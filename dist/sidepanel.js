const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["chunks/AIReasoningModal.BZb5xl_h.js","chunks/vendor-ui.BBm4hhLH.js","chunks/vendor.ChGo-vQ_.js","chunks/ScreenshotAnnotationModal.B-0I2kHK.js","chunks/vendor-3d.C_BwnfSu.js","chunks/agents.D6Qu3kid.js","chunks/services.BZymtB7H.js","chunks/modulepreload-polyfill.B5Qt9EMX.js","chunks/NotionStructuralWorkupService.24z3Prym.js","chunks/RHCCalculationService.DvfUPga5.js","chunks/settings-components.CH9ATYUj.js","chunks/NextStepInferenceAgent.DHqOZ5Vi.js","chunks/NextStepInferenceSystemPrompts.DeOuJ_T0.js","chunks/clinicalStorage.Cnou96FG.js","chunks/TAVIWorkupStorageService.BDN3NnOz.js","chunks/ValveSizingTab.6ZbyFyfF.js","assets/globals.css","chunks/AudioProcessingQueueService.BVdSSjm2.js","chunks/PatientEducationAgent.DoYlcw1n.js","chunks/PatientEducationSystemPrompts.d5DDcQ5R.js","chunks/BatchPatientReviewAgent.BLkmsmC_.js","chunks/BatchPatientReviewSystemPrompts.Cro_9UlO.js","chunks/index.es.NdbSEVaA.js","chunks/BackgroundAgent.Opfr34f8.js","chunks/InvestigationSummarySystemPrompts.8cZAk0RD.js","chunks/AgentFactory.CRiEgI8V.js","chunks/RightHeartCathAgent.DdqpSSZN.js","chunks/RightHeartCathSystemPrompts.n8EsDNAf.js"])))=>i.map(i=>d[i]);
import"./chunks/modulepreload-polyfill.B5Qt9EMX.js";import{j as t,m as or,R as Xa,a8 as Vr,p as ps,t as Xn,X as es,I as Ma,af as ei,A as xr,B as ol,q as ti,d as Ms,P as si,$ as $r,K as qi,Z as tl,n as _a,ag as bp,e as wA,l as vy,a5 as cc,D as Ya,ah as J1,f as Ac,F as Rn,k as Y1,ai as X1,ad as Po,r as Ye,g as Ra,ae as dA,aj as dc,ak as Zn,al as sl,am as vp,an as Z1,ao as lu,ap as e2,T as Ln,a4 as Fr,s as as,h as uc,y as wp,U as Do,aq as ll,ar as t2,L as Za,as as wy,at as Cy,au as cu,a as Cp,av as sA,aw as s2,ax as r2,z as CA,ay as a2,az as Ny,a6 as Dg,E as n2,aA as By,a2 as ji,aB as i2,aC as o2,aD as l2,aE as c2,aF as A2,aG as Rg,a3 as cl,aH as Qu,aI as d2,x as u2,w as Ou,M as Sy,C as Da,aJ as m2,aK as Np,aL as NA,aM as h2,aN as p2,H as mc,i as jy,aO as Ey,Y as Mg,aP as ky,aQ as g2,aR as f2,o as Bp,aS as x2,aT as Iy,aU as Sp,aV as Au,J as Ty,G as y2,aW as _g,aX as Fy,c as BA,aY as b2,aZ as v2,a7 as w2,a_ as C2,a$ as Hu,b0 as N2,b1 as Sm,b2 as B2,b3 as Py,b4 as Uy,b5 as S2,b6 as Ly,a1 as j2,b7 as E2,b8 as k2,b9 as I2,ba as Vu,bb as T2,aa as Qg,bc as F2,bd as P2}from"./chunks/vendor-ui.BBm4hhLH.js";import{r as m,a as Dy,R as bs}from"./chunks/vendor.ChGo-vQ_.js";import{_ as ns,c as $u,e as U2,u as Ry,a as My,C as L2,b as D2,E as R2,L as qA,d as M2,V as hi,R as Og,T as _2,f as Q2,S as O2,g as H2,h as jm,i as V2,j as $2,k as Ic,B as Em,l as K2,M as G2,m as z2}from"./chunks/vendor-3d.C_BwnfSu.js";/* empty css                       */import{M as rA,N as _y,n as Tc,d as Qy,b as W2,Q as q2,S as J2,L as JA,p as Hg}from"./chunks/NotionStructuralWorkupService.24z3Prym.js";import{B as ye,I as Zt,w as Na,c as Ci,A as Ho,T as gt,a as Y2,s as X2,l as Z2,t as Oy,m as eC,d as tC,F as YA,u as sC,R as Vg,S as rC}from"./chunks/ScreenshotAnnotationModal.B-0I2kHK.js";import{l as bt,i as aC,O as nC}from"./chunks/agents.D6Qu3kid.js";import{g as du,h as uu,i as mu,j as hu,k as Hy,l as Vy,e as Co,d as pu,p as $y,f as jh,m as Eh,q as Ky,s as gu,n as Gy,o as iC,u as zy,t as Wy,a as oC,w as lC,z as cC,y as AC,x as dC,c as uC}from"./chunks/RHCCalculationService.DvfUPga5.js";import{a as kh,O as mC}from"./chunks/settings-components.CH9ATYUj.js";import{L as Ei,M as Tr,T as hC,W as $g,s as pC,i as gC}from"./chunks/services.BZymtB7H.js";import{getNextStepInferenceAgent as Kg}from"./chunks/NextStepInferenceAgent.DHqOZ5Vi.js";import{C as bl,s as Ih,g as Gg,i as fC,m as xC}from"./chunks/clinicalStorage.Cnou96FG.js";import{TAVIWorkupStorageService as yC}from"./chunks/TAVIWorkupStorageService.BDN3NnOz.js";import{D as bC,a as uo,V as Al,b as vC,g as wC}from"./chunks/ValveSizingTab.6ZbyFyfF.js";import"./chunks/NextStepInferenceSystemPrompts.DeOuJ_T0.js";const qy=m.createContext(void 0),CC=({children:s})=>{const[e,r]=m.useState(null),[a,n]=m.useState(null),[i,o]=m.useState("auto"),[l,c]=m.useState("auto"),A=(h,f=!1)=>{if(r(h),o(f?"manual":"auto"),f&&h)try{localStorage.setItem("xestro-preferred-microphone",h)}catch(u){console.warn("Failed to persist microphone preference:",u)}},d=(h,f=!1)=>{if(n(h),c(f?"manual":"auto"),f&&h)try{localStorage.setItem("xestro-preferred-speaker",h)}catch(u){console.warn("Failed to persist speaker preference:",u)}};return t.jsx(qy.Provider,{value:{selectedMicrophoneId:e,selectedSpeakerId:a,microphoneSelectionType:i,speakerSelectionType:l,setSelectedMicrophoneId:A,setSelectedSpeakerId:d},children:s})},Jy=()=>{const s=m.useContext(qy);if(s===void 0)throw new Error("useAudioDeviceContext must be used within an AudioDeviceProvider");return s},NC=({error:s,errorInfo:e,resetError:r})=>{const[a,n]=m.useState(!1),[i,o]=m.useState(!1),l=async()=>{const A=`
Error: ${s?.name||"Unknown Error"}
Message: ${s?.message||"No message"}
Stack: ${s?.stack||"No stack trace"}
Component Stack: ${e?.componentStack||"No component stack"}
Timestamp: ${new Date().toISOString()}
User Agent: ${navigator.userAgent}
    `.trim();try{await navigator.clipboard.writeText(A),o(!0),setTimeout(()=>o(!1),2e3)}catch(d){console.error("Failed to copy error:",d)}},c=()=>{window.location.reload()};return t.jsx("div",{className:"flex items-center justify-center min-h-screen bg-gradient-to-br from-rose-50/50 to-pink-50/40 p-8",children:t.jsxs("div",{className:"max-w-2xl w-full bg-white rounded-xl shadow-lg border border-rose-200/60 overflow-hidden",children:[t.jsx("div",{className:"bg-gradient-to-br from-rose-50 to-pink-50 border-b border-rose-200/60 p-6",children:t.jsxs("div",{className:"flex items-start gap-4",children:[t.jsx("div",{className:"flex-shrink-0 w-12 h-12 bg-rose-500 rounded-full flex items-center justify-center",children:t.jsx(or,{className:"w-6 h-6 text-white"})}),t.jsxs("div",{className:"flex-1",children:[t.jsx("h1",{className:"text-2xl font-semibold text-rose-900",children:"Something went wrong"}),t.jsx("p",{className:"text-sm text-rose-700 mt-1",children:"The application encountered an unexpected error"})]})]})}),t.jsxs("div",{className:"p-6 space-y-4",children:[t.jsxs("div",{className:"bg-rose-50 border border-rose-200 rounded-lg p-4",children:[t.jsx("h2",{className:"text-sm font-semibold text-rose-900 mb-2",children:"Error Details"}),t.jsx("p",{className:"text-sm text-rose-700 font-mono break-words",children:s?.message||"An unknown error occurred"})]}),t.jsxs("div",{className:"flex gap-3",children:[t.jsx(ye,{onClick:r,variant:"primary",size:"md",fullWidth:!0,startIcon:t.jsx(Xa,{}),children:"Try Again"}),t.jsx(ye,{onClick:c,variant:"outline",size:"md",fullWidth:!0,children:"Reload Page"})]}),t.jsxs("div",{className:"border-t border-gray-200 pt-4",children:[t.jsx(ye,{onClick:()=>n(!a),variant:"ghost",size:"md",fullWidth:!0,endIcon:a?t.jsx(Vr,{}):t.jsx(ps,{}),className:"!justify-between",children:"Technical Details"}),a&&t.jsxs("div",{className:"mt-3 space-y-3",children:[s?.stack&&t.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[t.jsx("h3",{className:"text-xs font-semibold text-gray-700 mb-2",children:"Stack Trace"}),t.jsx("pre",{className:"text-xs text-gray-600 font-mono overflow-x-auto whitespace-pre-wrap break-words",children:s.stack})]}),e?.componentStack&&t.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[t.jsx("h3",{className:"text-xs font-semibold text-gray-700 mb-2",children:"Component Stack"}),t.jsx("pre",{className:"text-xs text-gray-600 font-mono overflow-x-auto whitespace-pre-wrap break-words",children:e.componentStack})]}),t.jsx(ye,{onClick:l,variant:"outline",size:"md",fullWidth:!0,startIcon:t.jsx(Xn,{className:i?"text-emerald-600":""}),isSuccess:i,className:"bg-gray-100 hover:bg-gray-200 text-gray-700",children:i?"Copied!":"Copy Error Details"})]})]}),t.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[t.jsx("h3",{className:"text-sm font-semibold text-blue-900 mb-2",children:"What can you do?"}),t.jsxs("ul",{className:"text-sm text-blue-700 space-y-1.5",children:[t.jsxs("li",{className:"flex items-start gap-2",children:[t.jsx("span",{className:"text-blue-500 mt-0.5",children:"‚Ä¢"}),t.jsx("span",{children:'Click "Try Again" to attempt recovery without reloading'})]}),t.jsxs("li",{className:"flex items-start gap-2",children:[t.jsx("span",{className:"text-blue-500 mt-0.5",children:"‚Ä¢"}),t.jsx("span",{children:'Click "Reload Page" for a fresh start'})]}),t.jsxs("li",{className:"flex items-start gap-2",children:[t.jsx("span",{className:"text-blue-500 mt-0.5",children:"‚Ä¢"}),t.jsx("span",{children:"Copy error details to report the issue"})]}),t.jsxs("li",{className:"flex items-start gap-2",children:[t.jsx("span",{className:"text-blue-500 mt-0.5",children:"‚Ä¢"}),t.jsx("span",{children:"If the problem persists, check the browser console (F12) for more information"})]})]})]})]})]})})};let BC=class extends m.Component{constructor(e){super(e),this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,r){console.error("ErrorBoundary caught an error:",e,r),this.setState({error:e,errorInfo:r}),this.props.onError&&this.props.onError(e,r),this.logErrorToService(e,r)}logErrorToService(e,r){const a={timestamp:new Date().toISOString(),error:{name:e.name,message:e.message,stack:e.stack},componentStack:r.componentStack,userAgent:navigator.userAgent,url:window.location.href};console.error("Error Log:",JSON.stringify(a,null,2));try{const n=JSON.parse(localStorage.getItem("operator_error_logs")||"[]"),i=[a,...n].slice(0,10);localStorage.setItem("operator_error_logs",JSON.stringify(i))}catch(n){console.error("Failed to save error log:",n)}}resetError=()=>{this.setState({hasError:!1,error:null,errorInfo:null})};render(){if(this.state.hasError){if(this.props.fallback)return this.props.fallback;const e=this.props.FallbackComponent||NC;return t.jsx(e,{error:this.state.error,errorInfo:this.state.errorInfo,resetError:this.resetError})}return this.props.children}};const jp=({className:s,size:e=20})=>t.jsx("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:s,children:t.jsx("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"})}),gn=({className:s,size:e=20})=>t.jsxs("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:s,children:[t.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),t.jsx("polyline",{points:"14,2 14,8 20,8"}),t.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),t.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),t.jsx("polyline",{points:"10,9 9,9 8,9"})]}),fu=({className:s,size:e=20})=>t.jsx("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:s,children:t.jsx("polyline",{points:"22,12 18,12 15,21 9,3 6,12 2,12"})}),Wo=({className:s,size:e=20})=>t.jsx("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:s,children:t.jsx("polyline",{points:"20,6 9,17 4,12"})}),dl=({className:s,size:e=20})=>t.jsxs("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:s,children:[t.jsx("circle",{cx:"12",cy:"12",r:"10"}),t.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),t.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),SC=({className:s,size:e=20})=>t.jsx("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:s,children:t.jsx("rect",{width:"18",height:"18",x:"3",y:"3",rx:"2"})}),jC=({className:s,size:e=20})=>t.jsxs("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:s,children:[t.jsx("polygon",{points:"11,5 6,9 2,9 2,15 6,15 11,19"}),t.jsx("path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"})]}),Th=({className:s,size:e=20})=>t.jsxs("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:s,children:[t.jsx("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),t.jsx("circle",{cx:"12",cy:"7",r:"4"})]}),Fh=({className:s,size:e=20})=>t.jsx("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:s,children:t.jsx("polyline",{points:"6,9 12,15 18,9"})}),Ph=({className:s,size:e=20})=>t.jsx("svg",{width:e,height:e,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:s,children:t.jsx("polyline",{points:"18,15 12,9 6,15"})});function EC(s){if(s==null||s<0)return"0s";s>864e5&&(console.warn(`formatElapsedTime: Suspiciously large value ${s}ms, clamping to 24h`),s=864e5);const e=Math.floor(s/1e3);if(e<60)return`${e}s`;const r=Math.floor(e/60),a=e%60;if(r<60)return a===0?`${r}m`:`${r}m ${a.toString().padStart(2,"0")}s`;const n=Math.floor(r/60),i=r%60;return i===0?`${n}h`:`${n}h ${i}m`}function Uh(s){if(s==null||s<=0)return"‚Äî";try{const e=new Date(s);return isNaN(e.getTime())?"‚Äî":e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}catch{return console.warn("formatAbsoluteTime: Invalid timestamp",s),"‚Äî"}}function Yy(s){if(!s||typeof s!="string")return 0;const e=s.trim();return e.length===0?0:e.split(/\s+/).filter(a=>a.length>0).length}function Xy(s,e=80){return s<e?null:Math.ceil(s/200)}function kC(s){return s==null?"":`${s} min read`}const Zy=({className:s="w-4 h-4",title:e})=>{const[r,a]=m.useState(!1),n=()=>{a(!0),setTimeout(()=>a(!1),300)};return t.jsx("span",{onMouseEnter:n,onFocus:n,className:"relative inline-flex items-center justify-center group","aria-hidden":e?void 0:!0,title:e,children:t.jsx(Xn,{className:`${s} transition-transform duration-300 ${r?"animate-bounce":"group-hover:scale-110"}`})})},IC={recording:{gradient:{from:"red-50",to:"rose-50"},border:"red-200",text:"red-600",indicator:"red-500",bgGradient:"bg-gradient-to-br from-red-50/40 to-rose-50/30",progressGradient:{inactive:"bg-gray-200",active:"bg-gradient-to-r from-red-400 to-rose-500",complete:"bg-gradient-to-r from-red-500 to-rose-600"}},transcribing:{gradient:{from:"blue-50",to:"indigo-50"},border:"blue-200",text:"blue-600",indicator:"blue-500",bgGradient:"bg-gradient-to-br from-blue-50/35 to-indigo-50/25",progressGradient:{inactive:"bg-gray-200",active:"bg-gradient-to-r from-blue-400 to-indigo-500",complete:"bg-gradient-to-r from-blue-500 to-indigo-600"}},"ai-analysis":{gradient:{from:"purple-50",to:"violet-50"},border:"purple-200",text:"purple-600",indicator:"purple-500",bgGradient:"bg-gradient-to-br from-purple-50/45 to-violet-50/35",progressGradient:{inactive:"bg-gray-200",active:"bg-gradient-to-r from-violet-400 to-fuchsia-500",complete:"bg-gradient-to-r from-violet-500 to-fuchsia-600"}},generation:{gradient:{from:"emerald-50",to:"teal-50"},border:"emerald-200",text:"emerald-600",indicator:"emerald-500",bgGradient:"bg-gradient-to-br from-emerald-50/40 to-teal-50/30",progressGradient:{inactive:"bg-gray-200",active:"bg-gradient-to-r from-emerald-400 to-teal-500",complete:"bg-gradient-to-r from-emerald-500 to-teal-600"}},completed:{gradient:{from:"emerald-50",to:"teal-50"},border:"emerald-200",text:"emerald-600",indicator:"emerald-500",bgGradient:"bg-gradient-to-br from-emerald-50/50 to-teal-50/40",progressGradient:{inactive:"bg-gray-200",active:"bg-gradient-to-r from-emerald-400 to-teal-500",complete:"bg-gradient-to-r from-emerald-500 to-teal-600"}},needs_review:{gradient:{from:"amber-50",to:"yellow-50"},border:"amber-200",text:"amber-700",indicator:"amber-500",bgGradient:"bg-gradient-to-br from-amber-50/40 to-yellow-50/30",progressGradient:{inactive:"bg-gray-200",active:"bg-gradient-to-r from-amber-400 to-yellow-500",complete:"bg-gradient-to-r from-amber-500 to-yellow-600"}},error:{gradient:{from:"rose-50",to:"pink-50"},border:"rose-200",text:"rose-600",indicator:"rose-500",bgGradient:"bg-gradient-to-br from-rose-50/45 to-pink-50/35",progressGradient:{inactive:"bg-gray-200",active:"bg-gradient-to-r from-rose-400 to-pink-500",complete:"bg-gradient-to-r from-rose-500 to-pink-600"}},processing:{gradient:{from:"purple-50",to:"violet-50"},border:"purple-200",text:"purple-600",indicator:"purple-500",bgGradient:"bg-gradient-to-br from-purple-50/45 to-violet-50/35",progressGradient:{inactive:"bg-gray-200",active:"bg-gradient-to-r from-purple-400 to-violet-500",complete:"bg-gradient-to-r from-purple-500 to-violet-600"}}};function No(s){return IC[s]}function Gc(s){return{"audio-processing":"recording",transcribing:"transcribing","ai-analysis":"ai-analysis",generation:"generation"}[s]||"processing"}const TC={modal:999998},FC={zIndex:TC},pc=({isOpen:s,onClose:e,size:r="md",title:a,children:n,footer:i,showCloseButton:o=!0,closeOnBackdropClick:l=!0,closeOnEscape:c=!0,className:A="",contentClassName:d="",header:h,disableScrollLock:f=!1})=>{const u=m.useRef(null),x=m.useRef(null),b={sm:"max-w-md",md:"max-w-2xl",lg:"max-w-4xl",xl:"max-w-6xl",full:"max-w-[95vw] h-[95vh]"};m.useEffect(()=>{if(!s||f)return;x.current=document.activeElement;const j=document.body.style.overflow;return document.body.style.overflow="hidden",u.current&&u.current.focus(),()=>{document.body.style.overflow=j,x.current instanceof HTMLElement&&x.current.focus()}},[s,f]),m.useEffect(()=>{if(!s||!c)return;const j=I=>{I.key==="Escape"&&e()};return document.addEventListener("keydown",j),()=>document.removeEventListener("keydown",j)},[s,c,e]);const N=j=>{l&&j.target===j.currentTarget&&e()};if(!s)return null;const v=t.jsxs("div",{className:"fixed inset-0 flex items-center justify-center p-4",style:{zIndex:FC.zIndex.modal},onClick:N,role:"presentation",children:[t.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity","aria-hidden":"true"}),t.jsxs("div",{ref:u,className:`
          relative w-full ${b[r]}
          bg-white rounded-modal shadow-modal border border-gray-200
          flex flex-col
          ${r==="full"?"h-[95vh]":"max-h-[90vh]"}
          transform transition-all
          ${A}
        `,role:"dialog","aria-modal":"true","aria-labelledby":a?"modal-title":void 0,tabIndex:-1,children:[(a||h||o)&&t.jsxs("div",{className:"flex items-start justify-between px-6 py-5 border-b border-gray-200",children:[h||(a?t.jsx("h2",{id:"modal-title",className:"text-xl font-semibold text-gray-900 flex-1",children:a}):t.jsx("div",{className:"flex-1"})),o&&t.jsx(Zt,{onClick:e,icon:es,variant:"ghost",size:"sm","aria-label":"Close modal",className:"ml-4 text-gray-400 hover:text-gray-600 focus:ring-violet-500/30"})]}),t.jsx("div",{className:`
            flex-1 overflow-y-auto px-6 py-5
            ${d}
          `,children:n}),i&&t.jsx("div",{className:"flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50/50",children:i})]})]});return Dy.createPortal(v,document.body)},PC=({isOpen:s,onClose:e,onConfirm:r,title:a,message:n,confirmText:i="Confirm",cancelText:o="Cancel",confirmVariant:l="primary",isLoading:c=!1})=>t.jsx(pc,{isOpen:s,onClose:e,size:"sm",title:a,footer:t.jsxs(t.Fragment,{children:[t.jsx(ye,{onClick:e,disabled:c,variant:"outline",size:"md",children:o}),t.jsx(ye,{onClick:r,disabled:c,variant:l==="danger"?"danger":"primary",size:"md",isLoading:c,children:c?"Processing...":i})]}),children:t.jsx("p",{className:"text-gray-700",children:n})}),UC=({type:s,message:e,className:r=""})=>{if(!e)return null;const a={error:{icon:or,textColor:"text-rose-600",iconColor:"text-rose-500"},warning:{icon:xr,textColor:"text-amber-700",iconColor:"text-amber-500"},success:{icon:ei,textColor:"text-emerald-600",iconColor:"text-emerald-500"},info:{icon:Ma,textColor:"text-blue-600",iconColor:"text-blue-500"}},{icon:n,textColor:i,iconColor:o}=a[s];return t.jsxs("div",{className:`flex items-start gap-1.5 mt-1 ${r}`,role:"alert","aria-live":s==="error"?"assertive":"polite",children:[t.jsx(n,{className:`w-3.5 h-3.5 mt-0.5 flex-shrink-0 ${o}`}),t.jsx("p",{className:`text-xs ${i}`,children:e})]})},Ku=({children:s,error:e,warning:r,success:a,helperText:n,className:i=""})=>{const o=e||r||a,l=e?"error":r?"warning":a?"success":void 0;return t.jsxs("div",{className:`w-full ${i}`,children:[s,o&&l&&t.jsx(UC,{type:l,message:o}),!o&&n&&t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:n})]})},eb=m.forwardRef(({variant:s="default",size:e="md",state:r="default",label:a,error:n,warning:i,success:o,helperText:l,startIcon:c,endIcon:A,containerClassName:d="",labelClassName:h="",className:f="",disabled:u,required:x,...b},N)=>{const v=n?"error":i?"warning":o?"success":r,j={sm:"h-8 px-3 text-sm",md:"h-10 px-4 text-base",lg:"h-12 px-5 text-lg"},I={default:"bg-white border-gray-300 hover:border-gray-400 focus:border-violet-500",filled:"bg-gray-50 border-gray-200 hover:bg-gray-100 focus:bg-white focus:border-violet-500",outlined:"bg-transparent border-2 border-gray-300 hover:border-gray-400 focus:border-violet-500"},C={default:"",error:"!border-rose-500 focus:!border-rose-500 focus:ring-rose-100",warning:"!border-amber-500 focus:!border-amber-500 focus:ring-amber-100",success:"!border-emerald-500 focus:!border-emerald-500 focus:ring-emerald-100"},E={default:"text-gray-400",error:"text-rose-500",warning:"text-amber-500",success:"text-emerald-500"},T=u?"bg-gray-100 text-gray-400 cursor-not-allowed opacity-60":"",Q=`
      block text-sm font-medium mb-1.5
      ${v==="error"?"text-rose-700":"text-gray-700"}
      ${u?"text-gray-400":""}
      ${h}
    `.trim(),D=`
      w-full
      ${j[e]}
      ${I[s]}
      ${C[v]}
      ${T}
      ${c?"!pl-10":""}
      ${A?"!pr-10":""}
      border rounded-lg
      transition-all duration-200
      focus:outline-none focus:ring-2 focus:ring-violet-500/20
      placeholder-gray-400
      ${f}
    `.trim();return t.jsxs(Ku,{error:n,warning:i,success:o,helperText:l,className:d,children:[a&&t.jsxs("label",{className:Q,children:[a,x&&t.jsx("span",{className:"text-rose-500 ml-1",children:"*"})]}),t.jsxs("div",{className:"relative",children:[c&&t.jsx("div",{className:`absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none ${E[v]}`,children:c}),t.jsx("input",{ref:N,disabled:u,required:x,className:D,"aria-invalid":v==="error","aria-describedby":n||i||o||l?`${b.id}-message`:void 0,...b}),A&&t.jsx("div",{className:`absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none ${E[v]}`,children:A})]})]})});eb.displayName="FormInput";const tb=m.forwardRef(({variant:s="default",state:e="default",label:r,error:a,warning:n,success:i,helperText:o,containerClassName:l="",labelClassName:c="",className:A="",disabled:d,required:h,rows:f=4,...u},x)=>{const b=a?"error":n?"warning":i?"success":e,N={default:"bg-white border-gray-300 hover:border-gray-400 focus:border-violet-500",filled:"bg-gray-50 border-gray-200 hover:bg-gray-100 focus:bg-white focus:border-violet-500",outlined:"bg-transparent border-2 border-gray-300 hover:border-gray-400 focus:border-violet-500"},v={default:"",error:"!border-rose-500 focus:!border-rose-500 focus:ring-rose-100",warning:"!border-amber-500 focus:!border-amber-500 focus:ring-amber-100",success:"!border-emerald-500 focus:!border-emerald-500 focus:ring-emerald-100"},j=d?"bg-gray-100 text-gray-400 cursor-not-allowed opacity-60":"",I=`
      block text-sm font-medium mb-1.5
      ${b==="error"?"text-rose-700":"text-gray-700"}
      ${d?"text-gray-400":""}
      ${c}
    `.trim(),C=`
      w-full px-4 py-3 text-base
      ${N[s]}
      ${v[b]}
      ${j}
      border rounded-lg
      transition-all duration-200
      focus:outline-none focus:ring-2 focus:ring-violet-500/20
      placeholder-gray-400
      resize-y
      ${A}
    `.trim();return t.jsxs(Ku,{error:a,warning:n,success:i,helperText:o,className:l,children:[r&&t.jsxs("label",{className:I,children:[r,h&&t.jsx("span",{className:"text-rose-500 ml-1",children:"*"})]}),t.jsx("textarea",{ref:x,disabled:d,required:h,rows:f,className:C,"aria-invalid":b==="error","aria-describedby":a||n||i||o?`${u.id}-message`:void 0,...u})]})});tb.displayName="FormTextarea";const LC=m.forwardRef(({variant:s="default",size:e="md",state:r="default",label:a,error:n,warning:i,success:o,helperText:l,containerClassName:c="",labelClassName:A="",className:d="",disabled:h,required:f,options:u,placeholder:x,...b},N)=>{const v=n?"error":i?"warning":o?"success":r,j={sm:"h-8 px-3 text-sm",md:"h-10 px-4 text-base",lg:"h-12 px-5 text-lg"},I={default:"bg-white border-gray-300 hover:border-gray-400 focus:border-violet-500",filled:"bg-gray-50 border-gray-200 hover:bg-gray-100 focus:bg-white focus:border-violet-500",outlined:"bg-transparent border-2 border-gray-300 hover:border-gray-400 focus:border-violet-500"},C={default:"",error:"!border-rose-500 focus:!border-rose-500 focus:ring-rose-100",warning:"!border-amber-500 focus:!border-amber-500 focus:ring-amber-100",success:"!border-emerald-500 focus:!border-emerald-500 focus:ring-emerald-100"},E=h?"bg-gray-100 text-gray-400 cursor-not-allowed opacity-60":"",T=`
      block text-sm font-medium mb-1.5
      ${v==="error"?"text-rose-700":"text-gray-700"}
      ${h?"text-gray-400":""}
      ${A}
    `.trim(),Q=`
      w-full
      ${j[e]}
      ${I[s]}
      ${C[v]}
      ${E}
      border rounded-lg
      transition-all duration-200
      focus:outline-none focus:ring-2 focus:ring-violet-500/20
      ${d}
    `.trim();return t.jsxs(Ku,{error:n,warning:i,success:o,helperText:l,className:c,children:[a&&t.jsxs("label",{className:T,children:[a,f&&t.jsx("span",{className:"text-rose-500 ml-1",children:"*"})]}),t.jsxs("select",{ref:N,disabled:h,required:f,className:Q,"aria-invalid":v==="error","aria-describedby":n||i||o||l?`${b.id}-message`:void 0,...b,children:[x&&t.jsx("option",{value:"",disabled:!0,children:x}),u.map(D=>t.jsx("option",{value:D.value,disabled:D.disabled,children:D.label},D.value))]})]})});LC.displayName="FormSelect";const $o=m.forwardRef(({variant:s="default",size:e="md",state:r="default",label:a,error:n,warning:i,success:o,helperText:l,containerClassName:c="",labelClassName:A="",className:d="",disabled:h,required:f,options:u=[],value:x="",onChange:b,placeholder:N,...v},j)=>{const[I,C]=m.useState(!1),[E,T]=m.useState(u),Q=m.useRef(null);m.useEffect(()=>{const q=x.toLowerCase().trim();if(!q)T(u);else{const S=u.filter(H=>H.toLowerCase().includes(q));T(S)}},[x,u]),m.useEffect(()=>{const q=S=>{Q.current&&!Q.current.contains(S.target)&&C(!1)};return document.addEventListener("mousedown",q),()=>document.removeEventListener("mousedown",q)},[]);const D=n?"error":i?"warning":o?"success":r,k={sm:"h-8 px-3 text-sm",md:"h-10 px-4 text-base",lg:"h-12 px-5 text-lg"},R={default:"bg-white border-gray-300 hover:border-gray-400 focus:border-violet-500",filled:"bg-gray-50 border-gray-200 hover:bg-gray-100 focus:bg-white focus:border-violet-500",outlined:"bg-transparent border-2 border-gray-300 hover:border-gray-400 focus:border-violet-500"},w={default:"",error:"!border-rose-500 focus:!border-rose-500 focus:ring-rose-100",warning:"!border-amber-500 focus:!border-amber-500 focus:ring-amber-100",success:"!border-emerald-500 focus:!border-emerald-500 focus:ring-emerald-100"},L=h?"bg-gray-100 text-gray-400 cursor-not-allowed opacity-60":"",M=`
      block text-sm font-medium mb-1.5
      ${D==="error"?"text-rose-700":"text-gray-700"}
      ${h?"text-gray-400":""}
      ${A}
    `.trim(),P=`
      w-full
      ${k[e]}
      ${R[s]}
      ${w[D]}
      ${L}
      border rounded-lg
      transition-all duration-200
      focus:outline-none focus:ring-2 focus:ring-violet-500/20
      placeholder-gray-400
      ${d}
    `.trim(),K=`
      absolute z-50 w-full mt-1
      bg-white border border-gray-300 rounded-lg shadow-lg
      max-h-60 overflow-y-auto
      ${!I||E.length===0?"hidden":""}
    `.trim(),$=q=>`
      px-4 py-2 cursor-pointer
      transition-colors duration-150
      ${q?"bg-violet-100 text-violet-900":"hover:bg-gray-100 text-gray-900"}
    `.trim(),O=q=>{b(q.target.value),C(!0)},W=q=>{b(q),C(!1)},ee=()=>{C(!0)},V=q=>{q.key==="Escape"&&C(!1)};return t.jsxs(Ku,{error:n,warning:i,success:o,helperText:l,className:c,children:[a&&t.jsxs("label",{className:M,children:[a,f&&t.jsx("span",{className:"text-rose-500 ml-1",children:"*"})]}),t.jsxs("div",{className:"relative",ref:Q,children:[t.jsx("input",{ref:j,type:"text",value:x,onChange:O,onFocus:ee,onKeyDown:V,disabled:h,required:f,placeholder:N,className:P,"aria-invalid":D==="error","aria-describedby":n||i||o||l?`${v.id}-message`:void 0,"aria-autocomplete":"list","aria-expanded":I,role:"combobox",...v}),t.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400",children:t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})}),t.jsx("div",{className:K,role:"listbox",children:E.map(q=>t.jsx("div",{className:$(q===x),onClick:()=>W(q),role:"option","aria-selected":q===x,children:q},q))})]})]})});$o.displayName="Combobox";const pi={confidenceLabel:"Validation confidence",criticalTitle:"Critical Missing Fields",criticalHelper:"These fields are required before continuing.",optionalTitle:"Optional Fields",optionalHelper:"Adding these values improves documentation quality.",suggestionsTitle:"Suggested Corrections",suggestionsHelper:"Review low-confidence corrections from the quick model.",cancelLabel:"Cancel",skipLabel:"Skip & Generate Anyway",continueLabel:"Validate & Continue"},zg=s=>{const e=s.split(".");return e[e.length-1].replace(/_/g," ").replace(/([a-z0-9])([A-Z])/g,"$1 $2").replace(/\b([a-z])/g,a=>a.toUpperCase())},km=s=>{if(s==null)return"none";if(typeof s=="number")return Number.isInteger(s)?String(s):s.toFixed(2);if(typeof s=="string"){const e=parseFloat(s);if(!isNaN(e)&&s.includes(".")&&s.split(".")[1]?.length>2)return e.toFixed(2)}return String(s)},uA=({agentLabel:s,validation:e,onCancel:r,onContinue:a,onSkip:n,fieldConfig:i={},copy:o={},autoConfidenceThreshold:l=.8})=>{const[c,A]=m.useState({}),[d,h]=m.useState(new Set),[f,u]=m.useState(new Set),[x,b]=m.useState({}),[N,v]=m.useState(!1),j=m.useMemo(()=>({heading:o.heading??`${s} Validation Required`,description:o.description,confidenceLabel:o.confidenceLabel??pi.confidenceLabel,criticalTitle:o.criticalTitle??pi.criticalTitle,criticalHelper:o.criticalHelper??pi.criticalHelper,optionalTitle:o.optionalTitle??pi.optionalTitle,optionalHelper:o.optionalHelper??pi.optionalHelper,suggestionsTitle:o.suggestionsTitle??pi.suggestionsTitle,suggestionsHelper:o.suggestionsHelper??pi.suggestionsHelper,cancelLabel:o.cancelLabel??pi.cancelLabel,skipLabel:o.skipLabel??pi.skipLabel,continueLabel:o.continueLabel??pi.continueLabel}),[s,o]),I=m.useMemo(()=>e.corrections.filter(M=>M.confidence<l),[e.corrections,l]),C=(M,P)=>{A(K=>({...K,[M]:P}))},E=M=>{const P=M.match(/suggest(?:ed|ion)?\s*[:-]?\s*(\d+(?:\.\d+)?)/i);if(P)return Number(P[1]);const K=M.match(/\((\d+(?:\.\d+)?)\)/);if(K)return Number(K[1]);const $=M.match(/(\d+(?:\.\d+)?)/);if($)return Number($[1])},T=M=>M.suggestedValue!==void 0?M.suggestedValue:E(M.reason),Q=M=>{const P=T(M);P!==void 0&&C(M.field,P)},D=()=>{const M=new Set(d),P={...c};for(const K of I)M.add(K.field),P[K.field]=K.correctValue;for(const K of[...e.missingCritical,...e.missingOptional]){const $=T(K);$!==void 0&&(P[K.field]=$)}h(M),A(P),a(P)},k=(M,P)=>{u(K=>{const $=new Set(K);return $.delete(M.field),$}),h(K=>{const $=new Set(K);if(P){$.add(M.field);const O=x[M.field]??M.correctValue;A(W=>({...W,[M.field]:O}))}else $.delete(M.field),A(O=>{const W={...O};return delete W[M.field],W});return $})},R=M=>{u(K=>{const $=new Set(K);return $.add(M.field),$});const P=x[M.field]??String(M.correctValue??M.regexValue??"");b(K=>({...K,[M.field]:P}))},w=M=>{const P=x[M.field];P!==void 0&&(h(K=>{const $=new Set(K);return $.add(M.field),$}),A(K=>({...K,[M.field]:P}))),u(K=>{const $=new Set(K);return $.delete(M.field),$})},L=(M,P)=>{const K=i[M.field],$=K?.label??zg(M.field),O=K?.inputType??"text",W=K?.placeholder??(P?M.reason:"Optional"),ee=K?.helperText??M.reason,V=T(M);return O==="textarea"?t.jsxs("div",{className:"space-y-2",children:[t.jsx(tb,{label:$,placeholder:W,rows:3,helperText:ee,onChange:q=>C(M.field,q.target.value)}),V!==void 0&&t.jsxs(ye,{variant:"success",size:"sm",onClick:()=>Q(M),children:["Accept ",String(V)]})]},M.field):t.jsxs("div",{className:"space-y-2",children:[t.jsx(eb,{label:$,type:O,step:"any",placeholder:W,helperText:ee,onChange:q=>C(M.field,q.target.value)}),V!==void 0&&t.jsxs(ye,{variant:"success",size:"sm",onClick:()=>Q(M),children:["Accept ",String(V)]})]},M.field)};return t.jsx(pc,{isOpen:!0,onClose:r,size:"lg",title:j.heading,footer:t.jsxs("div",{className:"flex items-center justify-end gap-2 w-full",children:[n&&t.jsx(ye,{variant:"ghost",size:"sm",className:"text-xs text-gray-500 hover:text-gray-700",onClick:n,children:"Skip"}),t.jsx(ye,{variant:"outline",size:"sm",className:"text-xs",onClick:r,children:"Cancel"}),t.jsx(ye,{variant:"success",size:"sm",className:"text-xs",onClick:D,children:"Save & Continue"})]}),children:t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"space-y-2",children:[j.description&&t.jsx("p",{className:"text-sm text-gray-600",children:j.description}),t.jsxs("div",{className:"text-xs text-gray-500 uppercase tracking-wide",children:[j.confidenceLabel,": ",t.jsxs("span",{className:"font-semibold text-gray-800",children:[Math.round(e.confidence*100),"%"]})]})]}),e.modelReasoning&&t.jsxs("section",{className:"border border-purple-200 rounded-lg overflow-hidden",children:[t.jsxs("button",{type:"button",onClick:()=>v(!N),className:"w-full flex items-center gap-2 px-4 py-2 bg-purple-50 hover:bg-purple-100 transition-colors text-left",children:[t.jsx(ol,{className:"w-4 h-4 text-purple-600"}),t.jsx("span",{className:"text-sm font-medium text-purple-700",children:"Model Reasoning"}),N?t.jsx(ps,{className:"w-4 h-4 text-purple-500 ml-auto"}):t.jsx(ti,{className:"w-4 h-4 text-purple-500 ml-auto"})]}),N&&t.jsx("div",{className:"p-4 bg-purple-50/50",children:t.jsx("pre",{className:"text-xs text-gray-700 whitespace-pre-wrap font-mono leading-relaxed",children:e.modelReasoning})})]}),e.missingCritical.length>0&&t.jsxs("section",{className:"bg-rose-50/50 border border-rose-200 rounded-lg p-4 space-y-4",children:[t.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-rose-200",children:[t.jsx(or,{className:"w-5 h-5 text-rose-600 flex-shrink-0"}),t.jsx("span",{className:"text-rose-700 font-semibold",children:j.criticalTitle})]}),t.jsx("p",{className:"text-xs text-rose-600",children:j.criticalHelper}),t.jsx("div",{className:"space-y-4",children:e.missingCritical.map(M=>L(M,!0))})]}),I.length>0&&t.jsxs("section",{className:"bg-amber-50/50 border border-amber-200 rounded-lg p-4 space-y-4",children:[t.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-amber-200",children:[t.jsx(xr,{className:"w-5 h-5 text-amber-600 flex-shrink-0"}),t.jsx("span",{className:"text-amber-700 font-semibold",children:j.suggestionsTitle})]}),t.jsx("p",{className:"text-xs text-amber-600",children:j.suggestionsHelper}),t.jsx("div",{className:"space-y-3",children:I.map(M=>{const P=i[M.field],K=P?.label??zg(M.field),$=d.has(M.field),O=f.has(M.field),W=P?.inputType??"text";return t.jsxs("div",{className:"border border-gray-200 rounded-lg p-4 space-y-3",children:[t.jsx("div",{className:"text-sm font-medium text-gray-700",children:K}),O?t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"text-xs text-gray-500 mb-1",children:["Original: ",t.jsx("span",{className:"font-mono bg-gray-100 px-1 rounded",children:String(M.regexValue??"none")})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:W,value:x[M.field]??"",onChange:ee=>b(V=>({...V,[M.field]:ee.target.value})),placeholder:P?.placeholder??"Enter corrected value",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",autoFocus:!0}),t.jsx(ye,{variant:"success",size:"sm",onClick:()=>w(M),children:t.jsx(Ms,{className:"w-4 h-4"})})]}),P?.helperText&&t.jsx("div",{className:"text-xs text-gray-400",children:P.helperText})]}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"text-sm text-gray-600",children:M.regexValue!==null&&M.regexValue!==void 0?t.jsxs(t.Fragment,{children:["Transcription: ",t.jsx("strong",{className:"font-mono bg-amber-50 px-1 rounded",children:km(M.regexValue)})," ‚Üí Suggested: ",t.jsx("strong",{className:"font-mono bg-green-50 px-1 rounded",children:km(M.correctValue)})]}):t.jsxs(t.Fragment,{children:["Suggested: ",t.jsx("strong",{className:"font-mono bg-green-50 px-1 rounded",children:km(M.correctValue)})]})}),t.jsx("div",{className:"text-xs text-gray-500",children:M.reason})]}),!O&&t.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.jsx(ye,{variant:$?"success":"outline",size:"xs",className:"text-xs px-2 py-1",onClick:()=>k(M,!0),children:"Accept"}),t.jsx(ye,{variant:$?"outline":"primary",size:"xs",className:"text-xs px-2 py-1",onClick:()=>k(M,!1),children:"Keep"}),t.jsx(ye,{variant:"outline",size:"xs",className:"text-xs px-2 py-1",onClick:()=>R(M),children:t.jsx(si,{className:"w-3 h-3"})})]}),t.jsxs("div",{className:"text-xs text-gray-400",children:["Confidence: ",(M.confidence*100).toFixed(0),"%"]})]},M.field)})})]}),e.missingOptional.length>0&&t.jsxs("section",{className:"bg-blue-50/50 border border-blue-200 rounded-lg p-4 space-y-4",children:[t.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-blue-200",children:[t.jsx(Ma,{className:"w-5 h-5 text-blue-600 flex-shrink-0"}),t.jsx("span",{className:"text-blue-700 font-semibold",children:j.optionalTitle})]}),t.jsx("p",{className:"text-xs text-blue-600",children:j.optionalHelper}),t.jsx("div",{className:"space-y-4",children:e.missingOptional.map(M=>L(M,!1))})]})]})})};class Ni{static instance;metrics=[];maxMetricsHistory=100;constructor(){}static getInstance(){return Ni.instance||(Ni.instance=new Ni),Ni.instance}recordMetrics(e,r,a){try{const n={timestamp:Date.now(),processingPhase:e,duration:Math.max(0,r||0),memoryUsage:this.getMemoryInfo(),systemLoad:this.getSystemLoad(),...a};this.metrics.push(n),this.metrics.length>this.maxMetricsHistory&&(this.metrics=this.metrics.slice(-this.maxMetricsHistory)),console.log(`üìä Performance: ${e} completed in ${r}ms`,{phase:e,duration:r,agentType:a?.agentType,audioSize:a?.audioSize?Math.round(a.audioSize/1024)+"KB":void 0,memoryUsage:n.memoryUsage?.estimatedMemoryMB?n.memoryUsage.estimatedMemoryMB+"MB":"N/A"}),this.detectPerformanceIssues(n)}catch(n){console.warn("‚ö†Ô∏è Failed to record performance metrics:",n)}}getMemoryInfo(){let e={totalAgents:0,estimatedMemoryMB:0};try{if(typeof window<"u"&&window.AgentFactory){const a=window.AgentFactory.getMemoryEstimate();a&&typeof a=="object"&&(e={totalAgents:Math.max(0,a.totalAgents||0),estimatedMemoryMB:Math.max(0,a.estimatedMemoryMB||0)})}}catch{}let r={jsHeapSizeLimit:0,jsHeapTotalSize:0,jsHeapUsedSize:0};try{if(typeof window<"u"&&window.performance&&"memory"in window.performance&&window.performance.memory){const a=window.performance.memory;r={jsHeapSizeLimit:Math.max(0,a.jsHeapSizeLimit||0),jsHeapTotalSize:Math.max(0,a.totalJSHeapSize||0),jsHeapUsedSize:Math.max(0,a.usedJSHeapSize||0)}}}catch{}return{...e,...r}}getSystemLoad(){try{const e=this.metrics.slice(-5).filter(l=>l&&typeof l.duration=="number"&&l.duration>=0);if(e.length===0)return{};const a=e.reduce((l,c)=>l+(c.duration||0),0)/e.length,n={transcription:2e3,"agent-loading":500,"agent-processing":5e3,complete:0};let i=0;e.forEach(l=>{const c=n[l.processingPhase]||1e3;if(c>0){const A=(l.duration||0)/c;i+=Math.min(Math.max(A,0),3)}});const o=e.length>0?i/e.length*100:0;return{cpuUsage:Math.min(Math.max(o,0),100),isMainThreadBlocked:a>1e4,frameDrops:o>200?Math.max(0,Math.floor(o/50)):0}}catch(e){return console.warn("‚ö†Ô∏è Failed to calculate system load:",e),{}}}detectPerformanceIssues(e){try{if(!e||typeof e.duration!="number")return;const r=[],a=Math.max(0,e.duration);if(e.processingPhase==="transcription"&&a>1e4&&r.push(`Slow transcription (${a}ms) - check Transcription server`),e.processingPhase==="agent-processing"&&a>3e4){const n=e.agentType||"unknown";r.push(`Slow processing (${a}ms) - agent: ${n}`)}if(e.memoryUsage&&typeof e.memoryUsage.jsHeapUsedSize=="number"&&e.memoryUsage.jsHeapUsedSize>100*1024*1024){const n=Math.round(e.memoryUsage.jsHeapUsedSize/1024/1024);r.push(`High memory usage (${n}MB)`)}e.memoryUsage&&typeof e.memoryUsage.totalAgents=="number"&&e.memoryUsage.totalAgents>8&&r.push(`Too many agents loaded (${e.memoryUsage.totalAgents}) - consider cache optimization`),r.length>0&&console.warn("‚ö†Ô∏è Performance issues detected:",r)}catch(r){console.warn("‚ö†Ô∏è Failed to detect performance issues:",r)}}getPerformanceSummary(){if(this.metrics.length===0)return{totalSessions:0,averageTranscriptionTime:0,averageProcessingTime:0,averageCompressionRatio:0,memoryTrend:"stable",recommendedOptimizations:["Start using the extension to collect performance data"]};const e=this.metrics.filter(A=>A.processingPhase==="transcription"),r=this.metrics.filter(A=>A.processingPhase==="agent-processing"),a=this.metrics.filter(A=>A.compressionRatio!==void 0),n=e.length>0?e.reduce((A,d)=>A+d.duration,0)/e.length:0,i=r.length>0?r.reduce((A,d)=>A+d.duration,0)/r.length:0,o=a.length>0?a.reduce((A,d)=>A+(d.compressionRatio||0),0)/a.length:0,l=this.analyzeMemoryTrend(),c=this.generateOptimizationRecommendations(n,i,o,l);return{totalSessions:Math.floor(this.metrics.filter(A=>A.processingPhase==="complete").length),averageTranscriptionTime:Math.round(n),averageProcessingTime:Math.round(i),averageCompressionRatio:Math.round(o*10)/10,memoryTrend:l,recommendedOptimizations:c}}analyzeMemoryTrend(){try{const e=this.metrics.slice(-20).filter(d=>d&&d.memoryUsage&&typeof d.memoryUsage.jsHeapUsedSize=="number");if(e.length<5)return"stable";const r=Math.floor(e.length/2),a=e.slice(0,r),n=e.slice(r);if(a.length===0||n.length===0)return"stable";const i=a.reduce((d,h)=>d+(h.memoryUsage?.jsHeapUsedSize||0),0),o=n.reduce((d,h)=>d+(h.memoryUsage?.jsHeapUsedSize||0),0),l=i/a.length,c=o/n.length;if(l===0)return"stable";const A=(c-l)/l*100;return A>10?"increasing":A<-10?"decreasing":"stable"}catch(e){return console.warn("‚ö†Ô∏è Failed to analyze memory trend:",e),"stable"}}generateOptimizationRecommendations(e,r,a,n){const i=[];return e>8e3&&(i.push("Transcription is slow - check Transcription server performance"),i.push("Consider restarting the transcription server: ./dev")),r>2e4&&i.push("Agent processing is slow - consider using lighter models for simple tasks"),a<20&&i.push("Low compression ratio - audio files may benefit from better compression"),n==="increasing"&&(i.push("Memory usage is increasing - enable automatic cache optimization"),i.push("Consider restarting the extension periodically for long sessions")),i.length===0&&(i.push("Performance is optimal - no specific optimizations needed"),i.push("Continue using agent preloading for best performance")),i}clearMetrics(){this.metrics=[],console.log("üßπ Performance metrics cleared")}exportMetrics(){return[...this.metrics]}getRecentIssues(e=5){const r=Date.now()-e*60*1e3,a=this.metrics.filter(i=>i.timestamp>r),n=[];return a.forEach(i=>{i.processingPhase==="transcription"&&i.duration>1e4&&n.push(`Slow transcription: ${i.duration}ms`),i.processingPhase==="agent-processing"&&i.duration>3e4&&n.push(`Slow ${i.agentType} processing: ${i.duration}ms`)}),[...new Set(n)]}}class zi{static instance;historicalData=[];maxHistorySize=200;performanceService;agentProfiles={"investigation-summary":{baselineMs:1500,lengthScalingFactor:.8,modelComplexity:"lightweight",expectedRange:{min:1e3,max:3e3}},medication:{baselineMs:1800,lengthScalingFactor:.9,modelComplexity:"lightweight",expectedRange:{min:1200,max:3500}},background:{baselineMs:2e3,lengthScalingFactor:1,modelComplexity:"lightweight",expectedRange:{min:1500,max:4e3}},bloods:{baselineMs:1600,lengthScalingFactor:.85,modelComplexity:"lightweight",expectedRange:{min:1100,max:3200}},imaging:{baselineMs:1700,lengthScalingFactor:.9,modelComplexity:"lightweight",expectedRange:{min:1200,max:3400}},"ohif-viewer":{baselineMs:2400,lengthScalingFactor:.8,modelComplexity:"lightweight",expectedRange:{min:1500,max:5e3}},"quick-letter":{baselineMs:4e3,lengthScalingFactor:1.2,modelComplexity:"standard",expectedRange:{min:2500,max:8e3}},"pre-op-plan":{baselineMs:4500,lengthScalingFactor:1.1,modelComplexity:"standard",expectedRange:{min:3e3,max:9e3}},consultation:{baselineMs:5e3,lengthScalingFactor:1.4,modelComplexity:"standard",expectedRange:{min:3e3,max:12e3}},tavi:{baselineMs:6e3,lengthScalingFactor:1.8,modelComplexity:"heavy",expectedRange:{min:4e3,max:15e3}},"angiogram-pci":{baselineMs:6500,lengthScalingFactor:1.8,modelComplexity:"heavy",expectedRange:{min:4e3,max:15e3}},mteer:{baselineMs:6e3,lengthScalingFactor:1.7,modelComplexity:"heavy",expectedRange:{min:4e3,max:14e3}},tteer:{baselineMs:6e3,lengthScalingFactor:1.7,modelComplexity:"heavy",expectedRange:{min:4e3,max:14e3}},"pfo-closure":{baselineMs:5500,lengthScalingFactor:1.6,modelComplexity:"heavy",expectedRange:{min:3500,max:12e3}},"asd-closure":{baselineMs:5500,lengthScalingFactor:1.6,modelComplexity:"heavy",expectedRange:{min:3500,max:12e3}},"right-heart-cath":{baselineMs:5800,lengthScalingFactor:1.7,modelComplexity:"heavy",expectedRange:{min:3800,max:13e3}},"pvl-plug":{baselineMs:5500,lengthScalingFactor:1.6,modelComplexity:"heavy",expectedRange:{min:3500,max:12e3}},"bypass-graft":{baselineMs:7e3,lengthScalingFactor:2,modelComplexity:"heavy",expectedRange:{min:4500,max:18e3}},"tavi-workup":{baselineMs:6500,lengthScalingFactor:1.9,modelComplexity:"heavy",expectedRange:{min:4e3,max:16e3}},"ai-medical-review":{baselineMs:8e3,lengthScalingFactor:2.2,modelComplexity:"heavy",expectedRange:{min:5e3,max:2e4}},"batch-ai-review":{baselineMs:15e3,lengthScalingFactor:3,modelComplexity:"heavy",expectedRange:{min:1e4,max:45e3}},"aus-medical-review":{baselineMs:5200,lengthScalingFactor:1.6,modelComplexity:"standard",expectedRange:{min:3200,max:12e3}},"patient-education":{baselineMs:4500,lengthScalingFactor:1.3,modelComplexity:"standard",expectedRange:{min:3e3,max:1e4}},enhancement:{baselineMs:3e3,lengthScalingFactor:1.1,modelComplexity:"standard",expectedRange:{min:2e3,max:6e3}},transcription:{baselineMs:2e3,lengthScalingFactor:.5,modelComplexity:"lightweight",expectedRange:{min:1e3,max:4e3}},generation:{baselineMs:4500,lengthScalingFactor:1.3,modelComplexity:"standard",expectedRange:{min:2500,max:9e3}}};constructor(){this.performanceService=Ni.getInstance(),this.loadHistoricalData()}static getInstance(){return zi.instance||(zi.instance=new zi),zi.instance}predictProcessingTime(e,r,a){const n=this.agentProfiles[e];if(!n)throw new Error(`Unknown agent type: ${e}`);const i=this.historicalData.filter(j=>j.agentType===e),o=this.categorizeTranscriptionLength(r),l=n.baselineMs,c=a?.audioDuration?this.calculateAudioDurationFactor(a.audioDuration,n.lengthScalingFactor):this.calculateLengthFactor(r,n.lengthScalingFactor),A=this.calculateHistoricalAdjustment(e,r,a?.audioDuration,i),d=this.calculateSystemPerformanceFactor(a?.systemPerformance),h=l*c*A*d,f=Math.max(n.expectedRange.min,Math.min(n.expectedRange.max,h)),u=a?.includeTranscriptionTime?f+this.estimateTranscriptionTime(r):f,x=this.calculateConfidenceLevel(i.length,o),b=x==="high"?.2:x==="medium"?.4:.6,N={min:Math.round(u*(1-b)),max:Math.round(u*(1+b))},v=[{name:"Agent baseline",impact:l,description:`${n.modelComplexity} model baseline`,type:"additive"},{name:"Transcription length",impact:c,description:`${o.category} transcription (${r} chars)`,type:"multiplier"}];return A!==1&&v.push({name:"Historical performance",impact:A,description:`Based on ${i.length} similar sessions`,type:"multiplier"}),d!==1&&v.push({name:"System performance",impact:d,description:a?.systemPerformance?`Current system load: ${a.systemPerformance}%`:"System performance adjustment",type:"multiplier"}),{estimatedDurationMs:Math.round(u),confidenceLevel:x,factors:v,range:N,basedOnSessions:i.length,displayText:this.formatEstimateForDisplay(N,x,i.length)}}categorizeTranscriptionLength(e){return e<300?{category:"short",range:{min:0,max:300},description:"Short dictation (< 300 characters)"}:e<800?{category:"medium",range:{min:300,max:800},description:"Medium dictation (300-800 characters)"}:e<1500?{category:"long",range:{min:800,max:1500},description:"Long dictation (800-1500 characters)"}:{category:"very-long",range:{min:1500,max:1/0},description:"Very long dictation (> 1500 characters)"}}calculateLengthFactor(e,r){const n=e/500;return 1+Math.log(n+1)*r*.3}calculateAudioDurationFactor(e,r){const n=e/45;return 1+Math.log(n+1)*r*.5}calculateHistoricalAdjustment(e,r,a,n){if(n.length<3)return 1;let i;if(a!==void 0){const o={min:a*.5,max:a*1.5};i=n.filter(l=>l.audioDuration!==void 0&&l.audioDuration>=o.min&&l.audioDuration<=o.max)}else{const o={min:r*.5,max:r*1.5};i=n.filter(l=>l.transcriptionLength>=o.min&&l.transcriptionLength<=o.max)}return i.length<2?this.calculateAveragePerformanceRatio(n,e):this.calculateAveragePerformanceRatio(i,e)}calculateAveragePerformanceRatio(e,r){const a=this.agentProfiles[r],n=e.map(o=>{const l=a.baselineMs*this.calculateLengthFactor(o.transcriptionLength,a.lengthScalingFactor);return o.actualProcessingTime/l}),i=n.reduce((o,l)=>o+l,0)/n.length;return Math.max(.5,Math.min(2,i))}calculateSystemPerformanceFactor(e){return e?2-Math.max(0,Math.min(100,e))/100*1.2:(this.performanceService.getPerformanceSummary(),this.performanceService.getRecentIssues(2).length>0?1.3:1)}estimateTranscriptionTime(e){return 1500+Math.log(e/100+1)*200}calculateConfidenceLevel(e,r){return e>=20?"high":e>=8?"medium":"low"}formatEstimateForDisplay(e,r,a){const n=this.formatDuration(e.min),i=this.formatDuration(e.max),o=r==="high"?"High confidence":r==="medium"?"Medium confidence":"Low confidence";return a>0?`Expected: ${n}-${i} (${o}, ${a} sessions)`:`Expected: ${n}-${i} (${o})`}formatDuration(e){if(e<1e3)return`${Math.round(e)}ms`;const r=e/1e3;return r<10?`${r.toFixed(1)}s`:`${Math.round(r)}s`}recordActualProcessingTime(e,r,a,n,i){const o={agentType:e,transcriptionLength:r,audioDuration:n,actualProcessingTime:a,timestamp:Date.now(),systemPerformance:i};this.historicalData.push(o),this.historicalData.length>this.maxHistorySize&&(this.historicalData=this.historicalData.slice(-this.maxHistorySize)),this.saveHistoricalData(),bt.info(`Recorded processing time for ${e}`,{component:"processing-predictor",operation:"record-time",agentType:e,transcriptionLength:r,audioDuration:n,processingTime:a})}updatePredictionAccuracy(e,r){const a=r>=e.range.min&&r<=e.range.max,n=1-Math.abs(e.estimatedDurationMs-r)/e.estimatedDurationMs;return bt.info(`Prediction accuracy: ${Math.round(n*100)}%, within range: ${a}`,{component:"processing-predictor",operation:"accuracy-check",accuracy:Math.round(n*100),withinRange:a}),{accuracy:Math.max(0,n),wasWithinRange:a}}getAgentPerformanceStats(e){const r=this.historicalData.filter(i=>i.agentType===e);if(r.length===0)return{averageTime:this.agentProfiles[e]?.baselineMs||5e3,sessionCount:0,accuracyTrend:"stable"};const a=r.reduce((i,o)=>i+o.actualProcessingTime,0)/r.length,n=this.analyzeTrend(r);return{averageTime:Math.round(a),sessionCount:r.length,accuracyTrend:n}}analyzeTrend(e){if(e.length<6)return"stable";const r=Math.floor(e.length/2),a=e.slice(0,r),n=e.slice(r),i=a.reduce((c,A)=>c+A.actualProcessingTime,0)/a.length,l=(n.reduce((c,A)=>c+A.actualProcessingTime,0)/n.length-i)/i*100;return l<-10?"improving":l>10?"declining":"stable"}async loadHistoricalData(){try{const e=await chrome.storage.local.get("processingTimeHistory");e.processingTimeHistory&&(this.historicalData=e.processingTimeHistory.slice(-this.maxHistorySize),bt.info(`Loaded ${this.historicalData.length} historical processing time data points`,{component:"processing-predictor",operation:"load-data",dataPoints:this.historicalData.length}))}catch(e){bt.warn("Failed to load historical processing time data",{component:"processing-predictor",operation:"load-data",error:e instanceof Error?e.message:String(e)})}}async saveHistoricalData(){try{await chrome.storage.local.set({processingTimeHistory:this.historicalData})}catch(e){bt.warn("Failed to save historical processing time data",{component:"processing-predictor",operation:"save-data",error:e instanceof Error?e.message:String(e)})}}clearHistoricalData(){this.historicalData=[],chrome.storage.local.remove("processingTimeHistory"),bt.info("Cleared historical processing time data",{component:"processing-predictor",operation:"clear-data"})}exportHistoricalData(){return[...this.historicalData]}}const DC=s=>{if(!s)return"MedGemma-27B MLX";const e={"medgemma-27b-text-it-mlx":"MedGemma-27B MLX","qwen/qwen3-4b-2507":"Qwen 3-4B","qwen3-4b":"Qwen 3-4B","gemma-3n-e4b":"Gemma 3N-E4B"};if(e[s])return e[s];const r=s.toLowerCase();for(const[a,n]of Object.entries(e))if(r.includes(a.toLowerCase())||a.toLowerCase().includes(r))return n;return s},XA={"quick-letter":{min:3e4,max:6e4,complexity:"low"},consultation:{min:12e4,max:24e4,complexity:"medium"},"investigation-summary":{min:1e4,max:3e4,complexity:"low"},tavi:{min:48e4,max:72e4,complexity:"high"},mteer:{min:42e4,max:6e5,complexity:"high"},"pfo-closure":{min:3e5,max:48e4,complexity:"medium"},"right-heart-cath":{min:36e4,max:6e5,complexity:"medium"},"angiogram-pci":{min:48e4,max:9e5,complexity:"high"},"ai-medical-review":{min:18e4,max:24e4,complexity:"medium"}},RC=({appState:s,isRecording:e=!1,recordingTime:r=0,transcriptionLength:a,modelUsed:n=null})=>{const[i,o]=m.useState(0),[l,c]=m.useState(null),[A]=m.useState(()=>zi.getInstance());m.useEffect(()=>{let u;return(s.processingStatus==="transcribing"||s.processingStatus==="processing")&&(u=window.setInterval(()=>{s.processingStartTime&&o(Date.now()-s.processingStartTime)},100)),()=>{u&&clearInterval(u)}},[s.processingStatus,s.processingStartTime]),m.useEffect(()=>{try{if(s.currentAgent&&typeof a=="number"&&a>0){const u=A.predictProcessingTime(s.currentAgent,a,{includeTranscriptionTime:!0});c(u)}else c(null)}catch(u){console.warn("Failed to predict processing time:",u),c(null)}},[s.currentAgent,a,A]);const d=u=>{if(u===null)return"0s";const x=Math.floor(u/1e3);if(x<60)return`${(u/1e3).toFixed(1)}s`;{const b=Math.floor(x/60),N=x%60;return`${b}m ${N}s`}},h=u=>{if(u===null)return"0s";const x=Math.floor(u/1e3);if(x<60)return`${x}s`;{const b=Math.floor(x/60),N=x%60;return`${b}m ${N.toString().padStart(2,"0")}s`}},f=(u,x)=>{if(l)return u<l.range.min?{icon:"üü¢",color:"text-green-600",label:"Fast"}:u<=l.range.max?{icon:"üü°",color:"text-yellow-600",label:"Normal"}:{icon:"üî¥",color:"text-red-600",label:"Slow"};if(!x||!XA[x])return{icon:"üü°",color:"text-yellow-600",label:"Normal"};const b=XA[x];return u<b.min?{icon:"üü¢",color:"text-green-600",label:"Fast"}:u<=b.max?{icon:"üü°",color:"text-yellow-600",label:"Normal"}:{icon:"üî¥",color:"text-red-600",label:"Slow"}};if(e&&r>0)return t.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3 mb-4",children:t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx($r,{className:"h-4 w-4 text-red-600 animate-pulse"}),t.jsx("span",{className:"text-sm font-medium text-red-800",children:"Recording..."}),t.jsxs("span",{className:"text-sm text-red-600 font-mono",children:["(",h(r)," elapsed)"]})]})});if(s.processingStatus==="transcribing")return t.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4",children:t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(qi,{className:"h-4 w-4 text-blue-600 animate-pulse"}),t.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Transcribing..."}),t.jsxs("span",{className:"text-sm text-blue-600 font-mono",children:["(",h(i)," elapsed)"]})]})});if(s.processingStatus==="processing")return t.jsx("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-3 mb-4",children:t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(tl,{className:"h-4 w-4 text-purple-600 animate-pulse"}),t.jsxs("span",{className:"text-sm font-medium text-purple-800",children:[s.currentAgentName||"Agent"," Processing..."]}),t.jsxs("span",{className:"text-sm text-purple-600 font-mono",children:["(",h(i)," elapsed)"]})]})});if(s.processingStatus==="complete"&&s.totalProcessingTime){const u=f(s.totalProcessingTime,s.currentAgent),x=s.recordingTime?Math.round(s.recordingTime/s.totalProcessingTime*100):0,b=s.transcriptionTime?Math.round(s.transcriptionTime/s.totalProcessingTime*100):0,N=s.agentProcessingTime?Math.round(s.agentProcessingTime/s.totalProcessingTime*100):0;return t.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-4",children:t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(_a,{className:"h-4 w-4 text-green-600"}),t.jsx("span",{className:"text-sm font-medium text-green-800",children:"Processing Complete"}),t.jsxs("span",{className:`text-xs ${u.color}`,children:[u.icon," ",u.label]})]}),t.jsx("span",{className:"text-sm font-semibold text-green-800",children:d(s.totalProcessingTime)})]}),t.jsxs("div",{className:"space-y-2",children:[s.recordingTime&&t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"w-2 h-2 bg-red-400 rounded-full"}),t.jsx("span",{className:"text-gray-700",children:"Recording (Voice Input)"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("div",{className:"w-20 bg-gray-200 rounded-full h-1.5",children:t.jsx("div",{className:"bg-red-400 h-1.5 rounded-full",style:{width:`${x}%`}})}),t.jsx("span",{className:"w-12 text-right font-medium",children:d(s.recordingTime)}),t.jsxs("span",{className:"w-8 text-right text-gray-500",children:[x,"%"]})]})]}),s.transcriptionTime&&t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"w-2 h-2 bg-blue-400 rounded-full"}),t.jsx("span",{className:"text-gray-700",children:"Transcription (ASR)"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("div",{className:"w-20 bg-gray-200 rounded-full h-1.5",children:t.jsx("div",{className:"bg-blue-400 h-1.5 rounded-full",style:{width:`${b}%`}})}),t.jsx("span",{className:"w-12 text-right font-medium",children:d(s.transcriptionTime)}),t.jsxs("span",{className:"w-8 text-right text-gray-500",children:[b,"%"]})]})]}),s.agentProcessingTime&&t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"w-2 h-2 bg-purple-400 rounded-full"}),t.jsxs("span",{className:"text-gray-700",children:[s.currentAgentName||"Agent"," (",DC(n),")"]})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("div",{className:"w-20 bg-gray-200 rounded-full h-1.5",children:t.jsx("div",{className:"bg-purple-400 h-1.5 rounded-full",style:{width:`${N}%`}})}),t.jsx("span",{className:"w-12 text-right font-medium",children:d(s.agentProcessingTime)}),t.jsxs("span",{className:"w-8 text-right text-gray-500",children:[N,"%"]})]})]})]}),(()=>{if(l)return t.jsx("div",{className:"text-xs text-gray-600 pt-1 border-t border-green-100",children:l.displayText});if(s.currentAgent&&XA[s.currentAgent]){const v=XA[s.currentAgent];return t.jsxs("div",{className:"text-xs text-gray-600 pt-1 border-t border-green-100",children:["Expected: ",d(v.min)," - ",d(v.max)," (",v.complexity," complexity)"]})}return null})()]})})}return null},MC={blue:{selected:"bg-blue-50 text-blue-900 border-blue-200",unselected:"bg-white border-blue-100 text-gray-700 hover:border-blue-200 hover:bg-blue-50/30"},purple:{selected:"bg-purple-50 text-purple-900 border-purple-200",unselected:"bg-white border-purple-100 text-gray-700 hover:border-purple-200 hover:bg-purple-50/30"},emerald:{selected:"bg-emerald-50 text-emerald-900 border-emerald-200",unselected:"bg-white border-emerald-100 text-gray-700 hover:border-emerald-200 hover:bg-emerald-50/30"},amber:{selected:"bg-amber-50 text-amber-900 border-amber-200",unselected:"bg-white border-amber-100 text-gray-700 hover:border-amber-200 hover:bg-amber-50/30"},gray:{selected:"bg-gray-900 text-white border-gray-900",unselected:"bg-white border-gray-200 text-gray-700 hover:border-gray-400 hover:bg-gray-50"},violet:{selected:"bg-violet-50 text-violet-900 border-violet-200",unselected:"bg-white border-violet-100 text-gray-700 hover:border-violet-200 hover:bg-violet-50/30"}},qo=m.memo(({options:s,value:e,onChange:r,size:a="sm",className:n="",successId:i,multiSelect:o=!1,fullWidth:l=!1,accentColor:c="gray"})=>{const A=MC[c],d={sm:"h-7 text-xs gap-1 px-2",md:"h-8 text-sm gap-1.5 px-3"},h={sm:"w-3 h-3",md:"w-3.5 h-3.5"};return t.jsx("div",{className:`inline-flex gap-0.5 ${l?"w-full":""} ${n}`,role:o?"group":"radiogroup",children:s.map(f=>{const u=e===f.id,x=i===f.id,b=f.icon;return t.jsxs("button",{type:"button",role:o?"button":"radio","aria-checked":o?void 0:u,disabled:f.disabled,onClick:()=>r?.(f.id),className:`
              inline-flex items-center justify-center ${l?"flex-1":""}
              rounded-md transition-all duration-200 ease-out
              font-medium whitespace-nowrap
              ${d[a]}
              ${u&&!o?A.selected:x?"bg-emerald-50 text-emerald-700":"text-gray-600 hover:text-gray-900 hover:bg-gray-100/60"}
              ${f.disabled?"opacity-50 cursor-not-allowed":"cursor-pointer"}
              focus:outline-none focus-visible:ring-2 focus-visible:ring-violet-500/30 focus-visible:ring-offset-1
            `,children:[x?t.jsx(Ms,{className:`${h[a]} transition-transform duration-200`}):b&&t.jsx(b,{className:`${h[a]} transition-transform duration-200 group-hover:scale-110`}),t.jsx("span",{children:f.label})]},f.id)})})});qo.displayName="SegmentedControl";const Wg={copy:"‚áßC",insert:"‚áßI"},rc=m.memo(({onCopy:s,onInsert:e,onEdit:r,onTrain:a,onDownload:n,onReprocess:i,onPatient:o,onSkip:l,copiedRecently:c=!1,insertedRecently:A=!1,className:d="",actions:h=["copy","insert"],showKeyboardHints:f=!1})=>{const u=(v,j)=>f&&Wg[v]?`${j} ${Wg[v]}`:j,x=[];h.includes("copy")&&s&&x.push({id:"copy",label:u("copy","Copy")}),h.includes("insert")&&e&&x.push({id:"insert",label:u("insert","Insert")}),h.includes("edit")&&r&&x.push({id:"edit",label:"Edit"}),h.includes("train")&&a&&x.push({id:"train",label:"Train"}),h.includes("download")&&n&&x.push({id:"download",label:"Download"}),h.includes("reprocess")&&i&&x.push({id:"reprocess",label:"Redo"}),h.includes("patient")&&o&&x.push({id:"patient",label:"Patient"}),h.includes("skip")&&l&&x.push({id:"skip",label:"Skip"});const b=v=>{switch(v){case"copy":s?.();break;case"insert":e?.();break;case"edit":r?.();break;case"train":a?.();break;case"download":n?.();break;case"reprocess":i?.();break;case"patient":o?.();break;case"skip":l?.();break}},N=c?"copy":A?"insert":void 0;return t.jsx(qo,{options:x,onChange:b,successId:N,multiSelect:!0,className:d})});rc.displayName="ActionSegmentedControl";const sb=({audioBlob:s,fileName:e="investigation-audio",className:r="",onAnalysisUpdate:a,showQualityBar:n=!0,defaultExpanded:i=!1})=>{const[o,l]=m.useState(!1),[c,A]=m.useState(0),[d,h]=m.useState(0),[f,u]=m.useState(1),[x,b]=m.useState(1),[N,v]=m.useState([]),[j,I]=m.useState(""),[C,E]=m.useState(null),[T,Q]=m.useState(!1),[D,k]=m.useState(!1),[R,w]=m.useState(i),L=m.useRef(null),M=m.useRef(null),P=m.useRef(),K=m.useRef();m.useEffect(()=>{const Be=URL.createObjectURL(s);return I(Be),()=>{URL.revokeObjectURL(Be)}},[s]);const $=m.useCallback(async()=>{if(s)try{const Be=await s.arrayBuffer(),Re=new AudioContext,re=await Re.decodeAudioData(Be),Me=re.getChannelData(0),Pe=re.sampleRate,be=re.duration;let ce=0,Ie=0;const pe=.01;for(let pt=0;pt<Me.length;pt++){const dt=Math.abs(Me[pt]);ce+=dt,dt<pe&&Ie++}const fe=ce/Me.length,we=Ie/Pe,de=[...Me].map(Math.abs).sort((pt,dt)=>pt-dt),xe=de[Math.floor(de.length*.1)],Ne=de[Math.floor(de.length*.9)],it=Ne>0?20*Math.log10(Ne/(xe+.001)):0;let st="good";fe<.005||we>be*.8||it<10?st="poor":(fe<.02||we>be*.5||it<20)&&(st="fair");const $e=200,Xe=Math.floor(Me.length/$e),Ze=[];for(let pt=0;pt<$e;pt++){let dt=0;const xt=pt*Xe,Se=Math.min(xt+Xe,Me.length);for(let qe=xt;qe<Se;qe++)dt+=Math.abs(Me[qe]);Ze.push(dt/(Se-xt))}const ct={duration:be,fileSize:s.size,quality:st,avgVolume:fe,silenceDuration:we,estimatedSNR:it};v(Ze),E(ct),a?.(ct),await Re.close()}catch(Be){console.error("Audio analysis failed:",Be)}},[s,a]);m.useEffect(()=>{j&&$()},[j,$]);const O=m.useCallback(()=>{const Be=M.current;if(!Be||!N.length||!d)return;const Re=Be.getContext("2d");if(!Re)return;const{width:re,height:Me}=Be,Pe=c/d;Re.clearRect(0,0,re,Me);const be=re/N.length,ce=Math.max(...N);N.forEach((pe,fe)=>{const we=Math.max(2,pe/ce*Me*.8),de=fe*be,xe=(Me-we)/2;fe/N.length<=Pe?Re.fillStyle=T?"#1d4ed8":"#3b82f6":Re.fillStyle="#d1d5db",Re.fillRect(de,xe,Math.max(1,be-1),we)});const Ie=Pe*re;Re.strokeStyle=T?"#dc2626":"#ef4444",Re.lineWidth=T?3:2,Re.beginPath(),Re.moveTo(Ie,0),Re.lineTo(Ie,Me),Re.stroke(),T&&(Re.fillStyle="rgba(239, 68, 68, 0.2)",Re.fillRect(Ie-2,0,4,Me))},[N,c,d,T]);m.useEffect(()=>{O()},[O]);const W=()=>{if(L.current&&!T&&!D){const Be=L.current.currentTime;isFinite(Be)&&Be>=0&&A(Be)}},ee=()=>{if(L.current){const Be=L.current.duration;isFinite(Be)&&Be>0?h(Be):h(0)}},V=()=>{l(!1),Y()},q=m.useCallback(()=>{K.current&&(window.clearTimeout(K.current),K.current=void 0),Q(!1),L.current&&isFinite(L.current.currentTime)&&A(L.current.currentTime)},[]),S=m.useCallback(()=>{K.current&&(window.clearTimeout(K.current),K.current=void 0),Q(!1),L.current&&isFinite(L.current.currentTime)&&A(L.current.currentTime)},[]),H=m.useCallback(()=>{if(!o||!L.current||T||D)return;const Be=()=>{L.current&&o&&!T&&!D&&(A(L.current.currentTime),P.current=requestAnimationFrame(Be))};P.current=requestAnimationFrame(Be)},[o,T,D]),Y=m.useCallback(()=>{P.current&&(cancelAnimationFrame(P.current),P.current=void 0)},[]),te=m.useCallback(()=>{!L.current||T||(o?(L.current.pause(),l(!1),Y()):L.current.play().then(()=>{l(!0),!D&&!T&&H()}).catch(Be=>{console.error("Audio playback failed:",Be),l(!1)}))},[o,T,D,H,Y]),G=m.useCallback(Be=>{if(!L.current||!d||!isFinite(d)||d<=0){console.log("‚ùå seekTo validation failed:",{hasAudioRef:!!L.current,duration:d,isFiniteDuration:isFinite(d||0),durationValid:(d||0)>0});return}if(!isFinite(Be)||Be<0||Be>100){console.error("‚ùå Invalid percentage in seekTo:",{percentage:Be,isFinite:isFinite(Be),inRange:Be>=0&&Be<=100});return}if(T)return;Q(!0);const Re=Be/100*d,re=Math.max(0,Math.min(d,Re));if(!isFinite(re)){console.error("‚ùå Calculated newTime is non-finite:",{percentage:Be,duration:d,rawNewTime:Re,newTime:re}),Q(!1);return}console.log("üéØ Seeking to:",{percentage:Be.toFixed(2),newTime:re.toFixed(2),duration:d.toFixed(2)}),K.current&&(window.clearTimeout(K.current),K.current=void 0),A(re);try{isFinite(re)&&re>=0&&re<=d?(L.current.currentTime=re,K.current=window.setTimeout(()=>{Q(!1),L.current&&isFinite(L.current.currentTime)&&A(L.current.currentTime)},200)):(console.error("‚ùå Final validation failed for currentTime:",{newTime:re,duration:d}),Q(!1))}catch(Me){console.error("‚ùå Seek failed:",Me),Q(!1),K.current&&(window.clearTimeout(K.current),K.current=void 0)}},[d,T]),X=m.useCallback(Be=>{Be.preventDefault(),Be.stopPropagation();const Re=M.current;if(!Re||!d||!isFinite(d)||d<=0){console.log("‚ùå Cannot seek: canvas or duration not available",{canvas:!!Re,duration:d,isFiniteDuration:isFinite(d||0)});return}if(T){console.log("‚è≠Ô∏è Seek already in progress, ignoring click");return}const re=Re.getBoundingClientRect(),Me=Be.clientX-re.left,Pe=Me/re.width*100,be=Math.max(0,Math.min(100,Pe));if(!isFinite(be)){console.error("‚ùå Invalid percentage calculated:",{x:Me,width:re.width,rawPercentage:Pe,percentage:be});return}console.log("üéØ Waveform clicked:",{x:Me.toFixed(2),width:re.width.toFixed(2),percentage:be.toFixed(2)});try{G(be)}catch(ce){console.error("‚ùå Waveform seek failed:",ce)}},[d,T,G]),le=m.useCallback(()=>{Y(),l(!1),k(!1),L.current&&L.current.pause(),G(0)},[G,Y]),he=()=>{const Be=URL.createObjectURL(s),Re=document.createElement("a");Re.href=Be,Re.download=`${e}-${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.webm`,document.body.appendChild(Re),Re.click(),document.body.removeChild(Re),URL.revokeObjectURL(Be)},ve=Be=>{if(!isFinite(Be)||isNaN(Be)||Be<0)return"0:00";const Re=Math.floor(Be/60),re=Math.floor(Be%60);return`${Re}:${re.toString().padStart(2,"0")}`},ke=Be=>{switch(Be){case"good":return"text-green-600";case"fair":return"text-yellow-600";case"poor":return"text-red-600";default:return"text-gray-600"}},Le=Be=>{switch(Be){case"good":return"‚úÖ";case"fair":return"‚ö†Ô∏è";case"poor":return"‚ùå";default:return"‚ùì"}};return m.useEffect(()=>{o||Y()},[o,Y]),m.useEffect(()=>()=>{K.current&&window.clearTimeout(K.current)},[]),m.useEffect(()=>()=>{Y(),K.current&&window.clearTimeout(K.current)},[Y]),t.jsxs("div",{className:`space-y-3 ${r}`,children:[t.jsx("audio",{ref:L,src:j,onTimeUpdate:W,onLoadedMetadata:ee,onEnded:V,onSeeked:q,onError:S,onRateChange:()=>u(L.current?.playbackRate||1),preload:"metadata"}),n&&C&&t.jsx(ye,{onClick:()=>w(!R),variant:"ghost",size:"md",fullWidth:!0,endIcon:R?Vr:ps,className:"justify-between px-3 py-2 bg-white border border-gray-200 hover:bg-gray-50",children:t.jsxs("div",{className:"flex items-center space-x-3 text-sm",children:[t.jsx("span",{className:"text-gray-600",children:"Quality:"}),t.jsx("span",{className:`font-medium ${ke(C.quality)}`,children:C.quality}),t.jsx("span",{className:"text-gray-400",children:"‚Ä¢"}),t.jsx("span",{className:"text-gray-600",children:"Duration:"}),t.jsx("span",{className:"text-gray-900",children:ve(C.duration)})]})}),R&&C&&t.jsxs("div",{className:"space-y-3 p-3 bg-gray-50 rounded-lg border border-gray-200",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[t.jsxs("div",{className:"space-y-1",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Quality:"}),t.jsxs("span",{className:`font-medium ${ke(C.quality)}`,children:[C.quality!=="good"&&`${Le(C.quality)} `,C.quality]})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Duration:"}),t.jsx("span",{className:"text-gray-900",children:ve(C.duration)})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"File Size:"}),t.jsxs("span",{className:"text-gray-900",children:[(C.fileSize/1024).toFixed(1),"KB"]})]})]}),t.jsxs("div",{className:"space-y-1",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Avg Volume:"}),t.jsxs("span",{className:"text-gray-900",children:[(C.avgVolume*100).toFixed(1),"%"]})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Silence:"}),t.jsx("span",{className:"text-gray-900",children:ve(C.silenceDuration)})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Est. SNR:"}),t.jsxs("span",{className:"text-gray-900",children:[C.estimatedSNR.toFixed(1),"dB"]})]})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("canvas",{ref:M,width:400,height:80,className:`w-full h-20 bg-white rounded border transition-all duration-200 ${T?"cursor-grabbing border-blue-400 shadow-md":"cursor-pointer hover:bg-gray-50 hover:border-gray-300"}`,onClick:X,onMouseMove:Be=>{const Re=M.current;if(Re&&d&&isFinite(d)&&d>0&&!T){const re=Re.getBoundingClientRect(),Me=Be.clientX-re.left,be=Math.max(0,Math.min(100,Me/re.width*100))/100*d;Re.title=`Click to seek to ${ve(be)}`}else Re&&T&&(Re.title="Seeking...")},style:{touchAction:"none"}}),t.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[t.jsx("span",{children:ve(c)}),t.jsx("span",{className:T?"text-blue-600 font-medium":"",children:T?"Seeking...":"Click waveform to seek"}),t.jsx("span",{children:ve(d)})]}),t.jsxs("div",{className:"space-y-1",children:[t.jsx("input",{type:"range",min:"0",max:"100",step:"0.1",value:d&&isFinite(d)&&d>0?c/d*100:0,onMouseDown:()=>{k(!0),Y()},onMouseUp:()=>{k(!1),o&&!T&&H()},onTouchStart:()=>{k(!0),Y()},onTouchEnd:()=>{k(!1),o&&!T&&H()},onInput:Be=>{if(D){const Re=parseFloat(Be.target.value);isFinite(Re)&&G(Re)}},onChange:()=>{},className:"w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer",disabled:!d||!isFinite(d)||d<=0,title:"Seek audio position"}),t.jsx("div",{className:"text-xs text-gray-400 text-center",children:"Alternative: Use slider above to seek"})]})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(Zt,{onClick:te,icon:o?bp:wA,variant:"primary",size:"lg",disabled:!j,"aria-label":o?"Pause audio":"Play audio",className:"rounded-full w-10 h-10"}),t.jsx(Zt,{onClick:le,icon:vy,variant:"secondary",size:"sm",disabled:!j,"aria-label":"Reset to beginning",className:"rounded-full w-8 h-8"}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(cc,{className:"w-4 h-4 text-gray-600"}),t.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:x,onChange:Be=>{const Re=parseFloat(Be.target.value);b(Re),L.current&&(L.current.volume=Re)},className:"w-20 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer",title:"Adjust volume"})]})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsxs("select",{value:f,onChange:Be=>{const Re=parseFloat(Be.target.value);u(Re),L.current&&(L.current.playbackRate=Re)},className:"text-xs bg-white border border-gray-300 rounded px-2 py-1",title:"Playback speed",children:[t.jsx("option",{value:.5,children:"0.5x"}),t.jsx("option",{value:.75,children:"0.75x"}),t.jsx("option",{value:1,children:"1.0x"}),t.jsx("option",{value:1.25,children:"1.25x"}),t.jsx("option",{value:1.5,children:"1.5x"}),t.jsx("option",{value:2,children:"2.0x"})]}),t.jsx(ye,{onClick:he,variant:"outline",size:"sm",startIcon:Ya,className:"text-xs px-2 py-1",children:"Save"})]})]}),C.quality!=="good"&&t.jsx("div",{className:"bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded",children:t.jsx("div",{className:"flex items-start",children:t.jsxs("div",{className:"ml-3",children:[t.jsx("p",{className:"text-sm text-yellow-700 font-medium",children:"Audio Quality Issues Detected"}),t.jsxs("div",{className:"mt-1 text-xs text-yellow-600 space-y-1",children:[C.avgVolume<.005&&t.jsx("p",{children:"‚Ä¢ Recording is very quiet - check microphone levels"}),C.silenceDuration>C.duration*.5&&t.jsx("p",{children:"‚Ä¢ Recording contains significant silence"}),C.estimatedSNR<15&&t.jsx("p",{children:"‚Ä¢ High background noise detected"}),C.duration<2&&t.jsx("p",{children:"‚Ä¢ Recording is very short - may affect transcription accuracy"})]})]})})})]})]})};function qg(s){if(!s||!isFinite(s))return"0:00";const e=Math.floor(s/60),r=Math.floor(s%60);return`${e}:${r.toString().padStart(2,"0")}`}const rb=m.memo(({audioBlob:s,currentTime:e=0,duration:r=0,isPlaying:a=!1,isMuted:n=!1,onSeek:i,onPlayPause:o,onMuteToggle:l,className:c=""})=>{const[A,d]=m.useState(!1),[h,f]=m.useState([]),u=m.useRef(null),x=m.useRef(null);m.useEffect(()=>{if(!s){f([]);return}(async()=>{try{const E=await s.arrayBuffer(),T=new AudioContext,D=(await T.decodeAudioData(E)).getChannelData(0),k=80,R=Math.floor(D.length/k),w=[];for(let L=0;L<k;L++){let M=0;const P=L*R,K=Math.min(P+R,D.length);for(let $=P;$<K;$++)M+=Math.abs(D[$]);w.push(M/(K-P))}f(w),await T.close()}catch(E){console.error("Waveform generation failed:",E),f([])}})()},[s]);const b=m.useCallback(()=>{const C=x.current;if(!C)return;const E=C.getContext("2d");if(!E)return;const T=window.devicePixelRatio||1,Q=C.getBoundingClientRect();C.width=Q.width*T,C.height=Q.height*T,E.scale(T,T);const D=Q.width,k=Q.height,R=r>0?e/r:0;if(E.clearRect(0,0,D,k),h.length===0){const $=k/2-2,O=4;E.fillStyle="#e5e7eb",E.beginPath(),E.roundRect(0,$,D,O,2),E.fill(),E.fillStyle="#6b7280",E.beginPath(),E.roundRect(0,$,D*R,O,2),E.fill();return}const w=D/h.length,L=1,M=Math.max(...h),P=3;h.forEach(($,O)=>{const W=M>0?$/M:0,ee=Math.max(P,W*k*.85),V=O*w,q=(k-ee)/2;(O+.5)/h.length<=R?E.fillStyle=A?"#3b82f6":"#6b7280":E.fillStyle="#d1d5db";const H=Math.max(2,w-L);E.beginPath(),E.roundRect(V,q,H,ee,1),E.fill()});const K=R*D;E.strokeStyle=A?"#ef4444":"#4b5563",E.lineWidth=A?2:1.5,E.beginPath(),E.moveTo(K,2),E.lineTo(K,k-2),E.stroke()},[h,e,r,A]);m.useEffect(()=>{b()},[b]),m.useEffect(()=>{if(!a)return;let C;const E=()=>{b(),C=requestAnimationFrame(E)};return C=requestAnimationFrame(E),()=>cancelAnimationFrame(C)},[a,b]),m.useEffect(()=>{const C=()=>b();return window.addEventListener("resize",C),()=>window.removeEventListener("resize",C)},[b]);const N=C=>{if(!u.current||!r)return 0;const E=u.current.getBoundingClientRect(),T=C-E.left;return Math.max(0,Math.min(1,T/E.width))*r},v=C=>{if(!r||!i)return;const E=N(C.clientX);i(E)},j=C=>{C.preventDefault(),d(!0),v(C)};m.useEffect(()=>{if(!A)return;const C=T=>{if(!r||!i)return;const Q=N(T.clientX);i(Q)},E=()=>{d(!1)};return document.addEventListener("mousemove",C),document.addEventListener("mouseup",E),()=>{document.removeEventListener("mousemove",C),document.removeEventListener("mouseup",E)}},[A,r,i]);const I=C=>{if(C.preventDefault(),d(!0),C.touches[0]&&r&&i){const E=N(C.touches[0].clientX);i(E)}};return m.useEffect(()=>{if(!A)return;const C=T=>{if(!r||!i||!T.touches[0])return;T.preventDefault();const Q=N(T.touches[0].clientX);i(Q)},E=()=>{d(!1)};return document.addEventListener("touchmove",C,{passive:!1}),document.addEventListener("touchend",E),()=>{document.removeEventListener("touchmove",C),document.removeEventListener("touchend",E)}},[A,r,i]),t.jsxs("div",{className:`flex items-center gap-2 ${c}`,children:[o&&t.jsx("button",{onClick:o,className:"p-1.5 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors flex-shrink-0","aria-label":a?"Pause":"Play",children:a?t.jsx(bp,{className:"w-4 h-4"}):t.jsx(wA,{className:"w-4 h-4"})}),t.jsx("span",{className:"text-xs text-gray-600 tabular-nums w-9 flex-shrink-0",children:qg(e)}),t.jsx("div",{ref:u,className:"flex-1 h-8 relative select-none",style:{cursor:A?"grabbing":"pointer"},onMouseDown:j,onTouchStart:I,role:"slider","aria-valuenow":e,"aria-valuemin":0,"aria-valuemax":r,"aria-label":"Audio position",tabIndex:0,children:t.jsx("canvas",{ref:x,className:"w-full h-full",style:{display:"block"}})}),t.jsx("span",{className:"text-xs text-gray-500 tabular-nums w-9 text-right flex-shrink-0",children:qg(r)}),l&&t.jsx("button",{onClick:l,className:"p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors flex-shrink-0","aria-label":n?"Unmute":"Mute",children:n?t.jsx(J1,{className:"w-3.5 h-3.5"}):t.jsx(cc,{className:"w-3.5 h-3.5"})})]})});rb.displayName="AudioScrubber";const Gu=({state:s,size:e="md",variant:r="default",label:a,showIcon:n=!0,action:i,className:o=""})=>{const l=No(s),c={recording:"Recording",transcribing:"Transcribing","ai-analysis":"AI Analysis",generation:"Generating",completed:"Completed",error:"Error",needs_review:"Needs Review",processing:"Processing"},A={recording:t.jsx($r,{className:"w-full h-full"}),transcribing:t.jsx(Rn,{className:"w-full h-full"}),"ai-analysis":t.jsx(ol,{className:"w-full h-full"}),generation:t.jsx(Ac,{className:"w-full h-full"}),completed:t.jsx(ei,{className:"w-full h-full"}),error:t.jsx(or,{className:"w-full h-full"}),needs_review:t.jsx(xr,{className:"w-full h-full"}),processing:t.jsx(ol,{className:"w-full h-full"})},h={sm:{container:"h-6 px-2 text-xs gap-1",icon:"w-3 h-3",dot:"w-1.5 h-1.5",action:"ml-1 -mr-1 p-0.5",actionIcon:"w-3 h-3"},md:{container:"h-7 px-2.5 text-sm gap-1.5",icon:"w-3.5 h-3.5",dot:"w-2 h-2",action:"ml-1.5 -mr-1 p-0.5",actionIcon:"w-3.5 h-3.5"},lg:{container:"h-8 px-3 text-base gap-2",icon:"w-4 h-4",dot:"w-2.5 h-2.5",action:"ml-2 -mr-1 p-1",actionIcon:"w-4 h-4"}}[e],f=a||c[s],u={default:`
      ${l.bgGradient}
      border border-${l.border}/70
      text-${l.text}
    `,dot:`
      bg-gray-50
      border border-gray-200
      text-gray-700
    `,outline:`
      bg-transparent
      border-2 border-${l.border}
      text-${l.text}
    `};return t.jsxs("div",{className:`
        inline-flex items-center
        ${h.container}
        ${u[r]}
        rounded-full
        font-medium
        transition-all duration-200
        ${o}
      `,role:"status","aria-label":`Status: ${f}`,children:[n&&t.jsx(t.Fragment,{children:r==="dot"?t.jsx("span",{className:`
                ${h.dot}
                bg-${l.indicator}
                rounded-full
                animate-pulse
              `}):t.jsx("span",{className:`${h.icon} text-${l.indicator} flex-shrink-0`,children:A[s]})}),t.jsx("span",{className:"whitespace-nowrap",children:f}),i&&t.jsx("button",{onClick:i.onClick,className:`
            ${h.action}
            rounded-full
            hover:bg-black/10
            transition-colors
            focus:outline-none focus:ring-2 focus:ring-${l.indicator}
          `,"aria-label":i.label,children:i.icon?t.jsx("span",{className:h.actionIcon,children:i.icon}):t.jsx(es,{className:h.actionIcon})})]})},_C=({state:s,size:e="md",withTooltip:r=!0,className:a=""})=>{const n=No(s),i={sm:"w-2 h-2",md:"w-2.5 h-2.5",lg:"w-3 h-3"},o={recording:"Recording",transcribing:"Transcribing","ai-analysis":"AI Analysis",generation:"Generating",completed:"Completed",error:"Error",needs_review:"Needs Review",processing:"Processing"};return t.jsx("span",{className:`
        ${i[e]}
        bg-${n.indicator}
        border border-${n.border}
        rounded-full
        animate-pulse
        ${a}
      `,role:"status","aria-label":r?o[s]:void 0,title:r?o[s]:void 0})},QC=s=>{switch(s){case"approved":return"completed";case"edited":return"needs_review";case"skipped":return"error";case"pending":default:return"processing"}},OC=s=>{switch(s){case"pending":return"‚è≥ Not Reviewed";case"approved":return"‚úÖ Approved";case"edited":return"‚úèÔ∏è Edited";case"skipped":return"‚è≠Ô∏è Skipped";default:return"Unknown"}},Gi=m.memo(({originalTranscription:s,sessionId:e,sessionSource:r="recording",sessionErrors:a,pendingAudio:n,onTranscriptionCopy:i,onTranscriptionInsert:o,onTranscriptionEdit:l,transcriptionSaveStatus:c,onAgentReprocess:A,onRetryTranscription:d,isRetryingTranscription:h=!1,currentAgent:f,isProcessing:u=!1,className:x="",audioBlob:b,defaultExpanded:N=!1,collapseWhen:v,approvalState:j,onTranscriptionApprove:I})=>{if((!s||!s.trim())&&!u){const be=!!d&&r!=="paste",ce=n?.failureReason||a?.find(Boolean)||null;return t.jsx("div",{className:`border-b border-gray-200/50 ${x}`,children:t.jsxs("div",{className:"px-4 py-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-gray-500",children:[t.jsx(gn,{className:"w-4 h-4 flex-shrink-0"}),t.jsx("span",{className:"text-sm",children:"Transcription not available for this session"})]}),(ce||e||n||be)&&t.jsxs("div",{className:"mt-2 space-y-2",children:[ce&&t.jsxs("div",{className:"text-xs text-gray-600",children:[t.jsx("span",{className:"font-medium",children:"Reason:"})," ",ce]}),n&&t.jsxs("div",{className:"text-xs text-gray-600",children:[t.jsx("span",{className:"font-medium",children:"Saved audio:"})," ",n.saved?n.audioPath||"saved for retry":"not saved"]}),e&&t.jsxs("div",{className:"text-xs text-gray-500",children:[t.jsx("span",{className:"font-medium",children:"Session:"})," ",t.jsx("span",{className:"font-mono",children:e})]}),be&&t.jsx("div",{className:"pt-1",children:t.jsx(ye,{onClick:d,disabled:h||u,variant:"primary",size:"sm",className:"bg-amber-600 hover:bg-amber-700",title:"Retry transcription by reloading the saved audio and sending it to the transcription server",children:h?"Retrying transcription‚Ä¶":"Retry transcription from saved audio"})})]})]})})}const[E,T]=m.useState(!!N),[Q,D]=m.useState(!1),[k,R]=m.useState(!1),[w,L]=m.useState(s||""),[M,P]=m.useState(!1),[K,$]=m.useState(null),[O,W]=m.useState(null),[ee,V]=m.useState(!1),[q,S]=m.useState(0),[H,Y]=m.useState(0),[te,G]=m.useState(!1);bs.useEffect(()=>{if(!b){$(null),W(null);return}const be=URL.createObjectURL(b);$(be);const ce=new Audio(be);return ce.addEventListener("loadedmetadata",()=>{Y(ce.duration)}),ce.addEventListener("timeupdate",()=>{S(ce.currentTime)}),ce.addEventListener("ended",()=>{V(!1),S(0)}),ce.addEventListener("play",()=>{V(!0)}),ce.addEventListener("pause",()=>{V(!1)}),W(ce),()=>{ce.pause(),URL.revokeObjectURL(be)}},[b]);const le=bs.useMemo(()=>{if(!s)return!1;const be=s.toLowerCase(),ce=s.startsWith("[")&&s.endsWith("]"),Ie=be.includes("server not running")||be.includes("transcription failed")||be.includes("whisper server")||be.includes("server unavailable")||be.includes("timeout")||be.includes("can be reprocessed");return ce&&Ie},[s])&&!!d,he=()=>{O&&(ee?O.pause():O.play(),V(!ee))},ve=be=>{O&&(O.currentTime=be,S(be))},ke=()=>{O&&(O.muted=!te,G(!te))};bs.useEffect(()=>{v&&E&&T(!1)},[v]),bs.useEffect(()=>{L(s)},[s]);const Le=be=>{L(be),l&&l(be)},Be=[{name:"Letters",agents:[{id:"quick-letter",label:"Quick Letter",icon:"üìù"},{id:"consultation",label:"Consultation",icon:"üë®‚Äç‚öïÔ∏è"},{id:"patient-education",label:"Patient Education",icon:"üìö"}]},{name:"Clinical",agents:[{id:"background",label:"Background",icon:"üìã"},{id:"investigation-summary",label:"Investigation",icon:"üî¨"},{id:"medication",label:"Medications",icon:"üíä"},{id:"bloods",label:"Bloods",icon:"ü©∏"},{id:"imaging",label:"Imaging",icon:"üñºÔ∏è"}]},{name:"Structural",agents:[{id:"tavi",label:"TAVI",icon:"ü´Ä"},{id:"tavi-workup",label:"TAVI Workup",icon:"üìä"},{id:"mteer",label:"mTEER",icon:"üîß"},{id:"tteer",label:"tTEER",icon:"üî©"},{id:"pfo-closure",label:"PFO Closure",icon:"ü©π"},{id:"asd-closure",label:"ASD Closure",icon:"ü´Å"},{id:"pvl-plug",label:"PVL Plug",icon:"üîå"}]},{name:"Coronary",agents:[{id:"angiogram-pci",label:"Angiogram/PCI",icon:"ü©∫"},{id:"bypass-graft",label:"Bypass Graft",icon:"üîÄ"},{id:"right-heart-cath",label:"Right Heart Cath",icon:"üíì"}]},{name:"Planning",agents:[{id:"pre-op-plan",label:"Pre-Op Plan",icon:"üìë"}]}],Re=Be.flatMap(be=>be.agents),re=async()=>{if(i)try{await i(w),D(!0),setTimeout(()=>D(!1),2e3)}catch(be){console.error("Failed to copy transcription:",be)}},Me=async()=>{if(o)try{await o(w),R(!0),setTimeout(()=>R(!1),2e3)}catch(be){console.error("Failed to insert transcription:",be)}},Pe=be=>{A&&!u&&A(be)};return t.jsxs("div",{className:`border-b border-gray-200/50 ${x} ${u?"bg-blue-50/30 border-b-blue-200/50":""}`,children:[t.jsxs("div",{className:`flex items-center justify-between px-4 py-3 ${u?"hover:bg-blue-50/60":"hover:bg-gray-50/50"}`,children:[t.jsxs("button",{onClick:()=>T(!E),className:"flex items-center gap-2 min-w-0 text-left bg-transparent border-none cursor-pointer p-0",children:[t.jsx(gn,{className:`w-4 h-4 flex-shrink-0 ${u?"text-blue-600":"text-gray-600"}`}),t.jsx("span",{className:`font-medium text-sm ${u?"text-blue-900":"text-gray-900"}`,children:"Transcription"}),w!==s&&t.jsx("span",{className:"text-xs text-blue-600",children:"(edited)"}),E?t.jsx(Ph,{className:"w-3.5 h-3.5 text-gray-400 flex-shrink-0"}):t.jsx(Fh,{className:"w-3.5 h-3.5 text-gray-400 flex-shrink-0"})]}),t.jsx("div",{className:"flex-shrink-0",onClick:be=>be.stopPropagation(),children:t.jsx(rc,{onCopy:i?re:void 0,onInsert:o?Me:void 0,onReprocess:A?()=>{E?P(!M):(T(!0),P(!0))}:void 0,copiedRecently:Q,insertedRecently:k,actions:[...i?["copy"]:[],...o?["insert"]:[],...A?["reprocess"]:[]]})})]}),!E&&b&&K&&t.jsx("div",{className:"px-4 pb-3 -mt-1",children:t.jsx(rb,{audioBlob:b,currentTime:q,duration:H,isPlaying:ee,isMuted:te,onSeek:ve,onPlayPause:he,onMuteToggle:ke,className:"bg-gray-50/50 rounded-lg px-2 py-1.5"})}),E&&t.jsxs("div",{className:"px-4 pb-4",children:[t.jsxs("div",{className:"bg-gray-50/80 rounded-card p-2 border border-gray-200/50",children:[c&&c.status!=="idle"&&t.jsxs("div",{className:`flex items-center space-x-2 mb-2 p-2 rounded text-xs ${c.status==="saving"?"bg-yellow-50 text-yellow-700 border border-yellow-200":c.status==="saved"?"bg-green-50 text-green-700 border border-green-200":"bg-red-50 text-red-700 border border-red-200"}`,children:[c.status==="saving"&&t.jsx("div",{className:"w-3 h-3 border-2 border-yellow-400 border-t-transparent rounded-full animate-spin"}),t.jsx("span",{children:c.message}),c.timestamp&&t.jsxs("span",{className:"opacity-70",children:["at ",c.timestamp.toLocaleTimeString()]})]}),j&&I&&t.jsxs("div",{className:"mb-3 p-3 bg-white border rounded-lg",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h4",{className:"text-sm font-medium text-gray-800",children:"Transcription"}),t.jsx(Gu,{state:QC(j.status),size:"sm",label:OC(j.status)})]}),t.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[t.jsx(ye,{type:"button",onClick:()=>I("approved"),disabled:j.status==="approved",variant:"outline",size:"md",startIcon:t.jsx(Y1,{className:"w-4 h-4"}),className:`${j.status==="approved"?"bg-green-100 text-green-700 border-green-200":"border-2 hover:border-green-400 hover:bg-green-50"}`,title:"Mark this transcription as perfect for training",children:"Perfect"}),t.jsx(ye,{type:"button",onClick:()=>{j.status!=="edited"&&I("edited")},variant:"outline",size:"md",startIcon:t.jsx(si,{className:"w-4 h-4"}),className:`${j.status==="edited"?"bg-orange-100 text-orange-700 border-orange-200":"border-2 hover:border-orange-400 hover:bg-orange-50"}`,title:"Edit this transcription to improve accuracy",children:"Edit"}),t.jsx(ye,{type:"button",onClick:()=>I("skipped"),disabled:j.status==="skipped",variant:"outline",size:"md",startIcon:t.jsx(X1,{className:"w-4 h-4"}),className:`${j.status==="skipped"?"bg-gray-100 text-gray-700 border-gray-200":"border-2 hover:border-gray-400 hover:bg-gray-50"}`,title:"Skip this transcription for training",children:"Skip"})]}),j.status==="edited"&&t.jsx(ye,{type:"button",onClick:()=>{console.log("‚úÖ Submitting edited transcription for training"),I("approved")},variant:"primary",size:"md",fullWidth:!0,className:"mt-2",title:"Submit your corrections to improve AI training",children:"Send for Corrections"})]}),t.jsx("div",{className:"relative",children:t.jsx("textarea",{value:w,onChange:be=>Le(be.target.value),disabled:!l,className:`w-full h-32 p-2 text-sm text-gray-900 bg-white border border-gray-200 rounded resize-none focus:ring-2 focus:ring-violet-500/20 focus:border-violet-500 leading-relaxed ${l?"":"opacity-60 cursor-not-allowed"}`,placeholder:l?"Edit transcription to improve accuracy - corrections will be submitted for training only with your approval...":"Transcription editing not available",title:l?"Edit the transcription to improve accuracy. Training data is only submitted when you explicitly approve it.":"Transcription editing not available"})})]}),le&&t.jsx("div",{className:"mt-3 p-3 bg-amber-50 border border-amber-200 rounded-card",children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"flex-shrink-0 text-amber-600",children:t.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-sm font-medium text-amber-800",children:"Transcription Failed - Audio Available"}),t.jsx("p",{className:"text-xs text-amber-700 mt-1",children:"The Transcription server wasn't running when this was recorded. Your audio is still available and can be re-transcribed."}),t.jsx(ye,{onClick:d,disabled:h||u,variant:"primary",size:"sm",className:"mt-2 bg-amber-600 hover:bg-amber-700",children:h?t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"Retrying Transcription..."]}):t.jsx(t.Fragment,{children:"üîÑ Retry Transcription"})})]})]})}),b&&t.jsx("div",{className:"mt-3",children:t.jsx(sb,{audioBlob:b,fileName:`transcription-${f||"recording"}`,className:"",showQualityBar:!0,defaultExpanded:!1})}),A&&t.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-200",children:[t.jsx(ye,{onClick:()=>P(!M),variant:"ghost",size:"sm",fullWidth:!0,className:"justify-between px-2 py-1",endIcon:M?t.jsx(Ph,{className:"w-3 h-3 text-gray-400"}):t.jsx(Fh,{className:"w-3 h-3 text-gray-400"}),children:t.jsxs("p",{className:"text-xs text-gray-600",children:["Reprocess (",Re.length," agents)"]})}),M&&t.jsx("div",{className:"mt-2 space-y-2",children:Be.map(be=>t.jsxs("div",{className:"space-y-1",children:[t.jsx("p",{className:"text-[10px] font-medium text-gray-400 uppercase tracking-wider px-1",children:be.name}),t.jsx("div",{className:"flex flex-wrap gap-1",children:be.agents.map(ce=>t.jsxs(ye,{onClick:()=>Pe(ce.id),disabled:u,variant:f===ce.id?"outline":"ghost",size:"sm",className:`text-xs px-2 py-1 h-7 ${f===ce.id?"bg-blue-50 border-blue-200 text-blue-700":"bg-gray-50 hover:bg-gray-100 border border-gray-200 text-gray-700"}`,children:[t.jsx("span",{className:"text-sm",children:ce.icon}),t.jsx("span",{className:"ml-1",children:ce.label}),f===ce.id&&t.jsx("span",{className:"ml-1 text-blue-500",children:"‚Ä¢"})]},ce.id))})]},be.name))})]})]})]})});Gi.displayName="TranscriptionSection";const HC=bs.lazy(()=>ns(()=>import("./chunks/AIReasoningModal.BZb5xl_h.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]))),Ep=m.memo(({results:s,agentType:e,onCopy:r,onInsertToEMR:a,className:n="",reportMetadata:i,agentName:o,customActions:l=[],onEditAndTrain:c,editAndTrainActive:A=!1,disableEditAndTrain:d=!1})=>{const[h,f]=m.useState(!1),[u,x]=m.useState(!1),[b,N]=m.useState(!1),v=i?.reasoningArtifacts?.hasReasoningContent||i?.rawAIOutput&&i.rawAIOutput.trim().length>0,j=async()=>{try{await r(s),f(!0),setTimeout(()=>f(!1),2e3)}catch(Q){console.error("Failed to copy:",Q)}},I=async()=>{try{typeof a=="function"&&await a(s,void 0,e),x(!0),setTimeout(()=>x(!1),2e3)}catch(Q){console.error("Failed to insert to EMR:",Q)}},C=[{id:"copy",label:"Copy",icon:Xn},{id:"insert",label:"Insert",icon:Po}];c&&C.push({id:"edit",label:A?"Editing":"Train",icon:si,disabled:d}),v&&C.push({id:"reasoning",label:"AI",icon:ol}),l.forEach(Q=>{C.push({id:Q.id,label:Q.label,icon:Q.icon,disabled:Q.disabled})});const E=Q=>{switch(Q){case"copy":j();break;case"insert":I();break;case"edit":c?.();break;case"reasoning":N(!0);break;default:l.find(k=>k.id===Q)?.onClick()}},T=h?"copy":u?"insert":void 0;return t.jsxs("div",{className:`p-3 border-t border-gray-200 ${n}`,children:[t.jsx("div",{className:"flex items-center gap-2",children:t.jsx(qo,{options:C,onChange:E,successId:T,multiSelect:!0,size:"sm",fullWidth:!0,className:"flex-1 justify-between"})}),v&&t.jsx(m.Suspense,{fallback:null,children:t.jsx(HC,{isOpen:b,onClose:()=>N(!1),reasoningArtifacts:i?.reasoningArtifacts,rawAIOutput:i?.rawAIOutput,agentName:o})})]})});Ep.displayName="ActionButtons";const ab=m.memo(({agentType:s,title:e,subtitle:r,completedTime:a,processingTime:n,confidence:i,originalTranscription:o,onTranscriptionCopy:l,onTranscriptionInsert:c,onTranscriptionEdit:A,transcriptionSaveStatus:d,onAgentReprocess:h,onRetryTranscription:f,isRetryingTranscription:u=!1,isProcessing:x=!1,audioBlob:b,transcriptionApprovalState:N,onTranscriptionApprove:v,children:j,results:I,onCopy:C,onInsertToEMR:E,reportMetadata:T,agentName:Q,className:D="",hideTranscription:k=!1,hideActions:R=!1})=>{const w=Yy(I),L=Xy(w),M=e||(s?`${s.charAt(0).toUpperCase()+s.slice(1).replace("-"," ")} Results`:"Results");return t.jsxs(Ye.div,{className:`operator-results-container bg-white/95 backdrop-blur-sm rounded-card shadow-card border border-gray-200 overflow-hidden ${D}`,variants:Na(Ci),initial:"hidden",animate:"visible",exit:"exit",children:[t.jsxs("div",{className:"operator-results-header bg-gradient-to-br from-emerald-50/80 to-teal-50/60 p-4 border-b border-emerald-200/50",children:[t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx("div",{className:"flex-shrink-0",children:t.jsx(Rn,{className:"w-5 h-5 text-emerald-600"})}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-base font-semibold text-gray-900 leading-tight",children:M}),r&&t.jsx("p",{className:"text-sm text-gray-600 mt-0.5",children:r}),t.jsxs("div",{className:"flex flex-wrap items-center gap-3 mt-2 text-xs text-gray-600",children:[a&&t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx(_a,{className:"w-3 h-3"}),t.jsx("span",{children:Uh(a)})]}),n&&t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx("span",{children:"‚Ä¢"}),t.jsxs("span",{children:[(n/1e3).toFixed(1),"s processing"]})]}),w>0&&t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx("span",{children:"‚Ä¢"}),t.jsxs("span",{children:[w," words"]})]}),L&&t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx("span",{children:"‚Ä¢"}),t.jsxs("span",{children:[kC(L)," read"]})]})]})]})]}),t.jsx("div",{className:"flex-shrink-0",children:t.jsx(Ra,{className:"w-5 h-5 text-emerald-600"})})]}),i!==void 0&&i>0&&t.jsx("div",{className:"mt-3 pt-3 border-t border-emerald-200/50",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-xs text-gray-600",children:"AI Confidence"}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("div",{className:"w-32 h-1.5 bg-emerald-100 rounded-full overflow-hidden",children:t.jsx("div",{className:"h-full bg-emerald-500 rounded-full transition-all duration-500",style:{width:`${i}%`}})}),t.jsxs("span",{className:"text-xs font-medium text-emerald-700",children:[i,"%"]})]})]})})]}),!k&&o&&t.jsx(Gi,{originalTranscription:o,onTranscriptionCopy:l,onTranscriptionInsert:c,onTranscriptionEdit:A,transcriptionSaveStatus:d,onAgentReprocess:h,onRetryTranscription:f,isRetryingTranscription:u,currentAgent:s,isProcessing:x,audioBlob:b,defaultExpanded:!1,collapseWhen:!x,approvalState:N,onTranscriptionApprove:v}),t.jsx("div",{className:"results-content",children:j}),!R&&t.jsx(Ep,{results:I,agentType:s,onCopy:C,onInsertToEMR:E,reportMetadata:T,agentName:Q})]})});ab.displayName="ResultsContainer";const kp=m.memo(({results:s,agentType:e,className:r="",onCopy:a,onInsert:n,onTrain:i,copiedRecently:o=!1,insertedRecently:l=!1})=>{const[c,A]=m.useState(!0),[d,h]=m.useState(!1),[f,u]=m.useState(null),x=m.useRef(null),b=m.useMemo(()=>{if(e!=="patient-education")return null;try{const R=s.match(/\n---\n/);if(R&&R.index!==void 0){const w=s.substring(0,R.index).trim(),L=s.substring(R.index+R[0].length).trim();try{return{jsonMetadata:JSON.parse(w),letterContent:L}}catch(M){return console.warn("Failed to parse JSON metadata:",M),{jsonMetadata:null,letterContent:s}}}else return console.warn("No delimiter found in patient education output"),{jsonMetadata:null,letterContent:s}}catch(R){console.error("Error parsing patient education response:",R)}return null},[s,e]),N=m.useMemo(()=>{const R=s.split(/\s+/).filter(P=>P.length>0).length,w=Math.ceil(R/200),L=s.length,M=s.split(`
`).length;return{wordCount:R,readingTime:w,charCount:L,lineCount:M}},[s]),v=e!=="angiogram-pci"&&s.length>1e3,j=m.useMemo(()=>!v||d?s:s.substring(0,500)+"...",[s,v,d]),I=m.useCallback(R=>{const w=[],L=R.split(`
`);let M=null;const P=e==="medication",K=()=>{M&&M.content.trim().length>0&&w.push({title:M.title||"Medical Report",content:M.content.trim()})},$=e==="angiogram-pci",O=e==="right-heart-cath",W=["PREAMBLE","FINDINGS","FINDINGS/PROCEDURE","PROCEDURE","CONCLUSION"];for(const ee of L){const V=ee.trim();if(!V)continue;const q=V.replace(/^[#>*\s]+/,"").replace(/\*+$/g,"").replace(/:$/,"").trim();(()=>{if(P||!q)return!1;const H=q.toUpperCase();if($||O)return W.includes(H);if(["PREAMBLE","FINDINGS","FINDINGS/PROCEDURE","PROCEDURE","CONCLUSION","ADDITIONAL NOTES","LEFT VENTRICLE"].includes(H))return!0;const te=q===H&&H.length<=60&&!H.includes("."),G=/^[A-Z][A-Za-z\s()/-]{2,40}$/.test(q);return te||G})()?(K(),M={title:q,content:""}):M?M.content+=(M.content?`
`:"")+ee:M={title:"Medical Report",content:ee}}return K(),w.length===0?[{title:"Medical Report",content:R}]:w},[e]),C=m.useMemo(()=>I(s),[s,I]),E=m.useMemo(()=>I(j),[j,I]),T=R=>R?{tavi:"TAVI Report","angiogram-pci":"Angiogram/PCI Report","quick-letter":"Quick Letter",consultation:"Consultation Report","investigation-summary":"Investigation Summary",background:"Background Summary",medication:"Medication Review",bloods:"Blood Test Order",imaging:"Imaging Order",mteer:"mTEER Report",tteer:"TTEER Report","pfo-closure":"PFO Closure Report","asd-closure":"ASD Closure Report","pvl-plug":"PVL Plug Report","bypass-graft":"Bypass Graft Report","right-heart-cath":"Right Heart Catheterisation","tavi-workup":"TAVI Workup","ai-medical-review":"AI Medical Review","batch-ai-review":"Batch AI Review","patient-education":"Patient Education","pre-op-plan":"Pre-Op Plan Summary","ohif-viewer":"Imaging Viewer Summary","aus-medical-review":"Australian Medical Review",enhancement:"Enhanced Report",transcription:"Transcription",generation:"Generated Report"}[R]||R.toUpperCase():"Medical Report",Q=async(R,w)=>{try{const M=(K=>{let $=K.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>");return $=$.replace(/\n/g,"<br>"),$})(R),P=new ClipboardItem({"text/html":new Blob([M],{type:"text/html"}),"text/plain":new Blob([R],{type:"text/plain"})});await navigator.clipboard.write([P]),u(w),setTimeout(()=>u(null),2e3)}catch(L){console.warn("HTML copy failed, falling back to plain text:",L);try{await navigator.clipboard.writeText(R),u(w),setTimeout(()=>u(null),2e3)}catch(M){console.error("Failed to copy:",M)}}},D=()=>{if(x.current&&b?.jsonMetadata){const R=window.open("","_blank");if(R){const w=JSON.stringify(b.jsonMetadata,null,2);R.document.write(`
          <!DOCTYPE html>
          <html>
            <head>
              <title>Patient Education Plan - Structured Data</title>
              <style>
                body { font-family: monospace; padding: 20px; }
                pre { white-space: pre-wrap; word-wrap: break-word; }
                h1 { font-size: 18px; margin-bottom: 20px; }
              </style>
            </head>
            <body>
              <h1>Patient Education Plan - Structured Data</h1>
              <pre>${w}</pre>
            </body>
          </html>
        `),R.document.close(),R.print()}}};if(!s)return null;if(e==="patient-education"&&b){const{letterContent:R,jsonMetadata:w}=b;return t.jsx("div",{className:`bg-white border border-gray-200 rounded-lg overflow-hidden ${r}`,children:t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Rn,{className:"w-4 h-4 text-emerald-600"}),t.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Patient Letter"})]}),t.jsx(ye,{onClick:()=>Q(R,"letter"),variant:f==="letter"?"success":"outline",size:"sm",startIcon:f==="letter"?t.jsx(Ra,{className:"w-3 h-3"}):t.jsx(Xn,{className:"w-3 h-3"}),className:"text-xs",children:f==="letter"?"Copied!":"Copy"})]}),t.jsx("div",{className:"bg-gray-50 rounded-lg p-4 border border-gray-200",children:t.jsx("div",{className:"text-gray-800 text-sm leading-relaxed whitespace-pre-wrap",children:R})})]}),w&&t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(dA,{className:"w-4 h-4 text-blue-600"}),t.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Action Plan (Structured Data)"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(ye,{onClick:()=>Q(JSON.stringify(w,null,2),"json"),variant:f==="json"?"success":"outline",size:"sm",startIcon:f==="json"?t.jsx(Ra,{className:"w-3 h-3"}):t.jsx(Xn,{className:"w-3 h-3"}),className:"text-xs",children:f==="json"?"Copied!":"Copy JSON"}),t.jsx(ye,{onClick:D,variant:"primary",size:"sm",startIcon:t.jsx(Ya,{className:"w-3 h-3"}),className:"text-xs",children:"Export PDF"})]})]}),t.jsx("div",{ref:x,className:"bg-gray-900 rounded-lg p-4 border border-gray-700 overflow-x-auto",children:t.jsx("pre",{className:"text-xs text-green-400 font-mono whitespace-pre-wrap break-words",children:JSON.stringify(w,null,2)})})]})]})})}return e==="investigation-summary"||e==="background"||e==="medication"?t.jsxs("div",{className:`relative bg-white border border-gray-200 rounded-lg overflow-hidden ${r}`,children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b border-gray-100 bg-gray-50",children:[t.jsx("h4",{className:"text-sm font-medium text-gray-700",children:T(e)}),(a||n||i)&&t.jsx(rc,{onCopy:a?()=>a(s):void 0,onInsert:n?()=>n(s):void 0,onTrain:i,copiedRecently:o,insertedRecently:l,actions:[...a?["copy"]:[],...n?["insert"]:[],...i?["train"]:[]],showKeyboardHints:!0})]}),t.jsx("div",{className:"p-4 space-y-4",children:E.length>0?E.map((R,w)=>t.jsx("div",{className:"text-gray-900 text-sm leading-relaxed whitespace-pre-wrap bg-gray-50 border border-gray-200 rounded-lg p-4",children:R.content},`${R.title||"section"}-${w}`)):t.jsx("div",{className:"text-gray-900 text-sm leading-relaxed whitespace-pre-wrap",children:j})})]}):t.jsxs("div",{className:`bg-white border border-gray-200 rounded-lg overflow-hidden ${r}`,children:[t.jsx("div",{className:"p-4 border-b border-gray-200",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(Zt,{onClick:()=>A(!c),variant:"ghost",size:"sm",icon:c?t.jsx(Vr,{className:"w-5 h-5"}):t.jsx(ps,{className:"w-5 h-5"}),"aria-label":c?"Collapse report":"Expand report"}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-gray-900 font-semibold text-sm",children:T(e)}),t.jsx("div",{className:"text-gray-600 text-xs mt-1",children:t.jsx("span",{children:new Date().toLocaleTimeString()})})]})]}),v&&t.jsx(ye,{onClick:()=>h(!d),variant:"ghost",size:"sm",className:"text-xs font-medium",children:d?"Show Less":"Show More"})]})}),c&&t.jsxs("div",{className:"report-content",children:[t.jsx("div",{className:"space-y-4 p-4",children:E.map((R,w)=>{const L=C[w]?.content||R.content,M=R.title||`Section ${w+1}`,P=`section-${w}`;return t.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg shadow-sm p-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h4",{className:"font-semibold text-gray-900 text-sm",children:M}),t.jsx(ye,{onClick:()=>Q(L,P),variant:f===P?"success":"outline",size:"sm",startIcon:f===P?t.jsx(Ra,{className:"w-3 h-3"}):t.jsx(Xn,{className:"w-3 h-3"}),className:"text-xs",children:f===P?"Copied":"Copy"})]}),t.jsx("div",{className:"text-gray-900 text-sm leading-relaxed whitespace-pre-wrap",children:R.content})]},`${M}-${w}`)})}),E.length===0&&t.jsx("div",{className:"p-4",children:t.jsx("div",{className:"text-gray-900 text-sm leading-relaxed whitespace-pre-wrap",children:j})}),v&&!d&&t.jsx("div",{className:"px-4 pb-4",children:t.jsxs(ye,{onClick:()=>h(!0),variant:"ghost",size:"sm",endIcon:t.jsx(ps,{className:"w-4 h-4"}),className:"text-sm font-medium",children:["Show complete report (",N.charCount," characters)"]})})]})]})});kp.displayName="ReportDisplay";const VC=({finding:s,index:e,isCompleted:r,onToggleComplete:a,className:n="",useBrightDesign:i=!1})=>{const[o,l]=m.useState(!1),c=b=>{switch(b){case"Immediate":return t.jsx(xr,{className:"w-4 h-4 text-red-600"});case"Soon":return t.jsx(_a,{className:"w-4 h-4 text-orange-500"});case"Routine":return t.jsx(Ra,{className:"w-4 h-4 text-green-600"});default:return t.jsx(sl,{className:"w-4 h-4 text-gray-500"})}},A=b=>{if(r)return i?"border-white bg-gradient-bright opacity-60":"border-gray-200 bg-gray-50 opacity-60";if(i)switch(b){case"Immediate":return"border-rose-300 bg-gradient-bright-rose";case"Soon":return"border-amber-300 bg-gradient-bright-amber";case"Routine":return"border-emerald-300 bg-gradient-bright-emerald";default:return"border-white bg-gradient-bright"}else switch(b){case"Immediate":return"border-red-200 bg-red-50";case"Soon":return"border-orange-200 bg-orange-50";case"Routine":return"border-green-200 bg-green-50";default:return"border-gray-200 bg-gray-50"}},d=b=>{if(r)return"completed";switch(b){case"Immediate":return"error";case"Soon":return"needs_review";case"Routine":return"completed";default:return"processing"}},h=()=>{a(e)},f=i?"border-bright":"border-2",u=i?"rounded-bright":"rounded-lg",x=i?"shadow-bright-card hover:shadow-bright-elevated":"";return t.jsxs("div",{className:`${f} ${u} ${x} transition-all duration-200 ${A(s.urgency)} ${n} ${r?"transform scale-[0.98]":""}`,children:[t.jsxs("div",{className:"p-4",children:[t.jsxs("div",{className:"flex items-start justify-between mb-3",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(Zt,{onClick:h,icon:r?t.jsx(Ra,{}):t.jsx(dc,{}),variant:"ghost",size:"sm",className:r?"text-green-600":"text-gray-400 hover:text-gray-600",title:r?"Mark as incomplete":"Mark as complete","aria-label":r?"Mark as incomplete":"Mark as complete"}),t.jsxs("div",{className:"flex items-center space-x-2",children:[c(s.urgency),t.jsxs("span",{className:`font-semibold text-sm ${r?"text-gray-500 line-through":"text-gray-900"}`,children:["Finding ",e+1]})]})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Gu,{state:d(s.urgency),size:"sm",label:s.urgency}),t.jsx(ye,{onClick:()=>l(!o),variant:"ghost",size:"sm",className:"text-xs text-blue-600 hover:text-blue-800 font-medium",children:o?"Collapse":"Details"})]})]}),t.jsxs("div",{className:"mb-3",children:[t.jsx("h5",{className:`font-medium text-sm mb-1 ${r?"text-gray-500":"text-gray-900"}`,children:"Clinical Finding"}),t.jsx("p",{className:`text-sm ${r?"text-gray-400 line-through":"text-gray-700"}`,children:s.finding})]}),t.jsxs("div",{className:"mb-3",children:[t.jsx("h5",{className:`font-medium text-sm mb-1 ${r?"text-gray-500":"text-gray-900"}`,children:"Recommended Action"}),t.jsx("p",{className:`text-sm font-medium ${r?"text-gray-400 line-through":"text-indigo-700"}`,children:s.recommendedAction})]}),o&&t.jsxs("div",{className:"space-y-3 pt-3 border-t border-gray-200",children:[t.jsxs("div",{children:[t.jsx("h5",{className:`font-medium text-sm mb-1 ${r?"text-gray-500":"text-gray-900"}`,children:"Australian Guideline"}),t.jsx("p",{className:`text-sm font-medium ${r?"text-gray-400":"text-blue-700"}`,children:s.australianGuideline})]}),t.jsxs("div",{children:[t.jsx("h5",{className:`font-medium text-sm mb-1 ${r?"text-gray-500":"text-gray-900"}`,children:"Clinical Reasoning"}),t.jsx("p",{className:`text-sm ${r?"text-gray-400":"text-gray-700"}`,children:s.clinicalReasoning})]}),s.heartFoundationLink&&t.jsx("div",{children:t.jsxs("a",{href:s.heartFoundationLink,target:"_blank",rel:"noopener noreferrer",className:`inline-flex items-center space-x-1 text-sm hover:underline ${r?"text-gray-400 pointer-events-none":"text-red-600 hover:text-red-700"}`,children:[t.jsx(Zn,{className:"w-4 h-4"}),t.jsx("span",{children:"Heart Foundation Resource"}),t.jsx(Po,{className:"w-3 h-3"})]})})]})]}),r&&t.jsx("div",{className:"px-4 py-2 bg-green-100 border-t border-green-200",children:t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Ms,{className:"w-4 h-4 text-green-600"}),t.jsx("span",{className:"text-green-700 text-xs font-medium",children:"Action completed"})]})})]})},$C=({classification:s,findings:e,guidelineReferences:r,heartFoundationResources:a,cvdRiskCalculatorRecommended:n,aboriginalTorresStraitIslander:i,qtProlongationRisk:o,medicationSafetyIssues:l,missingTests:c,therapyTargets:A,clinicalNotes:d,isProcessing:h=!1,useBrightCards:f=!1})=>{const x=(E=>{switch(E){case"primary":return{label:"Primary Prevention",color:"emerald",bgGradient:"from-emerald-50 to-teal-50",borderColor:"border-emerald-200",textColor:"text-emerald-800",icon:qi};case"secondary-cad":return{label:"Secondary Prevention (CAD)",color:"red",bgGradient:"from-red-50 to-rose-50",borderColor:"border-red-200",textColor:"text-red-800",icon:e2};case"secondary-hfref":return{label:"Secondary Prevention (HFrEF)",color:"purple",bgGradient:"from-purple-50 to-indigo-50",borderColor:"border-purple-200",textColor:"text-purple-800",icon:Zn};case"secondary-valvular":return{label:"Secondary Prevention (Valvular)",color:"blue",bgGradient:"from-blue-50 to-cyan-50",borderColor:"border-blue-200",textColor:"text-blue-800",icon:lu};case"mixed":return{label:"Mixed (Primary + Secondary)",color:"amber",bgGradient:"from-amber-50 to-yellow-50",borderColor:"border-amber-200",textColor:"text-amber-800",icon:sl}}})(s.category),b=x.icon,[N,v]=m.useState(new Set),j=E=>{const T=new Set(N);N.has(E)?T.delete(E):T.add(E),v(T)},I=N.size,C=e.length;return h?t.jsxs("div",{className:"glass rounded-2xl p-6",children:[t.jsxs("div",{className:"flex items-center space-x-3 mb-4",children:[t.jsx(sl,{className:"w-6 h-6 text-purple-600 animate-pulse"}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-gray-900 font-semibold text-lg",children:"AI Medical Review"}),t.jsx("p",{className:"text-gray-600 text-sm",children:"Analyzing patient data against Australian guidelines..."})]})]}),t.jsx("div",{className:"flex items-center justify-center py-8",children:t.jsx("div",{className:"w-8 h-8 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin"})})]}):t.jsxs("div",{className:"glass rounded-2xl overflow-hidden",children:[t.jsxs("div",{className:"p-6 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-blue-50",children:[t.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[t.jsx(sl,{className:"w-6 h-6 text-purple-600"}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-gray-900 font-semibold text-lg",children:"Comprehensive Cardiovascular Review"}),t.jsx("p",{className:"text-gray-600 text-sm",children:"Primary + Secondary Prevention ‚Ä¢ NHFA/CSANZ/RACGP Guidelines"})]})]}),t.jsx("div",{className:`mt-4 p-4 rounded-lg border-2 bg-gradient-to-r ${x.bgGradient} ${x.borderColor}`,children:t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx(b,{className:`w-5 h-5 mt-0.5 ${x.textColor} flex-shrink-0`}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[t.jsx("h4",{className:`font-semibold text-sm ${x.textColor}`,children:x.label}),t.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs font-medium bg-white/50 ${x.textColor}`,children:s.category.toUpperCase()})]}),t.jsx("p",{className:"text-gray-700 text-xs mb-2",children:s.rationale}),s.reviewFocus.length>0&&t.jsxs("div",{className:"mt-2",children:[t.jsx("p",{className:"text-gray-600 text-xs font-medium mb-1",children:"Review Focus:"}),t.jsx("div",{className:"flex flex-wrap gap-1",children:s.reviewFocus.map((E,T)=>t.jsx("span",{className:"px-2 py-0.5 bg-white/70 text-gray-700 text-xs rounded",children:E},T))})]})]})]})}),t.jsxs("div",{className:"grid grid-cols-4 gap-3",children:[t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-2xl font-bold text-purple-600",children:C}),t.jsx("div",{className:"text-xs text-gray-600",children:"Total Findings"})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-2xl font-bold text-green-600",children:I}),t.jsx("div",{className:"text-xs text-gray-600",children:"Completed"})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-2xl font-bold text-red-600",children:e.filter(E=>E.urgency==="Immediate").length}),t.jsx("div",{className:"text-xs text-gray-600",children:"Immediate"})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-2xl font-bold text-orange-600",children:l}),t.jsx("div",{className:"text-xs text-gray-600",children:"Medication Safety"})]})]}),C>0&&t.jsxs("div",{className:"mt-4",children:[t.jsxs("div",{className:"flex justify-between items-center mb-2",children:[t.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Progress"}),t.jsxs("span",{className:"text-sm text-gray-600",children:[I,"/",C," completed"]})]}),t.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:t.jsx("div",{className:"bg-green-500 h-2 rounded-full transition-all duration-300",style:{width:`${C>0?I/C*100:0}%`}})})]}),t.jsxs("div",{className:"mt-4 space-y-2",children:[i&&t.jsx("div",{className:"p-3 bg-blue-100 border border-blue-200 rounded-lg",children:t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(vp,{className:"w-4 h-4 text-blue-600"}),t.jsx("span",{className:"text-blue-800 text-sm font-medium",children:"Aboriginal/Torres Strait Islander considerations included"})]})}),o&&t.jsx("div",{className:"p-3 bg-yellow-100 border border-yellow-200 rounded-lg",children:t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(xr,{className:"w-4 h-4 text-yellow-600"}),t.jsx("span",{className:"text-yellow-800 text-sm font-medium",children:"QT prolongation risk identified - review medications and ECG monitoring"})]})})]})]}),t.jsx("div",{className:"p-6",children:e.length===0?t.jsxs("div",{className:"text-center py-8",children:[t.jsx(Ra,{className:"w-12 h-12 text-green-500 mx-auto mb-3"}),t.jsx("h4",{className:"text-gray-900 font-medium text-lg mb-2",children:"No Critical Issues Identified"}),t.jsx("p",{className:"text-gray-600 text-sm",children:"The AI review found no major clinical oversights based on Australian guidelines."})]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("h4",{className:"font-semibold text-gray-900 text-base",children:"Clinical Findings"}),t.jsxs("div",{className:"flex space-x-2",children:[t.jsx(ye,{onClick:()=>v(new Set),variant:"ghost",size:"sm",className:"text-xs",disabled:I===0,children:"Clear all"}),t.jsx(ye,{onClick:()=>v(new Set(Array.from({length:C},(E,T)=>T))),variant:"ghost",size:"sm",className:"text-xs text-blue-600 hover:text-blue-800",disabled:I===C,children:"Complete all"})]})]}),t.jsx("div",{className:"space-y-4",children:e.map((E,T)=>t.jsx(VC,{finding:E,index:T,isCompleted:N.has(T),onToggleComplete:j,useBrightDesign:f},T))}),I===C&&C>0&&t.jsx("div",{className:"mt-6 p-4 bg-green-50 border border-green-200 rounded-lg",children:t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Ra,{className:"w-5 h-5 text-green-600"}),t.jsxs("div",{children:[t.jsx("h5",{className:"font-medium text-green-800",children:"All Findings Addressed"}),t.jsx("p",{className:"text-green-700 text-sm",children:"You have completed all clinical findings from the AI review."})]})]})})]})}),c&&c.length>0||A&&Object.keys(A).length>0?t.jsxs("div",{className:"p-6 border-t border-gray-200 bg-gradient-to-r from-emerald-50/30 to-teal-50/30",children:[t.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[t.jsx(Ma,{className:"w-5 h-5 text-emerald-600"}),t.jsx("h4",{className:"font-semibold text-gray-900 text-sm",children:"Primary Prevention Recommendations"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[c&&c.length>0&&t.jsxs("div",{className:"bg-white/70 backdrop-blur-sm rounded-lg p-4 border border-emerald-200",children:[t.jsx("h5",{className:"font-medium text-emerald-800 text-xs mb-2",children:"Missing / Next Tests"}),t.jsx("ul",{className:"space-y-1",children:c.map((E,T)=>t.jsxs("li",{className:"text-gray-700 text-xs flex items-start",children:[t.jsx("span",{className:"text-emerald-600 mr-2",children:"‚Ä¢"}),t.jsx("span",{children:E})]},T))})]}),A&&Object.keys(A).length>0&&t.jsxs("div",{className:"bg-white/70 backdrop-blur-sm rounded-lg p-4 border border-teal-200",children:[t.jsx("h5",{className:"font-medium text-teal-800 text-xs mb-2",children:"Therapy Targets"}),t.jsx("dl",{className:"space-y-1",children:Object.entries(A).map(([E,T],Q)=>t.jsxs("div",{className:"flex items-start text-xs",children:[t.jsxs("dt",{className:"font-medium text-gray-700 mr-2",children:[E,":"]}),t.jsx("dd",{className:"text-gray-600",children:T})]},Q))})]})]}),d&&t.jsxs("div",{className:"mt-4 bg-amber-50/50 border border-amber-200 rounded-lg p-4",children:[t.jsx("h5",{className:"font-medium text-amber-800 text-xs mb-2",children:"Clinical Notes"}),t.jsx("p",{className:"text-gray-700 text-xs whitespace-pre-line",children:d})]})]}):null,t.jsxs("div",{className:"p-6 bg-gray-50 border-t border-gray-200",children:[t.jsx("h4",{className:"font-semibold text-gray-900 text-sm mb-4",children:"Australian Clinical Resources"}),r.length>0&&t.jsxs("div",{className:"mb-4",children:[t.jsx("h5",{className:"font-medium text-gray-700 text-xs mb-2",children:"Guidelines Referenced"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:r.map((E,T)=>t.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full",children:E},T))})]}),a.length>0&&t.jsxs("div",{className:"mb-4",children:[t.jsx("h5",{className:"font-medium text-gray-700 text-xs mb-2",children:"Heart Foundation Resources"}),t.jsx("div",{className:"space-y-2",children:a.map((E,T)=>t.jsxs("a",{href:E,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center space-x-1 text-red-600 hover:text-red-700 text-xs",children:[t.jsx(Zn,{className:"w-3 h-3"}),t.jsxs("span",{children:["Resource ",T+1]}),t.jsx(Po,{className:"w-3 h-3"})]},T))})]}),n&&t.jsxs("div",{className:"mb-4",children:[t.jsx("h5",{className:"font-medium text-gray-700 text-xs mb-2",children:"Recommended Calculator"}),t.jsxs("a",{href:"http://www.cvdcheck.org.au/",target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center space-x-1 text-blue-600 hover:text-blue-700 text-xs",children:[t.jsx(Z1,{className:"w-3 h-3"}),t.jsx("span",{children:"Australian CVD Risk Calculator"}),t.jsx(Po,{className:"w-3 h-3"})]})]}),t.jsx("div",{className:"mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:t.jsxs("div",{className:"flex items-start space-x-2",children:[t.jsx(xr,{className:"w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-yellow-800 text-xs font-medium mb-1",children:"Important Disclaimer"}),t.jsx("p",{className:"text-yellow-700 text-xs",children:"AI-generated clinical suggestions based on Australian guidelines (NHFA/CSANZ/RACGP) for cardiology practice. Not a substitute for clinical judgment. Verify recommendations against current guidelines and local policies."})]})]})})]})]})},nb=m.memo(({reviewData:s,className:e="",useBrightCards:r,storageKey:a="ui_preferences_card_theme"})=>{const[n,i]=m.useState(!1),[o,l]=m.useState(!1);m.useEffect(()=>{(async()=>{try{const x=(await chrome.storage.local.get(a))[a];i(x==="bright")}catch(u){console.error("Failed to load card theme preference:",u)}finally{l(!0)}})();const f=u=>{if(u[a]){const x=u[a].newValue;i(x==="bright")}};return chrome.storage.onChanged.addListener(f),()=>{chrome.storage.onChanged.removeListener(f)}},[a]);const c=r!==void 0?r:n;console.log("üé¥ AI REVIEW CARDS: Rendering with data:",{hasReviewData:!!s,hasClassification:!!s?.classification,findingsCount:s?.findings?.length||0,hasMissingTests:!!s?.missingTests,hasTherapyTargets:!!s?.therapyTargets,classification:s?.classification?.category});const A=Array.isArray(s?.findings)?s.findings:[],d={category:"primary",rationale:"Classification not provided",triggers:[],reviewFocus:[]};return t.jsx("div",{className:e,children:t.jsx($C,{classification:s?.classification||d,findings:A,guidelineReferences:s?.guidelineReferences||[],heartFoundationResources:s?.heartFoundationResources||[],cvdRiskCalculatorRecommended:s?.cvdRiskCalculatorRecommended||!1,aboriginalTorresStraitIslander:s?.aboriginalTorresStraitIslander||!1,qtProlongationRisk:s?.qtProlongationRisk||!1,medicationSafetyIssues:s?.medicationSafetyIssues||0,missingTests:s?.missingTests,therapyTargets:s?.therapyTargets,clinicalNotes:s?.clinicalNotes,isProcessing:!1,useBrightCards:c})})});nb.displayName="AIReviewCards";const ib=m.memo(({warnings:s=[],onDismissWarnings:e,className:r=""})=>{const[a,n]=m.useState(!1);return!s||s.length===0?null:t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:()=>n(!a),className:"inline-flex items-center space-x-1 cursor-pointer hover:opacity-80 transition-opacity",title:`${s.length} warning${s.length!==1?"s":""} - click to ${a?"hide":"view"}`,children:t.jsx(Gu,{state:"needs_review",size:"sm",label:`${s.length}`})}),a&&t.jsx("div",{className:`p-4 border-b border-orange-200/50 bg-orange-50/30 ${r}`,children:t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx(dl,{className:"w-4 h-4 text-orange-500 flex-shrink-0 mt-0.5"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("h4",{className:"text-orange-800 font-medium text-sm mb-2",children:"Content Warnings"}),t.jsx("ul",{className:"space-y-1",children:s.map((i,o)=>t.jsxs("li",{className:"text-orange-700 text-sm leading-relaxed",children:["‚Ä¢ ",i]},o))}),e&&t.jsx(ye,{onClick:()=>{e(),n(!1)},variant:"ghost",size:"sm",className:"mt-3 text-orange-600 hover:text-orange-700",children:"Dismiss warnings"})]})]})})]})});ib.displayName="WarningsPanel";const ob=m.memo(({failedAudioRecordings:s,errors:e,onClearFailedRecordings:r,className:a=""})=>{const[n,i]=m.useState(!1),[o,l]=m.useState(null);return s.length>0&&e.length>0&&e.some(A=>A.includes("could not be parsed coherently")||A.includes("Investigation dictation could not be parsed"))?t.jsxs("div",{className:`border-t border-red-200/50 bg-red-50/30 ${a}`,children:[t.jsxs(ye,{onClick:()=>i(!n),variant:"ghost",className:"w-full p-4 text-left hover:bg-red-50/50 rounded-none justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(jC,{className:"w-4 h-4 text-red-600"}),t.jsx("span",{className:"text-red-900 font-medium text-sm",children:"üîä Troubleshoot Audio Recording"}),t.jsxs("span",{className:"text-xs text-red-600 bg-red-100 px-2 py-0.5 rounded-full",children:[s.length," recording",s.length!==1?"s":""]})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[r&&t.jsx(Zt,{onClick:A=>{A.stopPropagation(),r()},icon:t.jsx(Ln,{}),variant:"ghost",size:"sm","aria-label":"Clear all failed recordings",title:"Clear all failed recordings",className:"hover:bg-red-100"}),n?t.jsx(Ph,{className:"w-4 h-4 text-red-400"}):t.jsx(Fh,{className:"w-4 h-4 text-red-400"})]})]}),n&&t.jsx("div",{className:"px-4 pb-4",children:t.jsxs("div",{className:"space-y-3",children:[t.jsx("div",{className:"text-sm text-red-700 bg-red-100/50 p-3 rounded-lg border border-red-200",children:t.jsxs("div",{className:"flex items-start space-x-2",children:[t.jsx(dl,{className:"w-4 h-4 text-red-600 mt-0.5 flex-shrink-0"}),t.jsxs("div",{children:[t.jsx("p",{className:"font-medium",children:"Investigation parsing failed"}),t.jsx("p",{className:"text-red-600 mt-1 text-xs",children:"The recording could not be processed into a structured investigation summary. Use the audio playback below to identify potential issues:"}),t.jsxs("ul",{className:"mt-2 text-xs text-red-600 space-y-1",children:[t.jsx("li",{children:"‚Ä¢ Check if audio is too quiet or contains too much silence"}),t.jsx("li",{children:"‚Ä¢ Verify medical terminology is clearly spoken"}),t.jsx("li",{children:"‚Ä¢ Ensure recording duration is adequate (‚â•2 seconds)"}),t.jsx("li",{children:"‚Ä¢ Look for background noise or audio quality issues"})]})]})]})}),s.length>1&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-red-700 mb-2",children:"Select recording to troubleshoot:"}),t.jsx("div",{className:"grid grid-cols-1 gap-2",children:s.map((A,d)=>t.jsx(ye,{onClick:()=>l(A),variant:"ghost",className:`p-3 rounded-lg border text-left justify-start ${o?.id===A.id?"bg-red-100 border-red-300 text-red-800":"bg-white border-red-200 hover:bg-red-50 text-red-700"}`,children:t.jsxs("div",{className:"flex items-center justify-between w-full",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"font-medium text-sm",children:["Recording #",s.length-d]}),t.jsxs("div",{className:"text-xs opacity-75 mt-1",children:[new Date(A.timestamp).toLocaleString()," ‚Ä¢",A.metadata.recordingTime,"s ‚Ä¢",(A.metadata.fileSize/1024).toFixed(1),"KB"]})]}),o?.id===A.id&&t.jsx("div",{className:"w-2 h-2 bg-red-500 rounded-full"})]})},A.id))})]}),(o||s.length===1)&&t.jsxs("div",{children:[t.jsxs("div",{className:"mb-3",children:[t.jsx("h4",{className:"text-sm font-medium text-red-700 mb-1",children:"Audio Playback & Analysis"}),t.jsx("p",{className:"text-xs text-red-600",children:"Listen to the recording and check the audio quality metrics below:"})]}),t.jsx(sb,{audioBlob:(o||s[0]).audioBlob,fileName:`investigation-failed-${(o||s[0]).agentType}`,className:"border-red-200"}),(o||s[0]).transcriptionAttempt&&t.jsxs("div",{className:"mt-3",children:[t.jsx("h5",{className:"text-sm font-medium text-red-700 mb-2",children:"Transcription Result:"}),t.jsx("div",{className:"bg-white p-3 rounded-lg border border-red-200 text-sm text-gray-800",children:t.jsx("p",{className:"whitespace-pre-wrap",children:(o||s[0]).transcriptionAttempt})}),t.jsx("p",{className:"text-xs text-red-600 mt-2",children:"The transcription above was successful, but could not be parsed into a structured investigation summary."})]}),t.jsxs("div",{className:"mt-3",children:[t.jsx("h5",{className:"text-sm font-medium text-red-700 mb-2",children:"Error Details:"}),t.jsx("div",{className:"bg-red-50 p-3 rounded-lg border border-red-200",children:t.jsx("p",{className:"text-sm text-red-800 font-mono",children:(o||s[0]).errorMessage})})]})]})]})})]}):null});ob.displayName="TroubleshootingSection";const xu=(s={})=>{const{agentType:e}=s,[r,a]=m.useState(!1),[n,i]=m.useState(null),[o,l]=m.useState(!1),[c,A]=m.useState({}),d=m.useCallback(N=>{e&&console.log(`üîç ${e.toUpperCase()} validation checkpoint triggered`),i(N),l(!0),a(!0)},[e]),h=m.useCallback(N=>{A(N),l(!1),a(!1)},[]),f=m.useCallback(()=>{l(!1),i(null),a(!1),A({})},[]),u=m.useCallback(()=>{e&&console.log(`‚è≠Ô∏è ${e.toUpperCase()} validation skipped by user`),l(!1),a(!1)},[e]),x=m.useCallback(()=>Object.keys(c).length>0?c:void 0,[c]),b=m.useCallback(()=>{a(!1),i(null),l(!1),A({})},[]);return{isValidating:r,validationResult:n,showValidationModal:o,userProvidedFields:c,handleValidationRequired:d,handleValidationContinue:h,handleValidationCancel:f,handleValidationSkip:u,getUserProvidedFields:x,clearValidationState:b}},KC={"patientData.height":{label:"Height",inputType:"number",placeholder:"Height in cm",helperText:"Required for BSA and CI calculation (normal: 150-200 cm)"},"patientData.weight":{label:"Weight",inputType:"number",placeholder:"Weight in kg",helperText:"Required for BSA and CI calculation (normal: 40-120 kg)"},"patientData.hemoglobin":{label:"Haemoglobin",inputType:"number",placeholder:"Hb in g/L",helperText:"Required for Fick CO calculation (normal: 120-180 g/L)"},"patientData.haemoglobin":{label:"Haemoglobin",inputType:"number",placeholder:"Hb in g/L",helperText:"Required for Fick CO calculation (normal: 120-180 g/L)"},"patientData.sao2":{label:"Arterial O‚ÇÇ Saturation (SaO‚ÇÇ)",inputType:"number",placeholder:"SaO‚ÇÇ in %",helperText:"Required for Fick CO (normal: 95-100%)"},"patientData.svo2":{label:"Mixed Venous O‚ÇÇ (SvO‚ÇÇ)",inputType:"number",placeholder:"SvO‚ÇÇ in %",helperText:"Required for Fick CO (normal: 60-80%)"},"patientData.heartRate":{label:"Heart Rate",inputType:"number",placeholder:"HR in bpm",helperText:"For stroke volume calculation (normal: 60-100 bpm)"},"pressures.raP":{label:"RA Pressure",inputType:"number",placeholder:"Mean RA pressure in mmHg",helperText:"Right atrial mean pressure (normal: 2-8 mmHg)"},"pressures.rvSystolic":{label:"RV Systolic Pressure",inputType:"number",placeholder:"RV systolic in mmHg",helperText:"Right ventricular systolic pressure (normal: 15-30 mmHg)"},"pressures.rvDiastolic":{label:"RV Diastolic Pressure",inputType:"number",placeholder:"RV diastolic in mmHg",helperText:"Right ventricular end-diastolic pressure (normal: 2-8 mmHg)"},"pressures.paSystolic":{label:"PA Systolic Pressure",inputType:"number",placeholder:"PA systolic in mmHg",helperText:"Pulmonary artery systolic pressure (normal: 15-30 mmHg)"},"pressures.paDiastolic":{label:"PA Diastolic Pressure",inputType:"number",placeholder:"PA diastolic in mmHg",helperText:"Pulmonary artery diastolic pressure (normal: 4-12 mmHg)"},"pressures.paMean":{label:"PA Mean Pressure",inputType:"number",placeholder:"Mean PA pressure in mmHg",helperText:"Pulmonary artery mean pressure (normal: 9-18 mmHg)"},"pressures.pcwp":{label:"PCWP",inputType:"number",placeholder:"PCWP in mmHg",helperText:"Pulmonary capillary wedge pressure (normal: 6-12 mmHg)"},"cardiacOutput.thermodilution.co":{label:"Thermodilution CO",inputType:"number",placeholder:"CO in L/min",helperText:"Cardiac output by thermodilution (normal: 4-8 L/min)"},"cardiacOutput.thermodilution.ci":{label:"Thermodilution CI",inputType:"number",placeholder:"CI in L/min/m¬≤",helperText:"Cardiac index (normal: 2.5-4.0 L/min/m¬≤)"},"calculations.cardiacOutput":{label:"Cardiac Output",inputType:"number",placeholder:"CO in L/min",helperText:"Cardiac output (normal: 4-8 L/min)"},"calculations.cardiacIndex":{label:"Cardiac Index",inputType:"number",placeholder:"CI in L/min/m¬≤",helperText:"Cardiac index normalized to BSA (normal: 2.5-4.0 L/min/m¬≤)"},"calculations.pvr":{label:"PVR",inputType:"number",placeholder:"PVR in Wood units",helperText:"Pulmonary vascular resistance (normal: <3 Wood units)"},"calculations.svr":{label:"SVR",inputType:"number",placeholder:"SVR in dynes¬∑s¬∑cm‚Åª‚Åµ",helperText:"Systemic vascular resistance (normal: 800-1200 dynes¬∑s¬∑cm‚Åª‚Åµ)"},"calculations.transValvularGradient":{label:"Transvalvular Gradient",inputType:"number",placeholder:"Gradient in mmHg",helperText:"Pressure gradient across valve (if applicable)"},"rhcData.vascularAccess":{label:"Vascular Access Site",inputType:"text",placeholder:"e.g., Right internal jugular, Right brachial vein",helperText:"Venous access site for RHC catheter insertion"},"rhcData.catheterDetails":{label:"Catheter Details",inputType:"text",placeholder:"e.g., 7 French Swan-Ganz catheter",helperText:"Catheter type and size (French)"},"rhcData.indication":{label:"Indication",inputType:"text",placeholder:"e.g., Heart failure assessment, Pulmonary hypertension workup",helperText:"Clinical indication for procedure"},"rhcData.fluoroscopyTime":{label:"Fluoroscopy Time",inputType:"number",placeholder:"Total fluoroscopy time in minutes",helperText:"Total radiation exposure time (OPTIONAL - for ALARA compliance)"},"rhcData.fluoroscopyDose":{label:"Fluoroscopy Dose",inputType:"number",placeholder:"Dose in mGy",helperText:"Total fluoroscopy dose (OPTIONAL - for radiation safety documentation)"},"rhcData.doseAreaProduct":{label:"Dose Area Product (DAP)",inputType:"number",placeholder:"DAP in Gy¬∑cm¬≤",helperText:"Dose area product (OPTIONAL - alternative radiation metric)"},"rhcData.contrastVolume":{label:"Contrast Volume",inputType:"number",placeholder:"Total contrast in mL",helperText:"Total iodinated contrast volume (OPTIONAL - for nephrotoxicity assessment)"},"resources.fluoroscopyTime":{label:"Fluoroscopy Time",inputType:"number",placeholder:"Total fluoroscopy time in minutes",helperText:"Total radiation exposure time (OPTIONAL)"},"resources.contrastVolume":{label:"Contrast Volume",inputType:"number",placeholder:"Total contrast in mL",helperText:"Total iodinated contrast volume (OPTIONAL)"},"cardiacOutput.co":{label:"Cardiac Output",inputType:"number",placeholder:"CO in L/min",helperText:"Cardiac output (normal: 4-8 L/min)"},"cardiacOutput.ci":{label:"Cardiac Index",inputType:"number",placeholder:"CI in L/min/m¬≤",helperText:"Cardiac index (normal: 2.5-4.0 L/min/m¬≤)"},co:{label:"Cardiac Output",inputType:"number",placeholder:"CO in L/min",helperText:"Cardiac output (normal: 4-8 L/min)"},ci:{label:"Cardiac Index",inputType:"number",placeholder:"CI in L/min/m¬≤",helperText:"Cardiac index (normal: 2.5-4.0 L/min/m¬≤)"},"cardiacOutput.mixedVenousO2":{label:"Mixed Venous O‚ÇÇ (SvO‚ÇÇ)",inputType:"number",placeholder:"SvO‚ÇÇ in %",helperText:"Required for Fick CO calculation (normal: 60-80%)"},svo2:{label:"Mixed Venous O‚ÇÇ (SvO‚ÇÇ)",inputType:"number",placeholder:"SvO‚ÇÇ in %",helperText:"Required for Fick CO (normal: 60-80%)"},bmi:{label:"BMI",inputType:"number",placeholder:"BMI in kg/m¬≤",helperText:"Body Mass Index (normal: 18.5-25 kg/m¬≤)"},"patientData.bmi":{label:"BMI",inputType:"number",placeholder:"BMI in kg/m¬≤",helperText:"Body Mass Index (normal: 18.5-25 kg/m¬≤)"}},GC={heading:"RHC Data Validation Required",description:"The quick model detected missing critical fields or low-confidence measurements. Please review and provide missing values for accurate haemodynamic calculations.",criticalHelper:"Required for PVR/SVR/CI calculations and diagnostic accuracy.",optionalHelper:"Improves report completeness and radiation safety documentation."},zC={"valveSizing.annulusDiameter":{label:"Annulus Diameter",inputType:"number",placeholder:"Aortic annulus diameter in mm",helperText:"CT-measured annulus diameter for valve sizing (CRITICAL)"},"valveSizing.annulusPerimeter":{label:"Annulus Perimeter",inputType:"number",placeholder:"Annulus perimeter in mm",helperText:"CT-measured annulus perimeter for valve sizing"},"valveSizing.annulusArea":{label:"Annulus Area",inputType:"number",placeholder:"Annulus area in mm¬≤",helperText:"CT-measured annulus area for valve sizing"},"accessAssessment.site":{label:"Access Site",inputType:"text",placeholder:"e.g., Right femoral artery",helperText:"Vascular access site for procedure"},"accessAssessment.iliofemoralDimensions":{label:"Iliofemoral Dimensions",inputType:"text",placeholder:"e.g., 7-8 mm diameter",helperText:"Minimal iliofemoral vessel diameter from CT"},"coronaryHeights.leftCoronary":{label:"Left Coronary Height",inputType:"number",placeholder:"LCA height in mm",helperText:"Distance from annulus to left coronary ostium (CRITICAL for coronary occlusion risk)"},"coronaryHeights.rightCoronary":{label:"Right Coronary Height",inputType:"number",placeholder:"RCA height in mm",helperText:"Distance from annulus to right coronary ostium (CRITICAL for coronary occlusion risk)"},"aorticValve.peakGradient":{label:"Peak Gradient",inputType:"number",placeholder:"Peak AV gradient in mmHg",helperText:"Peak echocardiographic gradient across aortic valve"},"aorticValve.meanGradient":{label:"Mean Gradient",inputType:"number",placeholder:"Mean AV gradient in mmHg",helperText:"Mean echocardiographic gradient across aortic valve"},"aorticValve.avArea":{label:"AV Area",inputType:"number",placeholder:"AV area in cm¬≤",helperText:"Aortic valve area (normal: 3-4 cm¬≤; severe AS: <1.0 cm¬≤)"},"lvAssessment.ef":{label:"Ejection Fraction",inputType:"number",placeholder:"LVEF in %",helperText:"Left ventricular ejection fraction"},"lvAssessment.lvidd":{label:"LVIDD",inputType:"number",placeholder:"LVIDD in mm",helperText:"Left ventricular internal diameter in diastole"},"lvAssessment.lvids":{label:"LVIDS",inputType:"number",placeholder:"LVIDS in mm",helperText:"Left ventricular internal diameter in systole"},"procedureDetails.valveType":{label:"Valve Type",inputType:"text",placeholder:"e.g., Sapien 3, Evolut R",helperText:"Transcatheter valve prosthesis model"},"procedureDetails.valveSize":{label:"Valve Size",inputType:"number",placeholder:"Valve size in mm",helperText:"Deployed valve size (e.g., 26mm, 29mm)"},"procedureDetails.deploymentDepth":{label:"Deployment Depth",inputType:"number",placeholder:"Depth in mm",helperText:"Distance from annulus to ventricular aspect of valve"}},WC={heading:"TAVI Workup Validation Required",description:"The quick model detected missing valve sizing parameters or coronary height measurements. These fields are CRITICAL for safe valve selection and deployment.",criticalHelper:"REQUIRED for valve sizing and procedural safety (coronary occlusion risk).",optionalHelper:"Improves workup completeness and pre-procedural planning."},qC={accessSite:{label:"Access Site",inputType:"text",placeholder:"e.g., Right radial artery",helperText:"Vascular access site for catheterization"},targetVessel:{label:"Target Vessel",inputType:"text",placeholder:"e.g., LAD, LCx, RCA",helperText:"Target coronary vessel for intervention"},lesionLocation:{label:"Lesion Location",inputType:"text",placeholder:"e.g., Proximal LAD, Mid RCA",helperText:"Anatomical location of coronary lesion"},stenosisPercent:{label:"Stenosis %",inputType:"number",placeholder:"Stenosis percentage (0-100)",helperText:"Degree of luminal narrowing (e.g., 90%)"},"intervention.stentType":{label:"Stent Type",inputType:"text",placeholder:"e.g., Xience, Resolute, Promus",helperText:"Stent manufacturer/model (REQUIRED for device tracking)"},"intervention.stentSize":{label:"Stent Diameter",inputType:"number",placeholder:"Stent diameter in mm",helperText:"Stent diameter (REQUIRED for registry reporting)"},"intervention.stentLength":{label:"Stent Length",inputType:"number",placeholder:"Stent length in mm",helperText:"Stent length (REQUIRED for registry reporting)"},"intervention.balloonSize":{label:"Balloon Size",inputType:"number",placeholder:"Balloon diameter in mm",helperText:"Pre/post-dilation balloon size"},"timiFlow.pre":{label:"Pre-intervention TIMI Flow",inputType:"number",placeholder:"TIMI flow grade (0-3)",helperText:"TIMI flow before intervention (REQUIRED for success assessment)"},"timiFlow.post":{label:"Post-intervention TIMI Flow",inputType:"number",placeholder:"TIMI flow grade (0-3)",helperText:"TIMI flow after intervention (REQUIRED for success assessment)"},"resources.contrastVolume":{label:"Contrast Volume",inputType:"number",placeholder:"Total contrast in mL",helperText:"Total iodinated contrast volume (REQUIRED for safety documentation)"},"resources.fluoroscopyTime":{label:"Fluoroscopy Time",inputType:"number",placeholder:"Total fluoroscopy time in minutes",helperText:"Total radiation exposure time (REQUIRED for safety documentation)"}},JC={heading:"Angiogram/PCI Validation Required",description:"The quick model detected missing stent details, TIMI flow grades, or lesion characteristics. These fields are CRITICAL for registry reporting and intervention documentation.",criticalHelper:"REQUIRED for device tracking, registry reporting, and procedural success assessment.",optionalHelper:"Improves procedural documentation and safety reporting."},YC={"mitralRegurgitation.preGrade":{label:"Pre-procedure MR Grade",inputType:"text",placeholder:"e.g., 4+, severe",helperText:"MR grade before intervention (CRITICAL for baseline)"},"mitralRegurgitation.postGrade":{label:"Post-procedure MR Grade",inputType:"text",placeholder:"e.g., 1+, mild",helperText:"MR grade after clip deployment (CRITICAL for procedural success)"},"mitralRegurgitation.preMRGrade":{label:"Pre MR Grade (Alt)",inputType:"text",placeholder:"Alternative pre-procedure MR grade",helperText:"Alternative naming for pre-procedure MR severity"},"mitralRegurgitation.postMRGrade":{label:"Post MR Grade (Alt)",inputType:"text",placeholder:"Alternative post-procedure MR grade",helperText:"Alternative naming for post-procedure MR severity"},"clipDetails.type":{label:"Clip Type",inputType:"text",placeholder:"e.g., MitraClip NTW, PASCAL P10",helperText:"Clip device type (REQUIRED for device tracking)"},"clipDetails.size":{label:"Clip Size",inputType:"text",placeholder:"e.g., 10mm",helperText:"Clip size designation (REQUIRED for registry reporting)"},"clipDetails.number":{label:"Number of Clips",inputType:"number",placeholder:"Number of clips deployed",helperText:"Total clips deployed (REQUIRED for procedural documentation)"},anatomicalLocation:{label:"Anatomical Location",inputType:"text",placeholder:"e.g., A2-P2, A1-P1",helperText:"Mitral valve location for clip deployment (REQUIRED for precise documentation)"},"eroa.pre":{label:"Pre-procedure EROA",inputType:"number",placeholder:"EROA in cm¬≤",helperText:"Effective regurgitant orifice area before intervention (severity assessment)"},"eroa.post":{label:"Post-procedure EROA",inputType:"number",placeholder:"EROA in cm¬≤",helperText:"EROA after clip deployment (outcome documentation)"},"transmitralGradient.pre":{label:"Pre-procedure Transmitral Gradient",inputType:"number",placeholder:"Gradient in mmHg",helperText:"Mean transmitral gradient before intervention"},"transmitralGradient.post":{label:"Post-procedure Transmitral Gradient",inputType:"number",placeholder:"Gradient in mmHg",helperText:"Mean transmitral gradient after clip (CRITICAL for assessing mitral stenosis risk)"}},XC={heading:"mTEER Procedure Validation Required",description:"The quick model detected missing MR grading, clip details, or anatomical location. Pre/post MR comparison is the KEY measure of procedural success.",criticalHelper:"REQUIRED for procedural success documentation, device tracking, and registry reporting.",optionalHelper:"Improves outcome documentation and severity assessment."},ZC={procedure:{label:"Procedure",inputType:"text",placeholder:"e.g., Angiogram, TAVI, RHC, mTEER",helperText:"Procedure type (REQUIRED for card generation)"},indication:{label:"Indication",inputType:"text",placeholder:"e.g., NSTEMI, Severe AS, PHT",helperText:"Clinical indication for procedure (REQUIRED)"},primaryAccess:{label:"Primary Access",inputType:"text",placeholder:"e.g., Right radial, Right femoral",helperText:"Primary vascular access site (REQUIRED for most procedures)"},accessSite:{label:"Access Site",inputType:"text",placeholder:"e.g., Right femoral vein",helperText:"Access site for RHC or mTEER"},sheathSizeFr:{label:"Sheath Size (Fr)",inputType:"number",placeholder:"Sheath size in French",helperText:"Introducer sheath size (REQUIRED)"},catheters:{label:"Catheters",inputType:"text",placeholder:"e.g., JL3.5, JR4",helperText:"Diagnostic/guiding catheters"},valveTypeSize:{label:"Valve Type/Size",inputType:"text",placeholder:"e.g., Sapien 3 Ultra 26mm",helperText:"TAVI valve model and size (REQUIRED for TAVI)"},wire:{label:"Wire",inputType:"text",placeholder:"e.g., Safari, Confida",helperText:"Guide wire type"},balloonSizeMm:{label:"Balloon Size (mm)",inputType:"number",placeholder:"Valvuloplasty balloon size",helperText:"Pre-dilation balloon size for TAVI"},transeptalCatheter:{label:"Transeptal Catheter",inputType:"text",placeholder:"e.g., Brockenbrough needle",helperText:"Transeptal puncture equipment (REQUIRED for mTEER)"},closurePlan:{label:"Closure Plan",inputType:"text",placeholder:"e.g., 2√ó ProStyle",helperText:"Vascular closure device plan"},pacingWireAccess:{label:"Pacing Wire Access",inputType:"text",placeholder:"e.g., Left femoral venous",helperText:"Temporary pacing wire access (REQUIRED for TAVI)"},protamine:{label:"Protamine",inputType:"text",placeholder:"e.g., Yes (no contraindications)",helperText:"Protamine reversal plan (REQUIRED for TAVI)"},goalsOfCare:{label:"Goals of Care",inputType:"text",placeholder:"e.g., Routine theatre",helperText:"Emergency theatre status and care goals (REQUIRED for TAVI)"},anticoagulationPlan:{label:"Anticoagulation Plan",inputType:"text",placeholder:"e.g., Continue aspirin + ticagrelor",helperText:"Antiplatelet/anticoagulation management"},sedation:{label:"Sedation",inputType:"text",placeholder:"e.g., Light sedation",helperText:"Sedation plan"},sitePrep:{label:"Site Prep",inputType:"text",placeholder:"e.g., Radial only; chlorhexidine",helperText:"Skin preparation sites and antiseptic"},allergies:{label:"Allergies/Precautions",inputType:"text",placeholder:"e.g., Iodine (premed given)",helperText:"Allergies and precautions taken"},coMeasurement:{label:"CO Measurement",inputType:"text",placeholder:"e.g., Thermodilution + Fick",helperText:"Cardiac output measurement method (REQUIRED for RHC)"},bloodGasSamples:{label:"Blood Gas Samples",inputType:"number",placeholder:"Number of blood gas samples",helperText:"Number of blood gas samples (RHC)"},echoSummary:{label:"Echo Summary",inputType:"text",placeholder:"Key echo findings",helperText:"Echo summary for mTEER (e.g., MR grade, mechanism)"},"recentLabs.hb_g_per_l":{label:"Hemoglobin (g/L)",inputType:"number",placeholder:"Hb in g/L",helperText:"Recent hemoglobin level"},"recentLabs.creatinine_umol_per_l":{label:"Creatinine (¬µmol/L)",inputType:"number",placeholder:"Creatinine in ¬µmol/L",helperText:"Recent creatinine level"},nokName:{label:"Next of Kin Name",inputType:"text",placeholder:"Full name",helperText:"Next of kin full name (REQUIRED)"},nokRelationship:{label:"NOK Relationship",inputType:"text",placeholder:"e.g., Partner, Son",helperText:"Relationship to patient"},nokPhone:{label:"NOK Phone",inputType:"text",placeholder:"Contact number",helperText:"Next of kin contact number (REQUIRED)"}},e5={heading:"Pre-Op Plan Validation Required",description:"The quick model detected missing procedure details or next-of-kin information. These fields are REQUIRED for a complete pre-procedure summary card.",criticalHelper:"REQUIRED for complete pre-op card generation and procedural documentation.",optionalHelper:"Improves card completeness and clinical communication."},t5={tests:{label:"Pathology Tests",inputType:"text",placeholder:"Comma-separated test names (e.g., FBE, EUC, CRP)",helperText:"List of pathology tests to order (REQUIRED)"},fastingRequired:{label:"Fasting Required",inputType:"checkbox",helperText:"Check if patient needs to fast before collection"},urgency:{label:"Urgency",inputType:"select",placeholder:"routine | urgent | stat",helperText:"Priority level for pathology processing"},clinicalIndication:{label:"Clinical Indication",inputType:"text",placeholder:"Reason for ordering tests",helperText:"Clinical reason (improves laboratory processing and interpretation)"}},s5={heading:"Pathology Tests Validation Required",description:"The quick model detected ambiguous test names or an empty extraction. Please clarify which specific tests should be ordered.",criticalHelper:"REQUIRED for generating a valid pathology requisition.",optionalHelper:"Improves pathology documentation and laboratory interpretation."},r5={rhc:{fieldConfig:KC,copy:GC},tavi:{fieldConfig:zC,copy:WC},"angio-pci":{fieldConfig:qC,copy:JC},mteer:{fieldConfig:YC,copy:XC},"pre-op-plan":{fieldConfig:ZC,copy:e5},bloods:{fieldConfig:t5,copy:s5}};function SA(s){return r5[s]}const ZA=[{key:"patient",title:"Patient Demographics",icon:Th,color:"blue",priority:"high",group:"demographics"},{key:"social_history",title:"Social History",icon:Th,color:"cyan",priority:"low",group:"demographics"},{key:"clinical",title:"Clinical Assessment",icon:fu,color:"green",priority:"high",group:"clinical"},{key:"background",title:"Background History",icon:gn,color:"gray",priority:"medium",group:"clinical"},{key:"medications",title:"Medications",icon:gn,color:"orange",priority:"medium",group:"clinical"},{key:"laboratory",title:"Laboratory Values",icon:gn,color:"purple",priority:"medium",group:"investigations"},{key:"ecg",title:"ECG Assessment",icon:fu,color:"red",priority:"medium",group:"investigations"},{key:"investigations",title:"Other Investigations",icon:gn,color:"indigo",priority:"medium",group:"investigations"},{key:"echocardiography",title:"Echocardiography",icon:jp,color:"red",priority:"high",group:"investigations"},{key:"procedure_planning",title:"Procedure Planning",icon:gn,color:"violet",priority:"high",group:"planning"},{key:"alerts",title:"Alerts & Considerations",icon:dl,color:"red",priority:"high",group:"planning"}],a5=[{key:"demographics",title:"Demographics",icon:Th,color:"blue",description:"Patient demographics and social information"},{key:"clinical",title:"Clinical Assessment",icon:fu,color:"green",description:"Clinical history, medications, and assessments"},{key:"investigations",title:"Investigations",icon:jp,color:"purple",description:"Imaging, laboratory, and diagnostic studies"},{key:"planning",title:"Planning",icon:gn,color:"violet",description:"Procedure planning and clinical considerations"}],{fieldConfig:n5,copy:i5}=SA("tavi"),o5=({structuredSections:s,results:e,missingInfo:r=[],onCopy:a,onInsertToEMR:n,onReprocessWithAnswers:i,validationResult:o,validationStatus:l,onReprocessWithValidation:c,className:A=""})=>{const[d,h]=m.useState(new Set(["patient","clinical","alerts"])),[f,u]=m.useState(new Set(["demographics","clinical","investigations","planning"])),[x,b]=m.useState(!1),[N,v]=m.useState({}),[j,I]=m.useState({copied:!1,inserted:!1}),{showValidationModal:C,validationResult:E,handleValidationRequired:T,handleValidationContinue:Q,handleValidationCancel:D,handleValidationSkip:k,clearValidationState:R}=xu({agentType:"tavi-workup"});m.useEffect(()=>{l==="awaiting_validation"&&o?T(o):l&&l!=="awaiting_validation"&&R()},[l,o,T,R]);const w=m.useMemo(()=>{if(s)return s;const q=G=>({patient:{content:"No data available",missing:[]},clinical:{content:"No data available",missing:[]},laboratory:{content:"No data available",missing:[]},ecg:{content:"No data available",missing:[]},background:{content:"No data available",missing:[]},medications:{content:"No data available",missing:[]},social_history:{content:"No data available",missing:[]},investigations:{content:"No data available",missing:[]},echocardiography:{content:"No data available",missing:[]},procedure_planning:{content:"No data available",missing:[]},alerts:{content:"No alerts",missing:[]},missing_summary:{missing_clinical:[],missing_diagnostic:[],missing_measurements:[],completeness_score:"0% (No data available)"},...G}),S=(G,X)=>{const le=G.trim();if(!le)return X==="alerts"?"No alerts":"Not provided";const he=le.toLowerCase();return/\bnot available\b/.test(he)||/\bno data available\b/.test(he)||/\bnot provided\b/.test(he)||/\bno\b.*\bprovided\b/.test(he)?X==="alerts"?"No alerts":"Not provided":le},H=G=>{const X=G.trim().toLowerCase();return X==="patient"||X.includes("patient")?"patient":X==="clinical"||X.includes("clinical")?"clinical":X==="laboratory values"||X==="bloods"||X.includes("laboratory")?"laboratory":X==="ecg assessment"||X==="ecg"||X.includes("ecg")?"ecg":X==="background"||X.includes("background")?"background":X.startsWith("medications")?"medications":X==="social history"||X.includes("social")?"social_history":X.includes("investigation")?"investigations":X==="echocardiography"||X==="echo"||X.includes("echo")?"echocardiography":X==="procedure planning"||X.includes("procedure")||X.includes("devices planned")?"procedure_planning":X.includes("alerts")?"alerts":X.includes("missing")?"missing_summary":null},Y=new Map([["patient","patient"],["patient demographics","patient"],["clinical","clinical"],["clinical assessment","clinical"],["laboratory values","laboratory"],["bloods","laboratory"],["ecg assessment","ecg"],["ecg","ecg"],["background","background"],["background history","background"],["medications","medications"],["medications (problem list)","medications"],["social history","social_history"],["investigation summary","investigations"],["investigations","investigations"],["other investigations","investigations"],["echocardiography","echocardiography"],["echo","echocardiography"],["procedure planning","procedure_planning"],["procedure plan","procedure_planning"],["devices planned","procedure_planning"],["alerts & anatomical considerations","alerts"],["alerts & considerations","alerts"],["alerts","alerts"],["missing / not stated","missing_summary"],["missing / not stated:","missing_summary"]]),te=G=>{const X=G.replace(/\r\n/g,`
`).replace(/[‚Ä¢¬∑]/g,`
`).replace(/;/g,`
`).trim();return X?X.split(`
`).map(le=>le.trim()).filter(Boolean):[]};if(e){try{let G=e.trim();G=G.replace(/```json\s*/,"").replace(/```\s*$/,"");const X=G.match(/\{[\s\S]*\}/);if(X){const le=JSON.parse(X[0]);return{patient:{content:le.patient?.content||"Not provided",missing:le.patient?.missing||[]},clinical:{content:le.clinical?.content||"Not provided",missing:le.clinical?.missing||[]},laboratory:{content:le.laboratory?.content||"Not provided",missing:le.laboratory?.missing||[]},ecg:{content:le.ecg?.content||"Not provided",missing:le.ecg?.missing||[]},background:{content:le.background?.content||"Not provided",missing:le.background?.missing||[]},medications:{content:le.medications?.content||"Not provided",missing:le.medications?.missing||[]},social_history:{content:le.social_history?.content||"Not provided",missing:le.social_history?.missing||[]},investigations:{content:le.investigations?.content||"Not provided",missing:le.investigations?.missing||[]},echocardiography:{content:le.echocardiography?.content||"Not provided",missing:le.echocardiography?.missing||[]},procedure_planning:{content:le.procedure_planning?.content||"Not provided",missing:le.procedure_planning?.missing||[]},alerts:{content:le.alerts?.content||"No alerts",missing:le.alerts?.missing||[],pre_anaesthetic_review_text:le.alerts?.pre_anaesthetic_review_text,pre_anaesthetic_review_json:le.alerts?.pre_anaesthetic_review_json},missing_summary:le.missing_summary||{missing_clinical:[],missing_diagnostic:[],missing_measurements:[],completeness_score:"0% (No data)"}}}}catch(G){console.warn("Failed to parse TAVI JSON from results:",G)}try{const G=/<section\s+title="([^"]+)"\s*>([\s\S]*?)<\/section>/gi,X=q({patient:{content:"Not provided",missing:[]},clinical:{content:"Not provided",missing:[]},laboratory:{content:"Not provided",missing:[]},ecg:{content:"Not provided",missing:[]},background:{content:"Not provided",missing:[]},medications:{content:"Not provided",missing:[]},social_history:{content:"Not provided",missing:[]},investigations:{content:"Not provided",missing:[]},echocardiography:{content:"Not provided",missing:[]},procedure_planning:{content:"Not provided",missing:[]},alerts:{content:"No alerts",missing:[]},missing_summary:{missing_clinical:[],missing_diagnostic:[],missing_measurements:[],completeness_score:"Not assessed"}});let le,he=!1;for(;(le=G.exec(e))!==null;){he=!0;const ve=le[1]?.trim()??"",Le=(le[2]??"").replace(/<\/?[^>]+>/g,"").replace(/\s+/g," ").trim(),Be=H(ve);if(Be){if(Be==="missing_summary"){X.missing_summary.missing_measurements=te(Le);continue}X[Be]={content:S(Le,Be),missing:[]}}}if(he)return X}catch(G){console.warn("Failed to parse TAVI XML from results:",G)}try{const X=e.replace(/\r\n/g,`
`).trim().split(`
`),le=[];for(let he=0;he<X.length;he++){const ve=X[he].trim().toLowerCase(),ke=Y.get(ve)??null;ke&&le.push({lineIndex:he,key:ke})}if(le.length>0){const he=q({patient:{content:"Not provided",missing:[]},clinical:{content:"Not provided",missing:[]},laboratory:{content:"Not provided",missing:[]},ecg:{content:"Not provided",missing:[]},background:{content:"Not provided",missing:[]},medications:{content:"Not provided",missing:[]},social_history:{content:"Not provided",missing:[]},investigations:{content:"Not provided",missing:[]},echocardiography:{content:"Not provided",missing:[]},procedure_planning:{content:"Not provided",missing:[]},alerts:{content:"No alerts",missing:[]},missing_summary:{missing_clinical:[],missing_diagnostic:[],missing_measurements:[],completeness_score:"Not assessed"}});for(let ve=0;ve<le.length;ve++){const ke=le[ve].lineIndex+1,Le=le[ve+1]?.lineIndex??X.length,Be=X.slice(ke,Le).join(`
`).trim(),Re=le[ve].key;if(Re){if(Re==="missing_summary"){he.missing_summary.missing_measurements=te(Be);continue}he[Re]={content:S(Be,Re),missing:[]}}}return he}}catch(G){console.warn("Failed to parse TAVI plain sections from results:",G)}}return q()},[s,e]),L=m.useMemo(()=>{const q=ZA.length,S=ZA.filter(G=>{const X=w[G.key];return G.key==="missing_summary"?!0:X&&"content"in X&&X.content&&X.content!=="Not provided"&&X.content!=="No data available"&&!X.content.includes("not provided")&&!X.content.includes("not available")}).length,H=Math.round(S/q*100),Y=w.missing_summary,te=[...Y?.missing_clinical||[],...Y?.missing_diagnostic||[],...Y?.missing_measurements||[]].length;return{percentage:H,completedSections:S,totalSections:q,totalMissingItems:te,status:H>=80?"excellent":H>=60?"good":H>=40?"fair":"incomplete"}},[w]),M=m.useMemo(()=>{const q=ZA.filter(H=>H.key!=="missing_summary").map(H=>{const Y=w[H.key];if(!Y||!("content"in Y)||!Y.content||Y.content==="Not provided"||Y.content==="No data available"||Y.content.includes("not provided")||Y.content.includes("not available"))return null;let te=`**${H.title}**
${Y.content}`;return H.key==="alerts"&&"pre_anaesthetic_review_text"in Y&&Y.pre_anaesthetic_review_text&&(te+=`

${"pre_anaesthetic_review_text"in Y?Y.pre_anaesthetic_review_text:""}`),te+`
`}).filter(Boolean).join(`
`);return`TAVI WORKUP SUMMARY
Completion: ${L.percentage}% (${L.status})

`+q},[w,L]),P=m.useCallback(q=>{h(S=>{const H=new Set(S);return H.has(q)?H.delete(q):H.add(q),H})},[]),K=m.useCallback(q=>{u(S=>{const H=new Set(S);return H.has(q)?H.delete(q):H.add(q),H})},[]),$=m.useMemo(()=>a5.map(q=>{const S=ZA.filter(te=>te.group===q.key),H=S.filter(te=>{const G=w[te.key];return te.key==="missing_summary"?!0:G&&"content"in G&&G.content&&G.content!=="Not provided"&&G.content!=="No data available"&&!G.content.includes("not provided")&&!G.content.includes("not available")}).length,Y=S.reduce((te,G)=>{const X=w[G.key];return X&&"missing"in X&&X.missing?te+X.missing.length:te},0);return{...q,sections:S,completed:H,total:S.length,completionPercentage:Math.round(H/S.length*100),missingItems:Y}}),[w]),O=m.useCallback(async()=>{a&&(await a(M),I(q=>({...q,copied:!0})),setTimeout(()=>I(q=>({...q,copied:!1})),2e3))},[a,M]),W=m.useCallback(async()=>{n&&(await n(M),I(q=>({...q,inserted:!0})),setTimeout(()=>I(q=>({...q,inserted:!1})),2e3))},[n,M]),ee=m.useCallback(()=>{i&&Object.keys(N).length>0&&(i(N),b(!1),v({}))},[i,N]),V=q=>{const S=w[q.key],H=d.has(q.key),Y=q.key==="missing_summary",te=!Y&&S&&"content"in S&&S.content!=="Not provided"&&S.content!=="No data available"&&!S.content.includes("not provided")&&!S.content.includes("not available")&&S.content.trim().length>0,G=!Y&&S&&"missing"in S&&S.missing&&S.missing.length>0,X=q.icon;return t.jsxs(Ye.div,{className:"border border-gray-200 rounded-lg overflow-hidden",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:[t.jsxs(ye,{onClick:()=>P(q.key),variant:"ghost",className:`w-full p-4 flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition-colors rounded-none ${te?"border-l-4 border-l-green-500":G?"border-l-4 border-l-yellow-500":"border-l-4 border-l-gray-300"}`,children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(X,{className:`w-5 h-5 text-${q.color}-600`}),t.jsxs("div",{className:"text-left",children:[t.jsx("h3",{className:"font-semibold text-gray-900",children:q.title}),t.jsx("p",{className:"text-sm text-gray-600",children:te?"Complete":G&&"missing"in S?`${S.missing.length} missing items`:"No data"})]})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[te&&t.jsx(Wo,{className:"w-4 h-4 text-green-600"}),G&&t.jsx(dl,{className:"w-4 h-4 text-yellow-600"}),H?t.jsx(Vr,{className:"w-4 h-4 text-gray-500"}):t.jsx(ps,{className:"w-4 h-4 text-gray-500"})]})]}),t.jsx(as,{children:H&&t.jsx(Ye.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.3},className:"overflow-hidden",children:t.jsxs("div",{className:"p-4 border-t border-gray-200",children:[te?t.jsx("div",{className:"prose prose-sm max-w-none",children:t.jsx("div",{className:"text-gray-900 whitespace-pre-wrap",children:"content"in S?S.content:""})}):t.jsx("div",{className:"text-gray-500 italic",children:"No data available"}),q.key==="alerts"&&"pre_anaesthetic_review_text"in S&&S.pre_anaesthetic_review_text&&t.jsxs("div",{className:"mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[t.jsx("h4",{className:"text-sm font-semibold text-blue-800 mb-3",children:"Pre Anaesthetic Review"}),t.jsx("div",{className:"text-sm text-blue-900 whitespace-pre-wrap",children:"pre_anaesthetic_review_text"in S?S.pre_anaesthetic_review_text:""}),"pre_anaesthetic_review_json"in S&&S.pre_anaesthetic_review_json&&t.jsxs("details",{className:"mt-3",children:[t.jsx("summary",{className:"text-xs text-blue-700 cursor-pointer hover:text-blue-900",children:"View structured anaesthetic data"}),t.jsx("pre",{className:"mt-2 text-xs text-blue-800 bg-blue-100 p-2 rounded overflow-x-auto",children:"pre_anaesthetic_review_json"in S?JSON.stringify(S.pre_anaesthetic_review_json,null,2):""})]})]}),G&&t.jsxs("div",{className:"mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:[t.jsx("h4",{className:"text-sm font-semibold text-yellow-800 mb-2",children:"Missing Information:"}),t.jsx("ul",{className:"text-sm text-yellow-700 space-y-2",children:"missing"in S?S.missing.map((le,he)=>t.jsxs("li",{className:"flex items-center justify-between p-2 bg-white border border-yellow-200 rounded",children:[t.jsxs("div",{className:"flex items-start space-x-2 flex-1",children:[t.jsx("span",{className:"text-yellow-500 mt-0.5",children:"‚Ä¢"}),t.jsx("span",{className:"flex-1",children:le})]}),t.jsx(ye,{onClick:()=>{const ve=prompt(`Please provide: ${le}`,"");ve&&ve.trim()&&console.log(`Adding missing info for ${q.key}:`,{field:le,value:ve.trim()})},variant:"primary",size:"sm",className:"ml-2 text-xs",children:"Add"})]},he)):null}),t.jsx("div",{className:"mt-3 pt-3 border-t border-yellow-200",children:t.jsx(ye,{onClick:()=>{console.log("Regenerating TAVI report with missing information...")},variant:"primary",size:"md",fullWidth:!0,className:"text-sm",children:"Regenerate with Missing Information"})})]})]})})})]},q.key)};return t.jsxs("div",{className:`space-y-6 ${A}`,children:[t.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"TAVI Workup Summary"}),t.jsxs("p",{className:"text-sm text-gray-600",children:[L.completedSections," of ",L.totalSections," sections complete",L.totalMissingItems>0&&` ‚Ä¢ ${L.totalMissingItems} items missing`]})]}),t.jsxs("div",{className:"text-right",children:[t.jsxs("div",{className:`text-2xl font-bold ${L.status==="excellent"?"text-green-600":L.status==="good"?"text-blue-600":L.status==="fair"?"text-yellow-600":"text-red-600"}`,children:[L.percentage,"%"]}),t.jsx("div",{className:`text-xs uppercase tracking-wide ${L.status==="excellent"?"text-green-600":L.status==="good"?"text-blue-600":L.status==="fair"?"text-yellow-600":"text-red-600"}`,children:L.status})]})]}),t.jsx("div",{className:"mt-3",children:t.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:t.jsx("div",{className:`h-2 rounded-full transition-all duration-500 ${L.status==="excellent"?"bg-green-500":L.status==="good"?"bg-blue-500":L.status==="fair"?"bg-yellow-500":"bg-red-500"}`,style:{width:`${L.percentage}%`}})})})]}),t.jsxs("div",{className:"flex flex-wrap gap-3",children:[t.jsx(ye,{onClick:O,variant:j.copied?"success":"outline",size:"md",startIcon:j.copied?t.jsx(Wo,{className:"w-4 h-4"}):t.jsx(Zy,{className:"w-4 h-4"}),children:j.copied?"Copied!":"Copy Report"}),t.jsx(ye,{onClick:W,variant:j.inserted?"secondary":"outline",size:"md",startIcon:j.inserted?t.jsx(Wo,{className:"w-4 h-4"}):t.jsx(gn,{className:"w-4 h-4"}),children:j.inserted?"Inserted!":"Insert to EMR"}),L.totalMissingItems>0&&t.jsx(ye,{onClick:()=>b(!x),variant:"outline",size:"md",startIcon:t.jsx(Fr,{className:"w-4 h-4"}),className:"bg-yellow-50 border-yellow-200 text-yellow-700 hover:bg-yellow-100",children:"Complete Missing Info"})]}),t.jsx(as,{children:x&&t.jsx(Ye.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"overflow-hidden",children:t.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[t.jsx("h3",{className:"font-semibold text-yellow-800 mb-3",children:"Complete Missing Information"}),t.jsx("div",{className:"space-y-3",children:[...w.missing_summary.missing_clinical,...w.missing_summary.missing_diagnostic,...w.missing_summary.missing_measurements].map((q,S)=>t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:q}),t.jsx("input",{type:"text",value:N[q]||"",onChange:H=>v(Y=>({...Y,[q]:H.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:`Enter ${q.toLowerCase()}`})]},S))}),t.jsxs("div",{className:"flex justify-end space-x-3 mt-4",children:[t.jsx(ye,{onClick:()=>b(!1),variant:"ghost",size:"md",children:"Cancel"}),t.jsx(ye,{onClick:ee,disabled:Object.keys(N).length===0,variant:"primary",size:"md",children:"Reprocess with Answers"})]})]})})}),t.jsx("div",{className:"space-y-6",children:$.map(q=>t.jsxs("div",{className:"space-y-3",children:[t.jsxs(ye,{onClick:()=>K(q.key),variant:"ghost",className:"w-full p-4 flex items-center justify-between bg-gradient-to-r from-gray-50 to-gray-100 hover:from-gray-100 hover:to-gray-200 border border-gray-200 rounded-lg transition-all duration-200",children:[t.jsxs("div",{className:"flex items-center space-x-4",children:[t.jsx("div",{className:`p-2 rounded-lg bg-${q.color}-100`,children:t.jsx(q.icon,{className:`w-5 h-5 text-${q.color}-600`})}),t.jsxs("div",{className:"text-left",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:q.title}),t.jsx("p",{className:"text-sm text-gray-600",children:q.description})]})]}),t.jsxs("div",{className:"flex items-center space-x-4",children:[t.jsxs("div",{className:"text-right",children:[t.jsxs("div",{className:`text-sm font-medium ${q.completionPercentage>=80?"text-green-600":q.completionPercentage>=50?"text-blue-600":"text-yellow-600"}`,children:[q.completed,"/",q.total," complete"]}),t.jsxs("div",{className:"text-xs text-gray-500",children:[q.completionPercentage,"%",q.missingItems>0&&` ‚Ä¢ ${q.missingItems} missing`]})]}),t.jsx("div",{className:`w-12 h-12 rounded-full border-4 ${q.completionPercentage>=80?"border-green-500":q.completionPercentage>=50?"border-blue-500":"border-yellow-500"} border-r-transparent animate-pulse flex items-center justify-center`,children:t.jsxs("span",{className:`text-xs font-bold ${q.completionPercentage>=80?"text-green-600":q.completionPercentage>=50?"text-blue-600":"text-yellow-600"}`,children:[q.completionPercentage,"%"]})}),f.has(q.key)?t.jsx(Vr,{className:"w-5 h-5 text-gray-500"}):t.jsx(ps,{className:"w-5 h-5 text-gray-500"})]})]}),t.jsx(as,{children:f.has(q.key)&&t.jsx(Ye.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.3},className:"overflow-hidden space-y-3 pl-6",children:q.sections.map(V)})})]},q.key))}),w.missing_summary.completeness_score&&t.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[t.jsx("h3",{className:"font-semibold text-gray-900 mb-2",children:"Assessment Summary"}),t.jsxs("p",{className:"text-sm text-gray-700",children:[t.jsx("strong",{children:"Completeness Score:"})," ",w.missing_summary.completeness_score]})]}),C&&E&&t.jsx(uA,{agentLabel:"TAVI Workup",validation:E,fieldConfig:n5,copy:i5,onCancel:()=>{console.log("üö´ TAVI Display: Validation cancelled"),D()},onSkip:()=>{console.log("‚è≠Ô∏è TAVI Display: Validation skipped"),k()},onContinue:q=>{console.log("‚úÖ TAVI Display: Validation complete, user fields:",q),Q(q),c&&c(q)}})]})},Ds=({label:s,value:e,unit:r,normalRange:a,description:n,priority:i="medium",decimalPlaces:o=1,prerequisites:l=[],showWhenMissing:c=!1})=>{if(e===void 0)return!c||l.length===0?null:t.jsx("div",{className:"bg-gray-50 border-l-2 border-gray-300 rounded-lg p-3",children:t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:s}),t.jsx("div",{className:"text-sm text-gray-500 italic",children:"Not calculated"}),t.jsxs("div",{className:"text-xs text-gray-500 mt-2",children:[t.jsx("span",{className:"font-medium",children:"Needs:"})," ",l.join(", ")]})]}),t.jsx(or,{className:"w-4 h-4 text-gray-400 ml-2"})]})});let A="normal";a&&(a.min!==void 0&&e<a.min||a.max!==void 0&&e>a.max?A="abnormal":(a.min!==void 0&&e<a.min*1.1||a.max!==void 0&&e>a.max*.9)&&(A="borderline"));const d={normal:"bg-emerald-50 border-emerald-200",borderline:"bg-amber-50 border-amber-200",abnormal:"bg-rose-50 border-rose-200"},h={normal:"text-emerald-700",borderline:"text-amber-700",abnormal:"text-rose-700"},f=i==="high"?"border-l-4":"border-l-2";return t.jsx("div",{className:`${d[A]} ${f} border rounded-lg p-3`,children:t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"text-xs font-medium text-gray-600 mb-1",children:s}),t.jsxs("div",{className:`text-xl font-bold ${h[A]}`,children:[e.toFixed(o),t.jsx("span",{className:"text-sm font-normal ml-1",children:r})]}),a&&t.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Normal: ",a.min!==void 0?`${a.min}`:"",a.min!==void 0&&a.max!==void 0?"-":"",a.max!==void 0?`${a.max}`:a.min!==void 0?"+":""," ",r]}),n&&t.jsx("div",{className:"text-xs text-gray-600 mt-1 italic",children:n})]}),A!=="normal"&&t.jsx("div",{className:"ml-2",children:A==="abnormal"?t.jsx(or,{className:"w-4 h-4 text-rose-600"}):t.jsx(or,{className:"w-4 h-4 text-amber-600"})})]})})},l5=({calculations:s,className:e=""})=>{const[r,a]=m.useState(new Set(["tier1","tier2"]));if(!s)return null;const n=c=>{a(A=>{const d=new Set(A);return d.has(c)?d.delete(c):d.add(c),d})},i=!!(s.bsa||s.bmi||s.cardiacIndex||s.transpulmonaryGradient||s.pulmonaryVascularResistance||s.systemicVascularResistance),o=!!(s.fickCO||s.cardiacPowerOutput||s.rvswi||s.lvswi||s.papi||s.rapPawpRatio),l=!!(s.oxygenDelivery||s.oxygenExtractionRatio||s.pulmonaryArterialCompliance||s.pulmonaryRCTime||s.effectivePulmonaryEa||s.lvEes||s.raEes);return t.jsxs("div",{className:`space-y-4 ${e}`,children:[(s.clinicalAssessment||s.riskStratification||s.phClassification?.hasPH)&&t.jsx("div",{className:"bg-blue-50 border-l-4 border-blue-600 rounded-lg p-4",children:t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx(Zn,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("h4",{className:"text-sm font-semibold text-blue-900 mb-2",children:"Clinical Assessment"}),s.clinicalAssessment&&t.jsx("p",{className:"text-sm text-blue-800 mb-2",children:s.clinicalAssessment}),t.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[s.riskStratification&&t.jsxs("span",{className:`inline-flex items-center px-2 py-1 rounded text-xs font-medium ${s.riskStratification==="High"?"bg-rose-100 text-rose-800":s.riskStratification==="Intermediate"?"bg-amber-100 text-amber-800":"bg-emerald-100 text-emerald-800"}`,children:[s.riskStratification," Risk"]}),s.phClassification?.hasPH&&t.jsxs(t.Fragment,{children:[s.phClassification.type&&t.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800",children:s.phClassification.type}),s.phClassification.severity&&t.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800",children:[s.phClassification.severity," PH"]})]})]})]})]})}),i&&t.jsxs("div",{className:"rounded-lg",children:[t.jsxs("button",{type:"button",onClick:()=>n("tier1"),className:"flex items-center gap-2 w-full px-4 py-3 hover:bg-gray-50 rounded-t-lg text-left bg-transparent border-none cursor-pointer",children:[t.jsx(uc,{className:"w-5 h-5 text-emerald-600 flex-shrink-0"}),t.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Essential Haemodynamics"}),r.has("tier1")?t.jsx(Vr,{className:"w-4 h-4 text-gray-400 flex-shrink-0 ml-auto"}):t.jsx(ps,{className:"w-4 h-4 text-gray-400 flex-shrink-0 ml-auto"})]}),r.has("tier1")&&t.jsxs("div",{className:"px-4 pb-4 space-y-3",children:[(s.bsa||s.bmi)&&t.jsxs("div",{children:[t.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Patient Anthropometrics"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsx(Ds,{label:"BSA",value:s.bsa,unit:"m¬≤",normalRange:{min:1.5,max:2.5}}),t.jsx(Ds,{label:"BMI",value:s.bmi,unit:"kg/m¬≤",normalRange:{min:18.5,max:25}})]})]}),t.jsxs("div",{children:[t.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Core Haemodynamics"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsx(Ds,{label:"Cardiac Index",value:s.cardiacIndex,unit:"L/min/m¬≤",normalRange:{min:2.5,max:4},priority:"high"}),t.jsx(Ds,{label:"Stroke Volume",value:s.strokeVolume,unit:"mL",normalRange:{min:60,max:100}}),t.jsx(Ds,{label:"MAP",value:s.map,unit:"mmHg",normalRange:{min:70,max:100}}),t.jsx(Ds,{label:"Estimated VO‚ÇÇ",value:s.estimatedVO2,unit:"mL/min"})]})]}),t.jsxs("div",{children:[t.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Pulmonary Haemodynamics"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsx(Ds,{label:"PVR",value:s.pulmonaryVascularResistance,unit:"Wood units",normalRange:{max:3},priority:"high",description:"Pulmonary Vascular Resistance",prerequisites:["PA mean","PCWP","CO"],showWhenMissing:!0}),t.jsx(Ds,{label:"PVRI",value:s.pulmonaryVascularResistanceIndex,unit:"Wood¬∑m¬≤",normalRange:{max:5},prerequisites:["PVR","BSA"],showWhenMissing:!0}),t.jsx(Ds,{label:"TPG",value:s.transpulmonaryGradient,unit:"mmHg",normalRange:{max:12},description:"Transpulmonary Gradient",prerequisites:["PA mean","PCWP"],showWhenMissing:!0}),t.jsx(Ds,{label:"DPG",value:s.diastolicPressureGradient,unit:"mmHg",normalRange:{max:7},description:"Diastolic Pressure Gradient",prerequisites:["PA diastolic","PCWP"],showWhenMissing:!0})]})]}),(s.systemicVascularResistance||s.systemicVascularResistanceIndex)&&t.jsxs("div",{children:[t.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Systemic Haemodynamics"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsx(Ds,{label:"SVR",value:s.systemicVascularResistance,unit:"Wood units",normalRange:{min:10,max:20},description:"Systemic Vascular Resistance"}),t.jsx(Ds,{label:"SVRI",value:s.systemicVascularResistanceIndex,unit:"Wood¬∑m¬≤",normalRange:{min:17,max:35}})]})]})]})]}),o&&t.jsxs("div",{className:"rounded-lg",children:[t.jsxs("button",{type:"button",onClick:()=>n("tier2"),className:"flex items-center gap-2 w-full px-4 py-3 hover:bg-gray-50 rounded-t-lg text-left bg-transparent border-none cursor-pointer",children:[t.jsx(qi,{className:"w-5 h-5 text-purple-600 flex-shrink-0"}),t.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Advanced Metrics"}),r.has("tier2")?t.jsx(Vr,{className:"w-4 h-4 text-gray-400 flex-shrink-0 ml-auto"}):t.jsx(ps,{className:"w-4 h-4 text-gray-400 flex-shrink-0 ml-auto"})]}),r.has("tier2")&&t.jsxs("div",{className:"px-4 pb-4 space-y-3",children:[(s.fickCO||s.fickCI)&&t.jsxs("div",{children:[t.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Fick Method (Validation)"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsx(Ds,{label:"Fick CO",value:s.fickCO,unit:"L/min",normalRange:{min:4,max:8},description:"Cross-validation with thermodilution"}),t.jsx(Ds,{label:"Fick CI",value:s.fickCI,unit:"L/min/m¬≤",normalRange:{min:2.5,max:4}})]})]}),t.jsxs("div",{children:[t.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Cardiac Power & Ventricular Work"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsx(Ds,{label:"CPO",value:s.cardiacPowerOutput,unit:"Watts",normalRange:{min:.5,max:.7},description:"Cardiac Power Output"}),t.jsx(Ds,{label:"CPI",value:s.cardiacPowerIndex,unit:"W/m¬≤",normalRange:{min:.3,max:.5}}),t.jsx(Ds,{label:"RVSWI",value:s.rvswi,unit:"mmHg¬∑mL/m¬≤",normalRange:{min:400,max:600},description:"RV Stroke Work Index"}),t.jsx(Ds,{label:"LVSWI",value:s.lvswi,unit:"mmHg¬∑mL/m¬≤",normalRange:{min:50,max:70},description:"LV Stroke Work Index"}),t.jsx(Ds,{label:"RV CPO",value:s.rvCardiacPowerOutput,unit:"Watts"}),t.jsx(Ds,{label:"SVI",value:s.strokeVolumeIndex,unit:"mL/m¬≤",normalRange:{min:35,max:65}})]})]}),(s.papi||s.rapPawpRatio)&&t.jsxs("div",{children:[t.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"RV Function Indices"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsx(Ds,{label:"PAPi",value:s.papi,unit:"",normalRange:{min:1.85},description:"Pulmonary Artery Pulsatility Index",decimalPlaces:2}),t.jsx(Ds,{label:"RAP:PCWP Ratio",value:s.rapPawpRatio,unit:"",normalRange:{max:.67},decimalPlaces:2})]})]})]})]}),l&&t.jsxs("div",{className:"rounded-lg",children:[t.jsxs("button",{type:"button",onClick:()=>n("tier3"),className:"flex items-center gap-2 w-full px-4 py-3 hover:bg-gray-50 rounded-t-lg text-left bg-transparent border-none cursor-pointer",children:[t.jsx(Zn,{className:"w-5 h-5 text-blue-600 flex-shrink-0"}),t.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Specialized Calculations"}),r.has("tier3")?t.jsx(Vr,{className:"w-4 h-4 text-gray-400 flex-shrink-0 ml-auto"}):t.jsx(ps,{className:"w-4 h-4 text-gray-400 flex-shrink-0 ml-auto"})]}),r.has("tier3")&&t.jsxs("div",{className:"px-4 pb-4 space-y-3",children:[(s.oxygenDelivery||s.oxygenExtractionRatio)&&t.jsxs("div",{children:[t.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Oxygen Transport"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsx(Ds,{label:"DO‚ÇÇ",value:s.oxygenDelivery,unit:"mL/min",description:"Oxygen Delivery",decimalPlaces:0}),t.jsx(Ds,{label:"O‚ÇÇER",value:s.oxygenExtractionRatio,unit:"%",normalRange:{min:20,max:30},description:"Oxygen Extraction Ratio"})]})]}),(s.pulmonaryArterialCompliance||s.pulmonaryRCTime||s.effectivePulmonaryEa)&&t.jsxs("div",{children:[t.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Pulmonary Vascular Mechanics"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsx(Ds,{label:"PAC",value:s.pulmonaryArterialCompliance,unit:"mL/mmHg",normalRange:{min:2},description:"Pulmonary Arterial Compliance"}),t.jsx(Ds,{label:"RC Time",value:s.pulmonaryRCTime,unit:"seconds",normalRange:{min:.5,max:.7},description:"Pulmonary Resistance-Compliance Time"}),t.jsx(Ds,{label:"Ea",value:s.effectivePulmonaryEa,unit:"mmHg/mL",description:"Effective Pulmonary Elastance"})]})]}),(s.lvEes||s.raEes)&&t.jsxs("div",{children:[t.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Ventricular Elastance (PV Loop Data)"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsx(Ds,{label:"LV Ees",value:s.lvEes,unit:"mmHg/mL",description:"LV End-Systolic Elastance",decimalPlaces:2}),t.jsx(Ds,{label:"RA Ees",value:s.raEes,unit:"mmHg/mL",description:"RA End-Systolic Elastance",decimalPlaces:2})]})]})]})]}),!i&&!o&&!l&&t.jsxs("div",{className:"border border-gray-200 rounded-lg bg-gray-50 p-6 text-center",children:[t.jsx(Ra,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),t.jsx("p",{className:"text-gray-600 text-sm",children:"Calculated values will appear here once all necessary haemodynamic measurements are recorded."}),t.jsx("p",{className:"text-gray-500 text-xs mt-2",children:"Required: Pressures (RA, RV, PA, PCWP), Cardiac Output, Patient Data (Height, Weight, HR, BP)"})]})]})},lb=({missingInfo:s,onSubmit:e,onDismiss:r,agentType:a})=>{console.log("üîç MissingInfoPanel: Received missingInfo:",s,"for agent:",a);const n=m.useMemo(()=>{const A=[],d=a==="quick-letter",h=a==="angiogram-pci",f=a==="tavi-workup";a==="investigation-summary"&&(s?.missing_purpose||s?.missing_clinical)&&console.warn("‚ö†Ô∏è MissingInfoPanel: Investigation Summary incorrectly has QuickLetter-style missing info - filtering out"),h&&Array.isArray(s?.missing_diagnostic)&&(console.log("üìã MissingInfoPanel: Adding missing_diagnostic (angiogram-pci):",s.missing_diagnostic),A.push(...s.missing_diagnostic)),h&&Array.isArray(s?.missing_intervention)&&(console.log("üìã MissingInfoPanel: Adding missing_intervention (angiogram-pci):",s.missing_intervention),A.push(...s.missing_intervention)),d&&Array.isArray(s?.missing_purpose)&&(console.log("üìã MissingInfoPanel: Adding missing_purpose (quick-letter):",s.missing_purpose),A.push(...s.missing_purpose)),d&&Array.isArray(s?.missing_clinical)&&(console.log("üìã MissingInfoPanel: Adding missing_clinical (quick-letter):",s.missing_clinical),A.push(...s.missing_clinical)),d&&Array.isArray(s?.missing_recommendations)&&(console.log("üìã MissingInfoPanel: Adding missing_recommendations (quick-letter):",s.missing_recommendations),A.push(...s.missing_recommendations)),f&&Array.isArray(s?.missing_structured)&&(console.log("üìã MissingInfoPanel: Adding missing_structured (tavi-workup):",s.missing_structured),A.push(...s.missing_structured)),f&&Array.isArray(s?.missing_measurements)&&(console.log("üìã MissingInfoPanel: Adding missing_measurements (tavi-workup):",s.missing_measurements),A.push(...s.missing_measurements));const x=A.filter(I=>I&&I.trim().length>0),b=I=>I.toLowerCase().trim().replace(/[^\w\s]/g,"").replace(/\s+/g," ").replace(/\b(the|a|an|and|or|of|in|on|at|to|for|with)\b/g,"").trim(),N=(I,C)=>{const E=b(I),T=b(C);if(E===T||E.length>10&&T.length>10&&(E.includes(T)||T.includes(E)))return!0;if(["gradient","measurement","diameter","area","valve","pressure"].some(k=>E.includes(k)&&T.includes(k))){const k=E.split(" ").filter(M=>M.length>2),R=T.split(" ").filter(M=>M.length>2);if(k.filter(M=>R.includes(M)).length/Math.max(k.length,R.length)>.7)return!0}return!1},v=[],j=new Set;for(const I of x){const C=b(I);if(j.has(C)){console.log(`üìã MissingInfoPanel: Skipping exact duplicate: "${I}"`);continue}if(v.some(T=>N(I,T))){console.log(`üìã MissingInfoPanel: Skipping similar question: "${I}"`);continue}v.push(I),j.add(C)}return console.log(`üìä MissingInfoPanel: Total questions before dedup: ${A.length}, after enhanced dedup: ${v.length}`),console.log(`üìä MissingInfoPanel: Removed ${A.length-v.length} duplicate/similar questions`),v},[s,a]),[i,o]=m.useState({}),l=(A,d)=>{o(h=>({...h,[A]:d}))},c=s?.completeness_score||"";return n.length===0?null:t.jsxs("div",{className:"rounded-lg border border-amber-200 bg-amber-50",children:[t.jsxs("div",{className:"p-3 border-b border-amber-200 bg-amber-100 flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h4",{className:"text-amber-900 font-semibold text-sm",children:"Missing Information"}),c&&t.jsxs("p",{className:"text-amber-700 text-xs",children:["Completeness: ",c]})]}),r&&t.jsx(ye,{onClick:r,variant:"ghost",size:"sm",className:"text-amber-700 text-xs underline",children:"Dismiss"})]}),t.jsx("div",{className:"p-3 space-y-3",children:n.map(A=>t.jsxs("div",{className:"space-y-1",children:[t.jsx("label",{className:"text-xs font-medium text-amber-900 block",children:A}),t.jsx("input",{type:"text",className:"w-full text-sm p-2 border border-amber-200 rounded focus:outline-none focus:ring-2 focus:ring-amber-300 bg-white",placeholder:"Add detail...",value:i[A]||"",onChange:d=>l(A,d.target.value)})]},A))}),t.jsxs("div",{className:"p-3 border-t border-amber-200 bg-amber-50 flex items-center justify-end space-x-2",children:[r&&t.jsx(ye,{onClick:r,variant:"outline",size:"sm",className:"text-xs border-amber-200 bg-white hover:bg-amber-50",children:"Skip for now"}),t.jsx(ye,{onClick:()=>e(i),variant:"primary",size:"sm",className:"text-xs bg-amber-600 hover:bg-amber-700",children:"Reprocess with answers"})]})]})},c5=({rhcReport:s,onSave:e,onCancel:r,onLiveUpdate:a})=>{const[n,i]=m.useState(()=>JSON.parse(JSON.stringify(s.haemodynamicPressures))),[o,l]=m.useState(()=>JSON.parse(JSON.stringify(s.cardiacOutput))),[c,A]=m.useState(()=>JSON.parse(JSON.stringify(s.rhcData))),[d,h]=m.useState(()=>JSON.parse(JSON.stringify(s.patientData||{})));m.useEffect(()=>{console.log("üîß RHCFieldEditor mounted with data:",{patientData:s.patientData,hasPressures:!!s.haemodynamicPressures,hasCardiacOutput:!!s.cardiacOutput,hasRhcData:!!s.rhcData})},[]);const[f,u]=m.useState(!1),[x,b]=m.useState(""),[N,v]=m.useState(""),j=bs.useRef(null);m.useEffect(()=>{console.log("üîÑ RHCFieldEditor: rhcReport prop changed, resetting state"),i(JSON.parse(JSON.stringify(s.haemodynamicPressures))),l(JSON.parse(JSON.stringify(s.cardiacOutput))),A(JSON.parse(JSON.stringify(s.rhcData))),h(JSON.parse(JSON.stringify(s.patientData||{})))},[s]),m.useEffect(()=>{j.current&&(j.current.scrollTop=0)},[]);const I=m.useMemo(()=>{const w=ee=>{if(!ee)return;const V=parseFloat(ee);return isNaN(V)?void 0:V},L=w(n.ra.mean);w(n.rv.systolic),w(n.rv.diastolic);const M=w(n.pa.systolic),P=w(n.pa.diastolic),K=w(n.pa.mean),$=w(n.pcwp.mean),O=w(o.thermodilution.co);w(o.thermodilution.ci);const W={};return W.transpulmonaryGradient=du(K,$),W.diastolicPressureGradient=uu(P,$),W.pulmonaryVascularResistance=mu(K,$,O),W.pulmonaryVascularResistance&&d.bsa&&(W.pulmonaryVascularResistanceIndex=hu(W.pulmonaryVascularResistance,d.bsa)),d.meanArterialPressure&&O&&(W.systemicVascularResistance=Hy(d.meanArterialPressure,L||0,O),W.systemicVascularResistance&&d.bsa&&(W.systemicVascularResistanceIndex=Vy(W.systemicVascularResistance,d.bsa))),O&&d.bsa&&(W.cardiacIndex=Co(O,d.bsa)),O&&d.heartRate&&(W.strokeVolume=pu(O,d.heartRate)),W.cardiacIndex&&d.heartRate&&(W.strokeVolumeIndex=$y(W.cardiacIndex,d.heartRate)),d.bsa&&(W.estimatedVO2=jh(d.bsa,d.gender)),W.estimatedVO2&&d.haemoglobin&&d.sao2&&d.svo2&&(W.fickCO=Eh(W.estimatedVO2,d.haemoglobin,d.sao2,d.svo2),W.fickCO&&d.bsa&&(W.fickCI=Co(W.fickCO,d.bsa))),K&&W.strokeVolumeIndex&&(W.rvswi=Ky(K,L||0,W.strokeVolumeIndex)),W.papi=gu(M,P,L),d.meanArterialPressure&&O&&(W.cardiacPowerOutput=Gy(d.meanArterialPressure,O)),d.meanArterialPressure&&W.cardiacIndex&&(W.cardiacPowerIndex=iC(d.meanArterialPressure,W.cardiacIndex)),K&&O&&(W.rvCardiacPowerOutput=zy(K,O)),W.rapPawpRatio=Wy(L,$),W},[n,o,d]);m.useEffect(()=>{if(!a)return;const w={...s,haemodynamicPressures:n,cardiacOutput:o,rhcData:c,patientData:d,calculations:I};a(w)},[n,o,c,d,I]),m.useEffect(()=>{const w=o.thermodilution.co,L=d.bsa;if(console.log("üî¢ Field Editor: Auto-calc CI triggered",{coValue:w,bsaValue:L}),w&&L){const M=parseFloat(w);if(!isNaN(M)&&L>0){const P=Co(M,L);if(console.log("üî¢ Field Editor: Calculated CI:",P,"from CO:",M,"BSA:",L),P!==void 0){const K=P.toFixed(2);o.thermodilution.ci!==K?(console.log("üî¢ Field Editor: Updating CI from",o.thermodilution.ci,"to",K),l($=>({...$,thermodilution:{...$.thermodilution,ci:K}}))):console.log("üî¢ Field Editor: CI already correct:",K)}}}else console.log("üî¢ Field Editor: Missing CO or BSA for CI calculation")},[o.thermodilution.co,d.bsa]),m.useEffect(()=>{const w=I.fickCO,L=I.fickCI;if(w!==void 0){const M=w.toFixed(2);o.fick.co!==M&&l(P=>({...P,fick:{...P.fick,co:M}}))}if(L!==void 0){const M=L.toFixed(2);o.fick.ci!==M&&l(P=>({...P,fick:{...P.fick,ci:M}}))}},[I.fickCO,I.fickCI]),m.useEffect(()=>{const w=o.mixedVenousO2;if(w){const L=parseFloat(w);!isNaN(L)&&d.svo2!==L&&(console.log("üî¢ Field Editor: Syncing mixedVenousO2 ‚Üí svo2:",L),h(M=>({...M,svo2:L})))}},[o.mixedVenousO2,d.svo2]);const C=(w,L,M)=>{i(P=>({...P,[w]:{...P[w],[L]:M||null}}))},E=(w,L,M)=>{l(P=>({...P,[w]:{...P[w],[L]:M||null}}))},T=(w,L)=>{l(M=>({...M,[w]:L||null}))},Q=(w,L)=>{A(M=>({...M,[w]:L||void 0}))},D=(w,L)=>{h(M=>({...M,[w]:L||void 0}))},k=()=>{!x.trim()||!N.trim()||(A(w=>({...w,[`custom_${x.toLowerCase().replace(/\s+/g,"_")}`]:N})),b(""),v(""),u(!1))},R=()=>{const w={...s,haemodynamicPressures:n,cardiacOutput:o,rhcData:c,patientData:d,calculations:I};console.log("üíæ Field Editor: Saving report with cardiacOutput:",{thermodilution:o.thermodilution,fick:o.fick,calculations:I}),e(w)};return t.jsx(as,{children:t.jsx(Ye.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.2},className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4",onClick:r,children:t.jsxs(Ye.div,{ref:j,initial:{scale:.95},animate:{scale:1},exit:{scale:.95},onClick:w=>w.stopPropagation(),className:"bg-white rounded-modal shadow-modal max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:[t.jsxs("div",{className:"sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between z-10",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(si,{className:"w-5 h-5 text-blue-600"}),t.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Edit Haemodynamic Data"})]}),t.jsx(Zt,{onClick:r,icon:t.jsx(es,{}),variant:"ghost",size:"md","aria-label":"Close",className:"rounded-full"})]}),t.jsxs("div",{className:"px-6 py-6 space-y-6",children:[t.jsxs("section",{children:[t.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center",children:[t.jsx("span",{className:"w-2 h-2 bg-cyan-500 rounded-full mr-2"}),"Patient Data"]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Height (cm)"}),t.jsx("input",{type:"number",step:"1",value:d.height||"",onChange:w=>D("height",w.target.value),placeholder:"cm",className:"w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Weight (kg)"}),t.jsx("input",{type:"number",step:"0.1",value:d.weight||"",onChange:w=>D("weight",w.target.value),placeholder:"kg",className:"w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Age (years)"}),t.jsx("input",{type:"number",step:"1",value:d.age||"",onChange:w=>D("age",w.target.value),placeholder:"years",className:"w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Gender"}),t.jsxs("select",{value:d.gender||"",onChange:w=>D("gender",w.target.value),className:"w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[t.jsx("option",{value:"",children:"Select gender"}),t.jsx("option",{value:"male",children:"Male"}),t.jsx("option",{value:"female",children:"Female"}),t.jsx("option",{value:"other",children:"Other"})]})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Haemoglobin (g/L)"}),t.jsx("input",{type:"number",step:"1",value:d.haemoglobin||"",onChange:w=>D("haemoglobin",w.target.value),placeholder:"g/L",className:"w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("div",{className:"mt-1 text-xs text-gray-500",children:"Normal: 130-180 (M), 120-160 (F)"})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Lactate (mmol/L)"}),t.jsx("input",{type:"number",step:"0.1",value:d.lactate||"",onChange:w=>D("lactate",w.target.value),placeholder:"mmol/L",className:"w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("div",{className:"mt-1 text-xs text-gray-500",children:"Normal: 0.5-2.0 mmol/L"})]})]})]}),t.jsxs("section",{children:[t.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center",children:[t.jsx("span",{className:"w-2 h-2 bg-indigo-500 rounded-full mr-2"}),"Clinical & Procedure Information"]}),t.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Indication"}),t.jsxs("select",{value:c.indication,onChange:w=>Q("indication",w.target.value),className:"w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[t.jsx("option",{value:"heart_failure",children:"Heart Failure"}),t.jsx("option",{value:"pulmonary_hypertension",children:"Pulmonary Hypertension"}),t.jsx("option",{value:"transplant_evaluation",children:"Transplant Evaluation"}),t.jsx("option",{value:"cardiogenic_shock",children:"Cardiogenic Shock"}),t.jsx("option",{value:"valvular_disease",children:"Valvular Disease"}),t.jsx("option",{value:"other",children:"Other"})]}),c.indication==="other"&&t.jsxs("div",{className:"mt-3",children:[t.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Specify Other Indication"}),t.jsx("input",{type:"text",value:c.indicationOther||"",onChange:w=>Q("indicationOther",w.target.value),placeholder:"e.g., Chronic thromboembolic disease",className:"w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Clinical Presentation"}),t.jsx("textarea",{value:c.clinicalPresentation||"",onChange:w=>Q("clinicalPresentation",w.target.value),placeholder:"e.g., Progressive dyspnoea NYHA class III...",rows:2,className:"w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Recent Investigations"}),t.jsx("textarea",{value:c.recentInvestigations||"",onChange:w=>Q("recentInvestigations",w.target.value),placeholder:"e.g., Echocardiography demonstrated...",rows:2,className:"w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Vascular Access"}),t.jsxs("select",{value:c.vascularAccess,onChange:w=>Q("vascularAccess",w.target.value),className:"w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[t.jsx("option",{value:"right_basilic_vein",children:"Right Basilic Vein"}),t.jsx("option",{value:"right_internal_jugular_vein",children:"Right Internal Jugular Vein"}),t.jsx("option",{value:"right_femoral_vein",children:"Right Femoral Vein"}),t.jsx("option",{value:"left_femoral_vein",children:"Left Femoral Vein"}),t.jsx("option",{value:"left_basilic_vein",children:"Left Basilic Vein"}),t.jsx("option",{value:"right_median_antecubital_vein",children:"Right Median Antecubital Vein"})]})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Catheter Details"}),t.jsx("input",{type:"text",value:c.catheterDetails||"",onChange:w=>Q("catheterDetails",w.target.value),placeholder:"e.g., 7 French Swan-Ganz catheter",className:"w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Recommendations"}),t.jsx("textarea",{value:c.recommendations||"",onChange:w=>Q("recommendations",w.target.value),placeholder:"e.g., Management recommendations...",rows:2,className:"w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Follow-up Plan"}),t.jsx("textarea",{value:c.followUp||"",onChange:w=>Q("followUp",w.target.value),placeholder:"e.g., Repeat RHC in 3 months...",rows:2,className:"w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})]})]}),t.jsxs("section",{children:[t.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center",children:[t.jsx("span",{className:"w-2 h-2 bg-red-500 rounded-full mr-2"}),"Haemodynamic Pressures"]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Right Atrial (RA)"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-16",children:"A-wave:"}),t.jsx("input",{type:"number",step:"0.1",value:n.ra.aWave||"",onChange:w=>C("ra","aWave",w.target.value),placeholder:"mmHg",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"mmHg"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-16",children:"V-wave:"}),t.jsx("input",{type:"number",step:"0.1",value:n.ra.vWave||"",onChange:w=>C("ra","vWave",w.target.value),placeholder:"mmHg",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"mmHg"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-16",children:"Mean:"}),t.jsx("input",{type:"number",step:"0.1",value:n.ra.mean||"",onChange:w=>C("ra","mean",w.target.value),placeholder:"mmHg",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"mmHg"})]})]}),t.jsx("div",{className:"mt-2 text-xs text-gray-500",children:"Normal: 2-8 mmHg"})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Right Ventricular (RV)"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-16",children:"Systolic:"}),t.jsx("input",{type:"number",step:"0.1",value:n.rv.systolic||"",onChange:w=>C("rv","systolic",w.target.value),placeholder:"mmHg",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"mmHg"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-16",children:"Diastolic:"}),t.jsx("input",{type:"number",step:"0.1",value:n.rv.diastolic||"",onChange:w=>C("rv","diastolic",w.target.value),placeholder:"mmHg",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"mmHg"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-16",children:"RVEDP:"}),t.jsx("input",{type:"number",step:"0.1",value:n.rv.rvedp||"",onChange:w=>C("rv","rvedp",w.target.value),placeholder:"mmHg",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"mmHg"})]})]}),t.jsx("div",{className:"mt-2 text-xs text-gray-500",children:"Normal: 15-30/2-8 mmHg"})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Pulmonary Artery (PA)"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-16",children:"Systolic:"}),t.jsx("input",{type:"number",step:"0.1",value:n.pa.systolic||"",onChange:w=>C("pa","systolic",w.target.value),placeholder:"mmHg",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"mmHg"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-16",children:"Diastolic:"}),t.jsx("input",{type:"number",step:"0.1",value:n.pa.diastolic||"",onChange:w=>C("pa","diastolic",w.target.value),placeholder:"mmHg",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"mmHg"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-16",children:"Mean:"}),t.jsx("input",{type:"number",step:"0.1",value:n.pa.mean||"",onChange:w=>C("pa","mean",w.target.value),placeholder:"mmHg",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"mmHg"})]})]}),t.jsx("div",{className:"mt-2 text-xs text-gray-500",children:"Normal: 15-30/4-12 (9-18) mmHg"})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Pulmonary Capillary Wedge Pressure (PCWP)"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-16",children:"A-wave:"}),t.jsx("input",{type:"number",step:"0.1",value:n.pcwp.aWave||"",onChange:w=>C("pcwp","aWave",w.target.value),placeholder:"mmHg",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"mmHg"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-16",children:"V-wave:"}),t.jsx("input",{type:"number",step:"0.1",value:n.pcwp.vWave||"",onChange:w=>C("pcwp","vWave",w.target.value),placeholder:"mmHg",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"mmHg"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-16",children:"Mean:"}),t.jsx("input",{type:"number",step:"0.1",value:n.pcwp.mean||"",onChange:w=>C("pcwp","mean",w.target.value),placeholder:"mmHg",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"mmHg"})]})]}),t.jsx("div",{className:"mt-2 text-xs text-gray-500",children:"Normal: 6-15 mmHg"})]})]})]}),t.jsxs("section",{children:[t.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center",children:[t.jsx("span",{className:"w-2 h-2 bg-purple-500 rounded-full mr-2"}),"Cardiac Output Assessment"]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border border-blue-200",children:[t.jsx("label",{className:"block text-sm font-medium text-blue-900 mb-2",children:"Thermodilution Method"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-blue-700 w-12",children:"CO:"}),t.jsx("input",{type:"number",step:"0.1",value:o.thermodilution.co||"",onChange:w=>E("thermodilution","co",w.target.value),placeholder:"L/min",className:"flex-1 px-3 py-1.5 text-sm border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-blue-600",children:"L/min"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-blue-700 w-12",children:"CI:"}),t.jsx("input",{type:"number",step:"0.01",value:o.thermodilution.ci||"",onChange:w=>E("thermodilution","ci",w.target.value),placeholder:"L/min/m¬≤",className:"flex-1 px-3 py-1.5 text-sm border border-blue-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-blue-600",children:"L/min/m¬≤"})]})]}),t.jsx("div",{className:"mt-2 text-xs text-blue-700",children:"Normal: 4-8 L/min, CI 2.5-4.0"})]}),t.jsxs("div",{className:"bg-green-50 p-4 rounded-lg border border-green-200",children:[t.jsx("label",{className:"block text-sm font-medium text-green-900 mb-2",children:"Fick Method"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-green-700 w-12",children:"CO:"}),t.jsx("input",{type:"number",step:"0.1",value:o.fick.co||"",onChange:w=>E("fick","co",w.target.value),placeholder:"L/min",className:"flex-1 px-3 py-1.5 text-sm border border-green-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-green-600",children:"L/min"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-green-700 w-12",children:"CI:"}),t.jsx("input",{type:"number",step:"0.01",value:o.fick.ci||"",onChange:w=>E("fick","ci",w.target.value),placeholder:"L/min/m¬≤",className:"flex-1 px-3 py-1.5 text-sm border border-green-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-green-600",children:"L/min/m¬≤"})]})]})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Oxygen Saturations"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-24",children:"Arterial (SaO‚ÇÇ):"}),t.jsx("input",{type:"number",step:"1",min:"0",max:"100",value:d.sao2||"",onChange:w=>D("sao2",w.target.value),placeholder:"%",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"%"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-24",children:"Mixed Venous:"}),t.jsx("input",{type:"number",step:"1",value:o.mixedVenousO2||"",onChange:w=>T("mixedVenousO2",w.target.value),placeholder:"%",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"%"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-24",children:"Wedge Sat:"}),t.jsx("input",{type:"number",step:"1",value:o.wedgeSaturation||"",onChange:w=>T("wedgeSaturation",w.target.value),placeholder:"%",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"%"})]})]}),t.jsx("div",{className:"mt-2 text-xs text-gray-500",children:"Normal SaO‚ÇÇ: 95‚Äì100%; Mixed Venous: 65‚Äì75%"})]})]})]}),t.jsxs("section",{children:[t.jsxs("h3",{className:"text-lg font-semibold text-gray-800 mb-4 flex items-center",children:[t.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),"Procedure Details"]}),t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Radiation & Contrast"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-24",children:"Fluoro Time:"}),t.jsx("input",{type:"number",step:"0.01",value:c.fluoroscopyTime||"",onChange:w=>Q("fluoroscopyTime",w.target.value),placeholder:"minutes",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"min"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-24",children:"Fluoro Dose:"}),t.jsx("input",{type:"number",step:"1",value:c.fluoroscopyDose||"",onChange:w=>Q("fluoroscopyDose",w.target.value),placeholder:"mGy",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"mGy"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-24",children:"DAP:"}),t.jsx("input",{type:"number",step:"1",value:c.doseAreaProduct||"",onChange:w=>Q("doseAreaProduct",w.target.value),placeholder:"Gy¬∑cm¬≤",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"Gy¬∑cm¬≤"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-xs text-gray-500 w-24",children:"Contrast:"}),t.jsx("input",{type:"number",step:"1",value:c.contrastVolume||"",onChange:w=>Q("contrastVolume",w.target.value),placeholder:"mL",className:"flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx("span",{className:"text-xs text-gray-400",children:"mL"})]})]})]})})]}),t.jsxs("section",{className:"bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-lg p-5",children:[t.jsxs("h3",{className:"text-lg font-semibold text-purple-900 mb-3 flex items-center",children:[t.jsx(Xa,{className:"w-5 h-5 mr-2 text-purple-600"}),"Calculated Haemodynamics (Live)"]}),t.jsx("p",{className:"text-xs text-purple-700 mb-4",children:"Auto-calculated from your inputs. Updates in real-time as you edit fields."}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[I.estimatedVO2&&t.jsxs("div",{className:"bg-emerald-50 rounded-md p-3 shadow-sm border border-emerald-200",children:[t.jsx("div",{className:"text-xs font-medium text-emerald-800",children:"VO‚ÇÇ (estimated)"}),t.jsx("div",{className:"text-lg font-bold text-emerald-900",children:I.estimatedVO2.toFixed(0)}),t.jsxs("div",{className:"text-xs text-emerald-700",children:["mL/min ",d.gender?`(${d.gender})`:""]})]}),I.fickCO&&t.jsxs("div",{className:"bg-emerald-50 rounded-md p-3 shadow-sm border border-emerald-200",children:[t.jsx("div",{className:"text-xs font-medium text-emerald-800",children:"Fick CO"}),t.jsx("div",{className:"text-lg font-bold text-emerald-900",children:I.fickCO.toFixed(1)}),t.jsx("div",{className:"text-xs text-emerald-700",children:"L/min (4-8)"})]}),I.fickCI&&t.jsxs("div",{className:"bg-emerald-50 rounded-md p-3 shadow-sm border border-emerald-200",children:[t.jsx("div",{className:"text-xs font-medium text-emerald-800",children:"Fick CI"}),t.jsx("div",{className:"text-lg font-bold text-emerald-900",children:I.fickCI.toFixed(1)}),t.jsx("div",{className:"text-xs text-emerald-700",children:"L/min/m¬≤ (2.5-4.0)"})]}),I.pulmonaryVascularResistance&&t.jsxs("div",{className:"bg-white rounded-md p-3 shadow-sm",children:[t.jsx("div",{className:"text-xs font-medium text-gray-600",children:"PVR"}),t.jsx("div",{className:"text-lg font-bold text-purple-900",children:I.pulmonaryVascularResistance.toFixed(1)}),t.jsx("div",{className:"text-xs text-gray-500",children:"WU (Normal: <3)"})]}),I.systemicVascularResistance&&t.jsxs("div",{className:"bg-white rounded-md p-3 shadow-sm",children:[t.jsx("div",{className:"text-xs font-medium text-gray-600",children:"SVR"}),t.jsx("div",{className:"text-lg font-bold text-purple-900",children:I.systemicVascularResistance.toFixed(1)}),t.jsx("div",{className:"text-xs text-gray-500",children:"WU (Normal: 10-20)"})]}),I.transpulmonaryGradient&&t.jsxs("div",{className:"bg-white rounded-md p-3 shadow-sm",children:[t.jsx("div",{className:"text-xs font-medium text-gray-600",children:"TPG"}),t.jsx("div",{className:"text-lg font-bold text-purple-900",children:I.transpulmonaryGradient.toFixed(0)}),t.jsx("div",{className:"text-xs text-gray-500",children:"mmHg (Normal: <12)"})]}),I.diastolicPressureGradient&&t.jsxs("div",{className:"bg-white rounded-md p-3 shadow-sm",children:[t.jsx("div",{className:"text-xs font-medium text-gray-600",children:"DPG"}),t.jsx("div",{className:"text-lg font-bold text-purple-900",children:I.diastolicPressureGradient.toFixed(0)}),t.jsx("div",{className:"text-xs text-gray-500",children:"mmHg (Normal: <7)"})]}),I.cardiacIndex&&t.jsxs("div",{className:"bg-white rounded-md p-3 shadow-sm",children:[t.jsx("div",{className:"text-xs font-medium text-gray-600",children:"CI"}),t.jsx("div",{className:"text-lg font-bold text-purple-900",children:I.cardiacIndex.toFixed(1)}),t.jsx("div",{className:"text-xs text-gray-500",children:"L/min/m¬≤ (2.5-4.0)"})]}),I.rvswi&&t.jsxs("div",{className:"bg-white rounded-md p-3 shadow-sm",children:[t.jsx("div",{className:"text-xs font-medium text-gray-600",children:"RVSWI"}),t.jsx("div",{className:"text-lg font-bold text-purple-900",children:I.rvswi.toFixed(1)}),t.jsx("div",{className:"text-xs text-gray-500",children:"g¬∑m/m¬≤ (5-10)"})]}),I.papi&&t.jsxs("div",{className:"bg-white rounded-md p-3 shadow-sm",children:[t.jsx("div",{className:"text-xs font-medium text-gray-600",children:"PAPi"}),t.jsx("div",{className:"text-lg font-bold text-purple-900",children:I.papi.toFixed(2)}),t.jsx("div",{className:"text-xs text-gray-500",children:"(Normal: >1.0)"})]}),I.cardiacPowerOutput&&t.jsxs("div",{className:"bg-white rounded-md p-3 shadow-sm",children:[t.jsx("div",{className:"text-xs font-medium text-gray-600",children:"CPO"}),t.jsx("div",{className:"text-lg font-bold text-purple-900",children:I.cardiacPowerOutput.toFixed(2)}),t.jsx("div",{className:"text-xs text-gray-500",children:"W (Normal: ‚â•0.6)"})]})]}),Object.keys(I).length===0&&t.jsx("div",{className:"text-sm text-gray-600 italic text-center py-4",children:"Fill in pressure and cardiac output values above to see calculated haemodynamics"})]})]}),t.jsxs("div",{className:"sticky bottom-0 bg-gray-50 border-t border-gray-200 px-6 py-4",children:[f&&t.jsxs("div",{className:"mb-4 p-4 bg-white border border-emerald-200 rounded-lg",children:[t.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Add Custom Field"}),t.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-3",children:[t.jsx("input",{type:"text",value:x,onChange:w=>b(w.target.value),placeholder:"Field name (e.g., 'Fluoroscopy time')",className:"px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500",onKeyDown:w=>{w.key==="Enter"&&(w.preventDefault(),k())}}),t.jsx("input",{type:"text",value:N,onChange:w=>v(w.target.value),placeholder:"Value (e.g., '8.2 minutes')",className:"px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500",onKeyDown:w=>{w.key==="Enter"&&(w.preventDefault(),k())}})]}),t.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[t.jsx(ye,{onClick:()=>{u(!1),b(""),v("")},variant:"outline",size:"sm",className:"text-xs",children:"Cancel"}),t.jsx(ye,{onClick:k,disabled:!x.trim()||!N.trim(),variant:"success",size:"sm",className:"text-xs",children:"Add Field"})]})]}),t.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-3",children:[t.jsx("p",{className:"text-xs text-gray-500",children:"Changes will be applied to the card export. Original data is preserved."}),!f&&t.jsx(ye,{onClick:()=>u(!0),variant:"outline",size:"sm",className:"text-xs border-2 border-dashed border-emerald-300 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 whitespace-nowrap flex-shrink-0",children:"+ Add Custom Field"})]}),t.jsxs("div",{className:"flex items-center space-x-3 flex-shrink-0",children:[t.jsx(ye,{onClick:r,variant:"outline",size:"md",className:"whitespace-nowrap",children:"Cancel"}),t.jsx(ye,{onClick:R,variant:"secondary",size:"md",startIcon:t.jsx(Ms,{}),className:"whitespace-nowrap",children:"Apply Changes"})]})]})]})]})})})},A5=({imageDataUrl:s,imageBlob:e,patientName:r,onClose:a})=>{const[n,i]=m.useState("idle"),[o,l]=m.useState("idle"),c=async()=>{try{await navigator.clipboard.write([new ClipboardItem({"image/png":e})]),i("success"),setTimeout(()=>i("idle"),2e3)}catch(d){console.error("Failed to copy to clipboard:",d),alert("Failed to copy to clipboard. Please try downloading instead.")}},A=()=>{const d=URL.createObjectURL(e),h=document.createElement("a"),f=new Date().toISOString().split("T")[0],u=r?`RHC_Card_${r.replace(/\s+/g,"_")}_${f}.png`:`RHC_Card_${f}.png`;h.href=d,h.download=u,h.style.display="none",document.body.appendChild(h),h.click(),setTimeout(()=>{document.body.removeChild(h),URL.revokeObjectURL(d)},100),l("success"),setTimeout(()=>l("idle"),2e3)};return t.jsx(pc,{isOpen:!0,onClose:a,size:"lg",header:t.jsxs("div",{className:"w-full -mx-6 -mt-5 px-6 py-4 rounded-t-2xl bg-gradient-to-r from-blue-50 to-cyan-50 border-b-2 border-blue-200",children:[t.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"RHC Card Preview"}),t.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"18√ó10cm @ 300 DPI"})]}),footer:t.jsxs("div",{className:"flex items-center gap-3 w-full -mx-6 -mb-4 px-6 py-4 bg-gradient-to-r from-gray-50 to-slate-50 rounded-b-2xl border-t-2 border-gray-200",children:[t.jsx(ye,{variant:"primary",onClick:c,isSuccess:n==="success",icon:Xn,className:"flex-1",children:n==="success"?"Copied!":"Copy to Clipboard"}),t.jsx(ye,{variant:"success",onClick:A,isSuccess:o==="success",icon:Ya,className:"flex-1",children:o==="success"?"Downloaded!":"Download PNG"})]}),children:t.jsx("div",{className:"bg-gray-100 rounded-lg p-4 flex items-center justify-center",children:t.jsx("img",{src:s,alt:"RHC Card Preview",className:"max-w-full h-auto rounded shadow-lg",style:{maxHeight:"60vh"}})})})};var Lh=function(s,e){return Lh=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,a){r.__proto__=a}||function(r,a){for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(r[n]=a[n])},Lh(s,e)};function ai(s,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");Lh(s,e);function r(){this.constructor=s}s.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}var Dh=function(){return Dh=Object.assign||function(e){for(var r,a=1,n=arguments.length;a<n;a++){r=arguments[a];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e},Dh.apply(this,arguments)};function La(s,e,r,a){function n(i){return i instanceof r?i:new r(function(o){o(i)})}return new(r||(r=Promise))(function(i,o){function l(d){try{A(a.next(d))}catch(h){o(h)}}function c(d){try{A(a.throw(d))}catch(h){o(h)}}function A(d){d.done?i(d.value):n(d.value).then(l,c)}A((a=a.apply(s,[])).next())})}function Ca(s,e){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},a,n,i,o;return o={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function l(A){return function(d){return c([A,d])}}function c(A){if(a)throw new TypeError("Generator is already executing.");for(;r;)try{if(a=1,n&&(i=A[0]&2?n.return:A[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,A[1])).done)return i;switch(n=0,i&&(A=[A[0]&2,i.value]),A[0]){case 0:case 1:i=A;break;case 4:return r.label++,{value:A[1],done:!1};case 5:r.label++,n=A[1],A=[0];continue;case 7:A=r.ops.pop(),r.trys.pop();continue;default:if(i=r.trys,!(i=i.length>0&&i[i.length-1])&&(A[0]===6||A[0]===2)){r=0;continue}if(A[0]===3&&(!i||A[1]>i[0]&&A[1]<i[3])){r.label=A[1];break}if(A[0]===6&&r.label<i[1]){r.label=i[1],i=A;break}if(i&&r.label<i[2]){r.label=i[2],r.ops.push(A);break}i[2]&&r.ops.pop(),r.trys.pop();continue}A=e.call(s,r)}catch(d){A=[6,d],n=0}finally{a=i=0}if(A[0]&5)throw A[1];return{value:A[0]?A[1]:void 0,done:!0}}}function ed(s,e,r){if(arguments.length===2)for(var a=0,n=e.length,i;a<n;a++)(i||!(a in e))&&(i||(i=Array.prototype.slice.call(e,0,a)),i[a]=e[a]);return s.concat(i||e)}var Ji=function(){function s(e,r,a,n){this.left=e,this.top=r,this.width=a,this.height=n}return s.prototype.add=function(e,r,a,n){return new s(this.left+e,this.top+r,this.width+a,this.height+n)},s.fromClientRect=function(e,r){return new s(r.left+e.windowBounds.left,r.top+e.windowBounds.top,r.width,r.height)},s.fromDOMRectList=function(e,r){var a=Array.from(r).find(function(n){return n.width!==0});return a?new s(a.left+e.windowBounds.left,a.top+e.windowBounds.top,a.width,a.height):s.EMPTY},s.EMPTY=new s(0,0,0,0),s}(),zu=function(s,e){return Ji.fromClientRect(s,e.getBoundingClientRect())},d5=function(s){var e=s.body,r=s.documentElement;if(!e||!r)throw new Error("Unable to get document size");var a=Math.max(Math.max(e.scrollWidth,r.scrollWidth),Math.max(e.offsetWidth,r.offsetWidth),Math.max(e.clientWidth,r.clientWidth)),n=Math.max(Math.max(e.scrollHeight,r.scrollHeight),Math.max(e.offsetHeight,r.offsetHeight),Math.max(e.clientHeight,r.clientHeight));return new Ji(0,0,a,n)},Wu=function(s){for(var e=[],r=0,a=s.length;r<a;){var n=s.charCodeAt(r++);if(n>=55296&&n<=56319&&r<a){var i=s.charCodeAt(r++);(i&64512)===56320?e.push(((n&1023)<<10)+(i&1023)+65536):(e.push(n),r--)}else e.push(n)}return e},Br=function(){for(var s=[],e=0;e<arguments.length;e++)s[e]=arguments[e];if(String.fromCodePoint)return String.fromCodePoint.apply(String,s);var r=s.length;if(!r)return"";for(var a=[],n=-1,i="";++n<r;){var o=s[n];o<=65535?a.push(o):(o-=65536,a.push((o>>10)+55296,o%1024+56320)),(n+1===r||a.length>16384)&&(i+=String.fromCharCode.apply(String,a),a.length=0)}return i},Jg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",u5=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var td=0;td<Jg.length;td++)u5[Jg.charCodeAt(td)]=td;var Yg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",zc=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var sd=0;sd<Yg.length;sd++)zc[Yg.charCodeAt(sd)]=sd;var m5=function(s){var e=s.length*.75,r=s.length,a,n=0,i,o,l,c;s[s.length-1]==="="&&(e--,s[s.length-2]==="="&&e--);var A=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u"&&typeof Uint8Array.prototype.slice<"u"?new ArrayBuffer(e):new Array(e),d=Array.isArray(A)?A:new Uint8Array(A);for(a=0;a<r;a+=4)i=zc[s.charCodeAt(a)],o=zc[s.charCodeAt(a+1)],l=zc[s.charCodeAt(a+2)],c=zc[s.charCodeAt(a+3)],d[n++]=i<<2|o>>4,d[n++]=(o&15)<<4|l>>2,d[n++]=(l&3)<<6|c&63;return A},h5=function(s){for(var e=s.length,r=[],a=0;a<e;a+=2)r.push(s[a+1]<<8|s[a]);return r},p5=function(s){for(var e=s.length,r=[],a=0;a<e;a+=4)r.push(s[a+3]<<24|s[a+2]<<16|s[a+1]<<8|s[a]);return r},rl=5,Ip=11,Im=2,g5=Ip-rl,cb=65536>>rl,f5=1<<rl,Tm=f5-1,x5=1024>>rl,y5=cb+x5,b5=y5,v5=32,w5=b5+v5,C5=65536>>Ip,N5=1<<g5,B5=N5-1,Xg=function(s,e,r){return s.slice?s.slice(e,r):new Uint16Array(Array.prototype.slice.call(s,e,r))},S5=function(s,e,r){return s.slice?s.slice(e,r):new Uint32Array(Array.prototype.slice.call(s,e,r))},j5=function(s,e){var r=m5(s),a=Array.isArray(r)?p5(r):new Uint32Array(r),n=Array.isArray(r)?h5(r):new Uint16Array(r),i=24,o=Xg(n,i/2,a[4]/2),l=a[5]===2?Xg(n,(i+a[4])/2):S5(a,Math.ceil((i+a[4])/4));return new E5(a[0],a[1],a[2],a[3],o,l)},E5=function(){function s(e,r,a,n,i,o){this.initialValue=e,this.errorValue=r,this.highStart=a,this.highValueIndex=n,this.index=i,this.data=o}return s.prototype.get=function(e){var r;if(e>=0){if(e<55296||e>56319&&e<=65535)return r=this.index[e>>rl],r=(r<<Im)+(e&Tm),this.data[r];if(e<=65535)return r=this.index[cb+(e-55296>>rl)],r=(r<<Im)+(e&Tm),this.data[r];if(e<this.highStart)return r=w5-C5+(e>>Ip),r=this.index[r],r+=e>>rl&B5,r=this.index[r],r=(r<<Im)+(e&Tm),this.data[r];if(e<=1114111)return this.data[this.highValueIndex]}return this.errorValue},s}(),Zg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",k5=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var rd=0;rd<Zg.length;rd++)k5[Zg.charCodeAt(rd)]=rd;var I5="KwAAAAAAAAAACA4AUD0AADAgAAACAAAAAAAIABAAGABAAEgAUABYAGAAaABgAGgAYgBqAF8AZwBgAGgAcQB5AHUAfQCFAI0AlQCdAKIAqgCyALoAYABoAGAAaABgAGgAwgDKAGAAaADGAM4A0wDbAOEA6QDxAPkAAQEJAQ8BFwF1AH0AHAEkASwBNAE6AUIBQQFJAVEBWQFhAWgBcAF4ATAAgAGGAY4BlQGXAZ8BpwGvAbUBvQHFAc0B0wHbAeMB6wHxAfkBAQIJAvEBEQIZAiECKQIxAjgCQAJGAk4CVgJeAmQCbAJ0AnwCgQKJApECmQKgAqgCsAK4ArwCxAIwAMwC0wLbAjAA4wLrAvMC+AIAAwcDDwMwABcDHQMlAy0DNQN1AD0DQQNJA0kDSQNRA1EDVwNZA1kDdQB1AGEDdQBpA20DdQN1AHsDdQCBA4kDkQN1AHUAmQOhA3UAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AKYDrgN1AHUAtgO+A8YDzgPWAxcD3gPjA+sD8wN1AHUA+wMDBAkEdQANBBUEHQQlBCoEFwMyBDgEYABABBcDSARQBFgEYARoBDAAcAQzAXgEgASIBJAEdQCXBHUAnwSnBK4EtgS6BMIEyAR1AHUAdQB1AHUAdQCVANAEYABgAGAAYABgAGAAYABgANgEYADcBOQEYADsBPQE/AQEBQwFFAUcBSQFLAU0BWQEPAVEBUsFUwVbBWAAYgVgAGoFcgV6BYIFigWRBWAAmQWfBaYFYABgAGAAYABgAKoFYACxBbAFuQW6BcEFwQXHBcEFwQXPBdMF2wXjBeoF8gX6BQIGCgYSBhoGIgYqBjIGOgZgAD4GRgZMBmAAUwZaBmAAYABgAGAAYABgAGAAYABgAGAAYABgAGIGYABpBnAGYABgAGAAYABgAGAAYABgAGAAYAB4Bn8GhQZgAGAAYAB1AHcDFQSLBmAAYABgAJMGdQA9A3UAmwajBqsGqwaVALMGuwbDBjAAywbSBtIG1QbSBtIG0gbSBtIG0gbdBuMG6wbzBvsGAwcLBxMHAwcbByMHJwcsBywHMQcsB9IGOAdAB0gHTgfSBkgHVgfSBtIG0gbSBtIG0gbSBtIG0gbSBiwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdgAGAALAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdbB2MHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB2kH0gZwB64EdQB1AHUAdQB1AHUAdQB1AHUHfQdgAIUHjQd1AHUAlQedB2AAYAClB6sHYACzB7YHvgfGB3UAzgfWBzMB3gfmB1EB7gf1B/0HlQENAQUIDQh1ABUIHQglCBcDLQg1CD0IRQhNCEEDUwh1AHUAdQBbCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIcAh3CHoIMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIgggwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAALAcsBywHLAcsBywHLAcsBywHLAcsB4oILAcsB44I0gaWCJ4Ipgh1AHUAqgiyCHUAdQB1AHUAdQB1AHUAdQB1AHUAtwh8AXUAvwh1AMUIyQjRCNkI4AjoCHUAdQB1AO4I9gj+CAYJDgkTCS0HGwkjCYIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiAAIAAAAFAAYABgAGIAXwBgAHEAdQBFAJUAogCyAKAAYABgAEIA4ABGANMA4QDxAMEBDwE1AFwBLAE6AQEBUQF4QkhCmEKoQrhCgAHIQsAB0MLAAcABwAHAAeDC6ABoAHDCwMMAAcABwAHAAdDDGMMAAcAB6MM4wwjDWMNow3jDaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAEjDqABWw6bDqABpg6gAaABoAHcDvwOPA+gAaABfA/8DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DpcPAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcAB9cPKwkyCToJMAB1AHUAdQBCCUoJTQl1AFUJXAljCWcJawkwADAAMAAwAHMJdQB2CX4JdQCECYoJjgmWCXUAngkwAGAAYABxAHUApgn3A64JtAl1ALkJdQDACTAAMAAwADAAdQB1AHUAdQB1AHUAdQB1AHUAowYNBMUIMAAwADAAMADICcsJ0wnZCRUE4QkwAOkJ8An4CTAAMAB1AAAKvwh1AAgKDwoXCh8KdQAwACcKLgp1ADYKqAmICT4KRgowADAAdQB1AE4KMAB1AFYKdQBeCnUAZQowADAAMAAwADAAMAAwADAAMAAVBHUAbQowADAAdQC5CXUKMAAwAHwBxAijBogEMgF9CoQKiASMCpQKmgqIBKIKqgquCogEDQG2Cr4KxgrLCjAAMADTCtsKCgHjCusK8Qr5CgELMAAwADAAMAB1AIsECQsRC3UANAEZCzAAMAAwADAAMAB1ACELKQswAHUANAExCzkLdQBBC0kLMABRC1kLMAAwADAAMAAwADAAdQBhCzAAMAAwAGAAYABpC3ELdwt/CzAAMACHC4sLkwubC58Lpwt1AK4Ltgt1APsDMAAwADAAMAAwADAAMAAwAL4LwwvLC9IL1wvdCzAAMADlC+kL8Qv5C/8LSQswADAAMAAwADAAMAAwADAAMAAHDDAAMAAwADAAMAAODBYMHgx1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1ACYMMAAwADAAdQB1AHUALgx1AHUAdQB1AHUAdQA2DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AD4MdQBGDHUAdQB1AHUAdQB1AEkMdQB1AHUAdQB1AFAMMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQBYDHUAdQB1AF8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUA+wMVBGcMMAAwAHwBbwx1AHcMfwyHDI8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAYABgAJcMMAAwADAAdQB1AJ8MlQClDDAAMACtDCwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB7UMLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AA0EMAC9DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAsBywHLAcsBywHLAcsBywHLQcwAMEMyAwsBywHLAcsBywHLAcsBywHLAcsBywHzAwwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1ANQM2QzhDDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMABgAGAAYABgAGAAYABgAOkMYADxDGAA+AwADQYNYABhCWAAYAAODTAAMAAwADAAFg1gAGAAHg37AzAAMAAwADAAYABgACYNYAAsDTQNPA1gAEMNPg1LDWAAYABgAGAAYABgAGAAYABgAGAAUg1aDYsGVglhDV0NcQBnDW0NdQ15DWAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAlQCBDZUAiA2PDZcNMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAnw2nDTAAMAAwADAAMAAwAHUArw23DTAAMAAwADAAMAAwADAAMAAwADAAMAB1AL8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQDHDTAAYABgAM8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA1w11ANwNMAAwAD0B5A0wADAAMAAwADAAMADsDfQN/A0EDgwOFA4wABsOMAAwADAAMAAwADAAMAAwANIG0gbSBtIG0gbSBtIG0gYjDigOwQUuDsEFMw7SBjoO0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGQg5KDlIOVg7SBtIGXg5lDm0OdQ7SBtIGfQ6EDooOjQ6UDtIGmg6hDtIG0gaoDqwO0ga0DrwO0gZgAGAAYADEDmAAYAAkBtIGzA5gANIOYADaDokO0gbSBt8O5w7SBu8O0gb1DvwO0gZgAGAAxA7SBtIG0gbSBtIGYABgAGAAYAAED2AAsAUMD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHJA8sBywHLAcsBywHLAccDywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywPLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAc0D9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHPA/SBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gYUD0QPlQCVAJUAMAAwADAAMACVAJUAlQCVAJUAlQCVAEwPMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA//8EAAQABAAEAAQABAAEAAQABAANAAMAAQABAAIABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQACgATABcAHgAbABoAHgAXABYAEgAeABsAGAAPABgAHABLAEsASwBLAEsASwBLAEsASwBLABgAGAAeAB4AHgATAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABYAGwASAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWAA0AEQAeAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAFAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJABYAGgAbABsAGwAeAB0AHQAeAE8AFwAeAA0AHgAeABoAGwBPAE8ADgBQAB0AHQAdAE8ATwAXAE8ATwBPABYAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAFAATwBAAE8ATwBPAEAATwBQAFAATwBQAB4AHgAeAB4AHgAeAB0AHQAdAB0AHgAdAB4ADgBQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgBQAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAkACQAJAAkACQAJAAkABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAFAAHgAeAB4AKwArAFAAUABQAFAAGABQACsAKwArACsAHgAeAFAAHgBQAFAAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUAAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAYAA0AKwArAB4AHgAbACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAB4ABAAEAB4ABAAEABMABAArACsAKwArACsAKwArACsAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAKwArACsAKwBWAFYAVgBWAB4AHgArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AGgAaABoAGAAYAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQAEwAEACsAEwATAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABLAEsASwBLAEsASwBLAEsASwBLABoAGQAZAB4AUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABMAUAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABABQAFAABAAEAB4ABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUAAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAFAABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQAUABQAB4AHgAYABMAUAArACsABAAbABsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAFAABAAEAAQABAAEAFAABAAEAAQAUAAEAAQABAAEAAQAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArACsAHgArAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAUAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEAA0ADQBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUAArACsAKwBQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABABQACsAKwArACsAKwArACsAKwAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUAAaABoAUABQAFAAUABQAEwAHgAbAFAAHgAEACsAKwAEAAQABAArAFAAUABQAFAAUABQACsAKwArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQACsAUABQACsAKwAEACsABAAEAAQABAAEACsAKwArACsABAAEACsAKwAEAAQABAArACsAKwAEACsAKwArACsAKwArACsAUABQAFAAUAArAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLAAQABABQAFAAUAAEAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAArACsAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AGwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAKwArACsAKwArAAQABAAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAAQAUAArAFAAUABQAFAAUABQACsAKwArAFAAUABQACsAUABQAFAAUAArACsAKwBQAFAAKwBQACsAUABQACsAKwArAFAAUAArACsAKwBQAFAAUAArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArAAQABAAEAAQABAArACsAKwAEAAQABAArAAQABAAEAAQAKwArAFAAKwArACsAKwArACsABAArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAHgAeAB4AHgAeAB4AGwAeACsAKwArACsAKwAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAUABQAFAAKwArACsAKwArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwAOAFAAUABQAFAAUABQAFAAHgBQAAQABAAEAA4AUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAKwArAAQAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAKwArACsAKwArACsAUAArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAFAABAAEAAQABAAEAAQABAArAAQABAAEACsABAAEAAQABABQAB4AKwArACsAKwBQAFAAUAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQABoAUABQAFAAUABQAFAAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQACsAUAArACsAUABQAFAAUABQAFAAUAArACsAKwAEACsAKwArACsABAAEAAQABAAEAAQAKwAEACsABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArAAQABAAeACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAXAAqACoAKgAqACoAKgAqACsAKwArACsAGwBcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAeAEsASwBLAEsASwBLAEsASwBLAEsADQANACsAKwArACsAKwBcAFwAKwBcACsAXABcAFwAXABcACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAXAArAFwAXABcAFwAXABcAFwAXABcAFwAKgBcAFwAKgAqACoAKgAqACoAKgAqACoAXAArACsAXABcAFwAXABcACsAXAArACoAKgAqACoAKgAqACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwBcAFwAXABcAFAADgAOAA4ADgAeAA4ADgAJAA4ADgANAAkAEwATABMAEwATAAkAHgATAB4AHgAeAAQABAAeAB4AHgAeAB4AHgBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQAFAADQAEAB4ABAAeAAQAFgARABYAEQAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAAQABAAEAAQADQAEAAQAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAA0ADQAeAB4AHgAeAB4AHgAEAB4AHgAeAB4AHgAeACsAHgAeAA4ADgANAA4AHgAeAB4AHgAeAAkACQArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgBcAEsASwBLAEsASwBLAEsASwBLAEsADQANAB4AHgAeAB4AXABcAFwAXABcAFwAKgAqACoAKgBcAFwAXABcACoAKgAqAFwAKgAqACoAXABcACoAKgAqACoAKgAqACoAXABcAFwAKgAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqAFwAKgBLAEsASwBLAEsASwBLAEsASwBLACoAKgAqACoAKgAqAFAAUABQAFAAUABQACsAUAArACsAKwArACsAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAKwBQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsABAAEAAQAHgANAB4AHgAeAB4AHgAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUAArACsADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWABEAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQANAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAANAA0AKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUAArAAQABAArACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqAA0ADQAVAFwADQAeAA0AGwBcACoAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwAeAB4AEwATAA0ADQAOAB4AEwATAB4ABAAEAAQACQArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAHgArACsAKwATABMASwBLAEsASwBLAEsASwBLAEsASwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAXABcAFwAXABcACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAXAArACsAKwAqACoAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsAHgAeAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKwAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKwArAAQASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACoAKgAqACoAKgAqACoAXAAqACoAKgAqACoAKgArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABABQAFAAUABQAFAAUABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwANAA0AHgANAA0ADQANAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwAeAB4AHgAeAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArAA0ADQANAA0ADQBLAEsASwBLAEsASwBLAEsASwBLACsAKwArAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUAAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAAQAUABQAFAAUABQAFAABABQAFAABAAEAAQAUAArACsAKwArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQACsAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAFAAUABQACsAHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQACsAKwAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQACsAHgAeAB4AHgAeAB4AHgAOAB4AKwANAA0ADQANAA0ADQANAAkADQANAA0ACAAEAAsABAAEAA0ACQANAA0ADAAdAB0AHgAXABcAFgAXABcAFwAWABcAHQAdAB4AHgAUABQAFAANAAEAAQAEAAQABAAEAAQACQAaABoAGgAaABoAGgAaABoAHgAXABcAHQAVABUAHgAeAB4AHgAeAB4AGAAWABEAFQAVABUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ADQAeAA0ADQANAA0AHgANAA0ADQAHAB4AHgAeAB4AKwAEAAQABAAEAAQABAAEAAQABAAEAFAAUAArACsATwBQAFAAUABQAFAAHgAeAB4AFgARAE8AUABPAE8ATwBPAFAAUABQAFAAUAAeAB4AHgAWABEAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArABsAGwAbABsAGwAbABsAGgAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGgAbABsAGwAbABoAGwAbABoAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAHgAeAFAAGgAeAB0AHgBQAB4AGgAeAB4AHgAeAB4AHgAeAB4AHgBPAB4AUAAbAB4AHgBQAFAAUABQAFAAHgAeAB4AHQAdAB4AUAAeAFAAHgBQAB4AUABPAFAAUAAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgBQAFAAUABQAE8ATwBQAFAAUABQAFAATwBQAFAATwBQAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAUABQAFAATwBPAE8ATwBPAE8ATwBPAE8ATwBQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABPAB4AHgArACsAKwArAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHQAdAB4AHgAeAB0AHQAeAB4AHQAeAB4AHgAdAB4AHQAbABsAHgAdAB4AHgAeAB4AHQAeAB4AHQAdAB0AHQAeAB4AHQAeAB0AHgAdAB0AHQAdAB0AHQAeAB0AHgAeAB4AHgAeAB0AHQAdAB0AHgAeAB4AHgAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHgAeAB0AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAeAB0AHQAdAB0AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAdAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAWABEAHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAWABEAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AHQAdAB0AHgAeAB0AHgAeAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlAB4AHQAdAB4AHgAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AJQAlAB0AHQAlAB4AJQAlACUAIAAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAdAB0AHQAeAB0AJQAdAB0AHgAdAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAdAB0AHQAdACUAHgAlACUAJQAdACUAJQAdAB0AHQAlACUAHQAdACUAHQAdACUAJQAlAB4AHQAeAB4AHgAeAB0AHQAlAB0AHQAdAB0AHQAdACUAJQAlACUAJQAdACUAJQAgACUAHQAdACUAJQAlACUAJQAlACUAJQAeAB4AHgAlACUAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AFwAXABcAFwAXABcAHgATABMAJQAeAB4AHgAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARABYAEQAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAEAAQABAAeAB4AKwArACsAKwArABMADQANAA0AUAATAA0AUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUAANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAA0ADQANAA0ADQANAA0ADQAeAA0AFgANAB4AHgAXABcAHgAeABcAFwAWABEAFgARABYAEQAWABEADQANAA0ADQATAFAADQANAB4ADQANAB4AHgAeAB4AHgAMAAwADQANAA0AHgANAA0AFgANAA0ADQANAA0ADQANAA0AHgANAB4ADQANAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArAA0AEQARACUAJQBHAFcAVwAWABEAFgARABYAEQAWABEAFgARACUAJQAWABEAFgARABYAEQAWABEAFQAWABEAEQAlAFcAVwBXAFcAVwBXAFcAVwBXAAQABAAEAAQABAAEACUAVwBXAFcAVwA2ACUAJQBXAFcAVwBHAEcAJQAlACUAKwBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBRAFcAUQBXAFEAVwBXAFcAVwBXAFcAUQBXAFcAVwBXAFcAVwBRAFEAKwArAAQABAAVABUARwBHAFcAFQBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBRAFcAVwBXAFcAVwBXAFEAUQBXAFcAVwBXABUAUQBHAEcAVwArACsAKwArACsAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwAlACUAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACsAKwArACsAKwArACsAKwArACsAKwArAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBPAE8ATwBPAE8ATwBPAE8AJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADQATAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABLAEsASwBLAEsASwBLAEsASwBLAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAABAAEAAQABAAeAAQABAAEAAQABAAEAAQABAAEAAQAHgBQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAeAA0ADQANAA0ADQArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAAQAUABQAFAABABQAFAAUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAeAB4AHgAeAAQAKwArACsAUABQAFAAUABQAFAAHgAeABoAHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADgAOABMAEwArACsAKwArACsAKwArACsABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwANAA0ASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUAAeAB4AHgBQAA4AUABQAAQAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArAB4AWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYACsAKwArAAQAHgAeAB4AHgAeAB4ADQANAA0AHgAeAB4AHgArAFAASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArAB4AHgBcAFwAXABcAFwAKgBcAFwAXABcAFwAXABcAFwAXABcAEsASwBLAEsASwBLAEsASwBLAEsAXABcAFwAXABcACsAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAFAAUABQAAQAUABQAFAAUABQAFAAUABQAAQABAArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAHgANAA0ADQBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAXAAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAKgAqACoAXABcACoAKgBcAFwAXABcAFwAKgAqAFwAKgBcACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcACoAKgBQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAA0ADQBQAFAAUAAEAAQAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQADQAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAVABVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBUAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVACsAKwArACsAKwArACsAKwArACsAKwArAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAKwArACsAKwBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAKwArACsAKwAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAKwArACsAKwArAFYABABWAFYAVgBWAFYAVgBWAFYAVgBWAB4AVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgArAFYAVgBWAFYAVgArAFYAKwBWAFYAKwBWAFYAKwBWAFYAVgBWAFYAVgBWAFYAVgBWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAEQAWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAaAB4AKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAGAARABEAGAAYABMAEwAWABEAFAArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACUAJQAlACUAJQAWABEAFgARABYAEQAWABEAFgARABYAEQAlACUAFgARACUAJQAlACUAJQAlACUAEQAlABEAKwAVABUAEwATACUAFgARABYAEQAWABEAJQAlACUAJQAlACUAJQAlACsAJQAbABoAJQArACsAKwArAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAcAKwATACUAJQAbABoAJQAlABYAEQAlACUAEQAlABEAJQBXAFcAVwBXAFcAVwBXAFcAVwBXABUAFQAlACUAJQATACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXABYAJQARACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAWACUAEQAlABYAEQARABYAEQARABUAVwBRAFEAUQBRAFEAUQBRAFEAUQBRAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcARwArACsAVwBXAFcAVwBXAFcAKwArAFcAVwBXAFcAVwBXACsAKwBXAFcAVwBXAFcAVwArACsAVwBXAFcAKwArACsAGgAbACUAJQAlABsAGwArAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAAQAB0AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsADQANAA0AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAA0AUABQAFAAUAArACsAKwArAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwArAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwBQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAUABQAFAAUABQAAQABAAEACsABAAEACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAKwBQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAA0ADQANAA0ADQANAA0ADQAeACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAArACsAKwArAFAAUABQAFAAUAANAA0ADQANAA0ADQAUACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsADQANAA0ADQANAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArAAQABAANACsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAB4AHgAeAB4AHgArACsAKwArACsAKwAEAAQABAAEAAQABAAEAA0ADQAeAB4AHgAeAB4AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsASwBLAEsASwBLAEsASwBLAEsASwANAA0ADQANAFAABAAEAFAAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAeAA4AUAArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAADQANAB4ADQAEAAQABAAEAB4ABAAEAEsASwBLAEsASwBLAEsASwBLAEsAUAAOAFAADQANAA0AKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAANAA0AHgANAA0AHgAEACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAA0AKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsABAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsABAAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAUAArACsAKwArACsAKwAEACsAKwArACsAKwBQAFAAUABQAFAABAAEACsAKwAEAAQABAAEAAQABAAEACsAKwArAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAAQABABQAFAAUABQAA0ADQANAA0AHgBLAEsASwBLAEsASwBLAEsASwBLAA0ADQArAB4ABABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUAAeAFAAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABAAEAAQADgANAA0AEwATAB4AHgAeAA0ADQANAA0ADQANAA0ADQANAA0ADQANAA0ADQANAFAAUABQAFAABAAEACsAKwAEAA0ADQAeAFAAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKwArACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBcAFwADQANAA0AKgBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAKwArAFAAKwArAFAAUABQAFAAUABQAFAAUAArAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQAKwAEAAQAKwArAAQABAAEAAQAUAAEAFAABAAEAA0ADQANACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABABQAA4AUAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAFAABAAEAAQABAAOAB4ADQANAA0ADQAOAB4ABAArACsAKwArACsAKwArACsAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAA0ADQANAFAADgAOAA4ADQANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAAQABAAEAFAADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAOABMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAArACsAKwAEACsABAAEACsABAAEAAQABAAEAAQABABQAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAaABoAGgAaAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABIAEgAQwBDAEMAUABQAFAAUABDAFAAUABQAEgAQwBIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABDAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAJAAkACQAJAAkACQAJABYAEQArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwANAA0AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAANACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAA0ADQANAB4AHgAeAB4AHgAeAFAAUABQAFAADQAeACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAA0AHgAeACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAARwBHABUARwAJACsAKwArACsAKwArACsAKwArACsAKwAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUQBRAFEAKwArACsAKwArACsAKwArACsAKwArACsAKwBRAFEAUQBRACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAHgAEAAQADQAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQABAAEAAQABAAeAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQAHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAKwArAFAAKwArAFAAUAArACsAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUAArAFAAUABQAFAAUABQAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAHgAeAFAAUABQAFAAUAArAFAAKwArACsAUABQAFAAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeACsAKwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4ABAAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAHgAeAA0ADQANAA0AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArAAQABAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwBQAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArABsAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAB4AHgAeAB4ABAAEAAQABAAEAAQABABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArABYAFgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAGgBQAFAAUAAaAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUAArACsAKwArACsAKwBQACsAKwArACsAUAArAFAAKwBQACsAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUAArAFAAKwBQACsAUAArAFAAUAArAFAAKwArAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAKwBQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8AJQAlACUAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB4AHgAeACUAJQAlAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAlACUAJQAlACUAHgAlACUAJQAlACUAIAAgACAAJQAlACAAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACEAIQAhACEAIQAlACUAIAAgACUAJQAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAIAAlACUAJQAlACAAIAAgACUAIAAgACAAJQAlACUAJQAlACUAJQAgACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAlAB4AJQAeACUAJQAlACUAJQAgACUAJQAlACUAHgAlAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACAAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABcAFwAXABUAFQAVAB4AHgAeAB4AJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAgACUAJQAgACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAIAAgACUAJQAgACAAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACAAIAAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACAAIAAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAA==",ef=50,T5=1,Ab=2,db=3,F5=4,P5=5,tf=7,ub=8,sf=9,Bo=10,Rh=11,rf=12,Mh=13,U5=14,Wc=15,_h=16,ad=17,Fc=18,L5=19,af=20,Qh=21,Pc=22,Fm=23,vl=24,pn=25,qc=26,Jc=27,wl=28,D5=29,Ko=30,R5=31,nd=32,id=33,Oh=34,Hh=35,Vh=36,mA=37,$h=38,qd=39,Jd=40,Pm=41,mb=42,M5=43,_5=[9001,65288],hb="!",ds="√ó",od="√∑",Kh=j5(I5),Qi=[Ko,Vh],Gh=[T5,Ab,db,P5],pb=[Bo,ub],nf=[Jc,qc],Q5=Gh.concat(pb),of=[$h,qd,Jd,Oh,Hh],O5=[Wc,Mh],H5=function(s,e){e===void 0&&(e="strict");var r=[],a=[],n=[];return s.forEach(function(i,o){var l=Kh.get(i);if(l>ef?(n.push(!0),l-=ef):n.push(!1),["normal","auto","loose"].indexOf(e)!==-1&&[8208,8211,12316,12448].indexOf(i)!==-1)return a.push(o),r.push(_h);if(l===F5||l===Rh){if(o===0)return a.push(o),r.push(Ko);var c=r[o-1];return Q5.indexOf(c)===-1?(a.push(a[o-1]),r.push(c)):(a.push(o),r.push(Ko))}if(a.push(o),l===R5)return r.push(e==="strict"?Qh:mA);if(l===mb||l===D5)return r.push(Ko);if(l===M5)return i>=131072&&i<=196605||i>=196608&&i<=262141?r.push(mA):r.push(Ko);r.push(l)}),[a,r,n]},Um=function(s,e,r,a){var n=a[r];if(Array.isArray(s)?s.indexOf(n)!==-1:s===n)for(var i=r;i<=a.length;){i++;var o=a[i];if(o===e)return!0;if(o!==Bo)break}if(n===Bo)for(var i=r;i>0;){i--;var l=a[i];if(Array.isArray(s)?s.indexOf(l)!==-1:s===l)for(var c=r;c<=a.length;){c++;var o=a[c];if(o===e)return!0;if(o!==Bo)break}if(l!==Bo)break}return!1},lf=function(s,e){for(var r=s;r>=0;){var a=e[r];if(a===Bo)r--;else return a}return 0},V5=function(s,e,r,a,n){if(r[a]===0)return ds;var i=a-1;if(Array.isArray(n)&&n[i]===!0)return ds;var o=i-1,l=i+1,c=e[i],A=o>=0?e[o]:0,d=e[l];if(c===Ab&&d===db)return ds;if(Gh.indexOf(c)!==-1)return hb;if(Gh.indexOf(d)!==-1||pb.indexOf(d)!==-1)return ds;if(lf(i,e)===ub)return od;if(Kh.get(s[i])===Rh||(c===nd||c===id)&&Kh.get(s[l])===Rh||c===tf||d===tf||c===sf||[Bo,Mh,Wc].indexOf(c)===-1&&d===sf||[ad,Fc,L5,vl,wl].indexOf(d)!==-1||lf(i,e)===Pc||Um(Fm,Pc,i,e)||Um([ad,Fc],Qh,i,e)||Um(rf,rf,i,e))return ds;if(c===Bo)return od;if(c===Fm||d===Fm)return ds;if(d===_h||c===_h)return od;if([Mh,Wc,Qh].indexOf(d)!==-1||c===U5||A===Vh&&O5.indexOf(c)!==-1||c===wl&&d===Vh||d===af||Qi.indexOf(d)!==-1&&c===pn||Qi.indexOf(c)!==-1&&d===pn||c===Jc&&[mA,nd,id].indexOf(d)!==-1||[mA,nd,id].indexOf(c)!==-1&&d===qc||Qi.indexOf(c)!==-1&&nf.indexOf(d)!==-1||nf.indexOf(c)!==-1&&Qi.indexOf(d)!==-1||[Jc,qc].indexOf(c)!==-1&&(d===pn||[Pc,Wc].indexOf(d)!==-1&&e[l+1]===pn)||[Pc,Wc].indexOf(c)!==-1&&d===pn||c===pn&&[pn,wl,vl].indexOf(d)!==-1)return ds;if([pn,wl,vl,ad,Fc].indexOf(d)!==-1)for(var h=i;h>=0;){var f=e[h];if(f===pn)return ds;if([wl,vl].indexOf(f)!==-1)h--;else break}if([Jc,qc].indexOf(d)!==-1)for(var h=[ad,Fc].indexOf(c)!==-1?o:i;h>=0;){var f=e[h];if(f===pn)return ds;if([wl,vl].indexOf(f)!==-1)h--;else break}if($h===c&&[$h,qd,Oh,Hh].indexOf(d)!==-1||[qd,Oh].indexOf(c)!==-1&&[qd,Jd].indexOf(d)!==-1||[Jd,Hh].indexOf(c)!==-1&&d===Jd||of.indexOf(c)!==-1&&[af,qc].indexOf(d)!==-1||of.indexOf(d)!==-1&&c===Jc||Qi.indexOf(c)!==-1&&Qi.indexOf(d)!==-1||c===vl&&Qi.indexOf(d)!==-1||Qi.concat(pn).indexOf(c)!==-1&&d===Pc&&_5.indexOf(s[l])===-1||Qi.concat(pn).indexOf(d)!==-1&&c===Fc)return ds;if(c===Pm&&d===Pm){for(var u=r[i],x=1;u>0&&(u--,e[u]===Pm);)x++;if(x%2!==0)return ds}return c===nd&&d===id?ds:od},$5=function(s,e){e||(e={lineBreak:"normal",wordBreak:"normal"});var r=H5(s,e.lineBreak),a=r[0],n=r[1],i=r[2];(e.wordBreak==="break-all"||e.wordBreak==="break-word")&&(n=n.map(function(l){return[pn,Ko,mb].indexOf(l)!==-1?mA:l}));var o=e.wordBreak==="keep-all"?i.map(function(l,c){return l&&s[c]>=19968&&s[c]<=40959}):void 0;return[a,n,o]},K5=function(){function s(e,r,a,n){this.codePoints=e,this.required=r===hb,this.start=a,this.end=n}return s.prototype.slice=function(){return Br.apply(void 0,this.codePoints.slice(this.start,this.end))},s}(),G5=function(s,e){var r=Wu(s),a=$5(r,e),n=a[0],i=a[1],o=a[2],l=r.length,c=0,A=0;return{next:function(){if(A>=l)return{done:!0,value:null};for(var d=ds;A<l&&(d=V5(r,i,n,++A,o))===ds;);if(d!==ds||A===l){var h=new K5(r,d,c,A);return c=A,{value:h,done:!1}}return{done:!0,value:null}}}},z5=1,W5=2,jA=4,cf=8,yu=10,Af=47,aA=92,q5=9,J5=32,ld=34,Uc=61,Y5=35,X5=36,Z5=37,cd=39,Ad=40,Lc=41,eN=95,Ja=45,tN=33,sN=60,rN=62,aN=64,nN=91,iN=93,oN=61,lN=123,dd=63,cN=125,df=124,AN=126,dN=128,uf=65533,Lm=42,Jo=43,uN=44,mN=58,hN=59,hA=46,pN=0,gN=8,fN=11,xN=14,yN=31,bN=127,gi=-1,gb=48,fb=97,xb=101,vN=102,wN=117,CN=122,yb=65,bb=69,vb=70,NN=85,BN=90,Ba=function(s){return s>=gb&&s<=57},SN=function(s){return s>=55296&&s<=57343},Cl=function(s){return Ba(s)||s>=yb&&s<=vb||s>=fb&&s<=vN},jN=function(s){return s>=fb&&s<=CN},EN=function(s){return s>=yb&&s<=BN},kN=function(s){return jN(s)||EN(s)},IN=function(s){return s>=dN},ud=function(s){return s===yu||s===q5||s===J5},bu=function(s){return kN(s)||IN(s)||s===eN},mf=function(s){return bu(s)||Ba(s)||s===Ja},TN=function(s){return s>=pN&&s<=gN||s===fN||s>=xN&&s<=yN||s===bN},bo=function(s,e){return s!==aA?!1:e!==yu},md=function(s,e,r){return s===Ja?bu(e)||bo(e,r):bu(s)?!0:!!(s===aA&&bo(s,e))},Dm=function(s,e,r){return s===Jo||s===Ja?Ba(e)?!0:e===hA&&Ba(r):Ba(s===hA?e:s)},FN=function(s){var e=0,r=1;(s[e]===Jo||s[e]===Ja)&&(s[e]===Ja&&(r=-1),e++);for(var a=[];Ba(s[e]);)a.push(s[e++]);var n=a.length?parseInt(Br.apply(void 0,a),10):0;s[e]===hA&&e++;for(var i=[];Ba(s[e]);)i.push(s[e++]);var o=i.length,l=o?parseInt(Br.apply(void 0,i),10):0;(s[e]===bb||s[e]===xb)&&e++;var c=1;(s[e]===Jo||s[e]===Ja)&&(s[e]===Ja&&(c=-1),e++);for(var A=[];Ba(s[e]);)A.push(s[e++]);var d=A.length?parseInt(Br.apply(void 0,A),10):0;return r*(n+l*Math.pow(10,-o))*Math.pow(10,c*d)},PN={type:2},UN={type:3},LN={type:4},DN={type:13},RN={type:8},MN={type:21},_N={type:9},QN={type:10},ON={type:11},HN={type:12},VN={type:14},hd={type:23},$N={type:1},KN={type:25},GN={type:24},zN={type:26},WN={type:27},qN={type:28},JN={type:29},YN={type:31},zh={type:32},wb=function(){function s(){this._value=[]}return s.prototype.write=function(e){this._value=this._value.concat(Wu(e))},s.prototype.read=function(){for(var e=[],r=this.consumeToken();r!==zh;)e.push(r),r=this.consumeToken();return e},s.prototype.consumeToken=function(){var e=this.consumeCodePoint();switch(e){case ld:return this.consumeStringToken(ld);case Y5:var r=this.peekCodePoint(0),a=this.peekCodePoint(1),n=this.peekCodePoint(2);if(mf(r)||bo(a,n)){var i=md(r,a,n)?W5:z5,o=this.consumeName();return{type:5,value:o,flags:i}}break;case X5:if(this.peekCodePoint(0)===Uc)return this.consumeCodePoint(),DN;break;case cd:return this.consumeStringToken(cd);case Ad:return PN;case Lc:return UN;case Lm:if(this.peekCodePoint(0)===Uc)return this.consumeCodePoint(),VN;break;case Jo:if(Dm(e,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(e),this.consumeNumericToken();break;case uN:return LN;case Ja:var l=e,c=this.peekCodePoint(0),A=this.peekCodePoint(1);if(Dm(l,c,A))return this.reconsumeCodePoint(e),this.consumeNumericToken();if(md(l,c,A))return this.reconsumeCodePoint(e),this.consumeIdentLikeToken();if(c===Ja&&A===rN)return this.consumeCodePoint(),this.consumeCodePoint(),GN;break;case hA:if(Dm(e,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(e),this.consumeNumericToken();break;case Af:if(this.peekCodePoint(0)===Lm)for(this.consumeCodePoint();;){var d=this.consumeCodePoint();if(d===Lm&&(d=this.consumeCodePoint(),d===Af))return this.consumeToken();if(d===gi)return this.consumeToken()}break;case mN:return zN;case hN:return WN;case sN:if(this.peekCodePoint(0)===tN&&this.peekCodePoint(1)===Ja&&this.peekCodePoint(2)===Ja)return this.consumeCodePoint(),this.consumeCodePoint(),KN;break;case aN:var h=this.peekCodePoint(0),f=this.peekCodePoint(1),u=this.peekCodePoint(2);if(md(h,f,u)){var o=this.consumeName();return{type:7,value:o}}break;case nN:return qN;case aA:if(bo(e,this.peekCodePoint(0)))return this.reconsumeCodePoint(e),this.consumeIdentLikeToken();break;case iN:return JN;case oN:if(this.peekCodePoint(0)===Uc)return this.consumeCodePoint(),RN;break;case lN:return ON;case cN:return HN;case wN:case NN:var x=this.peekCodePoint(0),b=this.peekCodePoint(1);return x===Jo&&(Cl(b)||b===dd)&&(this.consumeCodePoint(),this.consumeUnicodeRangeToken()),this.reconsumeCodePoint(e),this.consumeIdentLikeToken();case df:if(this.peekCodePoint(0)===Uc)return this.consumeCodePoint(),_N;if(this.peekCodePoint(0)===df)return this.consumeCodePoint(),MN;break;case AN:if(this.peekCodePoint(0)===Uc)return this.consumeCodePoint(),QN;break;case gi:return zh}return ud(e)?(this.consumeWhiteSpace(),YN):Ba(e)?(this.reconsumeCodePoint(e),this.consumeNumericToken()):bu(e)?(this.reconsumeCodePoint(e),this.consumeIdentLikeToken()):{type:6,value:Br(e)}},s.prototype.consumeCodePoint=function(){var e=this._value.shift();return typeof e>"u"?-1:e},s.prototype.reconsumeCodePoint=function(e){this._value.unshift(e)},s.prototype.peekCodePoint=function(e){return e>=this._value.length?-1:this._value[e]},s.prototype.consumeUnicodeRangeToken=function(){for(var e=[],r=this.consumeCodePoint();Cl(r)&&e.length<6;)e.push(r),r=this.consumeCodePoint();for(var a=!1;r===dd&&e.length<6;)e.push(r),r=this.consumeCodePoint(),a=!0;if(a){var n=parseInt(Br.apply(void 0,e.map(function(c){return c===dd?gb:c})),16),i=parseInt(Br.apply(void 0,e.map(function(c){return c===dd?vb:c})),16);return{type:30,start:n,end:i}}var o=parseInt(Br.apply(void 0,e),16);if(this.peekCodePoint(0)===Ja&&Cl(this.peekCodePoint(1))){this.consumeCodePoint(),r=this.consumeCodePoint();for(var l=[];Cl(r)&&l.length<6;)l.push(r),r=this.consumeCodePoint();var i=parseInt(Br.apply(void 0,l),16);return{type:30,start:o,end:i}}else return{type:30,start:o,end:o}},s.prototype.consumeIdentLikeToken=function(){var e=this.consumeName();return e.toLowerCase()==="url"&&this.peekCodePoint(0)===Ad?(this.consumeCodePoint(),this.consumeUrlToken()):this.peekCodePoint(0)===Ad?(this.consumeCodePoint(),{type:19,value:e}):{type:20,value:e}},s.prototype.consumeUrlToken=function(){var e=[];if(this.consumeWhiteSpace(),this.peekCodePoint(0)===gi)return{type:22,value:""};var r=this.peekCodePoint(0);if(r===cd||r===ld){var a=this.consumeStringToken(this.consumeCodePoint());return a.type===0&&(this.consumeWhiteSpace(),this.peekCodePoint(0)===gi||this.peekCodePoint(0)===Lc)?(this.consumeCodePoint(),{type:22,value:a.value}):(this.consumeBadUrlRemnants(),hd)}for(;;){var n=this.consumeCodePoint();if(n===gi||n===Lc)return{type:22,value:Br.apply(void 0,e)};if(ud(n))return this.consumeWhiteSpace(),this.peekCodePoint(0)===gi||this.peekCodePoint(0)===Lc?(this.consumeCodePoint(),{type:22,value:Br.apply(void 0,e)}):(this.consumeBadUrlRemnants(),hd);if(n===ld||n===cd||n===Ad||TN(n))return this.consumeBadUrlRemnants(),hd;if(n===aA)if(bo(n,this.peekCodePoint(0)))e.push(this.consumeEscapedCodePoint());else return this.consumeBadUrlRemnants(),hd;else e.push(n)}},s.prototype.consumeWhiteSpace=function(){for(;ud(this.peekCodePoint(0));)this.consumeCodePoint()},s.prototype.consumeBadUrlRemnants=function(){for(;;){var e=this.consumeCodePoint();if(e===Lc||e===gi)return;bo(e,this.peekCodePoint(0))&&this.consumeEscapedCodePoint()}},s.prototype.consumeStringSlice=function(e){for(var r=5e4,a="";e>0;){var n=Math.min(r,e);a+=Br.apply(void 0,this._value.splice(0,n)),e-=n}return this._value.shift(),a},s.prototype.consumeStringToken=function(e){var r="",a=0;do{var n=this._value[a];if(n===gi||n===void 0||n===e)return r+=this.consumeStringSlice(a),{type:0,value:r};if(n===yu)return this._value.splice(0,a),$N;if(n===aA){var i=this._value[a+1];i!==gi&&i!==void 0&&(i===yu?(r+=this.consumeStringSlice(a),a=-1,this._value.shift()):bo(n,i)&&(r+=this.consumeStringSlice(a),r+=Br(this.consumeEscapedCodePoint()),a=-1))}a++}while(!0)},s.prototype.consumeNumber=function(){var e=[],r=jA,a=this.peekCodePoint(0);for((a===Jo||a===Ja)&&e.push(this.consumeCodePoint());Ba(this.peekCodePoint(0));)e.push(this.consumeCodePoint());a=this.peekCodePoint(0);var n=this.peekCodePoint(1);if(a===hA&&Ba(n))for(e.push(this.consumeCodePoint(),this.consumeCodePoint()),r=cf;Ba(this.peekCodePoint(0));)e.push(this.consumeCodePoint());a=this.peekCodePoint(0),n=this.peekCodePoint(1);var i=this.peekCodePoint(2);if((a===bb||a===xb)&&((n===Jo||n===Ja)&&Ba(i)||Ba(n)))for(e.push(this.consumeCodePoint(),this.consumeCodePoint()),r=cf;Ba(this.peekCodePoint(0));)e.push(this.consumeCodePoint());return[FN(e),r]},s.prototype.consumeNumericToken=function(){var e=this.consumeNumber(),r=e[0],a=e[1],n=this.peekCodePoint(0),i=this.peekCodePoint(1),o=this.peekCodePoint(2);if(md(n,i,o)){var l=this.consumeName();return{type:15,number:r,flags:a,unit:l}}return n===Z5?(this.consumeCodePoint(),{type:16,number:r,flags:a}):{type:17,number:r,flags:a}},s.prototype.consumeEscapedCodePoint=function(){var e=this.consumeCodePoint();if(Cl(e)){for(var r=Br(e);Cl(this.peekCodePoint(0))&&r.length<6;)r+=Br(this.consumeCodePoint());ud(this.peekCodePoint(0))&&this.consumeCodePoint();var a=parseInt(r,16);return a===0||SN(a)||a>1114111?uf:a}return e===gi?uf:e},s.prototype.consumeName=function(){for(var e="";;){var r=this.consumeCodePoint();if(mf(r))e+=Br(r);else if(bo(r,this.peekCodePoint(0)))e+=Br(this.consumeEscapedCodePoint());else return this.reconsumeCodePoint(r),e}},s}(),Cb=function(){function s(e){this._tokens=e}return s.create=function(e){var r=new wb;return r.write(e),new s(r.read())},s.parseValue=function(e){return s.create(e).parseComponentValue()},s.parseValues=function(e){return s.create(e).parseComponentValues()},s.prototype.parseComponentValue=function(){for(var e=this.consumeToken();e.type===31;)e=this.consumeToken();if(e.type===32)throw new SyntaxError("Error parsing CSS component value, unexpected EOF");this.reconsumeToken(e);var r=this.consumeComponentValue();do e=this.consumeToken();while(e.type===31);if(e.type===32)return r;throw new SyntaxError("Error parsing CSS component value, multiple values found when expecting only one")},s.prototype.parseComponentValues=function(){for(var e=[];;){var r=this.consumeComponentValue();if(r.type===32)return e;e.push(r),e.push()}},s.prototype.consumeComponentValue=function(){var e=this.consumeToken();switch(e.type){case 11:case 28:case 2:return this.consumeSimpleBlock(e.type);case 19:return this.consumeFunction(e)}return e},s.prototype.consumeSimpleBlock=function(e){for(var r={type:e,values:[]},a=this.consumeToken();;){if(a.type===32||ZN(a,e))return r;this.reconsumeToken(a),r.values.push(this.consumeComponentValue()),a=this.consumeToken()}},s.prototype.consumeFunction=function(e){for(var r={name:e.value,values:[],type:18};;){var a=this.consumeToken();if(a.type===32||a.type===3)return r;this.reconsumeToken(a),r.values.push(this.consumeComponentValue())}},s.prototype.consumeToken=function(){var e=this._tokens.shift();return typeof e>"u"?zh:e},s.prototype.reconsumeToken=function(e){this._tokens.unshift(e)},s}(),EA=function(s){return s.type===15},gc=function(s){return s.type===17},Os=function(s){return s.type===20},XN=function(s){return s.type===0},Wh=function(s,e){return Os(s)&&s.value===e},Nb=function(s){return s.type!==31},hc=function(s){return s.type!==31&&s.type!==4},ki=function(s){var e=[],r=[];return s.forEach(function(a){if(a.type===4){if(r.length===0)throw new Error("Error parsing function args, zero tokens for arg");e.push(r),r=[];return}a.type!==31&&r.push(a)}),r.length&&e.push(r),e},ZN=function(s,e){return e===11&&s.type===12||e===28&&s.type===29?!0:e===2&&s.type===3},Uo=function(s){return s.type===17||s.type===15},Pr=function(s){return s.type===16||Uo(s)},Bb=function(s){return s.length>1?[s[0],s[1]]:[s[0]]},da={type:17,number:0,flags:jA},Tp={type:16,number:50,flags:jA},So={type:16,number:100,flags:jA},Yc=function(s,e,r){var a=s[0],n=s[1];return[qs(a,e),qs(typeof n<"u"?n:a,r)]},qs=function(s,e){if(s.type===16)return s.number/100*e;if(EA(s))switch(s.unit){case"rem":case"em":return 16*s.number;case"px":default:return s.number}return s.number},Sb="deg",jb="grad",Eb="rad",kb="turn",qu={name:"angle",parse:function(s,e){if(e.type===15)switch(e.unit){case Sb:return Math.PI*e.number/180;case jb:return Math.PI/200*e.number;case Eb:return e.number;case kb:return Math.PI*2*e.number}throw new Error("Unsupported angle type")}},Ib=function(s){return s.type===15&&(s.unit===Sb||s.unit===jb||s.unit===Eb||s.unit===kb)},Tb=function(s){var e=s.filter(Os).map(function(r){return r.value}).join(" ");switch(e){case"to bottom right":case"to right bottom":case"left top":case"top left":return[da,da];case"to top":case"bottom":return Pn(0);case"to bottom left":case"to left bottom":case"right top":case"top right":return[da,So];case"to right":case"left":return Pn(90);case"to top left":case"to left top":case"right bottom":case"bottom right":return[So,So];case"to bottom":case"top":return Pn(180);case"to top right":case"to right top":case"left bottom":case"bottom left":return[So,da];case"to left":case"right":return Pn(270)}return 0},Pn=function(s){return Math.PI*s/180},To={name:"color",parse:function(s,e){if(e.type===18){var r=eB[e.name];if(typeof r>"u")throw new Error('Attempting to parse an unsupported color function "'+e.name+'"');return r(s,e.values)}if(e.type===5){if(e.value.length===3){var a=e.value.substring(0,1),n=e.value.substring(1,2),i=e.value.substring(2,3);return jo(parseInt(a+a,16),parseInt(n+n,16),parseInt(i+i,16),1)}if(e.value.length===4){var a=e.value.substring(0,1),n=e.value.substring(1,2),i=e.value.substring(2,3),o=e.value.substring(3,4);return jo(parseInt(a+a,16),parseInt(n+n,16),parseInt(i+i,16),parseInt(o+o,16)/255)}if(e.value.length===6){var a=e.value.substring(0,2),n=e.value.substring(2,4),i=e.value.substring(4,6);return jo(parseInt(a,16),parseInt(n,16),parseInt(i,16),1)}if(e.value.length===8){var a=e.value.substring(0,2),n=e.value.substring(2,4),i=e.value.substring(4,6),o=e.value.substring(6,8);return jo(parseInt(a,16),parseInt(n,16),parseInt(i,16),parseInt(o,16)/255)}}if(e.type===20){var l=Wi[e.value.toUpperCase()];if(typeof l<"u")return l}return Wi.TRANSPARENT}},Fo=function(s){return(255&s)===0},Yr=function(s){var e=255&s,r=255&s>>8,a=255&s>>16,n=255&s>>24;return e<255?"rgba("+n+","+a+","+r+","+e/255+")":"rgb("+n+","+a+","+r+")"},jo=function(s,e,r,a){return(s<<24|e<<16|r<<8|Math.round(a*255)<<0)>>>0},hf=function(s,e){if(s.type===17)return s.number;if(s.type===16){var r=e===3?1:255;return e===3?s.number/100*r:Math.round(s.number/100*r)}return 0},pf=function(s,e){var r=e.filter(hc);if(r.length===3){var a=r.map(hf),n=a[0],i=a[1],o=a[2];return jo(n,i,o,1)}if(r.length===4){var l=r.map(hf),n=l[0],i=l[1],o=l[2],c=l[3];return jo(n,i,o,c)}return 0};function Rm(s,e,r){return r<0&&(r+=1),r>=1&&(r-=1),r<1/6?(e-s)*r*6+s:r<1/2?e:r<2/3?(e-s)*6*(2/3-r)+s:s}var gf=function(s,e){var r=e.filter(hc),a=r[0],n=r[1],i=r[2],o=r[3],l=(a.type===17?Pn(a.number):qu.parse(s,a))/(Math.PI*2),c=Pr(n)?n.number/100:0,A=Pr(i)?i.number/100:0,d=typeof o<"u"&&Pr(o)?qs(o,1):1;if(c===0)return jo(A*255,A*255,A*255,1);var h=A<=.5?A*(c+1):A+c-A*c,f=A*2-h,u=Rm(f,h,l+1/3),x=Rm(f,h,l),b=Rm(f,h,l-1/3);return jo(u*255,x*255,b*255,d)},eB={hsl:gf,hsla:gf,rgb:pf,rgba:pf},nA=function(s,e){return To.parse(s,Cb.create(e).parseComponentValue())},Wi={ALICEBLUE:4042850303,ANTIQUEWHITE:4209760255,AQUA:16777215,AQUAMARINE:2147472639,AZURE:4043309055,BEIGE:4126530815,BISQUE:4293182719,BLACK:255,BLANCHEDALMOND:4293643775,BLUE:65535,BLUEVIOLET:2318131967,BROWN:2771004159,BURLYWOOD:3736635391,CADETBLUE:1604231423,CHARTREUSE:2147418367,CHOCOLATE:3530104575,CORAL:4286533887,CORNFLOWERBLUE:1687547391,CORNSILK:4294499583,CRIMSON:3692313855,CYAN:16777215,DARKBLUE:35839,DARKCYAN:9145343,DARKGOLDENROD:3095837695,DARKGRAY:2846468607,DARKGREEN:6553855,DARKGREY:2846468607,DARKKHAKI:3182914559,DARKMAGENTA:2332068863,DARKOLIVEGREEN:1433087999,DARKORANGE:4287365375,DARKORCHID:2570243327,DARKRED:2332033279,DARKSALMON:3918953215,DARKSEAGREEN:2411499519,DARKSLATEBLUE:1211993087,DARKSLATEGRAY:793726975,DARKSLATEGREY:793726975,DARKTURQUOISE:13554175,DARKVIOLET:2483082239,DEEPPINK:4279538687,DEEPSKYBLUE:12582911,DIMGRAY:1768516095,DIMGREY:1768516095,DODGERBLUE:512819199,FIREBRICK:2988581631,FLORALWHITE:4294635775,FORESTGREEN:579543807,FUCHSIA:4278255615,GAINSBORO:3705462015,GHOSTWHITE:4177068031,GOLD:4292280575,GOLDENROD:3668254975,GRAY:2155905279,GREEN:8388863,GREENYELLOW:2919182335,GREY:2155905279,HONEYDEW:4043305215,HOTPINK:4285117695,INDIANRED:3445382399,INDIGO:1258324735,IVORY:4294963455,KHAKI:4041641215,LAVENDER:3873897215,LAVENDERBLUSH:4293981695,LAWNGREEN:2096890111,LEMONCHIFFON:4294626815,LIGHTBLUE:2916673279,LIGHTCORAL:4034953471,LIGHTCYAN:3774873599,LIGHTGOLDENRODYELLOW:4210742015,LIGHTGRAY:3553874943,LIGHTGREEN:2431553791,LIGHTGREY:3553874943,LIGHTPINK:4290167295,LIGHTSALMON:4288707327,LIGHTSEAGREEN:548580095,LIGHTSKYBLUE:2278488831,LIGHTSLATEGRAY:2005441023,LIGHTSLATEGREY:2005441023,LIGHTSTEELBLUE:2965692159,LIGHTYELLOW:4294959359,LIME:16711935,LIMEGREEN:852308735,LINEN:4210091775,MAGENTA:4278255615,MAROON:2147483903,MEDIUMAQUAMARINE:1724754687,MEDIUMBLUE:52735,MEDIUMORCHID:3126187007,MEDIUMPURPLE:2473647103,MEDIUMSEAGREEN:1018393087,MEDIUMSLATEBLUE:2070474495,MEDIUMSPRINGGREEN:16423679,MEDIUMTURQUOISE:1221709055,MEDIUMVIOLETRED:3340076543,MIDNIGHTBLUE:421097727,MINTCREAM:4127193855,MISTYROSE:4293190143,MOCCASIN:4293178879,NAVAJOWHITE:4292783615,NAVY:33023,OLDLACE:4260751103,OLIVE:2155872511,OLIVEDRAB:1804477439,ORANGE:4289003775,ORANGERED:4282712319,ORCHID:3664828159,PALEGOLDENROD:4008225535,PALEGREEN:2566625535,PALETURQUOISE:2951671551,PALEVIOLETRED:3681588223,PAPAYAWHIP:4293907967,PEACHPUFF:4292524543,PERU:3448061951,PINK:4290825215,PLUM:3718307327,POWDERBLUE:2967529215,PURPLE:2147516671,REBECCAPURPLE:1714657791,RED:4278190335,ROSYBROWN:3163525119,ROYALBLUE:1097458175,SADDLEBROWN:2336560127,SALMON:4202722047,SANDYBROWN:4104413439,SEAGREEN:780883967,SEASHELL:4294307583,SIENNA:2689740287,SILVER:3233857791,SKYBLUE:2278484991,SLATEBLUE:1784335871,SLATEGRAY:1887473919,SLATEGREY:1887473919,SNOW:4294638335,SPRINGGREEN:16744447,STEELBLUE:1182971135,TAN:3535047935,TEAL:8421631,THISTLE:3636451583,TOMATO:4284696575,TRANSPARENT:0,TURQUOISE:1088475391,VIOLET:4001558271,WHEAT:4125012991,WHITE:4294967295,WHITESMOKE:4126537215,YELLOW:4294902015,YELLOWGREEN:2597139199},tB={name:"background-clip",initialValue:"border-box",prefix:!1,type:1,parse:function(s,e){return e.map(function(r){if(Os(r))switch(r.value){case"padding-box":return 1;case"content-box":return 2}return 0})}},sB={name:"background-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},Ju=function(s,e){var r=To.parse(s,e[0]),a=e[1];return a&&Pr(a)?{color:r,stop:a}:{color:r,stop:null}},ff=function(s,e){var r=s[0],a=s[s.length-1];r.stop===null&&(r.stop=da),a.stop===null&&(a.stop=So);for(var n=[],i=0,o=0;o<s.length;o++){var l=s[o].stop;if(l!==null){var c=qs(l,e);c>i?n.push(c):n.push(i),i=c}else n.push(null)}for(var A=null,o=0;o<n.length;o++){var d=n[o];if(d===null)A===null&&(A=o);else if(A!==null){for(var h=o-A,f=n[A-1],u=(d-f)/(h+1),x=1;x<=h;x++)n[A+x-1]=u*x;A=null}}return s.map(function(b,N){var v=b.color;return{color:v,stop:Math.max(Math.min(1,n[N]/e),0)}})},rB=function(s,e,r){var a=e/2,n=r/2,i=qs(s[0],e)-a,o=n-qs(s[1],r);return(Math.atan2(o,i)+Math.PI*2)%(Math.PI*2)},aB=function(s,e,r){var a=typeof s=="number"?s:rB(s,e,r),n=Math.abs(e*Math.sin(a))+Math.abs(r*Math.cos(a)),i=e/2,o=r/2,l=n/2,c=Math.sin(a-Math.PI/2)*l,A=Math.cos(a-Math.PI/2)*l;return[n,i-A,i+A,o-c,o+c]},zn=function(s,e){return Math.sqrt(s*s+e*e)},xf=function(s,e,r,a,n){var i=[[0,0],[0,e],[s,0],[s,e]];return i.reduce(function(o,l){var c=l[0],A=l[1],d=zn(r-c,a-A);return(n?d<o.optimumDistance:d>o.optimumDistance)?{optimumCorner:l,optimumDistance:d}:o},{optimumDistance:n?1/0:-1/0,optimumCorner:null}).optimumCorner},nB=function(s,e,r,a,n){var i=0,o=0;switch(s.size){case 0:s.shape===0?i=o=Math.min(Math.abs(e),Math.abs(e-a),Math.abs(r),Math.abs(r-n)):s.shape===1&&(i=Math.min(Math.abs(e),Math.abs(e-a)),o=Math.min(Math.abs(r),Math.abs(r-n)));break;case 2:if(s.shape===0)i=o=Math.min(zn(e,r),zn(e,r-n),zn(e-a,r),zn(e-a,r-n));else if(s.shape===1){var l=Math.min(Math.abs(r),Math.abs(r-n))/Math.min(Math.abs(e),Math.abs(e-a)),c=xf(a,n,e,r,!0),A=c[0],d=c[1];i=zn(A-e,(d-r)/l),o=l*i}break;case 1:s.shape===0?i=o=Math.max(Math.abs(e),Math.abs(e-a),Math.abs(r),Math.abs(r-n)):s.shape===1&&(i=Math.max(Math.abs(e),Math.abs(e-a)),o=Math.max(Math.abs(r),Math.abs(r-n)));break;case 3:if(s.shape===0)i=o=Math.max(zn(e,r),zn(e,r-n),zn(e-a,r),zn(e-a,r-n));else if(s.shape===1){var l=Math.max(Math.abs(r),Math.abs(r-n))/Math.max(Math.abs(e),Math.abs(e-a)),h=xf(a,n,e,r,!1),A=h[0],d=h[1];i=zn(A-e,(d-r)/l),o=l*i}break}return Array.isArray(s.size)&&(i=qs(s.size[0],a),o=s.size.length===2?qs(s.size[1],n):i),[i,o]},iB=function(s,e){var r=Pn(180),a=[];return ki(e).forEach(function(n,i){if(i===0){var o=n[0];if(o.type===20&&o.value==="to"){r=Tb(n);return}else if(Ib(o)){r=qu.parse(s,o);return}}var l=Ju(s,n);a.push(l)}),{angle:r,stops:a,type:1}},pd=function(s,e){var r=Pn(180),a=[];return ki(e).forEach(function(n,i){if(i===0){var o=n[0];if(o.type===20&&["top","left","right","bottom"].indexOf(o.value)!==-1){r=Tb(n);return}else if(Ib(o)){r=(qu.parse(s,o)+Pn(270))%Pn(360);return}}var l=Ju(s,n);a.push(l)}),{angle:r,stops:a,type:1}},oB=function(s,e){var r=Pn(180),a=[],n=1,i=0,o=3,l=[];return ki(e).forEach(function(c,A){var d=c[0];if(A===0){if(Os(d)&&d.value==="linear"){n=1;return}else if(Os(d)&&d.value==="radial"){n=2;return}}if(d.type===18){if(d.name==="from"){var h=To.parse(s,d.values[0]);a.push({stop:da,color:h})}else if(d.name==="to"){var h=To.parse(s,d.values[0]);a.push({stop:So,color:h})}else if(d.name==="color-stop"){var f=d.values.filter(hc);if(f.length===2){var h=To.parse(s,f[1]),u=f[0];gc(u)&&a.push({stop:{type:16,number:u.number*100,flags:u.flags},color:h})}}}}),n===1?{angle:(r+Pn(180))%Pn(360),stops:a,type:n}:{size:o,shape:i,stops:a,position:l,type:n}},Fb="closest-side",Pb="farthest-side",Ub="closest-corner",Lb="farthest-corner",Db="circle",Rb="ellipse",Mb="cover",_b="contain",lB=function(s,e){var r=0,a=3,n=[],i=[];return ki(e).forEach(function(o,l){var c=!0;if(l===0){var A=!1;c=o.reduce(function(h,f){if(A)if(Os(f))switch(f.value){case"center":return i.push(Tp),h;case"top":case"left":return i.push(da),h;case"right":case"bottom":return i.push(So),h}else(Pr(f)||Uo(f))&&i.push(f);else if(Os(f))switch(f.value){case Db:return r=0,!1;case Rb:return r=1,!1;case"at":return A=!0,!1;case Fb:return a=0,!1;case Mb:case Pb:return a=1,!1;case _b:case Ub:return a=2,!1;case Lb:return a=3,!1}else if(Uo(f)||Pr(f))return Array.isArray(a)||(a=[]),a.push(f),!1;return h},c)}if(c){var d=Ju(s,o);n.push(d)}}),{size:a,shape:r,stops:n,position:i,type:2}},gd=function(s,e){var r=0,a=3,n=[],i=[];return ki(e).forEach(function(o,l){var c=!0;if(l===0?c=o.reduce(function(d,h){if(Os(h))switch(h.value){case"center":return i.push(Tp),!1;case"top":case"left":return i.push(da),!1;case"right":case"bottom":return i.push(So),!1}else if(Pr(h)||Uo(h))return i.push(h),!1;return d},c):l===1&&(c=o.reduce(function(d,h){if(Os(h))switch(h.value){case Db:return r=0,!1;case Rb:return r=1,!1;case _b:case Fb:return a=0,!1;case Pb:return a=1,!1;case Ub:return a=2,!1;case Mb:case Lb:return a=3,!1}else if(Uo(h)||Pr(h))return Array.isArray(a)||(a=[]),a.push(h),!1;return d},c)),c){var A=Ju(s,o);n.push(A)}}),{size:a,shape:r,stops:n,position:i,type:2}},cB=function(s){return s.type===1},AB=function(s){return s.type===2},Fp={name:"image",parse:function(s,e){if(e.type===22){var r={url:e.value,type:0};return s.cache.addImage(e.value),r}if(e.type===18){var a=Qb[e.name];if(typeof a>"u")throw new Error('Attempting to parse an unsupported image function "'+e.name+'"');return a(s,e.values)}throw new Error("Unsupported image type "+e.type)}};function dB(s){return!(s.type===20&&s.value==="none")&&(s.type!==18||!!Qb[s.name])}var Qb={"linear-gradient":iB,"-moz-linear-gradient":pd,"-ms-linear-gradient":pd,"-o-linear-gradient":pd,"-webkit-linear-gradient":pd,"radial-gradient":lB,"-moz-radial-gradient":gd,"-ms-radial-gradient":gd,"-o-radial-gradient":gd,"-webkit-radial-gradient":gd,"-webkit-gradient":oB},uB={name:"background-image",initialValue:"none",type:1,prefix:!1,parse:function(s,e){if(e.length===0)return[];var r=e[0];return r.type===20&&r.value==="none"?[]:e.filter(function(a){return hc(a)&&dB(a)}).map(function(a){return Fp.parse(s,a)})}},mB={name:"background-origin",initialValue:"border-box",prefix:!1,type:1,parse:function(s,e){return e.map(function(r){if(Os(r))switch(r.value){case"padding-box":return 1;case"content-box":return 2}return 0})}},hB={name:"background-position",initialValue:"0% 0%",type:1,prefix:!1,parse:function(s,e){return ki(e).map(function(r){return r.filter(Pr)}).map(Bb)}},pB={name:"background-repeat",initialValue:"repeat",prefix:!1,type:1,parse:function(s,e){return ki(e).map(function(r){return r.filter(Os).map(function(a){return a.value}).join(" ")}).map(gB)}},gB=function(s){switch(s){case"no-repeat":return 1;case"repeat-x":case"repeat no-repeat":return 2;case"repeat-y":case"no-repeat repeat":return 3;case"repeat":default:return 0}},ac;(function(s){s.AUTO="auto",s.CONTAIN="contain",s.COVER="cover"})(ac||(ac={}));var fB={name:"background-size",initialValue:"0",prefix:!1,type:1,parse:function(s,e){return ki(e).map(function(r){return r.filter(xB)})}},xB=function(s){return Os(s)||Pr(s)},Yu=function(s){return{name:"border-"+s+"-color",initialValue:"transparent",prefix:!1,type:3,format:"color"}},yB=Yu("top"),bB=Yu("right"),vB=Yu("bottom"),wB=Yu("left"),Xu=function(s){return{name:"border-radius-"+s,initialValue:"0 0",prefix:!1,type:1,parse:function(e,r){return Bb(r.filter(Pr))}}},CB=Xu("top-left"),NB=Xu("top-right"),BB=Xu("bottom-right"),SB=Xu("bottom-left"),Zu=function(s){return{name:"border-"+s+"-style",initialValue:"solid",prefix:!1,type:2,parse:function(e,r){switch(r){case"none":return 0;case"dashed":return 2;case"dotted":return 3;case"double":return 4}return 1}}},jB=Zu("top"),EB=Zu("right"),kB=Zu("bottom"),IB=Zu("left"),em=function(s){return{name:"border-"+s+"-width",initialValue:"0",type:0,prefix:!1,parse:function(e,r){return EA(r)?r.number:0}}},TB=em("top"),FB=em("right"),PB=em("bottom"),UB=em("left"),LB={name:"color",initialValue:"transparent",prefix:!1,type:3,format:"color"},DB={name:"direction",initialValue:"ltr",prefix:!1,type:2,parse:function(s,e){switch(e){case"rtl":return 1;case"ltr":default:return 0}}},RB={name:"display",initialValue:"inline-block",prefix:!1,type:1,parse:function(s,e){return e.filter(Os).reduce(function(r,a){return r|MB(a.value)},0)}},MB=function(s){switch(s){case"block":case"-webkit-box":return 2;case"inline":return 4;case"run-in":return 8;case"flow":return 16;case"flow-root":return 32;case"table":return 64;case"flex":case"-webkit-flex":return 128;case"grid":case"-ms-grid":return 256;case"ruby":return 512;case"subgrid":return 1024;case"list-item":return 2048;case"table-row-group":return 4096;case"table-header-group":return 8192;case"table-footer-group":return 16384;case"table-row":return 32768;case"table-cell":return 65536;case"table-column-group":return 131072;case"table-column":return 262144;case"table-caption":return 524288;case"ruby-base":return 1048576;case"ruby-text":return 2097152;case"ruby-base-container":return 4194304;case"ruby-text-container":return 8388608;case"contents":return 16777216;case"inline-block":return 33554432;case"inline-list-item":return 67108864;case"inline-table":return 134217728;case"inline-flex":return 268435456;case"inline-grid":return 536870912}return 0},_B={name:"float",initialValue:"none",prefix:!1,type:2,parse:function(s,e){switch(e){case"left":return 1;case"right":return 2;case"inline-start":return 3;case"inline-end":return 4}return 0}},QB={name:"letter-spacing",initialValue:"0",prefix:!1,type:0,parse:function(s,e){return e.type===20&&e.value==="normal"?0:e.type===17||e.type===15?e.number:0}},vu;(function(s){s.NORMAL="normal",s.STRICT="strict"})(vu||(vu={}));var OB={name:"line-break",initialValue:"normal",prefix:!1,type:2,parse:function(s,e){switch(e){case"strict":return vu.STRICT;case"normal":default:return vu.NORMAL}}},HB={name:"line-height",initialValue:"normal",prefix:!1,type:4},yf=function(s,e){return Os(s)&&s.value==="normal"?1.2*e:s.type===17?e*s.number:Pr(s)?qs(s,e):e},VB={name:"list-style-image",initialValue:"none",type:0,prefix:!1,parse:function(s,e){return e.type===20&&e.value==="none"?null:Fp.parse(s,e)}},$B={name:"list-style-position",initialValue:"outside",prefix:!1,type:2,parse:function(s,e){switch(e){case"inside":return 0;case"outside":default:return 1}}},qh={name:"list-style-type",initialValue:"none",prefix:!1,type:2,parse:function(s,e){switch(e){case"disc":return 0;case"circle":return 1;case"square":return 2;case"decimal":return 3;case"cjk-decimal":return 4;case"decimal-leading-zero":return 5;case"lower-roman":return 6;case"upper-roman":return 7;case"lower-greek":return 8;case"lower-alpha":return 9;case"upper-alpha":return 10;case"arabic-indic":return 11;case"armenian":return 12;case"bengali":return 13;case"cambodian":return 14;case"cjk-earthly-branch":return 15;case"cjk-heavenly-stem":return 16;case"cjk-ideographic":return 17;case"devanagari":return 18;case"ethiopic-numeric":return 19;case"georgian":return 20;case"gujarati":return 21;case"gurmukhi":return 22;case"hebrew":return 22;case"hiragana":return 23;case"hiragana-iroha":return 24;case"japanese-formal":return 25;case"japanese-informal":return 26;case"kannada":return 27;case"katakana":return 28;case"katakana-iroha":return 29;case"khmer":return 30;case"korean-hangul-formal":return 31;case"korean-hanja-formal":return 32;case"korean-hanja-informal":return 33;case"lao":return 34;case"lower-armenian":return 35;case"malayalam":return 36;case"mongolian":return 37;case"myanmar":return 38;case"oriya":return 39;case"persian":return 40;case"simp-chinese-formal":return 41;case"simp-chinese-informal":return 42;case"tamil":return 43;case"telugu":return 44;case"thai":return 45;case"tibetan":return 46;case"trad-chinese-formal":return 47;case"trad-chinese-informal":return 48;case"upper-armenian":return 49;case"disclosure-open":return 50;case"disclosure-closed":return 51;case"none":default:return-1}}},tm=function(s){return{name:"margin-"+s,initialValue:"0",prefix:!1,type:4}},KB=tm("top"),GB=tm("right"),zB=tm("bottom"),WB=tm("left"),qB={name:"overflow",initialValue:"visible",prefix:!1,type:1,parse:function(s,e){return e.filter(Os).map(function(r){switch(r.value){case"hidden":return 1;case"scroll":return 2;case"clip":return 3;case"auto":return 4;case"visible":default:return 0}})}},JB={name:"overflow-wrap",initialValue:"normal",prefix:!1,type:2,parse:function(s,e){switch(e){case"break-word":return"break-word";case"normal":default:return"normal"}}},sm=function(s){return{name:"padding-"+s,initialValue:"0",prefix:!1,type:3,format:"length-percentage"}},YB=sm("top"),XB=sm("right"),ZB=sm("bottom"),eS=sm("left"),tS={name:"text-align",initialValue:"left",prefix:!1,type:2,parse:function(s,e){switch(e){case"right":return 2;case"center":case"justify":return 1;case"left":default:return 0}}},sS={name:"position",initialValue:"static",prefix:!1,type:2,parse:function(s,e){switch(e){case"relative":return 1;case"absolute":return 2;case"fixed":return 3;case"sticky":return 4}return 0}},rS={name:"text-shadow",initialValue:"none",type:1,prefix:!1,parse:function(s,e){return e.length===1&&Wh(e[0],"none")?[]:ki(e).map(function(r){for(var a={color:Wi.TRANSPARENT,offsetX:da,offsetY:da,blur:da},n=0,i=0;i<r.length;i++){var o=r[i];Uo(o)?(n===0?a.offsetX=o:n===1?a.offsetY=o:a.blur=o,n++):a.color=To.parse(s,o)}return a})}},aS={name:"text-transform",initialValue:"none",prefix:!1,type:2,parse:function(s,e){switch(e){case"uppercase":return 2;case"lowercase":return 1;case"capitalize":return 3}return 0}},nS={name:"transform",initialValue:"none",prefix:!0,type:0,parse:function(s,e){if(e.type===20&&e.value==="none")return null;if(e.type===18){var r=lS[e.name];if(typeof r>"u")throw new Error('Attempting to parse an unsupported transform function "'+e.name+'"');return r(e.values)}return null}},iS=function(s){var e=s.filter(function(r){return r.type===17}).map(function(r){return r.number});return e.length===6?e:null},oS=function(s){var e=s.filter(function(c){return c.type===17}).map(function(c){return c.number}),r=e[0],a=e[1];e[2],e[3];var n=e[4],i=e[5];e[6],e[7],e[8],e[9],e[10],e[11];var o=e[12],l=e[13];return e[14],e[15],e.length===16?[r,a,n,i,o,l]:null},lS={matrix:iS,matrix3d:oS},bf={type:16,number:50,flags:jA},cS=[bf,bf],AS={name:"transform-origin",initialValue:"50% 50%",prefix:!0,type:1,parse:function(s,e){var r=e.filter(Pr);return r.length!==2?cS:[r[0],r[1]]}},dS={name:"visible",initialValue:"none",prefix:!1,type:2,parse:function(s,e){switch(e){case"hidden":return 1;case"collapse":return 2;case"visible":default:return 0}}},iA;(function(s){s.NORMAL="normal",s.BREAK_ALL="break-all",s.KEEP_ALL="keep-all"})(iA||(iA={}));var uS={name:"word-break",initialValue:"normal",prefix:!1,type:2,parse:function(s,e){switch(e){case"break-all":return iA.BREAK_ALL;case"keep-all":return iA.KEEP_ALL;case"normal":default:return iA.NORMAL}}},mS={name:"z-index",initialValue:"auto",prefix:!1,type:0,parse:function(s,e){if(e.type===20)return{auto:!0,order:0};if(gc(e))return{auto:!1,order:e.number};throw new Error("Invalid z-index number parsed")}},Ob={name:"time",parse:function(s,e){if(e.type===15)switch(e.unit.toLowerCase()){case"s":return 1e3*e.number;case"ms":return e.number}throw new Error("Unsupported time type")}},hS={name:"opacity",initialValue:"1",type:0,prefix:!1,parse:function(s,e){return gc(e)?e.number:1}},pS={name:"text-decoration-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},gS={name:"text-decoration-line",initialValue:"none",prefix:!1,type:1,parse:function(s,e){return e.filter(Os).map(function(r){switch(r.value){case"underline":return 1;case"overline":return 2;case"line-through":return 3;case"none":return 4}return 0}).filter(function(r){return r!==0})}},fS={name:"font-family",initialValue:"",prefix:!1,type:1,parse:function(s,e){var r=[],a=[];return e.forEach(function(n){switch(n.type){case 20:case 0:r.push(n.value);break;case 17:r.push(n.number.toString());break;case 4:a.push(r.join(" ")),r.length=0;break}}),r.length&&a.push(r.join(" ")),a.map(function(n){return n.indexOf(" ")===-1?n:"'"+n+"'"})}},xS={name:"font-size",initialValue:"0",prefix:!1,type:3,format:"length"},yS={name:"font-weight",initialValue:"normal",type:0,prefix:!1,parse:function(s,e){if(gc(e))return e.number;if(Os(e))switch(e.value){case"bold":return 700;case"normal":default:return 400}return 400}},bS={name:"font-variant",initialValue:"none",type:1,prefix:!1,parse:function(s,e){return e.filter(Os).map(function(r){return r.value})}},vS={name:"font-style",initialValue:"normal",prefix:!1,type:2,parse:function(s,e){switch(e){case"oblique":return"oblique";case"italic":return"italic";case"normal":default:return"normal"}}},Hr=function(s,e){return(s&e)!==0},wS={name:"content",initialValue:"none",type:1,prefix:!1,parse:function(s,e){if(e.length===0)return[];var r=e[0];return r.type===20&&r.value==="none"?[]:e}},CS={name:"counter-increment",initialValue:"none",prefix:!0,type:1,parse:function(s,e){if(e.length===0)return null;var r=e[0];if(r.type===20&&r.value==="none")return null;for(var a=[],n=e.filter(Nb),i=0;i<n.length;i++){var o=n[i],l=n[i+1];if(o.type===20){var c=l&&gc(l)?l.number:1;a.push({counter:o.value,increment:c})}}return a}},NS={name:"counter-reset",initialValue:"none",prefix:!0,type:1,parse:function(s,e){if(e.length===0)return[];for(var r=[],a=e.filter(Nb),n=0;n<a.length;n++){var i=a[n],o=a[n+1];if(Os(i)&&i.value!=="none"){var l=o&&gc(o)?o.number:0;r.push({counter:i.value,reset:l})}}return r}},BS={name:"duration",initialValue:"0s",prefix:!1,type:1,parse:function(s,e){return e.filter(EA).map(function(r){return Ob.parse(s,r)})}},SS={name:"quotes",initialValue:"none",prefix:!0,type:1,parse:function(s,e){if(e.length===0)return null;var r=e[0];if(r.type===20&&r.value==="none")return null;var a=[],n=e.filter(XN);if(n.length%2!==0)return null;for(var i=0;i<n.length;i+=2){var o=n[i].value,l=n[i+1].value;a.push({open:o,close:l})}return a}},vf=function(s,e,r){if(!s)return"";var a=s[Math.min(e,s.length-1)];return a?r?a.open:a.close:""},jS={name:"box-shadow",initialValue:"none",type:1,prefix:!1,parse:function(s,e){return e.length===1&&Wh(e[0],"none")?[]:ki(e).map(function(r){for(var a={color:255,offsetX:da,offsetY:da,blur:da,spread:da,inset:!1},n=0,i=0;i<r.length;i++){var o=r[i];Wh(o,"inset")?a.inset=!0:Uo(o)?(n===0?a.offsetX=o:n===1?a.offsetY=o:n===2?a.blur=o:a.spread=o,n++):a.color=To.parse(s,o)}return a})}},ES={name:"paint-order",initialValue:"normal",prefix:!1,type:1,parse:function(s,e){var r=[0,1,2],a=[];return e.filter(Os).forEach(function(n){switch(n.value){case"stroke":a.push(1);break;case"fill":a.push(0);break;case"markers":a.push(2);break}}),r.forEach(function(n){a.indexOf(n)===-1&&a.push(n)}),a}},kS={name:"-webkit-text-stroke-color",initialValue:"currentcolor",prefix:!1,type:3,format:"color"},IS={name:"-webkit-text-stroke-width",initialValue:"0",type:0,prefix:!1,parse:function(s,e){return EA(e)?e.number:0}},TS=function(){function s(e,r){var a,n;this.animationDuration=Ct(e,BS,r.animationDuration),this.backgroundClip=Ct(e,tB,r.backgroundClip),this.backgroundColor=Ct(e,sB,r.backgroundColor),this.backgroundImage=Ct(e,uB,r.backgroundImage),this.backgroundOrigin=Ct(e,mB,r.backgroundOrigin),this.backgroundPosition=Ct(e,hB,r.backgroundPosition),this.backgroundRepeat=Ct(e,pB,r.backgroundRepeat),this.backgroundSize=Ct(e,fB,r.backgroundSize),this.borderTopColor=Ct(e,yB,r.borderTopColor),this.borderRightColor=Ct(e,bB,r.borderRightColor),this.borderBottomColor=Ct(e,vB,r.borderBottomColor),this.borderLeftColor=Ct(e,wB,r.borderLeftColor),this.borderTopLeftRadius=Ct(e,CB,r.borderTopLeftRadius),this.borderTopRightRadius=Ct(e,NB,r.borderTopRightRadius),this.borderBottomRightRadius=Ct(e,BB,r.borderBottomRightRadius),this.borderBottomLeftRadius=Ct(e,SB,r.borderBottomLeftRadius),this.borderTopStyle=Ct(e,jB,r.borderTopStyle),this.borderRightStyle=Ct(e,EB,r.borderRightStyle),this.borderBottomStyle=Ct(e,kB,r.borderBottomStyle),this.borderLeftStyle=Ct(e,IB,r.borderLeftStyle),this.borderTopWidth=Ct(e,TB,r.borderTopWidth),this.borderRightWidth=Ct(e,FB,r.borderRightWidth),this.borderBottomWidth=Ct(e,PB,r.borderBottomWidth),this.borderLeftWidth=Ct(e,UB,r.borderLeftWidth),this.boxShadow=Ct(e,jS,r.boxShadow),this.color=Ct(e,LB,r.color),this.direction=Ct(e,DB,r.direction),this.display=Ct(e,RB,r.display),this.float=Ct(e,_B,r.cssFloat),this.fontFamily=Ct(e,fS,r.fontFamily),this.fontSize=Ct(e,xS,r.fontSize),this.fontStyle=Ct(e,vS,r.fontStyle),this.fontVariant=Ct(e,bS,r.fontVariant),this.fontWeight=Ct(e,yS,r.fontWeight),this.letterSpacing=Ct(e,QB,r.letterSpacing),this.lineBreak=Ct(e,OB,r.lineBreak),this.lineHeight=Ct(e,HB,r.lineHeight),this.listStyleImage=Ct(e,VB,r.listStyleImage),this.listStylePosition=Ct(e,$B,r.listStylePosition),this.listStyleType=Ct(e,qh,r.listStyleType),this.marginTop=Ct(e,KB,r.marginTop),this.marginRight=Ct(e,GB,r.marginRight),this.marginBottom=Ct(e,zB,r.marginBottom),this.marginLeft=Ct(e,WB,r.marginLeft),this.opacity=Ct(e,hS,r.opacity);var i=Ct(e,qB,r.overflow);this.overflowX=i[0],this.overflowY=i[i.length>1?1:0],this.overflowWrap=Ct(e,JB,r.overflowWrap),this.paddingTop=Ct(e,YB,r.paddingTop),this.paddingRight=Ct(e,XB,r.paddingRight),this.paddingBottom=Ct(e,ZB,r.paddingBottom),this.paddingLeft=Ct(e,eS,r.paddingLeft),this.paintOrder=Ct(e,ES,r.paintOrder),this.position=Ct(e,sS,r.position),this.textAlign=Ct(e,tS,r.textAlign),this.textDecorationColor=Ct(e,pS,(a=r.textDecorationColor)!==null&&a!==void 0?a:r.color),this.textDecorationLine=Ct(e,gS,(n=r.textDecorationLine)!==null&&n!==void 0?n:r.textDecoration),this.textShadow=Ct(e,rS,r.textShadow),this.textTransform=Ct(e,aS,r.textTransform),this.transform=Ct(e,nS,r.transform),this.transformOrigin=Ct(e,AS,r.transformOrigin),this.visibility=Ct(e,dS,r.visibility),this.webkitTextStrokeColor=Ct(e,kS,r.webkitTextStrokeColor),this.webkitTextStrokeWidth=Ct(e,IS,r.webkitTextStrokeWidth),this.wordBreak=Ct(e,uS,r.wordBreak),this.zIndex=Ct(e,mS,r.zIndex)}return s.prototype.isVisible=function(){return this.display>0&&this.opacity>0&&this.visibility===0},s.prototype.isTransparent=function(){return Fo(this.backgroundColor)},s.prototype.isTransformed=function(){return this.transform!==null},s.prototype.isPositioned=function(){return this.position!==0},s.prototype.isPositionedWithZIndex=function(){return this.isPositioned()&&!this.zIndex.auto},s.prototype.isFloating=function(){return this.float!==0},s.prototype.isInlineLevel=function(){return Hr(this.display,4)||Hr(this.display,33554432)||Hr(this.display,268435456)||Hr(this.display,536870912)||Hr(this.display,67108864)||Hr(this.display,134217728)},s}(),FS=function(){function s(e,r){this.content=Ct(e,wS,r.content),this.quotes=Ct(e,SS,r.quotes)}return s}(),wf=function(){function s(e,r){this.counterIncrement=Ct(e,CS,r.counterIncrement),this.counterReset=Ct(e,NS,r.counterReset)}return s}(),Ct=function(s,e,r){var a=new wb,n=r!==null&&typeof r<"u"?r.toString():e.initialValue;a.write(n);var i=new Cb(a.read());switch(e.type){case 2:var o=i.parseComponentValue();return e.parse(s,Os(o)?o.value:e.initialValue);case 0:return e.parse(s,i.parseComponentValue());case 1:return e.parse(s,i.parseComponentValues());case 4:return i.parseComponentValue();case 3:switch(e.format){case"angle":return qu.parse(s,i.parseComponentValue());case"color":return To.parse(s,i.parseComponentValue());case"image":return Fp.parse(s,i.parseComponentValue());case"length":var l=i.parseComponentValue();return Uo(l)?l:da;case"length-percentage":var c=i.parseComponentValue();return Pr(c)?c:da;case"time":return Ob.parse(s,i.parseComponentValue())}break}},PS="data-html2canvas-debug",US=function(s){var e=s.getAttribute(PS);switch(e){case"all":return 1;case"clone":return 2;case"parse":return 3;case"render":return 4;default:return 0}},Jh=function(s,e){var r=US(s);return r===1||e===r},Ii=function(){function s(e,r){if(this.context=e,this.textNodes=[],this.elements=[],this.flags=0,Jh(r,3))debugger;this.styles=new TS(e,window.getComputedStyle(r,null)),Zh(r)&&(this.styles.animationDuration.some(function(a){return a>0})&&(r.style.animationDuration="0s"),this.styles.transform!==null&&(r.style.transform="none")),this.bounds=zu(this.context,r),Jh(r,4)&&(this.flags|=16)}return s}(),LS="AAAAAAAAAAAAEA4AGBkAAFAaAAACAAAAAAAIABAAGAAwADgACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAAQABIAEQATAAIABAACAAQAAgAEAAIABAAVABcAAgAEAAIABAACAAQAGAAaABwAHgAgACIAI4AlgAIABAAmwCjAKgAsAC2AL4AvQDFAMoA0gBPAVYBWgEIAAgACACMANoAYgFkAWwBdAF8AX0BhQGNAZUBlgGeAaMBlQGWAasBswF8AbsBwwF0AcsBYwHTAQgA2wG/AOMBdAF8AekB8QF0AfkB+wHiAHQBfAEIAAMC5gQIAAsCEgIIAAgAFgIeAggAIgIpAggAMQI5AkACygEIAAgASAJQAlgCYAIIAAgACAAKBQoFCgUTBRMFGQUrBSsFCAAIAAgACAAIAAgACAAIAAgACABdAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABoAmgCrwGvAQgAbgJ2AggAHgEIAAgACADnAXsCCAAIAAgAgwIIAAgACAAIAAgACACKAggAkQKZAggAPADJAAgAoQKkAqwCsgK6AsICCADJAggA0AIIAAgACAAIANYC3gIIAAgACAAIAAgACABAAOYCCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAkASoB+QIEAAgACAA8AEMCCABCBQgACABJBVAFCAAIAAgACAAIAAgACAAIAAgACABTBVoFCAAIAFoFCABfBWUFCAAIAAgACAAIAAgAbQUIAAgACAAIAAgACABzBXsFfQWFBYoFigWKBZEFigWKBYoFmAWfBaYFrgWxBbkFCAAIAAgACAAIAAgACAAIAAgACAAIAMEFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAMgFCADQBQgACAAIAAgACAAIAAgACAAIAAgACAAIAO4CCAAIAAgAiQAIAAgACABAAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAD0AggACAD8AggACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIANYFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAMDvwAIAAgAJAIIAAgACAAIAAgACAAIAAgACwMTAwgACAB9BOsEGwMjAwgAKwMyAwsFYgE3A/MEPwMIAEUDTQNRAwgAWQOsAGEDCAAIAAgACAAIAAgACABpAzQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFIQUoBSwFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABtAwgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABMAEwACAAIAAgACAAIABgACAAIAAgACAC/AAgACAAyAQgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACAAIAAwAAgACAAIAAgACAAIAAgACAAIAAAARABIAAgACAAIABQASAAIAAgAIABwAEAAjgCIABsAqAC2AL0AigDQAtwC+IJIQqVAZUBWQqVAZUBlQGVAZUBlQGrC5UBlQGVAZUBlQGVAZUBlQGVAXsKlQGVAbAK6wsrDGUMpQzlDJUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAfAKAAuZA64AtwCJALoC6ADwAAgAuACgA/oEpgO6AqsD+AAIAAgAswMIAAgACAAIAIkAuwP5AfsBwwPLAwgACAAIAAgACADRA9kDCAAIAOED6QMIAAgACAAIAAgACADuA/YDCAAIAP4DyQAIAAgABgQIAAgAXQAOBAgACAAIAAgACAAIABMECAAIAAgACAAIAAgACAD8AAQBCAAIAAgAGgQiBCoECAExBAgAEAEIAAgACAAIAAgACAAIAAgACAAIAAgACAA4BAgACABABEYECAAIAAgATAQYAQgAVAQIAAgACAAIAAgACAAIAAgACAAIAFoECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAOQEIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAB+BAcACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAEABhgSMBAgACAAIAAgAlAQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAwAEAAQABAADAAMAAwADAAQABAAEAAQABAAEAAQABHATAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAdQMIAAgACAAIAAgACAAIAMkACAAIAAgAfQMIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACFA4kDCAAIAAgACAAIAOcBCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAIcDCAAIAAgACAAIAAgACAAIAAgACAAIAJEDCAAIAAgACADFAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABgBAgAZgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAbAQCBXIECAAIAHkECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABAAJwEQACjBKoEsgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAC6BMIECAAIAAgACAAIAAgACABmBAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAxwQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAGYECAAIAAgAzgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBd0FXwUIAOIF6gXxBYoF3gT5BQAGCAaKBYoFigWKBYoFigWKBYoFigWKBYoFigXWBIoFigWKBYoFigWKBYoFigWKBYsFEAaKBYoFigWKBYoFigWKBRQGCACKBYoFigWKBQgACAAIANEECAAIABgGigUgBggAJgYIAC4GMwaKBYoF0wQ3Bj4GigWKBYoFigWKBYoFigWKBYoFigWKBYoFigUIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWLBf///////wQABAAEAAQABAAEAAQABAAEAAQAAwAEAAQAAgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAQADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUAAAAFAAUAAAAFAAUAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAQAAAAUABQAFAAUABQAFAAAAAAAFAAUAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAFAAUAAQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAAABwAHAAcAAAAHAAcABwAFAAEAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAcABwAFAAUAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAAAAQABAAAAAAAAAAAAAAAFAAUABQAFAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAHAAcAAAAHAAcAAAAAAAUABQAHAAUAAQAHAAEABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwABAAUABQAFAAUAAAAAAAAAAAAAAAEAAQABAAEAAQABAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABQANAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAABQAHAAUABQAFAAAAAAAAAAcABQAFAAUABQAFAAQABAAEAAQABAAEAAQABAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUAAAAFAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAUAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAcABwAFAAcABwAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUABwAHAAUABQAFAAUAAAAAAAcABwAAAAAABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAAAAAAAAAAABQAFAAAAAAAFAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAFAAUABQAFAAUAAAAFAAUABwAAAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABwAFAAUABQAFAAAAAAAHAAcAAAAAAAcABwAFAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAAAAAAAAAHAAcABwAAAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAUABQAFAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAHAAcABQAHAAcAAAAFAAcABwAAAAcABwAFAAUAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAFAAcABwAFAAUABQAAAAUAAAAHAAcABwAHAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAHAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUAAAAFAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAUAAAAFAAUAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABwAFAAUABQAFAAUABQAAAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABQAFAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAFAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAHAAUABQAFAAUABQAFAAUABwAHAAcABwAHAAcABwAHAAUABwAHAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABwAHAAcABwAFAAUABwAHAAcAAAAAAAAAAAAHAAcABQAHAAcABwAHAAcABwAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAUABQAFAAUABQAFAAUAAAAFAAAABQAAAAAABQAFAAUABQAFAAUABQAFAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAUABQAFAAUABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABwAFAAcABwAHAAcABwAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAUABQAFAAUABwAHAAUABQAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABQAFAAcABwAHAAUABwAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAcABQAFAAUABQAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAAAAAABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAAAAAAAAAFAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAUABQAHAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAFAAUABQAFAAcABwAFAAUABwAHAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAcABwAFAAUABwAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABQAAAAAABQAFAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAcABwAAAAAAAAAAAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAcABwAFAAcABwAAAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAFAAUABQAAAAUABQAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABwAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAHAAcABQAHAAUABQAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAAABwAHAAAAAAAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAFAAUABwAFAAcABwAFAAcABQAFAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAAAAAABwAHAAcABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAFAAcABwAFAAUABQAFAAUABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAUABQAFAAcABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABQAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAAAAAAFAAUABwAHAAcABwAFAAAAAAAAAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAHAAUABQAFAAUABQAFAAUABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAABQAAAAUABQAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAHAAcAAAAFAAUAAAAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABQAFAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAABQAFAAUABQAFAAUABQAAAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAFAAUABQAFAAUADgAOAA4ADgAOAA4ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAMAAwADAAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkAAAAAAAAAAAAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAAAAAAAAAAAAsADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwACwAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAADgAOAA4AAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAAAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4AAAAOAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAAAAAAAAAAAA4AAAAOAAAAAAAAAAAADgAOAA4AAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAA=",Cf="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Xc=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var fd=0;fd<Cf.length;fd++)Xc[Cf.charCodeAt(fd)]=fd;var DS=function(s){var e=s.length*.75,r=s.length,a,n=0,i,o,l,c;s[s.length-1]==="="&&(e--,s[s.length-2]==="="&&e--);var A=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u"&&typeof Uint8Array.prototype.slice<"u"?new ArrayBuffer(e):new Array(e),d=Array.isArray(A)?A:new Uint8Array(A);for(a=0;a<r;a+=4)i=Xc[s.charCodeAt(a)],o=Xc[s.charCodeAt(a+1)],l=Xc[s.charCodeAt(a+2)],c=Xc[s.charCodeAt(a+3)],d[n++]=i<<2|o>>4,d[n++]=(o&15)<<4|l>>2,d[n++]=(l&3)<<6|c&63;return A},RS=function(s){for(var e=s.length,r=[],a=0;a<e;a+=2)r.push(s[a+1]<<8|s[a]);return r},MS=function(s){for(var e=s.length,r=[],a=0;a<e;a+=4)r.push(s[a+3]<<24|s[a+2]<<16|s[a+1]<<8|s[a]);return r},al=5,Pp=11,Mm=2,_S=Pp-al,Hb=65536>>al,QS=1<<al,_m=QS-1,OS=1024>>al,HS=Hb+OS,VS=HS,$S=32,KS=VS+$S,GS=65536>>Pp,zS=1<<_S,WS=zS-1,Nf=function(s,e,r){return s.slice?s.slice(e,r):new Uint16Array(Array.prototype.slice.call(s,e,r))},qS=function(s,e,r){return s.slice?s.slice(e,r):new Uint32Array(Array.prototype.slice.call(s,e,r))},JS=function(s,e){var r=DS(s),a=Array.isArray(r)?MS(r):new Uint32Array(r),n=Array.isArray(r)?RS(r):new Uint16Array(r),i=24,o=Nf(n,i/2,a[4]/2),l=a[5]===2?Nf(n,(i+a[4])/2):qS(a,Math.ceil((i+a[4])/4));return new YS(a[0],a[1],a[2],a[3],o,l)},YS=function(){function s(e,r,a,n,i,o){this.initialValue=e,this.errorValue=r,this.highStart=a,this.highValueIndex=n,this.index=i,this.data=o}return s.prototype.get=function(e){var r;if(e>=0){if(e<55296||e>56319&&e<=65535)return r=this.index[e>>al],r=(r<<Mm)+(e&_m),this.data[r];if(e<=65535)return r=this.index[Hb+(e-55296>>al)],r=(r<<Mm)+(e&_m),this.data[r];if(e<this.highStart)return r=KS-GS+(e>>Pp),r=this.index[r],r+=e>>al&WS,r=this.index[r],r=(r<<Mm)+(e&_m),this.data[r];if(e<=1114111)return this.data[this.highValueIndex]}return this.errorValue},s}(),Bf="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",XS=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var xd=0;xd<Bf.length;xd++)XS[Bf.charCodeAt(xd)]=xd;var ZS=1,Qm=2,Om=3,Sf=4,jf=5,ej=7,Ef=8,Hm=9,Vm=10,kf=11,If=12,Tf=13,Ff=14,$m=15,tj=function(s){for(var e=[],r=0,a=s.length;r<a;){var n=s.charCodeAt(r++);if(n>=55296&&n<=56319&&r<a){var i=s.charCodeAt(r++);(i&64512)===56320?e.push(((n&1023)<<10)+(i&1023)+65536):(e.push(n),r--)}else e.push(n)}return e},sj=function(){for(var s=[],e=0;e<arguments.length;e++)s[e]=arguments[e];if(String.fromCodePoint)return String.fromCodePoint.apply(String,s);var r=s.length;if(!r)return"";for(var a=[],n=-1,i="";++n<r;){var o=s[n];o<=65535?a.push(o):(o-=65536,a.push((o>>10)+55296,o%1024+56320)),(n+1===r||a.length>16384)&&(i+=String.fromCharCode.apply(String,a),a.length=0)}return i},rj=JS(LS),Tn="√ó",Km="√∑",aj=function(s){return rj.get(s)},nj=function(s,e,r){var a=r-2,n=e[a],i=e[r-1],o=e[r];if(i===Qm&&o===Om)return Tn;if(i===Qm||i===Om||i===Sf||o===Qm||o===Om||o===Sf)return Km;if(i===Ef&&[Ef,Hm,kf,If].indexOf(o)!==-1||(i===kf||i===Hm)&&(o===Hm||o===Vm)||(i===If||i===Vm)&&o===Vm||o===Tf||o===jf||o===ej||i===ZS)return Tn;if(i===Tf&&o===Ff){for(;n===jf;)n=e[--a];if(n===Ff)return Tn}if(i===$m&&o===$m){for(var l=0;n===$m;)l++,n=e[--a];if(l%2===0)return Tn}return Km},ij=function(s){var e=tj(s),r=e.length,a=0,n=0,i=e.map(aj);return{next:function(){if(a>=r)return{done:!0,value:null};for(var o=Tn;a<r&&(o=nj(e,i,++a))===Tn;);if(o!==Tn||a===r){var l=sj.apply(null,e.slice(n,a));return n=a,{value:l,done:!1}}return{done:!0,value:null}}}},oj=function(s){for(var e=ij(s),r=[],a;!(a=e.next()).done;)a.value&&r.push(a.value.slice());return r},lj=function(s){var e=123;if(s.createRange){var r=s.createRange();if(r.getBoundingClientRect){var a=s.createElement("boundtest");a.style.height=e+"px",a.style.display="block",s.body.appendChild(a),r.selectNode(a);var n=r.getBoundingClientRect(),i=Math.round(n.height);if(s.body.removeChild(a),i===e)return!0}}return!1},cj=function(s){var e=s.createElement("boundtest");e.style.width="50px",e.style.display="block",e.style.fontSize="12px",e.style.letterSpacing="0px",e.style.wordSpacing="0px",s.body.appendChild(e);var r=s.createRange();e.innerHTML=typeof"".repeat=="function"?"&#128104;".repeat(10):"";var a=e.firstChild,n=Wu(a.data).map(function(c){return Br(c)}),i=0,o={},l=n.every(function(c,A){r.setStart(a,i),r.setEnd(a,i+c.length);var d=r.getBoundingClientRect();i+=c.length;var h=d.x>o.x||d.y>o.y;return o=d,A===0?!0:h});return s.body.removeChild(e),l},Aj=function(){return typeof new Image().crossOrigin<"u"},dj=function(){return typeof new XMLHttpRequest().responseType=="string"},uj=function(s){var e=new Image,r=s.createElement("canvas"),a=r.getContext("2d");if(!a)return!1;e.src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'></svg>";try{a.drawImage(e,0,0),r.toDataURL()}catch{return!1}return!0},Pf=function(s){return s[0]===0&&s[1]===255&&s[2]===0&&s[3]===255},mj=function(s){var e=s.createElement("canvas"),r=100;e.width=r,e.height=r;var a=e.getContext("2d");if(!a)return Promise.reject(!1);a.fillStyle="rgb(0, 255, 0)",a.fillRect(0,0,r,r);var n=new Image,i=e.toDataURL();n.src=i;var o=Yh(r,r,0,0,n);return a.fillStyle="red",a.fillRect(0,0,r,r),Uf(o).then(function(l){a.drawImage(l,0,0);var c=a.getImageData(0,0,r,r).data;a.fillStyle="red",a.fillRect(0,0,r,r);var A=s.createElement("div");return A.style.backgroundImage="url("+i+")",A.style.height=r+"px",Pf(c)?Uf(Yh(r,r,0,0,A)):Promise.reject(!1)}).then(function(l){return a.drawImage(l,0,0),Pf(a.getImageData(0,0,r,r).data)}).catch(function(){return!1})},Yh=function(s,e,r,a,n){var i="http://www.w3.org/2000/svg",o=document.createElementNS(i,"svg"),l=document.createElementNS(i,"foreignObject");return o.setAttributeNS(null,"width",s.toString()),o.setAttributeNS(null,"height",e.toString()),l.setAttributeNS(null,"width","100%"),l.setAttributeNS(null,"height","100%"),l.setAttributeNS(null,"x",r.toString()),l.setAttributeNS(null,"y",a.toString()),l.setAttributeNS(null,"externalResourcesRequired","true"),o.appendChild(l),l.appendChild(n),o},Uf=function(s){return new Promise(function(e,r){var a=new Image;a.onload=function(){return e(a)},a.onerror=r,a.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(new XMLSerializer().serializeToString(s))})},Aa={get SUPPORT_RANGE_BOUNDS(){var s=lj(document);return Object.defineProperty(Aa,"SUPPORT_RANGE_BOUNDS",{value:s}),s},get SUPPORT_WORD_BREAKING(){var s=Aa.SUPPORT_RANGE_BOUNDS&&cj(document);return Object.defineProperty(Aa,"SUPPORT_WORD_BREAKING",{value:s}),s},get SUPPORT_SVG_DRAWING(){var s=uj(document);return Object.defineProperty(Aa,"SUPPORT_SVG_DRAWING",{value:s}),s},get SUPPORT_FOREIGNOBJECT_DRAWING(){var s=typeof Array.from=="function"&&typeof window.fetch=="function"?mj(document):Promise.resolve(!1);return Object.defineProperty(Aa,"SUPPORT_FOREIGNOBJECT_DRAWING",{value:s}),s},get SUPPORT_CORS_IMAGES(){var s=Aj();return Object.defineProperty(Aa,"SUPPORT_CORS_IMAGES",{value:s}),s},get SUPPORT_RESPONSE_TYPE(){var s=dj();return Object.defineProperty(Aa,"SUPPORT_RESPONSE_TYPE",{value:s}),s},get SUPPORT_CORS_XHR(){var s="withCredentials"in new XMLHttpRequest;return Object.defineProperty(Aa,"SUPPORT_CORS_XHR",{value:s}),s},get SUPPORT_NATIVE_TEXT_SEGMENTATION(){var s=!!(typeof Intl<"u"&&Intl.Segmenter);return Object.defineProperty(Aa,"SUPPORT_NATIVE_TEXT_SEGMENTATION",{value:s}),s}},oA=function(){function s(e,r){this.text=e,this.bounds=r}return s}(),hj=function(s,e,r,a){var n=fj(e,r),i=[],o=0;return n.forEach(function(l){if(r.textDecorationLine.length||l.trim().length>0)if(Aa.SUPPORT_RANGE_BOUNDS){var c=Lf(a,o,l.length).getClientRects();if(c.length>1){var A=Up(l),d=0;A.forEach(function(f){i.push(new oA(f,Ji.fromDOMRectList(s,Lf(a,d+o,f.length).getClientRects()))),d+=f.length})}else i.push(new oA(l,Ji.fromDOMRectList(s,c)))}else{var h=a.splitText(l.length);i.push(new oA(l,pj(s,a))),a=h}else Aa.SUPPORT_RANGE_BOUNDS||(a=a.splitText(l.length));o+=l.length}),i},pj=function(s,e){var r=e.ownerDocument;if(r){var a=r.createElement("html2canvaswrapper");a.appendChild(e.cloneNode(!0));var n=e.parentNode;if(n){n.replaceChild(a,e);var i=zu(s,a);return a.firstChild&&n.replaceChild(a.firstChild,a),i}}return Ji.EMPTY},Lf=function(s,e,r){var a=s.ownerDocument;if(!a)throw new Error("Node has no owner document");var n=a.createRange();return n.setStart(s,e),n.setEnd(s,e+r),n},Up=function(s){if(Aa.SUPPORT_NATIVE_TEXT_SEGMENTATION){var e=new Intl.Segmenter(void 0,{granularity:"grapheme"});return Array.from(e.segment(s)).map(function(r){return r.segment})}return oj(s)},gj=function(s,e){if(Aa.SUPPORT_NATIVE_TEXT_SEGMENTATION){var r=new Intl.Segmenter(void 0,{granularity:"word"});return Array.from(r.segment(s)).map(function(a){return a.segment})}return yj(s,e)},fj=function(s,e){return e.letterSpacing!==0?Up(s):gj(s,e)},xj=[32,160,4961,65792,65793,4153,4241],yj=function(s,e){for(var r=G5(s,{lineBreak:e.lineBreak,wordBreak:e.overflowWrap==="break-word"?"break-word":e.wordBreak}),a=[],n,i=function(){if(n.value){var o=n.value.slice(),l=Wu(o),c="";l.forEach(function(A){xj.indexOf(A)===-1?c+=Br(A):(c.length&&a.push(c),a.push(Br(A)),c="")}),c.length&&a.push(c)}};!(n=r.next()).done;)i();return a},bj=function(){function s(e,r,a){this.text=vj(r.data,a.textTransform),this.textBounds=hj(e,this.text,a,r)}return s}(),vj=function(s,e){switch(e){case 1:return s.toLowerCase();case 3:return s.replace(wj,Cj);case 2:return s.toUpperCase();default:return s}},wj=/(^|\s|:|-|\(|\))([a-z])/g,Cj=function(s,e,r){return s.length>0?e+r.toUpperCase():s},Vb=function(s){ai(e,s);function e(r,a){var n=s.call(this,r,a)||this;return n.src=a.currentSrc||a.src,n.intrinsicWidth=a.naturalWidth,n.intrinsicHeight=a.naturalHeight,n.context.cache.addImage(n.src),n}return e}(Ii),$b=function(s){ai(e,s);function e(r,a){var n=s.call(this,r,a)||this;return n.canvas=a,n.intrinsicWidth=a.width,n.intrinsicHeight=a.height,n}return e}(Ii),Kb=function(s){ai(e,s);function e(r,a){var n=s.call(this,r,a)||this,i=new XMLSerializer,o=zu(r,a);return a.setAttribute("width",o.width+"px"),a.setAttribute("height",o.height+"px"),n.svg="data:image/svg+xml,"+encodeURIComponent(i.serializeToString(a)),n.intrinsicWidth=a.width.baseVal.value,n.intrinsicHeight=a.height.baseVal.value,n.context.cache.addImage(n.svg),n}return e}(Ii),Gb=function(s){ai(e,s);function e(r,a){var n=s.call(this,r,a)||this;return n.value=a.value,n}return e}(Ii),Xh=function(s){ai(e,s);function e(r,a){var n=s.call(this,r,a)||this;return n.start=a.start,n.reversed=typeof a.reversed=="boolean"&&a.reversed===!0,n}return e}(Ii),Nj=[{type:15,flags:0,unit:"px",number:3}],Bj=[{type:16,flags:0,number:50}],Sj=function(s){return s.width>s.height?new Ji(s.left+(s.width-s.height)/2,s.top,s.height,s.height):s.width<s.height?new Ji(s.left,s.top+(s.height-s.width)/2,s.width,s.width):s},jj=function(s){var e=s.type===Ej?new Array(s.value.length+1).join("‚Ä¢"):s.value;return e.length===0?s.placeholder||"":e},wu="checkbox",Cu="radio",Ej="password",Df=707406591,Lp=function(s){ai(e,s);function e(r,a){var n=s.call(this,r,a)||this;switch(n.type=a.type.toLowerCase(),n.checked=a.checked,n.value=jj(a),(n.type===wu||n.type===Cu)&&(n.styles.backgroundColor=3739148031,n.styles.borderTopColor=n.styles.borderRightColor=n.styles.borderBottomColor=n.styles.borderLeftColor=2779096575,n.styles.borderTopWidth=n.styles.borderRightWidth=n.styles.borderBottomWidth=n.styles.borderLeftWidth=1,n.styles.borderTopStyle=n.styles.borderRightStyle=n.styles.borderBottomStyle=n.styles.borderLeftStyle=1,n.styles.backgroundClip=[0],n.styles.backgroundOrigin=[0],n.bounds=Sj(n.bounds)),n.type){case wu:n.styles.borderTopRightRadius=n.styles.borderTopLeftRadius=n.styles.borderBottomRightRadius=n.styles.borderBottomLeftRadius=Nj;break;case Cu:n.styles.borderTopRightRadius=n.styles.borderTopLeftRadius=n.styles.borderBottomRightRadius=n.styles.borderBottomLeftRadius=Bj;break}return n}return e}(Ii),zb=function(s){ai(e,s);function e(r,a){var n=s.call(this,r,a)||this,i=a.options[a.selectedIndex||0];return n.value=i&&i.text||"",n}return e}(Ii),Wb=function(s){ai(e,s);function e(r,a){var n=s.call(this,r,a)||this;return n.value=a.value,n}return e}(Ii),qb=function(s){ai(e,s);function e(r,a){var n=s.call(this,r,a)||this;n.src=a.src,n.width=parseInt(a.width,10)||0,n.height=parseInt(a.height,10)||0,n.backgroundColor=n.styles.backgroundColor;try{if(a.contentWindow&&a.contentWindow.document&&a.contentWindow.document.documentElement){n.tree=Yb(r,a.contentWindow.document.documentElement);var i=a.contentWindow.document.documentElement?nA(r,getComputedStyle(a.contentWindow.document.documentElement).backgroundColor):Wi.TRANSPARENT,o=a.contentWindow.document.body?nA(r,getComputedStyle(a.contentWindow.document.body).backgroundColor):Wi.TRANSPARENT;n.backgroundColor=Fo(i)?Fo(o)?n.styles.backgroundColor:o:i}}catch{}return n}return e}(Ii),kj=["OL","UL","MENU"],Yd=function(s,e,r,a){for(var n=e.firstChild,i=void 0;n;n=i)if(i=n.nextSibling,Xb(n)&&n.data.trim().length>0)r.textNodes.push(new bj(s,n,r.styles));else if(Ml(n))if(sv(n)&&n.assignedNodes)n.assignedNodes().forEach(function(l){return Yd(s,l,r,a)});else{var o=Jb(s,n);o.styles.isVisible()&&(Ij(n,o,a)?o.flags|=4:Tj(o.styles)&&(o.flags|=2),kj.indexOf(n.tagName)!==-1&&(o.flags|=8),r.elements.push(o),n.slot,n.shadowRoot?Yd(s,n.shadowRoot,o,a):!Nu(n)&&!Zb(n)&&!Bu(n)&&Yd(s,n,o,a))}},Jb=function(s,e){return ep(e)?new Vb(s,e):ev(e)?new $b(s,e):Zb(e)?new Kb(s,e):Fj(e)?new Gb(s,e):Pj(e)?new Xh(s,e):Uj(e)?new Lp(s,e):Bu(e)?new zb(s,e):Nu(e)?new Wb(s,e):tv(e)?new qb(s,e):new Ii(s,e)},Yb=function(s,e){var r=Jb(s,e);return r.flags|=4,Yd(s,e,r,r),r},Ij=function(s,e,r){return e.styles.isPositionedWithZIndex()||e.styles.opacity<1||e.styles.isTransformed()||Dp(s)&&r.styles.isTransparent()},Tj=function(s){return s.isPositioned()||s.isFloating()},Xb=function(s){return s.nodeType===Node.TEXT_NODE},Ml=function(s){return s.nodeType===Node.ELEMENT_NODE},Zh=function(s){return Ml(s)&&typeof s.style<"u"&&!Xd(s)},Xd=function(s){return typeof s.className=="object"},Fj=function(s){return s.tagName==="LI"},Pj=function(s){return s.tagName==="OL"},Uj=function(s){return s.tagName==="INPUT"},Lj=function(s){return s.tagName==="HTML"},Zb=function(s){return s.tagName==="svg"},Dp=function(s){return s.tagName==="BODY"},ev=function(s){return s.tagName==="CANVAS"},Rf=function(s){return s.tagName==="VIDEO"},ep=function(s){return s.tagName==="IMG"},tv=function(s){return s.tagName==="IFRAME"},Mf=function(s){return s.tagName==="STYLE"},Dj=function(s){return s.tagName==="SCRIPT"},Nu=function(s){return s.tagName==="TEXTAREA"},Bu=function(s){return s.tagName==="SELECT"},sv=function(s){return s.tagName==="SLOT"},_f=function(s){return s.tagName.indexOf("-")>0},Rj=function(){function s(){this.counters={}}return s.prototype.getCounterValue=function(e){var r=this.counters[e];return r&&r.length?r[r.length-1]:1},s.prototype.getCounterValues=function(e){var r=this.counters[e];return r||[]},s.prototype.pop=function(e){var r=this;e.forEach(function(a){return r.counters[a].pop()})},s.prototype.parse=function(e){var r=this,a=e.counterIncrement,n=e.counterReset,i=!0;a!==null&&a.forEach(function(l){var c=r.counters[l.counter];c&&l.increment!==0&&(i=!1,c.length||c.push(1),c[Math.max(0,c.length-1)]+=l.increment)});var o=[];return i&&n.forEach(function(l){var c=r.counters[l.counter];o.push(l.counter),c||(c=r.counters[l.counter]=[]),c.push(l.reset)}),o},s}(),Qf={integers:[1e3,900,500,400,100,90,50,40,10,9,5,4,1],values:["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"]},Of={integers:[9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["’î","’ì","’í","’ë","’ê","’è","’é","’ç","’å","’ã","’ä","’â","’à","’á","’Ü","’Ö","’Ñ","’É","’Ç","’Å","’Ä","‘ø","‘æ","‘Ω","‘º","‘ª","‘∫","‘π","‘∏","‘∑","‘∂","‘µ","‘¥","‘≥","‘≤","‘±"]},Mj={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,400,300,200,100,90,80,70,60,50,40,30,20,19,18,17,16,15,10,9,8,7,6,5,4,3,2,1],values:["◊ô◊≥","◊ò◊≥","◊ó◊≥","◊ñ◊≥","◊ï◊≥","◊î◊≥","◊ì◊≥","◊í◊≥","◊ë◊≥","◊ê◊≥","◊™","◊©","◊®","◊ß","◊¶","◊§","◊¢","◊°","◊†","◊û","◊ú","◊õ","◊ô◊ò","◊ô◊ó","◊ô◊ñ","◊ò◊ñ","◊ò◊ï","◊ô","◊ò","◊ó","◊ñ","◊ï","◊î","◊ì","◊í","◊ë","◊ê"]},_j={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["·Éµ","·É∞","·ÉØ","·É¥","·ÉÆ","·É≠","·É¨","·É´","·É™","·É©","·É®","·Éß","·É¶","·É•","·É§","·É≥","·É¢","·É°","·É†","·Éü","·Éû","·Éù","·É≤","·Éú","·Éõ","·Éö","·Éô","·Éò","·Éó","·É±","·Éñ","·Éï","·Éî","·Éì","·Éí","·Éë","·Éê"]},Nl=function(s,e,r,a,n,i){return s<e||s>r?pA(s,n,i.length>0):a.integers.reduce(function(o,l,c){for(;s>=l;)s-=l,o+=a.values[c];return o},"")+i},rv=function(s,e,r,a){var n="";do r||s--,n=a(s)+n,s/=e;while(s*e>=e);return n},Nr=function(s,e,r,a,n){var i=r-e+1;return(s<0?"-":"")+(rv(Math.abs(s),i,a,function(o){return Br(Math.floor(o%i)+e)})+n)},Qo=function(s,e,r){r===void 0&&(r=". ");var a=e.length;return rv(Math.abs(s),a,!1,function(n){return e[Math.floor(n%a)]})+r},Ul=1,xo=2,yo=4,Zc=8,Oi=function(s,e,r,a,n,i){if(s<-9999||s>9999)return pA(s,4,n.length>0);var o=Math.abs(s),l=n;if(o===0)return e[0]+l;for(var c=0;o>0&&c<=4;c++){var A=o%10;A===0&&Hr(i,Ul)&&l!==""?l=e[A]+l:A>1||A===1&&c===0||A===1&&c===1&&Hr(i,xo)||A===1&&c===1&&Hr(i,yo)&&s>100||A===1&&c>1&&Hr(i,Zc)?l=e[A]+(c>0?r[c-1]:"")+l:A===1&&c>0&&(l=r[c-1]+l),o=Math.floor(o/10)}return(s<0?a:"")+l},Hf="ÂçÅÁôæÂçÉËê¨",Vf="Êãæ‰Ω∞‰ªüËê¨",$f="„Éû„Ç§„Éä„Çπ",Gm="ÎßàÏù¥ÎÑàÏä§",pA=function(s,e,r){var a=r?". ":"",n=r?"„ÄÅ":"",i=r?", ":"",o=r?" ":"";switch(e){case 0:return"‚Ä¢"+o;case 1:return"‚ó¶"+o;case 2:return"‚óæ"+o;case 5:var l=Nr(s,48,57,!0,a);return l.length<4?"0"+l:l;case 4:return Qo(s,"„Äá‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πù",n);case 6:return Nl(s,1,3999,Qf,3,a).toLowerCase();case 7:return Nl(s,1,3999,Qf,3,a);case 8:return Nr(s,945,969,!1,a);case 9:return Nr(s,97,122,!1,a);case 10:return Nr(s,65,90,!1,a);case 11:return Nr(s,1632,1641,!0,a);case 12:case 49:return Nl(s,1,9999,Of,3,a);case 35:return Nl(s,1,9999,Of,3,a).toLowerCase();case 13:return Nr(s,2534,2543,!0,a);case 14:case 30:return Nr(s,6112,6121,!0,a);case 15:return Qo(s,"Â≠ê‰∏ëÂØÖÂçØËæ∞Â∑≥ÂçàÊú™Áî≥ÈÖâÊàå‰∫•",n);case 16:return Qo(s,"Áî≤‰πô‰∏ô‰∏ÅÊàäÂ∑±Â∫öËæõÂ£¨Áô∏",n);case 17:case 48:return Oi(s,"Èõ∂‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πù",Hf,"Ë≤†",n,xo|yo|Zc);case 47:return Oi(s,"Èõ∂Â£πË≤≥ÂèÉËÇÜ‰ºçÈô∏ÊüíÊçåÁéñ",Vf,"Ë≤†",n,Ul|xo|yo|Zc);case 42:return Oi(s,"Èõ∂‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πù",Hf,"Ë¥ü",n,xo|yo|Zc);case 41:return Oi(s,"Èõ∂Â£πË¥∞ÂèÅËÇÜ‰ºçÈôÜÊüíÊçåÁéñ",Vf,"Ë¥ü",n,Ul|xo|yo|Zc);case 26:return Oi(s,"„Äá‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πù","ÂçÅÁôæÂçÉ‰∏á",$f,n,0);case 25:return Oi(s,"Èõ∂Â£±ÂºêÂèÇÂõõ‰ºçÂÖ≠‰∏ÉÂÖ´‰πù","ÊãæÁôæÂçÉ‰∏á",$f,n,Ul|xo|yo);case 31:return Oi(s,"ÏòÅÏùºÏù¥ÏÇºÏÇ¨Ïò§Ïú°Ïπ†ÌåîÍµ¨","Ïã≠Î∞±Ï≤úÎßå",Gm,i,Ul|xo|yo);case 33:return Oi(s,"Èõ∂‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πù","ÂçÅÁôæÂçÉËê¨",Gm,i,0);case 32:return Oi(s,"Èõ∂Â£πË≤≥ÂèÉÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πù","ÊãæÁôæÂçÉ",Gm,i,Ul|xo|yo);case 18:return Nr(s,2406,2415,!0,a);case 20:return Nl(s,1,19999,_j,3,a);case 21:return Nr(s,2790,2799,!0,a);case 22:return Nr(s,2662,2671,!0,a);case 22:return Nl(s,1,10999,Mj,3,a);case 23:return Qo(s,"„ÅÇ„ÅÑ„ÅÜ„Åà„Åä„Åã„Åç„Åè„Åë„Åì„Åï„Åó„Åô„Åõ„Åù„Åü„Å°„Å§„Å¶„Å®„Å™„Å´„Å¨„Å≠„ÅÆ„ÅØ„Å≤„Åµ„Å∏„Åª„Åæ„Åø„ÇÄ„ÇÅ„ÇÇ„ÇÑ„ÇÜ„Çà„Çâ„Çä„Çã„Çå„Çç„Çè„Çê„Çë„Çí„Çì");case 24:return Qo(s,"„ÅÑ„Çç„ÅØ„Å´„Åª„Å∏„Å®„Å°„Çä„Å¨„Çã„Çí„Çè„Åã„Çà„Åü„Çå„Åù„Å§„Å≠„Å™„Çâ„ÇÄ„ÅÜ„Çê„ÅÆ„Åä„Åè„ÇÑ„Åæ„Åë„Åµ„Åì„Åà„Å¶„ÅÇ„Åï„Åç„ÇÜ„ÇÅ„Åø„Åó„Çë„Å≤„ÇÇ„Åõ„Åô");case 27:return Nr(s,3302,3311,!0,a);case 28:return Qo(s,"„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É∞„É±„É≤„É≥",n);case 29:return Qo(s,"„Ç§„É≠„Éè„Éã„Éõ„Éò„Éà„ÉÅ„É™„Éå„É´„É≤„ÉØ„Ç´„É®„Çø„É¨„ÇΩ„ÉÑ„Éç„Éä„É©„É†„Ç¶„É∞„Éé„Ç™„ÇØ„É§„Éû„Ç±„Éï„Ç≥„Ç®„ÉÜ„Ç¢„Çµ„Ç≠„É¶„É°„Éü„Ç∑„É±„Éí„É¢„Çª„Çπ",n);case 34:return Nr(s,3792,3801,!0,a);case 37:return Nr(s,6160,6169,!0,a);case 38:return Nr(s,4160,4169,!0,a);case 39:return Nr(s,2918,2927,!0,a);case 40:return Nr(s,1776,1785,!0,a);case 43:return Nr(s,3046,3055,!0,a);case 44:return Nr(s,3174,3183,!0,a);case 45:return Nr(s,3664,3673,!0,a);case 46:return Nr(s,3872,3881,!0,a);case 3:default:return Nr(s,48,57,!0,a)}},av="data-html2canvas-ignore",Kf=function(){function s(e,r,a){if(this.context=e,this.options=a,this.scrolledElements=[],this.referenceElement=r,this.counters=new Rj,this.quoteDepth=0,!r.ownerDocument)throw new Error("Cloned element does not have an owner document");this.documentElement=this.cloneNode(r.ownerDocument.documentElement,!1)}return s.prototype.toIFrame=function(e,r){var a=this,n=Qj(e,r);if(!n.contentWindow)return Promise.reject("Unable to find iframe window");var i=e.defaultView.pageXOffset,o=e.defaultView.pageYOffset,l=n.contentWindow,c=l.document,A=Vj(n).then(function(){return La(a,void 0,void 0,function(){var d,h;return Ca(this,function(f){switch(f.label){case 0:return this.scrolledElements.forEach(zj),l&&(l.scrollTo(r.left,r.top),/(iPad|iPhone|iPod)/g.test(navigator.userAgent)&&(l.scrollY!==r.top||l.scrollX!==r.left)&&(this.context.logger.warn("Unable to restore scroll position for cloned document"),this.context.windowBounds=this.context.windowBounds.add(l.scrollX-r.left,l.scrollY-r.top,0,0))),d=this.options.onclone,h=this.clonedReferenceElement,typeof h>"u"?[2,Promise.reject("Error finding the "+this.referenceElement.nodeName+" in the cloned document")]:c.fonts&&c.fonts.ready?[4,c.fonts.ready]:[3,2];case 1:f.sent(),f.label=2;case 2:return/(AppleWebKit)/g.test(navigator.userAgent)?[4,Hj(c)]:[3,4];case 3:f.sent(),f.label=4;case 4:return typeof d=="function"?[2,Promise.resolve().then(function(){return d(c,h)}).then(function(){return n})]:[2,n]}})})});return c.open(),c.write(Kj(document.doctype)+"<html></html>"),Gj(this.referenceElement.ownerDocument,i,o),c.replaceChild(c.adoptNode(this.documentElement),c.documentElement),c.close(),A},s.prototype.createElementClone=function(e){if(Jh(e,2))debugger;if(ev(e))return this.createCanvasClone(e);if(Rf(e))return this.createVideoClone(e);if(Mf(e))return this.createStyleClone(e);var r=e.cloneNode(!1);return ep(r)&&(ep(e)&&e.currentSrc&&e.currentSrc!==e.src&&(r.src=e.currentSrc,r.srcset=""),r.loading==="lazy"&&(r.loading="eager")),_f(r)?this.createCustomElementClone(r):r},s.prototype.createCustomElementClone=function(e){var r=document.createElement("html2canvascustomelement");return zm(e.style,r),r},s.prototype.createStyleClone=function(e){try{var r=e.sheet;if(r&&r.cssRules){var a=[].slice.call(r.cssRules,0).reduce(function(i,o){return o&&typeof o.cssText=="string"?i+o.cssText:i},""),n=e.cloneNode(!1);return n.textContent=a,n}}catch(i){if(this.context.logger.error("Unable to access cssRules property",i),i.name!=="SecurityError")throw i}return e.cloneNode(!1)},s.prototype.createCanvasClone=function(e){var r;if(this.options.inlineImages&&e.ownerDocument){var a=e.ownerDocument.createElement("img");try{return a.src=e.toDataURL(),a}catch{this.context.logger.info("Unable to inline canvas contents, canvas is tainted",e)}}var n=e.cloneNode(!1);try{n.width=e.width,n.height=e.height;var i=e.getContext("2d"),o=n.getContext("2d");if(o)if(!this.options.allowTaint&&i)o.putImageData(i.getImageData(0,0,e.width,e.height),0,0);else{var l=(r=e.getContext("webgl2"))!==null&&r!==void 0?r:e.getContext("webgl");if(l){var c=l.getContextAttributes();c?.preserveDrawingBuffer===!1&&this.context.logger.warn("Unable to clone WebGL context as it has preserveDrawingBuffer=false",e)}o.drawImage(e,0,0)}return n}catch{this.context.logger.info("Unable to clone canvas as it is tainted",e)}return n},s.prototype.createVideoClone=function(e){var r=e.ownerDocument.createElement("canvas");r.width=e.offsetWidth,r.height=e.offsetHeight;var a=r.getContext("2d");try{return a&&(a.drawImage(e,0,0,r.width,r.height),this.options.allowTaint||a.getImageData(0,0,r.width,r.height)),r}catch{this.context.logger.info("Unable to clone video as it is tainted",e)}var n=e.ownerDocument.createElement("canvas");return n.width=e.offsetWidth,n.height=e.offsetHeight,n},s.prototype.appendChildNode=function(e,r,a){(!Ml(r)||!Dj(r)&&!r.hasAttribute(av)&&(typeof this.options.ignoreElements!="function"||!this.options.ignoreElements(r)))&&(!this.options.copyStyles||!Ml(r)||!Mf(r))&&e.appendChild(this.cloneNode(r,a))},s.prototype.cloneChildNodes=function(e,r,a){for(var n=this,i=e.shadowRoot?e.shadowRoot.firstChild:e.firstChild;i;i=i.nextSibling)if(Ml(i)&&sv(i)&&typeof i.assignedNodes=="function"){var o=i.assignedNodes();o.length&&o.forEach(function(l){return n.appendChildNode(r,l,a)})}else this.appendChildNode(r,i,a)},s.prototype.cloneNode=function(e,r){if(Xb(e))return document.createTextNode(e.data);if(!e.ownerDocument)return e.cloneNode(!1);var a=e.ownerDocument.defaultView;if(a&&Ml(e)&&(Zh(e)||Xd(e))){var n=this.createElementClone(e);n.style.transitionProperty="none";var i=a.getComputedStyle(e),o=a.getComputedStyle(e,":before"),l=a.getComputedStyle(e,":after");this.referenceElement===e&&Zh(n)&&(this.clonedReferenceElement=n),Dp(n)&&Jj(n);var c=this.counters.parse(new wf(this.context,i)),A=this.resolvePseudoContent(e,n,o,lA.BEFORE);_f(e)&&(r=!0),Rf(e)||this.cloneChildNodes(e,n,r),A&&n.insertBefore(A,n.firstChild);var d=this.resolvePseudoContent(e,n,l,lA.AFTER);return d&&n.appendChild(d),this.counters.pop(c),(i&&(this.options.copyStyles||Xd(e))&&!tv(e)||r)&&zm(i,n),(e.scrollTop!==0||e.scrollLeft!==0)&&this.scrolledElements.push([n,e.scrollLeft,e.scrollTop]),(Nu(e)||Bu(e))&&(Nu(n)||Bu(n))&&(n.value=e.value),n}return e.cloneNode(!1)},s.prototype.resolvePseudoContent=function(e,r,a,n){var i=this;if(a){var o=a.content,l=r.ownerDocument;if(!(!l||!o||o==="none"||o==="-moz-alt-content"||a.display==="none")){this.counters.parse(new wf(this.context,a));var c=new FS(this.context,a),A=l.createElement("html2canvaspseudoelement");zm(a,A),c.content.forEach(function(h){if(h.type===0)A.appendChild(l.createTextNode(h.value));else if(h.type===22){var f=l.createElement("img");f.src=h.value,f.style.opacity="1",A.appendChild(f)}else if(h.type===18){if(h.name==="attr"){var u=h.values.filter(Os);u.length&&A.appendChild(l.createTextNode(e.getAttribute(u[0].value)||""))}else if(h.name==="counter"){var x=h.values.filter(hc),b=x[0],N=x[1];if(b&&Os(b)){var v=i.counters.getCounterValue(b.value),j=N&&Os(N)?qh.parse(i.context,N.value):3;A.appendChild(l.createTextNode(pA(v,j,!1)))}}else if(h.name==="counters"){var I=h.values.filter(hc),b=I[0],C=I[1],N=I[2];if(b&&Os(b)){var E=i.counters.getCounterValues(b.value),T=N&&Os(N)?qh.parse(i.context,N.value):3,Q=C&&C.type===0?C.value:"",D=E.map(function(w){return pA(w,T,!1)}).join(Q);A.appendChild(l.createTextNode(D))}}}else if(h.type===20)switch(h.value){case"open-quote":A.appendChild(l.createTextNode(vf(c.quotes,i.quoteDepth++,!0)));break;case"close-quote":A.appendChild(l.createTextNode(vf(c.quotes,--i.quoteDepth,!1)));break;default:A.appendChild(l.createTextNode(h.value))}}),A.className=tp+" "+sp;var d=n===lA.BEFORE?" "+tp:" "+sp;return Xd(r)?r.className.baseValue+=d:r.className+=d,A}}},s.destroy=function(e){return e.parentNode?(e.parentNode.removeChild(e),!0):!1},s}(),lA;(function(s){s[s.BEFORE=0]="BEFORE",s[s.AFTER=1]="AFTER"})(lA||(lA={}));var Qj=function(s,e){var r=s.createElement("iframe");return r.className="html2canvas-container",r.style.visibility="hidden",r.style.position="fixed",r.style.left="-10000px",r.style.top="0px",r.style.border="0",r.width=e.width.toString(),r.height=e.height.toString(),r.scrolling="no",r.setAttribute(av,"true"),s.body.appendChild(r),r},Oj=function(s){return new Promise(function(e){if(s.complete){e();return}if(!s.src){e();return}s.onload=e,s.onerror=e})},Hj=function(s){return Promise.all([].slice.call(s.images,0).map(Oj))},Vj=function(s){return new Promise(function(e,r){var a=s.contentWindow;if(!a)return r("No window assigned for iframe");var n=a.document;a.onload=s.onload=function(){a.onload=s.onload=null;var i=setInterval(function(){n.body.childNodes.length>0&&n.readyState==="complete"&&(clearInterval(i),e(s))},50)}})},$j=["all","d","content"],zm=function(s,e){for(var r=s.length-1;r>=0;r--){var a=s.item(r);$j.indexOf(a)===-1&&e.style.setProperty(a,s.getPropertyValue(a))}return e},Kj=function(s){var e="";return s&&(e+="<!DOCTYPE ",s.name&&(e+=s.name),s.internalSubset&&(e+=s.internalSubset),s.publicId&&(e+='"'+s.publicId+'"'),s.systemId&&(e+='"'+s.systemId+'"'),e+=">"),e},Gj=function(s,e,r){s&&s.defaultView&&(e!==s.defaultView.pageXOffset||r!==s.defaultView.pageYOffset)&&s.defaultView.scrollTo(e,r)},zj=function(s){var e=s[0],r=s[1],a=s[2];e.scrollLeft=r,e.scrollTop=a},Wj=":before",qj=":after",tp="___html2canvas___pseudoelement_before",sp="___html2canvas___pseudoelement_after",Gf=`{
    content: "" !important;
    display: none !important;
}`,Jj=function(s){Yj(s,"."+tp+Wj+Gf+`
         .`+sp+qj+Gf)},Yj=function(s,e){var r=s.ownerDocument;if(r){var a=r.createElement("style");a.textContent=e,s.appendChild(a)}},nv=function(){function s(){}return s.getOrigin=function(e){var r=s._link;return r?(r.href=e,r.href=r.href,r.protocol+r.hostname+r.port):"about:blank"},s.isSameOrigin=function(e){return s.getOrigin(e)===s._origin},s.setContext=function(e){s._link=e.document.createElement("a"),s._origin=s.getOrigin(e.location.href)},s._origin="about:blank",s}(),Xj=function(){function s(e,r){this.context=e,this._options=r,this._cache={}}return s.prototype.addImage=function(e){var r=Promise.resolve();return this.has(e)||(qm(e)||sE(e))&&(this._cache[e]=this.loadImage(e)).catch(function(){}),r},s.prototype.match=function(e){return this._cache[e]},s.prototype.loadImage=function(e){return La(this,void 0,void 0,function(){var r,a,n,i,o=this;return Ca(this,function(l){switch(l.label){case 0:return r=nv.isSameOrigin(e),a=!Wm(e)&&this._options.useCORS===!0&&Aa.SUPPORT_CORS_IMAGES&&!r,n=!Wm(e)&&!r&&!qm(e)&&typeof this._options.proxy=="string"&&Aa.SUPPORT_CORS_XHR&&!a,!r&&this._options.allowTaint===!1&&!Wm(e)&&!qm(e)&&!n&&!a?[2]:(i=e,n?[4,this.proxy(i)]:[3,2]);case 1:i=l.sent(),l.label=2;case 2:return this.context.logger.debug("Added image "+e.substring(0,256)),[4,new Promise(function(c,A){var d=new Image;d.onload=function(){return c(d)},d.onerror=A,(rE(i)||a)&&(d.crossOrigin="anonymous"),d.src=i,d.complete===!0&&setTimeout(function(){return c(d)},500),o._options.imageTimeout>0&&setTimeout(function(){return A("Timed out ("+o._options.imageTimeout+"ms) loading image")},o._options.imageTimeout)})];case 3:return[2,l.sent()]}})})},s.prototype.has=function(e){return typeof this._cache[e]<"u"},s.prototype.keys=function(){return Promise.resolve(Object.keys(this._cache))},s.prototype.proxy=function(e){var r=this,a=this._options.proxy;if(!a)throw new Error("No proxy defined");var n=e.substring(0,256);return new Promise(function(i,o){var l=Aa.SUPPORT_RESPONSE_TYPE?"blob":"text",c=new XMLHttpRequest;c.onload=function(){if(c.status===200)if(l==="text")i(c.response);else{var h=new FileReader;h.addEventListener("load",function(){return i(h.result)},!1),h.addEventListener("error",function(f){return o(f)},!1),h.readAsDataURL(c.response)}else o("Failed to proxy resource "+n+" with status code "+c.status)},c.onerror=o;var A=a.indexOf("?")>-1?"&":"?";if(c.open("GET",""+a+A+"url="+encodeURIComponent(e)+"&responseType="+l),l!=="text"&&c instanceof XMLHttpRequest&&(c.responseType=l),r._options.imageTimeout){var d=r._options.imageTimeout;c.timeout=d,c.ontimeout=function(){return o("Timed out ("+d+"ms) proxying "+n)}}c.send()})},s}(),Zj=/^data:image\/svg\+xml/i,eE=/^data:image\/.*;base64,/i,tE=/^data:image\/.*/i,sE=function(s){return Aa.SUPPORT_SVG_DRAWING||!aE(s)},Wm=function(s){return tE.test(s)},rE=function(s){return eE.test(s)},qm=function(s){return s.substr(0,4)==="blob"},aE=function(s){return s.substr(-3).toLowerCase()==="svg"||Zj.test(s)},yt=function(){function s(e,r){this.type=0,this.x=e,this.y=r}return s.prototype.add=function(e,r){return new s(this.x+e,this.y+r)},s}(),Bl=function(s,e,r){return new yt(s.x+(e.x-s.x)*r,s.y+(e.y-s.y)*r)},yd=function(){function s(e,r,a,n){this.type=1,this.start=e,this.startControl=r,this.endControl=a,this.end=n}return s.prototype.subdivide=function(e,r){var a=Bl(this.start,this.startControl,e),n=Bl(this.startControl,this.endControl,e),i=Bl(this.endControl,this.end,e),o=Bl(a,n,e),l=Bl(n,i,e),c=Bl(o,l,e);return r?new s(this.start,a,o,c):new s(c,l,i,this.end)},s.prototype.add=function(e,r){return new s(this.start.add(e,r),this.startControl.add(e,r),this.endControl.add(e,r),this.end.add(e,r))},s.prototype.reverse=function(){return new s(this.end,this.endControl,this.startControl,this.start)},s}(),Fn=function(s){return s.type===1},nE=function(){function s(e){var r=e.styles,a=e.bounds,n=Yc(r.borderTopLeftRadius,a.width,a.height),i=n[0],o=n[1],l=Yc(r.borderTopRightRadius,a.width,a.height),c=l[0],A=l[1],d=Yc(r.borderBottomRightRadius,a.width,a.height),h=d[0],f=d[1],u=Yc(r.borderBottomLeftRadius,a.width,a.height),x=u[0],b=u[1],N=[];N.push((i+c)/a.width),N.push((x+h)/a.width),N.push((o+b)/a.height),N.push((A+f)/a.height);var v=Math.max.apply(Math,N);v>1&&(i/=v,o/=v,c/=v,A/=v,h/=v,f/=v,x/=v,b/=v);var j=a.width-c,I=a.height-f,C=a.width-h,E=a.height-b,T=r.borderTopWidth,Q=r.borderRightWidth,D=r.borderBottomWidth,k=r.borderLeftWidth,R=qs(r.paddingTop,e.bounds.width),w=qs(r.paddingRight,e.bounds.width),L=qs(r.paddingBottom,e.bounds.width),M=qs(r.paddingLeft,e.bounds.width);this.topLeftBorderDoubleOuterBox=i>0||o>0?ar(a.left+k/3,a.top+T/3,i-k/3,o-T/3,js.TOP_LEFT):new yt(a.left+k/3,a.top+T/3),this.topRightBorderDoubleOuterBox=i>0||o>0?ar(a.left+j,a.top+T/3,c-Q/3,A-T/3,js.TOP_RIGHT):new yt(a.left+a.width-Q/3,a.top+T/3),this.bottomRightBorderDoubleOuterBox=h>0||f>0?ar(a.left+C,a.top+I,h-Q/3,f-D/3,js.BOTTOM_RIGHT):new yt(a.left+a.width-Q/3,a.top+a.height-D/3),this.bottomLeftBorderDoubleOuterBox=x>0||b>0?ar(a.left+k/3,a.top+E,x-k/3,b-D/3,js.BOTTOM_LEFT):new yt(a.left+k/3,a.top+a.height-D/3),this.topLeftBorderDoubleInnerBox=i>0||o>0?ar(a.left+k*2/3,a.top+T*2/3,i-k*2/3,o-T*2/3,js.TOP_LEFT):new yt(a.left+k*2/3,a.top+T*2/3),this.topRightBorderDoubleInnerBox=i>0||o>0?ar(a.left+j,a.top+T*2/3,c-Q*2/3,A-T*2/3,js.TOP_RIGHT):new yt(a.left+a.width-Q*2/3,a.top+T*2/3),this.bottomRightBorderDoubleInnerBox=h>0||f>0?ar(a.left+C,a.top+I,h-Q*2/3,f-D*2/3,js.BOTTOM_RIGHT):new yt(a.left+a.width-Q*2/3,a.top+a.height-D*2/3),this.bottomLeftBorderDoubleInnerBox=x>0||b>0?ar(a.left+k*2/3,a.top+E,x-k*2/3,b-D*2/3,js.BOTTOM_LEFT):new yt(a.left+k*2/3,a.top+a.height-D*2/3),this.topLeftBorderStroke=i>0||o>0?ar(a.left+k/2,a.top+T/2,i-k/2,o-T/2,js.TOP_LEFT):new yt(a.left+k/2,a.top+T/2),this.topRightBorderStroke=i>0||o>0?ar(a.left+j,a.top+T/2,c-Q/2,A-T/2,js.TOP_RIGHT):new yt(a.left+a.width-Q/2,a.top+T/2),this.bottomRightBorderStroke=h>0||f>0?ar(a.left+C,a.top+I,h-Q/2,f-D/2,js.BOTTOM_RIGHT):new yt(a.left+a.width-Q/2,a.top+a.height-D/2),this.bottomLeftBorderStroke=x>0||b>0?ar(a.left+k/2,a.top+E,x-k/2,b-D/2,js.BOTTOM_LEFT):new yt(a.left+k/2,a.top+a.height-D/2),this.topLeftBorderBox=i>0||o>0?ar(a.left,a.top,i,o,js.TOP_LEFT):new yt(a.left,a.top),this.topRightBorderBox=c>0||A>0?ar(a.left+j,a.top,c,A,js.TOP_RIGHT):new yt(a.left+a.width,a.top),this.bottomRightBorderBox=h>0||f>0?ar(a.left+C,a.top+I,h,f,js.BOTTOM_RIGHT):new yt(a.left+a.width,a.top+a.height),this.bottomLeftBorderBox=x>0||b>0?ar(a.left,a.top+E,x,b,js.BOTTOM_LEFT):new yt(a.left,a.top+a.height),this.topLeftPaddingBox=i>0||o>0?ar(a.left+k,a.top+T,Math.max(0,i-k),Math.max(0,o-T),js.TOP_LEFT):new yt(a.left+k,a.top+T),this.topRightPaddingBox=c>0||A>0?ar(a.left+Math.min(j,a.width-Q),a.top+T,j>a.width+Q?0:Math.max(0,c-Q),Math.max(0,A-T),js.TOP_RIGHT):new yt(a.left+a.width-Q,a.top+T),this.bottomRightPaddingBox=h>0||f>0?ar(a.left+Math.min(C,a.width-k),a.top+Math.min(I,a.height-D),Math.max(0,h-Q),Math.max(0,f-D),js.BOTTOM_RIGHT):new yt(a.left+a.width-Q,a.top+a.height-D),this.bottomLeftPaddingBox=x>0||b>0?ar(a.left+k,a.top+Math.min(E,a.height-D),Math.max(0,x-k),Math.max(0,b-D),js.BOTTOM_LEFT):new yt(a.left+k,a.top+a.height-D),this.topLeftContentBox=i>0||o>0?ar(a.left+k+M,a.top+T+R,Math.max(0,i-(k+M)),Math.max(0,o-(T+R)),js.TOP_LEFT):new yt(a.left+k+M,a.top+T+R),this.topRightContentBox=c>0||A>0?ar(a.left+Math.min(j,a.width+k+M),a.top+T+R,j>a.width+k+M?0:c-k+M,A-(T+R),js.TOP_RIGHT):new yt(a.left+a.width-(Q+w),a.top+T+R),this.bottomRightContentBox=h>0||f>0?ar(a.left+Math.min(C,a.width-(k+M)),a.top+Math.min(I,a.height+T+R),Math.max(0,h-(Q+w)),f-(D+L),js.BOTTOM_RIGHT):new yt(a.left+a.width-(Q+w),a.top+a.height-(D+L)),this.bottomLeftContentBox=x>0||b>0?ar(a.left+k+M,a.top+E,Math.max(0,x-(k+M)),b-(D+L),js.BOTTOM_LEFT):new yt(a.left+k+M,a.top+a.height-(D+L))}return s}(),js;(function(s){s[s.TOP_LEFT=0]="TOP_LEFT",s[s.TOP_RIGHT=1]="TOP_RIGHT",s[s.BOTTOM_RIGHT=2]="BOTTOM_RIGHT",s[s.BOTTOM_LEFT=3]="BOTTOM_LEFT"})(js||(js={}));var ar=function(s,e,r,a,n){var i=4*((Math.sqrt(2)-1)/3),o=r*i,l=a*i,c=s+r,A=e+a;switch(n){case js.TOP_LEFT:return new yd(new yt(s,A),new yt(s,A-l),new yt(c-o,e),new yt(c,e));case js.TOP_RIGHT:return new yd(new yt(s,e),new yt(s+o,e),new yt(c,A-l),new yt(c,A));case js.BOTTOM_RIGHT:return new yd(new yt(c,e),new yt(c,e+l),new yt(s+o,A),new yt(s,A));case js.BOTTOM_LEFT:default:return new yd(new yt(c,A),new yt(c-o,A),new yt(s,e+l),new yt(s,e))}},Su=function(s){return[s.topLeftBorderBox,s.topRightBorderBox,s.bottomRightBorderBox,s.bottomLeftBorderBox]},iE=function(s){return[s.topLeftContentBox,s.topRightContentBox,s.bottomRightContentBox,s.bottomLeftContentBox]},ju=function(s){return[s.topLeftPaddingBox,s.topRightPaddingBox,s.bottomRightPaddingBox,s.bottomLeftPaddingBox]},oE=function(){function s(e,r,a){this.offsetX=e,this.offsetY=r,this.matrix=a,this.type=0,this.target=6}return s}(),bd=function(){function s(e,r){this.path=e,this.target=r,this.type=1}return s}(),lE=function(){function s(e){this.opacity=e,this.type=2,this.target=6}return s}(),cE=function(s){return s.type===0},iv=function(s){return s.type===1},AE=function(s){return s.type===2},zf=function(s,e){return s.length===e.length?s.some(function(r,a){return r===e[a]}):!1},dE=function(s,e,r,a,n){return s.map(function(i,o){switch(o){case 0:return i.add(e,r);case 1:return i.add(e+a,r);case 2:return i.add(e+a,r+n);case 3:return i.add(e,r+n)}return i})},ov=function(){function s(e){this.element=e,this.inlineLevel=[],this.nonInlineLevel=[],this.negativeZIndex=[],this.zeroOrAutoZIndexOrTransformedOrOpacity=[],this.positiveZIndex=[],this.nonPositionedFloats=[],this.nonPositionedInlineLevel=[]}return s}(),lv=function(){function s(e,r){if(this.container=e,this.parent=r,this.effects=[],this.curves=new nE(this.container),this.container.styles.opacity<1&&this.effects.push(new lE(this.container.styles.opacity)),this.container.styles.transform!==null){var a=this.container.bounds.left+this.container.styles.transformOrigin[0].number,n=this.container.bounds.top+this.container.styles.transformOrigin[1].number,i=this.container.styles.transform;this.effects.push(new oE(a,n,i))}if(this.container.styles.overflowX!==0){var o=Su(this.curves),l=ju(this.curves);zf(o,l)?this.effects.push(new bd(o,6)):(this.effects.push(new bd(o,2)),this.effects.push(new bd(l,4)))}}return s.prototype.getEffects=function(e){for(var r=[2,3].indexOf(this.container.styles.position)===-1,a=this.parent,n=this.effects.slice(0);a;){var i=a.effects.filter(function(c){return!iv(c)});if(r||a.container.styles.position!==0||!a.parent){if(n.unshift.apply(n,i),r=[2,3].indexOf(a.container.styles.position)===-1,a.container.styles.overflowX!==0){var o=Su(a.curves),l=ju(a.curves);zf(o,l)||n.unshift(new bd(l,6))}}else n.unshift.apply(n,i);a=a.parent}return n.filter(function(c){return Hr(c.target,e)})},s}(),rp=function(s,e,r,a){s.container.elements.forEach(function(n){var i=Hr(n.flags,4),o=Hr(n.flags,2),l=new lv(n,s);Hr(n.styles.display,2048)&&a.push(l);var c=Hr(n.flags,8)?[]:a;if(i||o){var A=i||n.styles.isPositioned()?r:e,d=new ov(l);if(n.styles.isPositioned()||n.styles.opacity<1||n.styles.isTransformed()){var h=n.styles.zIndex.order;if(h<0){var f=0;A.negativeZIndex.some(function(x,b){return h>x.element.container.styles.zIndex.order?(f=b,!1):f>0}),A.negativeZIndex.splice(f,0,d)}else if(h>0){var u=0;A.positiveZIndex.some(function(x,b){return h>=x.element.container.styles.zIndex.order?(u=b+1,!1):u>0}),A.positiveZIndex.splice(u,0,d)}else A.zeroOrAutoZIndexOrTransformedOrOpacity.push(d)}else n.styles.isFloating()?A.nonPositionedFloats.push(d):A.nonPositionedInlineLevel.push(d);rp(l,d,i?d:r,c)}else n.styles.isInlineLevel()?e.inlineLevel.push(l):e.nonInlineLevel.push(l),rp(l,e,r,c);Hr(n.flags,8)&&cv(n,c)})},cv=function(s,e){for(var r=s instanceof Xh?s.start:1,a=s instanceof Xh?s.reversed:!1,n=0;n<e.length;n++){var i=e[n];i.container instanceof Gb&&typeof i.container.value=="number"&&i.container.value!==0&&(r=i.container.value),i.listValue=pA(r,i.container.styles.listStyleType,!0),r+=a?-1:1}},uE=function(s){var e=new lv(s,null),r=new ov(e),a=[];return rp(e,r,r,a),cv(e.container,a),r},Wf=function(s,e){switch(e){case 0:return Un(s.topLeftBorderBox,s.topLeftPaddingBox,s.topRightBorderBox,s.topRightPaddingBox);case 1:return Un(s.topRightBorderBox,s.topRightPaddingBox,s.bottomRightBorderBox,s.bottomRightPaddingBox);case 2:return Un(s.bottomRightBorderBox,s.bottomRightPaddingBox,s.bottomLeftBorderBox,s.bottomLeftPaddingBox);case 3:default:return Un(s.bottomLeftBorderBox,s.bottomLeftPaddingBox,s.topLeftBorderBox,s.topLeftPaddingBox)}},mE=function(s,e){switch(e){case 0:return Un(s.topLeftBorderBox,s.topLeftBorderDoubleOuterBox,s.topRightBorderBox,s.topRightBorderDoubleOuterBox);case 1:return Un(s.topRightBorderBox,s.topRightBorderDoubleOuterBox,s.bottomRightBorderBox,s.bottomRightBorderDoubleOuterBox);case 2:return Un(s.bottomRightBorderBox,s.bottomRightBorderDoubleOuterBox,s.bottomLeftBorderBox,s.bottomLeftBorderDoubleOuterBox);case 3:default:return Un(s.bottomLeftBorderBox,s.bottomLeftBorderDoubleOuterBox,s.topLeftBorderBox,s.topLeftBorderDoubleOuterBox)}},hE=function(s,e){switch(e){case 0:return Un(s.topLeftBorderDoubleInnerBox,s.topLeftPaddingBox,s.topRightBorderDoubleInnerBox,s.topRightPaddingBox);case 1:return Un(s.topRightBorderDoubleInnerBox,s.topRightPaddingBox,s.bottomRightBorderDoubleInnerBox,s.bottomRightPaddingBox);case 2:return Un(s.bottomRightBorderDoubleInnerBox,s.bottomRightPaddingBox,s.bottomLeftBorderDoubleInnerBox,s.bottomLeftPaddingBox);case 3:default:return Un(s.bottomLeftBorderDoubleInnerBox,s.bottomLeftPaddingBox,s.topLeftBorderDoubleInnerBox,s.topLeftPaddingBox)}},pE=function(s,e){switch(e){case 0:return vd(s.topLeftBorderStroke,s.topRightBorderStroke);case 1:return vd(s.topRightBorderStroke,s.bottomRightBorderStroke);case 2:return vd(s.bottomRightBorderStroke,s.bottomLeftBorderStroke);case 3:default:return vd(s.bottomLeftBorderStroke,s.topLeftBorderStroke)}},vd=function(s,e){var r=[];return Fn(s)?r.push(s.subdivide(.5,!1)):r.push(s),Fn(e)?r.push(e.subdivide(.5,!0)):r.push(e),r},Un=function(s,e,r,a){var n=[];return Fn(s)?n.push(s.subdivide(.5,!1)):n.push(s),Fn(r)?n.push(r.subdivide(.5,!0)):n.push(r),Fn(a)?n.push(a.subdivide(.5,!0).reverse()):n.push(a),Fn(e)?n.push(e.subdivide(.5,!1).reverse()):n.push(e),n},Av=function(s){var e=s.bounds,r=s.styles;return e.add(r.borderLeftWidth,r.borderTopWidth,-(r.borderRightWidth+r.borderLeftWidth),-(r.borderTopWidth+r.borderBottomWidth))},Eu=function(s){var e=s.styles,r=s.bounds,a=qs(e.paddingLeft,r.width),n=qs(e.paddingRight,r.width),i=qs(e.paddingTop,r.width),o=qs(e.paddingBottom,r.width);return r.add(a+e.borderLeftWidth,i+e.borderTopWidth,-(e.borderRightWidth+e.borderLeftWidth+a+n),-(e.borderTopWidth+e.borderBottomWidth+i+o))},gE=function(s,e){return s===0?e.bounds:s===2?Eu(e):Av(e)},fE=function(s,e){return s===0?e.bounds:s===2?Eu(e):Av(e)},Jm=function(s,e,r){var a=gE(Ll(s.styles.backgroundOrigin,e),s),n=fE(Ll(s.styles.backgroundClip,e),s),i=xE(Ll(s.styles.backgroundSize,e),r,a),o=i[0],l=i[1],c=Yc(Ll(s.styles.backgroundPosition,e),a.width-o,a.height-l),A=yE(Ll(s.styles.backgroundRepeat,e),c,i,a,n),d=Math.round(a.left+c[0]),h=Math.round(a.top+c[1]);return[A,d,h,o,l]},Sl=function(s){return Os(s)&&s.value===ac.AUTO},wd=function(s){return typeof s=="number"},xE=function(s,e,r){var a=e[0],n=e[1],i=e[2],o=s[0],l=s[1];if(!o)return[0,0];if(Pr(o)&&l&&Pr(l))return[qs(o,r.width),qs(l,r.height)];var c=wd(i);if(Os(o)&&(o.value===ac.CONTAIN||o.value===ac.COVER)){if(wd(i)){var A=r.width/r.height;return A<i!=(o.value===ac.COVER)?[r.width,r.width/i]:[r.height*i,r.height]}return[r.width,r.height]}var d=wd(a),h=wd(n),f=d||h;if(Sl(o)&&(!l||Sl(l))){if(d&&h)return[a,n];if(!c&&!f)return[r.width,r.height];if(f&&c){var u=d?a:n*i,x=h?n:a/i;return[u,x]}var b=d?a:r.width,N=h?n:r.height;return[b,N]}if(c){var v=0,j=0;return Pr(o)?v=qs(o,r.width):Pr(l)&&(j=qs(l,r.height)),Sl(o)?v=j*i:(!l||Sl(l))&&(j=v/i),[v,j]}var I=null,C=null;if(Pr(o)?I=qs(o,r.width):l&&Pr(l)&&(C=qs(l,r.height)),I!==null&&(!l||Sl(l))&&(C=d&&h?I/a*n:r.height),C!==null&&Sl(o)&&(I=d&&h?C/n*a:r.width),I!==null&&C!==null)return[I,C];throw new Error("Unable to calculate background-size for element")},Ll=function(s,e){var r=s[e];return typeof r>"u"?s[0]:r},yE=function(s,e,r,a,n){var i=e[0],o=e[1],l=r[0],c=r[1];switch(s){case 2:return[new yt(Math.round(a.left),Math.round(a.top+o)),new yt(Math.round(a.left+a.width),Math.round(a.top+o)),new yt(Math.round(a.left+a.width),Math.round(c+a.top+o)),new yt(Math.round(a.left),Math.round(c+a.top+o))];case 3:return[new yt(Math.round(a.left+i),Math.round(a.top)),new yt(Math.round(a.left+i+l),Math.round(a.top)),new yt(Math.round(a.left+i+l),Math.round(a.height+a.top)),new yt(Math.round(a.left+i),Math.round(a.height+a.top))];case 1:return[new yt(Math.round(a.left+i),Math.round(a.top+o)),new yt(Math.round(a.left+i+l),Math.round(a.top+o)),new yt(Math.round(a.left+i+l),Math.round(a.top+o+c)),new yt(Math.round(a.left+i),Math.round(a.top+o+c))];default:return[new yt(Math.round(n.left),Math.round(n.top)),new yt(Math.round(n.left+n.width),Math.round(n.top)),new yt(Math.round(n.left+n.width),Math.round(n.height+n.top)),new yt(Math.round(n.left),Math.round(n.height+n.top))]}},bE="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",qf="Hidden Text",vE=function(){function s(e){this._data={},this._document=e}return s.prototype.parseMetrics=function(e,r){var a=this._document.createElement("div"),n=this._document.createElement("img"),i=this._document.createElement("span"),o=this._document.body;a.style.visibility="hidden",a.style.fontFamily=e,a.style.fontSize=r,a.style.margin="0",a.style.padding="0",a.style.whiteSpace="nowrap",o.appendChild(a),n.src=bE,n.width=1,n.height=1,n.style.margin="0",n.style.padding="0",n.style.verticalAlign="baseline",i.style.fontFamily=e,i.style.fontSize=r,i.style.margin="0",i.style.padding="0",i.appendChild(this._document.createTextNode(qf)),a.appendChild(i),a.appendChild(n);var l=n.offsetTop-i.offsetTop+2;a.removeChild(i),a.appendChild(this._document.createTextNode(qf)),a.style.lineHeight="normal",n.style.verticalAlign="super";var c=n.offsetTop-a.offsetTop+2;return o.removeChild(a),{baseline:l,middle:c}},s.prototype.getMetrics=function(e,r){var a=e+" "+r;return typeof this._data[a]>"u"&&(this._data[a]=this.parseMetrics(e,r)),this._data[a]},s}(),dv=function(){function s(e,r){this.context=e,this.options=r}return s}(),wE=1e4,CE=function(s){ai(e,s);function e(r,a){var n=s.call(this,r,a)||this;return n._activeEffects=[],n.canvas=a.canvas?a.canvas:document.createElement("canvas"),n.ctx=n.canvas.getContext("2d"),a.canvas||(n.canvas.width=Math.floor(a.width*a.scale),n.canvas.height=Math.floor(a.height*a.scale),n.canvas.style.width=a.width+"px",n.canvas.style.height=a.height+"px"),n.fontMetrics=new vE(document),n.ctx.scale(n.options.scale,n.options.scale),n.ctx.translate(-a.x,-a.y),n.ctx.textBaseline="bottom",n._activeEffects=[],n.context.logger.debug("Canvas renderer initialized ("+a.width+"x"+a.height+") with scale "+a.scale),n}return e.prototype.applyEffects=function(r){for(var a=this;this._activeEffects.length;)this.popEffect();r.forEach(function(n){return a.applyEffect(n)})},e.prototype.applyEffect=function(r){this.ctx.save(),AE(r)&&(this.ctx.globalAlpha=r.opacity),cE(r)&&(this.ctx.translate(r.offsetX,r.offsetY),this.ctx.transform(r.matrix[0],r.matrix[1],r.matrix[2],r.matrix[3],r.matrix[4],r.matrix[5]),this.ctx.translate(-r.offsetX,-r.offsetY)),iv(r)&&(this.path(r.path),this.ctx.clip()),this._activeEffects.push(r)},e.prototype.popEffect=function(){this._activeEffects.pop(),this.ctx.restore()},e.prototype.renderStack=function(r){return La(this,void 0,void 0,function(){var a;return Ca(this,function(n){switch(n.label){case 0:return a=r.element.container.styles,a.isVisible()?[4,this.renderStackContent(r)]:[3,2];case 1:n.sent(),n.label=2;case 2:return[2]}})})},e.prototype.renderNode=function(r){return La(this,void 0,void 0,function(){return Ca(this,function(a){switch(a.label){case 0:if(Hr(r.container.flags,16))debugger;return r.container.styles.isVisible()?[4,this.renderNodeBackgroundAndBorders(r)]:[3,3];case 1:return a.sent(),[4,this.renderNodeContent(r)];case 2:a.sent(),a.label=3;case 3:return[2]}})})},e.prototype.renderTextWithLetterSpacing=function(r,a,n){var i=this;if(a===0)this.ctx.fillText(r.text,r.bounds.left,r.bounds.top+n);else{var o=Up(r.text);o.reduce(function(l,c){return i.ctx.fillText(c,l,r.bounds.top+n),l+i.ctx.measureText(c).width},r.bounds.left)}},e.prototype.createFontStyle=function(r){var a=r.fontVariant.filter(function(o){return o==="normal"||o==="small-caps"}).join(""),n=EE(r.fontFamily).join(", "),i=EA(r.fontSize)?""+r.fontSize.number+r.fontSize.unit:r.fontSize.number+"px";return[[r.fontStyle,a,r.fontWeight,i,n].join(" "),n,i]},e.prototype.renderTextNode=function(r,a){return La(this,void 0,void 0,function(){var n,i,o,l,c,A,d,h,f=this;return Ca(this,function(u){return n=this.createFontStyle(a),i=n[0],o=n[1],l=n[2],this.ctx.font=i,this.ctx.direction=a.direction===1?"rtl":"ltr",this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic",c=this.fontMetrics.getMetrics(o,l),A=c.baseline,d=c.middle,h=a.paintOrder,r.textBounds.forEach(function(x){h.forEach(function(b){switch(b){case 0:f.ctx.fillStyle=Yr(a.color),f.renderTextWithLetterSpacing(x,a.letterSpacing,A);var N=a.textShadow;N.length&&x.text.trim().length&&(N.slice(0).reverse().forEach(function(v){f.ctx.shadowColor=Yr(v.color),f.ctx.shadowOffsetX=v.offsetX.number*f.options.scale,f.ctx.shadowOffsetY=v.offsetY.number*f.options.scale,f.ctx.shadowBlur=v.blur.number,f.renderTextWithLetterSpacing(x,a.letterSpacing,A)}),f.ctx.shadowColor="",f.ctx.shadowOffsetX=0,f.ctx.shadowOffsetY=0,f.ctx.shadowBlur=0),a.textDecorationLine.length&&(f.ctx.fillStyle=Yr(a.textDecorationColor||a.color),a.textDecorationLine.forEach(function(v){switch(v){case 1:f.ctx.fillRect(x.bounds.left,Math.round(x.bounds.top+A),x.bounds.width,1);break;case 2:f.ctx.fillRect(x.bounds.left,Math.round(x.bounds.top),x.bounds.width,1);break;case 3:f.ctx.fillRect(x.bounds.left,Math.ceil(x.bounds.top+d),x.bounds.width,1);break}}));break;case 1:a.webkitTextStrokeWidth&&x.text.trim().length&&(f.ctx.strokeStyle=Yr(a.webkitTextStrokeColor),f.ctx.lineWidth=a.webkitTextStrokeWidth,f.ctx.lineJoin=window.chrome?"miter":"round",f.ctx.strokeText(x.text,x.bounds.left,x.bounds.top+A)),f.ctx.strokeStyle="",f.ctx.lineWidth=0,f.ctx.lineJoin="miter";break}})}),[2]})})},e.prototype.renderReplacedElement=function(r,a,n){if(n&&r.intrinsicWidth>0&&r.intrinsicHeight>0){var i=Eu(r),o=ju(a);this.path(o),this.ctx.save(),this.ctx.clip(),this.ctx.drawImage(n,0,0,r.intrinsicWidth,r.intrinsicHeight,i.left,i.top,i.width,i.height),this.ctx.restore()}},e.prototype.renderNodeContent=function(r){return La(this,void 0,void 0,function(){var a,n,i,o,l,c,j,j,A,d,h,f,C,u,x,E,b,N,v,j,I,C,E;return Ca(this,function(T){switch(T.label){case 0:this.applyEffects(r.getEffects(4)),a=r.container,n=r.curves,i=a.styles,o=0,l=a.textNodes,T.label=1;case 1:return o<l.length?(c=l[o],[4,this.renderTextNode(c,i)]):[3,4];case 2:T.sent(),T.label=3;case 3:return o++,[3,1];case 4:if(!(a instanceof Vb))return[3,8];T.label=5;case 5:return T.trys.push([5,7,,8]),[4,this.context.cache.match(a.src)];case 6:return j=T.sent(),this.renderReplacedElement(a,n,j),[3,8];case 7:return T.sent(),this.context.logger.error("Error loading image "+a.src),[3,8];case 8:if(a instanceof $b&&this.renderReplacedElement(a,n,a.canvas),!(a instanceof Kb))return[3,12];T.label=9;case 9:return T.trys.push([9,11,,12]),[4,this.context.cache.match(a.svg)];case 10:return j=T.sent(),this.renderReplacedElement(a,n,j),[3,12];case 11:return T.sent(),this.context.logger.error("Error loading svg "+a.svg.substring(0,255)),[3,12];case 12:return a instanceof qb&&a.tree?(A=new e(this.context,{scale:this.options.scale,backgroundColor:a.backgroundColor,x:0,y:0,width:a.width,height:a.height}),[4,A.render(a.tree)]):[3,14];case 13:d=T.sent(),a.width&&a.height&&this.ctx.drawImage(d,0,0,a.width,a.height,a.bounds.left,a.bounds.top,a.bounds.width,a.bounds.height),T.label=14;case 14:if(a instanceof Lp&&(h=Math.min(a.bounds.width,a.bounds.height),a.type===wu?a.checked&&(this.ctx.save(),this.path([new yt(a.bounds.left+h*.39363,a.bounds.top+h*.79),new yt(a.bounds.left+h*.16,a.bounds.top+h*.5549),new yt(a.bounds.left+h*.27347,a.bounds.top+h*.44071),new yt(a.bounds.left+h*.39694,a.bounds.top+h*.5649),new yt(a.bounds.left+h*.72983,a.bounds.top+h*.23),new yt(a.bounds.left+h*.84,a.bounds.top+h*.34085),new yt(a.bounds.left+h*.39363,a.bounds.top+h*.79)]),this.ctx.fillStyle=Yr(Df),this.ctx.fill(),this.ctx.restore()):a.type===Cu&&a.checked&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(a.bounds.left+h/2,a.bounds.top+h/2,h/4,0,Math.PI*2,!0),this.ctx.fillStyle=Yr(Df),this.ctx.fill(),this.ctx.restore())),NE(a)&&a.value.length){switch(f=this.createFontStyle(i),C=f[0],u=f[1],x=this.fontMetrics.getMetrics(C,u).baseline,this.ctx.font=C,this.ctx.fillStyle=Yr(i.color),this.ctx.textBaseline="alphabetic",this.ctx.textAlign=SE(a.styles.textAlign),E=Eu(a),b=0,a.styles.textAlign){case 1:b+=E.width/2;break;case 2:b+=E.width;break}N=E.add(b,0,0,-E.height/2+1),this.ctx.save(),this.path([new yt(E.left,E.top),new yt(E.left+E.width,E.top),new yt(E.left+E.width,E.top+E.height),new yt(E.left,E.top+E.height)]),this.ctx.clip(),this.renderTextWithLetterSpacing(new oA(a.value,N),i.letterSpacing,x),this.ctx.restore(),this.ctx.textBaseline="alphabetic",this.ctx.textAlign="left"}if(!Hr(a.styles.display,2048))return[3,20];if(a.styles.listStyleImage===null)return[3,19];if(v=a.styles.listStyleImage,v.type!==0)return[3,18];j=void 0,I=v.url,T.label=15;case 15:return T.trys.push([15,17,,18]),[4,this.context.cache.match(I)];case 16:return j=T.sent(),this.ctx.drawImage(j,a.bounds.left-(j.width+10),a.bounds.top),[3,18];case 17:return T.sent(),this.context.logger.error("Error loading list-style-image "+I),[3,18];case 18:return[3,20];case 19:r.listValue&&a.styles.listStyleType!==-1&&(C=this.createFontStyle(i)[0],this.ctx.font=C,this.ctx.fillStyle=Yr(i.color),this.ctx.textBaseline="middle",this.ctx.textAlign="right",E=new Ji(a.bounds.left,a.bounds.top+qs(a.styles.paddingTop,a.bounds.width),a.bounds.width,yf(i.lineHeight,i.fontSize.number)/2+1),this.renderTextWithLetterSpacing(new oA(r.listValue,E),i.letterSpacing,yf(i.lineHeight,i.fontSize.number)/2+2),this.ctx.textBaseline="bottom",this.ctx.textAlign="left"),T.label=20;case 20:return[2]}})})},e.prototype.renderStackContent=function(r){return La(this,void 0,void 0,function(){var a,n,v,i,o,v,l,c,v,A,d,v,h,f,v,u,x,v,b,N,v;return Ca(this,function(j){switch(j.label){case 0:if(Hr(r.element.container.flags,16))debugger;return[4,this.renderNodeBackgroundAndBorders(r.element)];case 1:j.sent(),a=0,n=r.negativeZIndex,j.label=2;case 2:return a<n.length?(v=n[a],[4,this.renderStack(v)]):[3,5];case 3:j.sent(),j.label=4;case 4:return a++,[3,2];case 5:return[4,this.renderNodeContent(r.element)];case 6:j.sent(),i=0,o=r.nonInlineLevel,j.label=7;case 7:return i<o.length?(v=o[i],[4,this.renderNode(v)]):[3,10];case 8:j.sent(),j.label=9;case 9:return i++,[3,7];case 10:l=0,c=r.nonPositionedFloats,j.label=11;case 11:return l<c.length?(v=c[l],[4,this.renderStack(v)]):[3,14];case 12:j.sent(),j.label=13;case 13:return l++,[3,11];case 14:A=0,d=r.nonPositionedInlineLevel,j.label=15;case 15:return A<d.length?(v=d[A],[4,this.renderStack(v)]):[3,18];case 16:j.sent(),j.label=17;case 17:return A++,[3,15];case 18:h=0,f=r.inlineLevel,j.label=19;case 19:return h<f.length?(v=f[h],[4,this.renderNode(v)]):[3,22];case 20:j.sent(),j.label=21;case 21:return h++,[3,19];case 22:u=0,x=r.zeroOrAutoZIndexOrTransformedOrOpacity,j.label=23;case 23:return u<x.length?(v=x[u],[4,this.renderStack(v)]):[3,26];case 24:j.sent(),j.label=25;case 25:return u++,[3,23];case 26:b=0,N=r.positiveZIndex,j.label=27;case 27:return b<N.length?(v=N[b],[4,this.renderStack(v)]):[3,30];case 28:j.sent(),j.label=29;case 29:return b++,[3,27];case 30:return[2]}})})},e.prototype.mask=function(r){this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(this.canvas.width,0),this.ctx.lineTo(this.canvas.width,this.canvas.height),this.ctx.lineTo(0,this.canvas.height),this.ctx.lineTo(0,0),this.formatPath(r.slice(0).reverse()),this.ctx.closePath()},e.prototype.path=function(r){this.ctx.beginPath(),this.formatPath(r),this.ctx.closePath()},e.prototype.formatPath=function(r){var a=this;r.forEach(function(n,i){var o=Fn(n)?n.start:n;i===0?a.ctx.moveTo(o.x,o.y):a.ctx.lineTo(o.x,o.y),Fn(n)&&a.ctx.bezierCurveTo(n.startControl.x,n.startControl.y,n.endControl.x,n.endControl.y,n.end.x,n.end.y)})},e.prototype.renderRepeat=function(r,a,n,i){this.path(r),this.ctx.fillStyle=a,this.ctx.translate(n,i),this.ctx.fill(),this.ctx.translate(-n,-i)},e.prototype.resizeImage=function(r,a,n){var i;if(r.width===a&&r.height===n)return r;var o=(i=this.canvas.ownerDocument)!==null&&i!==void 0?i:document,l=o.createElement("canvas");l.width=Math.max(1,a),l.height=Math.max(1,n);var c=l.getContext("2d");return c.drawImage(r,0,0,r.width,r.height,0,0,a,n),l},e.prototype.renderBackgroundImage=function(r){return La(this,void 0,void 0,function(){var a,n,i,o,l,c;return Ca(this,function(A){switch(A.label){case 0:a=r.styles.backgroundImage.length-1,n=function(d){var h,f,u,R,$,O,M,P,D,x,R,$,O,M,P,b,N,v,j,I,C,E,T,Q,D,k,R,w,L,M,P,K,$,O,W,ee,V,q,S,H,Y,te;return Ca(this,function(G){switch(G.label){case 0:if(d.type!==0)return[3,5];h=void 0,f=d.url,G.label=1;case 1:return G.trys.push([1,3,,4]),[4,i.context.cache.match(f)];case 2:return h=G.sent(),[3,4];case 3:return G.sent(),i.context.logger.error("Error loading background-image "+f),[3,4];case 4:return h&&(u=Jm(r,a,[h.width,h.height,h.width/h.height]),R=u[0],$=u[1],O=u[2],M=u[3],P=u[4],D=i.ctx.createPattern(i.resizeImage(h,M,P),"repeat"),i.renderRepeat(R,D,$,O)),[3,6];case 5:cB(d)?(x=Jm(r,a,[null,null,null]),R=x[0],$=x[1],O=x[2],M=x[3],P=x[4],b=aB(d.angle,M,P),N=b[0],v=b[1],j=b[2],I=b[3],C=b[4],E=document.createElement("canvas"),E.width=M,E.height=P,T=E.getContext("2d"),Q=T.createLinearGradient(v,I,j,C),ff(d.stops,N).forEach(function(X){return Q.addColorStop(X.stop,Yr(X.color))}),T.fillStyle=Q,T.fillRect(0,0,M,P),M>0&&P>0&&(D=i.ctx.createPattern(E,"repeat"),i.renderRepeat(R,D,$,O))):AB(d)&&(k=Jm(r,a,[null,null,null]),R=k[0],w=k[1],L=k[2],M=k[3],P=k[4],K=d.position.length===0?[Tp]:d.position,$=qs(K[0],M),O=qs(K[K.length-1],P),W=nB(d,$,O,M,P),ee=W[0],V=W[1],ee>0&&V>0&&(q=i.ctx.createRadialGradient(w+$,L+O,0,w+$,L+O,ee),ff(d.stops,ee*2).forEach(function(X){return q.addColorStop(X.stop,Yr(X.color))}),i.path(R),i.ctx.fillStyle=q,ee!==V?(S=r.bounds.left+.5*r.bounds.width,H=r.bounds.top+.5*r.bounds.height,Y=V/ee,te=1/Y,i.ctx.save(),i.ctx.translate(S,H),i.ctx.transform(1,0,0,Y,0,0),i.ctx.translate(-S,-H),i.ctx.fillRect(w,te*(L-H)+H,M,P*te),i.ctx.restore()):i.ctx.fill())),G.label=6;case 6:return a--,[2]}})},i=this,o=0,l=r.styles.backgroundImage.slice(0).reverse(),A.label=1;case 1:return o<l.length?(c=l[o],[5,n(c)]):[3,4];case 2:A.sent(),A.label=3;case 3:return o++,[3,1];case 4:return[2]}})})},e.prototype.renderSolidBorder=function(r,a,n){return La(this,void 0,void 0,function(){return Ca(this,function(i){return this.path(Wf(n,a)),this.ctx.fillStyle=Yr(r),this.ctx.fill(),[2]})})},e.prototype.renderDoubleBorder=function(r,a,n,i){return La(this,void 0,void 0,function(){var o,l;return Ca(this,function(c){switch(c.label){case 0:return a<3?[4,this.renderSolidBorder(r,n,i)]:[3,2];case 1:return c.sent(),[2];case 2:return o=mE(i,n),this.path(o),this.ctx.fillStyle=Yr(r),this.ctx.fill(),l=hE(i,n),this.path(l),this.ctx.fill(),[2]}})})},e.prototype.renderNodeBackgroundAndBorders=function(r){return La(this,void 0,void 0,function(){var a,n,i,o,l,c,A,d,h=this;return Ca(this,function(f){switch(f.label){case 0:return this.applyEffects(r.getEffects(2)),a=r.container.styles,n=!Fo(a.backgroundColor)||a.backgroundImage.length,i=[{style:a.borderTopStyle,color:a.borderTopColor,width:a.borderTopWidth},{style:a.borderRightStyle,color:a.borderRightColor,width:a.borderRightWidth},{style:a.borderBottomStyle,color:a.borderBottomColor,width:a.borderBottomWidth},{style:a.borderLeftStyle,color:a.borderLeftColor,width:a.borderLeftWidth}],o=BE(Ll(a.backgroundClip,0),r.curves),n||a.boxShadow.length?(this.ctx.save(),this.path(o),this.ctx.clip(),Fo(a.backgroundColor)||(this.ctx.fillStyle=Yr(a.backgroundColor),this.ctx.fill()),[4,this.renderBackgroundImage(r.container)]):[3,2];case 1:f.sent(),this.ctx.restore(),a.boxShadow.slice(0).reverse().forEach(function(u){h.ctx.save();var x=Su(r.curves),b=u.inset?0:wE,N=dE(x,-b+(u.inset?1:-1)*u.spread.number,(u.inset?1:-1)*u.spread.number,u.spread.number*(u.inset?-2:2),u.spread.number*(u.inset?-2:2));u.inset?(h.path(x),h.ctx.clip(),h.mask(N)):(h.mask(x),h.ctx.clip(),h.path(N)),h.ctx.shadowOffsetX=u.offsetX.number+b,h.ctx.shadowOffsetY=u.offsetY.number,h.ctx.shadowColor=Yr(u.color),h.ctx.shadowBlur=u.blur.number,h.ctx.fillStyle=u.inset?Yr(u.color):"rgba(0,0,0,1)",h.ctx.fill(),h.ctx.restore()}),f.label=2;case 2:l=0,c=0,A=i,f.label=3;case 3:return c<A.length?(d=A[c],d.style!==0&&!Fo(d.color)&&d.width>0?d.style!==2?[3,5]:[4,this.renderDashedDottedBorder(d.color,d.width,l,r.curves,2)]:[3,11]):[3,13];case 4:return f.sent(),[3,11];case 5:return d.style!==3?[3,7]:[4,this.renderDashedDottedBorder(d.color,d.width,l,r.curves,3)];case 6:return f.sent(),[3,11];case 7:return d.style!==4?[3,9]:[4,this.renderDoubleBorder(d.color,d.width,l,r.curves)];case 8:return f.sent(),[3,11];case 9:return[4,this.renderSolidBorder(d.color,l,r.curves)];case 10:f.sent(),f.label=11;case 11:l++,f.label=12;case 12:return c++,[3,3];case 13:return[2]}})})},e.prototype.renderDashedDottedBorder=function(r,a,n,i,o){return La(this,void 0,void 0,function(){var l,c,A,d,h,f,u,x,b,N,v,j,I,C,E,T,E,T;return Ca(this,function(Q){return this.ctx.save(),l=pE(i,n),c=Wf(i,n),o===2&&(this.path(c),this.ctx.clip()),Fn(c[0])?(A=c[0].start.x,d=c[0].start.y):(A=c[0].x,d=c[0].y),Fn(c[1])?(h=c[1].end.x,f=c[1].end.y):(h=c[1].x,f=c[1].y),n===0||n===2?u=Math.abs(A-h):u=Math.abs(d-f),this.ctx.beginPath(),o===3?this.formatPath(l):this.formatPath(c.slice(0,2)),x=a<3?a*3:a*2,b=a<3?a*2:a,o===3&&(x=a,b=a),N=!0,u<=x*2?N=!1:u<=x*2+b?(v=u/(2*x+b),x*=v,b*=v):(j=Math.floor((u+b)/(x+b)),I=(u-j*x)/(j-1),C=(u-(j+1)*x)/j,b=C<=0||Math.abs(b-I)<Math.abs(b-C)?I:C),N&&(o===3?this.ctx.setLineDash([0,x+b]):this.ctx.setLineDash([x,b])),o===3?(this.ctx.lineCap="round",this.ctx.lineWidth=a):this.ctx.lineWidth=a*2+1.1,this.ctx.strokeStyle=Yr(r),this.ctx.stroke(),this.ctx.setLineDash([]),o===2&&(Fn(c[0])&&(E=c[3],T=c[0],this.ctx.beginPath(),this.formatPath([new yt(E.end.x,E.end.y),new yt(T.start.x,T.start.y)]),this.ctx.stroke()),Fn(c[1])&&(E=c[1],T=c[2],this.ctx.beginPath(),this.formatPath([new yt(E.end.x,E.end.y),new yt(T.start.x,T.start.y)]),this.ctx.stroke())),this.ctx.restore(),[2]})})},e.prototype.render=function(r){return La(this,void 0,void 0,function(){var a;return Ca(this,function(n){switch(n.label){case 0:return this.options.backgroundColor&&(this.ctx.fillStyle=Yr(this.options.backgroundColor),this.ctx.fillRect(this.options.x,this.options.y,this.options.width,this.options.height)),a=uE(r),[4,this.renderStack(a)];case 1:return n.sent(),this.applyEffects([]),[2,this.canvas]}})})},e}(dv),NE=function(s){return s instanceof Wb||s instanceof zb?!0:s instanceof Lp&&s.type!==Cu&&s.type!==wu},BE=function(s,e){switch(s){case 0:return Su(e);case 2:return iE(e);case 1:default:return ju(e)}},SE=function(s){switch(s){case 1:return"center";case 2:return"right";case 0:default:return"left"}},jE=["-apple-system","system-ui"],EE=function(s){return/iPhone OS 15_(0|1)/.test(window.navigator.userAgent)?s.filter(function(e){return jE.indexOf(e)===-1}):s},kE=function(s){ai(e,s);function e(r,a){var n=s.call(this,r,a)||this;return n.canvas=a.canvas?a.canvas:document.createElement("canvas"),n.ctx=n.canvas.getContext("2d"),n.options=a,n.canvas.width=Math.floor(a.width*a.scale),n.canvas.height=Math.floor(a.height*a.scale),n.canvas.style.width=a.width+"px",n.canvas.style.height=a.height+"px",n.ctx.scale(n.options.scale,n.options.scale),n.ctx.translate(-a.x,-a.y),n.context.logger.debug("EXPERIMENTAL ForeignObject renderer initialized ("+a.width+"x"+a.height+" at "+a.x+","+a.y+") with scale "+a.scale),n}return e.prototype.render=function(r){return La(this,void 0,void 0,function(){var a,n;return Ca(this,function(i){switch(i.label){case 0:return a=Yh(this.options.width*this.options.scale,this.options.height*this.options.scale,this.options.scale,this.options.scale,r),[4,IE(a)];case 1:return n=i.sent(),this.options.backgroundColor&&(this.ctx.fillStyle=Yr(this.options.backgroundColor),this.ctx.fillRect(0,0,this.options.width*this.options.scale,this.options.height*this.options.scale)),this.ctx.drawImage(n,-this.options.x*this.options.scale,-this.options.y*this.options.scale),[2,this.canvas]}})})},e}(dv),IE=function(s){return new Promise(function(e,r){var a=new Image;a.onload=function(){e(a)},a.onerror=r,a.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(new XMLSerializer().serializeToString(s))})},TE=function(){function s(e){var r=e.id,a=e.enabled;this.id=r,this.enabled=a,this.start=Date.now()}return s.prototype.debug=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];this.enabled&&(typeof window<"u"&&window.console&&typeof console.debug=="function"?console.debug.apply(console,ed([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},s.prototype.getTime=function(){return Date.now()-this.start},s.prototype.info=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];this.enabled&&typeof window<"u"&&window.console&&typeof console.info=="function"&&console.info.apply(console,ed([this.id,this.getTime()+"ms"],e))},s.prototype.warn=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];this.enabled&&(typeof window<"u"&&window.console&&typeof console.warn=="function"?console.warn.apply(console,ed([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},s.prototype.error=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];this.enabled&&(typeof window<"u"&&window.console&&typeof console.error=="function"?console.error.apply(console,ed([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},s.instances={},s}(),FE=function(){function s(e,r){var a;this.windowBounds=r,this.instanceName="#"+s.instanceCount++,this.logger=new TE({id:this.instanceName,enabled:e.logging}),this.cache=(a=e.cache)!==null&&a!==void 0?a:new Xj(this,e)}return s.instanceCount=1,s}(),rm=function(s,e){return e===void 0&&(e={}),PE(s,e)};typeof window<"u"&&nv.setContext(window);var PE=function(s,e){return La(void 0,void 0,void 0,function(){var r,a,n,i,o,l,c,A,d,h,f,u,x,b,N,v,j,I,C,E,Q,T,Q,D,k,R,w,L,M,P,K,$,O,W,ee,V,q,S,H,Y;return Ca(this,function(te){switch(te.label){case 0:if(!s||typeof s!="object")return[2,Promise.reject("Invalid element provided as first argument")];if(r=s.ownerDocument,!r)throw new Error("Element is not attached to a Document");if(a=r.defaultView,!a)throw new Error("Document is not attached to a Window");return n={allowTaint:(D=e.allowTaint)!==null&&D!==void 0?D:!1,imageTimeout:(k=e.imageTimeout)!==null&&k!==void 0?k:15e3,proxy:e.proxy,useCORS:(R=e.useCORS)!==null&&R!==void 0?R:!1},i=Dh({logging:(w=e.logging)!==null&&w!==void 0?w:!0,cache:e.cache},n),o={windowWidth:(L=e.windowWidth)!==null&&L!==void 0?L:a.innerWidth,windowHeight:(M=e.windowHeight)!==null&&M!==void 0?M:a.innerHeight,scrollX:(P=e.scrollX)!==null&&P!==void 0?P:a.pageXOffset,scrollY:(K=e.scrollY)!==null&&K!==void 0?K:a.pageYOffset},l=new Ji(o.scrollX,o.scrollY,o.windowWidth,o.windowHeight),c=new FE(i,l),A=($=e.foreignObjectRendering)!==null&&$!==void 0?$:!1,d={allowTaint:(O=e.allowTaint)!==null&&O!==void 0?O:!1,onclone:e.onclone,ignoreElements:e.ignoreElements,inlineImages:A,copyStyles:A},c.logger.debug("Starting document clone with size "+l.width+"x"+l.height+" scrolled to "+-l.left+","+-l.top),h=new Kf(c,s,d),f=h.clonedReferenceElement,f?[4,h.toIFrame(r,l)]:[2,Promise.reject("Unable to find element in cloned iframe")];case 1:return u=te.sent(),x=Dp(f)||Lj(f)?d5(f.ownerDocument):zu(c,f),b=x.width,N=x.height,v=x.left,j=x.top,I=UE(c,f,e.backgroundColor),C={canvas:e.canvas,backgroundColor:I,scale:(ee=(W=e.scale)!==null&&W!==void 0?W:a.devicePixelRatio)!==null&&ee!==void 0?ee:1,x:((V=e.x)!==null&&V!==void 0?V:0)+v,y:((q=e.y)!==null&&q!==void 0?q:0)+j,width:(S=e.width)!==null&&S!==void 0?S:Math.ceil(b),height:(H=e.height)!==null&&H!==void 0?H:Math.ceil(N)},A?(c.logger.debug("Document cloned, using foreign object rendering"),Q=new kE(c,C),[4,Q.render(f)]):[3,3];case 2:return E=te.sent(),[3,5];case 3:return c.logger.debug("Document cloned, element located at "+v+","+j+" with size "+b+"x"+N+" using computed rendering"),c.logger.debug("Starting DOM parsing"),T=Yb(c,f),I===T.styles.backgroundColor&&(T.styles.backgroundColor=Wi.TRANSPARENT),c.logger.debug("Starting renderer for element at "+C.x+","+C.y+" with size "+C.width+"x"+C.height),Q=new CE(c,C),[4,Q.render(T)];case 4:E=te.sent(),te.label=5;case 5:return(!((Y=e.removeContainer)!==null&&Y!==void 0)||Y)&&(Kf.destroy(u)||c.logger.error("Cannot detach cloned iframe as it is not in the DOM anymore")),c.logger.debug("Finished rendering"),[2,E]}})})},UE=function(s,e,r){var a=e.ownerDocument,n=a.documentElement?nA(s,getComputedStyle(a.documentElement).backgroundColor):Wi.TRANSPARENT,i=a.body?nA(s,getComputedStyle(a.body).backgroundColor):Wi.TRANSPARENT,o=typeof r=="string"?nA(s,r):r===null?Wi.TRANSPARENT:4294967295;return e===a.documentElement?Fo(n)?Fo(i)?o:i:n:o};const LE=Object.freeze(Object.defineProperty({__proto__:null,default:rm},Symbol.toStringTag,{value:"Module"})),DE=({rhcData:s})=>{const{haemodynamicPressures:e,cardiacOutput:r,calculations:a}=s,n=i=>i||"‚Äî";return t.jsxs("div",{style:{width:"680px",height:"378px",fontFamily:'Avenir, "Avenir Next", system-ui, -apple-system, sans-serif',backgroundColor:"#FFFFFF",padding:"10px",boxSizing:"border-box",display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"0",overflow:"hidden"},children:[t.jsxs("div",{style:{border:"2px solid #DC2626",borderRadius:"0",padding:"8px",display:"flex",flexDirection:"column",gap:"6px",boxSizing:"border-box",overflow:"hidden"},children:[t.jsx("h3",{style:{margin:0,fontSize:"10px",fontWeight:"700",textTransform:"uppercase",color:"#6B7280",letterSpacing:"0.5px",marginBottom:"3px"},children:"Haemodynamic Pressures"}),t.jsxs("div",{style:{borderBottom:"1px solid #E5E7EB",paddingBottom:"5px"},children:[t.jsx("div",{style:{fontSize:"9px",fontWeight:"600",color:"#DC2626",marginBottom:"2px"},children:"Right Atrial (RA)"}),t.jsxs("div",{style:{fontSize:"15px",fontWeight:"700",color:"#000000",lineHeight:"1.2"},children:[n(e.ra.mean)," mmHg"]}),t.jsx("div",{style:{fontSize:"8px",color:"#6B7280",marginTop:"1px"},children:"mean"}),(e.ra.aWave||e.ra.vWave)&&t.jsxs("div",{style:{fontSize:"7px",color:"#6B7280",marginTop:"1px"},children:["a-wave: ",n(e.ra.aWave),", v-wave: ",n(e.ra.vWave)]})]}),t.jsxs("div",{style:{borderBottom:"1px solid #E5E7EB",paddingBottom:"5px"},children:[t.jsx("div",{style:{fontSize:"9px",fontWeight:"600",color:"#DC2626",marginBottom:"2px"},children:"Right Ventricular (RV)"}),t.jsxs("div",{style:{fontSize:"15px",fontWeight:"700",color:"#000000",lineHeight:"1.2"},children:[n(e.rv.systolic),"/",n(e.rv.diastolic)," mmHg"]}),e.rv.rvedp&&t.jsxs("div",{style:{fontSize:"8px",color:"#6B7280",marginTop:"1px"},children:["RVEDP: ",e.rv.rvedp," mmHg"]})]}),t.jsxs("div",{style:{borderBottom:"1px solid #E5E7EB",paddingBottom:"5px"},children:[t.jsx("div",{style:{fontSize:"9px",fontWeight:"600",color:"#DC2626",marginBottom:"2px"},children:"Pulmonary Artery (PA)"}),t.jsxs("div",{style:{fontSize:"15px",fontWeight:"700",color:"#000000",lineHeight:"1.2"},children:[n(e.pa.systolic),"/",n(e.pa.diastolic),e.pa.mean&&` (${e.pa.mean})`," mmHg"]}),t.jsx("div",{style:{fontSize:"8px",color:"#6B7280",marginTop:"1px"},children:"systolic/diastolic (mean)"})]}),t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"9px",fontWeight:"600",color:"#DC2626",marginBottom:"2px"},children:"PCWP"}),t.jsxs("div",{style:{fontSize:"15px",fontWeight:"700",color:"#000000",lineHeight:"1.2"},children:[n(e.pcwp.mean)," mmHg"]}),t.jsx("div",{style:{fontSize:"8px",color:"#6B7280",marginTop:"1px"},children:"mean"}),(e.pcwp.aWave||e.pcwp.vWave)&&t.jsxs("div",{style:{fontSize:"7px",color:"#6B7280",marginTop:"1px"},children:["a-wave: ",n(e.pcwp.aWave),", v-wave: ",n(e.pcwp.vWave)]})]})]}),t.jsxs("div",{style:{border:"2px solid #2563EB",borderLeft:"0",borderRadius:"0",padding:"8px",display:"flex",flexDirection:"column",gap:"6px",boxSizing:"border-box",overflow:"hidden"},children:[t.jsx("h3",{style:{margin:0,fontSize:"10px",fontWeight:"700",textTransform:"uppercase",color:"#6B7280",letterSpacing:"0.5px",marginBottom:"3px"},children:"Cardiac Output"}),t.jsxs("div",{style:{borderBottom:"1px solid #E5E7EB",paddingBottom:"5px"},children:[t.jsx("div",{style:{fontSize:"9px",fontWeight:"600",color:"#2563EB",marginBottom:"3px"},children:"Thermodilution"}),r.thermodilution.co&&t.jsxs("div",{style:{marginBottom:"1px"},children:[t.jsx("span",{style:{fontSize:"14px",fontWeight:"700",color:"#000000",lineHeight:"1.2"},children:r.thermodilution.co}),t.jsx("span",{style:{fontSize:"10px",color:"#6B7280",marginLeft:"3px"},children:"L/min"})]}),r.thermodilution.ci&&t.jsxs("div",{style:{marginBottom:"1px"},children:[t.jsx("span",{style:{fontSize:"14px",fontWeight:"700",color:"#000000",lineHeight:"1.2"},children:r.thermodilution.ci}),t.jsx("span",{style:{fontSize:"10px",color:"#6B7280",marginLeft:"3px"},children:"L/min/m¬≤"})]})]}),(r.fick.co||r.fick.ci||a?.estimatedVO2)&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"9px",fontWeight:"600",color:"#2563EB",marginBottom:"3px"},children:"Fick Method"}),r.fick.co&&t.jsxs("div",{style:{marginBottom:"1px"},children:[t.jsx("span",{style:{fontSize:"14px",fontWeight:"700",color:"#000000",lineHeight:"1.2"},children:r.fick.co}),t.jsx("span",{style:{fontSize:"10px",color:"#6B7280",marginLeft:"3px"},children:"L/min"})]}),r.fick.ci&&t.jsxs("div",{style:{marginBottom:"1px"},children:[t.jsx("span",{style:{fontSize:"14px",fontWeight:"700",color:"#000000",lineHeight:"1.2"},children:r.fick.ci}),t.jsx("span",{style:{fontSize:"10px",color:"#6B7280",marginLeft:"3px"},children:"L/min/m¬≤"})]}),a?.estimatedVO2&&t.jsxs("div",{style:{fontSize:"7px",color:"#6B7280",marginTop:"2px"},children:["Assumed VO‚ÇÇ: ",a.estimatedVO2.toFixed(0)," mL/min (based on BSA/gender)"]})]})]}),t.jsxs("div",{style:{border:"2px solid #7C3AED",borderLeft:"0",borderRadius:"0",padding:"8px",display:"flex",flexDirection:"column",gap:"4px",boxSizing:"border-box",overflow:"hidden"},children:[t.jsx("h3",{style:{margin:0,fontSize:"10px",fontWeight:"700",textTransform:"uppercase",color:"#6B7280",letterSpacing:"0.5px",marginBottom:"3px"},children:"Calculated Parameters"}),t.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"4px"},children:[a?.pulmonaryVascularResistance&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"7px",color:"#7C3AED",fontWeight:"600"},children:"PVR"}),t.jsx("div",{style:{fontSize:"12px",fontWeight:"700",color:"#000000",lineHeight:"1.2"},children:a.pulmonaryVascularResistance.toFixed(1)}),t.jsx("div",{style:{fontSize:"6px",color:"#6B7280"},children:"WU"})]}),a?.transpulmonaryGradient&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"7px",color:"#7C3AED",fontWeight:"600"},children:"TPG"}),t.jsx("div",{style:{fontSize:"12px",fontWeight:"700",color:"#000000",lineHeight:"1.2"},children:a.transpulmonaryGradient.toFixed(0)}),t.jsx("div",{style:{fontSize:"6px",color:"#6B7280"},children:"mmHg"})]}),a?.diastolicPressureGradient&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"7px",color:"#7C3AED",fontWeight:"600"},children:"DPG"}),t.jsx("div",{style:{fontSize:"12px",fontWeight:"700",color:"#000000",lineHeight:"1.2"},children:a.diastolicPressureGradient.toFixed(0)}),t.jsx("div",{style:{fontSize:"6px",color:"#6B7280"},children:"mmHg"})]}),a?.papi&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"7px",color:"#7C3AED",fontWeight:"600"},children:"PAPi"}),t.jsx("div",{style:{fontSize:"12px",fontWeight:"700",color:"#000000",lineHeight:"1.2"},children:a.papi.toFixed(2)}),t.jsx("div",{style:{fontSize:"6px",color:"#6B7280"},children:"¬†"})]}),a?.pulmonaryVascularResistanceIndex&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"7px",color:"#7C3AED",fontWeight:"600"},children:"PVRI"}),t.jsx("div",{style:{fontSize:"12px",fontWeight:"700",color:"#000000",lineHeight:"1.2"},children:a.pulmonaryVascularResistanceIndex.toFixed(1)}),t.jsx("div",{style:{fontSize:"6px",color:"#6B7280"},children:"WU¬∑m¬≤"})]}),a?.systemicVascularResistance&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"7px",color:"#7C3AED",fontWeight:"600"},children:"SVR"}),t.jsx("div",{style:{fontSize:"12px",fontWeight:"700",color:"#000000",lineHeight:"1.2"},children:a.systemicVascularResistance.toFixed(1)}),t.jsx("div",{style:{fontSize:"6px",color:"#6B7280"},children:"WU"})]}),a?.systemicVascularResistanceIndex&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"7px",color:"#7C3AED",fontWeight:"600"},children:"SVRI"}),t.jsx("div",{style:{fontSize:"12px",fontWeight:"700",color:"#000000",lineHeight:"1.2"},children:a.systemicVascularResistanceIndex.toFixed(1)}),t.jsx("div",{style:{fontSize:"6px",color:"#6B7280"},children:"WU¬∑m¬≤"})]}),a?.strokeVolumeIndex&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"7px",color:"#7C3AED",fontWeight:"600"},children:"SVI"}),t.jsx("div",{style:{fontSize:"12px",fontWeight:"700",color:"#000000",lineHeight:"1.2"},children:a.strokeVolumeIndex.toFixed(0)}),t.jsx("div",{style:{fontSize:"7px",color:"#6B7280"},children:"mL/m¬≤"})]}),a?.rvswi&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"8px",color:"#7C3AED",fontWeight:"600"},children:"RVSWI"}),t.jsx("div",{style:{fontSize:"13px",fontWeight:"700",color:"#000000"},children:a.rvswi.toFixed(0)}),t.jsx("div",{style:{fontSize:"7px",color:"#6B7280"},children:"g¬∑m/m¬≤"})]}),a?.pulmonaryArterialCompliance&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"8px",color:"#7C3AED",fontWeight:"600"},children:"PAC"}),t.jsx("div",{style:{fontSize:"13px",fontWeight:"700",color:"#000000"},children:a.pulmonaryArterialCompliance.toFixed(1)}),t.jsx("div",{style:{fontSize:"7px",color:"#6B7280"},children:"mL/mmHg"})]}),a?.pulmonaryRCTime&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"8px",color:"#7C3AED",fontWeight:"600"},children:"RC Time"}),t.jsx("div",{style:{fontSize:"13px",fontWeight:"700",color:"#000000"},children:a.pulmonaryRCTime.toFixed(2)}),t.jsx("div",{style:{fontSize:"7px",color:"#6B7280"},children:"s"})]}),a?.effectivePulmonaryEa&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"8px",color:"#7C3AED",fontWeight:"600"},children:"Ea"}),t.jsx("div",{style:{fontSize:"13px",fontWeight:"700",color:"#000000"},children:a.effectivePulmonaryEa.toFixed(2)}),t.jsx("div",{style:{fontSize:"7px",color:"#6B7280"},children:"mmHg/mL"})]}),a?.rapPawpRatio&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"8px",color:"#7C3AED",fontWeight:"600"},children:"RAP:PCWP"}),t.jsx("div",{style:{fontSize:"13px",fontWeight:"700",color:"#000000"},children:a.rapPawpRatio.toFixed(2)}),t.jsx("div",{style:{fontSize:"7px",color:"#6B7280"},children:"¬†"})]}),a?.oxygenExtractionRatio&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"8px",color:"#7C3AED",fontWeight:"600"},children:"O‚ÇÇER"}),t.jsx("div",{style:{fontSize:"13px",fontWeight:"700",color:"#000000"},children:a.oxygenExtractionRatio.toFixed(0)}),t.jsx("div",{style:{fontSize:"7px",color:"#6B7280"},children:"%"})]}),a?.cardiacPowerOutput&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"8px",color:"#7C3AED",fontWeight:"600"},children:"CPO"}),t.jsx("div",{style:{fontSize:"13px",fontWeight:"700",color:"#000000"},children:a.cardiacPowerOutput.toFixed(2)}),t.jsx("div",{style:{fontSize:"7px",color:"#6B7280"},children:"W"})]}),a?.rvCardiacPowerOutput&&t.jsxs("div",{children:[t.jsx("div",{style:{fontSize:"8px",color:"#7C3AED",fontWeight:"600"},children:"RV CPO"}),t.jsx("div",{style:{fontSize:"13px",fontWeight:"700",color:"#000000"},children:a.rvCardiacPowerOutput.toFixed(2)}),t.jsx("div",{style:{fontSize:"7px",color:"#6B7280"},children:"W"})]})]})]})]})};function RE(s){const e=[];let r=!1,a=!1;return!s.haemodynamicPressures.ra.mean&&!s.haemodynamicPressures.ra.aWave&&!s.haemodynamicPressures.ra.vWave?e.push("Right Atrial Pressure"):r=!0,!s.haemodynamicPressures.rv.systolic&&!s.haemodynamicPressures.rv.diastolic?e.push("Right Ventricular Pressure"):r=!0,!s.haemodynamicPressures.pa.systolic&&!s.haemodynamicPressures.pa.diastolic&&!s.haemodynamicPressures.pa.mean?e.push("Pulmonary Artery Pressure"):r=!0,!s.haemodynamicPressures.pcwp.mean&&!s.haemodynamicPressures.pcwp.aWave&&!s.haemodynamicPressures.pcwp.vWave?e.push("PCWP"):r=!0,!s.cardiacOutput.thermodilution.co&&!s.cardiacOutput.fick.co?e.push("Cardiac Output"):a=!0,{valid:r||a,missingFields:e}}async function ME(s,e={}){return new Promise((r,a)=>{try{const n=document.createElement("div");n.style.position="absolute",n.style.left="-9999px",n.style.top="0",n.style.zIndex="-1",document.body.appendChild(n);const i=$u(n);i.render(DE({rhcData:s,patientInfo:e.patientInfo,operatorInfo:e.operatorInfo})),setTimeout(async()=>{try{const o=n.firstElementChild;if(!o)throw new Error("Card element not found after rendering");const l=await rm(o,{scale:3.125,backgroundColor:"#FFFFFF",logging:!1,useCORS:!0,allowTaint:!1,width:680,height:378});l.toBlob(c=>{if(!c){a(new Error("Failed to create image blob"));return}const A=l.toDataURL("image/png");i.unmount(),document.body.removeChild(n),r({blob:c,dataUrl:A})},"image/png",1)}catch(o){i.unmount(),document.body.removeChild(n),a(o)}},300)}catch(n){a(n)}})}const _E=()=>xu({agentType:"right-heart-cath"}),{fieldConfig:QE,copy:OE}=SA("rhc"),HE=[{key:"patient_details",title:"Patient Details",icon:Do,color:"teal",priority:"high"},{key:"indication",title:"Indication & Presentation",icon:gn,color:"blue",priority:"high"},{key:"procedure",title:"Procedure Details",icon:fu,color:"green",priority:"high"},{key:"pressures",title:"Haemodynamic Pressures",icon:jp,color:"red",priority:"high"},{key:"cardiac_output",title:"Cardiac Output Assessment",icon:uc,color:"purple",priority:"high"},{key:"calculations",title:"Calculated Haemodynamics",icon:uc,color:"emerald",priority:"high"},{key:"exercise",title:"Exercise Testing",icon:qi,color:"orange",priority:"medium"},{key:"complications",title:"Complications",icon:dl,color:"red",priority:"high"},{key:"conclusions",title:"Conclusions & Follow-up",icon:gn,color:"indigo",priority:"high"}],VE=({rhcReport:s,results:e,onCopy:r,onInsertToEMR:a,onUpdateRhcReport:n,className:i="",originalTranscription:o,onTranscriptionCopy:l,onTranscriptionInsert:c,onTranscriptionEdit:A,transcriptionSaveStatus:d,onAgentReprocess:h,currentAgent:f,isProcessing:u=!1,audioBlob:x,defaultTranscriptionExpanded:b=!1,collapseTranscriptionWhen:N,approvalState:v,onTranscriptionApprove:j,onReprocessWithAnswers:I,onDismissMissingInfo:C,selectedPatientName:E,onReprocessWithValidation:T})=>{const[Q,D]=m.useState(new Set(["patient_details","procedure","indication","pressures","cardiac_output","calculations","complications"])),[k,R]=m.useState({exporting:!1,exported:!1}),[w,L]=m.useState(!1),[M,P]=m.useState(null),[K]=m.useState(!1),[$,O]=m.useState(null),W=_E(),[ee,V]=m.useState(null),[q,S]=m.useState({}),[H,Y]=m.useState(!1),[te,G]=m.useState(""),[X,le]=m.useState("");m.useEffect(()=>{if(s&&M){const de=s.timestamp||0,xe=M.timestamp||0;de>xe&&(console.log("üîÑ RHC Display: Fresh rhcReport prop detected, clearing stale editedRHCReport"),P(null))}},[s]);const he=m.useMemo(()=>{if(console.log("üîç RHC Display Debug:",{hasRhcReport:!!s,hasResults:!!e,hasEditedRHCReport:!!M,rhcReportStatus:s?.status,rhcReportKeys:s?Object.keys(s):null}),e){console.log("üìã Results string preview (first 300 chars):",e.substring(0,300)),console.log("üìã Results string end (last 500 chars):",e.substring(Math.max(0,e.length-500)));const de=e.includes("<!-- RHC_STRUCTURED_DATA_JSON -->");console.log("üéØ Has JSON marker:",de)}if(s){if(M){const de=s.timestamp||0;if((M.timestamp||0)>de)return console.log("‚úÖ Using editedRHCReport (fresher than prop)"),M}return console.log("‚úÖ Using rhcReport prop"),s}if(M)return console.log("‚úÖ Using editedRHCReport (no prop available)"),M;if(e)try{const de=e.match(/<!-- RHC_STRUCTURED_DATA_JSON -->\n(\{[\s\S]*?\})\s*$/);if(de){console.log("‚úÖ Found RHC JSON marker, parsing...");const Ne=JSON.parse(de[1]),it={id:"rhc-display",agentName:"Right Heart Cath Agent",content:e,sections:[],metadata:{confidence:.95,processingTime:0,modelUsed:"RHC Parser"},timestamp:Date.now(),warnings:[],errors:[],rhcData:Ne.rhcData,haemodynamicPressures:Ne.haemodynamicPressures,cardiacOutput:Ne.cardiacOutput,exerciseHaemodynamics:Ne.exerciseHaemodynamics,complications:Ne.complications,patientData:Ne.patientData,calculations:Ne.calculations};return console.log("‚úÖ Successfully parsed RHC data from JSON marker"),console.log("üîç Parsed patientData:",Ne.patientData),console.log("üîç Parsed calculations:",Ne.calculations),it}console.log("‚ö†Ô∏è No JSON marker found, trying generic JSON fallback...");const xe=e.match(/\{[\s\S]*\}/);if(xe){const Ne=JSON.parse(xe[0]);if(Ne.rhcData)return console.log("‚úÖ Found rhcData in generic JSON fallback"),console.log("üîç Generic fallback patientData:",Ne.patientData),console.log("üîç Generic fallback calculations:",Ne.calculations),Ne;console.log("‚ùå Generic JSON found but no rhcData property")}else console.log("‚ùå No JSON object found in results string")}catch(de){console.warn("‚ùå Could not parse RHC report from results:",de)}return console.log("‚ùå effectiveRHCData is NULL - no structured display will show"),null},[s,e,M]),ve=m.useMemo(()=>{if(he?.content){let de=he.content;const xe=de.indexOf("<!-- RHC_STRUCTURED_DATA_JSON -->");return xe!==-1&&(de=de.substring(0,xe).trim()),de}if(e){let de=e;const xe=de.indexOf("<!-- RHC_STRUCTURED_DATA_JSON -->");return xe!==-1&&(de=de.substring(0,xe).trim()),de}return null},[he,e]),ke=de=>{if(de==null||de==="")return!0;const xe=Number(de);return!Number.isNaN(xe)&&xe===0},Le=m.useCallback(de=>{if(!de?.rhcData)return 0;let xe=0;const Ne=de.rhcData,it=de.patientData,st=[{path:"fluoroscopyTime",value:Ne.fluoroscopyTime},{path:"fluoroscopyDose",value:Ne.fluoroscopyDose},{path:"doseAreaProduct",value:Ne.doseAreaProduct},{path:"contrastVolume",value:Ne.contrastVolume},{path:"heartRate",value:it?.heartRate}];for(const $e of st)ke($e.value)&&xe++;return xe},[]),Be=m.useCallback(de=>{if(!de?.rhcData)return[];const xe=[],Ne=de.rhcData,it=de.patientData;return ke(Ne.fluoroscopyTime)&&xe.push("Fluoroscopy time"),ke(Ne.fluoroscopyDose)&&xe.push("Fluoroscopy dose"),ke(Ne.doseAreaProduct)&&xe.push("Dose area product (DAP)"),ke(Ne.contrastVolume)&&xe.push("Contrast volume"),ke(it?.heartRate)&&xe.push("Heart rate"),xe},[]),Re=m.useMemo(()=>Le(he),[he,Le]),re=m.useMemo(()=>Be(he),[he,Be]);bs.useEffect(()=>{s?.status==="awaiting_validation"&&s.validationResult&&(console.log("üîç RHC Display: Validation required, showing modal"),W.handleValidationRequired(s.validationResult))},[s?.status,s?.validationResult]);const Me=m.useCallback(de=>{D(xe=>{const Ne=new Set(xe);return Ne.has(de)?Ne.delete(de):Ne.add(de),Ne})},[]),Pe=m.useCallback((de,xe,Ne=!1)=>{O(it=>{if(!it)return it;const st=JSON.parse(JSON.stringify(it)),$e=de.split(".");let Xe=st;for(let Ze=0;Ze<$e.length-1;Ze++)Xe[$e[Ze]]=Xe[$e[Ze]]??{},Xe=Xe[$e[Ze]];return Xe[$e[$e.length-1]]=Ne?xe===""?void 0:parseFloat(xe):xe||null,st})},[]),be=m.useCallback((de,xe)=>{const Ne=xe===""||xe===null||xe===void 0?void 0:Number(xe);if(Ne===void 0||Number.isNaN(Ne))return"";const st={"haemodynamicPressures.ra.mean":{min:2,max:8},"haemodynamicPressures.rv.systolic":{min:15,max:30},"haemodynamicPressures.rv.diastolic":{min:2,max:8},"haemodynamicPressures.rv.rvedp":{min:0,max:8},"haemodynamicPressures.pa.systolic":{min:15,max:30},"haemodynamicPressures.pa.diastolic":{min:4,max:12},"haemodynamicPressures.pa.mean":{min:9,max:18},"haemodynamicPressures.pcwp.mean":{min:6,max:15},"patientData.sao2":{min:95,max:100},"cardiacOutput.mixedVenousO2":{min:60,max:80},"cardiacOutput.wedgeSaturation":{min:60,max:100},"cardiacOutput.thermodilution.co":{min:4,max:8},"cardiacOutput.thermodilution.ci":{min:2.5,max:4},"cardiacOutput.fick.co":{min:4,max:8},"cardiacOutput.fick.ci":{min:2.5,max:4}}[de];if(!st)return"";const{min:$e,max:Xe}=st,Ze=($e===void 0||Ne>=$e)&&(Xe===void 0||Ne<=Xe),ct=()=>$e!==void 0&&Ne<$e||Xe!==void 0&&Ne>Xe||$e!==void 0&&Ne<$e+(Xe!==void 0?(Xe-$e)*.1:0)||Xe!==void 0&&Ne>Xe-(Xe!==void 0&&$e!==void 0?(Xe-$e)*.1:0);return Ze?"border-emerald-300 bg-emerald-50":ct()?"border-amber-300 bg-amber-50":"border-rose-300 bg-rose-50"},[]);bs.useEffect(()=>{if(!K||!$)return;const de=$,xe=ut=>ut!=null&&ut!==""?parseFloat(ut):void 0,Ne=de.patientData?.height,it=de.patientData?.weight,st=de.patientData?.bsa??(Ne&&it?oC(Ne,it):void 0),$e=xe(de.cardiacOutput.thermodilution.co),Xe=de.patientData?.sao2,Ze=de.patientData?.svo2??(de.cardiacOutput.mixedVenousO2?parseFloat(de.cardiacOutput.mixedVenousO2):void 0),ct=de.patientData?.haemoglobin,pt=de.patientData?.gender,dt=st?jh(st,pt):void 0,xt=$e&&st?Co($e,st):void 0,Se=dt&&ct&&Xe!==void 0&&Ze!==void 0?Eh(dt,ct,Xe,Ze):void 0,qe=Se&&st?Co(Se,st):void 0;O(ut=>{if(!ut)return ut;const Ge=JSON.parse(JSON.stringify(ut));let rt=!1;if(st&&st!==Ge.patientData?.bsa&&(Ge.patientData={...Ge.patientData||{},bsa:st},rt=!0),xt!==void 0){const Ht=xt.toFixed(2);Ge.cardiacOutput.thermodilution.ci!==Ht&&(Ge.cardiacOutput.thermodilution.ci=Ht,rt=!0)}if(Se!==void 0){const Ht=Se.toFixed(2);Ge.cardiacOutput.fick.co!==Ht&&(Ge.cardiacOutput.fick.co=Ht,rt=!0)}if(qe!==void 0){const Ht=qe.toFixed(2);Ge.cardiacOutput.fick.ci!==Ht&&(Ge.cardiacOutput.fick.ci=Ht,rt=!0)}const Tt=xe(Ge.haemodynamicPressures.ra.mean),At=xe(Ge.haemodynamicPressures.pa.systolic),mt=xe(Ge.haemodynamicPressures.pa.diastolic),Qt=xe(Ge.haemodynamicPressures.pa.mean),ts=xe(Ge.haemodynamicPressures.pcwp.mean),Yt=Ge.calculations?{...Ge.calculations}:{};return Yt.transpulmonaryGradient=du(Qt,ts),Yt.diastolicPressureGradient=uu(mt,ts),Yt.pulmonaryVascularResistance=mu(Qt,ts,$e),Yt.pulmonaryVascularResistance&&st&&(Yt.pulmonaryVascularResistanceIndex=hu(Yt.pulmonaryVascularResistance,st)),xt!==void 0&&(Yt.cardiacIndex=xt),$e&&Ge.patientData?.heartRate&&(Yt.strokeVolume=pu($e,Ge.patientData.heartRate)),Yt.papi=gu(At,mt,Tt),dt!==void 0&&(Yt.estimatedVO2=dt),Ge.calculations=Yt,rt=!0,rt?Ge:ut})},[K,$]);const ce=m.useCallback(async()=>{if(!he){alert("No RHC data available to export");return}const{haemodynamicPressures:de,cardiacOutput:xe}=he,Ne=Ht=>Ht?parseFloat(Ht):void 0,it=Ne(de.ra.mean),st=Ne(de.pa.systolic),$e=Ne(de.pa.diastolic),Xe=Ne(de.pa.mean),Ze=Ne(de.pcwp.mean),ct=Ne(xe.thermodilution.co),pt=he.patientData?.bsa,dt=he.patientData?.heartRate,xt=he.patientData?.gender,Se=he.patientData?.sao2,qe=Ne(xe.mixedVenousO2),ut=he.patientData?.systolicBP,Ge=he.patientData?.diastolicBP,rt=ut&&Ge?uC(ut,Ge):void 0,Tt=Ht=>!!Ht&&Object.values(Ht).some(Es=>typeof Es=="number");let At=he.calculations||{};if(!Tt(At)){const Ht=du(Xe,Ze),Es=uu($e,Ze),vt=mu(Xe,Ze,ct),Ft=vt&&pt?hu(vt,pt):void 0,Hs=ct&&pt?Co(ct,pt):void 0,ks=ct&&dt?pu(ct,dt):void 0,Is=Hs&&dt?$y(Hs,dt):void 0,Nt=rt&&ct?Hy(rt,it||0,ct):void 0,gs=Nt&&pt?Vy(Nt,pt):void 0,Vt=gu(st,$e,it),Kr=Xe&&Is?Ky(Xe,it||0,Is):void 0,Kt=rt&&ct?Gy(rt,ct):void 0,Js=Xe&&ct?zy(Xe,ct):void 0,fs=pt?jh(pt,xt):void 0,Zs=he.patientData?.haemoglobin,Ot=fs&&Zs&&Se!==void 0&&qe!==void 0?Eh(fs,Zs,Se,qe):void 0,qt=Ot&&pt?Co(Ot,pt):void 0,ur=ks&&st&&$e?dC(ks,st,$e):void 0,kr=vt&&ur?AC(vt,ur):void 0,Zr=Xe&&Ze&&ks?cC(Xe,Ze,ks):void 0,Qa=it&&Ze?Wy(it,Ze):void 0,Oa=Se&&qe?lC(Se,qe):void 0;At={transpulmonaryGradient:Ht,diastolicPressureGradient:Es,pulmonaryVascularResistance:vt,pulmonaryVascularResistanceIndex:Ft,cardiacIndex:Hs,strokeVolume:ks,strokeVolumeIndex:Is,systemicVascularResistance:Nt,systemicVascularResistanceIndex:gs,papi:Vt,rvswi:Kr,cardiacPowerOutput:Kt,rvCardiacPowerOutput:Js,estimatedVO2:fs,fickCO:Ot,fickCI:qt,pulmonaryArterialCompliance:ur,pulmonaryRCTime:kr,effectivePulmonaryEa:Zr,rapPawpRatio:Qa,oxygenExtractionRatio:Oa}}const mt=At.fickCO,Qt=At.fickCI,ts={...he,calculations:At,cardiacOutput:{...he.cardiacOutput,fick:{...he.cardiacOutput.fick,co:mt!==void 0?mt.toFixed(2):he.cardiacOutput.fick.co,ci:Qt!==void 0?Qt.toFixed(2):he.cardiacOutput.fick.ci}}};console.log("üì§ Export Card - Data Source:",{hasEditedReport:!!M,usingEditedData:he===M,pressures:{ra:de.ra,rv:de.rv,pa:de.pa,pcwp:de.pcwp},cardiacOutput:xe,calculations:At,hasCalculations:!!At,calculationKeys:At?Object.keys(At):[]});const Yt=RE(ts);if(!Yt.valid){const Ht=Yt.missingFields.join(`
‚Ä¢ `);alert(`Cannot export card: Missing essential data

Missing fields:
‚Ä¢ ${Ht}

Please ensure all haemodynamic measurements are recorded.`);return}R(Ht=>({...Ht,exporting:!0}));try{const Ht={name:E||void 0,mrn:ts.id||void 0,dob:void 0},Es={operator:void 0,institution:void 0,date:new Date().toLocaleDateString("en-AU",{year:"numeric",month:"short",day:"numeric"})},{blob:vt,dataUrl:Ft}=await ME(ts,{patientInfo:Ht,operatorInfo:Es});V({dataUrl:Ft,blob:vt}),R(Hs=>({...Hs,exporting:!1}))}catch(Ht){console.error("Failed to generate card preview:",Ht),alert("Failed to generate card preview. Please try again."),R(Es=>({...Es,exporting:!1}))}},[he,E,M]),Ie=m.useCallback(de=>{console.log("üì• Display: Received updated report from field editor:",{thermodilution:de.cardiacOutput.thermodilution,fick:de.cardiacOutput.fick,calculations:de.calculations});const xe={...de,timestamp:Date.now()};P(xe),L(!1),n&&n(xe)},[n]),pe=m.useCallback(()=>{L(!1)},[]),fe=m.useCallback(()=>{if(!te.trim()||!X.trim()){alert("Both field name and value are required");return}S(de=>({...de,[te.trim()]:X.trim()})),G(""),le(""),Y(!1)},[te,X]),we=m.useCallback(de=>{S(xe=>{const Ne={...xe};return delete Ne[de],Ne})},[]);return t.jsxs("div",{className:`space-y-6 ${i}`,children:[o&&t.jsx(Gi,{originalTranscription:o,onTranscriptionCopy:l,onTranscriptionInsert:c,onTranscriptionEdit:A,transcriptionSaveStatus:d,onAgentReprocess:h,currentAgent:f,isProcessing:u,audioBlob:x,defaultExpanded:b,collapseWhen:N,approvalState:v,onTranscriptionApprove:j}),ve&&t.jsx(kp,{results:ve,agentType:"right-heart-cath",className:"mb-4"}),he&&t.jsx("div",{className:"mb-6",children:t.jsx(ye,{type:"button",onClick:ce,disabled:k.exporting||!he,variant:"outline",size:"md",fullWidth:!0,isLoading:k.exporting,isSuccess:k.exported,startIcon:t.jsx(wp,{}),className:"border-2 border-purple-300 bg-purple-50 text-purple-700 hover:bg-purple-100 hover:border-purple-400",title:"Export 18√ó10cm PNG card (300 DPI) - serves as the FINDINGS section",children:k.exporting?"Generating Report Image...":k.exported?"Report Image Downloaded!":"Generate Report Image (Findings)"})}),he?.missingCalculationFields&&he.missingCalculationFields.length>0&&t.jsx(as,{children:t.jsx(Ye.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.2},children:t.jsx(lb,{missingInfo:{missing_structured:he.missingCalculationFields,completeness_score:`${Math.round((1-he.missingCalculationFields.length/10)*100)}%`},onSubmit:de=>I&&I(de),onDismiss:C,agentType:"right-heart-cath"})})}),t.jsxs(Ye.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"border border-gray-200 rounded-lg bg-white shadow-sm relative",children:[(Object.keys(q).length>0||H)&&t.jsxs("div",{className:"bg-gradient-to-r from-emerald-50 to-teal-50 border-2 border-emerald-200 rounded-lg p-4 mb-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Custom Fields"}),t.jsx(ye,{onClick:()=>Y(!H),variant:"ghost",size:"sm",className:"text-xs text-emerald-600 hover:text-emerald-700 font-medium",children:H?"Cancel":"+ Add Field"})]}),H&&t.jsxs("div",{className:"bg-white rounded-lg p-3 mb-3 border border-emerald-200",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-2",children:[t.jsx("input",{type:"text",value:te,onChange:de=>G(de.target.value),placeholder:"Field name (e.g., 'Fluoroscopy time')",className:"px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500",onKeyDown:de=>{de.key==="Enter"&&(de.preventDefault(),fe())}}),t.jsx("input",{type:"text",value:X,onChange:de=>le(de.target.value),placeholder:"Value (e.g., '8.2 minutes')",className:"px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-emerald-500",onKeyDown:de=>{de.key==="Enter"&&(de.preventDefault(),fe())}})]}),t.jsx(ye,{onClick:fe,variant:"success",size:"sm",fullWidth:!0,className:"text-xs",children:"Add Field"})]}),Object.keys(q).length>0&&t.jsx("div",{className:"space-y-2",children:Object.entries(q).map(([de,xe])=>t.jsxs("div",{className:"bg-white rounded px-3 py-2 flex items-center justify-between border border-emerald-200",children:[t.jsxs("div",{className:"flex-1",children:[t.jsxs("span",{className:"text-sm font-medium text-gray-700",children:[de,":"]}),t.jsx("span",{className:"text-sm text-gray-900 ml-2",children:xe})]}),t.jsx(Zt,{onClick:()=>we(de),icon:t.jsx(es,{}),variant:"ghost",size:"sm","aria-label":"Remove field",className:"text-red-500 hover:text-red-700 ml-2",title:"Remove field"})]},de))})]}),t.jsx("div",{className:"divide-y divide-gray-200",children:HE.map(({key:de,title:xe,icon:Ne,color:it})=>{const st=Q.has(de);return t.jsxs("div",{children:[t.jsxs("button",{type:"button",onClick:()=>Me(de),className:"w-full px-4 py-3 flex flex-row items-center justify-between hover:bg-gray-50 transition-colors",children:[t.jsxs("div",{className:"flex flex-row items-center gap-2 min-w-0",children:[t.jsx(Ne,{className:`w-4 h-4 text-${it}-600 flex-shrink-0`}),t.jsx("span",{className:"font-medium text-gray-900 truncate text-left",children:xe})]}),st?t.jsx(Vr,{className:"w-4 h-4 text-gray-400 flex-shrink-0"}):t.jsx(ps,{className:"w-4 h-4 text-gray-400 flex-shrink-0"})]}),t.jsx(as,{children:st&&t.jsx(Ye.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.2},className:"px-4 py-3 pb-4",children:zE(de,K&&$?$:he,K?{editable:!0,onChange:($e,Xe,Ze=!1)=>Pe($e,Xe,Ze),getClass:be}:void 0)})})]},de)})})]}),t.jsx("div",{className:"mt-6 mb-4 px-4",children:t.jsx("div",{className:"bg-white shadow-lg border border-gray-200 rounded-lg p-3",children:t.jsxs("div",{className:"relative",children:[t.jsx(ye,{type:"button",onClick:()=>L(!0),disabled:!he,variant:"outline",size:"md",fullWidth:!0,startIcon:t.jsx(si,{}),className:"border border-blue-300 bg-blue-50 text-blue-700 hover:bg-blue-100 hover:border-blue-400",title:Re>0?`Edit all fields - ${Re} optional field${Re>1?"s":""} available: ${re.join(", ")}`:"Edit all fields including patient data, haemodynamics, access, catheter details, and add custom fields",children:"Edit All Fields"}),Re>0&&t.jsx("span",{className:"absolute -top-1 -right-1 inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-blue-500 rounded-full border-2 border-white shadow-sm","aria-label":`${Re} optional fields available`,children:Re})]})})}),w&&he&&t.jsx(c5,{rhcReport:he,onSave:Ie,onCancel:pe},`field-editor-${he.id||Date.now()}`),ee&&t.jsx(A5,{imageDataUrl:ee.dataUrl,imageBlob:ee.blob,patientName:E,onClose:()=>V(null)}),W.showValidationModal&&W.validationResult&&t.jsx(uA,{agentLabel:"RHC Data",validation:W.validationResult,fieldConfig:QE,copy:OE,onCancel:()=>{console.log("üö´ RHC Display: Validation cancelled"),W.handleValidationCancel()},onSkip:()=>{console.log("‚è≠Ô∏è RHC Display: Validation skipped"),W.handleValidationSkip()},onContinue:de=>{console.log("‚úÖ RHC Display: Validation complete, user fields:",de),P(null),W.handleValidationContinue(de),T&&T(de)}})]})},$E=s=>t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"Right Atrial Pressures"}),t.jsxs("div",{className:"space-y-1 text-sm",children:[s.ra.aWave&&t.jsxs("div",{children:["A-wave: ",t.jsxs("span",{className:"font-mono",children:[s.ra.aWave," mmHg"]})]}),s.ra.vWave&&t.jsxs("div",{children:["V-wave: ",t.jsxs("span",{className:"font-mono",children:[s.ra.vWave," mmHg"]})]}),s.ra.mean&&t.jsxs("div",{children:["Mean: ",t.jsxs("span",{className:"font-mono",children:[s.ra.mean," mmHg"]})]})]})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"Right Ventricular Pressures"}),t.jsxs("div",{className:"space-y-1 text-sm",children:[s.rv.systolic&&t.jsxs("div",{children:["Systolic: ",t.jsxs("span",{className:"font-mono",children:[s.rv.systolic," mmHg"]})]}),s.rv.diastolic&&t.jsxs("div",{children:["Diastolic: ",t.jsxs("span",{className:"font-mono",children:[s.rv.diastolic," mmHg"]})]}),s.rv.rvedp&&t.jsxs("div",{children:["RVEDP: ",t.jsxs("span",{className:"font-mono",children:[s.rv.rvedp," mmHg"]})]})]})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"Pulmonary Artery Pressures"}),t.jsxs("div",{className:"space-y-1 text-sm",children:[s.pa.systolic&&t.jsxs("div",{children:["Systolic: ",t.jsxs("span",{className:"font-mono",children:[s.pa.systolic," mmHg"]})]}),s.pa.diastolic&&t.jsxs("div",{children:["Diastolic: ",t.jsxs("span",{className:"font-mono",children:[s.pa.diastolic," mmHg"]})]}),s.pa.mean&&t.jsxs("div",{children:["Mean: ",t.jsxs("span",{className:"font-mono",children:[s.pa.mean," mmHg"]})]})]})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"PCWP"}),t.jsxs("div",{className:"space-y-1 text-sm",children:[s.pcwp.aWave&&t.jsxs("div",{children:["A-wave: ",t.jsxs("span",{className:"font-mono",children:[s.pcwp.aWave," mmHg"]})]}),s.pcwp.vWave&&t.jsxs("div",{children:["V-wave: ",t.jsxs("span",{className:"font-mono",children:[s.pcwp.vWave," mmHg"]})]}),s.pcwp.mean&&t.jsxs("div",{children:["Mean: ",t.jsxs("span",{className:"font-mono",children:[s.pcwp.mean," mmHg"]})]})]})]})]}),KE=(s,e)=>t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"Thermodilution"}),t.jsxs("div",{className:"space-y-1 text-sm",children:[s.thermodilution.co&&t.jsxs("div",{children:["Cardiac Output: ",t.jsxs("span",{className:"font-mono",children:[s.thermodilution.co," L/min"]})]}),s.thermodilution.ci&&t.jsxs("div",{children:["Cardiac Index: ",t.jsxs("span",{className:"font-mono",children:[s.thermodilution.ci," L/min/m¬≤"]})]})]})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"Fick Method"}),t.jsxs("div",{className:"space-y-1 text-sm",children:[s.fick.co&&t.jsxs("div",{children:["Cardiac Output: ",t.jsxs("span",{className:"font-mono",children:[s.fick.co," L/min"]})]}),s.fick.ci&&t.jsxs("div",{children:["Cardiac Index: ",t.jsxs("span",{className:"font-mono",children:[s.fick.ci," L/min/m¬≤"]})]})]})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"Other Measurements"}),t.jsxs("div",{className:"space-y-1 text-sm",children:[e?.sao2&&t.jsxs("div",{children:["Arterial O‚ÇÇ Saturation: ",t.jsxs("span",{className:"font-mono",children:[e.sao2,"%"]})]}),(s.mixedVenousO2||e?.svo2)&&t.jsxs("div",{children:["Mixed Venous O‚ÇÇ: ",t.jsxs("span",{className:"font-mono",children:[s.mixedVenousO2||e?.svo2,"%"]})]}),s.wedgeSaturation&&t.jsxs("div",{children:["Wedge Saturation: ",t.jsxs("span",{className:"font-mono",children:[s.wedgeSaturation,"%"]})]})]})]})]});function GE(s){if(!s)return"Not specified";const e=s.replace(/_/g," ").replace(/\b\w/g,r=>r.toUpperCase());return e.includes("Internal Jugular")||e.includes("Femoral")?e+" Vein":e}function zE(s,e,r){if(!e)return t.jsx("div",{className:"text-gray-500 italic",children:"No structured data available"});const{rhcData:a,haemodynamicPressures:n,cardiacOutput:i,exerciseHaemodynamics:o,complications:l=[],patientData:c={}}=e;switch(s){case"indication":return t.jsxs("div",{className:"space-y-3 text-sm",children:[t.jsxs("div",{children:[t.jsx("span",{className:"font-medium",children:"Indication:"})," ",a.indication.replace("_"," ")]}),a.clinicalPresentation&&t.jsxs("div",{children:[t.jsx("span",{className:"font-medium",children:"Clinical Presentation:"})," ",a.clinicalPresentation]}),a.recentInvestigations&&t.jsxs("div",{children:[t.jsx("span",{className:"font-medium",children:"Recent Investigations:"})," ",a.recentInvestigations]})]});case"patient_details":{const A=c&&(c.height||c.weight||c.bsa||c.bmi||c.heartRate||c.age||c.gender||c.systolicBP||c.rhythm||c.haemoglobin||c.sao2||c.svo2),d=a?.laboratoryValues&&(a.laboratoryValues.haemoglobin||a.laboratoryValues.lactate);return!A&&!d?t.jsx("div",{className:"text-gray-500 italic text-sm",children:"No patient demographics recorded. Use Edit All Fields to add patient data."}):t.jsxs("div",{className:"space-y-3 text-sm",children:[c&&(c.heartRate||c.systolicBP||c.rhythm)&&t.jsxs("div",{className:"bg-blue-50 p-3 rounded border-l-4 border-blue-400",children:[t.jsx("span",{className:"font-medium text-blue-900",children:"Vitals:"}),t.jsxs("div",{className:"mt-2 grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2",children:[c.rhythm&&t.jsxs("div",{children:["Rhythm: ",c.rhythm]}),c.heartRate&&t.jsxs("div",{children:["Heart Rate: ",c.heartRate," bpm"]}),c.systolicBP&&c.diastolicBP&&t.jsxs("div",{children:["BP: ",c.systolicBP,"/",c.diastolicBP," mmHg"]})]})]}),c&&(c.height||c.weight||c.bsa||c.bmi||c.age||c.gender)&&t.jsxs("div",{className:"bg-green-50 p-3 rounded border-l-4 border-green-400",children:[t.jsx("span",{className:"font-medium text-green-900",children:"Demographics & Anthropometrics:"}),t.jsxs("div",{className:"mt-2 grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2",children:[c.age&&t.jsxs("div",{children:["Age: ",c.age," years"]}),c.gender&&t.jsxs("div",{children:["Gender: ",String(c.gender).charAt(0).toUpperCase()+String(c.gender).slice(1)]}),c.height&&t.jsxs("div",{children:["Height: ",c.height," cm"]}),c.weight&&t.jsxs("div",{children:["Weight: ",c.weight," kg"]}),c.bmi&&t.jsxs("div",{children:["BMI: ",typeof c.bmi=="number"?c.bmi.toFixed(1):c.bmi," kg/m¬≤"]}),c.bsa&&t.jsxs("div",{children:["BSA: ",typeof c.bsa=="number"?c.bsa.toFixed(2):c.bsa," m¬≤"]})]})]}),c&&(c.sao2||c.svo2||c.haemoglobin)&&t.jsxs("div",{className:"bg-purple-50 p-3 rounded border-l-4 border-purple-400",children:[t.jsx("span",{className:"font-medium text-purple-900",children:"Laboratory Values:"}),t.jsxs("div",{className:"mt-2 grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2",children:[c.haemoglobin&&t.jsxs("div",{children:["Haemoglobin: ",c.haemoglobin," g/L"]}),c.sao2&&t.jsxs("div",{children:["SaO‚ÇÇ: ",c.sao2,"%"]}),c.svo2&&t.jsxs("div",{children:["SvO‚ÇÇ: ",c.svo2,"%"]})]})]}),a?.laboratoryValues&&(a.laboratoryValues.haemoglobin||a.laboratoryValues.lactate)&&t.jsxs("div",{className:"bg-gray-50 p-3 rounded border-l-4 border-gray-400",children:[t.jsx("span",{className:"font-medium",children:"Additional Laboratory Values:"}),t.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-x-4 gap-y-1",children:[a.laboratoryValues.haemoglobin&&!c?.haemoglobin&&t.jsxs("div",{children:["Haemoglobin: ",a.laboratoryValues.haemoglobin," g/L"]}),a.laboratoryValues.lactate&&t.jsxs("div",{children:["Lactate: ",a.laboratoryValues.lactate," mmol/L"]})]})]})]})}case"procedure":return t.jsxs("div",{className:"space-y-3 text-sm",children:[t.jsxs("div",{children:[t.jsx("span",{className:"font-medium",children:"Vascular Access:"})," ",GE(a.vascularAccess)]}),t.jsxs("div",{children:[t.jsx("span",{className:"font-medium",children:"Catheter Details:"})," ",a.catheterDetails||"Not specified"]}),(a.fluoroscopyTime||a.fluoroscopyDose||a.doseAreaProduct||a.contrastVolume)&&t.jsxs("div",{className:"bg-blue-50 p-3 rounded border-l-4 border-blue-400",children:[t.jsx("span",{className:"font-medium text-blue-900",children:"Radiation Safety & Contrast:"}),t.jsxs("div",{className:"mt-1 space-y-1",children:[a.fluoroscopyTime&&t.jsxs("div",{children:["Fluoroscopy Time: ",a.fluoroscopyTime," min"]}),a.fluoroscopyDose&&t.jsxs("div",{children:["Fluoroscopy Dose: ",a.fluoroscopyDose," mGy"]}),a.doseAreaProduct&&t.jsxs("div",{children:["DAP: ",a.doseAreaProduct," Gy¬∑cm¬≤"]}),a.contrastVolume&&t.jsxs("div",{children:["Contrast Volume: ",a.contrastVolume," mL"]})]})]})]});case"pressures":return r?.editable?t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"Right Atrial Pressures"}),t.jsxs("div",{className:"grid grid-cols-3 gap-2 text-sm",children:[t.jsx("input",{className:`px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("haemodynamicPressures.ra.aWave",n.ra.aWave)||"border-gray-300"}`,placeholder:"A",value:n.ra.aWave??"",onChange:A=>r.onChange?.("haemodynamicPressures.ra.aWave",A.target.value)}),t.jsx("input",{className:`px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("haemodynamicPressures.ra.vWave",n.ra.vWave)||"border-gray-300"}`,placeholder:"V",value:n.ra.vWave??"",onChange:A=>r.onChange?.("haemodynamicPressures.ra.vWave",A.target.value)}),t.jsx("input",{className:`px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("haemodynamicPressures.ra.mean",n.ra.mean)||"border-gray-300"}`,placeholder:"Mean",value:n.ra.mean??"",onChange:A=>r.onChange?.("haemodynamicPressures.ra.mean",A.target.value)})]})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"Right Ventricular Pressures"}),t.jsxs("div",{className:"grid grid-cols-3 gap-2 text-sm",children:[t.jsx("input",{className:`px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("haemodynamicPressures.rv.systolic",n.rv.systolic)||"border-gray-300"}`,placeholder:"Sys",value:n.rv.systolic??"",onChange:A=>r.onChange?.("haemodynamicPressures.rv.systolic",A.target.value)}),t.jsx("input",{className:`px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("haemodynamicPressures.rv.diastolic",n.rv.diastolic)||"border-gray-300"}`,placeholder:"Dia",value:n.rv.diastolic??"",onChange:A=>r.onChange?.("haemodynamicPressures.rv.diastolic",A.target.value)}),t.jsx("input",{className:`px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("haemodynamicPressures.rv.rvedp",n.rv.rvedp)||"border-gray-300"}`,placeholder:"RVEDP",value:n.rv.rvedp??"",onChange:A=>r.onChange?.("haemodynamicPressures.rv.rvedp",A.target.value)})]})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"Pulmonary Artery Pressures"}),t.jsxs("div",{className:"grid grid-cols-3 gap-2 text-sm",children:[t.jsx("input",{className:`px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("haemodynamicPressures.pa.systolic",n.pa.systolic)||"border-gray-300"}`,placeholder:"Sys",value:n.pa.systolic??"",onChange:A=>r.onChange?.("haemodynamicPressures.pa.systolic",A.target.value)}),t.jsx("input",{className:`px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("haemodynamicPressures.pa.diastolic",n.pa.diastolic)||"border-gray-300"}`,placeholder:"Dia",value:n.pa.diastolic??"",onChange:A=>r.onChange?.("haemodynamicPressures.pa.diastolic",A.target.value)}),t.jsx("input",{className:`px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("haemodynamicPressures.pa.mean",n.pa.mean)||"border-gray-300"}`,placeholder:"Mean",value:n.pa.mean??"",onChange:A=>r.onChange?.("haemodynamicPressures.pa.mean",A.target.value)})]})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"PCWP"}),t.jsxs("div",{className:"grid grid-cols-3 gap-2 text-sm",children:[t.jsx("input",{className:`px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("haemodynamicPressures.pcwp.aWave",n.pcwp.aWave)||"border-gray-300"}`,placeholder:"A",value:n.pcwp.aWave??"",onChange:A=>r.onChange?.("haemodynamicPressures.pcwp.aWave",A.target.value)}),t.jsx("input",{className:`px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("haemodynamicPressures.pcwp.vWave",n.pcwp.vWave)||"border-gray-300"}`,placeholder:"V",value:n.pcwp.vWave??"",onChange:A=>r.onChange?.("haemodynamicPressures.pcwp.vWave",A.target.value)}),t.jsx("input",{className:`px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("haemodynamicPressures.pcwp.mean",n.pcwp.mean)||"border-gray-300"}`,placeholder:"Mean",value:n.pcwp.mean??"",onChange:A=>r.onChange?.("haemodynamicPressures.pcwp.mean",A.target.value)})]})]})]}):$E(n);case"cardiac_output":return r?.editable?t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"Thermodilution"}),t.jsxs("div",{className:"space-y-2 text-sm",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"w-12 text-gray-600 text-xs",children:"CO"}),t.jsx("input",{className:`flex-1 px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("cardiacOutput.thermodilution.co",i.thermodilution.co)||"border-gray-300"}`,placeholder:"L/min",value:i.thermodilution.co??"",onChange:A=>r.onChange?.("cardiacOutput.thermodilution.co",A.target.value,!0)})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"w-12 text-gray-600 text-xs",children:"CI"}),t.jsx("input",{className:`flex-1 px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("cardiacOutput.thermodilution.ci",i.thermodilution.ci)||"border-gray-300"}`,placeholder:"L/min/m¬≤",value:i.thermodilution.ci??"",onChange:A=>r.onChange?.("cardiacOutput.thermodilution.ci",A.target.value,!0)})]})]})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"Fick Method"}),t.jsxs("div",{className:"space-y-2 text-sm",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"w-12 text-gray-600 text-xs",children:"CO"}),t.jsx("input",{className:`flex-1 px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("cardiacOutput.fick.co",i.fick.co)||"border-gray-300"}`,placeholder:"L/min",value:i.fick.co??"",onChange:A=>r.onChange?.("cardiacOutput.fick.co",A.target.value,!0)})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"w-12 text-gray-600 text-xs",children:"CI"}),t.jsx("input",{className:`flex-1 px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("cardiacOutput.fick.ci",i.fick.ci)||"border-gray-300"}`,placeholder:"L/min/m¬≤",value:i.fick.ci??"",onChange:A=>r.onChange?.("cardiacOutput.fick.ci",A.target.value,!0)})]})]})]}),t.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg md:col-span-2",children:[t.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"Oxygen Saturations"}),t.jsxs("div",{className:"grid grid-cols-3 gap-2 text-sm",children:[t.jsx("input",{className:`px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("patientData.sao2",e.patientData?.sao2)||"border-gray-300"}`,placeholder:"SaO‚ÇÇ %",value:String(e.patientData?.sao2??""),onChange:A=>r.onChange?.("patientData.sao2",A.target.value,!0)}),t.jsx("input",{className:`px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("cardiacOutput.mixedVenousO2",i.mixedVenousO2)||"border-gray-300"}`,placeholder:"Mixed Venous %",value:i.mixedVenousO2??"",onChange:A=>r.onChange?.("cardiacOutput.mixedVenousO2",A.target.value,!0)}),t.jsx("input",{className:`px-2 py-1 text-xs font-mono text-right border rounded-md bg-white focus:ring-2 focus:ring-blue-500 ${r?.getClass?.("cardiacOutput.wedgeSaturation",i.wedgeSaturation)||"border-gray-300"}`,placeholder:"Wedge %",value:i.wedgeSaturation??"",onChange:A=>r.onChange?.("cardiacOutput.wedgeSaturation",A.target.value,!0)})]})]})]}):KE(i,e.patientData);case"calculations":{const A=E=>!!E&&Object.values(E).some(T=>typeof T=="number");let d=e.calculations;const h=E=>E?parseFloat(E):void 0,f=h(n.ra.mean),u=h(n.pa.systolic),x=h(n.pa.diastolic),b=h(n.pa.mean),N=h(n.pcwp.mean),v=h(i.thermodilution.co),j=e.patientData?.bsa,I=e.patientData?.heartRate,C={};if(C.transpulmonaryGradient=du(b,N),C.diastolicPressureGradient=uu(x,N),C.pulmonaryVascularResistance=mu(b,N,v),C.pulmonaryVascularResistance&&j&&(C.pulmonaryVascularResistanceIndex=hu(C.pulmonaryVascularResistance,j)),v&&j&&(C.cardiacIndex=Co(v,j)),v&&I&&(C.strokeVolume=pu(v,I)),C.papi=gu(u,x,f),!A(d)&&A(C))d=C;else if(A(d)&&A(C))for(const[E,T]of Object.entries(C))T!==void 0&&(d?.[E]===void 0||d?.[E]===null)&&(d[E]=T);return A(d)?t.jsx(l5,{calculations:d}):t.jsx("div",{className:"text-gray-500 italic",children:"No calculated haemodynamics available"})}case"exercise":return o?t.jsxs("div",{className:"space-y-3 text-sm",children:[t.jsxs("div",{children:[t.jsx("span",{className:"font-medium",children:"Protocol:"})," ",o.protocol]}),t.jsxs("div",{children:[t.jsx("span",{className:"font-medium",children:"Duration:"})," ",o.duration]}),t.jsxs("div",{children:[t.jsx("span",{className:"font-medium",children:"Response:"})," ",o.response]})]}):t.jsx("div",{className:"text-gray-500 italic",children:"Exercise testing not performed"});case"complications":return l.length===0?t.jsx("div",{className:"text-green-600 text-sm",children:"No complications reported"}):t.jsx("div",{className:"space-y-3",children:l.map((A,d)=>t.jsx("div",{className:"bg-red-50 border-l-4 border-red-400 p-3",children:t.jsxs("div",{className:"text-sm",children:[t.jsxs("span",{className:"font-medium text-red-800",children:[A.type.replace("_"," ")," (",A.severity,")"]}),t.jsx("div",{className:"mt-1 text-red-700",children:A.description}),A.management&&t.jsxs("div",{className:"mt-2 text-red-600",children:[t.jsx("span",{className:"font-medium",children:"Management:"})," ",A.management]})]})},d))});case"conclusions":return a?.immediateOutcomes||a?.recommendations||a?.followUp?t.jsxs("div",{className:"space-y-3 text-sm",children:[a.immediateOutcomes&&t.jsxs("div",{children:[t.jsx("span",{className:"font-medium",children:"Immediate Outcomes:"})," ",a.immediateOutcomes]}),a.recommendations&&t.jsxs("div",{children:[t.jsx("span",{className:"font-medium",children:"Recommendations:"})," ",a.recommendations]}),a.followUp&&t.jsxs("div",{children:[t.jsx("span",{className:"font-medium",children:"Follow-up:"})," ",a.followUp]})]}):t.jsx("div",{className:"text-gray-500 italic text-sm",children:"No conclusions or follow-up documented. Use Edit All Fields to add recommendations."});default:return t.jsx("div",{className:"text-gray-500",children:"Content not available"})}}const WE={high:{bg:"bg-amber-50",text:"text-amber-700",border:"border-amber-200"},medium:{bg:"bg-blue-50",text:"text-blue-700",border:"border-blue-200"},low:{bg:"bg-gray-50",text:"text-gray-600",border:"border-gray-200"}},qE={investigation:"Investigation",medication:"Medication",referral:"Referral","follow-up":"Follow-up",lifestyle:"Lifestyle",monitoring:"Monitoring",other:"Other"},uv=m.memo(({suggestion:s,isSelected:e,onToggle:r,disabled:a})=>{const n=WE[s.priority];return t.jsx(Ye.div,{className:`
        p-3 rounded-lg border transition-all cursor-pointer
        ${e?"border-indigo-300 bg-indigo-50 ring-1 ring-indigo-200":"border-gray-200 bg-white hover:border-gray-300 hover:bg-gray-50"}
        ${a?"opacity-60 cursor-not-allowed":""}
      `,onClick:()=>!a&&r(s.id),whileHover:a?{}:{scale:1.01},whileTap:a?{}:{scale:.99},layout:!0,children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"flex-shrink-0 pt-0.5",children:e?t.jsx(ll,{className:"w-5 h-5 text-indigo-600"}):t.jsx(dc,{className:"w-5 h-5 text-gray-400"})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2 flex-wrap mb-1",children:[t.jsx("h4",{className:"font-medium text-gray-900 text-sm",children:s.title}),t.jsx("span",{className:`
              px-2 py-0.5 text-xs rounded-full border
              ${n.bg} ${n.text} ${n.border}
            `,children:s.priority}),s.category&&t.jsx("span",{className:"px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600 border border-gray-200",children:qE[s.category]||s.category})]}),t.jsx("p",{className:"text-gray-600 text-sm mb-2",children:s.reason}),t.jsxs("div",{className:"text-gray-800 text-sm italic bg-gray-50 p-2 rounded border border-gray-100",children:[t.jsx(t2,{className:"w-3 h-3 inline-block mr-1 text-gray-400"}),'"',s.suggestedText,'"']})]})]})})});uv.displayName="SuggestionItem";const mv=m.memo(({status:s,result:e,onIntegrate:r,onUndo:a,canUndo:n=!1,isIntegrating:i=!1,integrationError:o=null})=>{const[l,c]=m.useState(new Set),[A,d]=m.useState(!0),h=e?.suggestions&&e.suggestions.length>0,f=e?.suggestions||[],u=h?A:!1,x=m.useCallback(C=>{c(E=>{const T=new Set(E);return T.has(C)?T.delete(C):T.add(C),T})},[]),b=m.useCallback(()=>{c(new Set(f.map(C=>C.id)))},[f]),N=m.useCallback(()=>{c(new Set)},[]),v=m.useCallback(async()=>{const C=f.filter(E=>l.has(E.id));C.length>0&&(await r(C),c(new Set))},[f,l,r]),j=l.size,I=j===f.length&&f.length>0;return s==="pending"||s==="processing"?t.jsx(Ye.div,{className:"rounded-lg border border-indigo-200 bg-indigo-50 overflow-hidden",initial:"hidden",animate:"visible",variants:Na(Ci),children:t.jsxs("div",{className:"px-4 py-3 flex items-center gap-3",children:[t.jsx(Za,{className:"w-5 h-5 text-indigo-600 animate-spin"}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-indigo-800 font-medium text-sm",children:"Analyzing for Next Steps..."}),t.jsx("p",{className:"text-indigo-600 text-xs",children:"Reviewing letter for potential clinical considerations"})]})]})}):s==="idle"||s==="error"&&!e?null:t.jsxs(Ye.div,{className:"rounded-lg border border-indigo-200 bg-white overflow-hidden",initial:"hidden",animate:"visible",variants:Na(Ci),children:[t.jsxs("div",{className:`
          px-4 py-3 flex items-center justify-between cursor-pointer
          ${h?"bg-indigo-50 border-b border-indigo-100":"bg-gray-50"}
        `,onClick:()=>h&&d(!A),children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(wy,{className:`w-5 h-5 ${h?"text-indigo-600":"text-gray-400"}`}),t.jsxs("div",{children:[t.jsx("h3",{className:`font-medium text-sm ${h?"text-indigo-800":"text-gray-600"}`,children:"Next-Step Suggestions"}),h?t.jsxs("p",{className:"text-indigo-600 text-xs",children:[f.length," suggestion",f.length!==1?"s":""," for consideration"]}):t.jsx("p",{className:"text-gray-500 text-xs",children:"No additional next steps identified for this patient"})]})]}),h&&t.jsxs("div",{className:"flex items-center gap-2",children:[n&&a&&t.jsxs("button",{type:"button",onClick:C=>{C.stopPropagation(),a()},className:"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors",children:[t.jsx(Cy,{className:"w-3.5 h-3.5"}),t.jsx("span",{children:"Undo"})]}),u?t.jsx(Vr,{className:"w-5 h-5 text-indigo-400"}):t.jsx(ps,{className:"w-5 h-5 text-indigo-400"})]})]}),t.jsx(as,{children:u&&h&&t.jsxs(Ye.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:Ho.normal},children:[t.jsx("div",{className:"px-4 py-2 bg-gray-50 border-b border-gray-100 flex items-center justify-between",children:t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("button",{onClick:I?N:b,className:"text-sm text-indigo-600 hover:text-indigo-800 flex items-center gap-1",disabled:i,children:I?t.jsxs(t.Fragment,{children:[t.jsx(dc,{className:"w-4 h-4"}),"Clear all"]}):t.jsxs(t.Fragment,{children:[t.jsx(ll,{className:"w-4 h-4"}),"Select all"]})}),j>0&&t.jsxs("span",{className:"text-sm text-gray-500",children:[j," selected"]})]})}),t.jsx("div",{className:"p-4 space-y-3 max-h-96 overflow-y-auto",children:f.map(C=>t.jsx(uv,{suggestion:C,isSelected:l.has(C.id),onToggle:x,disabled:i},C.id))}),o&&t.jsx("div",{className:"px-4 py-2 bg-red-50 border-t border-red-100",children:t.jsxs("div",{className:"flex items-center gap-2 text-red-700 text-sm",children:[t.jsx(or,{className:"w-4 h-4"}),o]})}),t.jsxs("div",{className:"px-3 py-2.5 bg-gray-50 border-t border-gray-100 flex flex-col gap-2",children:[t.jsx("p",{className:"text-xs text-gray-500 leading-tight",children:"Selected suggestions will be smoothly integrated into your letter."}),t.jsx("button",{type:"button",onClick:v,disabled:j===0||i,className:"w-full inline-flex items-center justify-center gap-1.5 px-3 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300 disabled:cursor-not-allowed rounded-md transition-colors",children:i?t.jsxs(t.Fragment,{children:[t.jsx(Za,{className:"w-4 h-4 animate-spin"}),t.jsx("span",{children:"Integrating..."})]}):t.jsxs(t.Fragment,{children:[t.jsx(Ms,{className:"w-4 h-4"}),t.jsx("span",{children:"Integrate into Letter"})]})})]})]})}),t.jsx(as,{children:!h&&s==="completed"&&t.jsx(Ye.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"px-4 py-3 text-gray-500 text-sm",children:t.jsx("p",{children:"The letter appears complete based on the patient's context and current plan. No gaps were identified that would warrant additional clinical considerations."})})})]})});mv.displayName="NextStepSuggestionsCard";const am=[{key:"lm",label:"Left Main",abbrev:"LM",color:"bg-amber-400",textColor:"text-amber-700",branches:[{id:"lm-trunk",label:"Left Main Trunk",abbrevs:["LM","LMCA","Left Main","left main"],segments:["ostial","mid","distal"]}]},{key:"lad",label:"Left Anterior Descending",abbrev:"LAD",color:"bg-rose-400",textColor:"text-rose-700",branches:[{id:"lad-trunk",label:"LAD",abbrevs:["LAD","Left Anterior Descending","left anterior descending"],segments:["proximal","mid","distal"]},{id:"d1",label:"Diagonal 1",abbrevs:["D1","Diag1","Diagonal 1","first diagonal","Diagonal"],segments:["proximal","mid","distal"]},{id:"d2",label:"Diagonal 2",abbrevs:["D2","Diag2","Diagonal 2","second diagonal"],segments:["proximal","mid","distal"]},{id:"s1",label:"Septal 1",abbrevs:["S1","Sept1","Septal 1","first septal","Septal"],segments:[]},{id:"s2",label:"Septal 2",abbrevs:["S2","Sept2","Septal 2","second septal"],segments:[]}]},{key:"lcx",label:"Left Circumflex",abbrev:"LCx",color:"bg-sky-400",textColor:"text-sky-700",branches:[{id:"lcx-trunk",label:"LCx",abbrevs:["LCx","Cx","Circumflex","left circumflex","circ"],segments:["proximal","mid","distal"]},{id:"om1",label:"Obtuse Marginal 1",abbrevs:["OM1","OM 1","OM-1","Obtuse Marginal 1","first obtuse marginal","OM"],segments:["proximal","mid","distal"]},{id:"om2",label:"Obtuse Marginal 2",abbrevs:["OM2","OM 2","OM-2","Obtuse Marginal 2","second obtuse marginal"],segments:["proximal","mid","distal"]},{id:"om3",label:"Obtuse Marginal 3",abbrevs:["OM3","OM 3","OM-3","Obtuse Marginal 3","third obtuse marginal"],segments:["proximal","mid","distal"]},{id:"ramus",label:"Ramus Intermedius",abbrevs:["Ramus","RI","Ramus Intermedius","intermediate"],segments:["proximal","mid","distal"]},{id:"lpl",label:"Left Posterolateral",abbrevs:["LPL","LPDA","Left Posterolateral"],segments:["proximal","distal"]}]},{key:"rca",label:"Right Coronary Artery",abbrev:"RCA",color:"bg-emerald-400",textColor:"text-emerald-700",branches:[{id:"rca-trunk",label:"RCA",abbrevs:["RCA","Right Coronary","right coronary artery"],segments:["proximal","mid","distal"]},{id:"am",label:"Acute Marginal",abbrevs:["AM","Acute Marginal","acute marginal"],segments:[]},{id:"pda",label:"Posterior Descending",abbrevs:["PDA","RPDA","Posterior Descending","posterior descending artery"],segments:["proximal","distal"]},{id:"plv",label:"Posterolateral",abbrevs:["PLV","RPL","Posterolateral","posterolateral"],segments:[]}]},{key:"grafts",label:"Grafts",abbrev:"Grafts",color:"bg-indigo-400",textColor:"text-indigo-700",branches:[{id:"lima",label:"LIMA",abbrevs:["LIMA","Left Internal Mammary","LIMA to LAD"],segments:["proximal","mid","distal"]},{id:"rima",label:"RIMA",abbrevs:["RIMA","Right Internal Mammary"],segments:["proximal","mid","distal"]},{id:"svg",label:"SVG",abbrevs:["SVG","Saphenous Vein Graft","vein graft"],segments:["proximal","mid","distal"]},{id:"radial",label:"Radial Graft",abbrevs:["Radial","radial graft","radial artery graft"],segments:["proximal","mid","distal"]}]}],ap=new Map;am.forEach(s=>{s.branches.forEach(e=>{e.abbrevs.forEach(r=>{ap.set(r.toLowerCase(),s.key)})})});function JE(s){const e=s.toLowerCase().trim();if(ap.has(e))return ap.get(e);for(const r of am)for(const a of r.branches)for(const n of a.abbrevs){const i=n.toLowerCase();if(e.includes(i)||i.includes(e))return r.key}return null}function YE(s){return am.find(e=>e.key===s)??null}function XE(s,e){const r=JE(s);return r===null?{isMisplaced:!1,correctVessel:null}:r!==e?{isMisplaced:!0,correctVessel:r}:{isMisplaced:!1,correctVessel:null}}const ZE=({lesionTree:s,onLesionMove:e,onLesionChange:r,onLesionAdd:a,onLesionRemove:n,readOnly:i=!1})=>{const[o,l]=m.useState(()=>{const C=new Set;return Object.entries(s).forEach(([E,T])=>{T.length>0&&C.add(E)}),C}),[c,A]=m.useState(null),[d,h]=m.useState(null),f=m.useMemo(()=>{const C={lm:0,lad:0,lcx:0,rca:0,grafts:0};return Object.entries(s).forEach(([E,T])=>{C[E]=T.length}),C},[s]),u=m.useMemo(()=>Object.values(f).reduce((C,E)=>C+E,0),[f]),x=m.useCallback(C=>{l(E=>{const T=new Set(E);return T.has(C)?T.delete(C):T.add(C),T})},[]),b=m.useCallback((C,E,T)=>{C.dataTransfer.effectAllowed="move",C.dataTransfer.setData("text/plain",E),A({lesionId:E,sourceVessel:T})},[]),N=m.useCallback((C,E)=>{C.preventDefault(),C.dataTransfer.dropEffect="move",c&&c.sourceVessel!==E&&h(E)},[c]),v=m.useCallback(()=>{h(null)},[]),j=m.useCallback((C,E)=>{C.preventDefault(),c&&c.sourceVessel!==E&&e(c.lesionId,c.sourceVessel,E),A(null),h(null)},[c,e]),I=m.useCallback(()=>{A(null),h(null)},[]);return t.jsxs("div",{className:"coronary-anatomy-tree",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3 px-1",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:"Coronary Findings"}),t.jsxs("span",{className:"px-1.5 py-0.5 text-[10px] font-medium bg-gray-100 text-gray-600 rounded",children:[u," lesion",u!==1?"s":""]})]}),!i&&t.jsx("span",{className:"text-[10px] text-gray-400",children:"Drag to reorganize"})]}),t.jsx("div",{className:"space-y-1",children:am.map(C=>t.jsx(e4,{vessel:C,lesions:s[C.key]||[],isExpanded:o.has(C.key),onToggle:()=>x(C.key),onLesionChange:(E,T,Q)=>r(C.key,E,T,Q),onLesionAdd:()=>a(C.key),onLesionRemove:E=>n(C.key,E),onDragStart:(E,T)=>b(E,T,C.key),onDragOver:E=>N(E,C.key),onDragLeave:v,onDrop:E=>j(E,C.key),onDragEnd:I,isDropTarget:d===C.key,isDragging:c?.sourceVessel===C.key,draggedLesionId:c?.lesionId??null,readOnly:i},C.key))})]})},e4=({vessel:s,lesions:e,isExpanded:r,onToggle:a,onLesionChange:n,onLesionAdd:i,onLesionRemove:o,onDragStart:l,onDragOver:c,onDragLeave:A,onDrop:d,onDragEnd:h,isDropTarget:f,isDragging:u,draggedLesionId:x,readOnly:b})=>{const N=e.length,v=m.useMemo(()=>{const j=new Map,I=[];return e.forEach(C=>{const E=s.branches.find(T=>T.abbrevs.some(Q=>C.branch.toLowerCase().includes(Q.toLowerCase())));if(E){const T=j.get(E.id)||[];j.set(E.id,[...T,C])}else I.push(C)}),{grouped:j,unassigned:I}},[e,s.branches]);return t.jsxs("div",{className:`vessel-section rounded-lg border transition-all ${f?"border-violet-400 bg-violet-50/50 ring-2 ring-violet-200/50":"border-gray-200 bg-white hover:border-gray-300"}`,onDragOver:c,onDragLeave:A,onDrop:d,children:[t.jsxs("button",{className:"w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-50/50 transition-colors rounded-t-lg",onClick:a,children:[r?t.jsx(ps,{className:"w-3.5 h-3.5 text-gray-400 flex-shrink-0"}):t.jsx(ti,{className:"w-3.5 h-3.5 text-gray-400 flex-shrink-0"}),t.jsx("span",{className:`w-2.5 h-2.5 rounded-full flex-shrink-0 ${s.color}`}),t.jsx("span",{className:"text-sm font-semibold text-gray-800",children:s.abbrev}),t.jsx("span",{className:"text-xs text-gray-400 flex-1 text-left truncate",children:s.label}),N>0?t.jsx("span",{className:`px-1.5 py-0.5 text-[10px] font-medium rounded-full ${s.color} text-white`,children:N}):t.jsx("span",{className:"text-[10px] text-gray-300",children:"-"})]}),r&&t.jsxs("div",{className:"px-2 pb-2",children:[t.jsxs("div",{className:"ml-2 border-l border-gray-200",children:[s.branches.map((j,I)=>{const C=v.grouped.get(j.id)||[],E=I===s.branches.length-1&&v.unassigned.length===0;return t.jsx(t4,{branch:j,lesions:C,vesselKey:s.key,vesselColor:s.color,isLast:E,onLesionChange:n,onLesionRemove:o,onDragStart:l,onDragEnd:h,draggedLesionId:x,readOnly:b},j.id)}),v.unassigned.length>0&&t.jsxs("div",{className:"relative pl-4 py-1",children:[t.jsx("div",{className:"absolute left-0 top-0 w-4 h-3 border-l border-b border-gray-200 rounded-bl"}),t.jsx("div",{className:"text-[10px] text-gray-400 font-medium mb-1",children:"Other"}),t.jsx("div",{className:"space-y-1",children:v.unassigned.map(j=>t.jsx(hv,{lesion:j,vesselKey:s.key,vesselColor:s.color,onDragStart:l,onDragEnd:h,onChange:n,onRemove:o,readOnly:b,isDragging:x===j.id},j.id))})]})]}),N===0&&t.jsx("div",{className:"ml-6 text-[10px] text-gray-400 py-2 italic",children:"No lesions"}),!b&&t.jsxs("button",{onClick:j=>{j.stopPropagation(),i()},className:"ml-6 mt-1 flex items-center gap-1 text-[10px] text-violet-600 hover:text-violet-700 hover:bg-violet-50 px-2 py-1 rounded transition-colors",children:[t.jsx(Fr,{className:"w-3 h-3"}),"Add lesion"]})]})]})},t4=({branch:s,lesions:e,vesselKey:r,vesselColor:a,isLast:n,onLesionChange:i,onLesionRemove:o,onDragStart:l,onDragEnd:c,draggedLesionId:A,readOnly:d})=>e.length===0?null:t.jsxs("div",{className:"relative pl-4 py-1",children:[t.jsx("div",{className:"absolute left-0 top-3 w-4 h-px bg-gray-200"}),!n&&t.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-px bg-gray-200"}),t.jsx("div",{className:"text-[10px] text-gray-500 font-medium mb-1",children:s.label}),t.jsx("div",{className:"space-y-1",children:e.map(h=>t.jsx(hv,{lesion:h,vesselKey:r,vesselColor:a,onDragStart:l,onDragEnd:c,onChange:i,onRemove:o,readOnly:d,isDragging:A===h.id},h.id))})]}),hv=({lesion:s,vesselKey:e,vesselColor:r,onDragStart:a,onDragEnd:n,onChange:i,onRemove:o,readOnly:l,isDragging:c})=>{const{isMisplaced:A,correctVessel:d}=XE(s.branch,e),h=d?YE(d):null;return t.jsxs("div",{draggable:!l,onDragStart:f=>a(f,s.id),onDragEnd:n,className:`lesion-card relative flex items-start gap-1.5 p-2 rounded-md border transition-all ${c?"opacity-40 bg-gray-100 border-gray-300 scale-95":A?"bg-amber-50 border-amber-200 hover:border-amber-300":"bg-white border-gray-200 hover:border-violet-300 hover:shadow-sm"} ${l?"":"cursor-grab active:cursor-grabbing"}`,children:[!l&&t.jsx("div",{className:"flex-shrink-0 mt-0.5 text-gray-300 hover:text-gray-400",children:t.jsx(cu,{className:"w-3.5 h-3.5"})}),t.jsx("div",{className:`absolute left-0 top-0 bottom-0 w-1 rounded-l-md ${r}`}),t.jsxs("div",{className:"flex-1 min-w-0 pl-0.5",children:[A&&h&&t.jsxs("div",{className:"flex items-center gap-1 text-[10px] text-amber-600 mb-1",children:[t.jsx(xr,{className:"w-3 h-3"}),t.jsxs("span",{children:["Should be under ",t.jsx("strong",{children:h.abbrev})," - drag to move"]})]}),t.jsxs("div",{className:"flex items-center gap-1.5 mb-1",children:[t.jsx("input",{className:"flex-1 min-w-0 rounded border border-gray-200 bg-gray-50 px-1.5 py-1 text-xs font-medium text-gray-900 focus:border-violet-400 focus:bg-white focus:outline-none focus:ring-1 focus:ring-violet-200",value:s.branch,onChange:f=>i(s.id,"branch",f.target.value),placeholder:"Branch",disabled:l}),t.jsx("input",{className:"w-20 flex-shrink-0 rounded border border-gray-200 bg-gray-50 px-1.5 py-1 text-xs text-gray-700 focus:border-violet-400 focus:bg-white focus:outline-none focus:ring-1 focus:ring-violet-200",value:s.severity,onChange:f=>i(s.id,"severity",f.target.value),placeholder:"Severity",disabled:l}),!l&&t.jsx("button",{onClick:()=>o(s.id),className:"p-1 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded transition-colors flex-shrink-0",title:"Remove lesion",children:t.jsx(Ln,{className:"w-3 h-3"})})]}),(s.description||!l)&&t.jsx("textarea",{className:"w-full rounded border border-gray-200 bg-gray-50 px-1.5 py-1 text-[11px] text-gray-600 focus:border-violet-400 focus:bg-white focus:outline-none focus:ring-1 focus:ring-violet-200 resize-none",value:s.description,onChange:f=>i(s.id,"description",f.target.value),placeholder:"Description (characteristics, intervention, etc.)",rows:1,disabled:l})]})]})};async function s4(s,e,r,a,n){const i={lesionId:s,branch:e,fromVessel:r,toVessel:a,timestamp:Date.now(),transcriptionSnippet:n};await kh.getInstance().addLesionPlacementCorrection(i)}const r4=({facts:s,agentLabel:e,onConfirm:r,onCancel:a,groupByCategory:n=!0,showConfidence:i=!1,lesionTree:o,transcriptionSnippet:l})=>{const[c,A]=m.useState(s),[d,h]=m.useState(null),[f,u]=m.useState(""),[x,b]=m.useState(new Set),[N]=m.useState(Date.now()),[v,j]=m.useState(o??null),[I,C]=m.useState(!0);m.useEffect(()=>{if(n){const V=new Set(c.map(q=>q.category));b(V)}},[n,c]);const E=m.useMemo(()=>{if(!n)return[{category:"All Facts",facts:c,allConfirmed:c.every(q=>q.status!=="pending")}];const V=new Map;return c.forEach(q=>{V.has(q.category)||V.set(q.category,[]),V.get(q.category).push(q)}),Array.from(V.entries()).map(([q,S])=>({category:q,facts:S,allConfirmed:S.every(H=>H.status!=="pending")}))},[c,n]),T=m.useMemo(()=>c.every(V=>V.status!=="pending"),[c]),Q=m.useMemo(()=>({editsCount:c.filter(V=>V.status==="edited").length,rejectsCount:c.filter(V=>V.status==="rejected").length,confirmedCount:c.filter(V=>V.status==="confirmed").length,pendingCount:c.filter(V=>V.status==="pending").length}),[c]),D=V=>{A(q=>q.map(S=>S.id===V?{...S,status:"confirmed"}:S))},k=V=>{h(V.id),u(V.value)},R=V=>{A(q=>q.map(S=>S.id===V?{...S,originalValue:S.originalValue||S.value,value:f,status:"edited"}:S)),h(null),u("")},w=()=>{h(null),u("")},L=V=>{A(q=>q.map(S=>S.id===V?{...S,status:"rejected"}:S))},M=V=>{b(q=>{const S=new Set(q);return S.has(V)?S.delete(V):S.add(V),S})},P=m.useCallback((V,q,S)=>{if(!v)return;const H=v[q].find(Y=>Y.id===V);H&&(j(Y=>Y&&{...Y,[q]:Y[q].filter(te=>te.id!==V),[S]:[...Y[S],H]}),s4(V,H.branch,q,S,l))},[v,l]),K=m.useCallback((V,q,S,H)=>{j(Y=>Y&&{...Y,[V]:Y[V].map(te=>te.id===q?{...te,[S]:H}:te)})},[]),$=m.useCallback(V=>{const q={id:`manual-${Date.now()}`,branch:"",severity:"",description:""};j(S=>S&&{...S,[V]:[...S[V],q]})},[]),O=m.useCallback((V,q)=>{j(S=>S&&{...S,[V]:S[V].filter(H=>H.id!==q)})},[]),W=()=>{const V=Date.now()-N,q={facts:c,action:"confirmed",modeUsed:"visual",timeSpent:V,completedAt:Date.now(),editsCount:Q.editsCount,rejectsCount:Q.rejectsCount,refinedLesions:v??void 0};r(q)},ee=()=>{a()};return t.jsxs("div",{className:"visual-proof-mode",children:[t.jsxs("div",{className:"proof-mode-header",children:[t.jsxs("h3",{className:"text-base font-semibold text-gray-900 dark:text-gray-100",children:["Verify Key Facts ‚Äî ",e]}),t.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 mt-1 leading-relaxed",children:"Review critical procedural details before generating the report. Use keyboard to confirm (‚úì) or edit values."})]}),t.jsxs("div",{className:"stats-bar flex flex-wrap gap-3 text-xs mt-3 mb-4",children:[t.jsxs("div",{className:"stat",children:[t.jsx("span",{className:"font-medium text-gray-600 dark:text-gray-300",children:"Total:"})," ",t.jsx("span",{className:"text-gray-900 dark:text-gray-100",children:c.length})]}),t.jsxs("div",{className:"stat",children:[t.jsx("span",{className:"font-medium text-emerald-700 dark:text-emerald-400",children:"Confirmed:"})," ",t.jsx("span",{className:"text-emerald-900 dark:text-emerald-100",children:Q.confirmedCount})]}),Q.editsCount>0&&t.jsxs("div",{className:"stat",children:[t.jsx("span",{className:"font-medium text-blue-700 dark:text-blue-400",children:"Edited:"})," ",t.jsx("span",{className:"text-blue-900 dark:text-blue-100",children:Q.editsCount})]}),Q.rejectsCount>0&&t.jsxs("div",{className:"stat",children:[t.jsx("span",{className:"font-medium text-rose-700 dark:text-rose-400",children:"Flagged:"})," ",t.jsx("span",{className:"text-rose-900 dark:text-rose-100",children:Q.rejectsCount})]}),Q.pendingCount>0&&t.jsxs("div",{className:"stat",children:[t.jsx("span",{className:"font-medium text-amber-700 dark:text-amber-400",children:"Pending:"})," ",t.jsx("span",{className:"text-amber-900 dark:text-amber-100",children:Q.pendingCount})]})]}),t.jsx("div",{className:"fact-groups space-y-2 max-h-[40vh] overflow-y-auto",children:E.map(V=>t.jsxs("div",{className:"fact-group",children:[n&&t.jsxs("button",{onClick:()=>M(V.category),className:"category-header w-full flex items-center justify-between px-3 py-1.5 bg-gray-100 dark:bg-gray-800 rounded-t hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[x.has(V.category)?t.jsx(ps,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"}):t.jsx(ti,{className:"w-4 h-4 text-gray-600 dark:text-gray-400"}),t.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-gray-100 capitalize",children:V.category}),t.jsxs("span",{className:"text-[11px] text-gray-500 dark:text-gray-500",children:["(",V.facts.length,")"]})]}),V.allConfirmed&&t.jsx(Ms,{className:"w-4 h-4 text-emerald-600 dark:text-emerald-400"})]}),(!n||x.has(V.category))&&t.jsx("div",{className:"facts-list space-y-2 p-2",children:V.facts.map(q=>t.jsx(a4,{fact:q,isEditing:d===q.id,editValue:f,showConfidence:i,onConfirm:()=>D(q.id),onStartEdit:()=>k(q),onSaveEdit:()=>R(q.id),onCancelEdit:w,onReject:()=>L(q.id),onEditValueChange:u},q.id))})]},V.category))}),v&&t.jsxs("div",{className:"coronary-findings-section mt-4 border-t border-gray-200 dark:border-gray-700 pt-4",children:[t.jsxs("button",{onClick:()=>C(!I),className:"w-full flex items-center justify-between mb-3 group",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[I?t.jsx(ps,{className:"w-4 h-4 text-gray-500 group-hover:text-gray-700 dark:group-hover:text-gray-300"}):t.jsx(ti,{className:"w-4 h-4 text-gray-500 group-hover:text-gray-700 dark:group-hover:text-gray-300"}),t.jsx("span",{className:"text-sm font-semibold text-gray-900 dark:text-gray-100",children:"Coronary Findings"})]}),t.jsx("span",{className:"text-[10px] text-gray-400 dark:text-gray-500",children:"Drag lesions to reorganize"})]}),I&&t.jsx("div",{className:"max-h-[30vh] overflow-y-auto",children:t.jsx(ZE,{lesionTree:v,onLesionMove:P,onLesionChange:K,onLesionAdd:$,onLesionRemove:O})})]}),t.jsxs("div",{className:"action-buttons flex gap-3 mt-6 pt-4 border-t border-gray-200 dark:border-gray-700",children:[t.jsx(ye,{onClick:ee,variant:"secondary",size:"sm",className:"flex-1 h-auto py-2 text-sm leading-tight",children:"Cancel"}),t.jsx(ye,{onClick:W,variant:"primary",disabled:!T,size:"sm",className:"flex-1 h-auto py-2 text-sm leading-tight whitespace-normal",children:T?"Generate Report":`Review ${Q.pendingCount} remaining`})]})]})},a4=({fact:s,isEditing:e,editValue:r,showConfidence:a,onConfirm:n,onStartEdit:i,onSaveEdit:o,onCancelEdit:l,onReject:c,onEditValueChange:A})=>{const d={pending:"border-amber-300 dark:border-amber-700 bg-amber-50 dark:bg-amber-950/30",confirmed:"border-emerald-300 dark:border-emerald-700 bg-emerald-50 dark:bg-emerald-950/30",edited:"border-blue-300 dark:border-blue-700 bg-blue-50 dark:bg-blue-950/30",rejected:"border-rose-300 dark:border-rose-700 bg-rose-50 dark:bg-rose-950/30"},h={pending:null,confirmed:t.jsx(Ms,{className:"w-4 h-4 text-emerald-600 dark:text-emerald-400"}),edited:t.jsx(si,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"}),rejected:t.jsx(or,{className:"w-4 h-4 text-rose-600 dark:text-rose-400"})};return t.jsxs("div",{className:`fact-card border-l-4 p-2.5 rounded-md ${d[s.status]}`,children:[t.jsx("div",{className:"fact-header flex items-start justify-between mb-2",children:t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-xs font-semibold text-gray-900 dark:text-gray-100",children:s.label}),h[s.status],s.critical&&t.jsx("span",{className:"text-[10px] px-1.5 py-0.5 bg-rose-100 dark:bg-rose-900/30 text-rose-700 dark:text-rose-300 rounded font-medium",children:"CRITICAL"})]}),a&&s.confidence!==void 0&&t.jsxs("span",{className:"text-[11px] text-gray-500 dark:text-gray-500",children:["Confidence: ",(s.confidence*100).toFixed(0),"%"]})]})}),e?t.jsxs("div",{className:"edit-controls space-y-2",children:[t.jsx("input",{type:"text",value:r,onChange:f=>A(f.target.value),className:"w-full px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-900 text-sm text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent",autoFocus:!0,onKeyDown:f=>{f.key==="Enter"&&o(),f.key==="Escape"&&l()}}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:o,className:"px-3 py-1 text-xs font-medium bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors",children:"Save"}),t.jsx("button",{onClick:l,className:"px-3 py-1 text-xs font-medium bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 rounded transition-colors",children:"Cancel"})]})]}):t.jsxs("div",{className:"value-display",children:[t.jsxs("p",{className:"text-sm font-medium text-gray-900 dark:text-gray-100 mb-2",children:[s.value,s.unit&&t.jsx("span",{className:"text-xs text-gray-600 dark:text-gray-400 ml-1",children:s.unit})]}),s.status==="edited"&&s.originalValue&&t.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-500",children:["Original: ",t.jsx("span",{className:"line-through",children:s.originalValue})]}),s.status==="pending"&&t.jsxs("div",{className:"action-buttons flex gap-2 mt-2",children:[t.jsxs("button",{onClick:n,className:"px-3 py-1 text-xs font-medium bg-emerald-600 hover:bg-emerald-700 text-white rounded flex items-center gap-1 transition-colors",children:[t.jsx(Ms,{className:"w-3 h-3"}),"Confirm"]}),t.jsxs("button",{onClick:i,className:"px-3 py-1 text-xs font-medium bg-blue-600 hover:bg-blue-700 text-white rounded flex items-center gap-1 transition-colors",children:[t.jsx(si,{className:"w-3 h-3"}),"Edit"]}),t.jsxs("button",{onClick:c,className:"px-3 py-1 text-xs font-medium bg-rose-600 hover:bg-rose-700 text-white rounded flex items-center gap-1 transition-colors",children:[t.jsx(es,{className:"w-3 h-3"}),"Flag"]})]})]})]})},pv="http://localhost:8001",n4=`${pv}/v1/audio/synthesis`;class i4{audioContext=null;currentSource=null;isPlaying=!1;async checkTTSAvailability(){try{const e=await fetch(`${pv}/v1/health`);if(!e.ok)return{ttsEnabled:!1,status:"error"};const r=await e.json();return{ttsEnabled:r.features?.tts_enabled||!1,model:r.tts_model||void 0,status:r.tts_status||"not_loaded"}}catch(e){return console.error("[TTSService] Health check failed:",e),{ttsEnabled:!1,status:"error"}}}async synthesize(e){const{text:r,speed:a=1}=e,n=Math.max(.5,Math.min(2,a));console.log(`[TTSService] Synthesizing: "${r.substring(0,50)}..." (speed: ${n}x)`);try{const i=await fetch(n4,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:r,speed:n})});if(!i.ok){const l=await i.json();throw new Error(l.message||`TTS synthesis failed: ${i.status}`)}const o=await i.blob();return console.log(`[TTSService] Synthesis complete: ${o.size} bytes`),o}catch(i){throw console.error("[TTSService] Synthesis error:",i),i}}async play(e,r){this.stop();try{this.audioContext||(this.audioContext=new AudioContext),this.audioContext.state==="suspended"&&await this.audioContext.resume();const a=await e.arrayBuffer(),n=await this.audioContext.decodeAudioData(a);this.currentSource=this.audioContext.createBufferSource(),this.currentSource.buffer=n,this.currentSource.connect(this.audioContext.destination),this.currentSource.onended=()=>{this.isPlaying=!1,this.currentSource=null,console.log("[TTSService] Playback ended"),r&&r()},this.currentSource.start(0),this.isPlaying=!0,console.log("[TTSService] Playback started")}catch(a){throw console.error("[TTSService] Playback error:",a),this.isPlaying=!1,this.currentSource=null,a}}stop(){if(this.currentSource&&this.isPlaying){try{this.currentSource.stop()}catch(e){console.warn("[TTSService] Stop warning:",e)}this.currentSource=null,this.isPlaying=!1,console.log("[TTSService] Playback stopped")}}getPlaybackState(){return{isPlaying:this.isPlaying}}dispose(){this.stop(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),console.log("[TTSService] Disposed")}async synthesizeAndPlay(e,r){const a=await this.synthesize(e);await this.play(a,r)}}const Wn=new i4,o4=({facts:s,agentLabel:e,onConfirm:r,onCancel:a,ttsSpeed:n=.9,autoAdvance:i=!1})=>{const[o,l]=m.useState(s),[c,A]=m.useState(0),[d,h]=m.useState("idle"),[f,u]=m.useState(!0),[x,b]=m.useState(null),[N,v]=m.useState(""),[j]=m.useState(Date.now()),I=m.useRef([]),C=m.useRef(!1),E=o[c],T=c===o.length-1;m.useEffect(()=>(Wn.checkTTSAvailability().then(V=>{u(V.ttsEnabled),V.ttsEnabled||console.warn("[AudioProofMode] TTS not available, audio mode degraded")}),()=>{Wn.stop()}),[]),m.useEffect(()=>{if(!f)return;(async()=>{const q=[];for(const S of o)try{const H=`${S.label}: ${S.value}${S.unit?` ${S.unit}`:""}`,Y=await Wn.synthesize({text:H,speed:n});q.push(Y)}catch(H){console.error(`[AudioProofMode] Failed to generate TTS for fact ${S.id}:`,H),q.push(new Blob)}I.current=q,console.log(`[AudioProofMode] Pre-generated TTS for ${q.length} facts`)})()},[o,n,f]);const Q=m.useMemo(()=>({editsCount:o.filter(V=>V.status==="edited").length,rejectsCount:o.filter(V=>V.status==="rejected").length,confirmedCount:o.filter(V=>V.status==="confirmed").length,pendingCount:o.filter(V=>V.status==="pending").length}),[o]),D=m.useMemo(()=>o.every(V=>V.status!=="pending"),[o]),k=async()=>{if(!f||c>=I.current.length){console.warn("[AudioProofMode] Cannot play: TTS unavailable or no audio blob");return}const V=I.current[c];if(!V||V.size===0){console.warn("[AudioProofMode] Empty audio blob, skipping");return}try{h("playing"),C.current=!0,await Wn.play(V,()=>{C.current=!1,h("idle"),i&&c<o.length-1&&setTimeout(()=>{A(q=>q+1)},500)})}catch(q){console.error("[AudioProofMode] Playback error:",q),h("idle"),C.current=!1}},R=()=>{d==="playing"?(Wn.stop(),h("paused"),C.current=!1):k()},w=()=>{c<o.length-1&&(Wn.stop(),h("idle"),C.current=!1,A(V=>V+1))},L=()=>{c>0&&(Wn.stop(),h("idle"),C.current=!1,A(V=>V-1))},M=()=>{l(V=>V.map(q=>q.id===E.id?{...q,status:"confirmed"}:q)),T||w()},P=()=>{b(E.id),v(E.value),Wn.stop(),h("idle")},K=()=>{l(V=>V.map(q=>q.id===E.id?{...q,originalValue:q.originalValue||q.value,value:N,status:"edited"}:q)),b(null),v(""),T||w()},$=()=>{b(null),v("")},O=()=>{l(V=>V.map(q=>q.id===E.id?{...q,status:"rejected"}:q)),T||w()},W=()=>{const V=Date.now()-j,q={facts:o,action:"confirmed",modeUsed:"audio",timeSpent:V,completedAt:Date.now(),editsCount:Q.editsCount,rejectsCount:Q.rejectsCount};r(q)},ee=()=>{Wn.stop(),a()};return m.useEffect(()=>{const V=q=>{if(!x)switch(q.key.toLowerCase()){case" ":q.preventDefault(),R();break;case"c":q.preventDefault(),M();break;case"e":q.preventDefault(),P();break;case"f":q.preventDefault(),O();break;case"arrowright":case"n":q.preventDefault(),w();break;case"arrowleft":case"p":q.preventDefault(),L();break}};return window.addEventListener("keydown",V),()=>window.removeEventListener("keydown",V)},[c,d,x]),E?t.jsxs("div",{className:"audio-proof-mode",children:[t.jsxs("div",{className:"proof-mode-header mb-6",children:[t.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:[t.jsx(cc,{className:"w-5 h-5 inline mr-2"}),"Audio Verification ‚Äî ",e]}),t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:"Listen to each fact and confirm, edit, or flag. Use keyboard shortcuts for quick navigation."})]}),t.jsxs("div",{className:"progress-bar mb-4",children:[t.jsxs("div",{className:"flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1",children:[t.jsxs("span",{children:["Fact ",c+1," of ",o.length]}),t.jsxs("span",{children:[Q.confirmedCount+Q.editsCount," reviewed"]})]}),t.jsx("div",{className:"w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden",children:t.jsx("div",{className:"h-full bg-emerald-600 dark:bg-emerald-500 transition-all duration-300",style:{width:`${(c+1)/o.length*100}%`}})})]}),t.jsxs("div",{className:"fact-card border-2 border-gray-300 dark:border-gray-600 rounded-lg p-6 bg-white dark:bg-gray-900 mb-6",children:[t.jsxs("div",{className:"flex items-start justify-between mb-4",children:[t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wide",children:E.category}),E.critical&&t.jsx("span",{className:"text-xs px-2 py-0.5 bg-rose-100 dark:bg-rose-900/30 text-rose-700 dark:text-rose-300 rounded font-medium",children:"CRITICAL"})]}),t.jsx("h4",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:E.label})]}),E.status!=="pending"&&t.jsxs("div",{className:"status-badge",children:[E.status==="confirmed"&&t.jsxs("div",{className:"flex items-center gap-1 text-emerald-600 dark:text-emerald-400",children:[t.jsx(Ms,{className:"w-5 h-5"}),t.jsx("span",{className:"text-sm font-medium",children:"Confirmed"})]}),E.status==="edited"&&t.jsxs("div",{className:"flex items-center gap-1 text-blue-600 dark:text-blue-400",children:[t.jsx(si,{className:"w-5 h-5"}),t.jsx("span",{className:"text-sm font-medium",children:"Edited"})]}),E.status==="rejected"&&t.jsxs("div",{className:"flex items-center gap-1 text-rose-600 dark:text-rose-400",children:[t.jsx(or,{className:"w-5 h-5"}),t.jsx("span",{className:"text-sm font-medium",children:"Flagged"})]})]})]}),x===E.id?t.jsxs("div",{className:"edit-controls space-y-3",children:[t.jsx("input",{type:"text",value:N,onChange:V=>v(V.target.value),className:"w-full px-4 py-3 text-lg border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent",autoFocus:!0,onKeyDown:V=>{V.key==="Enter"&&K(),V.key==="Escape"&&$()}}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{onClick:K,className:"px-4 py-2 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded font-medium transition-colors",children:"Save (Enter)"}),t.jsx("button",{onClick:$,className:"px-4 py-2 text-sm bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 rounded font-medium transition-colors",children:"Cancel (Esc)"})]})]}):t.jsxs("div",{children:[t.jsxs("p",{className:"text-2xl font-mono font-semibold text-gray-900 dark:text-gray-100 mb-2",children:[E.value,E.unit&&t.jsx("span",{className:"text-gray-600 dark:text-gray-400 ml-2",children:E.unit})]}),E.status==="edited"&&E.originalValue&&t.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-500",children:["Original: ",t.jsx("span",{className:"line-through",children:E.originalValue})]})]})]}),!x&&f&&t.jsxs("div",{className:"playback-controls flex justify-center gap-3 mb-6",children:[t.jsx("button",{onClick:L,disabled:c===0,className:"px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed rounded font-medium transition-colors",children:"‚Üê Previous (P)"}),t.jsx("button",{onClick:R,className:"px-6 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded font-medium flex items-center gap-2 transition-colors",children:d==="playing"?t.jsxs(t.Fragment,{children:[t.jsx(bp,{className:"w-4 h-4"}),"Pause (Space)"]}):t.jsxs(t.Fragment,{children:[t.jsx(wA,{className:"w-4 h-4"}),"Play (Space)"]})}),t.jsx("button",{onClick:w,disabled:T,className:"px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed rounded font-medium transition-colors",children:"Next (N) ‚Üí"})]}),!f&&t.jsx("div",{className:"tts-warning mb-6 p-4 bg-amber-50 dark:bg-amber-950/30 border border-amber-300 dark:border-amber-700 rounded",children:t.jsxs("p",{className:"text-sm text-amber-900 dark:text-amber-100",children:[t.jsx(or,{className:"w-4 h-4 inline mr-2"}),"TTS not available. Use keyboard shortcuts to navigate facts."]})}),!x&&E.status==="pending"&&t.jsxs("div",{className:"action-buttons flex gap-3 mb-6",children:[t.jsxs("button",{onClick:M,className:"flex-1 px-4 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded font-medium flex items-center justify-center gap-2 transition-colors",children:[t.jsx(Ms,{className:"w-4 h-4"}),"Confirm (C)"]}),t.jsxs("button",{onClick:P,className:"flex-1 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium flex items-center justify-center gap-2 transition-colors",children:[t.jsx(si,{className:"w-4 h-4"}),"Edit (E)"]}),t.jsxs("button",{onClick:O,className:"flex-1 px-4 py-3 bg-rose-600 hover:bg-rose-700 text-white rounded font-medium flex items-center justify-center gap-2 transition-colors",children:[t.jsx(es,{className:"w-4 h-4"}),"Flag (F)"]})]}),t.jsxs("div",{className:"final-actions flex gap-3 pt-4 border-t border-gray-200 dark:border-gray-700",children:[t.jsx(ye,{onClick:ee,variant:"secondary",className:"flex-1",children:"Cancel"}),t.jsx(ye,{onClick:W,variant:"primary",disabled:!D,className:"flex-1",children:D?"Confirm & Generate Report":`Review ${Q.pendingCount} Remaining`})]}),t.jsxs("div",{className:"keyboard-help mt-4 p-3 bg-gray-50 dark:bg-gray-900 rounded text-xs text-gray-600 dark:text-gray-400",children:[t.jsx("p",{className:"font-medium mb-1",children:"Keyboard Shortcuts:"}),t.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1",children:[t.jsxs("span",{children:[t.jsx("kbd",{className:"font-mono",children:"Space"})," Play/Pause"]}),t.jsxs("span",{children:[t.jsx("kbd",{className:"font-mono",children:"C"})," Confirm"]}),t.jsxs("span",{children:[t.jsx("kbd",{className:"font-mono",children:"‚Üê/P"})," Previous"]}),t.jsxs("span",{children:[t.jsx("kbd",{className:"font-mono",children:"E"})," Edit"]}),t.jsxs("span",{children:[t.jsx("kbd",{className:"font-mono",children:"‚Üí/N"})," Next"]}),t.jsxs("span",{children:[t.jsx("kbd",{className:"font-mono",children:"F"})," Flag"]})]})]})]}):t.jsx("div",{className:"text-center text-gray-500",children:"No facts to verify"})},l4=({facts:s,agentLabel:e,onComplete:r,onCancel:a,isOpen:n,initialConfig:i,lesionTree:o,transcriptionSnippet:l})=>{const c=()=>i?.mode==="audio"?"audio":"visual",[A,d]=m.useState({mode:c(),ttsSpeed:i?.ttsSpeed||.9,autoAdvance:i?.autoAdvance||!1,groupByCategory:i?.groupByCategory!==!1,showConfidence:i?.showConfidence||!1}),[h,f]=m.useState(!0),[u,x]=m.useState(!0);m.useEffect(()=>{i&&d(j=>({...j,...i.mode!==void 0?{mode:i.mode}:{},...i.ttsSpeed!==void 0?{ttsSpeed:i.ttsSpeed}:{},...i.autoAdvance!==void 0?{autoAdvance:i.autoAdvance}:{},...i.groupByCategory!==void 0?{groupByCategory:i.groupByCategory}:{},...i.showConfidence!==void 0?{showConfidence:i.showConfidence}:{}}))},[i?.mode,i?.ttsSpeed,i?.autoAdvance,i?.groupByCategory,i?.showConfidence]),m.useEffect(()=>{n&&(async()=>{x(!0);const I=await Wn.checkTTSAvailability();f(I.ttsEnabled),x(!1),!I.ttsEnabled&&A.mode==="audio"&&(console.warn("[KeyFactsProofDialog] TTS unavailable, switching to visual mode"),d(C=>({...C,mode:"visual"})))})()},[n]);const b=j=>{if(j==="audio"&&!h){console.warn("[KeyFactsProofDialog] Cannot switch to audio mode: TTS unavailable");return}d(I=>({...I,mode:j}))},N=j=>{r(j)},v=()=>{A.mode==="audio"&&Wn.stop(),a()};return n?t.jsx(pc,{isOpen:n,onClose:v,title:`Verify Key Facts ‚Äî ${e}`,size:"lg",children:t.jsxs("div",{className:"key-facts-proof-dialog",children:[!u&&h&&A.mode!=="audio"&&t.jsxs("div",{className:"mb-4 flex items-center justify-between gap-3 rounded-lg border border-blue-200 bg-blue-50 px-4 py-3 text-blue-900 dark:border-blue-600/50 dark:bg-blue-950/40 dark:text-blue-100",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(cc,{className:"w-4 h-4 text-blue-600 dark:text-blue-300"}),t.jsx("p",{className:"text-sm font-semibold",children:"Review with audio"})]}),t.jsx("p",{className:"mt-1 text-xs text-blue-700 dark:text-blue-200",children:"Listen to each fact and confirm or edit while it plays."})]}),t.jsx("button",{onClick:()=>b("audio"),className:"shrink-0 rounded-md bg-blue-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2",children:"Enable Audio"})]}),t.jsxs("div",{className:"mode-switcher flex gap-2 mb-6 p-1 bg-gray-100 dark:bg-gray-800 rounded-lg",children:[t.jsxs("button",{type:"button",onClick:()=>b("visual"),disabled:u,className:`flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-md font-medium transition-colors ${A.mode==="visual"?"bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow":"text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"}`,children:[t.jsx(Cp,{className:"w-4 h-4"}),"Visual"]}),t.jsxs("button",{type:"button",onClick:()=>b("audio"),disabled:u||!h,className:`flex-1 flex items-center justify-center gap-2 px-4 py-2 rounded-md font-medium transition-colors ${A.mode==="audio"?"bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 shadow":"text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"} ${!h&&!u?"opacity-50 cursor-not-allowed":""}`,children:[u?t.jsx(Za,{className:"w-4 h-4 animate-spin"}):t.jsx(cc,{className:"w-4 h-4"}),"Audio",!h&&!u&&t.jsx("span",{className:"text-xs",children:"(Unavailable)"})]})]}),!u&&!h&&t.jsxs("div",{className:"tts-warning mb-4 p-3 bg-amber-50 dark:bg-amber-950/30 border border-amber-300 dark:border-amber-700 rounded",children:[t.jsx("p",{className:"text-sm text-amber-900 dark:text-amber-100",children:"Audio mode is unavailable (TTS server not running). Using visual mode."}),t.jsx("p",{className:"text-xs text-amber-700 dark:text-amber-300 mt-1",children:"Start whisper-server.py with mlx-audio to enable audio mode."})]}),t.jsx("div",{className:"proof-mode-content",children:A.mode==="visual"?t.jsx(r4,{facts:s,agentLabel:e,onConfirm:N,onCancel:v,groupByCategory:A.groupByCategory,showConfidence:A.showConfidence,lesionTree:o,transcriptionSnippet:l}):A.mode==="audio"?t.jsx(o4,{facts:s,agentLabel:e,onConfirm:N,onCancel:v,ttsSpeed:A.ttsSpeed,autoAdvance:A.autoAdvance}):null})]})}):null},c4=({report:s,onCopy:e,onInsert:r,onRetry:a,isVisible:n})=>{const[i,o]=m.useState(null),[l,c]=m.useState(null),A=m.useRef(null);if(!n)return null;const d=async(E,T)=>{try{await e(E),o(T),setTimeout(()=>o(null),2e3)}catch(Q){console.error("Failed to copy content:",Q)}},h=async(E,T)=>{try{await r(E),c(T),setTimeout(()=>c(null),2e3)}catch(Q){console.error("Failed to insert content:",Q)}},f=E=>E.map(T=>T.split("_").map(Q=>Q.charAt(0).toUpperCase()+Q.slice(1)).join(" ")).join(", "),u=E=>{switch(E){case"high":return"text-red-700 bg-red-50 border-red-200";case"medium":return"text-amber-700 bg-amber-50 border-amber-200";case"low":return"text-green-700 bg-green-50 border-green-200";default:return"text-gray-700 bg-gray-50 border-gray-200"}},x=()=>!s.warnings||s.warnings.length===0?null:t.jsx("div",{className:"mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg",children:t.jsxs("div",{className:"flex items-start space-x-2",children:[t.jsx(xr,{className:"w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-medium text-amber-800",children:"Content Notice"}),s.warnings.map((E,T)=>t.jsx("p",{className:"text-xs text-amber-700 mt-1",children:E},T))]})]})}),b=()=>!s.errors||s.errors.length===0?null:t.jsx("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg",children:t.jsxs("div",{className:"flex items-start space-x-2",children:[t.jsx(xr,{className:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-medium text-red-800",children:"Generation Issues"}),s.errors.map((E,T)=>t.jsx("p",{className:"text-xs text-red-700 mt-1",children:E},T)),a&&t.jsx(ye,{onClick:a,variant:"ghost",size:"sm",startIcon:t.jsx(Xa,{}),className:"mt-2 bg-red-100 hover:bg-red-200 text-red-800",children:"Regenerate"})]})]})}),N=()=>{const E=s.metadata?.missingInformation;return!E||E.completeness_score==="95%"?null:t.jsx("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:t.jsxs("div",{className:"flex items-start space-x-2",children:[t.jsx(Ma,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),t.jsxs("div",{children:[t.jsxs("p",{className:"text-sm font-medium text-blue-800",children:["Personalization Score: ",E.completeness_score]}),t.jsx("p",{className:"text-xs text-blue-700 mt-1",children:"More specific patient information could help provide even more personalized advice."}),E.recommendations?.length>0&&t.jsxs("div",{className:"mt-2",children:[t.jsx("p",{className:"text-xs font-medium text-blue-800",children:"Suggestions:"}),t.jsx("ul",{className:"text-xs text-blue-700 mt-1 space-y-1",children:E.recommendations.map((T,Q)=>t.jsxs("li",{className:"flex items-start space-x-1",children:[t.jsx("span",{children:"‚Ä¢"}),t.jsx("span",{children:T})]},Q))})]})]})]})})},v=()=>{const{educationData:E}=s;return t.jsx("div",{className:"mb-4 bg-gray-50 rounded-lg p-3",children:t.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[t.jsxs("div",{className:`inline-flex items-center px-2 py-1 rounded-md text-xs font-medium border ${u(E.priority)}`,children:[t.jsx(Zn,{className:"w-3 h-3 mr-1"}),E.priority.charAt(0).toUpperCase()+E.priority.slice(1)," Priority"]}),t.jsxs("div",{children:[t.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Areas Covered: "}),t.jsx("span",{className:"text-xs text-gray-600",children:f(E.modules)})]}),E.australianGuidelines?.length>0&&t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center space-x-1 mb-1",children:[t.jsx(s2,{className:"w-3 h-3 text-green-600"}),t.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Australian Guidelines Referenced:"})]}),t.jsxs("ul",{className:"text-xs text-gray-600 space-y-1",children:[E.australianGuidelines.slice(0,3).map((T,Q)=>t.jsxs("li",{className:"flex items-start space-x-1",children:[t.jsx("span",{children:"‚Ä¢"}),t.jsx("span",{children:T})]},Q)),E.australianGuidelines.length>3&&t.jsxs("li",{className:"text-xs text-gray-500 italic",children:["+",E.australianGuidelines.length-3," more guidelines"]})]})]}),E.patientResources?.length>0&&t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center space-x-1 mb-1",children:[t.jsx(dA,{className:"w-3 h-3 text-blue-600"}),t.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Support Resources Mentioned:"})]}),t.jsxs("ul",{className:"text-xs text-gray-600 space-y-1",children:[E.patientResources.slice(0,3).map((T,Q)=>t.jsxs("li",{className:"flex items-start space-x-1",children:[t.jsx("span",{children:"‚Ä¢"}),t.jsx("span",{children:T})]},Q)),E.patientResources.length>3&&t.jsxs("li",{className:"text-xs text-gray-500 italic",children:["+",E.patientResources.length-3," more resources"]})]})]})]})})},j=()=>{const E=window.open("","_blank");if(!E)return;const T=s.educationData.jsonMetadata;if(!T){alert("No structured data available to export");return}const Q=T.priority_plan||[],D=R=>{const w=R.title?.toLowerCase()||"",L=R.id?.toLowerCase()||"";return w.includes("exercise")||w.includes("physical")||w.includes("activity")||L.includes("physical_activity")?"exercise":w.includes("diet")||w.includes("nutrition")||w.includes("food")||w.includes("fibre")||w.includes("salt")||L.includes("diet_nutrition")?"diet":w.includes("alcohol")||L.includes("alcohol")?"alcohol":w.includes("weight")||w.includes("bmi")||L.includes("weight")?"weight":w.includes("smoking")||w.includes("tobacco")||L.includes("smoking")?"smoking":w.includes("stress")||w.includes("mental")||L.includes("stress")?"mental":"other"},k=Q.map((R,w)=>{const L=D(R),M=R.expected_impact||"medium",K={exercise:{bg:"#EFF6FF",border:"#3B82F6",text:"#1E40AF"},diet:{bg:"#ECFDF5",border:"#10B981",text:"#065F46"},alcohol:{bg:"#F3E8FF",border:"#A855F7",text:"#6B21A8"},weight:{bg:"#FFF7ED",border:"#F97316",text:"#9A3412"},smoking:{bg:"#FEF2F2",border:"#EF4444",text:"#991B1B"},mental:{bg:"#F0FDFA",border:"#14B8A6",text:"#115E59"},other:{bg:"#F9FAFB",border:"#6B7280",text:"#374151"}}[L];return`
        <div style="background: ${K.bg}; border-left: 4px solid ${K.border};
                    padding: 16px; margin-bottom: 16px; border-radius: 8px; page-break-inside: avoid;">
          <div style="display: flex; align-items: start; gap: 12px;">
            <div style="background: white; width: 28px; height: 28px; border-radius: 50%;
                        display: flex; align-items: center; justify-content: center;
                        font-weight: bold; font-size: 14px; color: ${K.text}; flex-shrink: 0;">
              ${w+1}
            </div>
            <div style="flex: 1;">
              <h3 style="margin: 0 0 8px 0; color: ${K.text}; font-size: 16px; font-weight: 600;">
                ${R.title}
              </h3>
              ${R.magnitude_note?`
                <p style="margin: 0 0 8px 0; color: ${K.text}; opacity: 0.9; font-size: 14px;">
                  ${R.magnitude_note}
                </p>
              `:""}
              <p style="margin: 0 0 8px 0; color: ${K.text}; opacity: 0.85; font-size: 13px;">
                <strong>Impact level:</strong> ${M}
              </p>
              ${R.reason?`
                <p style="margin: 0 0 8px 0; color: ${K.text}; opacity: 0.8; font-size: 13px; font-style: italic;">
                  <strong>Why:</strong> ${R.reason}
                </p>
              `:""}
              ${R.next_action?`
                <div style="background: rgba(255,255,255,0.6); padding: 8px; border-radius: 6px; margin-top: 8px;">
                  <p style="margin: 0; font-size: 13px; color: ${K.text};">
                    <strong>Start here:</strong> ${R.next_action}
                  </p>
                </div>
              `:""}
              ${R.habit_cue?`
                <div style="background: rgba(255,255,255,0.6); padding: 8px; border-radius: 6px; margin-top: 6px;">
                  <p style="margin: 0; font-size: 13px; color: ${K.text};">
                    <strong>Habit cue:</strong> ${R.habit_cue}
                  </p>
                </div>
              `:""}
            </div>
          </div>
        </div>
      `}).join("");E.document.write(`
      <!DOCTYPE html>
      <html>
        <head>
          <title>Patient Education Action Plan</title>
          <style>
            @media print {
              body { margin: 0; }
              @page { margin: 1cm; }
            }
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
              padding: 20px;
              max-width: 800px;
              margin: 0 auto;
              line-height: 1.6;
            }
            h1 {
              font-size: 24px;
              margin-bottom: 8px;
              color: #111827;
            }
            .subtitle {
              color: #6B7280;
              font-size: 14px;
              margin-bottom: 24px;
            }
            .legend {
              display: flex;
              flex-wrap: wrap;
              gap: 12px;
              margin-bottom: 24px;
              padding: 16px;
              background: #F9FAFB;
              border-radius: 8px;
            }
            .legend-item {
              display: flex;
              align-items: center;
              gap: 6px;
              font-size: 12px;
            }
            .legend-color {
              width: 16px;
              height: 16px;
              border-radius: 3px;
            }
          </style>
        </head>
        <body>
          <h1>Patient Education Action Plan</h1>
          <p class="subtitle">Personalized lifestyle and wellness recommendations</p>

          <div class="legend">
            <div class="legend-item">
              <div class="legend-color" style="background: #3B82F6;"></div>
              <span>Exercise</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #10B981;"></div>
              <span>Diet & Nutrition</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #A855F7;"></div>
              <span>Alcohol</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #F97316;"></div>
              <span>Weight Management</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #EF4444;"></div>
              <span>Smoking Cessation</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #14B8A6;"></div>
              <span>Mental Health</span>
            </div>
          </div>

          ${k}

          <div style="margin-top: 32px; padding-top: 16px; border-top: 1px solid #E5E7EB;
                      font-size: 12px; color: #6B7280; text-align: center;">
            <p style="margin: 0;">Generated by Operator - Patient Education & Lifestyle Medicine</p>
            <p style="margin: 4px 0 0 0;">This information is for general education only. Always follow your healthcare team's specific advice.</p>
          </div>
        </body>
      </html>
    `),E.document.close(),E.print()},I=()=>{const E=s.educationData.letterContent||s.content,T=i==="letter";return t.jsxs("div",{className:"mb-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Rn,{className:"w-4 h-4 text-emerald-600"}),t.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Patient Letter"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(ye,{onClick:()=>d(E,"letter"),variant:"outline",size:"sm",startIcon:T?t.jsx(Ra,{}):t.jsx(Xn,{}),isSuccess:T,className:T?"text-green-600":"",children:T?"Copied!":"Copy"}),t.jsx(ye,{onClick:()=>h(E,"letter"),variant:"success",size:"sm",startIcon:l==="letter"?t.jsx(Ra,{}):t.jsx(r2,{}),isSuccess:l==="letter",className:"bg-emerald-100 hover:bg-emerald-200 text-emerald-700",children:l==="letter"?"Inserted!":"Insert"})]})]}),t.jsx("div",{className:"bg-gray-50 rounded-lg p-4 border border-gray-200",children:t.jsx("div",{className:"prose prose-sm max-w-none",children:t.jsx("div",{className:"text-gray-800 whitespace-pre-wrap text-sm leading-relaxed font-sans",dangerouslySetInnerHTML:{__html:E.replace(/\n\n/g,'</p><p class="mt-4">').replace(/^/,"<p>").replace(/$/,"</p>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/## (.*?)(?=\n|$)/g,'<h3 class="text-base font-bold text-gray-900 mt-6 mb-3 border-b border-gray-200 pb-1">$1</h3>').replace(/‚Ä¢ (.*?)(?=\n|$)/g,'<li class="ml-4">$1</li>').replace(/(<li.*?<\/li>)/g,'<ul class="list-disc list-inside space-y-1 mb-3">$1</ul>')}})})})]})},C=()=>{const E=s.educationData.jsonMetadata;if(!E)return null;const T=i==="json",Q=E.priority_plan||[];return t.jsxs("div",{className:"mb-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(dA,{className:"w-4 h-4 text-blue-600"}),t.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Quick Action Plan"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(ye,{onClick:()=>d(JSON.stringify(E,null,2),"json"),variant:"outline",size:"sm",startIcon:T?t.jsx(Ra,{}):t.jsx(Xn,{}),isSuccess:T,title:"Copy structured data as JSON",className:T?"text-green-600":"",children:T?"Copied!":"Copy JSON"}),t.jsx(ye,{onClick:j,variant:"secondary",size:"sm",startIcon:t.jsx(Ya,{}),children:"Export PDF"})]})]}),Q.length>0&&t.jsx("div",{className:"space-y-3",children:Q.map((D,k)=>{const R=D.expected_impact==="very_high"||D.expected_impact==="high"?"text-emerald-700 bg-emerald-50 border-emerald-200":D.expected_impact==="medium"?"text-blue-700 bg-blue-50 border-blue-200":"text-gray-700 bg-gray-50 border-gray-200";return t.jsx("div",{className:`border rounded-lg p-3 ${R}`,children:t.jsxs("div",{className:"flex items-start space-x-2",children:[t.jsx("div",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-white flex items-center justify-center text-xs font-bold mt-0.5",children:k+1}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h5",{className:"font-semibold text-sm mb-1",children:D.title}),D.magnitude_note&&t.jsx("p",{className:"text-xs mb-2 opacity-90",children:D.magnitude_note}),D.reason&&t.jsxs("p",{className:"text-xs mb-2 italic opacity-80",children:[t.jsx("strong",{children:"Why:"})," ",D.reason]}),D.next_action&&t.jsx("div",{className:"bg-white bg-opacity-50 rounded px-2 py-1 mt-2",children:t.jsxs("p",{className:"text-xs font-medium",children:[t.jsx("strong",{children:"Start here:"})," ",D.next_action]})}),D.habit_cue&&t.jsx("div",{className:"bg-white bg-opacity-50 rounded px-2 py-1 mt-1",children:t.jsxs("p",{className:"text-xs",children:[t.jsx("strong",{children:"Habit cue:"})," ",D.habit_cue]})})]})]})},k)})}),t.jsxs("details",{className:"mt-3",children:[t.jsx("summary",{className:"cursor-pointer text-xs text-gray-500 hover:text-gray-700 font-medium",children:"View structured data (JSON)"}),t.jsx("div",{ref:A,className:"mt-2 bg-gray-900 rounded-lg p-3 border border-gray-700 overflow-x-auto",children:t.jsx("pre",{className:"text-xs text-green-400 font-mono whitespace-pre-wrap break-words",children:JSON.stringify(E,null,2)})})]})]})};return t.jsx("div",{className:"w-full bg-white border border-gray-200 rounded-card shadow-card",children:t.jsxs("div",{className:"bg-white w-full overflow-hidden rounded-card",children:[t.jsx("div",{className:"bg-gradient-to-r from-emerald-600 to-emerald-700 text-white px-4 py-3",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(sA,{className:"w-4 h-4"}),t.jsx("h3",{className:"font-semibold text-sm",children:"Patient Education & Lifestyle Advice"})]}),t.jsxs("div",{className:"text-emerald-100 text-xs",children:["Generated in ",Math.round(s.metadata.processingTime/1e3),"s"]})]})}),t.jsxs("div",{className:"p-4",children:[b(),x(),N(),v(),I(),C(),t.jsx("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:t.jsxs("div",{className:"flex items-start space-x-2",children:[t.jsx(Ma,{className:"w-4 h-4 text-blue-600 flex-shrink-0 mt-0.5"}),t.jsxs("div",{className:"text-xs text-blue-800",children:[t.jsx("p",{className:"font-medium",children:"Important Disclaimer"}),t.jsx("p",{className:"mt-1",children:"This information is for educational purposes only and should not replace professional medical advice. Always consult with your healthcare team before making significant lifestyle changes."})]})]})})]})]})})},A4={card:{width:"559px",minHeight:"794px",padding:"38px",boxSizing:"border-box"}},Rp=({jsonData:s,procedureInfo:e})=>{const r=s.fields||{},a=s.procedure_type,n=o=>o&&o!==""&&o!=="Not specified",i=o=>!o||o===""?null:o==="Not specified"?t.jsx("span",{className:"text-gray-400 italic text-sm",children:"Not specified"}):o;return t.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-lg shadow-sm flex flex-col",style:A4.card,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3 pb-3 border-b-2 border-gray-100 flex-shrink-0",children:[t.jsx("span",{className:"text-2xl",children:e.emoji}),t.jsxs("div",{className:"flex-1",children:[t.jsx("h2",{className:"text-lg font-bold text-gray-900 leading-tight",children:e.label}),r.procedure&&r.procedure!==e.label&&t.jsx("p",{className:"text-xs text-gray-500",children:r.procedure})]})]}),t.jsxs("div",{className:"flex-1 flex flex-col text-sm",children:[n(r.indication)&&t.jsxs("div",{className:"mb-3 pb-3 border-b border-gray-100",children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Indication"}),t.jsx("div",{className:"text-sm text-gray-900",children:i(r.indication)})]}),(n(r.primary_access)||n(r.access_site)||n(r.sheath_size_fr)||a==="TAVI"&&n(r.valve_type_size)||a==="MITRAL_TEER"&&n(r.transeptal_catheter))&&t.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-3 pb-3 border-b border-gray-100",children:[n(r.primary_access||r.access_site)&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Access"}),t.jsx("div",{className:"text-sm text-gray-900",children:i(r.primary_access||r.access_site)})]}),n(r.sheath_size_fr)&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Sheath"}),t.jsxs("div",{className:"text-sm text-gray-900",children:[i(r.sheath_size_fr)," Fr"]})]}),a==="TAVI"&&n(r.valve_type_size)&&t.jsxs("div",{className:"col-span-2",children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Valve"}),t.jsx("div",{className:"text-sm text-gray-900",children:r.valve_type_size})]}),a==="MITRAL_TEER"&&n(r.transeptal_catheter)&&t.jsxs("div",{className:"col-span-2",children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Transeptal Catheter"}),t.jsx("div",{className:"text-sm text-gray-900",children:r.transeptal_catheter})]})]}),n(r.catheters)&&t.jsxs("div",{className:"mb-3",children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Catheters"}),t.jsx("div",{className:"text-sm text-gray-900",children:Array.isArray(r.catheters)?r.catheters.join(", "):r.catheters})]}),a==="TAVI"&&(n(r.pacing_wire_access)||n(r.closure_plan)||n(r.protamine)||n(r.goals_of_care))&&t.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-3 pb-3 border-b border-gray-100",children:[n(r.pacing_wire_access)&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Pacing Wire"}),t.jsx("div",{className:"text-sm text-gray-900",children:r.pacing_wire_access})]}),n(r.closure_plan)&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Closure"}),t.jsx("div",{className:"text-sm text-gray-900",children:r.closure_plan})]}),n(r.protamine)&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Protamine"}),t.jsx("div",{className:"text-sm text-gray-900",children:r.protamine})]}),n(r.goals_of_care)&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Goals of Care"}),t.jsx("div",{className:"text-sm text-gray-900",children:r.goals_of_care})]})]}),a==="RIGHT_HEART_CATH"&&(n(r.co_measurement)||n(r.blood_gas_samples))&&t.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-3 pb-3 border-b border-gray-100",children:[n(r.co_measurement)&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"CO Measurement"}),t.jsx("div",{className:"text-sm text-gray-900",children:r.co_measurement})]}),n(r.blood_gas_samples)&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Blood Gas Samples"}),t.jsx("div",{className:"text-sm text-gray-900",children:r.blood_gas_samples})]})]}),a==="MITRAL_TEER"&&n(r.echo_summary)&&t.jsxs("div",{className:"mb-3 pb-3 border-b border-gray-100",children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Echo Summary"}),t.jsx("div",{className:"text-sm text-gray-900",children:r.echo_summary})]}),(n(r.anticoagulation_plan)||n(r.sedation)||n(r.allergies)||n(r.site_prep))&&t.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-3 pb-3 border-b border-gray-100",children:[n(r.anticoagulation_plan)&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Antiplatelets"}),t.jsx("div",{className:"text-sm text-gray-900",children:r.anticoagulation_plan})]}),n(r.sedation)&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Sedation"}),t.jsx("div",{className:"text-sm text-gray-900",children:r.sedation})]}),n(r.allergies)&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Allergies"}),t.jsx("div",{className:"text-sm text-gray-900",children:r.allergies})]}),n(r.site_prep)&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Site Prep"}),t.jsx("div",{className:"text-sm text-gray-900",children:r.site_prep})]})]}),r.recent_labs&&(n(r.recent_labs.hb_g_per_l)||n(r.recent_labs.creatinine_umol_per_l))&&t.jsxs("div",{className:"mb-3 pb-3 border-b border-gray-100",children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Recent Labs"}),t.jsxs("div",{className:"text-sm text-gray-900",children:[n(r.recent_labs.hb_g_per_l)&&`Hb ${r.recent_labs.hb_g_per_l} g/L`,n(r.recent_labs.hb_g_per_l)&&n(r.recent_labs.creatinine_umol_per_l)&&" ‚Ä¢ ",n(r.recent_labs.creatinine_umol_per_l)&&`Creatinine ${r.recent_labs.creatinine_umol_per_l} ¬µmol/L`]})]}),n(r.planned_followup)&&t.jsxs("div",{className:"mb-3 pb-3 border-b border-gray-100",children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5",children:"Follow-up"}),t.jsx("div",{className:"text-sm text-gray-900",children:r.planned_followup})]}),t.jsx("div",{className:"flex-1"}),n(r.nok_name)&&t.jsxs("div",{className:"pt-3 border-t-2 border-gray-200 mt-auto",children:[t.jsx("div",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1",children:"Next of Kin"}),t.jsxs("div",{className:"text-sm text-gray-900",children:[t.jsx("span",{className:"font-medium",children:i(r.nok_name)}),n(r.nok_relationship)&&t.jsxs("span",{className:"text-gray-600",children:[" (",i(r.nok_relationship),")"]}),n(r.nok_phone)&&t.jsxs("span",{className:"text-gray-600",children:[" ‚Ä¢ ",i(r.nok_phone)]})]})]})]})]})},ku={ANGIOGRAM_OR_PCI:{label:"Angiogram/PCI",color:"blue",emoji:"ü©∫"},RIGHT_HEART_CATH:{label:"Right Heart Cath",color:"purple",emoji:"ü©∫"},TAVI:{label:"TAVI",color:"emerald",emoji:"ü´Ä"},MITRAL_TEER:{label:"Mitral TEER",color:"teal",emoji:"ü´Ä"}};async function d4(s,e={}){return bt.info("PreOpCardExport: Starting clipboard copy",{procedureType:s.procedureType,component:"pre-op-card-export"}),new Promise((r,a)=>{try{const n=document.createElement("div");n.style.position="absolute",n.style.left="-9999px",n.style.top="0",n.style.zIndex="-1",document.body.appendChild(n);const i=ku[s.procedureType]||ku.ANGIOGRAM_OR_PCI,o=$u(n);o.render(Rp({jsonData:s.jsonData,procedureInfo:i})),setTimeout(async()=>{try{const l=n.querySelector("div");if(!l)throw new Error("Card element not found after rendering");const c=await rm(l,{scale:3.14,backgroundColor:"#FFFFFF",logging:!1,useCORS:!0,allowTaint:!1,width:559,height:794});bt.info("PreOpCardExport: Canvas captured successfully",{width:c.width,height:c.height,component:"pre-op-card-export"}),c.toBlob(async A=>{if(!A){a(new Error("Failed to create image blob"));return}try{const d=new ClipboardItem({"image/png":A});await navigator.clipboard.write([d]),bt.info("PreOpCardExport: Image copied to clipboard",{blobSize:A.size,component:"pre-op-card-export"}),o.unmount(),document.body.removeChild(n),r()}catch(d){o.unmount(),document.body.removeChild(n),bt.error("PreOpCardExport: Clipboard write failed",{error:d instanceof Error?d.message:String(d),component:"pre-op-card-export"}),a(new Error("Failed to copy image to clipboard. Please check browser permissions."))}},"image/png",1)}catch(l){o.unmount(),document.body.removeChild(n),bt.error("PreOpCardExport: Canvas capture failed",{error:l instanceof Error?l.message:String(l),component:"pre-op-card-export"}),a(l)}},100)}catch(n){bt.error("PreOpCardExport: Setup failed",{error:n instanceof Error?n.message:String(n),component:"pre-op-card-export"}),a(n)}})}async function u4(s,e={}){return bt.info("PreOpCardExport: Starting download",{procedureType:s.procedureType,component:"pre-op-card-export"}),new Promise((r,a)=>{try{const n=document.createElement("div");n.style.position="absolute",n.style.left="-9999px",n.style.top="0",n.style.zIndex="-1",document.body.appendChild(n);const i=ku[s.procedureType]||ku.ANGIOGRAM_OR_PCI,o=$u(n);o.render(Rp({jsonData:s.jsonData,procedureInfo:i})),setTimeout(async()=>{try{const l=n.querySelector("div");if(!l)throw new Error("Card element not found after rendering");(await rm(l,{scale:3.14,backgroundColor:"#FFFFFF",logging:!1,useCORS:!0,allowTaint:!1,width:559,height:794})).toBlob(A=>{if(!A){a(new Error("Failed to create image blob"));return}const d=URL.createObjectURL(A),h=document.createElement("a"),f=new Date().toISOString().split("T")[0],x=`PreOp_${s.procedureType.toLowerCase().replace(/_/g,"-")}_${e.patientInfo?.mrn||f}.png`;h.href=d,h.download=e.filename||x,h.style.display="none",document.body.appendChild(h),h.click(),setTimeout(()=>{document.body.removeChild(h),URL.revokeObjectURL(d)},100),o.unmount(),document.body.removeChild(n),bt.info("PreOpCardExport: Download completed",{filename:x,component:"pre-op-card-export"}),r()},"image/png",1)}catch(l){o.unmount(),document.body.removeChild(n),bt.error("PreOpCardExport: Download failed",{error:l instanceof Error?l.message:String(l),component:"pre-op-card-export"}),a(l)}},100)}catch(n){bt.error("PreOpCardExport: Setup failed",{error:n instanceof Error?n.message:String(n),component:"pre-op-card-export"}),a(n)}})}function Jf(s){const e=[],r=s.jsonData?.fields||{},a=Object.values(r),n=a.length>0&&a.some(d=>d&&d!=="Not specified"&&d!==""&&d!=="parsing_error"),o={ANGIOGRAM_OR_PCI:["procedure","indication","primary_access","nok_name"],RIGHT_HEART_CATH:["procedure","indication","access_site","nok_name"],TAVI:["procedure","indication","primary_access","valve_type_size","nok_name"],MITRAL_TEER:["procedure","indication","access_site","transeptal_catheter","nok_name"]}[s.procedureType]||[];let l=0;for(const d of o){const h=r[d];!h||h==="Not specified"||h===""?e.push(d.replace(/_/g," ")):l++}const c=o.length>0?Math.round(l/o.length*100):100;let A;return e.length>0&&(A=`Card is ${c}% complete. Missing fields: ${e.join(", ")}. Export will proceed with available data.`),{valid:n,missingFields:e,hasAnyData:n,completenessPercent:c,warningMessage:A}}const Yf={ANGIOGRAM_OR_PCI:{label:"Angiogram/PCI",color:"blue",emoji:"ü©∫"},RIGHT_HEART_CATH:{label:"Right Heart Cath",color:"purple",emoji:"ü©∫"},TAVI:{label:"TAVI",color:"emerald",emoji:"ü´Ä"},MITRAL_TEER:{label:"Mitral TEER",color:"teal",emoji:"ü´Ä"}},gv=m.memo(({session:s,onCopy:e,onInsertToEMR:r,onTranscriptionCopy:a,onTranscriptionInsert:n,onTranscriptionEdit:i,onTranscriptionApprove:o,transcriptionApprovalState:l,onAgentReprocess:c,isProcessing:A=!1,onReprocessWithValidation:d})=>{const[h,f]=m.useState(!1),[u,x]=m.useState("idle"),[b,N]=m.useState("idle"),[v,j]=m.useState(!1),{fieldConfig:I,copy:C}=SA("pre-op-plan"),E=s.preOpPlanData;if(m.useEffect(()=>{s.preOpValidationStatus==="awaiting_validation"&&s.preOpValidationResult&&(console.log("üîç Pre-Op Display: Validation required, showing modal"),j(!0))},[s.preOpValidationStatus,s.preOpValidationResult]),!E)return t.jsx("div",{className:"p-4 text-center text-gray-500",children:"No pre-op plan data available"});const{procedureType:T,cardMarkdown:Q,jsonData:D,completenessScore:k}=E,R=E.warnings??[],w=Yf[T]||Yf.ANGIOGRAM_OR_PCI,L=()=>{const $=window.open("","_blank");if(!$)return;const O=`
      <!DOCTYPE html>
      <html>
        <head>
          <title>Pre-Op Plan - ${w.label}</title>
          <style>
            @page {
              size: A5;
              margin: 15mm;
            }
            body {
              font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
              font-size: 10pt;
              line-height: 1.4;
              color: #1f2937;
              margin: 0;
              padding: 0;
            }
            h1 {
              font-size: 14pt;
              margin: 0 0 10px 0;
              color: #1f2937;
            }
            .field {
              margin: 4px 0;
            }
            .field strong {
              color: #374151;
            }
            .header {
              border-bottom: 2px solid #e5e7eb;
              padding-bottom: 8px;
              margin-bottom: 12px;
            }
            .footer {
              margin-top: 20px;
              padding-top: 8px;
              border-top: 1px solid #e5e7eb;
              font-size: 8pt;
              color: #6b7280;
            }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>${w.emoji} ${w.label} Pre-Op Plan</h1>
          </div>
          <div class="content">
            ${Q.split(`
`).map(W=>W.startsWith("**")?`<div class="field">${W.replace(/\*\*/g,"<strong>").replace(/<\/strong>/g,"</strong>")}</div>`:W?`<div>${W}</div>`:"").join("")}
          </div>
          <div class="footer">
            Generated: ${new Date().toLocaleString("en-AU")} | Completeness: ${k||"N/A"}
          </div>
          <script>
            window.onload = () => {
              window.print();
              window.onafterprint = () => window.close();
            };
          <\/script>
        </body>
      </html>
    `;$.document.write(O),$.document.close()},M=()=>{const $=JSON.stringify(D,null,2),O=new Blob([$],{type:"application/json"}),W=URL.createObjectURL(O),ee=document.createElement("a");ee.href=W,ee.download=`pre-op-plan-${T.toLowerCase()}-${Date.now()}.json`,document.body.appendChild(ee),ee.click(),document.body.removeChild(ee),URL.revokeObjectURL(W)},P=async()=>{const $=Jf({procedureType:T,jsonData:D});if(!$.valid){gt.getInstance().error("Cannot copy card: No procedure data available. Please ensure validation workflow has completed."),x("error"),setTimeout(()=>x("idle"),2e3);return}if(!E||!D||!D.fields||Object.keys(D.fields).length===0){gt.getInstance().error("Cannot copy card: No validated data available. Please complete the validation workflow first."),x("error"),setTimeout(()=>x("idle"),2e3);return}$.warningMessage&&gt.getInstance().warning($.warningMessage),x("copying");try{await d4({procedureType:T,cardMarkdown:Q,jsonData:D,completenessScore:k},{operatorInfo:{date:new Date().toLocaleDateString("en-AU",{day:"2-digit",month:"short",year:"numeric"})}}),x("success"),gt.getInstance().success($.completenessPercent===100?"A5 card copied to clipboard! Ready to paste into documents.":`A5 card copied to clipboard (${$.completenessPercent}% complete)! Review and fill missing fields as needed.`),setTimeout(()=>x("idle"),3e3)}catch(O){console.error("Failed to copy card to clipboard:",O),x("error"),gt.getInstance().error(O instanceof Error?O.message:"Failed to copy card to clipboard"),setTimeout(()=>x("idle"),2e3)}},K=async()=>{const $=Jf({procedureType:T,jsonData:D});if(!$.valid){gt.getInstance().error("Cannot download card: No procedure data available. Please ensure validation workflow has completed."),N("error"),setTimeout(()=>N("idle"),2e3);return}if(!E||!D||!D.fields||Object.keys(D.fields).length===0){gt.getInstance().error("Cannot download card: No validated data available. Please complete the validation workflow first."),N("error"),setTimeout(()=>N("idle"),2e3);return}$.warningMessage&&gt.getInstance().warning($.warningMessage),N("downloading");try{await u4({procedureType:T,cardMarkdown:Q,jsonData:D,completenessScore:k},{operatorInfo:{date:new Date().toLocaleDateString("en-AU",{day:"2-digit",month:"short",year:"numeric"})}}),N("success"),gt.getInstance().success($.completenessPercent===100?"A5 card downloaded successfully!":`A5 card downloaded (${$.completenessPercent}% complete)! Review and fill missing fields as needed.`),setTimeout(()=>N("idle"),3e3)}catch(O){console.error("Failed to download card:",O),N("error"),gt.getInstance().error(O instanceof Error?O.message:"Failed to download card"),setTimeout(()=>N("idle"),2e3)}};return t.jsxs(ab,{agentType:"pre-op-plan",title:"Pre-Op Plan Summary Card",subtitle:w.label,completedTime:s.completedTime,processingTime:s.processingTime,originalTranscription:s.transcription,onTranscriptionCopy:a,onTranscriptionInsert:n,onTranscriptionEdit:i,onTranscriptionApprove:o,transcriptionApprovalState:l,onAgentReprocess:c?()=>c():void 0,isProcessing:A,audioBlob:s.audioBlob||null,results:Q,onCopy:e,onInsertToEMR:r,agentName:"Pre-Op Plan",hideActions:!1,children:[t.jsxs("div",{className:"space-y-6",children:[k&&t.jsx("div",{className:"flex items-center justify-end",children:t.jsx("div",{className:"text-xs text-gray-500 bg-gray-50 px-2 py-1 rounded",children:k})}),R.length>0&&t.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-3",children:t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx("svg",{className:"w-5 h-5 text-amber-600 mt-0.5",fill:"currentColor",viewBox:"0 0 20 20",children:t.jsx("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})}),t.jsxs("div",{className:"flex-1",children:[t.jsx("h4",{className:"text-sm font-semibold text-amber-800 mb-1",children:"Warnings"}),t.jsx("ul",{className:"text-sm text-amber-700 space-y-1",children:R.map(($,O)=>t.jsxs("li",{children:["‚Ä¢ ",$]},O))})]})]})}),t.jsx(Rp,{jsonData:D,procedureInfo:w}),t.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[t.jsx(ye,{onClick:P,disabled:u==="copying",variant:u==="success"?"success":u==="error"?"danger":"outline",size:"md",isLoading:u==="copying",isSuccess:u==="success",startIcon:u==="error"?t.jsx(or,{className:"w-4 h-4"}):u==="copying"||u==="success"?void 0:t.jsx(CA,{className:"w-4 h-4"}),className:u==="copying"?"bg-gray-50 border-gray-200 text-gray-500":u==="success"||u==="error"?"":"bg-teal-50 hover:bg-teal-100 border-teal-200 text-teal-700",children:u==="copying"?"Copying...":u==="success"?"Copied!":u==="error"?"Failed":"Copy A5 Card"}),t.jsx(ye,{onClick:K,disabled:b==="downloading",variant:b==="success"?"success":b==="error"?"danger":"outline",size:"md",isLoading:b==="downloading",isSuccess:b==="success",startIcon:b==="error"?t.jsx(or,{className:"w-4 h-4"}):b==="downloading"||b==="success"?void 0:t.jsx(Ya,{className:"w-4 h-4"}),className:b==="downloading"?"bg-gray-50 border-gray-200 text-gray-500":b==="success"||b==="error"?"":"bg-purple-50 hover:bg-purple-100 border-purple-200 text-purple-700",children:b==="downloading"?"Generating...":b==="success"?"Downloaded!":b==="error"?"Failed":"Download A5 Card"}),t.jsx(ye,{onClick:L,variant:"outline",size:"md",startIcon:t.jsx(a2,{className:"w-4 h-4"}),className:"bg-blue-50 hover:bg-blue-100 border-blue-200 text-blue-700",children:"Print"}),t.jsx(ye,{onClick:M,variant:"outline",size:"md",startIcon:t.jsx(Ya,{className:"w-4 h-4"}),children:"Export JSON"})]}),t.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[t.jsx(ye,{onClick:()=>f(!h),variant:"ghost",size:"md",fullWidth:!0,className:"justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-none",endIcon:h?t.jsx(ps,{className:"w-4 h-4 text-gray-500"}):t.jsx(ti,{className:"w-4 h-4 text-gray-500"}),children:t.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Structured JSON Metadata"})}),t.jsx(as,{children:h&&t.jsx(Ye.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.2},className:"overflow-hidden",children:t.jsx("div",{className:"p-4 bg-gray-900 text-gray-100 font-mono text-xs overflow-x-auto",children:t.jsx("pre",{children:JSON.stringify(D,null,2)})})})})]})]}),v&&s.preOpValidationResult&&t.jsx(uA,{agentLabel:"Pre-Op Plan",validation:s.preOpValidationResult,fieldConfig:I,copy:C,onCancel:()=>{console.log("üö´ Pre-Op Display: Validation cancelled"),j(!1)},onSkip:()=>{console.log("‚è≠Ô∏è Pre-Op Display: Validation skipped"),j(!1)},onContinue:$=>{console.log("‚úÖ Pre-Op Display: Validation completed, reprocessing with user fields",$),j(!1),d&&d($)}})]})});gv.displayName="PreOpPlanDisplay";const m4={"audio-processing":"Processing",transcribing:"Transcribing","ai-analysis":"AI Analysis",generation:"Generating"};function h4(s){const e=s<0,r=Math.abs(s),a=Math.floor(r/1e3);if(a<60){const l=`${a}s`;return e?`+${l}`:l}const n=Math.floor(a/60),i=a%60,o=`${n}m ${i}s`;return e?`+${o}`:o}function p4(s){const e={"from-red-500":"var(--fluent-text-secondary, #64748b)","from-blue-500":"var(--fluent-text-secondary, #64748b)","from-purple-500":"var(--fluent-accent-primary, #8B5CF6)","from-emerald-500":"var(--fluent-accent-emerald, #10b981)","from-indigo-500":"var(--fluent-accent-primary, #8B5CF6)","from-rose-500":"var(--fluent-accent-red, #f43f5e)","from-teal-500":"var(--fluent-accent-teal, #14b8a6)"},r=s.split(" ").find(a=>a.startsWith("from-"));return r&&e[r]?e[r]:"var(--fluent-text-secondary, #64748b)"}const g4=({remainingMs:s,progress:e,stage:r,size:a=200,className:n=""})=>{const i=m.useMemo(()=>{const x=Gc(r);return No(x)},[r]),o=m.useMemo(()=>p4(i.progressGradient.active),[i]),l=8,c=(a-l)/2,A=2*Math.PI*c,d=A-e/100*A,h=m.useMemo(()=>h4(s),[s]),f=m4[r],u=a/2;return t.jsx(Ye.div,{className:`flex items-center justify-center ${n}`,initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},transition:{duration:.3},role:"timer","aria-live":"polite","aria-label":`${h} remaining, ${f}`,children:t.jsxs("svg",{width:"100%",height:"100%",viewBox:`0 0 ${a} ${a}`,className:"transform -rotate-90",style:{filter:"drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1))"},children:[t.jsx("circle",{cx:u,cy:u,r:c,stroke:"var(--fluent-border-subtle, #e5e7eb)",strokeWidth:l,fill:"none",className:"opacity-30"}),t.jsx("circle",{cx:u,cy:u,r:c,stroke:o,strokeWidth:l,fill:"none",strokeDasharray:A,strokeDashoffset:d,strokeLinecap:"round",style:{transition:"stroke-dashoffset 0.5s ease, stroke 0.3s ease"}}),t.jsxs("g",{transform:`rotate(90 ${u} ${u})`,children:[t.jsx("text",{x:u,y:u-5,textAnchor:"middle",dominantBaseline:"middle",className:"font-bold",style:{fontSize:a*.18,fill:o,fontFamily:"system-ui, -apple-system, sans-serif"},children:h}),t.jsx("text",{x:u,y:u+a*.12,textAnchor:"middle",dominantBaseline:"middle",className:"text-gray-600",style:{fontSize:a*.07,fill:"var(--fluent-text-secondary, #4b5563)",fontFamily:"system-ui, -apple-system, sans-serif"},children:f})]})]})})};function f4(s,e,r,a){return!s||e>=100?null:s.estimatedDurationMs-a}function x4(s){const e=s/1e3;if(e<60)return`${e.toFixed(1)}s left`;const r=Math.floor(e/60),a=e%60;return`${r}m ${a.toFixed(1)}s left`}const Xf=[{id:"audio-processing",label:"Processing Audio",icon:$r,range:[0,10],color:No(Gc("audio-processing")).progressGradient},{id:"transcribing",label:"Transcribing",icon:Rn,range:[10,40],color:No(Gc("transcribing")).progressGradient},{id:"ai-analysis",label:"AI Analysis",icon:ol,range:[40,90],color:No(Gc("ai-analysis")).progressGradient},{id:"generation",label:"Generating",icon:Ac,range:[90,100],color:No(Gc("generation")).progressGradient}],np=({progress:s,startTime:e,agentType:r,transcriptionLength:a,audioDuration:n,showTimeEstimate:i=!0,showCircularTimer:o=!0,skipStages:l=[],className:c=""})=>{const[A,d]=m.useState(0),[h,f]=m.useState(null),[u,x]=m.useState(0),[b]=m.useState(()=>zi.getInstance()),N=m.useMemo(()=>Xf.filter(D=>!l.includes(D.id)),[l]),v=e&&Date.now()-e<=3e5,j=o&&v;console.log("üîç Timer visibility check:",{startTime:e,sessionAge:e?`${((Date.now()-e)/1e3/60).toFixed(1)} min`:"no startTime",isRecentSession:v,shouldShowTimer:j,progress:s.progress,isCompleted:s.progress>=100});const I=e||Date.now();m.useEffect(()=>{if(!v||s.progress>=100)return;const D=window.setInterval(()=>{const k=Date.now()-I;if(k>=0&&k<864e5&&(d(k),k>0&&s.progress>0)){const R=s.progress/k;x(R)}},1e3);return()=>clearInterval(D)},[I,s.progress,v]),m.useEffect(()=>{const D=n||a;if(console.log("‚è±Ô∏è Prediction check:",{agentType:r,hasInputData:D,audioDuration:n,transcriptionLength:a,showTimeEstimate:i,hasPrediction:!!h}),r&&D&&i&&!h)try{const k=b.predictProcessingTime(r,a||0,{audioDuration:n,includeTranscriptionTime:!0});f(k),console.log("‚úÖ Prediction generated:",{agentType:r,estimatedDurationMs:k.estimatedDurationMs,estimatedDurationSec:(k.estimatedDurationMs/1e3).toFixed(1)})}catch(k){console.warn("Failed to generate time prediction:",k)}},[r,a,n,i,h,b]);const C=D=>{const[k,R]=D.range;return s.progress>=R?"complete":s.progress>=k&&s.progress<R?"active":"inactive"},E=D=>{const k=C(D);if(k==="complete")return 100;if(k==="inactive")return 0;const[R,w]=D.range,L=(s.progress-R)/(w-R)*100;return Math.max(0,Math.min(100,L))},T=m.useMemo(()=>Xf.find(D=>C(D)==="active"),[s.progress]),Q=m.useMemo(()=>f4(h,s.progress,u,A),[h,s.progress,A]);return t.jsxs(Ye.div,{className:`bg-white rounded-card border border-gray-200 shadow-card ${c}`,initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3},role:"status","aria-live":"polite","aria-label":"Processing pipeline progress",children:[(()=>{const D=j&&Q!==null&&s.progress<100;return console.log("‚è±Ô∏è Timer render decision:",{willRender:D,shouldShowTimer:j,remainingTime:Q,progressComplete:s.progress>=100}),D&&t.jsx("div",{className:"flex justify-center py-6 border-b border-gray-100",children:t.jsx("div",{className:"w-40 h-40 sm:w-52 sm:h-52 md:w-60 md:h-60",children:t.jsx(g4,{remainingMs:Q,progress:s.progress,stage:s.stage,size:240,className:"w-full h-full"})})})})(),t.jsxs("div",{className:"p-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[T&&t.jsx(T.icon,{className:"w-4 h-4 text-gray-700"}),t.jsx("h4",{className:"text-sm font-medium text-gray-900",children:r?r.charAt(0).toUpperCase()+r.slice(1).replace("-"," "):"Processing"}),s.modelName&&t.jsxs("span",{className:"text-xs text-gray-500",children:["‚Ä¢ ",s.modelName]})]}),t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsxs("div",{className:"flex items-center space-x-1 text-indigo-600",children:[t.jsx(_a,{className:"w-3 h-3"}),t.jsx("span",{className:"text-xs font-mono font-medium",children:EC(A)})]}),Q!==null&&Q>2e3&&t.jsxs("div",{className:"flex items-center space-x-1 text-purple-600",children:[t.jsx(uc,{className:"w-3 h-3"}),t.jsx("span",{className:"text-xs font-medium",children:x4(Q)})]}),t.jsxs("span",{className:"text-xs text-gray-500 font-medium",children:[Math.round(s.progress),"%"]})]})]}),t.jsx("div",{className:"mb-3",children:t.jsx("div",{className:"flex gap-1",children:N.map(D=>{const k=C(D),R=E(D),w=D.range[1]-D.range[0];return t.jsxs("div",{className:"relative overflow-hidden rounded-sm",style:{flex:w},children:[t.jsx("div",{className:`h-2 ${D.color.inactive}`}),t.jsx(Ye.div,{className:`absolute inset-y-0 left-0 ${k==="complete"?D.color.complete:k==="active"?D.color.active:D.color.inactive}`,initial:{width:0},animate:{width:`${R}%`},transition:{duration:.3,ease:"easeOut"}}),k==="active"&&t.jsx(Ye.div,{className:`absolute inset-0 ${D.color.active} opacity-50`,animate:{opacity:[.3,.6,.3]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"}})]},D.id)})})}),t.jsx("div",{className:"flex justify-between text-[10px] mb-3",children:N.map(D=>{const k=C(D),R=D.icon;return t.jsxs("div",{className:`flex items-center space-x-0.5 ${k==="complete"?"text-gray-600":k==="active"?"text-gray-900 font-medium":"text-gray-400"}`,children:[t.jsx(R,{className:"w-2.5 h-2.5"}),t.jsx("span",{children:D.label})]},D.id)})}),s.details&&t.jsxs("div",{className:"text-xs text-gray-600 text-center py-2 bg-gray-50 rounded-lg border border-gray-100",children:[s.details,s.queuePosition!==void 0&&s.queuePosition>0&&t.jsxs("span",{className:"ml-2 text-gray-500",children:["‚Ä¢ Queue position: ",s.queuePosition]}),s.tokenCount!==void 0&&s.tokenCount>0&&t.jsxs("span",{className:"ml-2 text-emerald-600",children:["‚Ä¢ ",s.tokenCount," tokens"]})]}),t.jsx("div",{className:"mt-3 pt-2 border-t border-gray-200 text-center",children:t.jsx("p",{className:"text-xs text-gray-500",children:s.progress>=100?"‚úÖ Processing complete":s.modelName?`ü§ñ ${s.modelName}`:"üîÑ Local processing - privacy-first"})})]})]})};function y4({onCopy:s,onInsert:e,enabled:r=!0}){const a=m.useCallback(n=>{if(!r)return;const i=n.target;if(!(i.tagName==="INPUT"||i.tagName==="TEXTAREA"||i.isContentEditable)&&!(!n.shiftKey||n.ctrlKey||n.altKey||n.metaKey))switch(n.key.toLowerCase()){case"c":s&&(n.preventDefault(),s());break;case"i":e&&(n.preventDefault(),e());break}},[s,e,r]);m.useEffect(()=>{if(r)return document.addEventListener("keydown",a),()=>{document.removeEventListener("keydown",a)}},[a,r])}const{fieldConfig:b4,copy:v4}=SA("angio-pci"),{fieldConfig:w4,copy:C4}=SA("mteer");function N4(s){if(!s)return null;try{const e=s.match(/JSON:\s*\n```json\s*\n([\s\S]*?)\n```/i)||s.match(/JSON:\s*\n([\s\S]+?)(?=\n\s*$)/i)||s.match(/```json\s*\n([\s\S]*?)\n```/i);if(e){const d=e[1].trim(),h=JSON.parse(d),f=s.match(/CARD:\s*\n([\s\S]*?)(?=\n\s*JSON:|$)/i);let u="";f?u=f[1].trim():s.indexOf("JSON:")>0&&(u=s.substring(0,s.indexOf("JSON:")).trim().replace(/^CARD:\s*/i,"").trim());const x=h.procedure_type||"ANGIOGRAM_OR_PCI",b=h.fields||{};return console.log("üîß Parsed Pre-Op Plan from results (JSON found):",{procedureType:x,fieldsCount:Object.keys(b).length,hasCardMarkdown:!!u}),{procedureType:x,cardMarkdown:u||s,jsonData:{procedure_type:x,fields:b},completenessScore:`${Object.keys(b).length} fields extracted`}}console.log("üîß No JSON in results, extracting fields from card markdown");const r=s.replace(/^CARD:\s*/i,"").trim(),a={},n={indication:"indication",procedure:"procedure",allergies:"allergies",nok:"nok_name","next of kin":"nok_name",access:"primary_access","primary access":"primary_access","secondary access":"secondary_access",sheath:"sheath_size_fr",catheters:"catheters",catheter:"catheters",wire:"wire",closure:"closure_plan",valve:"valve_type_size",pacing:"pacing_wire_access",protamine:"protamine",goals:"goals_of_care",weight:"weight",egfr:"egfr",lm:"lm_findings",lad:"lad_findings",lcx:"lcx_findings",rca:"rca_findings",plan:"plan",antiplatelets:"antiplatelets",antiplatelet:"antiplatelets",sedation:"sedation",labs:"labs",bloods:"labs","follow-up":"follow_up","follow up":"follow_up","site prep":"site_prep",hemoglobin:"hemoglobin",hb:"hemoglobin",creatinine:"creatinine"},i=r.toLowerCase();let o="ANGIOGRAM_OR_PCI";i.includes("tavi")||i.includes("transcatheter aortic")?o="TAVI":i.includes("right heart")||i.includes("rhc")?o="RIGHT_HEART_CATH":(i.includes("mitral")||i.includes("teer"))&&(o="MITRAL_TEER");const l=/\*\*([^*]+)\*\*\s*[‚Äî\-:]\s*([^*\n]+?)(?=\s*[‚Ä¢¬∑]\s*\*\*|\s*\*\*|$|\n)/g;let c;for(;(c=l.exec(r))!==null;){const d=c[1].trim().toLowerCase(),h=c[2].trim().replace(/\s*[‚Ä¢¬∑]\s*$/,"").trim();if(!h||h.toLowerCase()==="not specified")continue;let f=!1;for(const[u,x]of Object.entries(n))if(d===u||d.includes(u)||u.includes(d)){a[x]=h,f=!0;break}if(!f){const u=d.replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,"");u.length>0&&(a[u]=h)}}const A=/[‚Ä¢-]\s*([^:]+):\s*([^\n]+)/g;for(;(c=A.exec(r))!==null;){const d=c[1].trim().toLowerCase(),h=c[2].trim();if(!(!h||h.toLowerCase()==="not specified")){for(const[f,u]of Object.entries(n))if(d.includes(f)||f.includes(d)){a[u]||(a[u]=h);break}}}if(console.log("üîß Extracted Pre-Op fields from markdown:",{procedureType:o,fieldsCount:Object.keys(a).length,fields:Object.keys(a)}),Object.keys(a).length>0)return{procedureType:o,cardMarkdown:r,jsonData:{procedure_type:o,fields:a},completenessScore:`${Object.keys(a).length} fields extracted from card`}}catch(e){console.warn("Failed to parse Pre-Op Plan from results:",e)}return null}const fv=m.memo(({results:s,resultsSummary:e="",agentType:r,onCopy:a,onInsertToEMR:n,warnings:i=[],onDismissWarnings:o,selectedSessionId:l=null,selectedPatientName:c="",originalTranscription:A,audioDuration:d,onTranscriptionCopy:h,onTranscriptionInsert:f,onTranscriptionEdit:u,transcriptionSaveStatus:x,currentAgent:b,onAgentReprocess:N,onRetryTranscription:v,isRetryingTranscription:j=!1,missingInfo:I,onReprocessWithAnswers:C,onDismissMissingInfo:E,isProcessing:T=!1,failedAudioRecordings:Q=[],onClearFailedRecordings:D,errors:k=[],reviewData:R,audioBlob:w,pendingAudio:L,transcriptionTime:M=null,agentProcessingTime:P=null,totalProcessingTime:K=null,processingStatus:$="idle",currentAgentName:O=null,modelUsed:W=null,patientVersion:ee=null,isGeneratingPatientVersion:V=!1,onGeneratePatientVersion:q,streaming:S=!1,streamBuffer:H="",ttftMs:Y=null,onStopStreaming:te,approvalState:G,onTranscriptionApprove:X,isStreaming:le=!1,streamingTokens:he="",onCancelStreaming:ve,taviStructuredSections:ke,taviValidationResult:Le=null,taviValidationStatus:Be,onTAVIReprocessWithValidation:Re,taviProofModeData:re=null,angioProofModeData:Me=null,angiogramValidationResult:Pe=null,angiogramValidationStatus:be,onAngioReprocessWithValidation:ce,mteerValidationResult:Ie=null,mteerValidationStatus:pe,onMTEERReprocessWithValidation:fe,educationData:we,preOpPlanData:de,rhcReport:xe,onUpdateRhcReport:Ne,onRHCReprocessWithValidation:it,onOpenLesionReview:st,pipelineProgress:$e,processingStartTime:Xe,sessionSource:Ze="recording",revisionPanel:ct,revisionContext:pt,onRevisionToggle:dt,onRevisionChange:xt,onRevisionSave:Se,onRevisionDiscard:qe,onRevisionMarkGoldenPair:ut,isSavingRevision:Ge=!1,isSavingGoldenPair:rt=!1,isViewingSession:Tt=!1,ocrExplanation:At=null,nextStepStatus:mt,nextStepResult:Qt,onNextStepIntegrate:ts,onNextStepUndo:Yt,canNextStepUndo:Ht=!1,isNextStepIntegrating:Es=!1,nextStepIntegrationError:vt=null})=>{const[Ft,Hs]=m.useState(!0),ks=xu({agentType:"angiogram-pci"}),Is=xu({agentType:"mteer"}),[Nt,gs]=m.useState(!1),[Vt,Kr]=m.useState([]),[Kt,Js]=m.useState({mode:"visual"}),fs=r==="tavi"||r==="tavi-workup",Zs=m.useMemo(()=>fs&&re?re.facts:r==="angiogram-pci"&&Me?Me.facts:[],[r,fs,re,Me]),Ot=Zs.length>0,qt=m.useCallback(()=>{Ot&&(Kr(Zs),Js(lt=>({...lt,mode:"audio"})),gs(!0))},[Ot,Zs]),{showValidationModal:ur,validationResult:kr,handleValidationRequired:Zr,handleValidationContinue:Qa,handleValidationCancel:Oa,handleValidationSkip:tn,clearValidationState:Ha}=ks,{showValidationModal:sn,validationResult:Mn,handleValidationRequired:lr,handleValidationContinue:os,handleValidationCancel:ua,handleValidationSkip:_n,clearValidationState:Va}=Is;m.useEffect(()=>{r==="angiogram-pci"?be==="awaiting_validation"&&Pe?Zr(Pe):be&&be!=="awaiting_validation"&&Ha():Ha()},[r,be,Pe,Zr,Ha]),m.useEffect(()=>{r==="mteer"?pe==="awaiting_validation"&&Ie?lr(Ie):pe&&pe!=="awaiting_validation"&&Va():Va()},[r,pe,Ie,lr,Va]),m.useEffect(()=>{fs&&re?(Kr(re.facts),Js(lt=>({...lt,mode:"visual"})),gs(!0)):r==="angiogram-pci"&&Me?(Kr(Me.facts),Js(lt=>({...lt,mode:"visual"})),gs(!0)):gs(!1)},[r,Me,fs,re]);const Qn=m.useMemo(()=>{const lt=Yy(s),us=Xy(lt);return{wordCount:lt,readingTime:us}},[s]),[rn,an]=m.useState({copied:!1,inserted:!1}),[Gr,ea]=m.useState({copied:!1,inserted:!1}),[mr,Ts]=m.useState({copied:!1,inserted:!1}),[On,Ur]=m.useState({copied:!1,inserted:!1}),zr=ct?.isEditing?ct.edited:s,er=!!(A&&A.trim().length>0),tr=!!ct?.isEditing,_s=!!dt,Lr=r==="quick-letter"&&!!N&&!!A?.trim(),oi=$!=="complete"&&(r==="angiogram-pci"||r==="tavi-workup"),Fi=r==="angiogram-pci"?"Angio/PCI":"TAVI Workup",Sa=m.useMemo(()=>[...r==="angiogram-pci"&&st?[{id:"review-lesions",label:"Lesions",icon:({className:lt})=>t.jsx(Ny,{className:lt}),onClick:st,variant:"secondary"}]:[],...Ot?[{id:"review-audio",label:"Review Audio",icon:({className:lt})=>t.jsx(cc,{className:lt}),onClick:qt,variant:"secondary"}]:[],...r==="angiogram-pci"&&q?[{id:"generate-patient-version",label:V?"Generating...":"Patient Version",icon:({className:lt})=>V?t.jsx("div",{className:`border-2 border-blue-300 border-t-transparent rounded-full animate-spin ${lt}`}):t.jsx("svg",{className:lt,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z"})}),onClick:q,disabled:V,variant:"secondary"}]:[]],[r,qt,Ot,V,q,st]),ta=m.useCallback(async()=>{await a(e||"No summary available"),an(us=>({...us,copied:!0})),setTimeout(()=>an(us=>({...us,copied:!1})),2e3)},[a,e]),ja=m.useCallback(async()=>{await n(e||"No summary available"),an(us=>({...us,inserted:!0})),setTimeout(()=>an(us=>({...us,inserted:!1})),2e3)},[n,e]),ma=m.useCallback(async()=>{await a(zr),ea(lt=>({...lt,copied:!0})),setTimeout(()=>ea(lt=>({...lt,copied:!1})),2e3)},[zr,a]),sr=m.useCallback(async()=>{await n(zr),ea(lt=>({...lt,inserted:!0})),setTimeout(()=>ea(lt=>({...lt,inserted:!1})),2e3)},[zr,n]),$a=m.useCallback(async()=>{ee&&(await a(ee),Ts(lt=>({...lt,copied:!0})),setTimeout(()=>Ts(lt=>({...lt,copied:!1})),2e3))},[a,ee]),nn=m.useCallback(async()=>{ee&&(await n(ee),Ts(lt=>({...lt,inserted:!0})),setTimeout(()=>Ts(lt=>({...lt,inserted:!1})),2e3))},[n,ee]),on=m.useCallback(()=>{if(ee){const lt=new Blob([ee],{type:"text/plain"}),us=URL.createObjectURL(lt),Wr=document.createElement("a");Wr.href=us,Wr.download=`patient-version-${new Date().toISOString().split("T")[0]}.txt`,document.body.appendChild(Wr),Wr.click(),document.body.removeChild(Wr),URL.revokeObjectURL(us)}},[ee]),Ea=m.useCallback(()=>{!N||T||!Lr||N("quick-letter")},[Lr,T,N]),ie=m.useCallback(async lt=>{await a(lt),Ur(us=>({...us,copied:!0})),setTimeout(()=>Ur(us=>({...us,copied:!1})),2e3)},[a]),Qe=m.useCallback(async lt=>{await n(lt),Ur(us=>({...us,inserted:!0})),setTimeout(()=>Ur(us=>({...us,inserted:!1})),2e3)},[n]),_e=r==="investigation-summary"||r==="background"||r==="medication",St=!!s&&!S&&!T;y4({onCopy:_e&&St?()=>ie(s):void 0,onInsert:_e&&St?()=>Qe(s):void 0,enabled:_e&&St});const zt=m.useMemo(()=>{if(!ct)return[];const lt=[];r&&lt.push(r),pt?.workflowId&&lt.push(pt.workflowId),pt?.agentLabel&&lt.push(pt.agentLabel);const us=ct.tags?.filter(Boolean)??[];return Array.from(new Set([...lt,...us]))},[ct,r,pt?.workflowId]),ot=m.useMemo(()=>{if(!ct)return null;const lt=ct.original?.length||0,us=ct.edited?.length||0,Wr=us-lt,ci=ct.original?ct.original.trim().split(/\s+/).filter(Boolean).length:0,Ga=ct.edited?ct.edited.trim().split(/\s+/).filter(Boolean).length:0,Ia=Ga-ci;return{originalLength:lt,editedLength:us,deltaChars:Wr,originalWords:ci,editedWords:Ga,deltaWords:Ia}},[ct]),yr=m.useMemo(()=>ct&&ct.tags?.join(", ")||"",[ct]),kt=m.useMemo(()=>{if(!ct?.lastSavedAt)return null;try{return Uh(ct.lastSavedAt)}catch(lt){return console.warn("Failed to format revision saved timestamp",lt),null}},[ct?.lastSavedAt]),ze=!ct?.hasUnsavedChanges||Ge,Gt=!ct?.notes?.trim()||rt,Bs=m.useCallback(lt=>{xt?.({edited:lt.target.value})},[xt]),ls=m.useCallback(lt=>{xt?.({notes:lt.target.value})},[xt]),Qs=m.useCallback(lt=>{const us=lt.target.value.split(",").map(Wr=>Wr.trim()).filter(Boolean);xt?.({tags:us})},[xt]),Vs=m.useCallback(lt=>{xt?.({runEvaluationOnSave:lt.target.checked})},[xt]),ha=r==="ai-medical-review"&&R,sa=r==="quick-letter"&&s;(r==="quick-letter"||s?.includes("I had the pleasure"))&&console.log("üîç Quick Letter Display Debug:",{agentType:r,hasResults:!!s,resultsLength:s?.length||0,resultsPreview:s?.substring(0,100),hasResultsSummary:!!e,summaryLength:e?.length||0,summaryPreview:e?.substring(0,100),isQuickLetterDualCards:sa,sessionSource:Ze||"unknown",isViewingSession:Tt});const Dr=r==="tavi-workup"&&s,ra=r==="right-heart-cath"&&(s||xe),pa=r==="patient-education"&&s,ka=r==="pre-op-plan"&&s;r==="pre-op-plan"&&console.log("üîç Pre-Op Plan Detection Debug:",{agentType:r,hasResults:!!s,resultsLength:s?.length,isPreOpPlan:ka,hasPreOpPlanData:!!de,preOpPlanDataKeys:de?Object.keys(de):null,procedureType:de?.procedureType,hasJsonData:!!de?.jsonData,fieldsCount:de?.jsonData?.fields?Object.keys(de.jsonData.fields).length:0,fieldsKeys:de?.jsonData?.fields?Object.keys(de.jsonData.fields):null});const Pi=!S&&!(Dr||ra||pa||ka)&&r!=="investigation-summary"&&(er||Tt);r==="tavi-workup"&&console.log("üîç TAVI Detection Debug:",{agentType:r,hasResults:!!s,resultsLength:s?.length,isTAVIWorkup:Dr,resultsPreview:s?.substring(0,100),hasStructuredSections:!!ke,structuredSectionsKeys:ke?Object.keys(ke):null,patientContentExists:ke?.patient?.content?"Yes":"No"});const Rr=r==="quick-letter"&&!!s&&!!e||r==="tavi-workup"&&!!s||r==="right-heart-cath"&&!!s||r!=="quick-letter"&&r!=="tavi-workup"&&r!=="right-heart-cath"&&!!s,li=()=>t.jsxs(Ye.div,{className:"p-4 border-b border-emerald-200/50",initial:"hidden",animate:"visible",variants:Na(Ci),children:[t.jsxs(Ye.div,{className:"flex items-center justify-between",variants:Na(Z2),children:[t.jsx("div",{className:"flex items-center space-x-2",children:ha?t.jsxs(t.Fragment,{children:[t.jsx(dl,{className:"w-4 h-4 text-blue-600"}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-gray-900 font-medium text-sm",children:R.isBatchReview?"Batch AI Medical Review":"AI Medical Review"}),t.jsx("p",{className:"text-blue-700 text-xs",children:R.isBatchReview?"Multi-patient clinical oversight recommendations":"Australian clinical oversight recommendations"})]})]}):T?t.jsxs(t.Fragment,{children:[t.jsx(gn,{className:"w-4 h-4 text-blue-600 animate-pulse"}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-gray-900 font-medium text-sm",children:"Processing"}),t.jsx("p",{className:"text-blue-700 text-xs",children:$e?.details||"Processing medical information..."})]})]}):t.jsxs(t.Fragment,{children:[t.jsx(gn,{className:"w-4 h-4 text-emerald-600"}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-gray-900 font-medium text-sm",children:r==="investigation-summary"?"Investigation Summary":r==="background"?"Background":r==="medication"?"Medications":"Final Proof"}),t.jsx("p",{className:"text-emerald-700 text-xs",children:l?"Viewing previous session":"Processed output ready for review"})]})]})}),t.jsx(Zt,{onClick:()=>Hs(!Ft),icon:Ft?t.jsx(n2,{}):t.jsx(Cp,{}),variant:"outline",size:"sm",className:"bg-white/60 border-emerald-200 hover:bg-emerald-50/60 text-emerald-600","aria-label":Ft?"Collapse":"Expand",title:Ft?"Collapse":"Expand"})]}),t.jsxs(Ye.div,{className:"flex items-center space-x-4 mt-2 text-xs",variants:Na(Oy),transition:{delay:.1},children:[ha?t.jsxs("div",{className:"text-blue-600 flex items-center space-x-2",children:[t.jsxs("span",{children:[R.findings.length," clinical findings"]}),t.jsx("span",{children:"‚Ä¢"}),t.jsxs("span",{children:[R.findings.filter(lt=>lt.urgency==="Immediate").length," immediate"]}),R.isBatchReview&&R.batchSummary&&t.jsxs(t.Fragment,{children:[t.jsx("span",{children:"‚Ä¢"}),t.jsxs("span",{children:[R.batchSummary.totalPatients," patients"]})]}),t.jsx("span",{children:"‚Ä¢"}),t.jsx("span",{children:new Date().toLocaleTimeString()}),i.length>0&&t.jsx("span",{children:"‚Ä¢"})]}):t.jsxs("div",{className:"text-emerald-600 flex items-center space-x-2",children:[Qn.wordCount>0&&t.jsxs(t.Fragment,{children:[t.jsxs("span",{children:[Qn.wordCount," words"]}),(r==="investigation-summary"||r==="background"||r==="medication")&&t.jsxs(t.Fragment,{children:[t.jsx("span",{children:"‚Ä¢"}),t.jsxs("span",{className:"flex items-center gap-1",title:"AI confidence",children:[t.jsx("span",{children:"95%"}),t.jsx(Wo,{className:"w-3 h-3"})]})]}),t.jsx("span",{children:"‚Ä¢"})]}),t.jsx("span",{title:`Generated at ${Uh(Date.now())}`,children:new Date().toLocaleTimeString()}),i.length>0&&t.jsx("span",{children:"‚Ä¢"})]}),i.length>0&&t.jsx(ib,{warnings:i,onDismissWarnings:o})]})]});return t.jsxs(Ye.div,{className:"letter-card rounded-lg overflow-hidden border-2 border-emerald-200",initial:"hidden",animate:"visible",variants:Na(Ci),children:[li(),oi&&t.jsx("div",{className:"px-4 pt-3",children:t.jsxs("div",{className:"flex items-center gap-2 rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-900",children:[t.jsx(Ac,{className:"h-3.5 w-3.5 text-amber-600"}),t.jsxs("span",{className:"font-semibold",children:[Fi," proof-first"]}),t.jsx("span",{className:"text-amber-700",children:"Review key facts before report generation."})]})}),t.jsx(as,{children:r==="tavi-workup"&&$e&&$!=="complete"&&t.jsx(Ye.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:Ho.normal},className:"p-4 border-b border-gray-200",children:t.jsx(np,{progress:$e,startTime:Xe||void 0,agentType:r,audioDuration:d,showTimeEstimate:!0,skipStages:Ze==="mobile"?["audio-processing","transcribing"]:[]})})}),t.jsx(as,{children:$e&&r!=="tavi-workup"&&$!=="complete"&&t.jsx(Ye.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:Ho.normal},className:"p-4 border-b border-gray-200",children:t.jsx(np,{progress:$e,startTime:Xe||void 0,agentType:r||void 0,transcriptionLength:A?.length,audioDuration:d,showTimeEstimate:!0,skipStages:Ze==="mobile"?["audio-processing","transcribing"]:[]})})}),t.jsx(as,{children:Pi&&t.jsx(Ye.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:Ho.normal},children:t.jsx(Gi,{originalTranscription:A??"",sessionId:l,sessionSource:Ze,sessionErrors:k,pendingAudio:L,onTranscriptionCopy:h,onTranscriptionInsert:f,onTranscriptionEdit:u,transcriptionSaveStatus:x,onAgentReprocess:N,onRetryTranscription:v,isRetryingTranscription:j,currentAgent:b,isProcessing:T,audioBlob:w,defaultExpanded:!Rr,collapseWhen:Rr,approvalState:G,onTranscriptionApprove:X})})}),t.jsx(as,{children:Ft&&t.jsxs(Ye.div,{className:"p-4",initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:Ho.normal},children:[t.jsx(as,{children:S&&t.jsxs(Ye.div,{className:"space-y-4",initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:Ho.quick},children:[A&&t.jsx(Gi,{originalTranscription:A??"",sessionId:l,sessionSource:Ze,sessionErrors:k,pendingAudio:L,onTranscriptionCopy:h,onTranscriptionInsert:f,onTranscriptionEdit:u,transcriptionSaveStatus:x,onAgentReprocess:N,onRetryTranscription:v,isRetryingTranscription:j,currentAgent:b,isProcessing:!0,audioBlob:w,defaultExpanded:!0,collapseWhen:!1,approvalState:G,onTranscriptionApprove:X}),t.jsxs("div",{className:"rounded-lg border border-emerald-300 bg-emerald-50",children:[t.jsxs("div",{className:"flex items-center justify-between p-2 border-b border-emerald-200 bg-emerald-100",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-emerald-600 text-sm",children:"‚óè Live Output"}),Y!=null&&t.jsxs("span",{className:"text-xs text-emerald-700",children:["TTFT: ",Y," ms"]})]}),t.jsx(ye,{onClick:te,variant:"danger",size:"sm",className:"text-xs px-2 py-1",children:"Stop"})]}),t.jsx("div",{className:"p-3 max-h-64 overflow-y-auto",children:t.jsx("pre",{className:"whitespace-pre-wrap text-sm text-gray-900",children:H})})]})]})}),t.jsx(as,{children:I&&(I.missing_diagnostic?.length>0||I.missing_intervention?.length>0||I.missing_purpose?.length>0||I.missing_clinical?.length>0||I.missing_recommendations?.length>0||I.missing_structured?.length>0)&&t.jsx(Ye.div,{className:"mb-4",initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:Ho.quick},children:t.jsx(lb,{missingInfo:I,onSubmit:lt=>C&&C(lt),onDismiss:E,agentType:r})})}),le&&he?t.jsxs(Ye.div,{className:"letter-card rounded-lg border border-blue-200 bg-blue-50",variants:Na(Ci),initial:"hidden",animate:"visible",children:[t.jsxs("div",{className:"p-3 border-b border-blue-200 bg-blue-100 flex justify-between items-center",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-pulse"}),t.jsx("h4",{className:"text-blue-800 font-semibold text-sm",children:"Generating Response..."})]}),ve&&t.jsx(ye,{onClick:ve,variant:"ghost",size:"sm",className:"text-blue-600 hover:text-blue-800","aria-label":"Cancel streaming",children:"Cancel"})]}),t.jsxs("div",{className:"p-4",children:[t.jsxs("div",{className:"text-gray-800 text-sm leading-relaxed whitespace-pre-wrap font-mono",children:[he,t.jsx("span",{className:"inline-block w-2 h-4 bg-blue-500 animate-pulse ml-1"})]}),t.jsx("div",{className:"mt-3 text-xs text-blue-600",children:"Real-time generation in progress..."})]})]}):ha?t.jsxs(t.Fragment,{children:[console.log("üñºÔ∏è RESULTS PANEL: Rendering AIReviewCards with data:",R),t.jsx(nb,{reviewData:R,storageKey:"ui_preferences_card_theme"})]}):r==="quick-letter"&&s&&!S?(console.log("‚úÖ RESULTS PANEL: Using QuickLetter dual-card display",{hasResults:!!s,resultsLength:s?.length||0,hasSummary:!!e,summaryLength:e?.length||0,hasTranscription:er,transcriptionLength:A?.length||0,hasAudioBlob:!!w,agentType:r,streaming:S}),null,t.jsxs(Ye.div,{className:"space-y-4",variants:Na(X2),initial:"hidden",animate:"visible",transition:{staggerChildren:Y2.normal,delayChildren:.1},children:[t.jsxs(Ye.div,{className:"letter-card rounded-lg border border-emerald-200 bg-emerald-50 overflow-hidden",variants:Na(Ci),children:[t.jsx("div",{className:"px-4 py-3 border-b border-emerald-200 bg-emerald-100",children:t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("h4",{className:"text-emerald-800 font-semibold text-sm",children:"Summary"}),t.jsx(rc,{onCopy:ta,onInsert:ja,copiedRecently:rn.copied,insertedRecently:rn.inserted,actions:["copy","insert"]})]})}),t.jsx("div",{className:"p-4 max-h-48 overflow-y-auto",children:t.jsx("div",{className:"text-gray-900 text-sm leading-relaxed whitespace-pre-wrap",children:e||t.jsx("div",{className:"text-gray-500 italic",children:"Summary not available - displaying full letter content below"})})})]}),t.jsxs(Ye.div,{className:`letter-card rounded-lg border overflow-hidden ${Ht?"border-indigo-300 bg-indigo-50":"border-blue-200 bg-blue-50"}`,variants:Na(Ci),children:[t.jsx("div",{className:`px-4 py-3 border-b ${Ht?"border-indigo-200 bg-indigo-100":"border-blue-200 bg-blue-100"}`,children:t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsxs("div",{className:"flex items-center gap-1.5 min-w-0",children:[t.jsx("h4",{className:`font-semibold text-sm ${Ht?"text-indigo-800":"text-blue-800"}`,children:tr?"Letter (Editing)":"Letter"}),Ht&&t.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 text-[10px] font-medium text-indigo-700 bg-indigo-200 rounded",children:"Modified"})]}),t.jsx("div",{className:"flex-shrink-0",children:t.jsx(rc,{onCopy:ma,onInsert:sr,onTrain:_s?()=>dt?.(!tr):void 0,onReprocess:Lr&&!T?Ea:void 0,onPatient:V?void 0:q,copiedRecently:Gr.copied,insertedRecently:Gr.inserted,actions:["copy","insert",..._s?["train"]:[],...Lr?["reprocess"]:[],"patient"]})})]})}),t.jsx("div",{className:"p-4 max-h-96 overflow-y-auto",children:tr&&ct?t.jsx("textarea",{value:ct.edited,onChange:Bs,className:"w-full min-h-[220px] max-h-[360px] resize-y border border-blue-200 rounded-lg px-3 py-2 text-sm leading-relaxed bg-white focus:outline-none focus:ring-2 focus:ring-blue-300",placeholder:"Update the letter content before saving a golden example...","aria-label":"Quick letter editable content"}):t.jsx("div",{className:"text-gray-900 text-sm leading-relaxed whitespace-pre-wrap",children:zr})})]}),t.jsx(as,{children:ee&&t.jsxs(Ye.div,{className:"letter-card rounded-lg border border-purple-200 bg-purple-50 overflow-hidden",variants:Na(Ci),initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{delay:.2},children:[t.jsx("div",{className:"px-4 py-3 border-b border-purple-200 bg-purple-100",children:t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("h4",{className:"text-purple-800 font-semibold text-sm",children:"Patient-Friendly Version"}),t.jsx(rc,{onCopy:$a,onInsert:nn,copiedRecently:mr.copied,insertedRecently:mr.inserted,actions:["copy","insert"]})]})}),t.jsx("div",{className:"p-4 max-h-96 overflow-y-auto",children:t.jsx("div",{className:"text-gray-900 text-sm leading-relaxed whitespace-pre-wrap",children:ee})})]})}),r==="quick-letter"&&(mt||Qt)&&t.jsx(mv,{status:mt||"idle",result:Qt||null,onIntegrate:ts||(async()=>{}),onUndo:Yt||(()=>{}),canUndo:Ht,isIntegrating:Es,integrationError:vt||null})]})):Dr?t.jsxs("div",{className:"space-y-6",children:[t.jsx(Gi,{originalTranscription:A||"",sessionId:l,sessionSource:Ze,sessionErrors:k,pendingAudio:L,onTranscriptionCopy:h,onTranscriptionInsert:f,onTranscriptionEdit:u,transcriptionSaveStatus:x,onAgentReprocess:N,onRetryTranscription:v,isRetryingTranscription:j,currentAgent:b,isProcessing:T,audioBlob:w,defaultExpanded:!Rr,collapseWhen:Rr,approvalState:G,onTranscriptionApprove:X}),t.jsx(o5,{structuredSections:ke,results:s,missingInfo:I?.missing_structured||[],onCopy:a,onInsertToEMR:n,onReprocessWithAnswers:C,validationResult:Le,validationStatus:Be,onReprocessWithValidation:Re})]}):ra?t.jsx(VE,{rhcReport:xe,results:s,onCopy:a,onInsertToEMR:n,onUpdateRhcReport:Ne,onReprocessWithValidation:it,originalTranscription:A,onTranscriptionCopy:h,onTranscriptionInsert:f,onTranscriptionEdit:u,transcriptionSaveStatus:x,onAgentReprocess:N,currentAgent:b,isProcessing:T,audioBlob:w,defaultTranscriptionExpanded:!Rr,collapseTranscriptionWhen:Rr,approvalState:G,onTranscriptionApprove:X,selectedPatientName:c,onReprocessWithAnswers:C,onDismissMissingInfo:E}):pa?t.jsxs("div",{className:"space-y-6",children:[t.jsx(Gi,{originalTranscription:A||"",sessionId:l,sessionSource:Ze,sessionErrors:k,pendingAudio:L,onTranscriptionCopy:h,onTranscriptionInsert:f,onTranscriptionEdit:u,transcriptionSaveStatus:x,onAgentReprocess:N,onRetryTranscription:v,isRetryingTranscription:j,currentAgent:b,isProcessing:T,audioBlob:w,defaultExpanded:!Rr,collapseWhen:Rr,approvalState:G,onTranscriptionApprove:X}),t.jsx(c4,{report:{id:`report-${Date.now()}`,timestamp:Date.now(),content:s,agentName:O||"Patient Education & Lifestyle Medicine",metadata:{processingTime:K||0,confidence:.9,modelUsed:"medgemma-27b"},sections:[],warnings:i||[],errors:k||[],educationData:we||{priority:"medium",modules:[],australianGuidelines:[],patientResources:[],jsonMetadata:null,letterContent:s}},onCopy:async lt=>{await Promise.resolve(a(lt))},onInsert:async lt=>{await Promise.resolve(n(lt))},isVisible:!0})]}):ka?t.jsx(gv,{session:{id:l||`session-${Date.now()}`,patient:{name:c||"Unknown",id:"",dob:"",age:"",extractedAt:Date.now()},transcription:A||"",results:s,agentType:"pre-op-plan",agentName:O||"Pre-Op Plan",timestamp:Date.now(),status:"completed",completed:!0,processingTime:K||void 0,modelUsed:W||void 0,warnings:i||void 0,errors:k||void 0,completedTime:Date.now(),preOpPlanData:de||N4(s)||{procedureType:"ANGIOGRAM_OR_PCI",cardMarkdown:s,jsonData:{procedure_type:"ANGIOGRAM_OR_PCI",fields:{}}},audioBlob:w||void 0},onCopy:a,onInsertToEMR:n,onTranscriptionCopy:h,onTranscriptionInsert:f,onTranscriptionEdit:u,onTranscriptionApprove:X,transcriptionApprovalState:G,onAgentReprocess:b?()=>N?.(b):void 0,isProcessing:T}):(r==="quick-letter"&&console.warn("‚ö†Ô∏è RESULTS PANEL: Quick Letter falling through to generic ReportDisplay",{hasResults:!!s,resultsLength:s?.length||0,hasSummary:!!e,summaryLength:e?.length||0,streaming:S,reason:s?S?"Still streaming":"Unknown":"No results"}),null,t.jsxs("div",{className:"space-y-4",children:[t.jsx(kp,{results:s,agentType:r,onCopy:ie,onInsert:Qe,copiedRecently:On.copied,insertedRecently:On.inserted}),r==="investigation-summary"&&At&&!S&&t.jsx("div",{className:"mt-4 mx-4",children:t.jsxs("details",{className:"group",children:[t.jsxs("summary",{className:"cursor-pointer text-xs text-gray-500 hover:text-gray-700 flex items-center gap-1.5 py-2",children:[t.jsx("svg",{className:"w-3 h-3 transition-transform group-open:rotate-90",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),t.jsx("span",{className:"font-medium",children:"AI Vision Interpretation"}),t.jsx("span",{className:"text-gray-400",children:"(what the AI extracted from the image)"})]}),t.jsxs("div",{className:"mt-2 p-3 bg-gray-50 rounded-lg border border-gray-200",children:[t.jsx("p",{className:"text-[10px] text-gray-400 mb-2 italic",children:"This shows the raw extraction from the vision model - for your reference only, not copied with results"}),t.jsx("div",{className:"text-xs text-gray-600 leading-relaxed whitespace-pre-wrap select-none",children:At})]})]})}),r==="investigation-summary"&&!S&&(er||Tt)&&t.jsx(Gi,{originalTranscription:A??"",sessionId:l,sessionSource:Ze,sessionErrors:k,pendingAudio:L,onTranscriptionCopy:h,onTranscriptionInsert:f,onTranscriptionEdit:u,transcriptionSaveStatus:x,onAgentReprocess:N,onRetryTranscription:v,isRetryingTranscription:j,currentAgent:b,isProcessing:T,audioBlob:w,defaultExpanded:!Rr,collapseWhen:Rr,approvalState:G,onTranscriptionApprove:X,className:"mt-4 pt-3 border-t border-gray-200"})]}))]})}),t.jsx(as,{children:r==="angiogram-pci"&&ee&&!T&&t.jsx(Ye.div,{className:"space-y-4 px-4",initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{delay:.2},children:t.jsxs("div",{className:"letter-card rounded-lg border border-blue-200 bg-blue-50",children:[t.jsx("div",{className:"p-3 border-b border-blue-200 bg-blue-100",children:t.jsx("h4",{className:"text-blue-800 font-semibold text-sm",children:"Patient-Friendly Explanation"})}),t.jsx("div",{className:"p-3 max-h-96 overflow-y-auto",children:t.jsx("div",{className:"text-gray-900 text-sm leading-relaxed whitespace-pre-wrap",children:ee})}),t.jsx("div",{className:"p-3 border-t border-blue-200 bg-blue-50",children:t.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[t.jsx(ye,{onClick:$a,variant:mr.copied?"success":"outline",size:"md",icon:mr.copied?t.jsx(Wo,{className:"w-4 h-4 text-blue-600 checkmark-appear"}):t.jsx(Zy,{className:"w-4 h-4",title:"Copy"}),isSuccess:mr.copied,className:`p-3 flex flex-col items-center space-y-1 ${mr.copied?"bg-blue-500/20 border-blue-400 text-blue-700 completion-celebration":"bg-white/60 border-blue-200 hover:bg-blue-50/60 text-gray-700"}`,children:t.jsx("span",{className:`text-xs ${mr.copied?"text-blue-700":"text-gray-700"}`,children:mr.copied?"Copied!":"Copy"})}),t.jsx(ye,{onClick:nn,variant:mr.inserted?"success":"outline",size:"md",icon:mr.inserted?t.jsx(Wo,{className:"w-4 h-4 text-blue-600 checkmark-appear"}):t.jsx(SC,{className:"w-4 h-4"}),isSuccess:mr.inserted,className:`p-3 flex flex-col items-center space-y-1 ${mr.inserted?"bg-blue-500/20 border-blue-400 text-blue-700 completion-celebration":"bg-white/60 border-blue-200 hover:bg-blue-50/60 text-gray-700"}`,children:t.jsx("span",{className:`text-xs ${mr.inserted?"text-blue-700":"text-gray-700"}`,children:mr.inserted?"Inserted!":"Insert"})}),t.jsx(ye,{onClick:on,variant:"outline",size:"md",icon:t.jsx(Ya,{className:"w-4 h-4"}),className:"bg-white/60 border-blue-200 p-3 flex flex-col items-center space-y-1 hover:bg-blue-50/60 text-gray-700",children:t.jsx("span",{className:"text-xs text-gray-700",children:"Download"})})]})})]})})}),t.jsx(as,{children:!T&&!ha&&!sa&&!Dr&&!ra&&r!=="investigation-summary"&&r!=="background"&&r!=="medication"&&t.jsx(Ye.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{delay:.3},children:t.jsx(Ep,{results:s,agentType:r,onCopy:a,onInsertToEMR:n,onEditAndTrain:dt?()=>dt(!tr):void 0,editAndTrainActive:tr,disableEditAndTrain:T||!s,customActions:Sa})})}),t.jsx(as,{children:tr&&ct&&t.jsx(Ye.div,{className:"px-4 pb-2",initial:{opacity:0,y:16},animate:{opacity:1,y:0},exit:{opacity:0,y:-16},transition:{duration:.2},children:t.jsxs("div",{"data-testid":"result-revision-panel",className:"border border-blue-200 bg-blue-50/70 rounded-xl shadow-sm p-4 sm:p-5 space-y-4",children:[t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[t.jsx("div",{className:"flex flex-wrap items-center gap-2",children:zt.length===0?t.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 text-xs font-medium",children:[t.jsx(Dg,{className:"w-3 h-3"}),"Training Capture"]}):zt.map(lt=>t.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 text-xs font-medium",children:[t.jsx(Dg,{className:"w-3 h-3"}),lt]},lt))}),t.jsx(ye,{type:"button",onClick:()=>dt?.(!1),variant:"ghost",size:"sm",startIcon:t.jsx(es,{className:"w-3 h-3"}),className:"text-xs text-blue-700 hover:text-blue-900",children:"Close"})]}),t.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-xs font-semibold text-blue-900 uppercase tracking-wide",children:"Original Output"}),t.jsx("div",{className:"p-3 bg-white border border-blue-100 rounded-lg max-h-64 overflow-auto text-sm whitespace-pre-wrap text-slate-700",children:ct.original||"No original output available."})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("p",{className:"text-xs font-semibold text-blue-900 uppercase tracking-wide",children:"Edited Revision"}),ct.hasUnsavedChanges?t.jsxs("span",{className:"text-[11px] text-amber-600 font-medium flex items-center gap-1",children:[t.jsx(dl,{className:"w-3 h-3"}),"Unsaved changes"]}):kt?t.jsxs("span",{className:"text-[11px] text-emerald-600 flex items-center gap-1",children:[t.jsx(Wo,{className:"w-3 h-3"}),"Saved ",kt]}):null]}),t.jsx("textarea",{"data-testid":"revision-editor",value:ct.edited,onChange:Bs,className:"w-full min-h-[200px] max-h-[320px] resize-y border border-blue-200 rounded-lg px-3 py-2 text-sm font-mono bg-white focus:outline-none focus:ring-2 focus:ring-blue-300",placeholder:"Make clinician revisions here..."})]})]}),ot&&t.jsxs("div",{className:"flex flex-wrap gap-4 text-xs text-blue-900",children:[t.jsxs("span",{children:["Characters: ",ot.editedLength," ","(",ot.deltaChars>=0?"+":"",ot.deltaChars,")"]}),t.jsxs("span",{children:["Words: ",ot.editedWords," ","(",ot.deltaWords>=0?"+":"",ot.deltaWords,")"]})]}),t.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsxs("label",{className:"text-xs font-semibold text-blue-900 uppercase tracking-wide",children:["Scenario Summary ",t.jsx("span",{className:"text-red-500",children:"*"})]}),t.jsx("textarea",{"data-testid":"revision-notes",value:ct.notes,onChange:ls,placeholder:"Example: Normalize measurement spacing, abbreviations, ensure parentheses",className:"w-full h-24 resize-y border border-blue-200 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-300"}),t.jsx("p",{className:"text-[11px] text-blue-700",children:"Describe why this revision is a gold standard example for future optimization."})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"space-y-1",children:[t.jsx("label",{className:"text-xs font-semibold text-blue-900 uppercase tracking-wide",children:"Tags"}),t.jsx("input",{type:"text",value:yr,onChange:Qs,placeholder:"heart-failure, formatting, urgent",className:"w-full border border-blue-200 rounded-lg px-3 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-300"}),t.jsx("p",{className:"text-[11px] text-blue-700",children:"Comma-separated tags help cluster similar training examples."})]}),t.jsxs("label",{className:"flex items-center gap-2 text-sm text-blue-900",children:[t.jsx("input",{type:"checkbox",className:"rounded border-blue-300 text-blue-600 focus:ring-blue-400",checked:ct.runEvaluationOnSave,onChange:Vs}),"Run GEPA preview after saving golden pair"]})]})]}),t.jsxs("div",{className:"flex flex-wrap justify-end gap-2",children:[t.jsx(ye,{type:"button",onClick:qe,disabled:!ct.hasUnsavedChanges||Ge,variant:"outline",size:"md",className:ct.hasUnsavedChanges&&!Ge?"border-blue-300 text-blue-700 hover:bg-blue-100":"border-blue-100 text-blue-400",children:"Reset"}),t.jsx(ye,{"data-testid":"save-revision-btn",type:"button",onClick:Se,disabled:ze,variant:"primary",size:"md",isLoading:Ge,startIcon:Ge?t.jsx(Za,{className:"w-4 h-4 animate-spin"}):void 0,className:ze?"bg-blue-200 border-blue-200 text-white":"bg-blue-600 border-blue-600 text-white hover:bg-blue-700",children:"Save Revision"}),t.jsx(ye,{"data-testid":"mark-golden-pair-btn",type:"button",onClick:ut,disabled:Gt,variant:"success",size:"md",isLoading:rt,startIcon:rt?t.jsx(Za,{className:"w-4 h-4 animate-spin"}):t.jsx(Ac,{className:"w-4 h-4"}),className:Gt?"bg-emerald-200 border-emerald-200 text-white":"bg-emerald-600 border-emerald-600 text-white hover:bg-emerald-700",children:"Mark as Golden Pair"})]})]})})}),t.jsx(as,{children:$==="complete"&&K&&t.jsx(Ye.div,{className:"px-4 pb-4",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{delay:.4},children:t.jsx(RC,{appState:{processingStatus:$,totalProcessingTime:K,transcriptionTime:M,agentProcessingTime:P,currentAgent:r,currentAgentName:O,processingStartTime:null},isRecording:!1,recordingTime:0,transcriptionLength:A?A.length:0,modelUsed:W})})}),t.jsx(ob,{failedAudioRecordings:Q,errors:k,onClearFailedRecordings:D}),r==="angiogram-pci"&&ur&&kr&&t.jsx(uA,{agentLabel:"Angiogram/PCI",validation:kr,fieldConfig:b4,copy:v4,onCancel:()=>{console.log("üö´ Angio Display: Validation cancelled"),Oa()},onSkip:()=>{console.log("‚è≠Ô∏è Angio Display: Validation skipped"),tn()},onContinue:lt=>{console.log("‚úÖ Angio Display: Validation complete, user fields:",lt),Qa(lt),ce&&ce(lt)}}),r==="mteer"&&sn&&Mn&&t.jsx(uA,{agentLabel:"mTEER Procedure",validation:Mn,fieldConfig:w4,copy:C4,onCancel:()=>{console.log("üö´ mTEER Display: Validation cancelled"),ua()},onSkip:()=>{console.log("‚è≠Ô∏è mTEER Display: Validation skipped"),_n()},onContinue:lt=>{console.log("‚úÖ mTEER Display: Validation complete, user fields:",lt),os(lt),fe&&fe(lt)}}),(fs&&re||r==="angiogram-pci"&&Me)&&Nt&&Vt.length>0&&t.jsx(l4,{facts:Vt,agentLabel:fs?"TAVI Procedure":"Angiogram/PCI",onComplete:lt=>{console.log(`‚úÖ ${r} Proof Mode: Facts confirmed`,lt),gs(!1),fs&&re?re.onComplete(lt):r==="angiogram-pci"&&Me&&Me.onComplete(lt)},onCancel:()=>{console.log(`üö´ ${r} Proof Mode: Cancelled`),gs(!1),fs&&re?re.onCancel():r==="angiogram-pci"&&Me&&Me.onCancel()},isOpen:Nt,initialConfig:Kt,lesionTree:r==="angiogram-pci"?Me?.lesionTree:void 0})]})});fv.displayName="OptimizedResultsPanel";const xv={lm:"LM (left main)",lad:"LAD (left anterior descending)",lcx:"LCx (left circumflex)",rca:"RCA (right coronary artery)",grafts:"Grafts"},B4=[{regex:/diagonal\s*[\d]*/i,label:"Diagonal"},{regex:/\bD(\d)/i,label:"D$1"},{regex:/ramus/i,label:"Ramus"},{regex:/septal/i,label:"Septal"},{regex:/obtuse\s*marginal\s*\d*/i,label:"Obtuse marginal"},{regex:/\bOM\s*\d*/i,label:"OM"},{regex:/posterior\s*descending|PDA/i,label:"PDA"},{regex:/posterolateral|PLV/i,label:"PLV"},{regex:/graft/i,label:"Graft"}],yv=()=>({lm:[],lad:[],lcx:[],rca:[],grafts:[]}),Zf=s=>s.replace(/^[\s-‚Ä¢]+/,"").trim(),S4=(s,e)=>{for(const r of B4){const a=s.match(r.regex);if(a)return r.label.includes("$1")&&a[1]?r.label.replace("$1",a[1]):r.label}return e},j4=s=>{const e=s.match(/(\d+)\s*%/);if(e)return`${e[1]}% stenosis`;const a=["no significant stenosis","mild","moderate","severe","occluded","chronic total occlusion","calcified","normal"].find(n=>s.toLowerCase().includes(n));return a||""},E4=s=>{const e=s.toUpperCase();return e.includes("LM")||e.includes("LEFT MAIN")?"lm":e.includes("LAD")||e.includes("ANTERIOR")?"lad":e.includes("LCX")||e.includes("CIRCUMFLEX")?"lcx":e.includes("RCA")||e.includes("RIGHT CORONARY")?"rca":e.includes("GRAFT")?"grafts":null},k4=s=>{const e=s.match(/\*\*FINDINGS\*\*\s*([\s\S]*?)(?=\n\*\*[A-Z ]+\*\*|$)/i);return e&&e[1]?e[1].trim():s},I4=(s,e)=>{const r=xv[e],a=s.split(/(?:\.\s+|\?\s+|!\s+|\n+)/).map(n=>Zf(n)).filter(Boolean);return a.length===0&&s.trim()&&a.push(Zf(s)),a.map(n=>({id:Math.random().toString(36).slice(2,8),branch:S4(n,r),severity:j4(n),description:n}))},Cd=s=>{const e=k4(s),r=yv(),a=/\*\*\s*([A-Za-z0-9\s()/-]+?)\s*\*\*\s*([\s\S]*?)(?=\n\*\*|$)/g;let n;for(;(n=a.exec(e))!==null;){const i=n[1],o=n[2]?.trim()||"",l=E4(i);l&&(r[l]=I4(o,l))}return r},e0=s=>["lm","lad","lcx","rca","grafts"].map(r=>{const a=s[r]||[],n=xv[r];if(!a.length)return`**${n}**
- No significant stenosis.`;const i=a.map(o=>`- ${[o.branch,o.severity,o.description].map(c=>c?.trim()).filter(Boolean).join(" ‚Äî ")}`);return`**${n}**
${i.join(`
`)}`}).join(`

`),t0=(s,e)=>{const r=/(\*\*FINDINGS\*\*\s*)([\s\S]*?)(?=(\n\*\*[A-Z ]+\*\*)|$)/i;return r.test(s)?s.replace(r,`$1${e}

`):`${s.trim()}

**FINDINGS**
${e}`},s0=yv,r0=[{key:"lm",color:"bg-amber-400",label:"Left Main",abbrev:"LM"},{key:"lad",color:"bg-rose-400",label:"Left Anterior Descending",abbrev:"LAD"},{key:"lcx",color:"bg-sky-400",label:"Left Circumflex",abbrev:"LCx"},{key:"rca",color:"bg-emerald-400",label:"Right Coronary",abbrev:"RCA"},{key:"grafts",color:"bg-indigo-400",label:"Grafts",abbrev:"Grafts"}],T4=({lesion:s,vesselAbbrev:e,vesselColor:r,onChange:a,onRemove:n})=>t.jsxs("div",{className:"relative bg-white rounded border border-gray-200 group hover:border-blue-300 transition-colors",children:[t.jsx("div",{className:`absolute left-0 top-0 bottom-0 w-0.5 rounded-l ${r}`}),t.jsxs("div",{className:"pl-2 pr-1 py-1.5",children:[t.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[t.jsx("input",{className:"flex-1 min-w-0 rounded border border-gray-200 bg-gray-50 px-1.5 py-1 text-xs font-medium text-gray-900 focus:border-blue-400 focus:bg-white focus:outline-none",value:s.branch,onChange:i=>a("branch",i.target.value),placeholder:e,title:"Branch/Segment"}),t.jsx("input",{className:"w-20 flex-shrink-0 rounded border border-gray-200 bg-gray-50 px-1.5 py-1 text-xs text-gray-700 focus:border-blue-400 focus:bg-white focus:outline-none",value:s.severity,onChange:i=>a("severity",i.target.value),placeholder:"%",title:"Stenosis %"}),t.jsx("button",{onClick:n,className:"p-1 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded flex-shrink-0",title:"Remove",children:t.jsx(Ln,{className:"w-3 h-3"})})]}),t.jsx("textarea",{className:"w-full rounded border border-gray-200 bg-gray-50 px-1.5 py-1 text-xs text-gray-600 focus:border-blue-400 focus:bg-white focus:outline-none resize-none",value:s.description,onChange:i=>a("description",i.target.value),placeholder:"Description...",title:"Description",rows:2})]})]}),F4=({vessel:s,lesions:e,onLesionChange:r,onAddLesion:a,onRemoveLesion:n})=>{const[i,o]=m.useState(e.length>0),l=e.length>0;return t.jsxs("div",{className:"border-b border-gray-100 last:border-b-0",children:[t.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1.5 cursor-pointer hover:bg-gray-50/50",onClick:()=>o(!i),children:[t.jsx("span",{className:`h-2 w-2 rounded-full flex-shrink-0 ${s.color}`}),t.jsx("span",{className:"text-xs font-semibold text-gray-800",children:s.abbrev}),t.jsx("span",{className:"text-[10px] text-gray-400 flex-1 truncate",children:s.label}),l?t.jsx("span",{className:"px-1.5 py-0.5 text-[10px] font-medium bg-blue-100 text-blue-700 rounded-full",children:e.length}):t.jsx("span",{className:"text-[10px] text-gray-400",children:"‚Äî"}),i?t.jsx(ps,{className:"w-3 h-3 text-gray-400 flex-shrink-0"}):t.jsx(ti,{className:"w-3 h-3 text-gray-400 flex-shrink-0"})]}),i&&t.jsxs("div",{className:"px-2 pb-2 space-y-1.5",children:[e.map(c=>t.jsx(T4,{lesion:c,vesselAbbrev:s.abbrev,vesselColor:s.color,onChange:(A,d)=>r(c.id,A,d),onRemove:()=>n(c.id)},c.id)),!l&&t.jsx("div",{className:"text-[10px] text-gray-400 py-1.5 px-2 bg-gray-50 rounded border border-dashed border-gray-200",children:"No findings"}),t.jsxs("button",{onClick:c=>{c.stopPropagation(),a()},className:"flex items-center gap-1 text-[10px] text-blue-600 hover:text-blue-700 hover:bg-blue-50 px-2 py-1 rounded transition-colors",children:[t.jsx(Fr,{className:"w-3 h-3"}),"Add"]})]})]})},bv=({open:s,lesionTree:e,onClose:r,onConfirm:a})=>{const[n,i]=m.useState(s0());m.useEffect(()=>{i(e||s0())},[e,s]);const o=m.useMemo(()=>Object.values(n).reduce((d,h)=>d+h.length,0),[n]),l=(d,h,f,u)=>{i(x=>({...x,[d]:x[d].map(b=>b.id===h?{...b,[f]:u}:b)}))},c=d=>{i(h=>({...h,[d]:[...h[d],{id:Math.random().toString(36).slice(2,8),branch:r0.find(f=>f.key===d)?.abbrev||"",severity:"",description:""}]}))},A=(d,h)=>{i(f=>({...f,[d]:f[d].filter(u=>u.id!==h)}))};return s?t.jsx("div",{className:"fixed inset-0 z-50 flex flex-col bg-black/40 backdrop-blur-sm p-2",children:t.jsxs("div",{className:"flex-1 flex flex-col rounded-lg border border-blue-200 bg-white shadow-2xl overflow-hidden",children:[t.jsxs("div",{className:"flex items-center justify-between gap-2 px-2 py-2 border-b border-blue-100 bg-gradient-to-r from-blue-50 to-white flex-shrink-0",children:[t.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[t.jsx(Ny,{className:"w-4 h-4 text-blue-600 flex-shrink-0"}),t.jsxs("div",{className:"min-w-0",children:[t.jsx("h3",{className:"text-xs font-semibold text-gray-900",children:"Review Findings"}),t.jsxs("p",{className:"text-[10px] text-gray-500",children:[o," finding",o===1?"":"s"]})]})]}),t.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[t.jsxs("button",{onClick:r,className:"flex items-center gap-1 px-2 py-1 text-[10px] text-gray-600 hover:bg-gray-100 rounded",children:[t.jsx(es,{className:"w-3 h-3"}),"Skip"]}),t.jsxs("button",{onClick:()=>a(n),className:"flex items-center gap-1 px-2 py-1 text-[10px] font-medium text-white bg-blue-600 hover:bg-blue-700 rounded",children:[t.jsx(Ms,{className:"w-3 h-3"}),"Update"]})]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto bg-gray-50/50",children:r0.map(d=>t.jsx(F4,{vessel:d,lesions:n[d.key],onLesionChange:(h,f,u)=>l(d.key,h,f,u),onAddLesion:()=>c(d.key),onRemoveLesion:h=>A(d.key,h)},d.key))}),t.jsx("div",{className:"px-2 py-1.5 bg-gray-50 border-t border-gray-200 flex-shrink-0",children:t.jsx("p",{className:"text-[10px] text-gray-400 text-center",children:"Edit findings or skip to keep original"})})]})}):null};bv.displayName="AngioLesionReviewDialog";const a0=[{id:"ai-medical-review",label:"AI Medical Review",icon:By,description:"Australian clinical oversight and guidelines review (analyzes existing EMR data)"},{id:"batch-ai-review",label:"Batch AI Review",icon:ji,description:"AI review for multiple patients from appointment book"}],P4=({onQuickAction:s,processingAction:e,isFooter:r=!1})=>{const[a,n]=m.useState(null),i=async(l,c)=>{if(l==="ai-medical-review"){n(l),console.log("ü§ñ AI Medical Review action triggered...");try{console.log("üìã EMR EXTRACTION: Starting EMR data extraction via service worker...");const A=await new Promise(d=>{console.log("üìã EMR EXTRACTION: Sending EXTRACT_EMR_DATA_AI_REVIEW message to service worker"),chrome.runtime.sendMessage({type:"EXTRACT_EMR_DATA_AI_REVIEW",fields:["background","investigations","medications-problemlist"]},h=>{if(console.log("üìã EMR EXTRACTION: Response from service worker:",h),chrome.runtime.lastError){console.error("üìã EMR EXTRACTION: Chrome runtime error:",chrome.runtime.lastError),d({success:!1,error:`Chrome runtime error: ${chrome.runtime.lastError.message}`});return}if(!h){console.error("üìã EMR EXTRACTION: No response received from service worker"),d({success:!1,error:"No response from service worker"});return}d(h)})});if(A.success&&A.data){const d=A.data;if(console.log("üìã EMR EXTRACTION: Successfully received data:",d),Object.entries(d).filter(([u,x])=>x&&typeof x=="string"&&x.trim().length>0).length===0)throw new Error("No EMR data found. Please ensure you're on a patient page with clinical data.");const f=`
Background: ${d.background||"No background data available"}

Investigations: ${d.investigations||"No investigations data available"}

Medications: ${d["medications-problemlist"]||"No medications data available"}
          `.trim();console.log("üìã EMR EXTRACTION: Processing EMR data for AI review"),await s(l,{emrData:d,formattedInput:f,type:"australian-medical-review"}),console.log("‚úÖ AI Medical Review completed successfully")}else{const d=A.error||"Unknown extraction error";throw new Error(`Failed to extract EMR data: ${d}`)}}catch(A){console.error("‚ùå AI Medical Review failed:",A);const d=A instanceof Error?A.message:"Unknown error";console.error("AI Review Error:",d),typeof window<"u"&&alert(`AI Medical Review Error

${d}`)}finally{n(null)}return}try{n(l),console.log("‚ö° Calling onQuickAction for AI Review..."),await s(l,l==="batch-ai-review"?{type:"show-modal"}:c),console.log("‚ö° AI Review onQuickAction completed successfully")}catch(A){console.error(`‚ùå AI Review action ${l} failed:`,A)}finally{n(null)}},o=l=>e===l||a===l;return r?t.jsxs("div",{className:"bg-white",children:[t.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[t.jsx(sl,{className:"w-3 h-3 text-indigo-600"}),t.jsx("h3",{className:"text-gray-900 font-medium text-xs",children:"AI Medical Review"})]}),t.jsx("div",{className:"grid grid-cols-2 gap-2",children:a0.map(l=>t.jsxs(ye,{onClick:()=>i(l.id),disabled:o(l.id),variant:"secondary",size:"md",className:"relative !h-auto p-2 flex-col bg-indigo-50 border-indigo-200 hover:bg-indigo-100",isLoading:o(l.id),children:[t.jsx(l.icon,{className:"w-3 h-3 text-indigo-600 flex-shrink-0 mb-1"}),t.jsx("div",{className:"text-gray-900 text-xs font-medium leading-tight",children:l.label})]},l.id))})]}):t.jsxs("div",{className:"glass rounded-card overflow-hidden",children:[t.jsx("div",{className:"p-4 border-b border-gray-200",children:t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(sl,{className:"w-5 h-5 text-indigo-600"}),t.jsxs("div",{className:"text-left",children:[t.jsx("h3",{className:"text-gray-900 font-medium text-sm",children:"AI Medical Review"}),t.jsx("p",{className:"text-gray-600 text-xs",children:"Clinical analysis and guidelines review"})]})]})}),t.jsx("div",{className:"p-4",children:t.jsx("div",{className:"grid grid-cols-1 gap-3",children:a0.map(l=>t.jsx(ye,{onClick:()=>i(l.id),disabled:o(l.id),variant:"secondary",size:"md",className:"relative !justify-start !h-auto p-3 bg-indigo-50 border-indigo-200 hover:bg-indigo-100",isLoading:o(l.id),startIcon:t.jsx(l.icon,{className:"w-4 h-4"}),children:t.jsxs("div",{className:"min-w-0 flex-1 text-left ml-2",children:[t.jsx("div",{className:"text-gray-900 text-xs font-medium truncate",children:l.label}),t.jsx("div",{className:"text-gray-600 text-xs mt-1 leading-tight",children:l.description})]})},l.id))})}),t.jsx("div",{className:"p-4 bg-indigo-50",children:t.jsxs("p",{className:"text-indigo-700 text-xs",children:["üí° ",t.jsx("strong",{children:"Note:"})," AI Review uses MedGemma-27b for comprehensive clinical analysis"]})})]})},xn={primary:{DEFAULT:"#8B5CF6",subtle:"#F5F3FF"},neutral:{200:"#E5E5E5",400:"#A3A3A3"},themes:{blue:{bg:"#EFF6FF",border:"#BFDBFE",text:"#1D4ED8",icon:"#3B82F6"},purple:{bg:"#F5F3FF",border:"#DDD6FE",text:"#7C3AED",icon:"#8B5CF6"},emerald:{bg:"#ECFDF5",border:"#A7F3D0",text:"#059669",icon:"#10B981"},amber:{bg:"#FFFBEB",border:"#FDE68A",text:"#D97706",icon:"#F59E0B"},red:{bg:"#FEF2F2",border:"#FECACA",text:"#DC2626",icon:"#EF4444"},cyan:{bg:"#ECFEFF",border:"#A5F3FC",text:"#0891B2",icon:"#06B6D4"},violet:{bg:"#F5F3FF",border:"#DDD6FE",text:"#7C3AED",icon:"#8B5CF6"}}},ir={sm:"6px",md:"8px",lg:"12px"},nl={sm:"0 1px 2px rgba(0, 0, 0, 0.05)",dropdown:"0 4px 16px rgba(0, 0, 0, 0.12)",modal:"0 20px 40px rgba(0, 0, 0, 0.15)",focusRing:"0 0 0 2px rgba(139, 92, 246, 0.4)"},$t={duration:{fast:120,normal:180},easing:{out:[0,0,.2,1],in:[.4,0,1,1]}},vv={dropdown:100},gA={header:{favourites:48}},wv=[{id:"workflows",label:"Workflows",description:"Full dictation workflows for consultations and procedures",defaultExpanded:!0},{id:"patient-context",label:"Patient Context",description:"EMR field entry and patient data",defaultExpanded:!0},{id:"documentation",label:"Documentation",description:"Investigations, education, and planning",defaultExpanded:!0},{id:"ai-tools",label:"AI Tools",description:"AI-powered analysis and review",defaultExpanded:!1},{id:"analysis",label:"Analysis",description:"Data import and trending",defaultExpanded:!1},{id:"utilities",label:"Utilities",description:"Media capture and task management",defaultExpanded:!1}],nm=[{id:"quick-letter",label:"Quick Letter",alias:"Letter",description:"Medical correspondence and consultation letters",icon:Rn,group:"workflows",shortcut:"L",modes:["dictate","type"],agentType:"quick-letter",estimatedTime:"1-3 min",complexity:"low",colorTheme:"blue"},{id:"consultation",label:"Consultation",alias:"Consult",description:"Comprehensive patient assessments",icon:lu,group:"workflows",shortcut:"C",modes:["dictate"],agentType:"consultation",estimatedTime:"2-4 min",complexity:"medium",colorTheme:"blue"},{id:"angiogram-pci",label:"Angiogram/PCI",alias:"Angio",description:"Cardiac catheterization and coronary interventions",icon:Zn,group:"workflows",modes:["dictate"],agentType:"angiogram-pci",estimatedTime:"8-15 min",complexity:"high",colorTheme:"red"},{id:"tavi",label:"TAVI Report",description:"Transcatheter aortic valve implantation",icon:i2,group:"workflows",shortcut:"T",modes:["dictate"],agentType:"tavi",estimatedTime:"8-12 min",complexity:"high",colorTheme:"red"},{id:"mteer",label:"mTEER Report",alias:"mTEER",description:"Mitral transcatheter edge-to-edge repair",icon:tl,group:"workflows",modes:["dictate"],agentType:"mteer",estimatedTime:"7-10 min",complexity:"high",colorTheme:"purple"},{id:"pfo-closure",label:"PFO Closure",alias:"PFO",description:"Patent foramen ovale closure",icon:sl,group:"workflows",modes:["dictate"],agentType:"pfo-closure",estimatedTime:"5-8 min",complexity:"medium",colorTheme:"emerald"},{id:"right-heart-cath",label:"Right Heart Cath",alias:"RHC",description:"Right heart catheterisation with haemodynamic assessment",icon:qi,group:"workflows",shortcut:"R",modes:["dictate","type"],agentType:"right-heart-cath",estimatedTime:"6-10 min",complexity:"medium",colorTheme:"amber"},{id:"ohif-viewer",label:"OHIF Viewer",alias:"OHIF",description:"Medical imaging viewer",icon:o2,group:"workflows",modes:["click"],agentType:"ohif-viewer",comingSoon:!0,colorTheme:"cyan"},{id:"background",label:"Background",description:"Patient background notes and history",icon:Do,group:"patient-context",shortcut:"B",modes:["dictate","type"],agentType:"background",quickActionField:"background",colorTheme:"blue"},{id:"medications",label:"Medications",alias:"Meds",description:"View and edit medication list",icon:l2,group:"patient-context",shortcut:"M",modes:["dictate","type"],agentType:"medication",quickActionField:"medications",colorTheme:"blue"},{id:"social-history",label:"Social History",alias:"Social",description:"Social and family history section",icon:c2,group:"patient-context",modes:["dictate","type"],agentType:"background",quickActionField:"social-history",colorTheme:"blue"},{id:"bloods",label:"Order Bloods",description:"Blood test results and analysis",icon:A2,group:"patient-context",modes:["dictate","type"],agentType:"bloods",quickActionField:"bloods",colorTheme:"blue"},{id:"imaging",label:"Order Imaging",description:"Medical imaging reports and analysis",icon:Rg,group:"patient-context",modes:["dictate","type"],agentType:"imaging",quickActionField:"imaging",colorTheme:"blue"},{id:"investigation-summary",label:"Investigations",alias:"Invests",description:"Investigation summary with dictation, typing, or image scan",icon:cl,group:"patient-context",shortcut:"I",modes:["dictate","type","vision"],agentType:"investigation-summary",quickActionField:"investigation-summary",colorTheme:"blue"},{id:"patient-education",label:"Patient Education",alias:"Pt Ed",description:"Generate lifestyle advice and education materials",icon:sA,group:"documentation",modes:["click"],colorTheme:"blue"},{id:"pre-op-plan",label:"Pre-Op Plan",alias:"Pre-Op",description:"Generate A5 pre-procedure summary card for cath lab",icon:Qu,group:"documentation",shortcut:"P",modes:["dictate","type"],agentType:"pre-op-plan",colorTheme:"blue"},{id:"ai-medical-review",label:"AI Medical Review",alias:"AI Review",description:"Australian clinical oversight and guidelines review",icon:By,group:"ai-tools",shortcut:"A",modes:["click"],colorTheme:"violet"},{id:"batch-ai-review",label:"Batch AI Review",alias:"Batch",description:"AI review for multiple patients from appointment book",icon:ji,group:"ai-tools",modes:["click"],colorTheme:"violet"},{id:"bp-diary-importer",label:"BP Diary",description:"Import and analyze blood pressure diary images",icon:qi,group:"analysis",modes:["click"],colorTheme:"purple"},{id:"lipid-profile-importer",label:"Lipid Profile",alias:"Lipids",description:"Import lipid profiles and generate insights",icon:d2,group:"analysis",modes:["click"],colorTheme:"purple"},{id:"tte-trend-importer",label:"Echo (TTE) Trends",alias:"TTE",description:"Import echo reports, trend LVEF/RVSP/LVEDD",icon:Rg,group:"analysis",modes:["click"],colorTheme:"purple"},{id:"annotate-screenshots",label:"Canvas",description:"Capture, annotate, and combine multiple screenshots",icon:u2,group:"utilities",modes:["click"],colorTheme:"cyan"},{id:"profile-photo",label:"Photo",description:"Capture screenshot for patient profile",icon:Ou,group:"utilities",modes:["click"],colorTheme:"cyan"},{id:"create-task",label:"Create Task",alias:"Task",description:"Add new task to workflow",icon:ll,group:"utilities",modes:["click"],colorTheme:"emerald"},{id:"ward-list",label:"Ward List",description:"Open ward list and tasks board",icon:lu,group:"utilities",shortcut:"R",modes:["click"],colorTheme:"emerald"},{id:"xestro-dark-mode",label:"Dark Mode",alias:"Night Mode",description:"Toggle dark mode for Xestro EMR",icon:Sy,group:"utilities",modes:["click"],colorTheme:"violet"},{id:"structural-workups",label:"Structural Workups",alias:"TAVI/PFO",description:"TAVI, PFO, mTEER workup management with Notion sync",icon:Zn,group:"utilities",shortcut:"S",modes:["click"],colorTheme:"purple"}],Jn={id:"appointment-wrap-up",label:"Wrap Up",alias:"Wrap Up",description:"Complete appointment workflow",icon:Da,group:"utilities",shortcut:"W",modes:["click"],colorTheme:"emerald"};function ip(s){return s==="appointment-wrap-up"?Jn:nm.find(e=>e.id===s)}function U4(s){const e=s.toUpperCase();return Jn.shortcut===e?Jn:nm.find(r=>r.shortcut===e)}function Iu(){return[...nm,Jn]}function Cv(s){return s.modes.includes("dictate")&&s.modes.includes("type")&&!s.modes.includes("vision")}function Nv(s){return s.modes.includes("dictate")&&s.modes.includes("type")&&s.modes.includes("vision")}function L4(s){if(!s.trim())return Iu();const e=im(s),r=e.split(" ").filter(Boolean);return Iu().map((i,o)=>({action:i,index:o,score:R4(i,e,r)})).filter(({score:i})=>i>0).sort((i,o)=>o.score-i.score||i.index-o.index).map(i=>i.action)}function im(s){return s.toLowerCase().replace(/[^a-z0-9]+/g," ").trim()}function D4(s){return im(s).replace(/\s+/g,"")}function Bv(s,e){if(!s)return!0;let r=0;for(let a=0;a<e.length;a+=1)if(e[a]===s[r]&&(r+=1,r>=s.length))return!0;return!1}function Nd(s,e){if(!s)return 0;const r=im(s),a=D4(s),n=e.replace(/\s+/g,"");return e.length<=1?r===e?140:r.startsWith(e)?120:r.split(" ").filter(Boolean).some(l=>l.startsWith(e))?110:0:r===e?140:r.startsWith(e)?120+Math.min(20,e.length):r.split(" ").filter(Boolean).some(o=>o.startsWith(e))?110+Math.min(10,e.length):r.includes(e)?90+Math.min(10,e.length):Bv(n,a)?70+Math.min(15,n.length):0}function R4(s,e,r){const a=[s.label,s.alias,s.description,s.shortcut].filter(Boolean).join(" "),n=im(a),i=n.replace(/\s+/g,"");if(r.length>1&&!r.every(h=>n.includes(h)?!0:Bv(h.replace(/\s+/g,""),i)))return 0;const o=Nd(s.label,e),l=Nd(s.alias,e),c=Nd(s.description,e),A=s.shortcut&&e.replace(/\s+/g,"").toUpperCase()===s.shortcut?60:Nd(s.shortcut,e);return Math.max(o,Math.round(l*.95),Math.round(c*.65),Math.round(A*.5))}class Go{static instance=null;handlers=new Map;listeners=new Set;currentError=null;currentClarification=null;isExecuting=!1;constructor(){}static getInstance(){return Go.instance||(Go.instance=new Go),Go.instance}static resetInstance(){Go.instance=null}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}emit(e){this.listeners.forEach(r=>{try{r(e)}catch(a){console.error("[ActionExecutor] Listener error:",a)}})}registerHandler(e,r){this.handlers.set(e,r)}registerHandlers(e){Object.entries(e).forEach(([r,a])=>{this.registerHandler(r,a)})}hasHandler(e){return this.handlers.has(e)}isActionAvailable(e,r){const a=ip(e);return!a||a.comingSoon||r&&!a.modes.includes(r)?!1:this.handlers.has(e)?!0:!!a.agentType}getAvailableActions(){return Iu().filter(e=>!e.comingSoon&&(this.handlers.has(e.id)||e.agentType))}getCurrentError(){return this.currentError}setError(e,r){this.currentError={message:e,suggestion:r},this.emit({type:"error:set",error:e,suggestion:r})}clearError(){this.currentError&&(this.currentError=null,this.emit({type:"error:clear"}))}errorFromBackground(e,r){this.setError(e,r?.suggestion),r?.autoClearMs&&r.autoClearMs>0&&setTimeout(()=>this.clearError(),r.autoClearMs)}getCurrentClarification(){return this.currentClarification}requestClarification(e){this.clearError(),this.currentClarification=e,this.emit({type:"clarification:request",actionId:e.actionId,clarification:e})}clearClarification(){if(this.currentClarification){const e=this.currentClarification.onCancel;this.currentClarification=null,this.emit({type:"clarification:clear"}),e?.()}}async submitClarification(e){if(!this.currentClarification)return{success:!1,error:"No clarification pending",suggestion:"Try starting the action again"};const{onSubmit:r}=this.currentClarification;this.currentClarification=null,this.emit({type:"clarification:clear"});try{const a=await r(e);return a.success||this.setError(a.error||"Action failed",a.suggestion),a}catch(a){const n=a instanceof Error?a.message:"Unknown error";return this.setError(n,"Please try again"),{success:!1,error:n,suggestion:"Please try again"}}}async execute(e,r,a={}){if(console.log("üî∑ [ActionExecutor] execute() called:",{actionId:e,mode:r,context:a}),this.clearError(),this.currentClarification&&(this.currentClarification=null,this.emit({type:"clarification:clear"})),this.isExecuting)return console.warn("‚ö†Ô∏è [ActionExecutor] Blocked - already executing"),{success:!1,error:"Action already in progress",suggestion:"Please wait for the current action to complete"};const n=ip(e);if(!n){const l={success:!1,error:`Unknown action: ${e}`,suggestion:"Try searching in the command bar"};return this.setError(l.error,l.suggestion),l}if(n.comingSoon){const l={success:!1,error:`${n.label} is coming soon`,suggestion:"This feature is not yet available"};return this.setError(l.error,l.suggestion),l}if(r&&!n.modes.includes(r)){const l={success:!1,error:`${n.label} does not support ${r} mode`,suggestion:`Available modes: ${n.modes.join(", ")}`};return this.setError(l.error,l.suggestion),l}const i={sessionId:null,origin:"command-bar",...a,quickActionField:a.quickActionField||n.quickActionField},o=this.handlers.get(e);if(!o){const l=this.handlers.get("__default_workflow__");if(l&&n.agentType)return this.executeWithHandler(n,l,r,i);const c={success:!1,error:`No handler registered for: ${n.label}`,suggestion:"This action is not yet implemented"};return this.setError(c.error,c.suggestion),c}return this.executeWithHandler(n,o,r,i)}async executeWithHandler(e,r,a,n){this.isExecuting=!0,this.emit({type:"action:start",actionId:e.id,mode:a});try{console.log(`[ActionExecutor] Executing: ${e.id} (${a||"default"})`,n);const i=await r(e,a,n);return i.success?this.emit({type:"action:complete",actionId:e.id,mode:a,result:i}):(this.setError(i.error||"Action failed",i.suggestion),this.emit({type:"action:error",actionId:e.id,error:i.error})),i}catch(i){const l={success:!1,error:i instanceof Error?i.message:"Unknown error occurred",suggestion:"Please try again or check the console for details"};return this.setError(l.error,l.suggestion),this.emit({type:"action:error",actionId:e.id,error:l.error}),console.error(`[ActionExecutor] Error executing ${e.id}:`,i),l}finally{this.isExecuting=!1}}async executeByShortcut(e,r,a={}){const n=e.toUpperCase(),o=Iu().find(l=>l.shortcut===n);return o?this.execute(o.id,r,{...a,origin:"keyboard"}):null}}const ca=()=>Go.getInstance();function Sv(){const s=m.useRef(ca()),[e,r]=m.useState(null),[a,n]=m.useState(null),[i,o]=m.useState(!1);m.useEffect(()=>{const v=s.current,j=T=>{switch(T.type){case"action:start":o(!0);break;case"action:complete":case"action:error":o(!1);break;case"error:set":r({message:T.error||"An error occurred",suggestion:T.suggestion});break;case"error:clear":r(null);break;case"clarification:request":n(T.clarification||null);break;case"clarification:clear":n(null);break}},I=v.subscribe(j),C=v.getCurrentError();C&&r(C);const E=v.getCurrentClarification();return E&&n(E),I},[]);const l=m.useCallback(async(v,j,I)=>s.current.execute(v,j,I),[]),c=m.useCallback(async(v,j,I)=>s.current.executeByShortcut(v,j,I),[]),A=m.useCallback(()=>{s.current.clearError()},[]),d=m.useCallback((v,j)=>{s.current.setError(v,j)},[]),h=m.useCallback(v=>{s.current.registerHandlers(v)},[]),f=m.useCallback((v,j)=>{s.current.registerHandler(v,j)},[]),u=m.useCallback((v,j)=>s.current.isActionAvailable(v,j),[]),x=m.useCallback(()=>s.current.getAvailableActions(),[]),b=m.useCallback(async v=>s.current.submitClarification(v),[]),N=m.useCallback(()=>{s.current.clearClarification()},[]);return m.useMemo(()=>({execute:l,executeByShortcut:c,error:e,clearError:A,setError:d,isExecuting:i,clarification:a,submitClarification:b,cancelClarification:N,registerHandlers:h,registerHandler:f,isActionAvailable:u,getAvailableActions:x,executor:s.current}),[l,c,e,A,d,i,a,b,N,h,f,u,x])}const jv=m.memo(({field:s,value:e,onChange:r,onKeyDown:a,autoFocus:n,inputRef:i})=>{const o=`
    w-full px-2.5 py-1.5
    text-[12px] text-neutral-900 placeholder-neutral-400
    bg-white border border-neutral-200 rounded-md
    outline-none
    transition-colors
    focus:border-violet-500 focus:ring-1 focus:ring-violet-500/20
  `;return s.type==="select"&&s.options?t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("label",{className:"block text-[11px] font-medium text-neutral-600 mb-1",children:[s.label,s.required&&t.jsx("span",{className:"text-rose-500 ml-0.5",children:"*"})]}),t.jsxs("select",{ref:i,value:e,onChange:l=>r(l.target.value),onKeyDown:a,autoFocus:n,className:o,"aria-label":s.label,children:[t.jsx("option",{value:"",children:s.placeholder||"Select..."}),s.options.map(l=>t.jsx("option",{value:l.value,children:l.label},l.value))]}),s.helperText&&t.jsx("p",{className:"text-[10px] text-neutral-500 mt-0.5",children:s.helperText})]}):t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("label",{className:"block text-[11px] font-medium text-neutral-600 mb-1",children:[s.label,s.required&&t.jsx("span",{className:"text-rose-500 ml-0.5",children:"*"})]}),t.jsx("input",{ref:i,type:s.type==="number"?"number":"text",value:e,onChange:l=>r(l.target.value),onKeyDown:a,placeholder:s.placeholder,autoFocus:n,className:o,"aria-label":s.label}),s.helperText&&t.jsx("p",{className:"text-[10px] text-neutral-500 mt-0.5",children:s.helperText})]})});jv.displayName="ClarificationFieldInput";const Ev=m.memo(({request:s,onSubmit:e,onCancel:r})=>{const[a,n]=m.useState(()=>{const E={};return s.fields.forEach(T=>{E[T.id]=T.defaultValue||""}),E}),[i,o]=m.useState(0),[l,c]=m.useState(!1),[A,d]=m.useState(null),h=m.useRef(null),f=s.fields.length>3,u=3,x=f?Math.ceil(s.fields.length/u):1,b=f?s.fields.slice(i*u,(i+1)*u):s.fields;m.useEffect(()=>{const E=setTimeout(()=>{h.current?.focus()},50);return()=>clearTimeout(E)},[i]);const N=m.useCallback((E,T)=>{n(Q=>({...Q,[E]:T})),d(null)},[]),v=m.useCallback(()=>{const E=f?b:s.fields;for(const T of E)if(T.required&&!a[T.id]?.trim())return d(`${T.label} is required`),!1;return!0},[b,s.fields,f,a]),j=m.useCallback(async()=>{if(v()){if(f&&i<x-1){o(E=>E+1);return}for(const E of s.fields)if(E.required&&!a[E.id]?.trim()){d(`${E.label} is required`);return}c(!0);try{await e(a)}finally{c(!1)}}},[v,f,i,x,s.fields,a,e]),I=m.useCallback(E=>{E.key==="Enter"&&!E.shiftKey?(E.preventDefault(),j()):E.key==="Escape"&&(E.preventDefault(),r())},[j,r]),C=m.useCallback(()=>{i>0&&(o(E=>E-1),d(null))},[i]);return t.jsxs(Ye.div,{initial:{opacity:0,y:-4,height:0},animate:{opacity:1,y:0,height:"auto"},exit:{opacity:0,y:-4,height:0},transition:{duration:$t.duration.fast/1e3},className:"mt-1.5 bg-violet-50 border border-violet-200 rounded-lg overflow-hidden",role:"form","aria-label":"Clarification required",children:[t.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b border-violet-100",children:[t.jsx(m2,{size:14,className:"text-violet-600 flex-shrink-0"}),t.jsx("p",{className:"text-[12px] font-medium text-violet-800 flex-1",children:s.message}),t.jsx("button",{type:"button",onClick:r,className:"p-1 rounded hover:bg-violet-100 transition-colors","aria-label":"Cancel",children:t.jsx(es,{size:14,className:"text-violet-600"})})]}),t.jsxs("div",{className:"px-3 py-2 space-y-2",children:[f&&t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("span",{className:"text-[10px] font-medium text-violet-600",children:["Step ",i+1," of ",x]}),t.jsx("div",{className:"flex gap-1",children:Array.from({length:x}).map((E,T)=>t.jsx("div",{className:`
                    w-1.5 h-1.5 rounded-full transition-colors
                    ${T===i?"bg-violet-600":T<i?"bg-violet-400":"bg-violet-200"}
                  `},T))})]}),t.jsx("div",{className:`flex gap-2 ${b.length===1?"":"flex-wrap"}`,children:b.map((E,T)=>t.jsx(jv,{field:E,value:a[E.id]||"",onChange:Q=>N(E.id,Q),onKeyDown:I,autoFocus:T===0,inputRef:T===0?h:void 0},E.id))}),A&&t.jsx("p",{className:"text-[11px] text-rose-600 mt-1",children:A})]}),t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 bg-violet-100/50 border-t border-violet-100",children:[t.jsxs("div",{className:"text-[10px] text-violet-600",children:[t.jsx("span",{className:"font-medium",children:"Tab"})," between fields ‚Ä¢ ",t.jsx("span",{className:"font-medium",children:"Enter"})," submit ‚Ä¢ ",t.jsx("span",{className:"font-medium",children:"Esc"})," cancel"]}),t.jsxs("div",{className:"flex items-center gap-1.5",children:[f&&i>0&&t.jsxs("button",{type:"button",onClick:C,className:`
                flex items-center gap-1 px-2 py-1
                text-[11px] font-medium
                text-violet-700 bg-violet-100 hover:bg-violet-200
                rounded transition-colors
              `,children:[t.jsx(Np,{size:12}),"Back"]}),t.jsx("button",{type:"button",onClick:j,disabled:l,className:`
              flex items-center gap-1 px-2.5 py-1
              text-[11px] font-semibold
              text-white bg-violet-600 hover:bg-violet-700
              rounded transition-colors
              disabled:opacity-50 disabled:cursor-not-allowed
            `,children:l?t.jsx(t.Fragment,{children:t.jsx("span",{className:"animate-pulse",children:"Submitting..."})}):f&&i<x-1?t.jsxs(t.Fragment,{children:["Next",t.jsx(ti,{size:12})]}):"Submit"})]})]})]})});Ev.displayName="ClarificationForm";const M4=["dictate","type","vision"];function n0(s){return s?M4.filter(e=>s.modes.includes(e)):[]}const _4={idle:{boxShadow:nl.sm,borderColor:xn.neutral[200]},focused:{boxShadow:nl.focusRing,borderColor:xn.primary.DEFAULT}},Q4={hidden:{opacity:0,width:0},visible:{opacity:1,width:"auto"}},i0={type:"spring",stiffness:520,damping:32,mass:1,bounce:.22},O4={type:"spring",stiffness:800,damping:50,mass:.7,bounce:.08},H4=.01,V4=12,$4={hidden:{opacity:0,y:6},visible:s=>({opacity:1,y:0,transition:{duration:$t.duration.fast/1e3,ease:$t.easing.out,delay:Math.min(s,V4)*H4}})},kv=m.memo(({action:s,isFocused:e,isKeyboardNavigating:r,selectedMode:a,onSelect:n,onMouseEnter:i})=>{const[o,l]=m.useState(!1),[c,A]=m.useState(null),h=s.modes.length>1&&(o||e&&r);return t.jsxs("div",{className:`
        relative flex items-center gap-3 px-3 py-2
        cursor-pointer
        transition-colors
        ${e?"":"hover:bg-neutral-50"}
      `,onMouseEnter:()=>{l(!0),i()},onMouseLeave:()=>{l(!1),A(null)},onClick:()=>n(s),onKeyDown:f=>{(f.key==="Enter"||f.key===" ")&&(f.preventDefault(),n(s))},tabIndex:0,children:[e&&t.jsx(Ye.div,{layoutId:"commandbar-active-row",transition:O4,className:"absolute inset-0 rounded-md pointer-events-none",style:{backgroundImage:r?"linear-gradient(180deg, rgba(139, 92, 246, 0.18), rgba(139, 92, 246, 0.12))":"linear-gradient(180deg, rgba(139, 92, 246, 0.14), rgba(139, 92, 246, 0.09))",boxShadow:r?"inset 0 0 0 1px rgba(139, 92, 246, 0.26), 0 1px 2px rgba(17, 24, 39, 0.06)":"inset 0 0 0 1px rgba(139, 92, 246, 0.2), 0 1px 2px rgba(17, 24, 39, 0.04)"}}),t.jsx(s.icon,{size:16,className:`${e?"text-violet-600":"text-neutral-500"} relative z-10`,strokeWidth:1.5}),t.jsxs("div",{className:"flex-1 min-w-0 relative z-10",children:[t.jsx("div",{className:`
          text-[13px] font-medium truncate
          ${e?"text-violet-900":"text-neutral-700"}
        `,children:s.label}),t.jsx("div",{className:"text-[11px] text-neutral-500 truncate",children:s.description})]}),t.jsxs("div",{className:"flex items-center gap-1.5 relative z-10",children:[t.jsx(as,{children:h&&t.jsxs(Ye.div,{initial:"hidden",animate:"visible",exit:"hidden",variants:Q4,transition:{duration:$t.duration.fast/1e3},className:"flex overflow-hidden rounded-md border border-neutral-200",children:[s.modes.includes("dictate")&&(()=>{const f=a==="dictate"||c==="dictate";return t.jsxs("button",{type:"button",onClick:u=>{u.stopPropagation(),n(s,"dictate")},onMouseEnter:()=>A("dictate"),onMouseLeave:()=>A(null),className:`
                    relative flex items-center gap-1 py-1
                    text-[10px] font-semibold
                    text-blue-600 bg-blue-50
                    hover:bg-blue-100
                    transition-all
                    border-r border-neutral-200
                    last:border-r-0
                    first:rounded-l-md last:rounded-r-md
                    ${f?"px-2.5":"px-2"}
                  `,title:"Dictate","aria-pressed":a==="dictate",children:[t.jsx($r,{size:14,strokeWidth:2}),t.jsx("span",{className:"whitespace-nowrap",children:a==="dictate"||c==="dictate"?"Dictate":"D"}),a==="dictate"&&t.jsx("span",{"aria-hidden":"true",className:"absolute inset-0 pointer-events-none",style:{borderRadius:"inherit",boxShadow:"inset 0 0 0 1px rgba(37, 99, 235, 0.55)"}})]})})(),s.modes.includes("type")&&(()=>{const f=a==="type"||c==="type";return t.jsxs("button",{type:"button",onClick:u=>{u.stopPropagation(),n(s,"type")},onMouseEnter:()=>A("type"),onMouseLeave:()=>A(null),className:`
                    relative flex items-center gap-1 py-1
                    text-[10px] font-semibold
                    text-purple-600 bg-purple-50
                    hover:bg-purple-100
                    transition-all
                    border-r border-neutral-200
                    last:border-r-0
                    first:rounded-l-md last:rounded-r-md
                    ${f?"px-2.5":"px-2"}
                  `,title:"Type","aria-pressed":a==="type",children:[t.jsx(NA,{size:14,strokeWidth:2}),t.jsx("span",{className:"whitespace-nowrap",children:a==="type"||c==="type"?"Type":"T"}),a==="type"&&t.jsx("span",{"aria-hidden":"true",className:"absolute inset-0 pointer-events-none",style:{borderRadius:"inherit",boxShadow:"inset 0 0 0 1px rgba(147, 51, 234, 0.55)"}})]})})(),s.modes.includes("vision")&&(()=>{const f=a==="vision"||c==="vision";return t.jsxs("button",{type:"button",onClick:u=>{u.stopPropagation(),n(s,"vision")},onMouseEnter:()=>A("vision"),onMouseLeave:()=>A(null),className:`
                    relative flex items-center gap-1 py-1
                    text-[10px] font-semibold
                    text-cyan-600 bg-cyan-50
                    hover:bg-cyan-100
                    transition-all
                    first:rounded-l-md last:rounded-r-md
                    ${f?"px-2.5":"px-2"}
                  `,title:"Vision (scan image)","aria-pressed":a==="vision",children:[t.jsx(Ou,{size:14,strokeWidth:2}),t.jsx("span",{className:"whitespace-nowrap",children:a==="vision"||c==="vision"?"Vision":"V"}),a==="vision"&&t.jsx("span",{"aria-hidden":"true",className:"absolute inset-0 pointer-events-none",style:{borderRadius:"inherit",boxShadow:"inset 0 0 0 1px rgba(8, 145, 178, 0.55)"}})]})})()]})}),s.comingSoon&&t.jsx("span",{className:`
            px-1.5 py-0.5
            text-[9px] font-semibold uppercase
            bg-amber-100 text-amber-700
            rounded-full
          `,children:"Soon"})]})]})});kv.displayName="ActionRow";const Iv=m.memo(({isOpen:s,onOpen:e,onClose:r,activateOnHover:a=!1,onQueryChange:n,onActionSelect:i,useExecutor:o=!0,placeholder:l="Search actions...",className:c=""})=>{const[A,d]=m.useState(""),[h,f]=m.useState(-1),[u,x]=m.useState(null),[b,N]=m.useState(!1),[v,j]=m.useState(!1),I=m.useRef(null),C=m.useRef(null),E=m.useRef(!1),T=m.useRef(null),{execute:Q,error:D,isExecuting:k,clarification:R,submitClarification:w,cancelClarification:L}=Sv(),M=m.useCallback(async(te,G)=>{o?await Q(te.id,G,{origin:"command-bar"}):i(te,G)},[o,Q,i]),P=m.useMemo(()=>L4(A),[A]),K=m.useMemo(()=>{const te=new Map;return P.forEach(G=>{const X=te.get(G.group)||[];X.push(G),te.set(G.group,X)}),wv.map(G=>({...G,actions:te.get(G.id)||[]})).filter(G=>G.actions.length>0)},[P]),$=m.useMemo(()=>K.flatMap(te=>te.actions),[K]),O=m.useMemo(()=>h<0?null:$[h]||null,[h,$]),W=m.useMemo(()=>n0(O),[O]);m.useEffect(()=>{if(!O){x(null);return}const te=n0(O);if(te.length===0){x(null);return}x(te.includes("dictate")?"dictate":te[0])},[O?.id]);const ee=m.useCallback(()=>{d(""),n?.(""),f(-1),x(null),N(!1),j(!1),r(),I.current?.blur()},[r,n]),V=m.useCallback(()=>{T.current!==null&&(window.clearTimeout(T.current),T.current=null)},[]),q=m.useCallback(()=>{a&&v&&(V(),T.current=window.setTimeout(()=>{ee()},90))},[a,V,ee,v]);m.useEffect(()=>()=>V(),[V]),m.useEffect(()=>{if(!s){E.current=!1;return}E.current=!0},[s]),m.useEffect(()=>{const te=G=>{if(G.metaKey&&G.key==="k"||G.key==="/"&&!s){G.preventDefault(),s||(j(!1),e(),I.current?.focus());return}if(G.key==="Escape"&&s){G.preventDefault(),ee();return}};return document.addEventListener("keydown",te),()=>document.removeEventListener("keydown",te)},[s,e,ee]);const S=m.useCallback(te=>{switch(te.key){case"ArrowDown":te.preventDefault(),N(!0),f(G=>G<$.length-1?G+1:0);break;case"ArrowUp":te.preventDefault(),N(!0),f(G=>G>0?G-1:$.length-1);break;case"ArrowLeft":case"ArrowRight":{if(!b||!O||W.length<=1)return;te.preventDefault();const G=te.key==="ArrowRight"?1:-1;x(X=>{const le=X??(W.includes("dictate")?"dictate":W[0]),he=W.indexOf(le),ke=((he>=0?he:0)+G+W.length)%W.length;return W[ke]});break}case"Enter":if(te.preventDefault(),h>=0&&$[h]){const G=$[h];M(G,u??void 0),ee()}break;case"Escape":te.preventDefault(),ee();break}},[h,$,M,O,W,u,ee,b]),H=m.useCallback(()=>{s||e()},[s,e]),Y=m.useCallback(()=>{a&&(V(),document.activeElement!==I.current&&(s||j(!0),I.current?.focus()))},[a,V,s]);return m.useEffect(()=>{const te=G=>{s&&C.current&&!C.current.contains(G.target)&&ee()};return document.addEventListener("mousedown",te),()=>document.removeEventListener("mousedown",te)},[s,ee]),m.useEffect(()=>{if(s){if(!A.trim()){f(-1),N(!1);return}f($.length>0?0:-1)}},[A,s,$.length]),t.jsxs("div",{ref:C,className:`relative ${c}`,style:{zIndex:vv.dropdown},children:[t.jsxs(Ye.div,{className:"relative",variants:_4,animate:s?"focused":"idle",transition:{duration:$t.duration.fast/1e3},onMouseEnter:Y,onMouseLeave:q,children:[t.jsx("div",{className:"absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none",children:t.jsx(cl,{size:16,className:"text-neutral-400"})}),t.jsx("input",{ref:I,type:"text",value:A,onMouseDown:()=>j(!1),onChange:te=>{const G=te.target.value;d(G),n?.(G),N(!1),j(!1)},onFocus:H,onKeyDown:S,placeholder:l,className:`
            w-full pl-9 pr-12 py-2.5
            text-[13px] text-neutral-900 placeholder-neutral-400
            bg-white border rounded-lg
            outline-none
            transition-all
          `,style:{borderRadius:ir.md,borderColor:s?xn.primary.DEFAULT:xn.neutral[200],boxShadow:s?nl.focusRing:nl.sm,transitionDuration:`${$t.duration.fast}ms`},"aria-label":"Search actions","aria-expanded":s,"aria-controls":"command-bar-dropdown",role:"combobox"}),t.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none",children:k?t.jsx("span",{className:"flex items-center gap-1 px-1.5 py-0.5 text-[10px] font-medium bg-violet-100 text-violet-600 rounded animate-pulse",children:"Running..."}):t.jsxs("span",{className:"flex items-center gap-1 px-1.5 py-0.5 text-[10px] font-medium bg-neutral-100 text-neutral-500 rounded",children:[t.jsx(h2,{size:10}),"K"]})})]}),t.jsx(as,{children:D&&t.jsx(Ye.div,{initial:{opacity:0,y:-4,height:0},animate:{opacity:1,y:0,height:"auto"},exit:{opacity:0,y:-4,height:0},transition:{duration:$t.duration.fast/1e3},className:"mt-1.5 px-3 py-2 bg-rose-50 border border-rose-200 rounded-lg",role:"alert","aria-live":"polite",children:t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx(or,{size:14,className:"text-rose-500 mt-0.5 flex-shrink-0"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"text-[12px] font-medium text-rose-800",children:D.message}),D.suggestion&&t.jsx("p",{className:"text-[11px] text-rose-600 mt-0.5",children:D.suggestion})]})]})})}),t.jsx(as,{children:R&&t.jsx(Ev,{request:R,onSubmit:w,onCancel:L})}),t.jsx(as,{children:s&&t.jsxs(Ye.div,{id:"command-bar-dropdown",role:"listbox",initial:{opacity:0,y:-12,scale:.985},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:-6,scale:.99},transition:{y:i0,scale:i0,opacity:{duration:$t.duration.normal/1e3,ease:$t.easing.out}},onMouseEnter:V,onMouseLeave:q,className:`
              absolute top-full left-0 right-0 mt-1
              border border-neutral-200
              rounded-lg overflow-hidden
            `,style:{borderRadius:ir.lg,backgroundColor:"rgba(255, 255, 255, 0.82)",boxShadow:nl.dropdown,maxHeight:"calc(100vh - 200px)",overflowY:"auto",backdropFilter:"blur(12px) saturate(1.15)",WebkitBackdropFilter:"blur(12px) saturate(1.15)",willChange:"transform, opacity"},children:[K.length===0?t.jsxs("div",{className:"relative px-4 py-8 text-center text-neutral-500 text-sm",children:['No actions found for "',A,'"']}):t.jsx(p2,{id:"commandbar-results",children:t.jsx("div",{className:"relative",children:K.map((te,G)=>t.jsxs("div",{className:G>0?"border-t border-neutral-100":"",children:[t.jsx("div",{className:"px-3 py-2 bg-neutral-50/70",children:t.jsx("span",{className:"text-[11px] font-semibold uppercase tracking-wider text-neutral-500",children:te.label})}),t.jsx("div",{className:"py-1",role:"group",children:te.actions.map(X=>{const le=$.indexOf(X),he=le===h,ve=s&&!E.current,ke=le>=0?le:0;return t.jsx(Ye.div,{custom:ke,variants:$4,initial:ve?"hidden":!1,animate:"visible",children:t.jsx(kv,{action:X,isFocused:he,isKeyboardNavigating:b,selectedMode:he?u:null,onSelect:(Le,Be)=>{M(Le,Be),ee()},onMouseEnter:()=>{le>=0&&f(le)}})},X.id)})})]},te.id))})}),t.jsx("div",{className:"px-3 py-2 bg-neutral-50 border-t border-neutral-100",children:t.jsxs("div",{className:"flex items-center justify-between text-[10px] text-neutral-500",children:[t.jsx("span",{children:"‚Üë‚Üì Navigate ‚Ä¢ ‚Üê‚Üí Mode ‚Ä¢ Enter Select"}),t.jsx("span",{children:"Type to filter"})]})})]})})]})});Iv.displayName="CommandBar";const K4={initial:{scale:1},hover:{scale:1.02},tap:{scale:.98}},Tu=m.memo(({id:s,label:e,alias:r,icon:a,onClick:n,shortcut:i,isLoading:o=!1,disabled:l=!1,comingSoon:c=!1,colorTheme:A="blue",compact:d=!1,className:h=""})=>{const f=xn.themes[A],u=l||o||c,x=d&&r?r:e;return t.jsxs(Ye.button,{"data-action-id":s,onClick:n,disabled:u,className:`
        group relative flex items-center
        ${d?"flex-col justify-center gap-1 p-1.5 w-full":"gap-2 px-3 py-2"}
        rounded-[${ir.md}] border
        transition-colors duration-[${$t.duration.fast}ms]
        ${u?"bg-neutral-50 border-neutral-200 text-neutral-400 cursor-not-allowed":`bg-white border-neutral-200 hover:bg-[${f.bg}] hover:border-[${f.border}] cursor-pointer`}
        ${h}
      `,style:{borderRadius:ir.md,transitionDuration:`${$t.duration.fast}ms`,...d?{height:gA.header.favourites}:{}},variants:!u&&!d?K4:void 0,whileHover:!u&&!d?"hover":void 0,whileTap:!u&&!d?"tap":void 0,"aria-label":e,"aria-disabled":u,title:c?`${e} - Coming soon`:e,children:[t.jsx("div",{className:`
        flex items-center justify-center
        ${d?"w-5 h-5":"w-4 h-4"}
        transition-transform duration-[${$t.duration.fast}ms]
        ${u?"":"group-hover:scale-110"}
      `,children:o?t.jsx(Za,{className:"animate-spin",style:{color:f.icon},size:d?18:16}):t.jsx(a,{size:d?18:16,style:{color:u?xn.neutral[400]:f.icon},strokeWidth:1.5})}),t.jsx("span",{className:`
        ${d?"text-[10px] text-center leading-tight whitespace-nowrap":"text-[13px]"}
        font-medium
        ${u?"text-neutral-400":"text-neutral-700"}
        ${d?"":"truncate"}
      `,children:x}),i&&!d&&!u&&t.jsx("span",{className:`
          ml-auto px-1.5 py-0.5
          text-[10px] font-medium
          bg-neutral-100 text-neutral-500
          rounded
          opacity-0 group-hover:opacity-100
          transition-opacity duration-[\${animation.duration.fast}ms]
        `,children:i}),c&&t.jsx("span",{className:`
          absolute ${d?"-top-1 -right-1":"top-1 right-1"}
          px-1.5 py-0.5
          text-[9px] font-semibold uppercase
          bg-amber-100 text-amber-700
          rounded-full
        `,children:"Soon"}),t.jsx("div",{className:`
        absolute inset-0 rounded-[inherit]
        ring-2 ring-transparent
        group-focus-visible:ring-violet-500/40
        pointer-events-none
      `})]})});Tu.displayName="ActionButton";const G4={initial:{scale:1},hover:{scale:1.02}},z4={hidden:{opacity:0,scale:.95},visible:{opacity:1,scale:1}},Mp=m.memo(({id:s,label:e,alias:r,icon:a,onDictate:n,onType:i,shortcut:o,isLoading:l=!1,disabled:c=!1,colorTheme:A="blue",compact:d=!1,className:h=""})=>{const[f,u]=m.useState(!1),x=xn.themes[A],b=c||l,N=d&&r?r:e,v=()=>{b||u(!0)},j=()=>{u(!1)},I=E=>{E.stopPropagation(),b||(n(),u(!1))},C=E=>{E.stopPropagation(),b||(i(),u(!1))};return t.jsxs(Ye.div,{"data-action-id":s,className:`
        relative overflow-hidden
        ${d?"":"min-h-[40px]"}
        ${h}
      `,onMouseEnter:v,onMouseLeave:j,variants:!b&&!d?G4:void 0,whileHover:!b&&!d?"hover":void 0,style:d?{height:gA.header.favourites,minHeight:gA.header.favourites}:void 0,children:[t.jsxs(Ye.button,{className:`
          absolute inset-0
          flex
          ${d?"flex-col items-center justify-center gap-1 p-1.5":"items-center gap-2 px-3 py-2"}
          rounded-lg border
          transition-colors
          ${b?"bg-neutral-50 border-neutral-200 text-neutral-400 cursor-not-allowed":"bg-white border-neutral-200 hover:border-neutral-300 cursor-pointer"}
        `,style:{borderRadius:ir.md,transitionDuration:`${$t.duration.fast}ms`,opacity:f&&!b?0:1,pointerEvents:f&&!b?"none":"auto"},disabled:b,"aria-label":e,"aria-disabled":b,title:e,children:[t.jsx("div",{className:`
          flex items-center justify-center
          ${d?"w-5 h-5":"w-4 h-4"}
        `,children:l?t.jsx(Za,{className:"animate-spin",style:{color:x.icon},size:d?18:16}):t.jsx(a,{size:d?18:16,style:{color:b?xn.neutral[400]:x.icon},strokeWidth:1.5})}),t.jsx("span",{className:`
          ${d?"text-[10px] text-center leading-tight whitespace-nowrap":"text-[13px]"}
          font-medium
          ${b?"text-neutral-400":"text-neutral-700"}
          ${d?"":"truncate"}
        `,children:N}),o&&!d&&!b&&t.jsx("span",{className:`
            ml-auto px-1.5 py-0.5
            text-[10px] font-medium
            bg-neutral-100 text-neutral-500
            rounded
          `,children:o})]}),t.jsxs(Ye.div,{className:"absolute inset-0 grid grid-cols-2 gap-0.5",initial:"hidden",animate:f&&!b?"visible":"hidden",variants:z4,transition:{duration:$t.duration.fast/1e3},style:{pointerEvents:f&&!b?"auto":"none"},children:[t.jsxs("button",{onClick:I,disabled:b,className:`
            flex flex-col items-center justify-center
            px-2
            rounded-l-lg border-2
            bg-white
            transition-colors
            hover:bg-blue-50 hover:border-blue-300
            border-blue-200
          `,style:{borderRadius:`${ir.md} 0 0 ${ir.md}`,transitionDuration:`${$t.duration.fast}ms`},title:`Dictate ${e}`,"aria-label":`Dictate ${e} with voice`,children:[t.jsx($r,{size:16,className:"text-blue-600 mb-0.5",strokeWidth:2}),t.jsx("span",{className:"text-[9px] font-semibold text-blue-700",children:"Dictate"})]}),t.jsxs("button",{onClick:C,disabled:b,className:`
            flex flex-col items-center justify-center
            px-2
            rounded-r-lg border-2
            bg-white
            transition-colors
            hover:bg-purple-50 hover:border-purple-300
            border-purple-200
          `,style:{borderRadius:`0 ${ir.md} ${ir.md} 0`,transitionDuration:`${$t.duration.fast}ms`},title:`Type ${e}`,"aria-label":`Type ${e} manually`,children:[t.jsx(NA,{size:16,className:"text-purple-600 mb-0.5",strokeWidth:2}),t.jsx("span",{className:"text-[9px] font-semibold text-purple-700",children:"Type"})]})]}),t.jsx("div",{className:`
        absolute inset-0 rounded-lg
        ring-2 ring-transparent
        pointer-events-none
        focus-within:ring-violet-500/40
      `})]})});Mp.displayName="DualModeButton";const W4={initial:{scale:1},hover:{scale:1.02}},q4={hidden:{opacity:0,scale:.95},visible:{opacity:1,scale:1}},_p=m.memo(({id:s,label:e,alias:r,icon:a,onDictate:n,onType:i,onVision:o,shortcut:l,isLoading:c=!1,disabled:A=!1,colorTheme:d="blue",compact:h=!1,className:f=""})=>{const[u,x]=m.useState(!1),b=xn.themes[d],N=A||c,v=h&&r?r:e,j=()=>{N||x(!0)},I=()=>{x(!1)},C=Q=>{Q.stopPropagation(),N||(n(),x(!1))},E=Q=>{Q.stopPropagation(),N||(i(),x(!1))},T=Q=>{Q.stopPropagation(),N||(o(),x(!1))};return t.jsxs(Ye.div,{"data-action-id":s,className:`
        relative overflow-hidden
        ${h?"":"min-h-[40px]"}
        ${f}
      `,onMouseEnter:j,onMouseLeave:I,variants:!N&&!h?W4:void 0,whileHover:!N&&!h?"hover":void 0,style:h?{height:gA.header.favourites,minHeight:gA.header.favourites}:void 0,children:[t.jsxs(Ye.button,{className:`
          absolute inset-0
          flex
          ${h?"flex-col items-center justify-center gap-1 p-1.5":"items-center gap-2 px-3 py-2"}
          rounded-lg border
          transition-colors
          ${N?"bg-neutral-50 border-neutral-200 text-neutral-400 cursor-not-allowed":"bg-white border-neutral-200 hover:border-neutral-300 cursor-pointer"}
        `,style:{borderRadius:ir.md,transitionDuration:`${$t.duration.fast}ms`,opacity:u&&!N?0:1,pointerEvents:u&&!N?"none":"auto"},disabled:N,"aria-label":e,"aria-disabled":N,title:e,children:[t.jsx("div",{className:`
          flex items-center justify-center
          ${h?"w-5 h-5":"w-4 h-4"}
        `,children:c?t.jsx(Za,{className:"animate-spin",style:{color:b.icon},size:h?18:16}):t.jsx(a,{size:h?18:16,style:{color:N?xn.neutral[400]:b.icon},strokeWidth:1.5})}),t.jsx("span",{className:`
          ${h?"text-[10px] text-center leading-tight whitespace-nowrap":"text-[13px]"}
          font-medium
          ${N?"text-neutral-400":"text-neutral-700"}
          ${h?"":"truncate"}
        `,children:v}),l&&!h&&!N&&t.jsx("span",{className:`
            ml-auto px-1.5 py-0.5
            text-[10px] font-medium
            bg-neutral-100 text-neutral-500
            rounded
          `,children:l})]}),t.jsxs(Ye.div,{className:"absolute inset-0 grid grid-cols-3 gap-0.5",initial:"hidden",animate:u&&!N?"visible":"hidden",variants:q4,transition:{duration:$t.duration.fast/1e3},style:{pointerEvents:u&&!N?"auto":"none"},children:[t.jsxs("button",{onClick:C,disabled:N,className:`
            flex flex-col items-center justify-center
            rounded-l-lg border-2
            bg-white
            transition-colors
            hover:bg-blue-50 hover:border-blue-300
            border-blue-200
          `,style:{borderRadius:`${ir.md} 0 0 ${ir.md}`,transitionDuration:`${$t.duration.fast}ms`},title:`Dictate ${e}`,"aria-label":`Dictate ${e} with voice`,children:[t.jsx($r,{size:h?16:14,className:"text-blue-600 mb-0.5",strokeWidth:2}),t.jsx("span",{className:"text-[10px] font-semibold text-blue-700",children:"D"})]}),t.jsxs("button",{onClick:E,disabled:N,className:`
            flex flex-col items-center justify-center
            border-2 border-l-0 border-r-0
            bg-white
            transition-colors
            hover:bg-purple-50 hover:border-purple-300
            border-purple-200
          `,style:{borderRadius:0,transitionDuration:`${$t.duration.fast}ms`},title:`Type ${e}`,"aria-label":`Type ${e} manually`,children:[t.jsx(NA,{size:h?16:14,className:"text-purple-600 mb-0.5",strokeWidth:2}),t.jsx("span",{className:"text-[10px] font-semibold text-purple-700",children:"T"})]}),t.jsxs("button",{onClick:T,disabled:N,className:`
            flex flex-col items-center justify-center
            rounded-r-lg border-2
            bg-white
            transition-colors
            hover:bg-cyan-50 hover:border-cyan-300
            border-cyan-200
          `,style:{borderRadius:`0 ${ir.md} ${ir.md} 0`,transitionDuration:`${$t.duration.fast}ms`},title:`Scan ${e} from image`,"aria-label":`Scan ${e} from photo or screenshot`,children:[t.jsx(Ou,{size:h?16:14,className:"text-cyan-600 mb-0.5",strokeWidth:2}),t.jsx("span",{className:"text-[10px] font-semibold text-cyan-700",children:"V"})]})]}),t.jsx("div",{className:`
        absolute inset-0 rounded-lg
        ring-2 ring-transparent
        pointer-events-none
        focus-within:ring-violet-500/40
      `})]})});_p.displayName="TriModeButton";const o0="operator-action-group-",J4={collapsed:{height:0,opacity:0,transition:{height:{duration:$t.duration.normal/1e3},opacity:{duration:$t.duration.fast/1e3}}},expanded:{height:"auto",opacity:1,transition:{height:{duration:$t.duration.normal/1e3},opacity:{duration:$t.duration.fast/1e3,delay:.05}}}},Y4={collapsed:{rotate:-90},expanded:{rotate:0}},Tv=m.memo(({id:s,label:e,description:r,defaultExpanded:a=!0,children:n,itemCount:i,alwaysExpanded:o=!1,className:l=""})=>{const[c,A]=m.useState(()=>{if(o)return!0;const f=localStorage.getItem(`${o0}${s}`);return f!==null?f==="true":a});m.useEffect(()=>{o||localStorage.setItem(`${o0}${s}`,c.toString())},[s,c,o]);const d=m.useCallback(()=>{o||A(f=>!f)},[o]),h=m.useCallback(f=>{(f.key==="Enter"||f.key===" ")&&(f.preventDefault(),d())},[d]);return t.jsxs("div",{className:`${l}`,children:[t.jsxs("button",{onClick:d,onKeyDown:h,disabled:o,className:`
          w-full flex items-center gap-2 px-3 py-2
          text-left
          transition-colors
          ${o?"cursor-default":"cursor-pointer hover:bg-neutral-50"}
          focus:outline-none focus-visible:ring-2 focus-visible:ring-violet-500/40
        `,style:{borderRadius:ir.sm,transitionDuration:`${$t.duration.fast}ms`},"aria-expanded":c,"aria-controls":`action-group-content-${s}`,children:[!o&&t.jsx(Ye.div,{variants:Y4,animate:c?"expanded":"collapsed",transition:{duration:$t.duration.fast/1e3},className:"flex-shrink-0",children:t.jsx(ps,{size:14,className:"text-neutral-400",strokeWidth:2})}),t.jsx("span",{className:`
          text-[11px] font-semibold uppercase tracking-wider
          text-neutral-500
        `,children:e}),i!==void 0&&t.jsx("span",{className:`
            px-1.5 py-0.5
            text-[10px] font-medium
            bg-neutral-100 text-neutral-500
            rounded-full
          `,children:i}),r&&c&&t.jsx("span",{className:`
            ml-auto
            text-[10px] text-neutral-400
            truncate max-w-[120px]
          `,children:r})]}),t.jsx(as,{initial:!1,children:c&&t.jsx(Ye.div,{id:`action-group-content-${s}`,initial:"collapsed",animate:"expanded",exit:"collapsed",variants:J4,className:"overflow-hidden",children:t.jsx("div",{className:"px-3 pb-2 pt-1",children:n})})})]})});Tv.displayName="ActionGroup";const X4={hidden:{opacity:0,y:-8,height:0,transition:{duration:$t.duration.normal/1e3,ease:$t.easing.in}},visible:{opacity:1,y:0,height:"auto",transition:{duration:$t.duration.normal/1e3,ease:$t.easing.out}}},Fv=m.memo(({isOpen:s,onDictate:e,onType:r,onVision:a,onClick:n,loadingActions:i=new Set,className:o=""})=>{const l=m.useCallback(c=>{const A=i.has(c.id);return Nv(c)?t.jsx(_p,{id:c.id,label:c.label,alias:c.alias,icon:c.icon,onDictate:()=>e(c),onType:()=>r(c),onVision:()=>a(c),shortcut:c.shortcut,isLoading:A,disabled:c.comingSoon,colorTheme:c.colorTheme,compact:!0},c.id):Cv(c)?t.jsx(Mp,{id:c.id,label:c.label,alias:c.alias,icon:c.icon,onDictate:()=>e(c),onType:()=>r(c),shortcut:c.shortcut,isLoading:A,disabled:c.comingSoon,colorTheme:c.colorTheme,compact:!0},c.id):t.jsx(Tu,{id:c.id,label:c.label,alias:c.alias,icon:c.icon,onClick:()=>n(c),shortcut:c.shortcut,isLoading:A,disabled:c.comingSoon,comingSoon:c.comingSoon,colorTheme:c.colorTheme,compact:!0},c.id)},[i,e,r,a,n]);return t.jsx(as,{children:s&&t.jsxs(Ye.div,{variants:X4,initial:"hidden",animate:"visible",exit:"hidden",className:`
            bg-white border border-neutral-200
            overflow-hidden
            ${o}
          `,style:{borderRadius:ir.lg,boxShadow:nl.dropdown,maxHeight:"calc(100vh - 220px)",overflowY:"auto"},children:[wv.map(c=>{const A=nm.filter(d=>d.group===c.id);return A.length===0?null:t.jsx(Tv,{id:c.id,label:c.label,description:c.description,defaultExpanded:c.defaultExpanded,itemCount:A.length,children:t.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:A.map(l)})},c.id)}),t.jsx("div",{className:`
            px-3 py-2
            bg-neutral-50 border-t border-neutral-100
            sticky bottom-0
          `,children:t.jsxs("div",{className:"flex items-center justify-between text-[10px] text-neutral-500",children:[t.jsx("span",{children:"Browse groups ‚Ä¢ Hover for D|T split"}),t.jsx("span",{className:"font-medium",children:"ESC to close"})]})})]})})});Fv.displayName="ActionsDrawer";const Z4=["quick-letter","background","medications","investigation-summary"],ek={hidden:{opacity:0},visible:{opacity:1,transition:{staggerChildren:.05}}},Bd={hidden:{opacity:0,y:8},visible:{opacity:1,y:0,transition:{duration:$t.duration.normal/1e3}}},Pv=m.memo(({onDictate:s,onType:e,onVision:r,onWrapUp:a,useExecutor:n=!0,loadingActions:i=new Set,className:o=""})=>{const{execute:l,isExecuting:c}=Sv(),A=m.useCallback(async(f,u)=>{n?await l(f.id,u,{origin:"favourites"}):u==="dictate"?s(f):u==="type"?e(f):u==="vision"&&r(f)},[n,l,s,e,r]),d=m.useCallback(async()=>{n?await l("appointment-wrap-up","click",{origin:"favourites"}):a()},[n,l,a]),h=Z4.map(f=>ip(f)).filter(Boolean);return t.jsxs(Ye.div,{className:`flex items-stretch gap-1.5 ${o}`,variants:ek,initial:"hidden",animate:"visible",children:[h.map(f=>{const u=i.has(f.id);return Nv(f)?t.jsx(Ye.div,{className:"flex-1 min-w-0",variants:Bd,children:t.jsx(_p,{id:f.id,label:f.label,alias:f.alias,icon:f.icon,onDictate:()=>A(f,"dictate"),onType:()=>A(f,"type"),onVision:()=>A(f,"vision"),shortcut:f.shortcut,isLoading:u||c,colorTheme:f.colorTheme,compact:!0})},f.id):Cv(f)?t.jsx(Ye.div,{className:"flex-1 min-w-0",variants:Bd,children:t.jsx(Mp,{id:f.id,label:f.label,alias:f.alias,icon:f.icon,onDictate:()=>A(f,"dictate"),onType:()=>A(f,"type"),shortcut:f.shortcut,isLoading:u||c,colorTheme:f.colorTheme,compact:!0})},f.id):t.jsx(Ye.div,{className:"flex-1 min-w-0",variants:Bd,children:t.jsx(Tu,{id:f.id,label:f.label,alias:f.alias,icon:f.icon,onClick:()=>A(f,"dictate"),shortcut:f.shortcut,isLoading:u||c,colorTheme:f.colorTheme,compact:!0})},f.id)}),t.jsx(Ye.div,{className:"flex-[1.25] min-w-0",variants:Bd,children:t.jsx(Tu,{id:Jn.id,label:Jn.label,alias:Jn.alias,icon:Jn.icon,onClick:d,shortcut:Jn.shortcut,isLoading:i.has(Jn.id)||c,colorTheme:Jn.colorTheme,compact:!0})})]})});Pv.displayName="FavouritesRow";const l0={idle:{label:"Ready",bgColor:"bg-emerald-50",textColor:"text-emerald-700",showDot:!1},"extracting-patient":{label:"Preparing",bgColor:"bg-blue-50",textColor:"text-blue-700",showDot:!0,animated:!0},recording:{label:"Recording‚Ä¶",bgColor:"bg-red-50",textColor:"text-red-700",showDot:!0,animated:!0},transcribing:{label:"Transcribing",bgColor:"bg-blue-50",textColor:"text-blue-700",showDot:!0,animated:!0},classifying:{label:"Analyzing",bgColor:"bg-purple-50",textColor:"text-purple-700",showDot:!0,animated:!0},processing:{label:"Processing",bgColor:"bg-purple-50",textColor:"text-purple-700",showDot:!0,animated:!0},formatting:{label:"Formatting",bgColor:"bg-purple-50",textColor:"text-purple-700",showDot:!0,animated:!0},enhancing:{label:"Enhancing",bgColor:"bg-purple-50",textColor:"text-purple-700",showDot:!0,animated:!0},complete:{label:"Complete",bgColor:"bg-teal-50",textColor:"text-teal-700",showDot:!1},error:{label:"Error",bgColor:"bg-rose-50",textColor:"text-rose-700",showIcon:!0},cancelled:{label:"Cancelled",bgColor:"bg-gray-100",textColor:"text-gray-600",showDot:!1},cancelling:{label:"Cancelling",bgColor:"bg-amber-50",textColor:"text-amber-700",showDot:!0,animated:!0}},Uv=bs.memo(({status:s,isRecording:e=!1,micAvailable:r=!0,className:a=""})=>{let n;return!r&&s==="idle"?n={label:"Mic unavailable",bgColor:"bg-gray-100",textColor:"text-gray-600",showIcon:!0}:n=l0[s]||l0.idle,t.jsxs("div",{className:`
        inline-flex items-center gap-1 px-2 py-0.5 rounded-full
        ${n.bgColor} ${n.textColor}
        ${a}
      `,role:"status","aria-live":"polite","aria-label":`Status: ${n.label}`,children:[n.showDot&&t.jsx("span",{className:`
            w-1.5 h-1.5 rounded-full bg-current
            ${n.animated?"motion-safe:animate-pulse":""}
          `,"aria-hidden":"true"}),n.showIcon&&t.jsx(xr,{className:"w-3 h-3","aria-hidden":"true"}),t.jsx("span",{className:"text-xs font-medium leading-none",children:n.label})]})});Uv.displayName="StateChip";const tk=({isCompact:s=!1,className:e=""})=>{const[r,a]=m.useState(null),[n,i]=m.useState(!1);if(m.useEffect(()=>{let l;return(async()=>{const{AudioProcessingQueueService:A}=await ns(async()=>{const{AudioProcessingQueueService:f}=await import("./chunks/AudioProcessingQueueService.BVdSSjm2.js");return{AudioProcessingQueueService:f}},__vite__mapDeps([17,4,2,1,5,6])),d=A.getInstance(),h=()=>{const f=d.getQueueStats();a(f);const u=f.queuedJobs>0||f.processingJobs>0;i(u)};h(),l=setInterval(h,2e3)})(),()=>{l&&clearInterval(l)}},[]),!n||!r)return null;const o=l=>l<1e3?`${Math.round(l)}ms`:l<6e4?`${Math.round(l/1e3)}s`:`${Math.round(l/6e4)}m`;return s?t.jsxs("div",{className:`inline-flex items-center space-x-2 text-xs text-gray-600 ${e}`,children:[r.processingJobs>0&&t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx(tl,{className:"w-3 h-3 text-blue-500"}),t.jsxs("span",{children:[r.processingJobs," processing"]})]}),r.queuedJobs>0&&t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx(_a,{className:"w-3 h-3 text-amber-500"}),t.jsxs("span",{children:[r.queuedJobs," queued"]})]})]}):t.jsxs("div",{className:`bg-gradient-to-br from-white to-slate-50/50 border border-gray-200 rounded-xl p-3 shadow-sm ${e}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(mc,{className:"w-4 h-4 text-blue-600"}),t.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Audio Queue"})]}),r.currentConcurrency>0&&t.jsxs("div",{className:"flex items-center space-x-1 text-xs text-green-600",children:[t.jsx(tl,{className:"w-3 h-3"}),t.jsxs("span",{children:[r.currentConcurrency,"/",r.maxConcurrency]})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[t.jsxs("div",{className:"space-y-1",children:[r.processingJobs>0&&t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Processing"}),t.jsxs("div",{className:"flex items-center space-x-1 text-blue-600",children:[t.jsx(tl,{className:"w-3 h-3"}),t.jsx("span",{className:"font-medium",children:r.processingJobs})]})]}),r.queuedJobs>0&&t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Queued"}),t.jsxs("div",{className:"flex items-center space-x-1 text-amber-600",children:[t.jsx(_a,{className:"w-3 h-3"}),t.jsx("span",{className:"font-medium",children:r.queuedJobs})]})]})]}),t.jsxs("div",{className:"space-y-1",children:[r.completedJobs>0&&t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Completed"}),t.jsx("span",{className:"font-medium text-green-600",children:r.completedJobs})]}),r.failedJobs>0&&t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Failed"}),t.jsxs("div",{className:"flex items-center space-x-1 text-red-600",children:[t.jsx(or,{className:"w-3 h-3"}),t.jsx("span",{className:"font-medium",children:r.failedJobs})]})]}),r.averageProcessingTime>0&&t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"Avg Time"}),t.jsx("span",{className:"font-medium text-gray-900",children:o(r.averageProcessingTime)})]})]})]}),r.processingJobs>0&&t.jsx("div",{className:"mt-2 pt-2 border-t border-gray-100",children:t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("div",{className:"flex-1 bg-gray-200 rounded-full h-1",children:t.jsx("div",{className:"bg-blue-500 h-1 rounded-full transition-all duration-300",style:{width:`${r.processingJobs/r.maxConcurrency*100}%`}})}),t.jsxs("span",{className:"text-xs text-gray-500",children:[r.processingJobs,"/",r.maxConcurrency]})]})})]})},sk=({phase:s,progress:e,compact:r=!1})=>{const a=Math.max(0,Math.min(100,e)),n=r?`${a}%`:`${s} ¬∑ ${a}%`;return t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("div",{className:"session-progress-bar",role:"progressbar","aria-valuenow":a,"aria-valuemin":0,"aria-valuemax":100,"aria-label":`Processing progress: ${a}%`,children:t.jsx("div",{className:"session-progress-fill",style:{width:`${a}%`}})}),t.jsx("span",{className:"text-[10px] font-medium text-slate-600 tabular-nums","aria-live":"polite","aria-atomic":"true",children:n})]})},rk=(s="portal-root")=>{const e=m.useRef(null),[r,a]=m.useState(null),n=m.useRef(null);return m.useEffect(()=>{const i=()=>{let l=document.getElementById(s);return l&&!document.body.contains(l)&&(console.warn(`üö® Portal container "${s}" exists but not in DOM - recreating`),l=null),l||(console.log(`üèóÔ∏è Creating portal container: ${s}`),l=document.createElement("div"),l.id=s,l.style.position="relative",l.style.zIndex="999999",l.style.pointerEvents="none",document.body.appendChild(l)),e.current=l,a(l),l};i(),n.current=new MutationObserver(l=>{for(const c of l)c.type==="childList"&&c.removedNodes.length>0&&Array.from(c.removedNodes).some(d=>d===e.current)&&(console.warn(`üö® Portal container "${s}" was removed from DOM - recreating`),i())}),n.current.observe(document.body,{childList:!0,subtree:!1});const o=window.setInterval(()=>{e.current&&!document.body.contains(e.current)&&(console.warn(`üö® Portal container "${s}" missing during validation - recreating`),i())},3e3);return()=>{console.log(`üßπ usePortal cleanup for "${s}" - keeping container in DOM`),n.current&&(n.current.disconnect(),n.current=null),window.clearInterval(o)}},[s]),r},Lv=({isOpen:s,children:e,onClickOutside:r})=>{const a=rk("dropdown-portal");return m.useEffect(()=>{if(!s||!r)return;const n=o=>{const l=o.target;!l.closest("[data-dropdown-menu]")&&!l.closest("[data-dropdown-trigger]")&&r()},i=setTimeout(()=>{document.addEventListener("mousedown",n)},0);return()=>{clearTimeout(i),document.removeEventListener("mousedown",n)}},[s,r]),!s||!a?null:Dy.createPortal(t.jsx(t.Fragment,{children:e}),a)},c0={letters:{id:"letters",label:"Letters & Correspondence",icon:"‚úâÔ∏è",agents:["quick-letter","consultation","patient-education"],colors:{bg:"bg-blue-50",bgHover:"bg-blue-100",bgGradient:"bg-gradient-to-br from-blue-50 to-blue-100",border:"border-blue-200",borderHover:"border-blue-300",text:"text-blue-700",textMuted:"text-blue-600",indicator:"bg-blue-500",badgeBg:"bg-blue-100",badgeText:"text-blue-700"},description:"Clinical letters, consultations, and patient communications"},clinical_data:{id:"clinical_data",label:"Clinical Data",icon:"üìã",agents:["background","investigation-summary","medication","bloods","imaging"],colors:{bg:"bg-emerald-50",bgHover:"bg-emerald-100",bgGradient:"bg-gradient-to-br from-emerald-50 to-emerald-100",border:"border-emerald-200",borderHover:"border-emerald-300",text:"text-emerald-700",textMuted:"text-emerald-600",indicator:"bg-emerald-500",badgeBg:"bg-emerald-100",badgeText:"text-emerald-700"},description:"Patient background, investigations, and clinical summaries"},procedures:{id:"procedures",label:"Procedures",icon:"üî¨",agents:["tavi","tavi-workup","angiogram-pci","mteer","tteer","pfo-closure","asd-closure","pvl-plug","bypass-graft","right-heart-cath","pre-op-plan"],colors:{bg:"bg-purple-50",bgHover:"bg-purple-100",bgGradient:"bg-gradient-to-br from-purple-50 to-purple-100",border:"border-purple-200",borderHover:"border-purple-300",text:"text-purple-700",textMuted:"text-purple-600",indicator:"bg-purple-500",badgeBg:"bg-purple-100",badgeText:"text-purple-700"},description:"Interventional cardiac procedures and reports"},ai_review:{id:"ai_review",label:"AI Review",icon:"üß†",agents:["ai-medical-review","batch-ai-review","aus-medical-review"],colors:{bg:"bg-amber-50",bgHover:"bg-amber-100",bgGradient:"bg-gradient-to-br from-amber-50 to-amber-100",border:"border-amber-200",borderHover:"border-amber-300",text:"text-amber-700",textMuted:"text-amber-600",indicator:"bg-amber-500",badgeBg:"bg-amber-100",badgeText:"text-amber-700"},description:"AI-powered clinical reviews and recommendations"}};function Dv(s){for(const e of Object.values(c0))if(e.agents.includes(s))return e;return c0.clinical_data}function ak(s){return Dv(s).colors}function nk(s){return Dv(s).icon}const En=3,ik=s=>{const e=new Date(s),r=new Date,a=new Date(r);a.setDate(a.getDate()-1);const n=new Date(e);n.setHours(0,0,0,0);const i=new Date(r);i.setHours(0,0,0,0);const o=new Date(a);return o.setHours(0,0,0,0),n.getTime()===i.getTime()?"Today":n.getTime()===o.getTime()?"Yesterday":e.toLocaleDateString("en-AU",{weekday:"short",day:"numeric",month:"short"})},jl=s=>{const r={recording:"recording",transcribing:"transcribing",processing:"ai-analysis",needs_review:"needs_review",completed:"completed",error:"error"}[s],a=No(r),n={recording:t.jsx($r,{className:`w-3 h-3 text-${a.indicator}`}),transcribing:t.jsx(Za,{className:`w-3 h-3 animate-spin text-${a.indicator}`}),processing:t.jsx(Ey,{className:`w-3 h-3 text-${a.indicator}`}),needs_review:t.jsx(Qu,{className:`w-3 h-3 text-${a.text}`}),completed:t.jsx(ei,{className:`w-3 h-3 text-${a.text}`}),error:t.jsx(xr,{className:`w-3 h-3 text-${a.text}`})},i={recording:"Audio capture in progress",transcribing:"Converting speech to clinical text",processing:"AI drafting the note",needs_review:"Ready for clinician polish",completed:"Finalized and ready to send",error:"Resolve to keep queue moving"};return{label:{recording:"Recording",transcribing:"Transcribing",processing:"Processing",needs_review:"Needs Review",completed:"Completed",error:"Attention Needed"}[s],badgeClass:`bg-gradient-to-br from-${a.gradient.from} to-${a.gradient.to} text-${a.text} border border-${a.border}/70`,dotClass:`bg-${a.indicator} border-${a.border}/60`,icon:n[s],description:i[s],cardClass:a.bgGradient+` border-${a.border}/60`,chipClass:`text-${a.text}`,accentEdgeClass:`before:bg-gradient-to-br before:from-${a.gradient.from.replace("-50","-300")}/40 before:via-${a.gradient.to.replace("-50","-200")}/30 before:to-transparent`}},ok={recording:jl("recording"),transcribing:jl("transcribing"),processing:jl("processing"),needs_review:jl("needs_review"),completed:jl("completed"),error:jl("error")},A0=s=>{if(!s||s<0)return"‚Äî";const e=Math.floor(s/1e3);if(e<60)return`${e}s`;const r=Math.floor(e/60),a=e%60;return a===0?`${r}m`:`${r}m ${a}s`},d0=s=>s?new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"‚Äî",lk=s=>{const e=s.status;return e==="recording"?"recording":e==="transcribing"?"transcribing":e==="processing"?"processing":e==="error"||e==="cancelled"?"error":e==="completed"&&s.completed&&(s.reviewedAt||s.finalizedAt)?"completed":"needs_review"},ck=s=>s.processingTime?s.processingTime:s.processingStartTime&&s.completedTime?s.completedTime-s.processingStartTime:null,Ak=s=>s.recordingStartTime&&s.transcriptionStartTime?s.transcriptionStartTime-s.recordingStartTime:null,dk=s=>({"bg-blue-500":"59, 130, 246","bg-emerald-500":"16, 185, 129","bg-purple-500":"168, 85, 247","bg-amber-500":"245, 158, 11"})[s]||"168, 85, 247",El=({session:s,state:e,isSelected:r,isNextReview:a,isActiveRecording:n,copiedSessionId:i,isChecked:o,isCompact:l,isPersisted:c,onToggleCheck:A,onSessionSelect:d,onResumeRecording:h,onStopRecording:f,onAgentReprocess:u,onRemoveSession:x,onCopyResults:b,onClose:N})=>{const v=ok[e],j=!!(s.results&&s.results.trim().length>0),I=i===s.id,C=Ak(s),E=ck(s),[T,Q]=m.useState(!1),D=ak(s.agentType),k=nk(s.agentType),R=m.useCallback(()=>{d&&d(s)},[d,s]),w=m.useCallback(()=>{e!=="recording"&&d&&(Q(!0),setTimeout(()=>Q(!1),200),R(),N&&setTimeout(N,250))},[e,d,R,N]),L=m.useCallback(P=>{P.stopPropagation(),A(s.id)},[A,s.id]),M=dk(D.indicator);return l?t.jsx("div",{className:`relative rounded-lg border-l-4 transition-all duration-300 px-2 py-1.5 ${D.bg} ${D.border} opacity-60 hover:opacity-80 ${r?"ring-2":""} ${e!=="recording"&&d?"cursor-pointer":""}`,style:{borderLeftColor:`var(--${D.indicator.replace("bg-","")})`,...r?{"--tw-ring-color":`rgba(${M}, 0.5)`}:{},...T?{animation:"clickFeedback 0.2s cubic-bezier(0.4, 0, 0.2, 1)","--click-shadow-color":`rgba(${M}, 0.3)`}:{}},onClick:w,children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"flex-shrink-0 cursor-pointer group",onClick:L,role:"button","aria-label":"Unmark session as complete",children:t.jsx("div",{className:"w-5 h-5 rounded border-2 bg-emerald-500 border-emerald-600 flex items-center justify-center",children:t.jsx(ei,{className:"w-3.5 h-3.5 text-white"})})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-xs",children:k}),t.jsx("p",{className:"truncate font-medium text-xs text-slate-700",children:s.patient?.name||"Unnamed patient"})]}),t.jsx("span",{className:"text-[9px] text-slate-500 whitespace-nowrap",children:d0(s.timestamp)})]}),t.jsxs("div",{className:"flex items-center gap-1 text-[9px] text-slate-500 truncate",children:[c&&t.jsx("span",{title:"Stored locally",children:t.jsx(Mg,{className:"w-2.5 h-2.5 flex-shrink-0"})}),t.jsx("span",{className:"truncate",children:s.agentName||s.agentType})]})]}),t.jsx(Zt,{onClick:P=>{P.stopPropagation(),x(s.id)},icon:t.jsx(Ln,{}),variant:"ghost",size:"sm","aria-label":"Remove",className:"flex-shrink-0 text-slate-400 hover:text-rose-600 w-auto h-auto p-1",title:"Remove"})]})}):t.jsx("div",{className:`relative rounded-card border-l-4 transition-all duration-300 px-3 py-2 ${D.bg} ${D.border} ${r?"ring-2":""} ${e!=="recording"&&d?"cursor-pointer":""}`,style:{borderLeftColor:`var(--${D.indicator.replace("bg-","")})`,...r?{"--tw-ring-color":`rgba(${M}, 0.5)`}:{},...T?{animation:"clickFeedback 0.2s cubic-bezier(0.4, 0, 0.2, 1)","--click-shadow-color":`rgba(${M}, 0.3)`}:{}},onClick:w,children:t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx("div",{className:"flex-shrink-0 pt-0.5 cursor-pointer group",onClick:L,role:"button","aria-label":o?"Unmark session as complete":"Mark session as complete",children:t.jsx("div",{className:`w-5 h-5 rounded border-2 flex items-center justify-center transition-all ${o?"bg-emerald-500 border-emerald-600":"bg-white border-slate-300 group-hover:border-emerald-400 group-hover:bg-emerald-50"}`,children:o&&t.jsx(ei,{className:"w-3.5 h-3.5 text-white"})})}),t.jsxs("div",{className:"flex items-start justify-between gap-2 flex-1 min-w-0",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-1.5 mb-1",children:[t.jsx("span",{className:"text-base opacity-40 flex-shrink-0",children:k}),t.jsx("p",{className:"truncate font-semibold text-sm text-slate-900",children:s.patient?.name||"Unnamed patient"}),t.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full px-1.5 py-0.5 text-[10px] font-semibold uppercase tracking-wide ${v.badgeClass} ${v.chipClass}`,children:[v.icon,t.jsx("span",{children:v.label})]}),e==="processing"&&s.pipelineProgress&&t.jsx(sk,{phase:s.pipelineProgress.details||s.pipelineProgress.stage||"Processing",progress:s.pipelineProgress.stageProgress||s.pipelineProgress.progress,compact:!0}),a&&t.jsx("span",{className:"rounded-full bg-amber-100 px-1.5 py-0.5 text-[9px] font-semibold uppercase tracking-wide text-amber-700",children:"Next"})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-x-2 gap-y-0.5 text-[10px] font-medium uppercase tracking-wide text-slate-500",children:[t.jsxs("span",{className:"flex items-center gap-0.5",children:[t.jsx(Da,{className:"w-2.5 h-2.5 text-slate-400"}),ik(s.timestamp)]}),t.jsxs("span",{className:"flex items-center gap-0.5",children:[t.jsx(_a,{className:"w-2.5 h-2.5 text-slate-400"}),d0(s.timestamp)]}),t.jsxs("span",{className:"flex items-center gap-0.5",children:[c&&t.jsx("span",{title:"Stored locally",children:t.jsx(Mg,{className:"w-2.5 h-2.5 flex-shrink-0"})}),t.jsx("span",{children:s.agentName||s.agentType})]}),C!==null&&t.jsxs("span",{className:"flex items-center gap-0.5",children:[t.jsx($r,{className:"w-2.5 h-2.5 text-slate-400"}),A0(C)]}),E!==null&&t.jsxs("span",{className:"flex items-center gap-0.5",children:[t.jsx(Ey,{className:"w-2.5 h-2.5 text-slate-400"}),A0(E)]})]}),e==="error"&&s.errors?.length?t.jsxs("div",{className:"mt-1 space-y-1",children:[t.jsxs("div",{className:"text-[10px] text-rose-600 flex items-center gap-1",children:[t.jsx(xr,{className:"w-2.5 h-2.5 flex-shrink-0"}),t.jsx("span",{className:"font-medium",children:s.errors[0]})]}),s.errors.length>1&&t.jsxs("details",{className:"text-[9px] text-rose-500",children:[t.jsxs("summary",{className:"cursor-pointer hover:text-rose-700 ml-3",children:["Show ",s.errors.length-1," more error",s.errors.length>2?"s":""]}),t.jsx("ul",{className:"mt-0.5 pl-3 space-y-0.5 list-disc",children:s.errors.slice(1).map((P,K)=>t.jsx("li",{children:P},K))})]}),t.jsxs("div",{className:"flex items-start gap-1.5 ml-3",children:[t.jsx("div",{className:"text-[9px] text-amber-600 flex-1",children:'üí° Try: Check LM Studio is running ‚Üí Click "Retry"'}),u&&d&&t.jsx(ye,{onClick:P=>{P.stopPropagation(),d(s),setTimeout(()=>u(s.agentType),100)},variant:"outline",size:"sm",startIcon:t.jsx(Xa,{}),className:"border-amber-200/80 bg-amber-50 text-amber-700 hover:bg-amber-100 text-[10px] font-semibold uppercase w-auto h-auto px-1.5 py-0.5",title:"Retry processing this session",children:"Retry"})]})]}):null,(e==="needs_review"||e==="completed")&&j&&t.jsx("div",{className:"mt-2 rounded border border-slate-200/70 bg-slate-50/80 px-2 py-1 text-[10px] text-slate-600",children:t.jsxs("p",{className:"line-clamp-2 leading-relaxed",children:[s.results.slice(0,120),"‚Ä¶"]})})]}),t.jsxs("div",{className:"flex flex-col gap-1.5",children:[e==="recording"&&n&&f&&t.jsx(Zt,{onClick:P=>{P.stopPropagation(),f()},icon:t.jsx(jy,{}),variant:"outline",size:"sm","aria-label":"Stop recording",className:"border-red-200/80 bg-white text-red-600 hover:bg-red-50 w-auto h-auto px-2 py-1",title:"Stop recording"}),e==="recording"&&!n&&h&&t.jsx(Zt,{onClick:P=>{P.stopPropagation(),h(s)},icon:t.jsx(wA,{}),variant:"outline",size:"sm","aria-label":"Resume recording",className:"border-red-200/80 bg-red-50/80 text-red-600 hover:bg-red-100 w-auto h-auto px-2 py-1",title:"Resume recording"}),(e==="needs_review"||e==="completed")&&t.jsx(Zt,{onClick:P=>{P.stopPropagation(),b(s)},disabled:!j,icon:I?t.jsx(Ms,{}):t.jsx(Xn,{}),variant:"outline",size:"sm","aria-label":"Copy letter",className:`w-auto h-auto px-2 py-1 ${j?"border-emerald-200/80 bg-white text-emerald-600 hover:bg-emerald-50":"border-slate-200/80 bg-white text-slate-400"}`,title:"Copy letter"}),t.jsx(Zt,{onClick:P=>{P.stopPropagation(),x(s.id)},icon:t.jsx(Ln,{}),variant:"outline",size:"sm","aria-label":"Remove",className:"border-slate-200/80 bg-white text-slate-500 hover:bg-rose-50 hover:text-rose-600 w-auto h-auto px-2 py-1",title:"Remove"})]})]})]})})},Rv=m.memo(({sessions:s,onRemoveSession:e,onClearAllSessions:r,onSessionSelect:a,onResumeRecording:n,onStopRecording:i,onAgentReprocess:o,selectedSessionId:l,activeRecordingSessionId:c=null,isOpen:A,onClose:d,triggerRef:h,position:f,checkedSessionIds:u=new Set,onToggleSessionCheck:x,persistedSessionIds:b=new Set})=>{const N=m.useRef(null),v=m.useRef(null),j=m.useRef(null),[I,C]=m.useState(null),[E,T]=m.useState(!1),[Q,D]=m.useState(!1),[k,R]=m.useState(!1),[w,L]=m.useState("");m.useEffect(()=>{if(!I)return;const ce=setTimeout(()=>C(null),2e3);return()=>clearTimeout(ce)},[I]);const M=m.useCallback(ce=>{x&&x(ce)},[x]),P=m.useCallback(async ce=>{if(!(!ce.results||ce.results.trim().length===0))try{if(navigator?.clipboard?.writeText)await navigator.clipboard.writeText(ce.results);else{const Ie=document.createElement("textarea");Ie.value=ce.results,Ie.setAttribute("readonly",""),Ie.style.position="absolute",Ie.style.left="-9999px",document.body.appendChild(Ie),Ie.select(),document.execCommand("copy"),document.body.removeChild(Ie)}C(ce.id)}catch(Ie){console.error("Failed to copy letter content:",Ie)}},[]),K=w.trim().toLowerCase(),$=m.useMemo(()=>K?s.filter(ce=>{const Ie=ce.patient?.name?.toLowerCase()??"",pe=ce.agentName?.toLowerCase()??"",fe=ce.agentType?.toLowerCase()??"",we=ce.quickActionField?.toLowerCase()??"",de=ce.transcription?.toLowerCase()??"";return Ie.includes(K)||pe.includes(K)||fe.includes(K)||we.includes(K)||de.includes(K)}):s,[s,K]);m.useEffect(()=>{T(!1),D(!1),R(!1)},[K]);const O=K.length>0,W=m.useMemo(()=>$.map(ce=>({session:ce,state:lk(ce),isChecked:u.has(ce.id)})),[$,u]),ee=m.useMemo(()=>W.find(ce=>ce.state==="needs_review"&&!ce.isChecked)||W.find(ce=>ce.state==="completed"&&!ce.isChecked),[W]),V=m.useMemo(()=>{const ce=[],Ie=[],pe=[];W.forEach(({session:we,state:de,isChecked:xe})=>{const Ne={session:we,isChecked:xe};de==="recording"||de==="transcribing"||de==="processing"?Ie.push(Ne):de==="error"?pe.push(Ne):(de==="needs_review"||de==="completed")&&ce.push(Ne)});const fe=(we,de)=>we.isChecked===de.isChecked?0:we.isChecked?1:-1;return ce.sort(fe),Ie.sort(fe),pe.sort(fe),{completed:ce,inProgress:Ie,errored:pe}},[W]),q=m.useMemo(()=>{const ce=O||E?V.completed.length:En,Ie=O||Q?V.inProgress.length:En,pe=O||k?V.errored.length:En;return{completed:V.completed.slice(0,ce),inProgress:V.inProgress.slice(0,Ie),errored:V.errored.slice(0,pe),hasMoreCompleted:!O&&V.completed.length>ce,hasMoreInProgress:!O&&V.inProgress.length>Ie,hasMoreErrored:!O&&V.errored.length>pe}},[V,E,Q,k,O]),S=m.useCallback(()=>O?!1:V.completed.length>0?q.hasMoreCompleted&&!E?(T(!0),!0):!1:V.errored.length>0?q.hasMoreErrored&&!k?(R(!0),!0):!1:V.inProgress.length>0&&q.hasMoreInProgress&&!Q?(D(!0),!0):!1,[O,V.completed.length,V.errored.length,V.inProgress.length,E,k,Q,q.hasMoreCompleted,q.hasMoreErrored,q.hasMoreInProgress]),H=m.useCallback(ce=>{if(O)return;const Ie=ce.currentTarget;Ie.scrollTop+Ie.clientHeight>=Ie.scrollHeight-24&&S()},[S,O]),Y=m.useCallback(ce=>{const Ie=v.current;if(!Ie)return;const pe=Number(ce?.deltaY??0);if(pe===0||O)return;const fe=ce?.target;if(!!fe&&!Ie.contains(fe)){ce.preventDefault(),ce.stopPropagation();const Ne=Math.max(0,Ie.scrollHeight-Ie.clientHeight);Ie.scrollTop=Math.min(Math.max(0,Ie.scrollTop+pe),Ne)}const de=Ie.scrollTop<=0,xe=Ie.scrollTop+Ie.clientHeight>=Ie.scrollHeight-1;if(j.current!==null){pe>0?(ce.preventDefault(),ce.stopPropagation(),j.current+=Math.min(240,pe)):de&&(ce.preventDefault(),ce.stopPropagation());return}if(xe&&pe>0){if(S()){ce.preventDefault(),ce.stopPropagation(),j.current=Ie.scrollTop+Math.min(240,pe);return}ce.preventDefault(),ce.stopPropagation();return}de&&pe<0&&(ce.preventDefault(),ce.stopPropagation())},[S,O]),te=()=>{r(),d()},[G,X]=m.useState(null),le=bs.useRef(),he=m.useCallback(()=>{if(f){X(f);return}if(h?.current){requestAnimationFrame(()=>{if(h?.current){const ce=h.current.getBoundingClientRect(),Ie=320,pe=16,fe=ce.right-Ie,we=fe<pe;X(we?{top:Math.round(ce.bottom+8),left:pe}:{top:Math.round(ce.bottom+8),left:Math.round(fe)})}});return}X(null)},[f,h]),ve=({onClick:ce,hiddenCount:Ie,category:pe})=>t.jsxs(ye,{onClick:ce,variant:"ghost",size:"sm",fullWidth:!0,startIcon:t.jsx(ps,{}),className:"px-3 py-2 text-xs text-gray-600 hover:text-gray-800 hover:bg-gray-50",children:["Scroll to load ",Ie," more ",pe]});m.useEffect(()=>{if(!A)return;he();const ce=()=>he();return window.addEventListener("resize",ce),()=>{window.removeEventListener("resize",ce),le.current&&clearTimeout(le.current)}},[A,he]);const ke=m.useCallback(ce=>{const Ie=Math.min(.7,ce*.05);return{initial:{y:8},animate:{y:0},exit:{y:-6},transition:{duration:.32,ease:"easeOut",delay:Ie}}},[]),Le=m.useCallback(()=>G?{position:"absolute",top:G.top,left:G.left,right:G.right,width:"320px",maxHeight:"calc(100vh - 80px)",zIndex:9990}:{position:"fixed",top:"60px",right:"16px",width:"320px",maxHeight:"calc(100vh - 80px)",zIndex:9990},[G]);m.useLayoutEffect(()=>{const ce=v.current;if(!ce||j.current===null)return;let Ie=!1,pe=0,fe=0;const we=()=>{if(Ie)return;fe+=1;const de=j.current??0,xe=Math.max(0,ce.scrollHeight-ce.clientHeight);if(ce.scrollTop=Math.min(de,xe),fe<30&&xe<de){pe=requestAnimationFrame(we);return}j.current=null};return pe=requestAnimationFrame(we),()=>{Ie=!0,cancelAnimationFrame(pe)}},[E,k,Q,q.completed.length,q.errored.length,q.inProgress.length]);const[Be,Re]=m.useState(!1),re=m.useCallback(ce=>{N.current=ce,Re(!!ce)},[]);if(m.useLayoutEffect(()=>{if(!A||!Be)return;const ce=N.current;if(!ce)return;const Ie=Y;return ce.addEventListener("wheel",Ie,{passive:!1}),()=>{ce.removeEventListener("wheel",Ie)}},[Y,A,Be]),!A)return null;const Me=s.length,Pe=$.length,be=t.jsxs(Ye.div,{ref:re,style:Le(),className:"bg-white rounded-card shadow-modal border border-gray-200 overflow-hidden","data-dropdown-menu":!0,initial:{height:0},animate:{height:"auto"},exit:{height:0},transition:{duration:.35,ease:"easeOut"},children:[t.jsx("div",{className:"p-3 border-b border-gray-100 bg-gray-50",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(ji,{className:"w-4 h-4 text-blue-600"}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-gray-900 font-medium text-sm",children:"Recent Sessions"}),t.jsx("p",{className:"text-gray-600 text-xs",children:O?t.jsxs(t.Fragment,{children:[Pe," match",Pe===1?"":"es",w&&t.jsxs(t.Fragment,{children:[" for ‚Äú",w,"‚Äù"]}),Pe!==Me&&t.jsxs(t.Fragment,{children:[" ‚Ä¢ ",Me," total"]})]}):t.jsxs(t.Fragment,{children:[Me," total ‚Ä¢ ",V.inProgress.length," processing ‚Ä¢ ",V.completed.length," completed",V.errored.length>0&&` ‚Ä¢ ${V.errored.length} error${V.errored.length!==1?"s":""}`]})})]})]}),s.length>0&&t.jsx(Zt,{onClick:te,icon:t.jsx(Ln,{}),variant:"ghost",size:"sm","aria-label":"Clear all sessions",className:"text-gray-500 hover:text-red-600 hover:bg-red-50",title:"Clear all sessions"})]})}),t.jsx("div",{className:"px-3 py-2 border-b border-gray-100 bg-white",children:t.jsxs("div",{className:"relative",children:[t.jsx(cl,{className:"pointer-events-none absolute left-2.5 top-1/2 h-3.5 w-3.5 -translate-y-1/2 text-gray-400"}),t.jsx("input",{value:w,onChange:ce=>L(ce.target.value),placeholder:"Search patients, agents, or transcripts",className:"w-full rounded-lg border border-gray-200 bg-gray-50 pl-8 pr-8 py-1.5 text-xs text-gray-700 placeholder-gray-400 focus:border-violet-500 focus:bg-white focus:outline-none focus:ring-2 focus:ring-violet-500/20",autoFocus:s.length>10}),w&&t.jsx(Zt,{onClick:()=>L(""),icon:t.jsx(jy,{className:"h-3.5 w-3.5"}),variant:"ghost",size:"sm","aria-label":"Clear session search",className:"absolute right-2 top-1/2 -translate-y-1/2 rounded-full w-auto h-auto p-1 text-gray-400 hover:text-gray-600"})]})}),t.jsx("div",{ref:v,className:"max-h-[calc(100vh-160px)] overflow-y-auto overscroll-contain",onScroll:H,children:Pe===0?t.jsx("div",{className:"px-3 py-6 text-center text-sm text-gray-500",children:O?t.jsxs(t.Fragment,{children:["No sessions found for ‚Äú",w,"‚Äù.",t.jsx("br",{}),"Try a different patient name or agent."]}):"No recent sessions"}):t.jsxs(t.Fragment,{children:[V.inProgress.length>0&&t.jsxs("div",{className:"p-2",children:[t.jsxs("div",{className:"flex items-center space-x-1 mb-2 px-2",children:[t.jsx(_a,{className:"w-3 h-3 text-amber-600"}),t.jsx("span",{className:"text-xs font-medium text-amber-700",children:"In Progress"})]}),t.jsxs("div",{className:"space-y-2",children:[q.inProgress.slice(0,En).map(({session:ce,isChecked:Ie})=>{const pe=W.find(fe=>fe.session.id===ce.id);return t.jsx(El,{session:ce,state:pe?.state||"processing",isSelected:l===ce.id,isNextReview:ee?.session.id===ce.id,isActiveRecording:ce.id===c,copiedSessionId:I,isChecked:Ie,isCompact:Ie,isPersisted:b.has(ce.id),onToggleCheck:M,onSessionSelect:a,onResumeRecording:n,onStopRecording:i,onAgentReprocess:o,onRemoveSession:e,onCopyResults:P,onClose:d},ce.id)}),t.jsx(as,{initial:!1,children:Q&&!O&&q.inProgress.length>En&&t.jsx(Ye.div,{className:"overflow-hidden",initial:{height:0},animate:{height:"auto"},exit:{height:0},transition:{duration:.44,ease:"easeOut"},children:t.jsx("div",{className:"space-y-2",children:q.inProgress.slice(En).map(({session:ce,isChecked:Ie},pe)=>{const fe=W.find(we=>we.session.id===ce.id);return t.jsx(Ye.div,{...ke(pe),children:t.jsx(El,{session:ce,state:fe?.state||"processing",isSelected:l===ce.id,isNextReview:ee?.session.id===ce.id,isActiveRecording:ce.id===c,copiedSessionId:I,isChecked:Ie,isCompact:Ie,isPersisted:b.has(ce.id),onToggleCheck:M,onSessionSelect:a,onResumeRecording:n,onStopRecording:i,onAgentReprocess:o,onRemoveSession:e,onCopyResults:P,onClose:d})},ce.id)})})},"inProgress-extra")}),q.hasMoreInProgress&&t.jsx(ve,{onClick:()=>D(!0),hiddenCount:V.inProgress.length-q.inProgress.length,category:"in-progress sessions"})]})]}),V.errored.length>0&&t.jsxs("div",{className:`p-2 ${V.inProgress.length>0?"border-t border-gray-100":""}`,children:[t.jsxs("div",{className:"flex items-center space-x-1 mb-2 px-2",children:[t.jsx("div",{className:"w-3 h-3 bg-red-500 rounded-full flex-shrink-0"}),t.jsx("span",{className:"text-xs font-medium text-red-700",children:"Needs Attention"})]}),t.jsxs("div",{className:"space-y-2",children:[q.errored.slice(0,En).map(({session:ce,isChecked:Ie})=>{const pe=W.find(fe=>fe.session.id===ce.id);return t.jsx(El,{session:ce,state:pe?.state||"error",isSelected:l===ce.id,isNextReview:ee?.session.id===ce.id,isActiveRecording:ce.id===c,copiedSessionId:I,isChecked:Ie,isCompact:Ie,isPersisted:b.has(ce.id),onToggleCheck:M,onSessionSelect:a,onResumeRecording:n,onStopRecording:i,onAgentReprocess:o,onRemoveSession:e,onCopyResults:P,onClose:d},ce.id)}),t.jsx(as,{initial:!1,children:k&&!O&&q.errored.length>En&&t.jsx(Ye.div,{className:"overflow-hidden",initial:{height:0},animate:{height:"auto"},exit:{height:0},transition:{duration:.44,ease:"easeOut"},children:t.jsx("div",{className:"space-y-2",children:q.errored.slice(En).map(({session:ce,isChecked:Ie},pe)=>{const fe=W.find(we=>we.session.id===ce.id);return t.jsx(Ye.div,{...ke(pe),children:t.jsx(El,{session:ce,state:fe?.state||"error",isSelected:l===ce.id,isNextReview:ee?.session.id===ce.id,isActiveRecording:ce.id===c,copiedSessionId:I,isChecked:Ie,isCompact:Ie,isPersisted:b.has(ce.id),onToggleCheck:M,onSessionSelect:a,onResumeRecording:n,onStopRecording:i,onAgentReprocess:o,onRemoveSession:e,onCopyResults:P,onClose:d})},ce.id)})})},"errored-extra")}),q.hasMoreErrored&&t.jsx(ve,{onClick:()=>R(!0),hiddenCount:V.errored.length-q.errored.length,category:"sessions needing attention"})]})]}),V.completed.length>0&&t.jsxs("div",{className:`p-2 ${V.inProgress.length>0||V.errored.length>0?"border-t border-gray-100":""}`,children:[(V.inProgress.length>0||V.errored.length>0)&&t.jsxs("div",{className:"flex items-center space-x-1 mb-2 px-2",children:[t.jsx("div",{className:"w-3 h-3 bg-emerald-500 rounded-full flex-shrink-0"}),t.jsx("span",{className:"text-xs font-medium text-emerald-700",children:"Completed"})]}),t.jsxs("div",{className:"space-y-2",children:[q.completed.slice(0,En).map(({session:ce,isChecked:Ie})=>{const pe=W.find(fe=>fe.session.id===ce.id);return t.jsx(El,{session:ce,state:pe?.state||"needs_review",isSelected:l===ce.id,isNextReview:ee?.session.id===ce.id,isActiveRecording:ce.id===c,copiedSessionId:I,isChecked:Ie,isCompact:Ie,isPersisted:b.has(ce.id),onToggleCheck:M,onSessionSelect:a,onResumeRecording:n,onStopRecording:i,onAgentReprocess:o,onRemoveSession:e,onCopyResults:P,onClose:d},ce.id)}),t.jsx(as,{initial:!1,children:E&&!O&&q.completed.length>En&&t.jsx(Ye.div,{className:"overflow-hidden",initial:{height:0},animate:{height:"auto"},exit:{height:0},transition:{duration:.44,ease:"easeOut"},children:t.jsx("div",{className:"space-y-2",children:q.completed.slice(En).map(({session:ce,isChecked:Ie},pe)=>{const fe=W.find(we=>we.session.id===ce.id);return t.jsx(Ye.div,{...ke(pe),children:t.jsx(El,{session:ce,state:fe?.state||"needs_review",isSelected:l===ce.id,isNextReview:ee?.session.id===ce.id,isActiveRecording:ce.id===c,copiedSessionId:I,isChecked:Ie,isCompact:Ie,isPersisted:b.has(ce.id),onToggleCheck:M,onSessionSelect:a,onResumeRecording:n,onStopRecording:i,onAgentReprocess:o,onRemoveSession:e,onCopyResults:P,onClose:d})},ce.id)})})},"completed-extra")}),q.hasMoreCompleted&&t.jsx(ve,{onClick:()=>T(!0),hiddenCount:V.completed.length-q.completed.length,category:"completed sessions"})]})]})]})})]});return t.jsx(Lv,{isOpen:A,onClickOutside:d,children:t.jsx(as,{mode:"wait",children:be})})},(s,e)=>{if(s.isOpen!==e.isOpen||s.sessions.length!==e.sessions.length||s.onRemoveSession!==e.onRemoveSession||s.onClearAllSessions!==e.onClearAllSessions||s.onSessionSelect!==e.onSessionSelect)return!1;const r=s.position,a=e.position;return!(r?.top!==a?.top||r?.left!==a?.left||r?.right!==a?.right)});Rv.displayName="SessionDropdown";const uk=s=>{const e=Date.parse(s);if(Number.isNaN(e))return s;const r=Date.now()-e;return r<6e4?"Just now":r<36e5?`${Math.floor(r/6e4)} min ago`:r<864e5?`${Math.floor(r/36e5)} h ago`:new Date(e).toLocaleDateString()},mk={clinic_letter:"Clinic Letter",procedure_report:"Procedure Report",echo_report:"Echo Report",task:"Task",note:"Note",unknown:"Dictation"},hk={phone_call_note:"Phone Call Note",audio_dictation:"Dictation"},pk=({jobs:s,isLoading:e=!1,error:r,onRefresh:a,onAttach:n,onDelete:i,attachingJobId:o,deletingJobId:l,attachedJobIds:c})=>{const A=c??new Set,[d,h]=m.useState({});m.useEffect(()=>{h(b=>{const N={...b},v=new Set;for(const j of s){const I=!!j.attached_session_id||A.has(j.id);N[j.id]===void 0?N[j.id]=!I:I&&N[j.id]&&(N[j.id]=!1),v.add(j.id)}return Object.keys(N).forEach(j=>{v.has(j)||delete N[j]}),N})},[c,s]);const f=m.useMemo(()=>[...s].sort((b,N)=>{const v=A.has(b.id)||!!b.attached_session_id,j=A.has(N.id)||!!N.attached_session_id;return v===j?Date.parse(N.created_at)-Date.parse(b.created_at):v?1:-1}),[A,s]),u=(b,N,v)=>{b.preventDefault(),b.stopPropagation(),N&&v&&N(v)},x=b=>{const N=b.job_type==="phone_call_note",v=hk[b.job_type||""]||mk[b.dictation_type]||"Dictation",j=!!b.attached_session_id||A.has(b.id),I=l===b.id,C=o===b.id,E=d[b.id]??!j;return t.jsxs("details",{className:`bg-white border border-gray-200 rounded-lg shadow-sm transition-all ${j?"opacity-80":""}`,open:E,onToggle:T=>{const{open:Q}=T.currentTarget;h(D=>({...D,[b.id]:Q}))},children:[t.jsx("summary",{className:"list-none cursor-pointer",children:t.jsxs("div",{className:"flex items-start justify-between px-3 py-2 gap-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-900",children:v}),t.jsx("p",{className:"text-xs text-gray-500",children:uk(b.created_at)}),t.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[t.jsx("span",{className:`px-2 py-0.5 rounded-full text-[11px] font-semibold ${b.status==="completed"?"bg-emerald-50 text-emerald-700":b.status==="needs_review"?"bg-amber-50 text-amber-700":"bg-gray-100 text-gray-700"}`,children:b.status.replace("_"," ")}),t.jsxs("span",{className:"text-[11px] text-gray-500",children:[Math.round(b.confidence*100),"%"]})]})]}),t.jsxs("div",{className:"flex flex-col items-end gap-1",children:[(j||N)&&t.jsx("span",{className:"text-[11px] text-emerald-600 font-semibold uppercase",children:N?"Saved to rounds":"Attached"}),t.jsxs("div",{className:"flex items-center gap-2",children:[i&&t.jsx(ye,{type:"button",size:"sm",variant:"ghost",className:"text-xs text-red-600 hover:text-red-700",disabled:I||j,isLoading:I,onClick:T=>u(T,i,b),startIcon:t.jsx(Ln,{className:"w-3.5 h-3.5"}),children:"Delete"}),n&&!N&&t.jsx(ye,{size:"sm",variant:j?"outline":"primary",disabled:j||C,isLoading:C,onClick:T=>u(T,n,b),className:"text-xs px-2 py-1",children:j?"Attached":"Attach to EMR"})]})]})]})}),t.jsxs("div",{className:"px-3 pb-3 space-y-2 border-t border-gray-100",children:[b.triage_metadata?.patient_name&&t.jsxs("div",{className:"text-xs text-gray-600",children:[t.jsx("span",{className:"font-medium",children:"Header:"})," ",b.triage_metadata.patient_name]}),b.header_text&&t.jsx("p",{className:"text-sm text-gray-700 bg-gray-50 border border-dashed border-gray-200 rounded p-2",children:b.header_text}),b.transcript_preview&&t.jsx("p",{className:"text-xs text-gray-500 whitespace-pre-line",children:b.transcript_preview}),t.jsxs("div",{className:"flex items-center justify-between text-[11px] text-gray-500",children:[t.jsx("span",{children:b.triage_metadata?.hospital||"Unassigned hospital"}),t.jsx("span",{children:b.audio_filename})]})]})]},`${b.id}-${j?"attached":"unattached"}`)};return t.jsxs("div",{className:"w-[340px] max-h-[720px] overflow-y-auto bg-white rounded-card shadow-modal border border-gray-200 p-4 space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"bg-gray-100 rounded-full p-1.5",children:t.jsx(ky,{className:"w-4 h-4 text-gray-700"})}),t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-gray-900",children:"Mobile Dictations"}),t.jsx("p",{className:"text-xs text-gray-500",children:"Jobs synced from Operator Ingest"})]})]}),a&&t.jsx(Zt,{onClick:a,icon:t.jsx(Xa,{}),variant:"ghost",size:"sm",className:"rounded-full",title:"Refresh list","aria-label":"Refresh list"})]}),r&&t.jsx("div",{className:"text-xs text-red-600 bg-red-50 border border-red-200 rounded p-2",children:r}),e&&t.jsx("div",{className:"text-sm text-gray-500",children:"Loading mobile dictations‚Ä¶"}),!e&&!r&&s.length===0&&t.jsx("div",{className:"text-sm text-gray-500",children:"No mobile recordings yet. Drop audio into the Operator Ingest inbox to sync."}),t.jsx("div",{className:"space-y-3",children:f.map(x)})]})},gk=s=>{const e=s.find(i=>i.deviceId==="default");if(e)return e;const r=s.find(i=>i.label.toLowerCase().includes("built-in")||i.label.toLowerCase().includes("internal")||i.label.toLowerCase().includes("macbook"));if(r)return r;const a=s.find(i=>i.deviceId!=="default"&&i.label&&!i.label.includes("Microphone ")&&!Qp(i.label));if(a)return a;const n=s.find(i=>i.deviceId!=="default");return n||s[0]},fk=s=>{const e=s.find(i=>i.deviceId==="default");if(e)return e;const r=s.find(i=>i.label.toLowerCase().includes("built-in")||i.label.toLowerCase().includes("internal")||i.label.toLowerCase().includes("macbook"));if(r)return r;const a=s.find(i=>i.deviceId!=="default"&&i.label&&!i.label.includes("Speaker ")&&!Qp(i.label));if(a)return a;const n=s.find(i=>i.deviceId!=="default");return n||s[0]},Qp=s=>{const e=s.toLowerCase();return["iphone","ipad","airpods","bluetooth","wireless","headphones","headset","earbuds","watch"].some(a=>e.includes(a))},u0=(s,e,r)=>{if(s.deviceId==="default")return"system default device";const a=s.label.toLowerCase();return a.includes("built-in")||a.includes("internal")||a.includes("macbook")?"built-in device":Qp(s.label)?s.deviceId!=="default"?"non-default device fallback":"first available device":"preferred non-mobile device"},xk=()=>{const[s,e]=m.useState([]),[r,a]=m.useState([]),[n,i]=m.useState(!0),[o,l]=m.useState(!1),{selectedMicrophoneId:c,selectedSpeakerId:A,microphoneSelectionType:d,speakerSelectionType:h,setSelectedMicrophoneId:f,setSelectedSpeakerId:u}=Jy(),x=m.useCallback(async()=>{try{i(!0);const T=(await navigator.permissions.query({name:"microphone"})).state==="granted";l(T);const Q=await navigator.mediaDevices.enumerateDevices(),D=Q.filter(R=>R.kind==="audioinput").map(R=>({deviceId:R.deviceId,label:R.label||`Microphone ${R.deviceId.slice(0,8)}`,groupId:R.groupId,kind:"audioinput"})),k=Q.filter(R=>R.kind==="audiooutput").map(R=>({deviceId:R.deviceId,label:R.label||`Speaker ${R.deviceId.slice(0,8)}`,groupId:R.groupId,kind:"audiooutput"}));if(e(D),a(k),D.length>0&&(!c||d==="auto")){let R=null;if(d==="auto")try{const w=localStorage.getItem("xestro-preferred-microphone");w&&(R=D.find(L=>L.deviceId===w)||null,R&&console.log("üé§ Using saved microphone preference:",R.label))}catch(w){console.warn("Failed to read microphone preference:",w)}R||(R=gk(D),console.log("üé§ Auto-selected microphone:",{deviceId:R.deviceId,label:R.label,selectionReason:u0(R,D,"microphone")})),f(R.deviceId,!1)}if(k.length>0&&(!A||h==="auto")){let R=null;if(h==="auto")try{const w=localStorage.getItem("xestro-preferred-speaker");w&&(R=k.find(L=>L.deviceId===w)||null,R&&console.log("üîä Using saved speaker preference:",R.label))}catch(w){console.warn("Failed to read speaker preference:",w)}R||(R=fk(k),console.log("üîä Auto-selected speaker:",{deviceId:R.deviceId,label:R.label,selectionReason:u0(R,k,"speaker")})),u(R.deviceId,!1)}console.log("üé§ Audio devices enumerated:",{microphones:D.length,speakers:k.length})}catch(E){console.error("üé§ Failed to enumerate audio devices:",E)}finally{i(!1)}},[c,A,d,h,f,u]),b=m.useCallback(async()=>{try{(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(T=>T.stop()),l(!0),await x()}catch(E){console.error("üé§ Failed to get microphone permission:",E),l(!1)}},[x]),N=m.useCallback(E=>{console.log("üé§ Manually selecting microphone:",E),f(E,!0)},[f]),v=m.useCallback(E=>{console.log("üîä Manually selecting speaker:",E),u(E,!0)},[u]),j=m.useCallback(()=>{if(!c)return"No microphone";const E=s.find(T=>T.deviceId===c);return E?E.label:c==="default"?"Default microphone":"Unknown microphone"},[c,s]),I=m.useCallback(()=>{if(!A)return"No speaker";const E=r.find(T=>T.deviceId===A);return E?E.label:A==="default"?"Default speaker":"Unknown speaker"},[A,r]),C=m.useCallback(async()=>{await x()},[x]);return m.useEffect(()=>{x();const E=()=>{console.log("üé§ Audio devices changed, re-enumerating..."),x()};return navigator.mediaDevices.addEventListener("devicechange",E),()=>{navigator.mediaDevices.removeEventListener("devicechange",E)}},[x]),{microphones:s,speakers:r,selectedMicrophoneId:c,selectedSpeakerId:A,isLoading:n,hasPermission:o,setSelectedMicrophone:N,setSelectedSpeaker:v,requestPermission:b,refreshDevices:C,getCurrentMicrophoneLabel:j,getCurrentSpeakerLabel:I}},Mv=1e6,yk=Mv+1,bk={hidden:{opacity:0},visible:{opacity:1}},vk={hidden:{x:"100%",transition:{duration:$t.duration.normal/1e3,ease:$t.easing.in}},visible:{x:0,transition:{duration:$t.duration.normal/1e3,ease:$t.easing.out}}},_v=m.memo(({isOpen:s,onClose:e,isDarkMode:r,onToggleDarkMode:a,onOpenFullSettings:n,className:i=""})=>{const{microphones:o,speakers:l,selectedMicrophoneId:c,selectedSpeakerId:A,setSelectedMicrophone:d,setSelectedSpeaker:h,isLoading:f,hasPermission:u,requestPermission:x}=xk();m.useEffect(()=>{const N=v=>{v.key==="Escape"&&s&&e()};return document.addEventListener("keydown",N),()=>document.removeEventListener("keydown",N)},[s,e]);const b=m.useCallback(()=>{n(),e()},[n,e]);return t.jsx(as,{children:s&&t.jsxs(t.Fragment,{children:[t.jsx(Ye.div,{variants:bk,initial:"hidden",animate:"visible",exit:"hidden",transition:{duration:$t.duration.fast/1e3},className:"fixed inset-0 bg-black/20",style:{zIndex:Mv},onClick:e,"aria-hidden":"true"}),t.jsxs(Ye.div,{variants:vk,initial:"hidden",animate:"visible",exit:"hidden",className:`
              fixed top-0 right-0 bottom-0
              w-[280px] max-w-[80vw]
              bg-white
              flex flex-col
              ${i}
            `,style:{zIndex:yk,boxShadow:nl.modal},role:"dialog","aria-modal":"true","aria-label":"Quick Settings",children:[t.jsxs("div",{className:`
              flex items-center justify-between
              px-4 py-3
              border-b border-neutral-200
            `,children:[t.jsx("h2",{className:"text-sm font-semibold text-neutral-900",children:"Quick Settings"}),t.jsx("button",{onClick:e,className:`
                  p-1.5 rounded-md
                  text-neutral-500 hover:text-neutral-700
                  hover:bg-neutral-100
                  transition-colors
                `,style:{transitionDuration:`${$t.duration.fast}ms`},"aria-label":"Close settings",children:t.jsx(es,{size:18})})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h3",{className:`
                  text-[11px] font-semibold uppercase tracking-wider
                  text-neutral-500 mb-3
                `,children:"Appearance"}),t.jsxs("button",{onClick:a,className:`
                    w-full flex items-center justify-between
                    p-3 rounded-lg border
                    transition-colors
                    hover:bg-neutral-50
                  `,style:{borderRadius:ir.md,borderColor:xn.neutral[200],transitionDuration:`${$t.duration.fast}ms`},children:[t.jsxs("div",{className:"flex items-center gap-3",children:[r?t.jsx(Sy,{size:18,className:"text-violet-600"}):t.jsx(g2,{size:18,className:"text-amber-500"}),t.jsxs("div",{className:"text-left",children:[t.jsx("div",{className:"text-[13px] font-medium text-neutral-900",children:"Dark Mode"}),t.jsx("div",{className:"text-[11px] text-neutral-500",children:r?"On":"Off"})]})]}),t.jsx("div",{className:`
                    relative w-10 h-6 rounded-full
                    transition-colors
                    ${r?"bg-violet-600":"bg-neutral-200"}
                  `,style:{transitionDuration:`${$t.duration.fast}ms`},children:t.jsx(Ye.div,{className:`
                        absolute top-1 left-1
                        w-4 h-4 rounded-full
                        bg-white shadow-sm
                      `,animate:{x:r?16:0},transition:{duration:$t.duration.fast/1e3}})})]})]}),t.jsxs("div",{className:"mb-6",children:[t.jsx("h3",{className:`
                  text-[11px] font-semibold uppercase tracking-wider
                  text-neutral-500 mb-3
                `,children:"Audio Devices"}),u?f?t.jsx("div",{className:"p-3 text-center text-[12px] text-neutral-500",children:"Loading devices..."}):t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx($r,{size:14,className:"text-neutral-500"}),t.jsx("span",{className:"text-[12px] font-medium text-neutral-700",children:"Microphone"})]}),t.jsx("select",{value:c||"",onChange:N=>d(N.target.value),title:"Select microphone","aria-label":"Select microphone",className:`
                          w-full px-3 py-2
                          text-[13px] text-neutral-900
                          bg-white border border-neutral-200
                          rounded-md
                          focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-violet-500
                          transition-colors
                        `,style:{borderRadius:ir.md,transitionDuration:`${$t.duration.fast}ms`},children:o.length===0?t.jsx("option",{value:"",children:"No microphones found"}):o.map(N=>t.jsx("option",{value:N.deviceId,children:N.label||"Unknown Microphone"},N.deviceId))})]}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(f2,{size:14,className:"text-neutral-500"}),t.jsx("span",{className:"text-[12px] font-medium text-neutral-700",children:"Speaker"})]}),t.jsx("select",{value:A||"",onChange:N=>h(N.target.value),title:"Select speaker","aria-label":"Select speaker",className:`
                          w-full px-3 py-2
                          text-[13px] text-neutral-900
                          bg-white border border-neutral-200
                          rounded-md
                          focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-violet-500
                          transition-colors
                        `,style:{borderRadius:ir.md,transitionDuration:`${$t.duration.fast}ms`},children:l.length===0?t.jsx("option",{value:"",children:"No speakers found"}):l.map(N=>t.jsx("option",{value:N.deviceId,children:N.label||"Unknown Speaker"},N.deviceId))})]})]}):t.jsx("div",{className:"p-3 rounded-lg border border-amber-200 bg-amber-50",style:{borderRadius:ir.md},children:t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx(xr,{size:16,className:"text-amber-600 flex-shrink-0 mt-0.5"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-[12px] text-amber-800 mb-2",children:"Audio access required to select devices"}),t.jsx("button",{type:"button",onClick:x,className:`
                            px-3 py-1.5 rounded-md
                            bg-amber-600 text-white
                            text-[12px] font-medium
                            hover:bg-amber-700
                            transition-colors
                          `,style:{transitionDuration:`${$t.duration.fast}ms`},children:"Enable Access"})]})]})})]}),t.jsxs("div",{className:"mb-6",children:[t.jsx("h3",{className:`
                  text-[11px] font-semibold uppercase tracking-wider
                  text-neutral-500 mb-3
                `,children:"Status"}),t.jsx("div",{className:"space-y-2",children:t.jsx("div",{className:`
                    p-3 rounded-lg
                    bg-emerald-50 border border-emerald-200
                  `,style:{borderRadius:ir.md},children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-2 h-2 rounded-full bg-emerald-500"}),t.jsx("span",{className:"text-[12px] font-medium text-emerald-700",children:"All systems operational"})]})})})]})]}),t.jsx("div",{className:`
              px-4 py-3
              border-t border-neutral-200
              bg-neutral-50
            `,children:t.jsxs("button",{onClick:b,className:`
                  w-full flex items-center justify-center gap-2
                  px-4 py-2.5 rounded-lg
                  bg-neutral-900 text-white
                  text-[13px] font-medium
                  hover:bg-neutral-800
                  transition-colors
                `,style:{borderRadius:ir.md,transitionDuration:`${$t.duration.fast}ms`},children:[t.jsx(Bp,{size:16}),"Open Full Settings",t.jsx(Po,{size:12,className:"ml-1 opacity-60"})]})})]})]})})});_v.displayName="QuickSettingsDrawer";const Qv=m.memo(({onDictate:s,onType:e,onVision:r,onClick:a,onWrapUp:n,onOpenFullSettings:i,status:o,isRecording:l=!1,modelStatus:c,patientInfo:A,patientSessions:d=[],selectedSessionId:h,currentSessionId:f,checkedSessionIds:u,persistedSessionIds:x,onSessionSelect:b,onRemoveSession:N,onClearAllSessions:v,onToggleSessionCheck:j,onResumeRecording:I,onAgentReprocess:C,mobileJobs:E=[],mobileJobsLoading:T=!1,mobileJobsError:Q,onRefreshMobileJobs:D,onAttachMobileJob:k,onDeleteMobileJob:R,attachingMobileJobId:w,deletingMobileJobId:L,attachedMobileJobIds:M,onOpenQuickAdd:P,loadingActions:K=new Set,isDarkMode:$=!1,onToggleDarkMode:O=()=>{},className:W=""})=>{const[ee,V]=m.useState(!1),[q,S]=m.useState(""),[H,Y]=m.useState(!1),[te,G]=m.useState(!1),[X,le]=m.useState(!1),[he,ve]=m.useState(!1),[ke,Le]=m.useState(!1),Be=m.useRef(null),Re=m.useRef(null),re=m.useRef(null),Me=m.useRef(o),Pe=d.filter(de=>!u?.has(de.id)).length,be=E.filter(de=>!de.attached_session_id),ce=c.whisperServer?.running;m.useEffect(()=>{const de=Me.current;return Me.current=o,re.current&&(clearTimeout(re.current),re.current=null),["recording","transcribing","classifying","processing","formatting","enhancing","extracting-patient","cancelling"].includes(o)?Le(!0):o==="complete"?(Le(!0),re.current=setTimeout(()=>{Le(!1)},1e4)):o==="idle"&&de==="complete"||(o==="error"||o==="cancelled"?(Le(!0),re.current=setTimeout(()=>{Le(!1)},5e3)):Le(!1)),()=>{re.current&&clearTimeout(re.current)}},[o]);const Ie=()=>{G(!te)},pe=()=>{const de=!X;le(de),de&&!he&&(D?.(),ve(!0))},fe=de=>{if(!de)return"Patient";const xe=["Mr","Mrs","Ms","Miss","Dr","Prof"],Ne=de.split(" ").filter(Xe=>Xe.length>0);let it=0;xe.includes(Ne[0]?.replace(/\./,""))&&Ne.length>1&&(it=1);const st=Ne[it]||"Patient",$e=Ne.length>it+1?Ne[Ne.length-1]:"";return $e?`${st} ${$e}`:st},we=m.useCallback((de,xe)=>{V(!1),xe==="dictate"||de.modes.includes("dictate")&&de.modes.length===1?s(de):xe==="type"?e(de):xe==="vision"?r(de):de.modes.includes("click")?a(de):s(de)},[s,e,r,a]);return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:`bg-white border-b border-neutral-200 ${W}`,children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(as,{mode:"wait",children:ke?t.jsx(Ye.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},exit:{opacity:0,x:-10},transition:{duration:.2},children:t.jsx(Uv,{status:o,isRecording:l,micAvailable:ce})},"status"):t.jsxs(Ye.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},exit:{opacity:0,x:-10},transition:{duration:.2},className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-6 h-6 rounded-md flex items-center justify-center",style:{backgroundColor:xn.primary.subtle},children:t.jsx("span",{className:"text-[11px] font-bold",style:{color:xn.primary.DEFAULT},children:"O"})}),t.jsx("span",{className:"text-[13px] font-semibold text-neutral-900",children:"operator"})]},"logo")}),A&&t.jsxs("div",{className:`
                flex items-center gap-1.5
                px-2 py-1
                bg-emerald-50 border border-emerald-200
                rounded-md
              `,style:{borderRadius:ir.sm},children:[t.jsx(Do,{size:14,className:"text-emerald-600"}),t.jsx("span",{className:"text-[11px] font-medium text-emerald-700 max-w-[120px] truncate",children:fe(A.name)})]})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[P&&t.jsx(Zt,{onClick:P,variant:"ghost",size:"sm",icon:t.jsx(Fr,{size:14}),"aria-label":"Quick Add",title:"Quick Add patient",className:"!p-1 !h-6 !w-6 text-neutral-500 hover:text-violet-600 hover:bg-violet-50"}),t.jsx(tk,{isCompact:!0}),t.jsxs("div",{className:"relative",children:[t.jsx(Zt,{ref:Re,"data-dropdown-trigger":!0,onClick:pe,icon:t.jsx(ky,{size:14}),variant:"ghost",size:"sm",className:`
                  !p-1 !h-6 !w-6
                  text-neutral-500 hover:text-violet-600 hover:bg-violet-50
                  ${X?"bg-violet-50 text-violet-600":""}
                `,style:{transitionDuration:`${$t.duration.fast}ms`},"aria-label":be.length>0?`${be.length} mobile dictations awaiting attachment`:"Mobile dictations",title:"Mobile dictations"}),be.length>0&&t.jsx("span",{className:`
                  absolute -top-1 -right-1
                  bg-emerald-500 text-white
                  text-[9px] font-bold
                  rounded-full
                  flex items-center justify-center
                  min-w-[14px] h-[14px] px-1
                  leading-none
                `,children:be.length})]}),t.jsxs("div",{className:"relative",children:[t.jsx(Zt,{ref:Be,onClick:Ie,icon:t.jsx(x2,{size:14}),variant:"ghost",size:"sm",className:`
                  !p-1 !h-6 !w-6
                  text-neutral-500 hover:text-violet-600 hover:bg-violet-50
                  ${te?"bg-violet-50 text-violet-600":""}
                `,style:{transitionDuration:`${$t.duration.fast}ms`},"aria-label":Pe>0?`${Pe} active session${Pe!==1?"s":""}`:"Session history",title:Pe>0?"View active sessions":"Session history"}),Pe>0&&t.jsx("span",{className:`
                  absolute -top-1 -right-1
                  bg-blue-500 text-white
                  text-[9px] font-bold
                  rounded-full
                  flex items-center justify-center
                  min-w-[14px] h-[14px] px-1
                  leading-none
                `,children:Pe})]}),t.jsx("button",{onClick:()=>Y(!0),className:`
                p-1.5 rounded-md
                text-neutral-500 hover:text-neutral-700
                hover:bg-neutral-100
                transition-colors
              `,style:{borderRadius:ir.sm,transitionDuration:`${$t.duration.fast}ms`},"aria-label":"Open settings",children:t.jsx(Bp,{size:18})})]})]}),t.jsx("div",{className:"px-3 py-2",children:t.jsx(Iv,{isOpen:ee,onOpen:()=>V(!0),onClose:()=>{V(!1),S("")},activateOnHover:!0,onQueryChange:S,onActionSelect:we,placeholder:"Type or press ‚åòK..."})}),ee&&q.trim()===""&&t.jsx("div",{className:"px-3 pb-2",children:t.jsx(Fv,{isOpen:ee,onDictate:s,onType:e,onVision:r,onClick:a,loadingActions:K})}),!ee&&t.jsx(Ye.div,{className:"px-3 pb-2",initial:{opacity:0,y:-8},animate:{opacity:1,y:0},transition:{duration:$t.duration.fast/1e3},children:t.jsx(Pv,{onDictate:s,onType:e,onVision:r,onWrapUp:n,loadingActions:K})})]}),X&&t.jsx(Lv,{isOpen:X,onClickOutside:()=>le(!1),children:t.jsx("div",{"data-dropdown-menu":!0,style:{position:"fixed",top:`${(Re.current?.getBoundingClientRect().bottom||0)+8}px`,left:`${Math.max(8,(Re.current?.getBoundingClientRect().right||340)-360)}px`,zIndex:vv.dropdown},children:t.jsx(pk,{jobs:E,isLoading:T,error:Q,onRefresh:D,onAttach:de=>{le(!1),k?.(de)},onDelete:R,attachingJobId:w||null,deletingJobId:L||null,attachedJobIds:M})})}),te&&N&&v&&t.jsx(Rv,{isOpen:te,onClose:()=>G(!1),triggerRef:Be,sessions:d,onRemoveSession:N,onClearAllSessions:v,onSessionSelect:b,onResumeRecording:I,onAgentReprocess:C,selectedSessionId:h,activeRecordingSessionId:f,checkedSessionIds:u,onToggleSessionCheck:j,persistedSessionIds:x}),t.jsx(_v,{isOpen:H,onClose:()=>Y(!1),isDarkMode:$,onToggleDarkMode:O,onOpenFullSettings:i})]})});Qv.displayName="AppHeader";const wk=({type:s})=>{const e={className:"w-4 h-4 flex-shrink-0"};switch(s){case"success":return t.jsx(Ra,{...e,className:"w-4 h-4 text-emerald-600 flex-shrink-0"});case"error":return t.jsx(or,{...e,className:"w-4 h-4 text-red-600 flex-shrink-0"});case"warning":return t.jsx(xr,{...e,className:"w-4 h-4 text-amber-600 flex-shrink-0"});case"info":return t.jsx(Ma,{...e,className:"w-4 h-4 text-blue-600 flex-shrink-0"});default:return t.jsx(Ma,{...e})}},Ck=({toast:s,onRemove:e})=>{const r=()=>{const a="bg-white border rounded-fluent-sm p-3 shadow-fluent-flyout";switch(s.type){case"success":return`${a} border-emerald-200 bg-emerald-50/95`;case"error":return`${a} border-red-200 bg-red-50/95`;case"warning":return`${a} border-amber-200 bg-amber-50/95`;case"info":return`${a} border-blue-200 bg-blue-50/95`;default:return`${a} border-gray-200 bg-gray-50/95`}};return t.jsx("div",{className:`${r()} animate-in slide-in-from-right-full duration-300`,children:t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx(wk,{type:s.type}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"text-gray-900 font-semibold text-sm leading-tight",children:s.title}),s.message&&t.jsx("p",{className:"text-gray-700 text-xs mt-1.5 leading-relaxed",children:s.message})]}),t.jsx(Zt,{onClick:()=>e(s.id),icon:t.jsx(es,{}),variant:"ghost",size:"sm",className:"flex-shrink-0 text-gray-400 hover:text-gray-600 hover:bg-gray-100",title:"Dismiss notification","aria-label":"Dismiss notification"})]})})},Nk=()=>{const[s,e]=m.useState([]);m.useEffect(()=>gt.getInstance().subscribe(e),[]);const r=a=>{gt.getInstance().remove(a)};return s.length===0?null:t.jsx("div",{className:"fixed top-4 right-4 z-[99999] space-y-2 w-80 max-w-[calc(100vw-2rem)] pointer-events-none","aria-live":"polite",role:"status",style:{maxWidth:"min(20rem, calc(100vw - 2rem))",position:"fixed",top:"1rem",right:"1rem"},children:s.map(a=>t.jsx("div",{className:"pointer-events-auto",children:t.jsx(Ck,{toast:a,onRemove:r})},a.id))})},Bk=({isOpen:s,onClose:e,onStartReview:r,calendarData:a,isExtracting:n=!1,extractError:i})=>{const[o,l]=m.useState(new Set),[c,A]=m.useState("all"),[d,h]=m.useState(!1);if(m.useEffect(()=>{s&&a&&(l(new Set),A("all"))},[s,a]),!s)return null;const f=C=>{const E=new Set(o);E.has(C)?E.delete(C):E.add(C),l(E)},u=()=>{if(!a)return;const C=x(),E=C.every(Q=>o.has(Q.fileNumber)),T=new Set(o);C.forEach(Q=>{E?T.delete(Q.fileNumber):T.add(Q.fileNumber)}),l(T)},x=()=>a?a.patients.filter(C=>{switch(c){case"confirmed":return C.confirmed;case"new":return C.isFirstAppointment;case"routine":return!C.isFirstAppointment;default:return!0}}):[],b=async()=>{if(!a||o.size===0)return;h(!0);const C=a.patients.filter(E=>o.has(E.fileNumber));try{await r(C)}catch(E){console.error("Failed to start batch review:",E)}finally{h(!1)}},N=C=>{switch(C.toLowerCase()){case"canew":return"bg-blue-100 text-blue-800";case"car20":case"carvi":return"bg-green-100 text-green-800";case"canvi":return"bg-purple-100 text-purple-800";case"phone":return"bg-gray-100 text-gray-800";case"unav":return"bg-gray-100 text-gray-600";default:return"bg-gray-100 text-gray-800"}},v=x(),j=o.size,I=Math.ceil(j*2.5);return t.jsx(as,{children:t.jsx(Ye.div,{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",variants:Na(tC),initial:"hidden",animate:"visible",exit:"exit",onClick:e,children:t.jsxs(Ye.div,{className:"bg-gradient-to-br from-white to-slate-50/50 rounded-modal shadow-modal max-w-2xl w-full max-h-[90vh] overflow-hidden mx-4",variants:Na(eC),initial:"hidden",animate:"visible",exit:"exit",onClick:C=>C.stopPropagation(),children:[t.jsxs(Ye.div,{className:"p-6 border-b border-gray-200 bg-gradient-to-br from-purple-50 to-violet-50",variants:Na(Oy),initial:"hidden",animate:"visible",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(ji,{className:"w-6 h-6 text-purple-600"}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Batch AI Medical Review"}),t.jsx("p",{className:"text-sm text-gray-600",children:"Select patients for sequential AI review and analysis"})]})]}),t.jsx(Zt,{onClick:e,icon:t.jsx(es,{}),variant:"ghost",size:"md",className:"text-gray-500",disabled:d,"aria-label":"Close modal"})]}),a&&t.jsxs("div",{className:"mt-4 flex items-center space-x-6 text-sm",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Da,{className:"w-4 h-4 text-purple-600"}),t.jsx("span",{className:"font-medium",children:a.appointmentDate})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(ji,{className:"w-4 h-4 text-purple-600"}),t.jsxs("span",{children:[a.totalCount," total appointments"]})]})]})]}),t.jsx(Ye.div,{className:"flex-1 overflow-hidden",initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},children:n?t.jsx("div",{className:"flex items-center justify-center py-16",children:t.jsxs("div",{className:"text-center",children:[t.jsx(Za,{className:"w-8 h-8 text-purple-600 animate-spin mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Extracting Patient Data"}),t.jsx("p",{className:"text-gray-600",children:"Reading appointment information from calendar..."})]})}):i?t.jsx("div",{className:"flex items-center justify-center py-16",children:t.jsxs("div",{className:"text-center",children:[t.jsx(xr,{className:"w-8 h-8 text-red-500 mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Extraction Failed"}),t.jsx("p",{className:"text-red-600 mb-4",children:i}),t.jsx("p",{className:"text-sm text-gray-600",children:"Please ensure you're on the appointment book page and try again."})]})}):!a||a.patients.length===0?t.jsx("div",{className:"flex items-center justify-center py-16",children:t.jsxs("div",{className:"text-center",children:[t.jsx(ji,{className:"w-8 h-8 text-gray-400 mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Patients Found"}),t.jsx("p",{className:"text-gray-600",children:"No appointments with patient data were found on this calendar page."})]})}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"p-6 border-b border-gray-200",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-4",children:[t.jsx(Iy,{className:"w-4 h-4 text-gray-500"}),t.jsxs("select",{value:c,onChange:C=>A(C.target.value),className:"border border-gray-300 rounded-lg px-3 py-1 text-sm",disabled:d,children:[t.jsxs("option",{value:"all",children:["All Appointments (",a.patients.length,")"]}),t.jsxs("option",{value:"confirmed",children:["Confirmed Only (",a.patients.filter(C=>C.confirmed).length,")"]}),t.jsxs("option",{value:"new",children:["New Patients (",a.patients.filter(C=>C.isFirstAppointment).length,")"]}),t.jsxs("option",{value:"routine",children:["Return Visits (",a.patients.filter(C=>!C.isFirstAppointment).length,")"]})]})]}),t.jsx(ye,{onClick:u,variant:"ghost",size:"sm",className:"text-purple-600 hover:text-purple-700 !h-auto !px-0",disabled:d,children:v.every(C=>o.has(C.fileNumber))?"Deselect All":"Select All"})]})}),t.jsx("div",{className:"overflow-y-auto max-h-96 p-6",children:t.jsx("div",{className:"space-y-3",children:v.map(C=>t.jsx("div",{className:`p-4 border-2 rounded-lg cursor-pointer transition-all ${o.has(C.fileNumber)?"border-purple-300 bg-purple-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>f(C.fileNumber),children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx("input",{type:"checkbox",checked:o.has(C.fileNumber),onChange:()=>f(C.fileNumber),className:"w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500",disabled:d}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("h4",{className:"font-medium text-gray-900",children:C.name}),C.isFirstAppointment&&t.jsx(Sp,{className:"w-4 h-4 text-yellow-500"})]}),t.jsxs("div",{className:"flex items-center space-x-4 text-sm text-gray-600 mt-1",children:[t.jsxs("span",{children:["DOB: ",C.dob]}),t.jsxs("span",{children:["File: ",C.fileNumber]}),t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx(_a,{className:"w-3 h-3"}),t.jsx("span",{children:C.appointmentTime})]})]}),C.notes&&t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:C.notes})]})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${N(C.appointmentType)}`,children:C.appointmentType}),C.confirmed&&t.jsx(Ra,{className:"w-4 h-4 text-green-500"})]})]})},C.fileNumber))})})]})}),a&&a.patients.length>0&&!n&&!i&&t.jsx("div",{className:"p-6 border-t border-gray-200 bg-gray-50",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"text-sm text-gray-600",children:[t.jsx("span",{className:"font-medium",children:j})," patient",j!==1?"s":""," selected",j>0&&t.jsxs("span",{className:"ml-2",children:["‚Ä¢ Estimated time: ",t.jsxs("span",{className:"font-medium",children:[I," minutes"]})]})]}),t.jsxs("div",{className:"flex space-x-3",children:[t.jsx(ye,{onClick:e,variant:"outline",size:"md",disabled:d,children:"Cancel"}),t.jsx(ye,{onClick:b,disabled:j===0||d,variant:"primary",size:"md",startIcon:t.jsx(wA,{}),isLoading:d,className:"bg-purple-600 hover:bg-purple-700",children:d?"Starting...":"Start AI Review"})]})]})})]})})})},Sk=({onGenerate:s,isGenerating:e,isVisible:r,onClose:a,emrExtractionError:n,onRetryExtraction:i,pipelineProgress:o,processingStartTime:l})=>{const[c,A]=m.useState("medium"),[d,h]=m.useState(["diet_nutrition","physical_activity"]),[f,u]=m.useState({}),[x,b]=m.useState(""),[N,v]=m.useState(!1),[j,I]=m.useState(null),[C,E]=m.useState(null),[T,Q]=m.useState(!1);m.useEffect(()=>{r&&(async()=>{if(!(C||T)){Q(!0);try{const{PatientEducationAgent:$}=await ns(async()=>{const{PatientEducationAgent:O}=await import("./chunks/PatientEducationAgent.DoYlcw1n.js");return{PatientEducationAgent:O}},__vite__mapDeps([18,5,6,4,2,1,19]));E({getPriorityOptions:$.getPriorityOptions.bind($),getAvailableModules:$.getAvailableModules.bind($)})}catch($){console.error("Failed to load PatientEducationAgent:",$)}finally{Q(!1)}}})()},[r,C,T]);const D=C?.getPriorityOptions()||[],k=C?.getAvailableModules()||[],R=m.useCallback(K=>{h($=>$.includes(K)?(u(O=>{const W={...O};return delete W[K],W}),$.filter(O=>O!==K)):[...$,K])},[]),w=m.useCallback((K,$)=>{u(O=>{const W=O[K]||[];if(W.includes($)){const ee=W.filter(V=>V!==$);if(ee.length===0){const V={...O};return delete V[K],V}return{...O,[K]:ee}}else return{...O,[K]:[...W,$]}})},[]),L=m.useCallback(async()=>{if(d.length!==0){v(!0);try{const K=await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"extract-patient-data",data:{}}),$=await chrome.runtime.sendMessage({type:"EXTRACT_EMR_DATA",fields:["background","medications","investigations"]}),O={demographics:"",background:$?.background||"",medications:$?.medications||"",investigations:$?.investigations||""},W=K?.success&&K?.data?K.data:null;console.log("üéì Extracted patient data:",W),console.log("üéì Extracted EMR data for Patient Education:",O),I(O);const ee={patientPriority:c,selectedModules:d,selectedSubFocus:Object.keys(f).length>0?f:void 0,emrData:O,patientData:W,patientContext:x.trim()||void 0};await s(ee)}catch(K){console.warn("‚ö†Ô∏è EMR extraction failed, proceeding with user context only:",K);const $={demographics:"",background:"",medications:"",investigations:""},O={patientPriority:c,selectedModules:d,selectedSubFocus:Object.keys(f).length>0?f:void 0,emrData:$,patientData:null,patientContext:x.trim()||void 0};await s(O)}finally{v(!1)}}},[c,d,f,x,s]),M=m.useCallback(async()=>{if(i){v(!0);try{await i()}finally{v(!1)}}},[i]);if(!r)return null;if(T||!C)return t.jsxs("div",{className:"w-full bg-white border border-gray-200 rounded-xl shadow-lg",children:[t.jsx("div",{className:"bg-gradient-to-r from-emerald-600 to-emerald-700 text-white px-4 py-3",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(sA,{className:"w-4 h-4"}),t.jsx("h3",{className:"font-semibold text-sm",children:"Patient Education & Lifestyle Advice"})]}),t.jsx(Zt,{icon:t.jsx(es,{}),onClick:a,variant:"ghost",size:"sm","aria-label":"Close",className:"text-emerald-100 hover:text-white"})]})}),t.jsx("div",{className:"p-8 flex items-center justify-center",children:t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(Au,{className:"w-5 h-5 animate-spin text-emerald-600"}),t.jsx("span",{className:"text-gray-600",children:"Loading education modules..."})]})})]});const P=K=>{const $=d.includes(K.id),O=f[K.id]||[];return t.jsxs("div",{className:"border border-gray-200 rounded-lg",children:[t.jsxs("div",{className:"flex items-start space-x-3 p-3 hover:border-blue-300 transition-colors",children:[t.jsx(Zt,{icon:$?t.jsx(ll,{className:"text-blue-600"}):t.jsx(dc,{className:"text-gray-400"}),onClick:()=>R(K.id),variant:"ghost",size:"sm","aria-label":`Toggle ${K.label}`,disabled:e||N,className:"flex-shrink-0 mt-0.5"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:`font-medium text-sm ${$?"text-blue-900":"text-gray-700"}`,children:K.label}),t.jsxs("div",{className:"group relative inline-block",title:K.tooltip,children:[t.jsx(Ma,{className:"w-4 h-4 text-gray-400 hover:text-blue-600 cursor-help"}),t.jsx("div",{className:"absolute left-0 top-6 w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10",children:K.tooltip})]})]}),t.jsx("p",{className:"text-xs text-gray-600 mt-1",children:K.description})]})]}),$&&K.subFocusPoints&&K.subFocusPoints.length>0&&t.jsxs("div",{className:"border-t border-gray-100 bg-gray-50 p-3 space-y-2",children:[t.jsx("p",{className:"text-xs font-medium text-gray-600 mb-2",children:"Focus on specific areas (optional):"}),K.subFocusPoints.map(W=>{const ee=O.includes(W.id);return t.jsxs("div",{className:"flex items-start space-x-2 ml-2",children:[t.jsx(Zt,{icon:ee?t.jsx(ll,{className:"text-emerald-600"}):t.jsx(dc,{className:"text-gray-400"}),onClick:()=>w(K.id,W.id),variant:"ghost",size:"sm","aria-label":`Toggle ${W.label}`,disabled:e||N,className:"flex-shrink-0 mt-0.5"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("span",{className:`text-xs ${ee?"text-emerald-800 font-medium":"text-gray-600"}`,children:W.label}),t.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:W.description})]})]},W.id)})]})]},K.id)};return t.jsx("div",{className:"w-full bg-white border border-gray-200 rounded-xl shadow-lg",children:t.jsxs("div",{className:"bg-white w-full overflow-hidden rounded-xl",children:[t.jsx("div",{className:"bg-gradient-to-r from-emerald-600 to-emerald-700 text-white px-4 py-3",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(sA,{className:"w-4 h-4"}),t.jsx("h3",{className:"font-semibold text-sm",children:"Patient Education & Lifestyle Advice"})]}),t.jsx(Zt,{icon:t.jsx(es,{}),onClick:a,variant:"ghost",size:"sm","aria-label":"Close",disabled:e||N,className:"text-emerald-100 hover:text-white"})]})}),t.jsxs("div",{className:"p-4 overflow-y-auto max-h-full",children:[n&&t.jsx("div",{className:"mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg",children:t.jsxs("div",{className:"flex items-start space-x-2",children:[t.jsx(or,{className:"w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:"text-sm text-amber-800 font-medium",children:"EMR Extraction Issue"}),t.jsx("p",{className:"text-xs text-amber-700 mt-1",children:n}),i&&t.jsx(ye,{onClick:M,disabled:N,variant:"ghost",size:"sm",startIcon:N?t.jsx(Au,{}):t.jsx(Xa,{}),isLoading:N,className:"mt-2 bg-amber-100 hover:bg-amber-200 text-amber-800",children:N?"Retrying...":"Retry Extraction"})]})]})}),t.jsxs("div",{className:"mb-6",children:[t.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-3",children:"Patient Priority Level"}),t.jsx("div",{className:"space-y-2",children:D.map(K=>t.jsxs("label",{className:"flex items-start space-x-3 cursor-pointer",children:[t.jsx("input",{type:"radio",name:"priority",value:K.value,checked:c===K.value,onChange:$=>A($.target.value),className:"mt-1 text-emerald-600 focus:ring-emerald-500",disabled:e||N}),t.jsxs("div",{children:[t.jsx("span",{className:"text-sm font-medium text-gray-900",children:K.label}),t.jsx("p",{className:"text-xs text-gray-600",children:K.description})]})]},K.value))})]}),t.jsxs("div",{className:"mb-6",children:[t.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-3",children:"Patient Specific Priorities & Goals"}),t.jsx("textarea",{value:x,onChange:K=>b(K.target.value),placeholder:"Enter specific patient priorities and goals (e.g., lose weight, stop smoking, improve fitness, reduce blood pressure, manage diabetes)...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 resize-none text-sm",rows:3,disabled:e||N}),t.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Optional: Describe what's most important for this patient to help personalize the lifestyle advice."})]}),j&&t.jsxs("div",{className:"mb-6",children:[t.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-3",children:"Extracted Patient Information"}),t.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-2",children:[j.background&&t.jsxs("div",{children:[t.jsx("span",{className:"text-xs font-medium text-gray-600",children:"Background:"}),t.jsx("p",{className:"text-xs text-gray-700 mt-1 line-clamp-2",children:j.background})]}),j.medications&&t.jsxs("div",{children:[t.jsx("span",{className:"text-xs font-medium text-gray-600",children:"Medications:"}),t.jsx("p",{className:"text-xs text-gray-700 mt-1 line-clamp-2",children:j.medications})]}),j.investigations&&t.jsxs("div",{children:[t.jsx("span",{className:"text-xs font-medium text-gray-600",children:"Recent Investigations:"}),t.jsx("p",{className:"text-xs text-gray-700 mt-1 line-clamp-2",children:j.investigations})]}),!j.background&&!j.medications&&!j.investigations&&t.jsx("p",{className:"text-xs text-gray-500 italic",children:"No patient data found in EMR fields"})]}),t.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"This information will be used to personalize the lifestyle advice."})]}),t.jsxs("div",{className:"mb-6",children:[t.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-3",children:"Select Lifestyle Areas (Choose at least 1)"}),t.jsx("div",{className:"grid grid-cols-1 gap-3",children:k.map(P)}),d.length===0&&t.jsx("p",{className:"text-xs text-red-600 mt-2",children:"Please select at least one lifestyle area"})]}),t.jsx("div",{className:"mb-6 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:t.jsxs("div",{className:"flex items-start space-x-2",children:[t.jsx(Ma,{className:"w-4 h-4 text-blue-600 flex-shrink-0 mt-0.5"}),t.jsxs("div",{className:"text-xs text-blue-800",children:[t.jsx("p",{className:"font-medium",children:"Education Only"}),t.jsx("p",{className:"mt-1",children:"This tool provides lifestyle education and general wellness advice only. It does not diagnose conditions or recommend medication changes."})]})]})}),t.jsx("div",{className:"flex justify-end border-t border-gray-200 pt-4 mt-6",children:t.jsx(ye,{onClick:L,disabled:e||N||d.length===0,variant:"success",size:"lg",startIcon:t.jsx(sA,{}),isLoading:e||N,className:"px-8 shadow-lg",children:e||N?"Generating Advice...":"Generate Lifestyle Advice"})}),(e||N)&&o&&t.jsx("div",{className:"mt-4",children:t.jsx(np,{progress:o,startTime:l||void 0,agentType:"patient-education",showTimeEstimate:!0})}),(e||N)&&!o&&t.jsxs("div",{className:"mt-4 text-center",children:[t.jsx("div",{className:"text-xs text-gray-600",children:"Generating personalized lifestyle advice..."}),t.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2 mt-2",children:t.jsx("div",{className:"bg-emerald-600 h-2 rounded-full animate-pulse",style:{width:"60%"}})})]})]})]})})},jk={tavi:"TAVI Workup","tavi-workup":"TAVI Workup","angiogram-pci":"Angiogram/PCI Report","quick-letter":"Quick Letter",consultation:"Consultation Report","investigation-summary":"Investigation Summary",background:"Background Summary",medication:"Medication Review",bloods:"Blood Results",imaging:"Imaging Review","patient-education":"Patient Education","batch-ai-review":"Batch AI Review","ai-medical-review":"AI Medical Review","aus-medical-review":"Australian Medical Review",mteer:"MitraClip/TEER",tteer:"TEER","pfo-closure":"PFO Closure","asd-closure":"ASD Closure","pvl-plug":"PVL Plug","bypass-graft":"Bypass Graft","right-heart-cath":"Right Heart Catheterization","pre-op-plan":"Pre-Op Plan","ohif-viewer":"OHIF Viewer",enhancement:"Enhancement",transcription:"Transcription",generation:"Generation"},Ek=(s,e)=>{if(e)return"recording";switch(s){case"transcribing":return"transcribing";case"processing":return"processing";case"complete":return"completed";default:return"processing"}},kk=(s,e)=>{if(e)return{bg:"bg-rose-50",text:"text-rose-700",accent:"text-rose-500"};switch(s){case"transcribing":return{bg:"bg-blue-50",text:"text-blue-700",accent:"text-blue-500"};case"processing":return{bg:"bg-purple-50",text:"text-purple-700",accent:"text-purple-500"};case"complete":return{bg:"bg-slate-50",text:"text-slate-700",accent:"text-slate-500"};default:return{bg:"bg-slate-50",text:"text-slate-700",accent:"text-slate-500"}}},Ov=m.memo(({patientInfo:s,agentType:e,processingStatus:r,isRecording:a=!1,isViewingCompletedSession:n=!1,onOpenQuickLetterAndInsert:i})=>{const o=Ek(r,a),l=kk(r,a),c=jk[e]||e,A=m.useCallback(async()=>{if(!(!n||r!=="complete"))try{await chrome.runtime.sendMessage({type:"NAVIGATE_TO_PATIENT",fileNumber:s.id,patientName:s.name}),console.log("‚úÖ Navigate to patient requested:",s.id)}catch(f){console.error("‚ùå Failed to navigate to patient:",f)}},[n,r,s.id,s.name]);m.useEffect(()=>{if(!n||r!=="complete")return;const f=u=>{const x=u.target;x.tagName==="INPUT"||x.tagName==="TEXTAREA"||x.isContentEditable||u.shiftKey&&!u.ctrlKey&&!u.altKey&&!u.metaKey&&u.key.toLowerCase()==="g"&&(u.preventDefault(),A())};return document.addEventListener("keydown",f),()=>document.removeEventListener("keydown",f)},[n,r,A]);const d=f=>{if(!f)return"";try{const u=new Date(f),x=new Date;let b=x.getFullYear()-u.getFullYear();const N=x.getMonth()-u.getMonth();return(N<0||N===0&&x.getDate()<u.getDate())&&b--,`${b}y`}catch{return""}},h=s.age||d(s.dob);return t.jsx("div",{className:`${l.bg} ${l.text} px-4 py-3 border-b border-slate-200`,children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-3 flex-1 min-w-0",children:[t.jsx(Do,{className:`w-5 h-5 flex-shrink-0 ${l.accent}`}),t.jsxs("div",{className:"flex flex-col min-w-0",children:[t.jsx("div",{className:"font-semibold text-base truncate",children:s.name}),t.jsxs("div",{className:"flex items-center space-x-2 text-sm opacity-75",children:[t.jsxs("span",{className:"truncate",children:["ID: ",s.id]}),s.dob&&t.jsxs(t.Fragment,{children:[t.jsx("span",{children:"‚Ä¢"}),t.jsxs("span",{className:"truncate",children:["DOB: ",s.dob]})]}),h&&t.jsxs(t.Fragment,{children:[t.jsx("span",{children:"‚Ä¢"}),t.jsx("span",{children:h})]})]})]})]}),t.jsxs("div",{className:"flex items-center space-x-3 flex-shrink-0",children:[t.jsxs("div",{className:"hidden sm:flex items-center space-x-2 bg-slate-100 px-3 py-1.5 rounded-full",children:[t.jsx(Rn,{className:"w-4 h-4 text-slate-500"}),t.jsx("span",{className:"text-sm font-medium text-slate-600 whitespace-nowrap",children:c})]}),n&&r==="complete"?t.jsxs("div",{className:"flex items-center gap-2",children:[e==="quick-letter"&&typeof i=="function"&&t.jsx("button",{type:"button",onClick:i,className:`
                    p-2 rounded-full
                    bg-emerald-600 hover:bg-emerald-700
                    text-white
                    shadow-sm hover:shadow-md
                    transition-colors
                  `,title:"Open Quick Letter + Insert","aria-label":"Open Quick Letter + Insert",children:t.jsx(NA,{size:16})}),t.jsx("button",{type:"button",onClick:A,className:`
                  p-2 rounded-full
                  bg-slate-700 hover:bg-slate-800
                  text-white
                  shadow-sm hover:shadow-md
                  transition-colors
                `,title:"Go to patient (‚áßG)","aria-label":"Go to patient",children:t.jsx(Po,{size:16})})]}):t.jsxs("div",{className:"flex items-center space-x-2 bg-slate-100 px-3 py-1.5 rounded-full",children:[(a||r==="transcribing"||r==="processing")&&t.jsx(_C,{state:o,size:"sm",withTooltip:!1}),t.jsx(Gu,{state:o,size:"sm",showIcon:!(a||r==="transcribing"||r==="processing"),label:r==="processing"?"AI Processing":void 0,className:"bg-transparent border-0"})]})]})]})})});Ov.displayName="PatientContextHeader";const Hv=[{id:"tavi",title:"TAVI Procedure Recording",description:"Transcatheter Aortic Valve Implantation - Comprehensive procedural documentation",estimatedTime:"8-12 minutes",sections:[{title:"Preamble Information",icon:"üìã",items:["Patient demographics and clinical indication",'Preoperative CT findings: "suitable anatomy for valve implant"',"Valve morphology: tricuspid/bicuspid, calcification burden","Calcium score and LVOT assessment","Transthoracic echo: mean gradient, systolic function","Valve selection rationale with sizing logic"]},{title:"Procedural Details",icon:"‚öïÔ∏è",items:["Anaesthesia approach: local anaesthesia and deep sedation","Vascular access: radial planning, femoral with ultrasound guidance","Pre-closure technique: ProStyle sutures or equivalent","Sheath sizes: specific French sizes (e.g., 16F Cook sheath)","Valve crossing: AL1, straight wire, invasive gradient, LVEDP","Lunderquist wire placement at left ventricular apex","Pre-dilation: balloon size and technique","Valve deployment: positioning at annular plane","Immediate assessment: aortic regurgitation, coronary patency"]},{title:"Outcomes & Assessment",icon:"‚úÖ",items:["Valve deployment success and positioning","Final aortic regurgitation grade","Post-procedural echo findings","Arteriotomy closure method and success","Overall procedural success statement","Immediate post-procedural valve performance"]}],tips:["Use Australian spelling: anaesthesia, recognised, utilised","Include precise measurements with units (mmHg, cm¬≤, French sizes)","Preserve original stenosis terminology (mild/moderate/severe)","Document valve manufacturer and model specifically"],terminology:["Edwards Sapien 3 Ultra/Medtronic Evolut series","Annular perimeter and area, LVOT calcium burden","Well-seated valve, patent coronaries","Partial recaptures for optimal positioning"]},{id:"angiogram-pci",title:"Angiogram/PCI Recording",description:"Cardiac catheterization and coronary interventions - Diagnostic and interventional procedures",estimatedTime:"8-15 minutes",sections:[{title:"Vessel Assessment",icon:"ü´Ä",items:["Left Main coronary artery findings","LAD: proximal, mid, distal segments and diagonal branches","Circumflex: segments and obtuse marginal branches","RCA: segments including dominance pattern","Coronary dominance (right/left/co-dominant)","Collateral circulation if present"]},{title:"Procedural Information",icon:"üîß",items:["Vascular access site and approach","Catheter selection and sizes","Target lesion characteristics and location","Intervention strategy and rationale","Device specifications: stent type, manufacturer, size","Balloon pre-dilation details","Deployment technique and positioning"]},{title:"Results & Outcomes",icon:"üìä",items:["TIMI flow assessment (pre and post)","Final angiographic result","Residual stenosis percentage","Procedural complications if any","Hemodynamic measurements","Antiplatelet therapy plan"]}],tips:["Preserve stenosis grading as stated by clinician","Use descriptive TIMI flow language","Include specific device details when mentioned","Document both diagnostic and intervention aspects"],terminology:["Drug-eluting stent (DES), bare metal stent (BMS)","TIMI III flow, complete perfusion","Proximal/mid/distal vessel segments","Optimal angiographic result"]},{id:"quick-letter",title:"Quick Letter Recording",description:"Medical correspondence and consultation letters - Professional communication",estimatedTime:"1-3 minutes",sections:[{title:"Patient Presentation",icon:"üë§",items:["Clinical presentation and chief complaint","Relevant history and context","Current symptoms and functional status","Reason for referral or consultation","Timeline of events"]},{title:"Clinical Assessment",icon:"üîç",items:["Investigation findings and interpretation","Clinical examination relevant findings","Diagnostic considerations","Risk stratification if applicable"]},{title:"Management Plan",icon:"üìù",items:["Treatment recommendations","Medication changes or additions","Follow-up arrangements","Specialist referrals if needed","Patient education provided"]}],tips:['Use first-person voice: "I reviewed", "I examined"',"Keep paragraphs flowing and professional","Include specific timeframes and measurements","Use Australian spelling and medical terminology"],terminology:["Clinical assessment, management plan","Follow-up arrangements, specialist review","Patient education, shared decision-making","Routine/semi-urgent/urgent referral"]},{id:"tavi-workup",title:"TAVI Workup Dictation",description:"Single-pass dictation covering the clinical, echocardiographic, and CT sizing inputs for TAVI planning",estimatedTime:"3-5 minutes",sections:[{title:"Patient Basics",icon:"üßç",items:["State the patient name and date of birth clearly","Latest height in centimetres and weight in kilograms","Note any symptomatic change prompting assessment"]},{title:"Risk Profile",icon:"‚öïÔ∏è",items:["Indication for TAVI workup","NYHA functional class (I-IV only)","STS and EuroSCORE II percentages"]},{title:"Echocardiography Highlights",icon:"ü©ª",items:["Echo study date and ejection fraction","Septal thickness and mean pressure gradient","Aortic valve area, dimensionless index, MR grade, RVSP","Key qualitative comments"]},{title:"CT Sizing",icon:"üß†",items:["Annulus area, perimeter, minimum and maximum diameters","Left main and right coronary heights","Sinus of Valsalva diameters for each cusp",'Coplanar acquisition angles (e.g., "LAO 12 cranial 6")',"Access vessel minimal diameters (CIA, EIA, CFA) with laterality"]},{title:"Device Planning",icon:"üõ†Ô∏è",items:["Intended valve platform (Sapien, Evolut, Navitor)","Planned valve size and rationale","Any anatomical cautions (coronary height, annular calcification, access limitations)"]}],tips:['Say "percent" after risk scores to avoid misinterpretation',"Use centimetres when dictating distances so the system can convert to millimetres","Work systematically: patient basics -> risk -> echo -> CT -> access/device"],terminology:["Annulus area/perimeter","Dimensionless index (DVI)","Sinus of Valsalva","Common/external iliac, common femoral","Coplanar LAO/RAO cranial/caudal angles"]},{id:"consultation",title:"Consultation Recording",description:"Comprehensive patient assessments - Detailed clinical evaluation",estimatedTime:"2-4 minutes",sections:[{title:"Clinical History",icon:"üìö",items:["Presenting complaint and history","Past medical history and comorbidities","Current medications and allergies","Family history if relevant","Social history and functional status"]},{title:"Examination & Investigations",icon:"üî¨",items:["Physical examination findings","Vital signs and measurements","Investigation results and interpretation","Imaging findings if applicable","Laboratory results correlation"]},{title:"Assessment & Plan",icon:"üéØ",items:["Clinical impression and differential diagnosis","Risk assessment and stratification","Management strategy and rationale","Investigation plan if needed","Follow-up and monitoring plan"]}],tips:["Capture comprehensive clinical reasoning","Include functional assessment (NYHA class, etc.)","Document shared decision-making process","Note patient understanding and concerns"],terminology:["Clinical impression, differential diagnosis","Risk stratification, management strategy","Functional class, symptom assessment","Patient-centred care, shared decisions"]},{id:"mteer",title:"mTEER Procedure Recording",description:"Mitral transcatheter edge-to-edge repair - Structural heart intervention",estimatedTime:"7-10 minutes",sections:[{title:"Pre-procedural Assessment",icon:"üîç",items:["Mitral regurgitation severity and mechanism","Valve anatomy and morphology","TOE assessment and measurements","Procedural planning and approach","Patient selection criteria"]},{title:"Procedural Technique",icon:"‚öôÔ∏è",items:["Transseptal puncture technique","Device delivery and positioning","Clip deployment and assessment","TOE guidance throughout procedure","Immediate haemodynamic changes"]},{title:"Results & Follow-up",icon:"üìà",items:["Final mitral regurgitation grade","Mitral valve gradient assessment","Procedural success metrics","Complications if any","Post-procedural monitoring plan including TTE next day"]}],tips:["Document TOE guidance detail","Include specific device information","Note immediate haemodynamic improvement","Record precise regurgitation grading"],terminology:["Edge-to-edge repair, MitraClip device","Functional vs degenerative MR","TOE guidance, transseptal puncture","Immediate haemodynamic improvement"]},{id:"pfo-closure",title:"PFO Closure Recording",description:"Patent foramen ovale closure - Structural heart intervention",estimatedTime:"5-8 minutes",sections:[{title:"Pre-procedural Assessment",icon:"üîé",items:["PFO anatomy and tunnel length","Shunt assessment and grading","Device selection rationale","Imaging findings (TOE/ICE)","Clinical indication for closure"]},{title:"Deployment Technique",icon:"üéØ",items:["Device delivery and positioning","Deployment sequence and technique","Position confirmation","Immediate closure assessment","Device stability evaluation"]},{title:"Procedural Outcome",icon:"‚ú®",items:["Successful device deployment","Residual shunt assessment","Device position and stability","Procedural complications if any","Post-procedural monitoring requirements"]}],tips:["Document device sizing rationale","Include immediate closure success","Note any residual shunt","Record device stability assessment"],terminology:["Patent foramen ovale, atrial septal anatomy","Device deployment, positioning confirmation","Residual shunt, complete closure","TOE/ICE guidance, device stability"]},{id:"right-heart-cath",title:"Right Heart Catheterisation",description:"Right heart catheterisation with haemodynamic assessment",estimatedTime:"6-10 minutes",sections:[{title:"Patient Data (REQUIRED for calculations)",icon:"üë§",items:["Height (cm) and Weight (kg)","Heart rate (bpm) and rhythm","Systemic blood pressure (mmHg)","Haemoglobin (g/L) and Lactate (mmol/L)","Arterial oxygen saturation (%)"]},{title:"Haemodynamic Pressures",icon:"üìä",items:["Right atrial pressure (a/v/mean mmHg)","Right ventricular pressures (systolic/diastolic mmHg)","RVEDP (mmHg)","Pulmonary artery (systolic/diastolic/mean mmHg)","PCWP (a/v/mean mmHg)","Cardiac output (L/min) & index (L/min/m¬≤)","Mixed venous O‚ÇÇ saturation (%)"]},{title:"Technical Details",icon:"üîß",items:["Vascular access approach (basilic/jugular/femoral)","Catheter type and size (e.g., 7F Swan-Ganz)","Fluoroscopy time (minutes)","Fluoroscopy dose (mGy)","DAP (dose area product, Gy¬∑cm¬≤)","Contrast volume (mL) if used","Thermodilution or Fick method","Complications if any"]},{title:"Clinical Interpretation",icon:"üìã",items:["Haemodynamic interpretation","Pulmonary hypertension assessment","Heart failure classification","Treatment implications","Follow-up recommendations"]}],tips:["MUST dictate: Height, Weight, HR, BP for auto-calculations","TPG, DPG, PVR are AUTO-CALCULATED - no need to dictate","Include precise pressure measurements with units","Dictate fluoroscopy dose/time/DAP for radiation safety","Note contrast volume for nephrotoxicity assessment","Correlate with clinical presentation"],terminology:["Pulmonary vascular resistance, cardiac index","Thermodilution, Fick equation","Pulmonary hypertension, right heart failure","Haemodynamic profile, pressure gradients","BSA, TPG, DPG, PVR (auto-calculated from raw values)"]},{id:"investigation-summary",title:"Investigation Summary Recording",description:"Formatting voice-dictated investigation results into structured summaries",estimatedTime:"30-60 seconds",sections:[{title:"Test Information",icon:"üî¨",items:["Investigation type (TTE, CTCA, Bloods, etc.)","Date of investigation (DD MMM YYYY format)","Location/institution if relevant","Test methodology or approach if specified"]},{title:"Key Findings",icon:"üìã",items:["Primary findings and measurements","Normal and abnormal values with units","Qualitative descriptions (mild/moderate/severe)","Relevant anatomical observations","Clinical significance if stated"]},{title:"Measurements & Values",icon:"üìè",items:["Exact numerical values with units","Reference ranges when mentioned","Percentage values (e.g., EF 55%)","Pressure measurements (mmHg)","Laboratory values with proper abbreviations"]}],tips:["Use standard medical abbreviations (TChol, LDL, HDL, etc.)","Include units with all measurements","Preserve qualitative terms exactly as stated","Format as: TEST (date): comma-separated findings"],terminology:["TTE, TOE, CTCA, CMRI, RHC, Bloods","TChol, TG, HDL, LDL, HbA1c, Cr, eGFR","EF%, MPG, PPG, RVSP, TIMI flow","Normal, mild, moderate, severe"]},{id:"background",title:"Background & History Recording",description:"Patient medical background, history, and contextual information",estimatedTime:"1-2 minutes",sections:[{title:"Medical History",icon:"üè•",items:["Past medical conditions and diagnoses","Previous cardiovascular events or procedures","Chronic conditions and comorbidities","Surgical history relevant to current care","Hospital admissions and major events"]},{title:"Family & Social History",icon:"üë•",items:["Family history of cardiovascular disease","Hereditary conditions or risk factors","Social circumstances affecting care","Functional status and mobility","Support systems and care arrangements"]},{title:"Risk Factors",icon:"‚ö†Ô∏è",items:["Smoking history (current/former/never)","Alcohol consumption patterns","Exercise tolerance and activity levels","Occupational or environmental exposures","Lifestyle factors affecting health"]}],tips:["Use chronological order for medical events","Include dates and timeframes when mentioned","Note functional impact of conditions","Use arrow notation (‚Üí) for progression or outcomes"],terminology:["CAD, MI, CABG, PCI, valve disease","DM, HTN, dyslipidaemia, CKD","NYHA class, functional capacity","Family Hx, social circumstances"]},{id:"medication",title:"Medication Recording",description:"Current medications, changes, and pharmaceutical management",estimatedTime:"1-2 minutes",sections:[{title:"Current Medications",icon:"üíä",items:["Drug name (generic preferred)","Dosage and strength","Frequency and timing","Route of administration","Duration of therapy if specified"]},{title:"Recent Changes",icon:"üîÑ",items:["New medications started","Dose adjustments made","Medications discontinued","Reason for changes","Timing of modifications"]},{title:"Compliance & Effects",icon:"‚úÖ",items:["Adherence to current regimen","Side effects experienced","Therapeutic response noted","Patient understanding and concerns","Monitoring requirements"]}],tips:["Use generic drug names when possible","Include exact dosages with units (mg, mcg)","Note timing (morning, evening, with meals)","Document reasons for any changes"],terminology:["ACE inhibitor, ARB, beta-blocker, statin","BD, TDS, QID, PRN, with meals","mg, mcg, g, units, mL","Commenced, ceased, increased, decreased"]},{id:"pre-op-plan",title:"Pre-Op Plan Recording",description:"Pre-procedure planning card for cath lab staff - Select procedure type first",estimatedTime:"1-3 minutes",sections:[{title:"ANGIOGRAM/PCI Checklist",icon:"ü©∫",items:['‚úÖ Procedure type & indication (e.g., "Angiogram for NSTEMI")',"‚úÖ Primary access site (radial/femoral)","‚úÖ Sheath size (Fr)","‚úÖ Catheters planned (e.g., JL3.5, JR4)","‚úÖ Allergies/precautions (iodine, latex)","‚úÖ Antiplatelet plan (continue/hold)","‚≠ï Sedation level (light/moderate)","‚≠ï Site prep (which sites + antiseptic)","‚≠ï Recent labs (Hb, creatinine)","‚≠ï Planned follow-up (timing, location)","‚úÖ Next-of-kin (name, relationship, phone)"]},{title:"RIGHT HEART CATH Checklist",icon:"ü©∫",items:["‚úÖ Procedure type & indication","‚úÖ Access site (basilic/jugular/femoral)","‚úÖ Sheath size (Fr)","‚úÖ Catheters planned (Swan-Ganz, etc.)","‚úÖ CO measurement (Yes/No, method)","‚úÖ Blood gas samples (count)","‚≠ï Sedation plan","‚≠ï Anticoagulation plan","‚≠ï Site prep details","‚≠ï Recent labs","‚≠ï Planned follow-up (timing, location)","‚úÖ Next-of-kin (name, relationship, phone)"]},{title:"TAVI Checklist",icon:"ü´Ä",items:["‚úÖ Indication (e.g., severe AS)","‚úÖ Primary access (femoral/other)","‚úÖ Secondary access","‚úÖ Valve type & size (Sapien/Evolut, mm)","‚úÖ Wire (Safari/Confida/Lunderquist)","‚úÖ Balloon size (mm, if planned)","‚úÖ Pacing wire access","‚úÖ Closure device plan (ProStyle/Angio-Seal)","‚úÖ Protamine plan (yes/no, contraindications)","‚úÖ Goals of care (theatre status, gradient)","‚≠ï Sedation plan","‚≠ï Site prep (both femorals + antiseptic)","‚≠ï Allergies","‚≠ï Recent labs","‚≠ï Planned follow-up (timing, location)","‚úÖ Next-of-kin"]},{title:"MITRAL TEER Checklist",icon:"ü´Ä",items:["‚úÖ Indication (MR severity)","‚úÖ Access site (femoral venous)","‚úÖ Transeptal catheter(s)","‚úÖ Wire (super-stiff for guide)","‚úÖ Closure device plan (usually 2√ó ProStyle)","‚úÖ Echo findings (key summary)","‚≠ï Device type (NTW/XT)","‚≠ï Sedation plan","‚≠ï Anticoagulation plan","‚≠ï Site prep","‚≠ï Allergies","‚≠ï Recent labs","‚≠ï Planned follow-up (timing, location)","‚úÖ Next-of-kin"]}],tips:["Start by stating the procedure type clearly","‚úÖ = REQUIRED field (must include)","‚≠ï = OPTIONAL field (include if mentioned)",'Keep Next-of-Kin format: "Name (relationship) phone"',"For TAVI: Always include Protamine plan and goals","For Angio/RHC: DO NOT mention Protamine or pacing wires"],terminology:["Access: radial, femoral, basilic, jugular","Antiseptics: chlorhexidine, betadine","TAVI valves: Sapien 3 Ultra, Evolut R/Pro, Navitor","Wires: Safari, Confida, Lunderquist","Closure: ProStyle, Angio-Seal, Perclose","Sedation: light, moderate, GA","Labs: Hb g/L, Creatinine ¬µmol/L"]}];function Ik(s){return Hv.find(e=>e.id===s)}function Tk(s){return Hv.some(e=>e.id===s)}const Fk=bs.memo(({agentType:s,isVisible:e,onClose:r,onStartRecording:a,compactMode:n=!1})=>{const[i,o]=m.useState({}),l=Ik(s);Math.random()<.001&&console.log("üìã Recording prompt shown for:",s);const c=m.useCallback(d=>{o(h=>({...h,[d]:!h[d]}))},[]);if(m.useCallback(()=>{a?.(),r?.()},[a,r]),!e||!l)return null;const A=(d,h)=>{const f=i[d.title]??(n?!1:h===0);return t.jsxs("div",{className:`border border-gray-200 rounded-xl overflow-hidden ${n?"mb-2":"mb-3"}`,children:[t.jsxs(ye,{onClick:()=>c(d.title),variant:"ghost",size:n?"sm":"md",className:`!w-full !justify-between bg-gray-50 hover:bg-gray-100 rounded-none ${n?"px-3 py-2":"px-4 py-3"}`,children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:n?"text-sm":"text-lg",children:d.icon}),t.jsx("span",{className:`font-semibold text-gray-800 ${n?"text-xs":"text-sm"}`,children:d.title})]}),f?t.jsx(ps,{className:`text-gray-500 ${n?"w-3 h-3":"w-4 h-4"}`}):t.jsx(ti,{className:`text-gray-500 ${n?"w-3 h-3":"w-4 h-4"}`})]}),f&&t.jsx("div",{className:`bg-white ${n?"px-3 py-2":"px-4 py-3"}`,children:t.jsx("ul",{className:n?"space-y-1":"space-y-2",children:d.items.map((u,x)=>t.jsxs("li",{className:`flex items-start space-x-2 text-gray-700 ${n?"text-xs":"text-sm"}`,children:[t.jsx("div",{className:`bg-blue-500 rounded-full mt-2 flex-shrink-0 ${n?"w-1 h-1":"w-1.5 h-1.5"}`}),t.jsx("span",{children:u})]},x))})})]},d.title)};return t.jsx("div",{className:`w-full bg-white border border-gray-200 ${n?"rounded-lg shadow-sm":"max-w-none mx-2 rounded-lg shadow-sm mb-4"}`,children:t.jsxs("div",{className:`bg-white w-full overflow-hidden ${n?"rounded-lg max-h-[40vh]":"rounded-lg max-h-[70vh]"}`,children:[t.jsx("div",{className:`bg-rose-500 text-white ${n?"px-3 py-2":"px-3 py-2.5"}`,children:t.jsxs("div",{className:"flex items-center space-x-2",children:[!n&&t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("div",{className:"w-2 h-2 bg-white/60 rounded-full animate-pulse"}),t.jsx("span",{className:"text-xs font-medium uppercase tracking-wide",children:"Recording"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(dA,{className:n?"w-3 h-3":"w-3.5 h-3.5"}),t.jsx("span",{className:`font-medium ${n?"text-xs":"text-sm"}`,children:l.title.replace(" Recording","")})]})]})}),t.jsxs("div",{className:`overflow-y-auto ${n?"p-3 max-h-[35vh]":"p-4 max-h-[60vh]"}`,children:[!n&&t.jsx("div",{className:"mb-4 p-3 bg-red-50 rounded-lg border border-red-200",children:t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx(wy,{className:"w-4 h-4 text-red-600 mt-0.5 flex-shrink-0"}),t.jsx("div",{children:t.jsx("p",{className:"text-red-700 text-sm font-medium",children:"Include these key elements while recording to ensure a comprehensive medical report:"})})]})}),t.jsxs("div",{className:n?"mb-3":"mb-6",children:[!n&&t.jsxs("h3",{className:"font-semibold text-gray-800 mb-4 flex items-center space-x-2",children:[t.jsx(dA,{className:"w-4 h-4"}),t.jsx("span",{children:"What to Include"})]}),l.sections.map(A)]}),l.tips.length>0&&t.jsxs("div",{className:n?"mb-3":"mb-6",children:[t.jsxs("h3",{className:`font-semibold text-gray-800 ${n?"mb-2 text-sm":"mb-3"}`,children:["üí° ",n?"Tips":"Recording Tips"]}),t.jsx("div",{className:`bg-yellow-50 border border-yellow-200 rounded-lg ${n?"p-2":"p-4"}`,children:t.jsx("ul",{className:n?"space-y-1":"space-y-2",children:l.tips.map((d,h)=>t.jsxs("li",{className:`flex items-start space-x-2 text-yellow-800 ${n?"text-xs":"text-sm"}`,children:[t.jsx("div",{className:`bg-yellow-500 rounded-full mt-2 flex-shrink-0 ${n?"w-1 h-1":"w-1.5 h-1.5"}`}),t.jsx("span",{children:d})]},h))})})]}),l.terminology.length>0&&t.jsxs("div",{className:n?"mb-2":"mb-6",children:[t.jsxs("h3",{className:`font-semibold text-gray-800 ${n?"mb-2 text-sm":"mb-3"}`,children:["üìö ",n?"Terms":"Key Terminology"]}),t.jsx("div",{className:`bg-green-50 border border-green-200 rounded-lg ${n?"p-2":"p-4"}`,children:t.jsx("div",{className:`grid gap-2 ${n?"grid-cols-1":"grid-cols-1 md:grid-cols-2"}`,children:l.terminology.map((d,h)=>t.jsxs("div",{className:`flex items-center space-x-2 text-green-800 ${n?"text-xs":"text-sm"}`,children:[t.jsx("div",{className:`bg-green-500 rounded-full flex-shrink-0 ${n?"w-1 h-1":"w-1.5 h-1.5"}`}),t.jsx("span",{className:"font-medium",children:d})]},h))})})]})]})]})})}),Pk=({isOpen:s,onClose:e})=>{const[r,a]=m.useState(null),[n,i]=m.useState([]),[o,l]=m.useState(!0);m.useEffect(()=>{s&&c()},[s]);const c=async()=>{l(!0);try{const x=rA.getInstance(),[b,N]=await Promise.all([x.getAnalytics(),x.getAllMetrics()]);a(b),i(N.slice(0,10))}catch(x){console.error("Failed to load metrics:",x)}finally{l(!1)}},A=async()=>{confirm("Are you sure you want to clear all performance metrics? This cannot be undone.")&&(await rA.getInstance().clearAllMetrics(),await c())},d=async()=>{try{const b=await rA.getInstance().exportMetrics(),N=new Blob([b],{type:"application/json"}),v=URL.createObjectURL(N),j=document.createElement("a");j.href=v,j.download=`xestro-metrics-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(j),j.click(),document.body.removeChild(j),URL.revokeObjectURL(v)}catch(x){console.error("Failed to export metrics:",x)}},h=x=>{if(x<1e3)return`${x}ms`;if(x<6e4)return`${(x/1e3).toFixed(1)}s`;const b=Math.floor(x/6e4),N=Math.floor(x%6e4/1e3);return`${b}m ${N}s`},f=x=>({tavi:"‚ù§Ô∏è","angiogram-pci":"ü´Ä",mteer:"üîß",tteer:"ü´Ä","pfo-closure":"üè•","asd-closure":"üè•","pvl-plug":"üîå","bypass-graft":"üõ§Ô∏è","right-heart-cath":"üìä","tavi-workup":"üîç","quick-letter":"üìù",consultation:"üë®‚Äç‚öïÔ∏è","investigation-summary":"üîç","ai-medical-review":"üõ°Ô∏è","batch-ai-review":"üìã","patient-education":"üéì","pre-op-plan":"üìã",background:"üìã",medication:"üíä",bloods:"ü©∏",imaging:"üì∑","ohif-viewer":"ü©ª","aus-medical-review":"üá¶üá∫",enhancement:"‚ú®",transcription:"üé§",generation:"ü§ñ"})[x]||"ü§ñ",u=x=>x>0?"text-green-600":x<0?"text-red-600":"text-gray-600";return s?t.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",children:t.jsxs("div",{className:"bg-white rounded-modal shadow-modal max-w-6xl max-h-[90vh] overflow-hidden w-full",children:[t.jsx("div",{className:"p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-purple-50",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(mc,{className:"w-6 h-6 text-blue-600"}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Performance Analytics"}),t.jsx("p",{className:"text-gray-600 text-sm",children:"Historical recording metrics and trends"})]})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Zt,{onClick:d,icon:Ya,variant:"ghost",size:"sm","aria-label":"Export Metrics",className:"text-gray-600"}),t.jsx(Zt,{onClick:c,icon:Xa,variant:"ghost",size:"sm","aria-label":"Refresh",className:"text-gray-600"}),t.jsx(Zt,{onClick:A,icon:Ln,variant:"ghost",size:"sm","aria-label":"Clear All Metrics",className:"text-red-600 hover:bg-red-50"}),t.jsx(Zt,{onClick:e,icon:es,variant:"ghost",size:"sm","aria-label":"Close",className:"text-gray-600"})]})]})}),t.jsx("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-120px)]",children:o?t.jsx("div",{className:"flex items-center justify-center py-12",children:t.jsx("div",{className:"w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"})}):r&&r.totalRecordings>0?t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[t.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[t.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[t.jsx(Ty,{className:"w-4 h-4 text-blue-600"}),t.jsx("span",{className:"text-sm font-medium text-blue-800",children:"Total Recordings"})]}),t.jsx("div",{className:"text-2xl font-bold text-blue-900",children:r.totalRecordings})]}),t.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[t.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[t.jsx(qi,{className:"w-4 h-4 text-green-600"}),t.jsx("span",{className:"text-sm font-medium text-green-800",children:"Avg Transcription"})]}),t.jsx("div",{className:"text-2xl font-bold text-green-900",children:h(r.averageTranscriptionTime)})]}),t.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[t.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[t.jsx(ol,{className:"w-4 h-4 text-purple-600"}),t.jsx("span",{className:"text-sm font-medium text-purple-800",children:"Avg Processing"})]}),t.jsx("div",{className:"text-2xl font-bold text-purple-900",children:h(r.averageProcessingTime)})]}),t.jsxs("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-4",children:[t.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[t.jsx(_a,{className:"w-4 h-4 text-orange-600"}),t.jsx("span",{className:"text-sm font-medium text-orange-800",children:"Avg Total"})]}),t.jsx("div",{className:"text-2xl font-bold text-orange-900",children:h(r.averageTotalDuration)})]})]}),r.recentTrend.last25Avg>0&&t.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[t.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[r.recentTrend.improvementPercent>0?t.jsx(uc,{className:"w-4 h-4 text-green-600"}):r.recentTrend.improvementPercent<0?t.jsx(y2,{className:"w-4 h-4 text-red-600"}):t.jsx(qi,{className:"w-4 h-4 text-gray-600"}),t.jsx("span",{className:"text-sm font-medium text-gray-800",children:"Performance Trend"})]}),t.jsxs("div",{className:"grid grid-cols-3 gap-4 text-sm",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-gray-600",children:"Last 10 Average"}),t.jsx("div",{className:"font-semibold",children:h(r.recentTrend.last10Avg)})]}),t.jsxs("div",{children:[t.jsx("div",{className:"text-gray-600",children:"Last 25 Average"}),t.jsx("div",{className:"font-semibold",children:h(r.recentTrend.last25Avg)})]}),t.jsxs("div",{children:[t.jsx("div",{className:"text-gray-600",children:"Improvement"}),t.jsxs("div",{className:`font-semibold ${u(r.recentTrend.improvementPercent)}`,children:[r.recentTrend.improvementPercent>0?"+":"",r.recentTrend.improvementPercent,"%"]})]})]})]}),Object.keys(r.agentTypeBreakdown).length>0&&t.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Agent Performance Breakdown"}),t.jsx("div",{className:"space-y-3",children:Object.entries(r.agentTypeBreakdown).map(([x,b])=>t.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx("span",{className:"text-xl",children:f(x)}),t.jsxs("div",{children:[t.jsx("div",{className:"font-medium text-gray-900 capitalize",children:x.replace("-"," ")}),t.jsxs("div",{className:"text-sm text-gray-600",children:[b.count," recordings"]})]})]}),t.jsxs("div",{className:"text-right text-sm",children:[t.jsx("div",{className:"font-medium",children:h(b.avgTotal)}),t.jsxs("div",{className:"text-gray-600",children:[h(b.avgTranscription)," + ",h(b.avgProcessing)]})]})]},x))})]}),n.length>0&&t.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Recent Recordings"}),t.jsx("div",{className:"space-y-2",children:n.map((x,b)=>t.jsxs("div",{className:"flex items-center justify-between p-2 hover:bg-gray-50 rounded-lg",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx("span",{className:"text-sm",children:f(x.agentType)}),t.jsxs("div",{children:[t.jsx("div",{className:"text-sm font-medium text-gray-900 capitalize",children:x.agentType.replace("-"," ")}),t.jsx("div",{className:"text-xs text-gray-500",children:new Date(x.timestamp).toLocaleString()})]})]}),t.jsxs("div",{className:"text-right text-sm",children:[t.jsx("div",{className:"font-medium",children:h(x.totalDuration)}),t.jsxs("div",{className:"text-xs text-gray-500",children:[h(x.transcriptionTime)," + ",h(x.processingTime)]})]})]},x.sessionId))})]}),Object.keys(r.modelPerformance).length>0&&t.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Model Performance"}),t.jsx("div",{className:"space-y-2",children:Object.entries(r.modelPerformance).map(([x,b])=>t.jsxs("div",{className:"flex items-center justify-between p-2 hover:bg-gray-50 rounded-lg",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(tl,{className:"w-4 h-4 text-purple-600"}),t.jsx("span",{className:"text-sm font-medium text-gray-900",children:x})]}),t.jsxs("div",{className:"text-right text-sm",children:[t.jsx("div",{className:"font-medium",children:h(b.avgTime)}),t.jsxs("div",{className:"text-xs text-gray-500",children:[b.count," recordings"]})]})]},x))})]})]}):t.jsxs("div",{className:"text-center py-12",children:[t.jsx(mc,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Metrics Available"}),t.jsx("p",{className:"text-gray-600",children:"Start recording to see performance analytics appear here."})]})})]})}):null},mo={accentPrimary:"var(--fluent-text-secondary, #64748b)",accentSecondary:"var(--fluent-border-subtle, #94a3b8)",accentGlow:"var(--fluent-glow-slate, rgba(100, 116, 139, 0.3))"},Ym={idle:{dot:"bg-slate-300",text:"text-slate-600"},initializing:{dot:"bg-sky-400",text:"text-sky-600"},active:{dot:"bg-cyan-500",text:"text-cyan-600"},low:{dot:"bg-amber-400",text:"text-amber-600"},silent:{dot:"bg-rose-500",text:"text-rose-600"}},Uk=s=>s in Ym?Ym[s]:Ym.idle,Lk=["Check mute switch","Confirm connection","Raise your voice slightly","Try another microphone"],m0=s=>{const e=s.replace("#","");if(e.length!==6)return null;const r=parseInt(e,16);return{r:r>>16&255,g:r>>8&255,b:r&255}},Dk=(s,e,r)=>{const a=m0(s),n=m0(e);if(!a||!n)return s;const i=Math.min(Math.max(r,0),1),o=Math.round(a.r+(n.r-a.r)*i),l=Math.round(a.g+(n.g-a.g)*i),c=Math.round(a.b+(n.b-a.b)*i);return`rgb(${o}, ${l}, ${c})`},Vv=({isRecording:s,voiceActivityLevel:e,frequencyData:r,audioLevelHistory:a,recordingTime:n,activeDeviceInfo:i,onStop:o,className:l=""})=>{const c=bs.useId(),[A,d]=bs.useState({status:"idle",color:"gray",message:"Not recording"}),[h,f]=bs.useState(!1),u=bs.useRef(),x=bs.useRef([]),b=bs.useRef([]);bs.useEffect(()=>{s&&!i?.isWorking&&Math.random()<.01&&console.warn("‚ö†Ô∏è Audio device may not be working properly")},[s,i]);const N=a.slice(-10).some(k=>k>.05),v=bs.useCallback(()=>s?a.length<5?{status:"initializing",color:"blue",message:"Initializing..."}:N?{status:"active",color:"green",message:"Audio detected"}:e>.01?{status:"low",color:"yellow",message:"Low audio"}:{status:"silent",color:"red",message:"No audio detected"}:{status:"idle",color:"gray",message:"Not recording"},[a.length,N,s,e]);bs.useEffect(()=>{const k=v();if(u.current&&clearTimeout(u.current),k.status==="active"||k.status==="initializing"){d(k),f(!1);return}return k.status==="silent"||k.status==="low"?u.current=setTimeout(()=>{d(k),k.status==="silent"&&a.length>50&&f(!0)},2500):(d(k),f(!1)),()=>{u.current&&clearTimeout(u.current)}},[v,a.length]);const j=A,I=bs.useMemo(()=>Uk(j.status),[j.status]),C=k=>{const R=Math.floor(k/60),w=k%60;return`${R}:${w.toString().padStart(2,"0")}`},E=k=>{x.current.length!==k.length&&(x.current=new Array(k.length).fill(0),b.current=new Array(k.length).fill(0));const R=k.map((P,K)=>P*.75+x.current[K]*.25),w=[.06,.09,.12,.15,.12,.09,.06],L=Math.floor(w.length/2),M=[];for(let P=0;P<R.length;P++){let K=0,$=0;for(let O=-L;O<=L;O++){const W=P+O;if(W>=0&&W<R.length){const ee=w[O+L];K+=R[W]*ee,$+=ee}}M.push(K/$)}return x.current=M,{smoothed:M,peaks:[]}},T=(k,R)=>{if(k.length===0)return[];if(k.length>=R)return k;const w=[],L=(k.length-1)/(R-1);for(let M=0;M<R;M++){const P=M*L,K=Math.floor(P),$=P-K;if(K>=k.length-1)w.push(k[k.length-1]);else{const O=k[Math.max(0,K-1)],W=k[K],ee=k[K+1],V=k[Math.min(k.length-1,K+2)],q=$,S=q*q,H=S*q,Y=.5*(2*W+(-O+ee)*q+(2*O-5*W+4*ee-V)*S+(-O+3*W-3*ee+V)*H);w.push(Math.max(0,Math.min(1,Y)))}}return w},D=(k=>{if(k.length===0)return[];const{smoothed:R}=E(k),w=T(R,150);return[...[...w].reverse(),...w]})(r);return t.jsxs(Ye.div,{className:`relative flex-1 w-full max-w-xl overflow-hidden rounded-card border border-gray-200 bg-white p-6 shadow-card ${l}`,variants:Na(Ci),initial:"hidden",animate:"visible",children:[t.jsxs(Ye.div,{className:"relative flex flex-col items-center gap-6 text-center",initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.2,type:"spring",damping:20,stiffness:300},children:[t.jsx(Ye.h3,{className:"text-lg font-semibold tracking-tight text-slate-900",animate:{color:s?mo.accentPrimary:"#0f172a"},transition:{duration:.4},children:s?"Recording in progress":"Ready to record"}),t.jsxs(Ye.div,{layout:!0,className:"flex flex-wrap items-center justify-center gap-2",children:[t.jsxs(Ye.div,{layout:!0,className:"flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-4 py-2 text-xs font-medium text-slate-600 shadow-[0_18px_35px_-24px_rgba(15,23,42,0.4)]",animate:{borderColor:j.status==="active"?"rgba(14,165,233,0.45)":"rgba(226,232,240,1)",backgroundColor:j.status==="active"?"rgba(224,242,254,0.95)":"rgba(248,250,252,0.95)"},transition:{duration:.45,ease:[.25,.1,.25,1]},children:[t.jsx(Ye.span,{className:`h-2.5 w-2.5 rounded-full shadow-[0_0_0px_rgba(148,163,184,0.35)] ${I.dot}`,animate:{scale:j.status==="active"?[1,1.35,1]:1,boxShadow:j.status==="active"?`0 0 14px ${mo.accentGlow}`:"0 0 6px rgba(148,163,184,0.25)"},transition:{duration:1.8,repeat:j.status==="active"?1/0:0,ease:"easeInOut"}}),t.jsx(Ye.span,{className:`text-sm font-medium ${I.text}`,animate:{opacity:1},children:j.message})]}),t.jsx(as,{initial:!1,children:i&&t.jsxs(Ye.div,{layout:!0,initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.85},transition:{type:"spring",damping:20,stiffness:320},className:"flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs text-slate-600 shadow-[0_12px_30px_-24px_rgba(15,23,42,0.35)]",children:[t.jsx("div",{className:"icon-compact",children:i.isWorking?t.jsx($r,{className:"h-3.5 w-3.5 text-slate-500"}):t.jsx(_g,{className:"h-3.5 w-3.5 text-rose-500"})}),t.jsx("span",{className:"max-w-[200px] truncate",children:i.label})]},"device-chip")}),t.jsx(as,{initial:!1,children:s&&t.jsxs(Ye.div,{layout:!0,className:"flex items-center gap-2 rounded-full border border-slate-200 bg-slate-50 px-4 py-2 font-mono text-sm font-semibold text-slate-800 shadow-[0_22px_45px_-28px_rgba(14,165,233,0.45)]",initial:{opacity:0,scale:.82,y:12},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.85,y:-12},transition:{type:"spring",damping:20,stiffness:300},children:[t.jsx("span",{className:"h-1.5 w-1.5 animate-pulse rounded-full bg-rose-400"}),C(n)]},"recording-timer")})]})]}),t.jsx(as,{children:s&&t.jsxs(Ye.div,{className:"relative mt-8 w-full",initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},transition:{type:"spring",damping:22,stiffness:320,delay:.12},children:[t.jsx(Ye.div,{className:"mb-5 text-center text-xs uppercase tracking-[0.35em] text-slate-400",initial:{opacity:0},animate:{opacity:1},transition:{delay:.35,duration:.4},children:"Live Spectrum"}),t.jsx("div",{className:"relative flex h-36 items-center justify-center overflow-hidden rounded-lg border border-gray-200 bg-gray-50 px-4",children:D.length>0?t.jsxs("svg",{width:"100%",height:"100%",viewBox:"0 0 600 160",preserveAspectRatio:"none",className:"relative z-[1] h-full w-full",children:[t.jsxs("defs",{children:[t.jsxs("linearGradient",{id:`${c}-stroke`,x1:"0%",x2:"100%",y1:"0%",y2:"0%",children:[t.jsx("stop",{offset:"0%",stopColor:mo.accentSecondary}),t.jsx("stop",{offset:"100%",stopColor:mo.accentPrimary})]}),t.jsxs("linearGradient",{id:`${c}-fill`,x1:"0",x2:"0",y1:"0",y2:"1",children:[t.jsx("stop",{offset:"0%",stopColor:mo.accentPrimary,stopOpacity:"0.45"}),t.jsx("stop",{offset:"100%",stopColor:mo.accentSecondary,stopOpacity:"0"})]})]}),(()=>{const R=D.reduce((ee,V)=>ee+V,0)/D.length>.05,w=D.map((ee,V)=>{if(!R)return 0;const q=V/(D.length-1),S=Math.sin(q*Math.PI),H=ee*120*S;return Math.max(3,Math.min(100,H))}),L=w.reduce((ee,V)=>ee+V,0)/w.length,M=Dk(mo.accentSecondary,mo.accentPrimary,Math.min(1,L/70)),P=Math.min(1,L/80),K=.18+P*.22,$=(ee,V)=>{if(!ee||ee.length===0)return"M 0,80 L 600,80";const S=600/Math.max(1,ee.length-1),H=ee.map((X,le)=>({x:le*S,y:V?80+X/2*.8:80-X/2*.8}));if(H.length<2)return"M 0,80 L 600,80";const Y=isFinite(H[0].x)?H[0].x:0,te=isFinite(H[0].y)?H[0].y:80;let G=`M ${Y},${te}`;for(let X=0;X<H.length-1;X++){const le=H[Math.max(0,X-1)],he=H[X],ve=H[X+1],ke=H[Math.min(H.length-1,X+2)],Le=isFinite(he.x+(ve.x-le.x)/6)?he.x+(ve.x-le.x)/6:he.x,Be=isFinite(he.y+(ve.y-le.y)/6)?he.y+(ve.y-le.y)/6:he.y,Re=isFinite(ve.x-(ke.x-he.x)/6)?ve.x-(ke.x-he.x)/6:ve.x,re=isFinite(ve.y-(ke.y-he.y)/6)?ve.y-(ke.y-he.y)/6:ve.y;G+=` C ${Le},${Be} ${Re},${re} ${ve.x},${ve.y}`}return G},O=$(w,!1),W=$(w,!0);return t.jsxs(t.Fragment,{children:[t.jsx(Ye.path,{d:O,fill:"none",stroke:M,strokeWidth:"2.4",strokeLinecap:"round",strokeLinejoin:"round",animate:{d:O},transition:{duration:.35,ease:"easeOut"},style:{filter:`drop-shadow(0 0 ${20*P+6}px rgba(34, 211, 238, ${.45+P*.25}))`}}),t.jsx(Ye.path,{d:W,fill:"none",stroke:M,strokeWidth:"2.4",strokeLinecap:"round",strokeLinejoin:"round",animate:{d:W},transition:{duration:.35,ease:"easeOut"},style:{filter:`drop-shadow(0 0 ${16*P+4}px rgba(168, 85, 247, ${.4+P*.2}))`}}),t.jsx(Ye.path,{d:`${O} L 600,80 L 0,80 Z`,fill:`url(#${c}-fill)`,fillOpacity:K,animate:{d:`${O} L 600,80 L 0,80 Z`},transition:{duration:.35,ease:"easeOut"}}),t.jsx(Ye.path,{d:`${W} L 600,80 L 0,80 Z`,fill:`url(#${c}-fill)`,fillOpacity:K,animate:{d:`${W} L 600,80 L 0,80 Z`},transition:{duration:.35,ease:"easeOut"}})]})})()]}):t.jsxs("div",{className:"relative z-[1] flex flex-col items-center gap-4 text-slate-500",children:[t.jsxs("div",{className:"relative flex h-16 w-16 items-center justify-center",children:[t.jsx("div",{className:"absolute inset-0 rounded-full bg-cyan-400/15 blur-xl"}),t.jsx(Ye.div,{className:"absolute inset-0 rounded-full border border-cyan-300/30",animate:{scale:[1,1.18,1],opacity:[.55,.1,.55]},transition:{duration:2.4,repeat:1/0,ease:"easeInOut"}}),t.jsx(Ye.div,{className:"absolute inset-0 rounded-full border border-cyan-200/25",animate:{scale:[1,1.35,1],opacity:[.35,0,.35]},transition:{duration:3,repeat:1/0,ease:"easeInOut",delay:.4}}),t.jsx("div",{className:"icon-compact relative z-[1] flex items-center justify-center rounded-full border border-white/10 bg-white/10 p-3 text-slate-100",children:t.jsx($r,{className:"h-5 w-5"})})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-sm font-medium text-slate-700",children:"Waiting for audio"}),t.jsx("div",{className:"mt-1 text-xs text-slate-500/80",children:"Speak into your microphone to wake the spectrum"})]})]})})]})}),t.jsx(as,{children:s&&t.jsxs(Ye.button,{onClick:o,className:"relative mx-auto mt-6 flex items-center gap-2 rounded-lg bg-rose-500 px-5 py-2.5 text-sm font-medium text-white shadow-sm hover:bg-rose-600 active:bg-rose-700",initial:{opacity:0,scale:.95,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:-10},whileHover:{scale:1.02},whileTap:{scale:.98},transition:{type:"spring",damping:20,stiffness:300,delay:.2},children:[t.jsx(Fy,{className:"h-4 w-4"}),t.jsx("span",{children:"Stop recording"})]})}),t.jsx("div",{className:"relative mt-8 w-full",children:t.jsx(as,{mode:"wait",children:s&&h&&t.jsxs(Ye.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},exit:{opacity:0,y:12},transition:{duration:.35,ease:"easeOut"},className:"relative w-full overflow-hidden rounded-card border border-rose-200 bg-rose-50 p-4 shadow-card",children:[t.jsx("div",{className:"pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_top_left,_rgba(244,63,94,0.12),_transparent_65%)]"}),t.jsxs("div",{className:"relative z-[1] flex flex-col gap-3",children:[t.jsxs("div",{className:"flex items-start gap-3 text-rose-700",children:[t.jsx("div",{className:"icon-compact mt-1 flex items-center justify-center rounded-full border border-rose-200 bg-rose-100 p-2 text-rose-600",children:t.jsx(_g,{className:"h-4 w-4"})}),t.jsxs("div",{children:[t.jsx("div",{className:"text-sm font-semibold tracking-tight",children:j.message}),t.jsx("div",{className:"mt-1 text-xs text-rose-600/80",children:"We‚Äôre not hearing anything from this mic right now."})]})]}),t.jsx("div",{className:"flex flex-wrap gap-2 text-[11px] uppercase tracking-[0.14em] text-rose-600/80",children:Lk.map(k=>t.jsx("span",{className:"rounded-full border border-rose-200 bg-white/80 px-3 py-1",children:k},k))})]})]},"warning")})})]})},$v=({isOpen:s,comparison:e,textToInsert:r,onConfirm:a,onCancel:n,onRefreshEMR:i,actionContext:o="insert"})=>{if(!e)return null;const l=f=>{switch(f){case"high":return"text-green-600";case"medium":return"text-yellow-600";case"low":return"text-red-600";default:return"text-gray-600"}},A=e.isMatch?{border:"border-green-200",bg:"bg-green-50",iconColor:"text-green-600",title:"Patient Names Match"}:e.similarityScore>.5?{border:"border-yellow-200",bg:"bg-yellow-50",iconColor:"text-yellow-600",title:"Patient Name Similarity Warning"}:{border:"border-red-200",bg:"bg-red-50",iconColor:"text-red-600",title:"Patient Name Mismatch Warning"},d=e.isMatch?o==="extract"?"Continue":"Insert Text":o==="extract"?"Continue Anyway":"Insert Anyway",h=e.isMatch?o==="extract"?"The patient names appear to match. You can proceed with EMR extraction.":"The patient names appear to match. You can proceed with inserting the text.":o==="extract"?"You are about to extract EMR data from a potentially different patient file. Please verify this is intentional.":"You are about to insert session results into a potentially different patient's EMR file. Please verify this is intentional.";return t.jsx(pc,{isOpen:s,onClose:n,size:"md",header:t.jsx("div",{className:`w-full -mx-6 -mt-5 px-6 py-4 rounded-t-2xl border-b border-gray-200 ${A.bg}`,children:t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(xr,{className:`w-6 h-6 ${A.iconColor}`}),t.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:A.title})]})}),footer:t.jsxs("div",{className:"flex items-center justify-between w-full -mx-6 -mb-4 px-6 py-4 bg-gray-50 rounded-b-2xl",children:[t.jsx(ye,{variant:"outline",onClick:n,children:"Cancel"}),t.jsxs("div",{className:"flex items-center gap-2",children:[i&&t.jsx(ye,{variant:"secondary",onClick:i,children:"Refresh EMR"}),t.jsx(ye,{variant:e.isMatch?"success":"danger",onClick:a,children:d})]})]}),children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Do,{className:"w-4 h-4 text-blue-600"}),t.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Session Patient Name:"})]}),t.jsxs("div",{className:"ml-6 p-3 bg-blue-50 rounded-lg border border-blue-200",children:[t.jsx("div",{className:"text-sm font-medium text-blue-900",children:e.sessionPatientName}),t.jsx("div",{className:"text-xs text-blue-600 mt-1",children:"From dictation session"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Rn,{className:"w-4 h-4 text-green-600"}),t.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Current EMR Patient:"})]}),t.jsxs("div",{className:"ml-6 p-3 bg-green-50 rounded-lg border border-green-200",children:[t.jsx("div",{className:"text-sm font-medium text-green-900",children:e.emrPatientName}),t.jsx("div",{className:"text-xs text-green-600 mt-1",children:"Currently open EMR file"})]})]}),t.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 border border-gray-200",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Similarity Score:"}),t.jsxs("span",{className:`text-sm font-bold ${l(e.confidence)}`,children:[Math.round(e.similarityScore*100),"%"]})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-sm text-gray-700",children:"Confidence Level:"}),t.jsx("span",{className:`text-xs font-medium px-2 py-1 rounded-full ${e.confidence==="high"?"bg-green-100 text-green-800":e.confidence==="medium"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:e.confidence.toUpperCase()})]})]}),e.warnings.length>0&&t.jsxs("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-3",children:[t.jsx("div",{className:"text-sm font-medium text-orange-800 mb-2",children:"Warnings:"}),t.jsx("ul",{className:"text-xs text-orange-700 space-y-1",children:e.warnings.map((f,u)=>t.jsxs("li",{className:"flex items-start space-x-1",children:[t.jsx("span",{className:"w-1 h-1 bg-orange-600 rounded-full mt-1.5 flex-shrink-0"}),t.jsx("span",{children:f})]},u))})]}),r&&t.jsxs("div",{className:"border-t pt-4",children:[t.jsx("div",{className:"text-sm font-medium text-gray-700 mb-2",children:"Text to Insert:"}),t.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 max-h-32 overflow-y-auto border border-gray-200",children:[t.jsx("div",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:r.length>200?`${r.substring(0,200)}...`:r}),r.length>200&&t.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Showing first 200 characters (",r.length," total)"]})]})]}),t.jsx("div",{className:`p-3 rounded-lg border ${e.isMatch?"bg-green-100 border-green-200":"bg-red-100 border-red-200"}`,children:t.jsx("div",{className:`text-sm ${e.isMatch?"text-green-800":"text-red-800"}`,children:h})})]})})},Rk=({onImageSelect:s,currentImage:e,onClearImage:r,disabled:a=!1})=>{const n=m.useCallback(d=>{if(!d.type.startsWith("image/")){YA.invalidFile();return}const h=new FileReader;h.onload=f=>{const u=f.target?.result;u&&(s(u),YA.imageAdded(0))},h.readAsDataURL(d)},[s]),i=m.useCallback(d=>{d&&d.length>0?n(d[0]):YA.invalidFile()},[n]),{getRootProps:o,getInputProps:l,isDragActive:c}=sC({onDrop:i,accept:{"image/*":[]},multiple:!1,disabled:a,noKeyboard:!0,useFsAccessApi:!1}),A=m.useCallback(d=>{d.stopPropagation(),r&&(r(),YA.imageRemoved(0))},[r]);return e?t.jsx("div",{className:"relative",children:t.jsxs("div",{className:"relative rounded-lg border-2 border-gray-300 bg-gray-50 overflow-hidden",children:[t.jsx("img",{src:e,alt:"BP Diary Sheet",className:"w-full h-auto max-h-96 object-contain"}),r&&!a&&t.jsx(Zt,{onClick:A,icon:t.jsx(es,{}),variant:"danger",size:"md",className:"absolute top-2 right-2 rounded-full shadow-lg",title:"Remove image","aria-label":"Remove image"})]})}):t.jsxs("div",{...o({className:`
          relative rounded-lg border-2 border-dashed cursor-pointer transition-all duration-200
          ${a?"opacity-50 cursor-not-allowed":""}
          ${c?"border-blue-500 bg-blue-50 scale-105":"border-gray-300 bg-gray-50 hover:border-blue-400 hover:bg-blue-25"}
          min-h-64 flex items-center justify-center p-8
        `}),children:[t.jsx("input",{...l({accept:"image/*"})}),t.jsxs("div",{className:"flex flex-col items-center justify-center text-center",children:[t.jsx("div",{className:`w-16 h-16 rounded-full flex items-center justify-center mb-4 ${c?"bg-blue-200":"bg-gray-200"}`,children:c?t.jsx(BA,{className:"w-8 h-8 text-blue-600"}):t.jsx(wp,{className:"w-8 h-8 text-gray-500"})}),t.jsx("div",{className:"text-base font-medium text-gray-700 mb-2",children:c?"Drop BP diary image here":"Drop BP diary image or click to browse"}),t.jsxs("div",{className:"text-sm text-gray-500 space-y-1",children:[t.jsx("p",{children:"Supports PNG, JPG, or PDF screenshots"}),t.jsx("p",{className:"text-xs",children:"Photos of handwritten BP diaries work best"})]})]})]})},Mk=({readings:s,onReadingsChange:e,editable:r=!0})=>{const[a,n]=m.useState(null),[i,o]=m.useState(!1),[l,c]=m.useState({date:new Date().toISOString().split("T")[0],time:"07:00",sbp:"",dbp:"",hr:""}),A=m.useCallback((I,C)=>{r&&n({readingId:I,field:C})},[r]),d=m.useCallback((I,C,E)=>{const T=parseInt(E,10);if(isNaN(T))return;const Q=s.map(D=>D.id===I?{...D,[C]:T}:D);e(Q)},[s,e]),h=m.useCallback(()=>{n(null)},[]),f=m.useCallback(()=>{const I=parseInt(l.sbp,10),C=parseInt(l.dbp,10),E=parseInt(l.hr,10);if(isNaN(I)||isNaN(C)||isNaN(E)){alert("Please enter valid numbers for SBP, DBP, and HR");return}if((I<60||I>250||C<40||C>150||E<30||E>200)&&!confirm("Values seem unusual. Are you sure you want to add this reading?"))return;const Q=parseInt(l.time.split(":")[0],10)<12?"morning":"evening",D={id:`bp-${Date.now()}-${Math.random().toString(36).substring(7)}`,date:l.date,time:l.time,timeOfDay:Q,sbp:I,dbp:C,hr:E,confidence:1,warnings:[]},k=[...s,D].sort((R,w)=>{const L=R.date.localeCompare(w.date);return L!==0?L:R.time.localeCompare(w.time)});e(k),c({date:new Date().toISOString().split("T")[0],time:"07:00",sbp:"",dbp:"",hr:""}),o(!1)},[l,s,e]),u=m.useCallback(I=>{if(!confirm("Delete this reading? This action cannot be undone."))return;const C=s.filter(E=>E.id!==I);e(C)},[s,e]),x=m.useCallback(()=>{o(!1),c({date:new Date().toISOString().split("T")[0],time:"07:00",sbp:"",dbp:"",hr:""})},[]),b=(I=[])=>{const C=I.some(T=>T.severity==="error"),E=I.some(T=>T.severity==="warning");return C?t.jsx(or,{className:"w-4 h-4 text-red-600"}):E?t.jsx(xr,{className:"w-4 h-4 text-yellow-600"}):I.length>0?t.jsx(Ma,{className:"w-4 h-4 text-blue-600"}):null},N=(I,C)=>{const E=a?.readingId===I.id&&a?.field===C,T=I[C],Q=I.warnings?.filter(k=>k.field===C)||[],D=Q.length>0;return E?t.jsx("input",{type:"number",defaultValue:T,autoFocus:!0,onBlur:k=>{d(I.id,C,k.target.value),h()},onKeyDown:k=>{k.key==="Enter"?(d(I.id,C,k.currentTarget.value),h()):k.key==="Escape"&&h()},className:"w-full px-2 py-1 border-2 border-blue-500 rounded focus:outline-none",style:{minWidth:"60px"}}):t.jsxs("div",{className:`flex items-center justify-between gap-2 px-2 py-1 rounded ${r?"cursor-pointer hover:bg-gray-100":""} ${D?"bg-yellow-50":""}`,onClick:()=>A(I.id,C),title:Q.map(k=>k.message).join(`
`),children:[t.jsx("span",{className:"font-medium",children:T}),D&&b(Q)]})},v=I=>new Date(I).toLocaleDateString("en-AU",{day:"numeric",month:"short"}),j=()=>s.reduce((I,C)=>I+(C.warnings?.length||0),0);return s.length===0?t.jsx("div",{className:"flex items-center justify-center h-32 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300",children:t.jsx("p",{className:"text-gray-500 text-sm",children:"No readings to review"})}):t.jsxs("div",{className:"space-y-3",children:[r&&!i&&t.jsx(ye,{onClick:()=>o(!0),variant:"outline",size:"sm",startIcon:t.jsx(Fr,{}),className:"text-blue-600 hover:text-blue-700 hover:bg-blue-50 border-blue-200",children:"Add New Reading"}),r&&i&&t.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h4",{className:"text-sm font-semibold text-blue-900",children:"Add New Reading"}),t.jsx(Zt,{onClick:x,icon:t.jsx(es,{}),variant:"ghost",size:"sm",className:"text-blue-600 hover:text-blue-800","aria-label":"Cancel add reading"})]}),t.jsxs("div",{className:"grid grid-cols-5 gap-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Date"}),t.jsx("input",{type:"date",value:l.date,onChange:I=>c({...l,date:I.target.value}),className:"w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Time"}),t.jsx("input",{type:"time",value:l.time,onChange:I=>c({...l,time:I.target.value}),className:"w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"SBP (mmHg)"}),t.jsx("input",{type:"number",value:l.sbp,onChange:I=>c({...l,sbp:I.target.value}),placeholder:"120",min:"60",max:"250",className:"w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"DBP (mmHg)"}),t.jsx("input",{type:"number",value:l.dbp,onChange:I=>c({...l,dbp:I.target.value}),placeholder:"80",min:"40",max:"150",className:"w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"HR (bpm)"}),t.jsx("input",{type:"number",value:l.hr,onChange:I=>c({...l,hr:I.target.value}),placeholder:"70",min:"30",max:"200",className:"w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(ye,{onClick:f,variant:"secondary",size:"sm",startIcon:t.jsx(Ms,{}),children:"Add Reading"}),t.jsx(ye,{onClick:x,variant:"ghost",size:"sm",className:"text-gray-600 hover:text-gray-800",children:"Cancel"})]})]}),t.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-600 bg-gray-50 px-4 py-2 rounded-lg",children:[t.jsxs("span",{children:[s.length," reading",s.length!==1?"s":""]}),j()>0&&t.jsxs("span",{className:"flex items-center gap-1 text-yellow-600",children:[t.jsx(xr,{className:"w-4 h-4"}),j()," warning",j()!==1?"s":""]})]}),t.jsx("div",{className:"overflow-x-auto rounded-lg border border-gray-200",children:t.jsxs("table",{className:"w-full text-xs table-fixed",children:[t.jsx("thead",{className:"bg-gray-100 border-b border-gray-200",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-2 py-2 text-left font-semibold text-gray-700 w-[12%]",children:"Date"}),t.jsx("th",{className:"px-2 py-2 text-left font-semibold text-gray-700 w-[14%]",children:"Time"}),t.jsxs("th",{className:"px-2 py-2 text-center font-semibold text-gray-700 w-[19%]",children:[t.jsx("div",{children:"SBP"}),t.jsx("div",{className:"font-normal text-[10px] text-gray-500",children:"(mmHg)"})]}),t.jsxs("th",{className:"px-2 py-2 text-center font-semibold text-gray-700 w-[19%]",children:[t.jsx("div",{children:"DBP"}),t.jsx("div",{className:"font-normal text-[10px] text-gray-500",children:"(mmHg)"})]}),t.jsxs("th",{className:"px-2 py-2 text-center font-semibold text-gray-700 w-[20%]",children:[t.jsx("div",{children:"HR"}),t.jsx("div",{className:"font-normal text-[10px] text-gray-500",children:"(bpm)"})]}),r&&t.jsx("th",{className:"px-2 py-2 text-center font-semibold text-gray-700 w-[16%]",children:"Actions"})]})}),t.jsx("tbody",{className:"divide-y divide-gray-200",children:s.map(I=>{const C=I.confidence||1,E=C<.8,T=C<.65;let Q="hover:bg-gray-50 transition-colors";return T?Q="bg-red-50 hover:bg-red-100 transition-colors border-l-4 border-red-400":E&&(Q="bg-yellow-50 hover:bg-yellow-100 transition-colors border-l-4 border-yellow-400"),t.jsxs("tr",{className:Q,children:[t.jsx("td",{className:"px-2 py-2 text-gray-900",children:t.jsxs("div",{className:"flex items-center gap-2",children:[v(I.date),E&&t.jsxs("span",{className:`text-[10px] px-1.5 py-0.5 rounded font-semibold ${T?"bg-red-200 text-red-800":"bg-yellow-200 text-yellow-800"}`,title:`Confidence: ${Math.round(C*100)}%`,children:[Math.round(C*100),"%"]})]})}),t.jsx("td",{className:"px-2 py-2 text-gray-700 font-mono text-xs",children:I.time}),t.jsx("td",{className:"px-2 py-2 text-center",children:N(I,"sbp")}),t.jsx("td",{className:"px-2 py-2 text-center",children:N(I,"dbp")}),t.jsx("td",{className:"px-2 py-2 text-center",children:N(I,"hr")}),r&&t.jsx("td",{className:"px-2 py-2 text-center",children:t.jsx(Zt,{onClick:()=>u(I.id),icon:t.jsx(Ln,{}),variant:"ghost",size:"sm",className:"text-red-600 hover:text-red-800 hover:bg-red-50","aria-label":"Delete this reading"})})]},I.id)})})]})}),r&&t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center justify-center gap-4 text-xs",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-3 h-3 bg-yellow-50 border-l-2 border-yellow-400 rounded"}),t.jsx("span",{className:"text-gray-600",children:"Low confidence (<80%) - verify these first"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-3 h-3 bg-red-50 border-l-2 border-red-400 rounded"}),t.jsx("span",{className:"text-gray-600",children:"Very low confidence (<65%) - likely incorrect"})]})]}),t.jsx("p",{className:"text-xs text-gray-500 text-center",children:"Click any value to edit ‚Ä¢ Press Enter to save, Esc to cancel ‚Ä¢ Use trash icon to delete readings"})]}),j()>0&&t.jsx("div",{className:"mt-4 space-y-2",children:s.filter(I=>I.warnings&&I.warnings.length>0).map(I=>t.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:[t.jsxs("div",{className:"text-xs font-semibold text-gray-700 mb-1",children:[v(I.date)," ",I.time,":"]}),t.jsx("ul",{className:"text-xs text-gray-600 space-y-1",children:I.warnings?.map((C,E)=>t.jsxs("li",{className:"flex items-start gap-2",children:[b([C]),t.jsx("span",{children:C.message})]},E))})]},I.id))})]})},Kv=m.forwardRef(({readings:s,showReferenceLines:e=!0,referenceSBP:r=130,referenceDBP:a=80,width:n,height:i},o)=>{const l=m.useRef(null),c=m.useRef(null),[A,d]=m.useState(null),[h,f]=m.useState({width:n||600,height:i||350});m.useImperativeHandle(o,()=>({copyToClipboard:async()=>{await E()}})),m.useEffect(()=>{const T=()=>{if(c.current){const Q=c.current.offsetWidth;f({width:n||Math.max(400,Q-20),height:i||350})}};return T(),window.addEventListener("resize",T),()=>window.removeEventListener("resize",T)},[n,i]),m.useEffect(()=>{u()},[s,e,r,a,h]);const u=m.useCallback(()=>{const T=l.current;if(!T||s.length===0)return;const Q=T.getContext("2d");if(!Q)return;const{width:D,height:k}=h,R=window.devicePixelRatio||1;T.width=D*R,T.height=k*R,T.style.width=`${D}px`,T.style.height=`${k}px`,Q.scale(R,R),Q.clearRect(0,0,D,k);const w={top:30,right:60,bottom:60,left:70},L=D-w.left-w.right,M=k-w.top-w.bottom,P=s.map(q=>q.sbp),K=s.map(q=>q.dbp),$=[...P,...K];e&&$.push(r,a);const O=Math.floor(Math.min(...$)/10)*10-10,W=Math.ceil(Math.max(...$)/10)*10+10,ee=q=>w.left+q/(s.length-1)*L,V=q=>w.top+M-(q-O)/(W-O)*M;e&&(v(Q,V(r),`SBP ${r}`,"#94a3b8",w,L),v(Q,V(a),`DBP ${a}`,"#94a3b8",w,L)),j(Q,w,L,M,O,W,s,k),b(Q,s,P,ee,V,"#1e293b"),b(Q,s,K,ee,V,"#475569"),s.forEach((q,S)=>{const H=ee(S);N(Q,H,V(q.sbp),"#1e293b"),N(Q,H,V(q.dbp),"#475569")})},[s,e,r,a,h]),x=m.useCallback(T=>{if(u(),T===null||!l.current)return;const Q=l.current.getContext("2d");if(!Q)return;const{width:D,height:k}=h,R={top:30,right:60,bottom:60,left:70},w=D-R.left-R.right,L=k-R.top-R.bottom,M=s.map(S=>S.sbp),P=s.map(S=>S.dbp),K=[...M,...P];e&&K.push(r,a);const $=Math.floor(Math.min(...K)/10)*10-10,O=Math.ceil(Math.max(...K)/10)*10+10,W=S=>R.left+S/(s.length-1)*w,ee=S=>R.top+L-(S-$)/(O-$)*L,V=s[T],q=W(T);Q.beginPath(),Q.fillStyle="rgba(30, 41, 59, 0.2)",Q.arc(q,ee(V.sbp),8,0,Math.PI*2),Q.fill(),Q.beginPath(),Q.fillStyle="rgba(71, 85, 105, 0.2)",Q.arc(q,ee(V.dbp),8,0,Math.PI*2),Q.fill()},[s,e,r,a,h]),b=(T,Q,D,k,R,w,L)=>{T.beginPath(),T.strokeStyle=w,T.lineWidth=2,Q.forEach((M,P)=>{const K=k(P),$=R(D[P]);P===0?T.moveTo(K,$):T.lineTo(K,$)}),T.stroke()},N=(T,Q,D,k)=>{T.beginPath(),T.fillStyle=k,T.arc(Q,D,4,0,Math.PI*2),T.fill(),T.strokeStyle="#ffffff",T.lineWidth=2,T.stroke()},v=(T,Q,D,k,R,w)=>{T.save(),T.setLineDash([5,5]),T.strokeStyle=k,T.lineWidth=1,T.beginPath(),T.moveTo(R.left,Q),T.lineTo(R.left+w,Q),T.stroke(),T.setLineDash([]),T.fillStyle=k,T.font="10px sans-serif",T.textAlign="left",T.fillText(D,R.left+5,Q-5),T.restore()},j=(T,Q,D,k,R,w,L,M)=>{T.strokeStyle="#cbd5e1",T.lineWidth=1,T.beginPath(),T.moveTo(Q.left,Q.top),T.lineTo(Q.left,Q.top+k),T.stroke(),T.beginPath(),T.moveTo(Q.left,Q.top+k),T.lineTo(Q.left+D,Q.top+k),T.stroke(),T.fillStyle="#64748b",T.font="12px sans-serif",T.textAlign="right";const P=5;for(let $=0;$<=P;$++){const O=R+(w-R)*($/P),W=Q.top+k-$/P*k;T.fillText(Math.round(O).toString(),Q.left-10,W+4)}T.textAlign="center",T.font="9px sans-serif";const K=Math.max(1,Math.ceil(L.length/6));L.forEach(($,O)=>{if(O%K===0||O===L.length-1){const W=Q.left+O/(L.length-1)*D,ee=new Date($.date),V=`${ee.getDate()}/${ee.getMonth()+1}`;T.fillText(V,W,Q.top+k+15),T.font="8px monospace",T.fillText($.time,W,Q.top+k+27),T.font="9px sans-serif"}}),T.save(),T.translate(12,Q.top+k/2),T.rotate(-Math.PI/2),T.textAlign="center",T.fillStyle="#475569",T.font="11px sans-serif",T.fillText("Blood Pressure (mmHg)",0,0),T.restore(),T.fillStyle="#475569",T.font="bold 13px sans-serif",T.textAlign="center",T.fillText("Date & Time",Q.left+D/2,M-10)},I=m.useCallback(T=>{if(s.length===0)return;const Q=l.current,D=c.current;if(!Q||!D)return;const k=Q.getBoundingClientRect(),R=D.getBoundingClientRect(),w=T.clientX-k.left,{width:L}=h,M={right:60,left:70},P=L-M.left-M.right;if(w<M.left||w>M.left+P){d(null);return}const K=w-M.left,$=Math.round(K/P*(s.length-1)),O=Math.max(0,Math.min($,s.length-1)),W=s[O];x(O);const ee=M.left+O/(s.length-1)*P,V=140,q=80;let S=ee+10,H=T.clientY-R.top-q;S+V>R.width&&(S=ee-V-10),H<0&&(H=T.clientY-R.top+10),d({visible:!0,x:S,y:H,reading:W,index:O})},[s,h,x]),C=m.useCallback(()=>{d(null),x(null)},[x]),E=async()=>{const T=l.current;if(!T){gt.getInstance().error("Copy failed","Chart not available");return}try{const Q=await new Promise((D,k)=>{T.toBlob(R=>{R?D(R):k(new Error("Failed to create image"))},"image/png",1)});await navigator.clipboard.write([new ClipboardItem({"image/png":Q})]),gt.getInstance().success("Chart copied","Paste into your document with Cmd+V (Mac) or Ctrl+V (Windows)")}catch(Q){console.error("Failed to copy chart:",Q),gt.getInstance().error("Copy failed","Your browser may not support clipboard images")}};return s.length===0?t.jsx("div",{className:"flex items-center justify-center h-64 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300",children:t.jsx("p",{className:"text-gray-500 text-sm",children:"No readings to display"})}):t.jsxs("div",{ref:c,className:"relative",children:[t.jsx("canvas",{ref:l,onMouseMove:I,onMouseLeave:C,className:"cursor-crosshair",style:{maxWidth:"100%",height:"auto"}}),A&&A.visible&&t.jsxs("div",{className:"absolute z-50 bg-white border-2 border-gray-800 rounded shadow-lg p-2 pointer-events-none",style:{left:`${A.x}px`,top:`${A.y}px`,minWidth:"140px"},children:[t.jsxs("div",{className:"text-[10px] font-semibold text-gray-900 mb-1",children:[new Date(A.reading.date).toLocaleDateString("en-AU",{day:"numeric",month:"short"})," ",t.jsx("span",{className:"font-mono",children:A.reading.time})]}),t.jsxs("div",{className:"space-y-0.5 text-[10px]",children:[t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"SBP:"}),t.jsx("span",{className:"font-semibold text-gray-900",children:A.reading.sbp})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"DBP:"}),t.jsx("span",{className:"font-semibold text-gray-900",children:A.reading.dbp})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-gray-600",children:"HR:"}),t.jsx("span",{className:"font-semibold text-gray-900",children:A.reading.hr})]})]})]})]})});Kv.displayName="BPChart";class Eo{static instance;lmStudioService;constructor(){this.lmStudioService=Ei.getInstance()}static getInstance(){return Eo.instance||(Eo.instance=new Eo),Eo.instance}getDefaultOCRModel(){return this.lmStudioService.getDefaultOCRModel()}getDefaultClinicalModel(){return this.lmStudioService.getDefaultClinicalReasoningModel()}async extractFromImage(e,r,a){const n=Date.now();try{const i=this.getDefaultOCRModel(),o=a||i,l=this.validateImage(e);if(l)return{success:!1,readings:[],error:l,processingTime:Date.now()-n};bt.info("Starting BP diary extraction",{component:"bp-extractor",imageSize:e.length,imageSizeMB:(e.length/(1024*1024)).toFixed(2),model:o,modelOverrideProvided:!!a});const c=this.buildExtractionPrompt(),A=await this.lmStudioService.processWithVisionAgent(this.getSystemPrompt(),c,e,"bp-diary-extraction",r,o);bt.info("Received LM Studio response",{component:"bp-extractor",responseLength:A.length,responsePreview:A.substring(0,100)});const d=A.trim();if(d==="[]"||d===""||d.length<3)return bt.warn("Vision model returned empty response",{component:"bp-extractor",response:d,modelUsed:o}),{success:!1,readings:[],error:`Vision model could not extract any readings from the image. This may indicate:

1. The model (${o}) may not be properly loaded with vision support in LM Studio
2. The image quality may be too poor for the model to read
3. The model may not support vision tasks (ensure you're using a vision-capable model such as Qwen3-VL, DeepSeek-OCR, LLaVA, or Gemma vision variants)

Troubleshooting:
- Verify your vision model is loaded in LM Studio with the correct GGUF files (including -mmproj files for vision support where required)
- Try a different vision-capable model from the dropdown
- Use the "Load Sample Data" button to test the chart and editing features`,processingTime:Date.now()-n};const h=this.parseResponse(A);if(h.length===0)return bt.warn("Parsing returned no readings",{component:"bp-extractor",responseLength:A.length}),{success:!1,readings:[],error:`Could not extract BP readings from the vision model response. The model may have misunderstood the task or the image may not contain recognizable BP diary data.

Try:
- Ensuring the image shows a clear BP diary table
- Using a different vision model
- Using the "Load Sample Data" button to test the features`,rawResponse:A,processingTime:Date.now()-n};const f=Date.now()-n;return bt.info("BP extraction complete",{component:"bp-extractor",readingsCount:h.length,processingTime:f,modelUsed:o}),{success:!0,readings:h,rawResponse:A,processingTime:f}}catch(i){const o=Date.now()-n,l=i instanceof Error?i.message:"Unknown error";return bt.error("BP extraction failed",{component:"bp-extractor",error:l,processingTime:o}),{success:!1,readings:[],error:l,processingTime:o}}}buildExtractionPrompt(){return`VISION TASK: You are analyzing a blood pressure diary photograph/screenshot. You must LOOK AT THE IMAGE and extract tabular data.

STEP 1: EXAMINE THE IMAGE COMPLETELY
- Look for a table with columns: Date, Time, Systolic BP (SBP), Diastolic BP (DBP), Heart Rate (HR)
- The table may be handwritten or printed
- Numbers are whole integers in mmHg (no decimals)
- SCAN THE ENTIRE IMAGE FROM TOP TO BOTTOM - do not stop early
- Count the number of rows visible in the table
- Dates may appear in various formats: DD/MM (e.g., "5/9", "16/10"), DD/MM/YYYY, or written out

STEP 2: EXTRACTION RULES (CRITICAL)
1. BOTTOM-NUMBER RULE: When a cell contains two stacked values (e.g., "160\\n156" or "160/156"), you MUST select the BOTTOM value only. This is non-negotiable.

2. READ EACH CELL INDEPENDENTLY: This is CRITICAL to avoid duplication errors.
   - Do NOT copy dates/times from previous rows
   - Look at EACH cell individually and read what you see
   - If two rows look similar, double-check - they should have different dates or times
   - Common mistake: copying "16 Oct" and "23:49" to multiple rows - AVOID THIS!

3. EXTRACT EVERY ROW: Extract ALL readings visible in the image, even if some values are slightly unclear. Make your BEST GUESS rather than skipping a row.

4. HANDWRITING TOLERANCE: For handwritten diaries:
   - If a number could be 5 or 6, pick the most likely
   - If a date format is abbreviated (e.g., "5/9"), assume current or previous year
   - If time is partially unclear, use context (am/pm notation)
   - Confidence should reflect uncertainty (0.6-0.8 for unclear values)
   - IMPORTANT: Each row should have DIFFERENT date or time values

5. DATE FORMATS: Accept and convert all these formats to YYYY-MM-DD:
   - "16/10" ‚Üí "2025-10-16" (assume current year if not specified)
   - "5/9" ‚Üí "2025-09-05" (DD/MM format, assume September 5th)
   - "14/9/2025" ‚Üí "2025-09-14"
   - Written dates ‚Üí convert to YYYY-MM-DD
   - WATCH OUT: Dates often change between rows - don't duplicate!

6. TIME FORMATS: Extract EXACT time in HH:MM (24-hour clock)
   - "4:22 am" ‚Üí "04:22"
   - "10.16 am" ‚Üí "10:16"
   - "3:21 pm" ‚Üí "15:21"
   - "9:55" ‚Üí assume context (am/pm)
   - WARNING: Times should vary between readings - check each cell carefully!

7. COMPLETE SCAN: Do not stop until you have checked every visible row in the table, even if you've already found 10+ readings

STEP 3: OUTPUT FORMAT
Return ONLY a JSON array with this exact structure (no markdown, no code blocks, no explanations):

EXAMPLE OUTPUT (if image shows these readings):
[
  {
    "date": "2025-10-16",
    "time": "04:22",
    "sbp": 150,
    "dbp": 94,
    "hr": 95,
    "confidence": 0.95
  },
  {
    "date": "2025-10-16",
    "time": "10:16",
    "sbp": 146,
    "dbp": 91,
    "hr": 89,
    "confidence": 0.90
  },
  {
    "date": "2025-10-16",
    "time": "13:40",
    "sbp": 130,
    "dbp": 82,
    "hr": 91,
    "confidence": 0.85
  }
]

CRITICAL REMINDERS:
- Extract EVERY row you can see - aim for 100% coverage
- READ EACH CELL INDEPENDENTLY - do not copy values from nearby rows
- Dates and times should be DIFFERENT for each row (unless truly identical in the image)
- Make your best guess for unclear values rather than skipping them
- Lower confidence (0.6-0.8) for uncertain readings is better than no reading
- Scan the ENTIRE image before returning results
- If you see duplicate dates/times in your output, GO BACK and re-read those cells carefully
- If the image is completely unreadable or contains no BP table, ONLY THEN return an empty array: []

Now, examine the provided image and extract ALL visible blood pressure readings following the rules above.`}getSystemPrompt(){return`You are a medical data extraction specialist with vision capabilities, specialized in analyzing blood pressure diary images.

Your task is to:
1. LOOK AT the provided image carefully and SCAN THE ENTIRE IMAGE from top to bottom
2. Identify tabular data containing BP readings (Date, Time, SBP, DBP, HR)
3. Extract EVERY SINGLE visible reading - do not skip rows even if handwriting is unclear
4. Make your best guess for unclear values rather than omitting them (use lower confidence scores for uncertainty)
5. Apply the BOTTOM-NUMBER RULE when cells contain stacked values
6. Preserve EXACT timestamps (HH:MM format) - never simplify to morning/evening
7. Handle various date formats: DD/MM, DD/MM/YYYY, written dates
8. Maintain chronological order

CRITICAL: Aim for 100% extraction coverage. Extract every row you can identify, even if values are partially unclear.

Return ONLY structured JSON array data without any markdown formatting, code blocks, or explanatory text.
If you cannot see or process the image at all, return an empty array [].`}async generateClinicalInsights(e,r){if(e.length===0)return{controlSummary:"No readings supplied for analysis",diurnalPattern:"Insufficient data for diurnal assessment",variabilityConcern:"Insufficient data for variability assessment",keyRecommendations:["Provide home BP readings before attempting analysis"]};const{signal:a,modelOverride:n,medicationsText:i,backgroundText:o}=r||{},l="You are a hypertension and cardiovascular risk clinician in Australia. You receive home blood pressure monitoring data and the current medication list. You must: (1) assess overall BP control using home thresholds (135/85), (2) comment on morning vs evening readings, (3) detect high variability, (4) relate control to the medications supplied (e.g. ACEi, ARB, CCB, thiazide, beta-blocker), (5) suggest next clinical steps such as ABPM, adherence check, timing adjustment or intensification, and (6) generate a short paragraph for the patient in Australian English. Use Australian spelling in every response.",c=this.calculateBasicStats(e),A=this.buildInsightsPrompt(e,c,{medicationsText:i,backgroundText:o}),d=this.getDefaultClinicalModel();if(n)try{const f=await this.lmStudioService.processWithAgent(l,A,"bp-diary-insights",a,n);return this.parseInsightsResponse(f)}catch(f){bt.warn("Failed to generate BP insights with override model, falling back to default clinical reasoning model",{component:"bp-extractor",model:n,error:f instanceof Error?f.message:"Unknown error"})}const h=await this.lmStudioService.processWithAgent(l,A,"bp-diary-insights",a,d);return this.parseInsightsResponse(h)}buildInsightsPrompt(e,r,a){const n=e.map(l=>`${l.date} ${l.time}: ${l.sbp}/${l.dbp} mmHg, HR ${l.hr}`).join(`
`),i=a?.medicationsText?.trim()?a.medicationsText.trim():"No medications supplied.",o=a?.backgroundText?.trim()?a.backgroundText.trim():"No additional background supplied.";return`You will receive structured home blood pressure readings and limited clinical context. Analyse the data and respond with JSON only.

READINGS:
${n}

SUMMARY STATISTICS:
- Count: ${r.count}
- Average: ${r.avgSBP}/${r.avgDBP} mmHg (HR ${r.avgHR})
- SBP Range: ${r.minSBP}-${r.maxSBP} mmHg
- DBP Range: ${r.minDBP}-${r.maxDBP} mmHg
- Readings ‚â•135/85: ${r.aboveTarget}/${r.count} (${r.percentAboveTarget}%)

CLINICAL CONTEXT:
- Medications: ${i}
- Background: ${o}

Return ONLY JSON using this schema:
{
  "controlSummary": "Overall BP control referencing home threshold (135/85)",
  "diurnalPattern": "Morning vs evening commentary or 'Insufficient data'",
  "variabilityConcern": "Variability assessment referencing observed range",
  "keyRecommendations": ["Clinician-facing next steps in plain text"],
  "medicationRationale": "How current regimen explains control or gaps; say 'No medications supplied' if none provided",
  "abpmSuggestion": "Specific statement on ABPM / adherence / follow-up timing",
  "patientParagraph": "Short patient-friendly paragraph (Australian English, plain text)",
  "peakTimes": "Times with highest readings if pattern evident",
  "lowestTimes": "Times with best control if pattern evident"
}

Constraints:
- Use Australian spelling.
- Tie recommendations to supplied medications where possible.
- Mention explicitly if medications or background were not provided.
- Do not include markdown, explanations, or additional text outside the JSON object.`}parseInsightsResponse(e){try{let r=e.trim();r.startsWith("```")&&(r=r.replace(/```json\n?/g,"").replace(/```\n?/g,""));const a=JSON.parse(r),n=a&&typeof a=="object"&&"insights"in a?a.insights:a;if(!n||typeof n!="object")throw new Error("Insights payload was not an object");const i=(d,h)=>typeof d=="string"&&d.trim().length>0?d.trim():h,o=d=>{if(typeof d=="string"&&d.trim().length>0)return d.trim()};let l=[];const c=n.keyRecommendations;Array.isArray(c)?l=c.map(d=>{if(typeof d=="string")return d.trim();if(d&&typeof d=="object")try{return JSON.stringify(d)}catch{return""}return String(d??"")}).filter(d=>d.length>0):typeof c=="string"&&c.trim().length>0&&(l=c.split(/\n|;/).map(d=>d.trim()).filter(Boolean)),l.length===0&&(l=["Review readings with healthcare provider"]);const A=n;return{controlSummary:i(A.controlSummary,"Unable to assess"),diurnalPattern:i(A.diurnalPattern,"Insufficient data for pattern analysis"),variabilityConcern:i(A.variabilityConcern,"Unable to assess"),keyRecommendations:l,peakTimes:o(A.peakTimes),lowestTimes:o(A.lowestTimes),patientParagraph:o(A.patientParagraph),medicationRationale:o(A.medicationRationale),abpmSuggestion:o(A.abpmSuggestion)}}catch(r){return bt.error("Failed to parse insights response",{component:"bp-extractor",error:r instanceof Error?r.message:"Parse error",response:e.substring(0,200)}),{controlSummary:"Analysis unavailable",diurnalPattern:"Analysis unavailable",variabilityConcern:"Analysis unavailable",keyRecommendations:["Review readings with healthcare provider"]}}}calculateBasicStats(e){const r=e.map(x=>x.sbp),a=e.map(x=>x.dbp),n=e.map(x=>x.hr),i=Math.round(r.reduce((x,b)=>x+b,0)/r.length),o=Math.round(a.reduce((x,b)=>x+b,0)/a.length),l=n.length>0?Math.round(n.reduce((x,b)=>x+b,0)/n.length):0,c=Math.min(...r),A=Math.max(...r),d=Math.min(...a),h=Math.max(...a),f=e.filter(x=>x.sbp>=135||x.dbp>=85).length,u=Math.round(f/e.length*100);return{count:e.length,avgSBP:i,avgDBP:o,avgHR:l,minSBP:c,maxSBP:A,minDBP:d,maxDBP:h,aboveTarget:f,percentAboveTarget:u}}parseResponse(e){try{let r=e.trim();r.startsWith("```")&&(r=r.replace(/```json\n?/g,"").replace(/```\n?/g,""));const a=JSON.parse(r);return Array.isArray(a)?a.map((i,o)=>{const l=String(i.time||"00:00");return{id:`bp-${Date.now()}-${o}`,date:this.normalizeDate(String(i.date||"")),time:this.normalizeTime(l),timeOfDay:this.deriveTimeOfDay(l),sbp:this.parseNumber(i.sbp),dbp:this.parseNumber(i.dbp),hr:this.parseNumber(i.hr),confidence:typeof i.confidence=="number"?i.confidence:.8,warnings:[]}}):(bt.warn("Response is not an array",{component:"bp-extractor"}),[])}catch(r){return bt.error("Failed to parse extraction response",{component:"bp-extractor",error:r instanceof Error?r.message:"Parse error",response:e.substring(0,200)}),[]}}normalizeDate(e){if(!e)return new Date().toISOString().split("T")[0];if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const r=e.match(/(\d{1,2})[/-](\d{1,2})(?:[/-](\d{2,4}))?/);if(r){const a=r[1].padStart(2,"0"),n=r[2].padStart(2,"0");return`${r[3]?r[3].length===2?`20${r[3]}`:r[3]:new Date().getFullYear().toString()}-${n}-${a}`}return new Date().toISOString().split("T")[0]}normalizeTime(e){if(!e)return"00:00";if(/^\d{2}:\d{2}$/.test(e))return e;const r=e.match(/(\d{1,2}):(\d{2})/);if(r){const a=r[1].padStart(2,"0"),n=r[2];return`${a}:${n}`}return"00:00"}deriveTimeOfDay(e){return parseInt(e.split(":")[0],10)<12?"morning":"evening"}parseNumber(e){if(typeof e=="number")return e;if(!e)return 0;const r=String(e).trim(),a=r.match(/(\d+)[\n/\\,](\d+)/);if(a)return parseInt(a[2],10);const n=r.match(/\d+/);return n?parseInt(n[0],10):0}validateImage(e){if(!e||e.length===0)return"No image data provided";if(!e.startsWith("data:image/"))return'Invalid image format. Expected data URL starting with "data:image/"';const r=e.substring(5,e.indexOf(";"));if(!["image/jpeg","image/jpg","image/png","image/webp"].includes(r))return`Unsupported image type: ${r}. Supported types: JPEG, PNG, WebP`;const i=e.length/(1024*1024);return i>10?`Image too large (${i.toFixed(1)}MB). Maximum size is 10MB. Please compress or resize the image.`:(i>5&&bt.warn("Large image detected",{component:"bp-extractor",sizeMB:i.toFixed(2),message:"Image is large and may take longer to process or fail with some models"}),null)}}const op={showReferenceLines:!0,referenceSBP:135,referenceDBP:85,dateFormat:"dd/MM",assumeCurrentYear:!0,sbpControlTarget:130,sbpControlGoal:90},xa={sbp:{min:70,max:260},dbp:{min:40,max:160},hr:{min:30,max:200}};class _l{static instance;constructor(){}static getInstance(){return _l.instance||(_l.instance=new _l),_l.instance}validateReading(e){const r=[];let a=!1,n={...e};if((n.sbp<xa.sbp.min||n.sbp>xa.sbp.max)&&r.push({type:"range",field:"sbp",message:`SBP ${n.sbp} is outside typical range (${xa.sbp.min}-${xa.sbp.max} mmHg)`,severity:"warning"}),(n.dbp<xa.dbp.min||n.dbp>xa.dbp.max)&&r.push({type:"range",field:"dbp",message:`DBP ${n.dbp} is outside typical range (${xa.dbp.min}-${xa.dbp.max} mmHg)`,severity:"warning"}),(n.hr<xa.hr.min||n.hr>xa.hr.max)&&r.push({type:"range",field:"hr",message:`HR ${n.hr} is outside typical range (${xa.hr.min}-${xa.hr.max} bpm)`,severity:"warning"}),n.dbp>n.sbp)if(this.shouldSwapValues(n.sbp,n.dbp)){const i=n.sbp;n.sbp=n.dbp,n.dbp=i,a=!0,r.push({type:"swapped",field:"sbp",message:"Swapped SBP/DBP (DBP was greater than SBP)",severity:"info"})}else r.push({type:"relational",field:"dbp",message:`DBP ${n.dbp} is greater than SBP ${n.sbp} (unusual)`,severity:"error"});return n.sbp===0&&r.push({type:"missing",field:"sbp",message:"SBP value is missing or zero",severity:"error"}),n.dbp===0&&r.push({type:"missing",field:"dbp",message:"DBP value is missing or zero",severity:"error"}),n.warnings=r,{valid:r.filter(i=>i.severity==="error").length===0,reading:n,warnings:r,modified:a}}validateAndSort(e){return e.map(a=>this.validateReading(a).reading).sort((a,n)=>{const i=a.date.localeCompare(n.date);if(i!==0)return i;const o=parseInt(a.time.replace(":",""),10),l=parseInt(n.time.replace(":",""),10);return o-l})}shouldSwapValues(e,r){if(r<=e)return!1;const a=r>=xa.sbp.min&&r<=xa.sbp.max,n=e>=xa.dbp.min&&e<=xa.dbp.max,i=r-e,o=i>=20&&i<=100;return a&&n&&o}getStatistics(e,r=130){if(e.length===0)return{count:0,avgSBP:0,avgDBP:0,avgHR:0,minSBP:0,maxSBP:0,minDBP:0,maxDBP:0,aboveTarget:0,percentAboveTarget:0,sbpBelowTarget:0,percentSBPBelowTarget:0};const a=e.map(h=>h.sbp),n=e.map(h=>h.dbp),i=e.map(h=>h.hr),o=this.average(a),l=this.average(n),c=this.average(i),A=e.filter(h=>h.sbp>=135||h.dbp>=85).length,d=e.filter(h=>h.sbp<r).length;return{count:e.length,avgSBP:Math.round(o),avgDBP:Math.round(l),avgHR:Math.round(c),minSBP:Math.min(...a),maxSBP:Math.max(...a),minDBP:Math.min(...n),maxDBP:Math.max(...n),aboveTarget:A,percentAboveTarget:Math.round(A/e.length*100),sbpBelowTarget:d,percentSBPBelowTarget:Math.round(d/e.length*100)}}normalizeDate(e,r=!0){if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const a=e.match(/(\d{1,2})[/-](\d{1,2})(?:[/-](\d{2,4}))?/);if(a){const n=a[1].padStart(2,"0"),i=a[2].padStart(2,"0");let o=a[3];return!o&&r?o=new Date().getFullYear().toString():o&&o.length===2&&(o=`20${o}`),`${o}-${i}-${n}`}return new Date().toISOString().split("T")[0]}average(e){return e.length===0?0:e.reduce((r,a)=>r+a,0)/e.length}applyBottomNumberRule(e){const r=e.match(/(\d+)[\n/\\,\s](\d+)/);if(r)return parseInt(r[2],10);const a=e.match(/\d+/);return a?parseInt(a[0],10):0}}const Ua={LATEST_SESSION:"bp-diary-latest",SETTINGS:"bp-diary-settings",HISTORY:"bp-diary-history"},h0=10;class Ql{static instance;constructor(){}static getInstance(){return Ql.instance||(Ql.instance=new Ql),Ql.instance}async saveSession(e){try{await chrome.storage.local.set({[Ua.LATEST_SESSION]:e}),bt.info("BP diary session saved",{component:"bp-storage",sessionId:e.id,readingsCount:e.readings.length}),await this.addToHistory(e)}catch(r){throw bt.error("Failed to save BP diary session",{component:"bp-storage",error:r instanceof Error?r.message:"Unknown error"}),r}}async loadLatestSession(){try{const r=(await chrome.storage.local.get(Ua.LATEST_SESSION))[Ua.LATEST_SESSION];return r&&bt.info("BP diary session loaded",{component:"bp-storage",sessionId:r.id,readingsCount:r.readings.length}),r||null}catch(e){return bt.error("Failed to load BP diary session",{component:"bp-storage",error:e instanceof Error?e.message:"Unknown error"}),null}}async clearLatestSession(){try{await chrome.storage.local.remove(Ua.LATEST_SESSION),bt.info("BP diary latest session cleared",{component:"bp-storage"})}catch(e){bt.error("Failed to clear BP diary session",{component:"bp-storage",error:e instanceof Error?e.message:"Unknown error"})}}async saveSettings(e){try{await chrome.storage.local.set({[Ua.SETTINGS]:e}),bt.info("BP diary settings saved",{component:"bp-storage"})}catch(r){throw bt.error("Failed to save BP diary settings",{component:"bp-storage",error:r instanceof Error?r.message:"Unknown error"}),r}}async loadSettings(){try{return(await chrome.storage.local.get(Ua.SETTINGS))[Ua.SETTINGS]||op}catch(e){return bt.error("Failed to load BP diary settings",{component:"bp-storage",error:e instanceof Error?e.message:"Unknown error"}),op}}async addToHistory(e){try{let a=(await chrome.storage.local.get(Ua.HISTORY))[Ua.HISTORY]||[];a.unshift(e),a.length>h0&&(a=a.slice(0,h0)),await chrome.storage.local.set({[Ua.HISTORY]:a})}catch(r){bt.warn("Failed to add session to history",{component:"bp-storage",error:r instanceof Error?r.message:"Unknown error"})}}async loadHistory(){try{return(await chrome.storage.local.get(Ua.HISTORY))[Ua.HISTORY]||[]}catch(e){return bt.error("Failed to load BP diary history",{component:"bp-storage",error:e instanceof Error?e.message:"Unknown error"}),[]}}async clearAll(){try{await chrome.storage.local.remove([Ua.LATEST_SESSION,Ua.SETTINGS,Ua.HISTORY]),bt.info("All BP diary data cleared",{component:"bp-storage"})}catch(e){throw bt.error("Failed to clear BP diary data",{component:"bp-storage",error:e instanceof Error?e.message:"Unknown error"}),e}}}const _k=({isOpen:s,onClose:e})=>{const[r,a]=m.useState(null),[n,i]=m.useState([]),[o,l]=m.useState("idle"),[c,A]=m.useState(""),[d,h]=m.useState(op),[f,u]=m.useState(!1),[x,b]=m.useState(()=>Eo.getInstance().getDefaultOCRModel()),[N,v]=m.useState([]),[j,I]=m.useState(!1),[C,E]=m.useState(null),[T,Q]=m.useState(!1),[D,k]=m.useState(null),[R,w]=m.useState(null),[L,M]=m.useState(()=>{const be=Eo.getInstance();return{extraction:be.getDefaultOCRModel(),reasoning:be.getDefaultClinicalModel()}}),P=m.useRef(null),K=m.useRef(Eo.getInstance()),$=m.useRef(_l.getInstance()),O=m.useRef(Ql.getInstance()),W=m.useRef(Ei.getInstance()),ee=m.useRef(0);m.useEffect(()=>{V(),q()},[]);const V=async()=>{const be=await O.current.loadSettings();h(be)},q=async()=>{const be=K.current.getDefaultOCRModel(),Ie=(await W.current.getAvailableModels()).filter(de=>{const xe=de.toLowerCase();return xe.includes("llava")||xe.includes("gemma")||xe.includes("vision")||xe.includes("qwen")&&xe.includes("vl")||xe.includes("minicpm")||xe.includes("pixtral")||xe.includes("phi-3-vision")||xe.includes("molmo")||xe.includes("deepseek")||xe.includes("ocr")}),pe=Array.from(new Set([be,...Ie]));v(pe);const fe=[be,"qwen/qwen3-vl-8b","google/gemma-3n-e4b","medgemma-4b-it-mlx","llava-v1.6","llava-v1.5"];let we=be;for(const de of fe){const xe=pe.find(Ne=>Ne.includes(de));if(xe){we=xe;break}}!pe.includes(we)&&pe.length>0&&(we=pe[0]),b(we)},S=m.useCallback(async()=>{const be={};if(typeof chrome>"u"||!chrome.runtime?.sendMessage)return be;try{const ce=await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"extract-patient-data",data:{}});if(!ce?.success||!ce?.data)return be;const Ie=ce.data,pe=[Ie.medications,Ie.medications_emr,Ie.currentMedications,Ie.meds_snapshot].filter(Boolean),fe=xe=>{if(!xe)return"";if(typeof xe=="string")return xe.trim();if(Array.isArray(xe))return xe.map(fe).filter(Boolean).join(`
`);if(typeof xe=="object"){const Ne=xe;return["name","dose","frequency","route","indication"].map(st=>typeof Ne[st]=="string"?Ne[st].trim():"").filter(Boolean).join(" ").trim()}return String(xe)};for(const xe of pe){const Ne=fe(xe);if(Ne.trim().length>0){be.medicationsText=Ne.trim();break}}const we=[Ie.background,Ie.problemList,Ie.problems,Ie.history,Ie.medicalHistory].filter(Boolean),de=xe=>{if(!xe)return"";if(typeof xe=="string")return xe.trim();if(Array.isArray(xe))return xe.map(de).filter(Boolean).join(`
`);if(typeof xe=="object")try{return JSON.stringify(xe)}catch{return""}return String(xe)};for(const xe of we){const Ne=de(xe);if(Ne.trim().length>0){be.backgroundText=Ne.trim();break}}}catch(ce){console.warn("Failed to fetch clinical context for BP diary insights",ce)}return be},[]),H=m.useCallback(async(be,ce)=>{if(be.length===0){E(null),k(null),Q(!1);return}const Ie=++ee.current;Q(!0),k(null);try{const pe=ce??await S();if(ee.current!==Ie)return;w(pe);const fe=K.current,we=fe.getDefaultClinicalModel(),de=await fe.generateClinicalInsights(be,{medicationsText:pe.medicationsText,backgroundText:pe.backgroundText});if(ee.current!==Ie)return;E(de),M(xe=>({extraction:xe.extraction,reasoning:we}))}catch(pe){if(ee.current!==Ie)return;const fe=pe instanceof Error?pe.message:"Unable to generate clinical insights";E(null),k(fe),gt.getInstance().warning("Clinical insights unavailable",fe)}finally{ee.current===Ie&&Q(!1)}},[S]),Y=m.useCallback(async be=>{a(be),l("extracting"),A(""),E(null),k(null),w(null);try{const ce=K.current,Ie=ce.getDefaultClinicalModel(),pe=x||ce.getDefaultOCRModel(),fe=await ce.extractFromImage(be,void 0,x);if(!fe.success||fe.readings.length===0){l("error"),A(fe.error||"No readings could be extracted from the image"),gt.getInstance().error("Extraction failed","Could not extract BP readings from the image");return}l("validating");const we=$.current.validateAndSort(fe.readings);i(we),M({extraction:pe,reasoning:Ie}),l("ready"),gt.getInstance().success("Extraction complete",`Found ${we.length} BP reading${we.length!==1?"s":""}`),H(we)}catch(ce){l("error");const Ie=ce instanceof Error?ce.message:"Unknown error";A(Ie),gt.getInstance().error("Processing failed",Ie)}},[H,x]),te=m.useCallback(be=>{const ce=$.current.validateAndSort(be);i(ce)},[]),G=m.useCallback(()=>{n.length!==0&&H(n)},[H,n]),X=m.useCallback(()=>{const be=K.current;a(null),i([]),E(null),k(null),Q(!1),w(null),M({extraction:be.getDefaultOCRModel(),reasoning:be.getDefaultClinicalModel()}),b(be.getDefaultOCRModel()),l("idle"),A("")},[]),le=m.useCallback(async()=>{if(n.length!==0)try{const be=K.current,ce={id:`bp-session-${Date.now()}`,timestamp:Date.now(),imageDataUrl:r||"",readings:n,settings:d,insights:C??null,modelsUsed:{extraction:L.extraction||be.getDefaultOCRModel(),reasoning:L.reasoning||be.getDefaultClinicalModel()}};R&&(R.medicationsText||R.backgroundText)&&(ce.clinicalContext=R),await O.current.saveSession(ce),await O.current.saveSettings(d),gt.getInstance().success("Saved","BP diary session saved successfully")}catch(be){gt.getInstance().error("Save failed",be instanceof Error?be.message:"Unknown error")}},[R,r,C,L,n,d]),he=m.useCallback(async()=>{const be=await O.current.loadLatestSession();if(!be){gt.getInstance().info("No saved session","No previous BP diary found");return}a(be.imageDataUrl),i(be.readings),h(be.settings),E(be.insights??null),w(be.clinicalContext??null),Q(!1),k(null),M({extraction:be.modelsUsed?.extraction||K.current.getDefaultOCRModel(),reasoning:be.modelsUsed?.reasoning||K.current.getDefaultClinicalModel()}),be.modelsUsed?.extraction&&b(be.modelsUsed.extraction),l("ready"),u(!1),gt.getInstance().success("Loaded","Previous BP diary loaded")},[]),ve=m.useCallback(()=>{const be=$.current.getStatistics(n,d.sbpControlTarget),ce={exportDate:new Date().toISOString(),readingsCount:n.length,statistics:be,settings:{sbpControlTarget:d.sbpControlTarget,sbpControlGoal:d.sbpControlGoal,referenceSBP:d.referenceSBP,referenceDBP:d.referenceDBP},readings:n.map(de=>({date:de.date,time:de.time,sbp:de.sbp,dbp:de.dbp,hr:de.hr})),insights:C,modelsUsed:L};R&&(R.medicationsText||R.backgroundText)&&(ce.clinicalContext=R);const Ie=JSON.stringify(ce,null,2),pe=new Blob([Ie],{type:"application/json"}),fe=URL.createObjectURL(pe),we=document.createElement("a");we.href=fe,we.download=`bp-diary-${new Date().toISOString().split("T")[0]}.json`,we.click(),URL.revokeObjectURL(fe),gt.getInstance().success("Exported","BP diary exported as JSON")},[R,C,L,n,d]),ke=m.useCallback(()=>{const be=[];be.push("Date,Time,SBP (mmHg),DBP (mmHg),HR (bpm)"),n.forEach(we=>{be.push(`${we.date},${we.time},${we.sbp},${we.dbp},${we.hr}`)});const ce=be.join(`
`),Ie=new Blob([ce],{type:"text/csv"}),pe=URL.createObjectURL(Ie),fe=document.createElement("a");fe.href=pe,fe.download=`bp-diary-${new Date().toISOString().split("T")[0]}.csv`,fe.click(),URL.revokeObjectURL(pe),gt.getInstance().success("Exported","BP diary exported as CSV")},[n]),Le=m.useCallback(async()=>{P.current&&await P.current.copyToClipboard()},[]),Be=m.useCallback(()=>{h(be=>({...be,showReferenceLines:!be.showReferenceLines}))},[]);if(!s)return null;const Re=K.current.getDefaultOCRModel(),re=K.current.getDefaultClinicalModel(),Me=L.reasoning||re,Pe=n.length>0?$.current.getStatistics(n,d.sbpControlTarget):null;return t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:t.jsxs("div",{className:"bg-white rounded-modal shadow-modal max-w-7xl w-full max-h-[90vh] flex flex-col",children:[t.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-2xl font-semibold text-gray-900",children:"BP Diary Importer"}),t.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Upload a photo of your BP diary for automatic extraction, then review, edit, add, or delete readings"})]}),t.jsx(Zt,{onClick:e,icon:t.jsx(es,{}),variant:"ghost",size:"md","aria-label":"Close BP Diary Importer"})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-6",children:[o==="idle"&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Bp,{className:"w-4 h-4 text-blue-700"}),t.jsx("h3",{className:"text-sm font-semibold text-blue-900",children:"Vision Model"})]}),!j&&t.jsx(ye,{onClick:()=>I(!0),variant:"ghost",size:"sm",className:"text-xs text-blue-600 hover:text-blue-800 underline h-auto px-2 py-0",children:"Change"})]}),j?t.jsxs("div",{className:"space-y-2",children:[N.length>0?t.jsxs(t.Fragment,{children:[t.jsx("select",{value:x,onChange:be=>b(be.target.value),className:"w-full px-3 py-2 border border-blue-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:N.map(be=>t.jsx("option",{value:be,children:be},be))}),t.jsx("p",{className:"text-xs text-gray-600",children:"‚úì Showing only vision-capable models (LLaVA, Gemma, Qwen2-VL, etc.)"})]}):t.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded p-3",children:[t.jsx("p",{className:"text-xs text-yellow-800 font-semibold mb-1",children:"‚ö†Ô∏è No vision models detected"}),t.jsx("p",{className:"text-xs text-gray-600",children:"Load a vision model in LM Studio (e.g., LLaVA, Gemma-3n, Qwen2-VL)"})]}),t.jsx(ye,{onClick:()=>I(!1),variant:"ghost",size:"sm",className:"text-xs text-blue-600 hover:text-blue-800 h-auto px-2 py-1",children:"Done"})]}):t.jsxs("div",{className:"text-sm text-gray-700",children:["Using: ",t.jsx("span",{className:"font-mono font-semibold text-blue-700",children:x})]})]}),t.jsx(Rk,{onImageSelect:Y,currentImage:r,onClearImage:X}),t.jsx("div",{className:"flex justify-center",children:t.jsx(ye,{onClick:()=>u(!0),variant:"ghost",size:"md",startIcon:t.jsx(Xa,{className:"w-4 h-4"}),children:"Load Last Session"})})]}),(o==="extracting"||o==="validating")&&t.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[t.jsx("div",{className:"w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"}),t.jsx("p",{className:"text-gray-700 font-medium",children:o==="extracting"?"Extracting readings from image...":"Validating data..."}),t.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"This typically takes 10-30 seconds"})]}),o==="error"&&t.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-6",children:[t.jsx("div",{className:"text-yellow-800 font-semibold mb-2 text-center",children:"‚ö†Ô∏è Vision/OCR Not Yet Supported"}),t.jsx("p",{className:"text-sm text-gray-700 mb-4 text-center",children:c}),t.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4 mb-4 text-sm",children:[t.jsx("div",{className:"font-semibold text-gray-800 mb-2",children:"Workaround Options:"}),t.jsxs("ol",{className:"list-decimal list-inside space-y-2 text-gray-600",children:[t.jsx("li",{children:"Use the sample data button below to test the chart and editing features"}),t.jsx("li",{children:"Manually enter your BP readings by editing the sample data"}),t.jsxs("li",{children:["To enable OCR: install Tesseract.js (",t.jsx("code",{className:"bg-gray-100 px-1 rounded text-xs",children:"npm install tesseract.js"}),")"]})]})]}),t.jsxs("div",{className:"flex gap-3 justify-center",children:[t.jsx(ye,{onClick:X,variant:"outline",size:"md",children:"Clear & Start Over"}),t.jsx(ye,{onClick:()=>{i([{id:"1",date:"2025-09-09",time:"07:15",timeOfDay:"morning",sbp:144,dbp:85,hr:58,warnings:[]},{id:"2",date:"2025-09-10",time:"06:44",timeOfDay:"morning",sbp:137,dbp:85,hr:60,warnings:[]},{id:"3",date:"2025-09-11",time:"08:24",timeOfDay:"morning",sbp:146,dbp:81,hr:64,warnings:[]},{id:"4",date:"2025-09-12",time:"07:02",timeOfDay:"morning",sbp:123,dbp:87,hr:80,warnings:[]},{id:"5",date:"2025-09-15",time:"06:55",timeOfDay:"morning",sbp:140,dbp:87,hr:62,warnings:[]},{id:"6",date:"2025-09-16",time:"19:21",timeOfDay:"evening",sbp:136,dbp:88,hr:61,warnings:[]},{id:"7",date:"2025-09-17",time:"07:33",timeOfDay:"morning",sbp:140,dbp:85,hr:59,warnings:[]},{id:"8",date:"2025-09-24",time:"18:45",timeOfDay:"evening",sbp:144,dbp:87,hr:61,warnings:[]},{id:"9",date:"2025-09-25",time:"06:12",timeOfDay:"morning",sbp:140,dbp:84,hr:65,warnings:[]},{id:"10",date:"2025-09-26",time:"20:18",timeOfDay:"evening",sbp:140,dbp:81,hr:59,warnings:[]},{id:"11",date:"2025-09-28",time:"07:41",timeOfDay:"morning",sbp:143,dbp:87,hr:60,warnings:[]},{id:"12",date:"2025-09-29",time:"19:05",timeOfDay:"evening",sbp:145,dbp:88,hr:55,warnings:[]}]),l("ready"),gt.getInstance().info("Sample data loaded","12 readings - test UI layout")},variant:"secondary",size:"md",children:"Load Sample Data (12 readings)"})]})]}),o==="ready"&&n.length>0&&t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Ma,{className:"w-5 h-5 text-blue-700"}),t.jsx("h3",{className:"text-lg font-semibold text-blue-900",children:"Clinical Insights"})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-xs text-blue-800",children:[t.jsxs("span",{children:["Models:¬†",t.jsxs("span",{className:"font-mono",children:[L.extraction||Re," ‚Üí ",Me]})]}),T&&t.jsx("span",{className:"text-blue-600",children:"MedGemma-27B running‚Ä¶"}),!T&&C&&t.jsx("span",{className:"text-blue-600",children:"MedGemma insights ready"})]}),R&&(R.medicationsText||R.backgroundText)&&t.jsxs("div",{className:"bg-white/70 border border-blue-100 rounded-lg p-3 space-y-2",children:[R.medicationsText&&t.jsxs("div",{children:[t.jsx("div",{className:"text-[11px] font-semibold text-blue-900 uppercase tracking-wide",children:"Medications"}),t.jsx("div",{className:"text-xs text-gray-700 whitespace-pre-line",children:R.medicationsText})]}),R.backgroundText&&t.jsxs("div",{children:[t.jsx("div",{className:"text-[11px] font-semibold text-blue-900 uppercase tracking-wide",children:"Background"}),t.jsx("div",{className:"text-xs text-gray-700 whitespace-pre-line",children:R.backgroundText})]})]}),T&&t.jsxs("div",{className:"bg-white rounded-lg p-4 flex items-center gap-3 border border-blue-100",children:[t.jsx("div",{className:"w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"}),t.jsx("div",{className:"text-sm text-gray-700",children:"Generating clinician and patient insights‚Ä¶"})]}),!T&&D&&t.jsxs("div",{className:"bg-white border border-yellow-200 rounded-lg p-4 space-y-3",children:[t.jsx("div",{className:"text-sm text-yellow-800",children:D}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(ye,{onClick:G,variant:"outline",size:"sm",className:"text-xs font-medium text-blue-700 border-blue-200 hover:bg-blue-100",children:"Retry insights"}),t.jsx("span",{className:"text-xs text-gray-500",children:"Readings remain available for review."})]})]}),!T&&!D&&C&&t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"grid gap-3 md:grid-cols-2",children:[t.jsxs("div",{className:"bg-white rounded-lg p-3",children:[t.jsx("div",{className:"text-xs font-semibold text-gray-600 mb-1",children:"Control Summary"}),t.jsx("div",{className:"text-sm text-gray-900",children:C.controlSummary})]}),t.jsxs("div",{className:"bg-white rounded-lg p-3",children:[t.jsx("div",{className:"text-xs font-semibold text-gray-600 mb-1",children:"Diurnal Pattern"}),t.jsx("div",{className:"text-sm text-gray-900",children:C.diurnalPattern})]})]}),t.jsxs("div",{className:"grid gap-3 md:grid-cols-2",children:[t.jsxs("div",{className:"bg-white rounded-lg p-3",children:[t.jsx("div",{className:"text-xs font-semibold text-gray-600 mb-1",children:"Variability"}),t.jsx("div",{className:"text-sm text-gray-900",children:C.variabilityConcern})]}),C.medicationRationale&&t.jsxs("div",{className:"bg-white rounded-lg p-3",children:[t.jsx("div",{className:"text-xs font-semibold text-gray-600 mb-1",children:"Medication Rationale"}),t.jsx("div",{className:"text-sm text-gray-900",children:C.medicationRationale})]})]}),(C.peakTimes||C.lowestTimes||C.abpmSuggestion)&&t.jsxs("div",{className:"grid gap-3 md:grid-cols-3",children:[C.peakTimes&&t.jsxs("div",{className:"bg-white rounded-lg p-3",children:[t.jsx("div",{className:"text-xs font-semibold text-gray-600 mb-1",children:"Peak Times"}),t.jsx("div",{className:"text-sm text-gray-900",children:C.peakTimes})]}),C.lowestTimes&&t.jsxs("div",{className:"bg-white rounded-lg p-3",children:[t.jsx("div",{className:"text-xs font-semibold text-gray-600 mb-1",children:"Best Control"}),t.jsx("div",{className:"text-sm text-gray-900",children:C.lowestTimes})]}),C.abpmSuggestion&&t.jsxs("div",{className:"bg-white rounded-lg p-3 md:col-span-1",children:[t.jsx("div",{className:"text-xs font-semibold text-gray-600 mb-1",children:"Next Clinical Step"}),t.jsx("div",{className:"text-sm text-gray-900",children:C.abpmSuggestion})]})]}),t.jsxs("div",{className:"bg-white rounded-lg p-3",children:[t.jsx("div",{className:"text-xs font-semibold text-gray-600 mb-2",children:"Key Recommendations"}),t.jsx("ul",{className:"space-y-1.5",children:C.keyRecommendations.map((be,ce)=>t.jsxs("li",{className:"flex items-start gap-2 text-sm text-gray-900",children:[t.jsxs("span",{className:"text-blue-600 font-semibold mt-0.5",children:[ce+1,"."]}),t.jsx("span",{children:be})]},ce))})]}),C.patientParagraph&&t.jsxs("div",{className:"bg-white border border-blue-100 rounded-lg p-4",children:[t.jsx("div",{className:"text-xs font-semibold text-blue-900 mb-1",children:"Patient-Facing Summary"}),t.jsx("div",{className:"text-sm text-gray-900 whitespace-pre-line",children:C.patientParagraph})]})]}),!T&&!D&&!C&&t.jsx("div",{className:"bg-white rounded-lg p-4 border border-dashed border-blue-200 text-sm text-gray-600",children:"Clinical insights will appear here once MedGemma finishes processing."})]}),Pe&&t.jsxs("div",{className:"space-y-1.5",children:[t.jsxs("div",{className:"grid grid-cols-3 gap-1.5",children:[t.jsxs("div",{className:"bg-gray-50 rounded-lg p-2 flex flex-col justify-between h-16",children:[t.jsx("div",{className:"text-[10px] text-gray-600 leading-tight",children:"Average SBP"}),t.jsx("div",{className:"text-xl font-bold text-gray-900 leading-none",children:Pe.avgSBP}),t.jsx("div",{className:"text-[9px] text-gray-500 leading-tight",children:"mmHg"})]}),t.jsxs("div",{className:"bg-gray-50 rounded-lg p-2 flex flex-col justify-between h-16",children:[t.jsx("div",{className:"text-[10px] text-gray-600 leading-tight",children:"Average DBP"}),t.jsx("div",{className:"text-xl font-bold text-gray-900 leading-none",children:Pe.avgDBP}),t.jsx("div",{className:"text-[9px] text-gray-500 leading-tight",children:"mmHg"})]}),t.jsxs("div",{className:"bg-gray-50 rounded-lg p-2 flex flex-col justify-between h-16",children:[t.jsx("div",{className:"text-[10px] text-gray-600 leading-tight",children:"Average HR"}),t.jsx("div",{className:"text-xl font-bold text-gray-900 leading-none",children:Pe.avgHR}),t.jsx("div",{className:"text-[9px] text-gray-500 leading-tight",children:"bpm"})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-1.5",children:[t.jsxs("div",{className:"bg-gray-50 rounded-lg p-2 flex flex-col justify-between h-16",children:[t.jsx("div",{className:"text-[10px] text-gray-600 leading-tight",children:"Above Target"}),t.jsxs("div",{className:"text-xl font-bold text-gray-900 leading-none",children:[Pe.percentAboveTarget,"%"]}),t.jsx("div",{className:"text-[9px] text-gray-500 leading-tight",children:">135/85 mmHg"})]}),t.jsxs("div",{className:`rounded-lg p-2 flex flex-col justify-between h-16 ${Pe.percentSBPBelowTarget>=d.sbpControlGoal?"bg-green-50 border border-green-200":Pe.percentSBPBelowTarget>=d.sbpControlGoal-10?"bg-yellow-50 border border-yellow-200":"bg-gray-50 border border-gray-200"}`,children:[t.jsx("div",{className:"text-[10px] text-gray-600 leading-tight",children:"SBP Control"}),t.jsxs("div",{className:`text-xl font-bold leading-none ${Pe.percentSBPBelowTarget>=d.sbpControlGoal?"text-green-700":Pe.percentSBPBelowTarget>=d.sbpControlGoal-10?"text-yellow-700":"text-gray-900"}`,children:[Pe.percentSBPBelowTarget,"%"]}),t.jsxs("div",{className:"text-[9px] text-gray-500 leading-tight",children:["<",d.sbpControlTarget," mmHg (goal ",d.sbpControlGoal,"%)"]})]})]})]}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Review & Edit Readings"}),n.length<15&&t.jsx("p",{className:"text-xs text-gray-500",children:'Tip: Use "Add New Reading" button below to manually add any missed readings'})]}),t.jsx(Mk,{readings:n,onReadingsChange:te,editable:!0})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Trend Chart"}),t.jsx("div",{className:"bg-white border border-gray-200 rounded-lg p-2",children:t.jsx(Kv,{ref:P,readings:n,showReferenceLines:d.showReferenceLines,referenceSBP:d.referenceSBP,referenceDBP:d.referenceDBP})}),t.jsx("div",{className:"flex justify-center mt-2",children:t.jsxs("label",{className:"flex items-center gap-1.5 text-xs text-gray-500 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:d.showReferenceLines,onChange:Be,className:"rounded border-gray-300 w-3 h-3"}),"Show guidelines (130/80)"]})})]})]}),f&&t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 z-60 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-card shadow-modal p-6 max-w-md",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Load Last Session?"}),t.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"This will replace your current work with the last saved BP diary session."}),t.jsxs("div",{className:"flex gap-3",children:[t.jsx(ye,{onClick:()=>u(!1),variant:"outline",size:"md",fullWidth:!0,children:"Cancel"}),t.jsx(ye,{onClick:he,variant:"secondary",size:"md",fullWidth:!0,children:"Load"})]})]})})]}),t.jsxs("div",{className:"flex items-center justify-between p-4 border-t border-gray-200 bg-gray-50 rounded-b-xl gap-4 flex-wrap",children:[t.jsx("div",{className:"flex items-center gap-2",children:o==="ready"&&t.jsx(ye,{onClick:X,variant:"ghost",size:"sm",startIcon:t.jsx(Ln,{className:"w-3.5 h-3.5"}),className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:"Clear"})}),t.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[o==="ready"&&n.length>0&&t.jsxs(t.Fragment,{children:[t.jsx(ye,{onClick:ve,variant:"ghost",size:"sm",startIcon:t.jsx(b2,{className:"w-3.5 h-3.5"}),children:"Export JSON"}),t.jsx(ye,{onClick:ke,variant:"ghost",size:"sm",startIcon:t.jsx(Rn,{className:"w-3.5 h-3.5"}),children:"Export CSV"}),t.jsx(ye,{onClick:Le,variant:"ghost",size:"sm",startIcon:t.jsx(CA,{className:"w-3.5 h-3.5"}),children:"Copy Chart"}),t.jsx(ye,{onClick:le,variant:"success",size:"sm",startIcon:t.jsx(Ra,{className:"w-3.5 h-3.5"}),children:"Accept & Save"})]}),t.jsx(ye,{onClick:e,variant:"ghost",size:"sm",children:"Close"})]})]})]})})},Qk=[{value:"TTE",label:"TTE (Transthoracic Echo)"},{value:"TOE",label:"TOE (Transoesophageal Echo)"},{value:"CTCA",label:"CTCA (CT Coronary Angiogram)"},{value:"Stress Echo",label:"Stress Echo"},{value:"ECG",label:"ECG"},{value:"Holter",label:"Holter Monitor"},{value:"CXR",label:"Chest X-ray"},{value:"RHC",label:"RHC (Right Heart Cath)"},{value:"Coronary Angiogram",label:"Coronary Angiogram"},{value:"Bloods",label:"Blood Tests"},{value:"Calcium Score",label:"Calcium Score"},{value:"MRI Cardiac",label:"Cardiac MRI"},{value:"Custom",label:"Custom (specify below)"}];class Yo{static instance;lmStudioService;constructor(){this.lmStudioService=Ei.getInstance()}static getInstance(){return Yo.instance||(Yo.instance=new Yo),Yo.instance}getDefaultOCRModel(){return this.lmStudioService.getDefaultOCRModel()}async extractFromImage(e,r,a,n,i){const o=Date.now();try{const l=this.getDefaultOCRModel(),c=i||l,A=this.validateImage(e);if(A)return{success:!1,extractedText:"",investigationType:r,investigationDate:a,error:A,processingTime:Date.now()-o};bt.info("Starting investigation image extraction",{component:"investigation-image-extractor",imageSize:e.length,imageSizeMB:(e.length/(1024*1024)).toFixed(2),investigationType:r,investigationDate:a,model:c});const d=this.buildExtractionPrompt(r),h=await this.lmStudioService.processWithVisionAgent(this.getSystemPrompt(r),d,e,"investigation-image-extraction",n,c);bt.info("Received LM Studio response",{component:"investigation-image-extractor",responseLength:h.length,responsePreview:h.substring(0,100)});const f=h.trim();if(f===""||f.length<10)return bt.warn("Vision model returned empty response",{component:"investigation-image-extractor",response:f,modelUsed:c}),{success:!1,extractedText:"",investigationType:r,investigationDate:a,error:`Vision model could not extract any findings from the image. This may indicate:

1. The image quality may be too poor for the model to read
2. The model (${c}) may not be properly loaded with vision support
3. The image may not contain recognizable medical report data

Try:
- Using a clearer photo with better lighting
- Ensuring the entire report is visible in the image
- Using a different vision-capable model`,processingTime:Date.now()-o};const u=Date.now()-o;return bt.info("Investigation image extraction complete",{component:"investigation-image-extractor",extractedLength:f.length,processingTime:u,modelUsed:c}),{success:!0,extractedText:f,investigationType:r,investigationDate:a,rawResponse:h,processingTime:u}}catch(l){const c=Date.now()-o,A=l instanceof Error?l.message:"Unknown error";return bt.error("Investigation image extraction failed",{component:"investigation-image-extractor",error:A,processingTime:c}),{success:!1,extractedText:"",investigationType:r,investigationDate:a,error:A,processingTime:c}}}getSystemPrompt(e){return`You are a medical data extraction specialist with vision capabilities, specialized in reading and extracting findings from ${e} medical reports.

Your task is to:
1. LOOK AT the provided image carefully and identify all medical findings
2. Extract key measurements, values, and clinical observations
3. Preserve medical terminology and abbreviations (e.g., LV, RV, EF, LVEDD, LVESD, GLS, TAPSE, TR, MR, AR)
4. Maintain numerical values with their units (mmHg, cm, mL, %, etc.)
5. Extract both normal and abnormal findings
6. Preserve the structure of findings (e.g., chamber sizes, valve function, pressures)

Output format:
- Return the extracted findings as clear, readable text
- Use natural language that can be spoken (as if dictating the report)
- Do NOT use JSON, tables, or code blocks
- Include all relevant clinical information visible in the report
- Preserve severity descriptors (mild, moderate, severe)
- Include any conclusions or impressions from the report

If the image is unclear or unreadable, describe what you can see and indicate which parts are unclear.`}buildExtractionPrompt(e){const r=this.getTypeSpecificInstructions(e);return`VISION TASK: You are analyzing a ${e} medical report image. Extract all relevant findings.

${r}

EXTRACTION GUIDELINES:
1. Read the entire report from top to bottom
2. Extract ALL measurements and values with their units
3. Note all normal AND abnormal findings
4. Preserve medical abbreviations (do not expand them)
5. Include severity descriptors (mild, moderate, severe, trivial)
6. Extract any conclusions or clinical impressions

OUTPUT FORMAT:
- Write the findings as clear text that could be dictated
- Use natural sentence structure
- Group related findings together
- Include all relevant clinical information
- Do NOT use JSON, markdown formatting, or tables

Now, examine the provided image and extract all visible medical findings.`}getTypeSpecificInstructions(e){return{TTE:`FOCUS ON:
- LV size and function (LVEDD, LVESD, EF, GLS)
- RV size and function (TAPSE, RV S')
- Chamber sizes (LA, RA volumes/dimensions)
- Valve function (MR, TR, AR, PR grades)
- Valve gradients and areas
- Diastolic function parameters
- Pericardium and any effusions
- Wall motion abnormalities`,TOE:`FOCUS ON:
- Valve morphology and function
- LA appendage (thrombus, flow velocities)
- Interatrial septum (PFO, ASD)
- Mitral valve details (leaflet pathology, regurgitation mechanism)
- Prosthetic valve assessment
- Endocarditis findings
- Aortic pathology`,CTCA:`FOCUS ON:
- Coronary artery stenoses (vessel, location, severity %)
- Plaque characterisation (calcified, mixed, non-calcified)
- Calcium score (Agatston)
- Anomalies or variants
- Non-coronary findings
- Technical quality`,"Stress Echo":`FOCUS ON:
- Resting LV function and wall motion
- Peak stress response
- New or worsening wall motion abnormalities
- Exercise capacity (METs, duration, stage)
- Symptoms during test
- ECG changes
- Blood pressure and heart rate response`,RHC:`FOCUS ON:
- Right atrial pressure (mean)
- RV pressures (systolic, diastolic)
- PA pressures (systolic, diastolic, mean)
- PCWP
- Cardiac output/index (Fick/thermodilution)
- PVR and SVR
- Oxygen saturations
- Any shunt quantification`,Bloods:`FOCUS ON:
- Full blood count values
- Renal function (Cr, eGFR, urea)
- Electrolytes
- Liver function tests
- Lipid profile
- Cardiac biomarkers (troponin, BNP/NT-proBNP)
- HbA1c, glucose
- Inflammatory markers
- Any flagged abnormal values`}[e]||`FOCUS ON:
- Key measurements and values
- Normal and abnormal findings
- Clinical conclusions
- Any diagnostic impressions`}validateImage(e){if(!e||e.length===0)return"No image data provided";if(!e.startsWith("data:image/"))return'Invalid image format. Expected data URL starting with "data:image/"';const r=e.substring(5,e.indexOf(";"));if(!["image/jpeg","image/jpg","image/png","image/webp"].includes(r))return`Unsupported image type: ${r}. Supported types: JPEG, PNG, WebP`;const i=e.length/(1024*1024);return i>10?`Image too large (${i.toFixed(1)}MB). Maximum size is 10MB. Please compress or resize the image.`:(i>5&&bt.warn("Large image detected",{component:"investigation-image-extractor",sizeMB:i.toFixed(2),message:"Image is large and may take longer to process"}),null)}formatDateForAgent(e){const r=e.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);if(!r)return e;const[,a,n,i]=r,o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],l=parseInt(n,10)-1;return`${parseInt(a,10)} ${o[l]} ${i}`}}const Ok=({isOpen:s,onClose:e,onProcess:r,isProcessing:a=!1})=>{const[n,i]=m.useState(null),[o,l]=m.useState("TTE"),[c,A]=m.useState(""),[d,h]=m.useState(()=>{const k=new Date,R=String(k.getDate()).padStart(2,"0"),w=String(k.getMonth()+1).padStart(2,"0"),L=k.getFullYear();return`${R}/${w}/${L}`}),[f,u]=m.useState(!1),[x,b]=m.useState(null),N=m.useRef(null),v=m.useCallback(k=>{k.preventDefault(),u(!0)},[]),j=m.useCallback(k=>{k.preventDefault(),u(!1)},[]),I=m.useCallback(k=>{k.preventDefault(),u(!1),b(null);const R=k.dataTransfer.files;R.length>0&&E(R[0])},[]),C=m.useCallback(k=>{b(null);const R=k.target.files;R&&R.length>0&&E(R[0])},[]),E=m.useCallback(k=>{if(!["image/jpeg","image/jpg","image/png","image/webp"].includes(k.type)){b("Invalid file type. Please use JPEG, PNG, or WebP images.");return}if(k.size>10*1024*1024){b("Image too large. Maximum size is 10MB.");return}const w=new FileReader;w.onload=L=>{const M=L.target?.result;i(M),b(null)},w.onerror=()=>{b("Failed to read image file.")},w.readAsDataURL(k)},[]),T=m.useCallback(()=>{i(null),N.current&&(N.current.value="")},[]),Q=m.useCallback(async()=>{if(!n){b("Please upload an image first.");return}const k=o==="Custom"?c:o;if(!k.trim()){b("Please specify the investigation type.");return}if(!d.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)){b("Please enter a valid date in DD/MM/YYYY format.");return}try{await r(n,k,d)}catch(R){b(R instanceof Error?R.message:"Processing failed")}},[n,o,c,d,r]),D=m.useCallback(k=>{let R=k.target.value.replace(/[^0-9/]/g,"");(R.length===2&&!R.includes("/")||R.length===5&&R.split("/").length===2)&&(R=R+"/"),R.length<=10&&h(R)},[]);return s?t.jsx(as,{children:t.jsx(Ye.div,{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:e,children:t.jsxs(Ye.div,{className:"bg-white rounded-modal shadow-modal w-full max-w-lg mx-4 overflow-hidden",initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},onClick:k=>k.stopPropagation(),children:[t.jsxs("div",{className:"p-4 border-b border-gray-200 flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx(v2,{className:"w-5 h-5 text-blue-600"}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-gray-900 font-semibold text-sm",children:"Scan Investigation Report"}),t.jsx("p",{className:"text-gray-500 text-xs",children:"Upload a photo or screenshot"})]})]}),t.jsx(Zt,{onClick:e,variant:"ghost",size:"sm",icon:es,"aria-label":"Close",disabled:a})]}),t.jsxs("div",{className:"p-4 space-y-4",children:[n?t.jsxs("div",{className:"relative rounded-xl overflow-hidden bg-gray-100",children:[t.jsx("img",{src:n,alt:"Investigation report preview",className:"w-full h-48 object-contain"}),t.jsx(Zt,{onClick:T,variant:"ghost",size:"sm",icon:Ln,"aria-label":"Remove image",className:"absolute top-2 right-2 bg-white/90 hover:bg-white shadow-sm",disabled:a})]}):t.jsxs("div",{className:`
                  border-2 border-dashed rounded-xl p-8
                  flex flex-col items-center justify-center
                  transition-colors cursor-pointer
                  ${f?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400 bg-gray-50"}
                `,onDragOver:v,onDragLeave:j,onDrop:I,onClick:()=>N.current?.click(),children:[t.jsx(BA,{className:`w-10 h-10 mb-3 ${f?"text-blue-500":"text-gray-400"}`}),t.jsx("p",{className:"text-sm font-medium text-gray-700 mb-1",children:f?"Drop image here":"Drag and drop image"}),t.jsx("p",{className:"text-xs text-gray-500",children:"or click to browse (JPEG, PNG, WebP)"}),t.jsx("input",{ref:N,type:"file",accept:"image/jpeg,image/jpg,image/png,image/webp",onChange:C,className:"hidden"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1.5",children:"Investigation Type"}),t.jsx("select",{value:o,onChange:k=>l(k.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white",disabled:a,children:Qk.map(k=>t.jsx("option",{value:k.value,children:k.label},k.value))}),o==="Custom"&&t.jsx("input",{type:"text",value:c,onChange:k=>A(k.target.value),placeholder:"Enter investigation type...",className:"mt-2 w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",disabled:a})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1.5",children:t.jsxs("span",{className:"flex items-center space-x-1",children:[t.jsx(Da,{className:"w-3.5 h-3.5"}),t.jsx("span",{children:"Investigation Date"})]})}),t.jsx("input",{type:"text",value:d,onChange:D,placeholder:"DD/MM/YYYY",className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",disabled:a}),t.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Australian date format"})]}),x&&t.jsxs("div",{className:"flex items-start space-x-2 p-3 bg-red-50 rounded-lg",children:[t.jsx(or,{className:"w-4 h-4 text-red-500 flex-shrink-0 mt-0.5"}),t.jsx("p",{className:"text-xs text-red-700",children:x})]})]}),t.jsxs("div",{className:"p-4 bg-gray-50 border-t border-gray-200 flex items-center justify-between",children:[t.jsx("p",{className:"text-xs text-gray-500",children:"AI will extract findings from the image"}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(ye,{onClick:e,variant:"outline",size:"sm",disabled:a,children:"Cancel"}),t.jsx(ye,{onClick:Q,variant:"primary",size:"sm",disabled:!n||a,children:a?t.jsxs(t.Fragment,{children:[t.jsx(Za,{className:"w-4 h-4 mr-1.5 animate-spin"}),"Processing..."]}):"Process Image"})]})]})]})})}):null},Hk=({isVisible:s,isGenerating:e,onClose:r,onGenerate:a,extractionError:n,onRetryExtraction:i})=>{const[o,l]=m.useState(""),[c,A]=m.useState(!1),[d,h]=m.useState(n),f=m.useRef(null);m.useEffect(()=>{s&&f.current&&f.current.focus()},[s]),m.useEffect(()=>{h(n)},[n]);const u=m.useCallback(v=>{(v.metaKey||v.ctrlKey)&&v.key==="Enter"&&(v.preventDefault(),o.trim()&&!e&&x()),v.key==="Escape"&&!e&&(v.preventDefault(),r())},[o,e,r]),x=m.useCallback(async()=>{if(!o.trim()){h("Please enter some clinical notes to generate a letter");return}h(void 0);try{await a(o,c),l(""),A(!1)}catch(v){h(v instanceof Error?v.message:"Failed to generate letter")}},[o,c,a]),b=m.useCallback(()=>{e||(l(""),A(!1),h(void 0),r())},[e,r]),N=m.useCallback(async()=>{if(i){h(void 0);try{await i()}catch(v){h(v instanceof Error?v.message:"Failed to extract EMR data")}}},[i]);return s?t.jsx(as,{children:t.jsx(Ye.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.15},className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:b,children:t.jsxs(Ye.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},transition:{duration:.15},className:"bg-white rounded-modal shadow-modal max-w-2xl w-full border-2 border-gray-200",onClick:v=>v.stopPropagation(),role:"dialog","aria-labelledby":"paste-notes-title","aria-describedby":"paste-notes-description",children:[t.jsx("div",{className:"px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-green-50 to-emerald-50",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx("div",{className:"w-10 h-10 rounded-xl bg-green-100 flex items-center justify-center",children:t.jsx(Rn,{className:"w-5 h-5 text-green-600"})}),t.jsxs("div",{children:[t.jsx("h3",{id:"paste-notes-title",className:"text-lg font-semibold text-gray-900",children:"Paste Clinical Notes"}),t.jsx("p",{id:"paste-notes-description",className:"text-xs text-gray-600",children:"Type or paste your clinic notes to generate a letter"})]})]}),t.jsx(Zt,{onClick:b,disabled:e,icon:es,variant:"ghost",size:"sm","aria-label":"Close paste notes panel",className:"text-gray-500 hover:text-gray-700"})]})}),t.jsxs("div",{className:"px-6 py-4 space-y-4",children:[d&&t.jsxs(Ye.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"bg-red-50 border border-red-200 rounded-lg p-3 flex items-start space-x-2",children:[t.jsx(or,{className:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"text-sm font-medium text-red-800",children:d}),i&&t.jsx(ye,{onClick:N,variant:"ghost",size:"sm",className:"mt-2 text-xs text-red-600 hover:text-red-800 underline p-0 h-auto",children:"Retry EMR extraction"})]})]}),t.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:t.jsxs("div",{className:"text-sm text-blue-800",children:[t.jsx("strong",{children:"Quick tips:"}),t.jsxs("ul",{className:"mt-1 space-y-1 text-xs",children:[t.jsx("li",{children:'‚Ä¢ Use shorthand: "FU HTN", "‚Üë perindopril to 5 mg od", "stop amlo"'}),t.jsx("li",{children:"‚Ä¢ Include key info: purpose, diagnosis, plan, medication changes"}),t.jsxs("li",{children:["‚Ä¢ Press ",t.jsx("kbd",{className:"px-1 py-0.5 bg-blue-100 rounded text-blue-900",children:"‚åò/Ctrl+Enter"})," to generate"]})]})]})}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"paste-notes-textarea",className:"block text-sm font-medium text-gray-700 mb-2",children:"Clinical Notes"}),t.jsx("textarea",{ref:f,id:"paste-notes-textarea",value:o,onChange:v=>l(v.target.value),onKeyDown:u,disabled:e,placeholder:"e.g., FU HTN. BP 145/90. ‚Üë perindopril to 5 mg od. Stop amlodipine due to ankle oedema. Review in 4 weeks with home BP diary.",className:"w-full h-40 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent resize-y disabled:opacity-50 disabled:cursor-not-allowed font-mono text-sm",style:{minHeight:"120px"},"aria-describedby":"notes-hint"}),t.jsxs("div",{id:"notes-hint",className:"mt-1 text-xs text-gray-500",children:[o.length," characters ‚Ä¢ ",o.split(`
`).length," lines"]})]}),t.jsxs("div",{className:"flex items-start space-x-2",children:[t.jsx("input",{type:"checkbox",id:"include-patient-friendly",checked:c,onChange:v=>A(v.target.checked),disabled:e,className:"mt-1 h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded disabled:opacity-50"}),t.jsxs("label",{htmlFor:"include-patient-friendly",className:"text-sm text-gray-700",children:[t.jsx("div",{className:"font-medium",children:"Include patient-friendly version"}),t.jsx("div",{className:"text-xs text-gray-500",children:"Generate an additional letter in plain language for the patient"})]})]})]}),t.jsx("div",{className:"px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-2xl",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("div",{className:"text-xs text-gray-500",children:e?t.jsxs("span",{className:"flex items-center space-x-2",children:[t.jsx(Au,{className:"w-4 h-4 animate-spin"}),t.jsx("span",{children:"Generating letter (max 30s)..."})]}):t.jsx("span",{children:"Keyboard shortcuts: ‚åò/Ctrl+Enter to generate, Esc to close"})}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(ye,{onClick:b,disabled:e,variant:"outline",size:"md",children:"Cancel"}),t.jsx(ye,{onClick:x,disabled:!o.trim()||e,variant:"success",size:"md",isLoading:e,startIcon:e?Au:void 0,children:e?"Generating...":"Generate Letter"})]})]})})]})})}):null},Dc=[{id:"purpose",title:"Letter Purpose",question:"What is the purpose of this letter?",type:"select",options:[{value:"referral",label:"Referral to specialist"},{value:"follow-up",label:"Follow-up consultation"},{value:"results",label:"Investigation results"},{value:"discharge",label:"Discharge summary"}]},{id:"diagnosis",title:"Primary Problem",question:"What is the primary problem or diagnosis?",type:"text",placeholder:"e.g., Hypertension, Atrial fibrillation, Chest pain"},{id:"plan",title:"Plan",question:"What are the recommendations or plan?",type:"textarea",placeholder:"e.g., Continue current medications, arrange echo, review in 4 weeks"},{id:"medications",title:"Medication Changes",question:"Are there any medication changes?",type:"textarea",placeholder:'e.g., Increase perindopril to 5 mg od, stop amlodipine, or "no medication changes"'}],Vk=({isVisible:s,missingFields:e,onComplete:r,onCancel:a,prefillData:n})=>{const[i,o]=m.useState(0),[l,c]=m.useState({purpose:"",diagnosis:n?.diagnosis||"",plan:n?.plan||"",medications:""}),[A,d]=m.useState({}),h=Dc[i],f=m.useCallback(()=>{const v=l[h.id];return!v||v.trim().length===0?(d({[h.id]:"This field is required"}),!1):(d({}),!0)},[l,h.id]),u=m.useCallback(()=>{if(f())if(i<Dc.length-1)o(i+1);else{const v={purpose:l.purpose,diagnosis:l.diagnosis,plan:l.plan,medications:l.medications};r(v)}},[i,l,f,r]),x=m.useCallback(()=>{i>0&&(o(i-1),d({}))},[i]),b=m.useCallback(v=>{c(j=>({...j,[h.id]:v})),d({})},[h.id]),N=m.useCallback(v=>{v.key==="Escape"&&(v.preventDefault(),a()),v.key==="Enter"&&h.type==="select"&&(v.preventDefault(),u())},[h.type,u,a]);return s?t.jsx(as,{children:t.jsx(Ye.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.15},className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",onClick:a,children:t.jsxs(Ye.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},transition:{duration:.15},className:"bg-white rounded-modal shadow-modal max-w-xl w-full border-2 border-amber-200",onClick:v=>v.stopPropagation(),role:"dialog","aria-labelledby":"stepper-title","aria-describedby":"stepper-description",children:[t.jsxs("div",{className:"px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-amber-50 to-yellow-50",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx("div",{className:"w-10 h-10 rounded-xl bg-amber-100 flex items-center justify-center",children:t.jsx(xr,{className:"w-5 h-5 text-amber-600"})}),t.jsxs("div",{children:[t.jsx("h3",{id:"stepper-title",className:"text-lg font-semibold text-gray-900",children:"Additional Information Needed"}),t.jsxs("p",{id:"stepper-description",className:"text-xs text-gray-600",children:["Step ",i+1," of ",Dc.length]})]})]}),t.jsx(Zt,{onClick:a,icon:t.jsx(es,{}),variant:"ghost",size:"md","aria-label":"Close stepper",className:"text-gray-500 hover:text-gray-700"})]}),t.jsx("div",{className:"mt-4",children:t.jsx("div",{className:"flex items-center space-x-1",children:Dc.map((v,j)=>t.jsx("div",{className:`flex-1 h-2 rounded-full transition-colors ${j<i?"bg-green-500":j===i?"bg-amber-500":"bg-gray-200"}`},v.id))})})]}),t.jsxs("div",{className:"px-6 py-6 space-y-4",children:[e.length>0&&i===0&&t.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-3",children:t.jsxs("div",{className:"text-sm text-amber-800",children:[t.jsx("strong",{children:"Missing information:"}),t.jsx("ul",{className:"mt-1 space-y-1 text-xs",children:e.map((v,j)=>t.jsxs("li",{children:["‚Ä¢ ",v]},j))})]})}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:`step-${h.id}`,className:"block text-lg font-medium text-gray-900 mb-2",children:h.question}),h.type==="select"&&t.jsxs("select",{id:`step-${h.id}`,value:l[h.id],onChange:v=>b(v.target.value),onKeyDown:N,className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent text-base",autoFocus:!0,children:[t.jsx("option",{value:"",children:"Select an option..."}),h.options?.map(v=>t.jsx("option",{value:v.value,children:v.label},v.value))]}),h.type==="text"&&t.jsx("input",{type:"text",id:`step-${h.id}`,value:l[h.id],onChange:v=>b(v.target.value),onKeyDown:N,placeholder:h.placeholder,className:"w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent text-base",autoFocus:!0}),h.type==="textarea"&&t.jsx("textarea",{id:`step-${h.id}`,value:l[h.id],onChange:v=>b(v.target.value),onKeyDown:N,placeholder:h.placeholder,className:"w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent resize-y text-base",autoFocus:!0}),A[h.id]&&t.jsx(Ye.div,{initial:{opacity:0,y:-5},animate:{opacity:1,y:0},className:"mt-2 text-sm text-red-600",children:A[h.id]})]})]}),t.jsx("div",{className:"px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-2xl",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx(ye,{onClick:x,disabled:i===0,variant:"outline",size:"sm",startIcon:t.jsx(Np,{}),className:"bg-white",children:"Back"}),t.jsx("div",{className:"text-xs text-gray-500",children:"Press Enter to continue ‚Ä¢ Esc to cancel"}),t.jsx(ye,{onClick:u,variant:"primary",size:"sm",endIcon:t.jsx(ti,{}),className:"bg-amber-600 hover:bg-amber-700",children:i===Dc.length-1?"Complete":"Next"})]})})]})})}):null},$k=/bloods?\s*\(([^)]+)\)\s*:\s*(.+)$/i,Kk=/(ldl-?c?|total\s+chol(?:esterol)?|tchol|tc|hdl|tg|trig(?:lycerides)?|apob|apo\s*b|non[-\s]*hdl)/i,Gk=/([-+]?\d+(?:\.\d+)?)/,p0=/\(([^)]+)\)\s*$/,zk=/(off\s+statin|pre[-\s]?therapy|baseline|statin\s*naive|no\s+statin|untreated)/i;function Wk(s){const r=s.trim().replace(/\./g,"").replace(/st|nd|rd|th/gi,"").split(/\s+/);if(r.length<3)return null;const[a,n,i]=r,o=parseInt(a,10);if(Number.isNaN(o))return null;const l=n.toLowerCase(),c=parseInt(i,10);if(Number.isNaN(c))return null;const d={jan:0,january:0,feb:1,february:1,mar:2,march:2,apr:3,april:3,may:4,jun:5,june:5,jul:6,july:6,aug:7,august:7,sep:8,sept:8,september:8,oct:9,october:9,nov:10,november:10,dec:11,december:11}[l];if(d===void 0)return null;const h=c<100?2e3+c:c,f=new Date(Date.UTC(h,d,o));return Number.isNaN(f.valueOf())?null:f.toISOString().slice(0,10)}function qk(s){const e=s.toLowerCase();return/^ldl/.test(e)?"ldl":/(total\s+chol|tchol|^tc$)/.test(e)?"tchol":/^hdl/.test(e)?"hdl":/^(tg|trig)/.test(e)?"tg":/apo\s*b|apob/.test(e)?"apob":/non[-\s]*hdl/.test(e)?"nonHDL":null}function Jk(s,e){const r=s.split(/[,;¬∑]/).map(a=>a.trim()).filter(Boolean);for(const a of r){const n=a.match(Kk),i=a.match(Gk);if(!n||!i)continue;const o=qk(n[0]);if(!o)continue;const l=parseFloat(i[0]);Number.isNaN(l)||(e[o]=l)}}function Yk(s){if(s.nonHDL==null&&s.tchol!=null&&s.hdl!=null){const e=parseFloat((s.tchol-s.hdl).toFixed(2));s.nonHDL=Number.isFinite(e)?e:void 0}}function Xk(s){return s?zk.test(s):!1}function Zk(s){const e=[];let r=null;for(const a of s){if(!a.therapyNote){r&&(r.endDate=a.date,e.push(r),r=null);continue}r&&r.note===a.therapyNote?r.endDate=a.date:(r&&e.push(r),r={label:a.therapyNote,startDate:a.date,note:a.therapyNote})}return r&&e.push(r),e}function eI(s){const e=s.filter(l=>typeof l.ldl=="number");if(e.length===0)return{};const r=e.filter(l=>l.isPreTherapy),a=r.length>0?r.slice(0,3):e.slice(0,1),n=a.map(l=>l.ldl).sort((l,c)=>l-c),i=Math.floor(n.length/2),o=n.length%2===0?(n[i-1]+n[i])/2:n[i];return{value:Number.isFinite(o)?parseFloat(o.toFixed(2)):void 0,date:a[0]?.date}}function g0(s){const e=[],r=[];if(!s||!s.trim())return{readings:[],warnings:["No Investigation Summary content detected."],metadata:{therapyPhases:[]}};const a=s.split(/\r?\n/).map(i=>i.trim()).filter(Boolean);for(const i of a){const o=i.match($k);if(!o)continue;const[,l,c]=o,A=Wk(l);if(!A){e.push(`Could not parse date "${l}"`);continue}let d=c.trim(),h=null;const f=d.match(p0);f&&(h=f[1].trim(),d=d.replace(p0,"").trim());const u={id:typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`lipid-${Date.now()}-${Math.random().toString(16).slice(2)}`,date:A,source:i,therapyNote:h,isPreTherapy:Xk(h)};if(Jk(d,u),Yk(u),u.ldl==null&&u.tchol==null&&u.hdl==null&&u.tg==null&&u.apob==null&&u.nonHDL==null){e.push(`No lipid values recognised for "${i}"`);continue}r.push(u)}r.sort((i,o)=>i.date<o.date?-1:i.date>o.date?1:0);const n=Gv(r);return{readings:r,warnings:e,metadata:n}}function Gv(s){const e=[...s].sort((o,l)=>o.date<l.date?-1:o.date>l.date?1:0),r=Zk(e),{value:a,date:n}=eI(e),i=e.at(-1);return{baselineLDL:a,baselineSourceDate:n,latestDate:i?.date,latestLDL:i?.ldl,latestTotalChol:i?.tchol,therapyPhases:r}}const tI=864e5,sI=tI*30.4375;function Sd(s){if(!s)return;const e=new Date(s);if(Number.isNaN(e.valueOf()))return;const r=String(e.getUTCDate()).padStart(2,"0"),a=String(e.getUTCMonth()+1).padStart(2,"0"),n=e.getUTCFullYear();return`${r}-${a}-${n}`}function eA(s){if(!s)return null;const e=new Date(s);return Number.isNaN(e.valueOf())?null:e}function rI(s,e){return(e.getTime()-s.getTime())/sI}function zv(s,e){const r=new Date(s);return r.setMonth(r.getMonth()-e),r}function aI(s){return`${Math.round(s*100)}%`}function nI(s){if(s.length<2)return null;const e=s.length,r=s.reduce((c,A)=>c+A.x,0),a=s.reduce((c,A)=>c+A.y,0),n=s.reduce((c,A)=>c+A.x*A.y,0),i=s.reduce((c,A)=>c+A.x*A.x,0),o=e*i-r*r;return o===0?null:(e*n-r*a)/o}function iI(s){return s==null?"insufficient-data":s>.05?"rising":s<-.05?"falling":"stable"}function oI(s){switch(s){case"3m":return 3;case"6m":return 6;case"12m":return 12;default:return 1/0}}function lI(s,e,r,a,n,i){if(!e)return{percentage:0,lastAtGoalDate:void 0};const o=oI(r),l=o===1/0?null:zv(e,o),c=s.filter(h=>{if(h.ldl==null)return!1;if(l){const f=eA(h.date);if(!f||f<l)return!1}return!0});if(c.length===0)return{percentage:0,lastAtGoalDate:void 0};const A=c.filter(h=>{if(h.ldl==null)return!1;let f=h.ldl<a+1e-6;return f&&n&&i&&(f=(i-h.ldl)/i*100>=n-.5),f}),d=A.length>0?A.at(-1)?.date:void 0;return{percentage:A.length/c.length,lastAtGoalDate:d}}function cI(s){let e;for(let r=1;r<s.length;r+=1){const a=s[r-1],n=s[r];if(a.ldl==null||n.ldl==null)continue;const i=n.ldl-a.ldl;i<=0||(!e||i>e.delta)&&(e={startDate:a.date,endDate:n.date,delta:parseFloat(i.toFixed(2))})}return e}function AI(s){const e=s.filter(a=>typeof a.ldl=="number");if(e.length===0)return;e.sort((a,n)=>a.ldl-n.ldl);const r=e[0];return{date:r.date,value:parseFloat(r.ldl.toFixed(2)),therapyNote:r.therapyNote??null}}function dI(s,e){if(s.length<2||e==null)return;const r=s.filter(f=>f.therapyNote&&!f.isPreTherapy);if(r.length===0)return;const a=r[0],n=s.findIndex(f=>f.id===a.id),i=s.slice(0,n).filter(f=>typeof f.ldl=="number"),o=s.slice(n).filter(f=>typeof f.ldl=="number");if(i.length===0||o.length===0)return;const l=i.reduce((f,u)=>f+u.ldl,0)/i.length,c=Math.min(...o.map(f=>f.ldl)),A=l-c,d=A/l*100;if(!Number.isFinite(d))return;let h="expected";return d<30?h="sub-expected":d>=50&&(h="excellent"),`Therapy response ${h}: ‚Üì${A.toFixed(1)} mmol/L (${Math.round(d)}%) from pre-therapy median.`}function uI(s){if(!s)return{strictOverlayRecommended:!1};const e=/ctca|coronary\s+angio/i.test(s),r=/(plaque|stenosis|calcium|calcified)/i.test(s);return e&&r?{strictOverlayRecommended:!0,note:"CTCA evidence of plaque ‚Äì consider secondary prevention targets."}:{strictOverlayRecommended:!1}}function mI(s,e,r,a,n,i){if(s.length===0)return{slopeClassification:"insufficient-data",timeInTarget:{timeframe:n,percentage:0}};const o=s.at(-1),l=s.length>1?s[s.length-2]:void 0,c=eA(o.date),A=e.baselineLDL,d=A!=null&&o.ldl!=null?parseFloat((o.ldl-A).toFixed(2)):void 0,h=A!=null&&o.ldl!=null?(A-o.ldl)/A*100:void 0,f=l?.ldl!=null&&o.ldl!=null?parseFloat((o.ldl-l.ldl).toFixed(2)):void 0,u=l?.ldl!=null&&o.ldl!=null?(o.ldl-l.ldl)/l.ldl*100:void 0,x=c?zv(c,12):null,b=s.filter(D=>{if(!x||!c)return!0;const k=eA(D.date);return k!=null&&k>=x}).filter(D=>typeof D.ldl=="number").map(D=>{const k=eA(D.date),R=x??eA(s[0].date)??k;return{x:rI(R,k),y:D.ldl}}),N=nI(b),v=iI(N),j=r.bands.find(D=>D.id===a)??r.bands[0],I=lI(s,c,n,j.threshold,j.percentReduction,A),C=AI(s),E=cI(s),T=dI(s,A),Q=uI(i);return{baselineLDL:A,baselineDate:e.baselineSourceDate,latestLDL:o.ldl,latestTotal:o.tchol,deltaSinceBaseline:d,percentReduction:h,deltaSincePrevious:f,percentDeltaSincePrevious:u,monthlySlope:N==null?void 0:parseFloat(N.toFixed(2)),slopeClassification:v,timeInTarget:{timeframe:n,percentage:I.percentage,lastAtGoalDate:I.lastAtGoalDate},bestNadir:C,largestRise:E,therapyResponseNote:T,strictOverlayRecommended:Q.strictOverlayRecommended,riskContext:Q.note,latestDate:o.date,previousDate:l?.date}}function hI(s){const e=(v,j)=>v==null||j==null?"Œî n/a":`${v>0?"‚Üë":v<0?"‚Üì":"‚Üí"}${Math.abs(v).toFixed(1)} mmol/L (${j>0?"+":""}${Math.round(j)}%)`,r=Sd(s.latestDate),a=Sd(s.previousDate),n=Sd(s.baselineDate),i=s.latestLDL!=null?`Latest LDL ${s.latestLDL.toFixed(1)} mmol/L${s.latestTotal!=null?`, Total Chol ${s.latestTotal.toFixed(1)} mmol/L`:""}${r?` (${r})`:""}.`:"Latest LDL not available.",o=s.deltaSincePrevious!=null?`Change since prior result${a?` (${a})`:""}: ${e(s.deltaSincePrevious,s.percentDeltaSincePrevious)}.`:"No prior comparison available.",l=s.deltaSinceBaseline!=null?`Baseline${n?` (${n})`:""}: ${e(s.deltaSinceBaseline,s.percentReduction)}.`:"Baseline not established.";let c="Trend assessment unavailable.";switch(s.slopeClassification){case"rising":c=`LDL is rising ‚âà${s.monthlySlope?.toFixed(2)} mmol/L per month over recent data.`;break;case"falling":c=`LDL is falling ‚âà${Math.abs(s.monthlySlope??0).toFixed(2)} mmol/L per month.`;break;case"stable":c="LDL has remained broadly stable over the recent window.";break}const A={"3m":"3 months","6m":"6 months","12m":"12 months",all:"all results"},d=s.timeInTarget.lastAtGoalDate?Sd(s.timeInTarget.lastAtGoalDate):void 0,h=`Time-in-target (${A[s.timeInTarget.timeframe]}): ${aI(s.timeInTarget.percentage)}${d?`; last at goal ${d}`:""}.`,f=s.bestNadir?`Best on-therapy nadir ${s.bestNadir.value.toFixed(1)} mmol/L (${s.bestNadir.date}${s.bestNadir.therapyNote?` ‚Äì ${s.bestNadir.therapyNote}`:""}).`:void 0,u=s.largestRise?`Largest month-to-month rise: +${s.largestRise.delta.toFixed(1)} mmol/L (${s.largestRise.startDate} ‚Üí ${s.largestRise.endDate}).`:void 0,x=s.therapyResponseNote,b=s.riskContext;return{latestSummary:i,priorComparison:o,baselineComparison:l,trajectory:c,timeInTarget:h,therapyResponse:x,nadirAndRise:[f,u].filter(Boolean).join(" ")||void 0,riskContext:b,whyItMatters:"Every ~1 mmol/L LDL-C reduction yields ‚âà21‚Äì25% relative ASCVD risk reduction; align therapy with chosen overlay to capture this benefit."}}const Ol={"au-practice":{id:"au-practice",name:"AU Practice",description:"Australian clinical practice (secondary prevention default, optional primary target).",allowCustomPrimaryTarget:!0,bands:[{id:"secondary-prevention",label:"Secondary prevention (LDL <1.8 mmol/L)",threshold:1.8,description:"Australian practice common target for established ASCVD."},{id:"primary-custom",label:"Primary prevention (clinician-set target)",threshold:2,description:"Default <2.0 mmol/L for high-risk primary prevention (editable)."}]},"esc-eas":{id:"esc-eas",name:"ESC/EAS 2019",description:"European Society of Cardiology / Atherosclerosis Society targets.",bands:[{id:"very-high",label:"Very-high risk (LDL <1.4 mmol/L + ‚â•50% reduction)",threshold:1.4,percentReduction:50,description:"Use for clinical ASCVD, diabetes with organ damage, severe CKD."},{id:"high-risk",label:"High risk (LDL <1.8 mmol/L)",threshold:1.8,percentReduction:50,description:"Marked risk factors or familial hypercholesterolaemia."},{id:"moderate-risk",label:"Moderate risk (LDL <2.6 mmol/L)",threshold:2.6,description:"Primary prevention moderate risk cohorts."}]}},Op="au-practice",pI="secondary-prevention",fi={LATEST:"lipid-profile-latest",HISTORY:"lipid-profile-history",SETTINGS:"lipid-profile-settings"},gI=5,Wv={framework:Op,selectedBandId:pI,selectedAnalytes:["ldl","tchol"],timeFilter:"6m",ldlOnlyView:!1,showTherapyBands:!0};class Hl{static instance;constructor(){}static getInstance(){return Hl.instance||(Hl.instance=new Hl),Hl.instance}async saveSession(e){await chrome.storage.local.set({[fi.LATEST]:e}),bt.info("Lipid profile session saved",{component:"lipid-storage",id:e.id,readings:e.readings.length}),await this.addToHistory(e)}async loadLatestSession(){return(await chrome.storage.local.get(fi.LATEST))[fi.LATEST]??null}async clearLatest(){await chrome.storage.local.remove(fi.LATEST)}async saveSettings(e){await chrome.storage.local.set({[fi.SETTINGS]:e})}async loadSettings(){return(await chrome.storage.local.get(fi.SETTINGS))[fi.SETTINGS]??Wv}async addToHistory(e){try{const a=(await chrome.storage.local.get(fi.HISTORY))[fi.HISTORY]??[];a.unshift(e);const n=a.slice(0,gI);await chrome.storage.local.set({[fi.HISTORY]:n})}catch(r){bt.warn("Failed to append lipid profile session to history",{component:"lipid-storage",error:r instanceof Error?r.message:"unknown"})}}}const f0={tchol:"#111827",ldl:"#dc2626",tg:"#ea580c",hdl:"#0284c7",apob:"#7c3aed",nonHDL:"#2563eb"};function jd(s,e){switch(e){case"ldl":return s.ldl??void 0;case"tchol":return s.tchol??void 0;case"hdl":return s.hdl??void 0;case"tg":return s.tg??void 0;case"apob":return s.apob??void 0;case"nonHDL":return s.nonHDL??void 0;default:return}}function Oo(s){return new Date(s)}function Ed(s){return new Date(Date.UTC(s.getUTCFullYear(),s.getUTCMonth(),1))}function kd(s){const e=new Date(s);return e.setUTCMonth(e.getUTCMonth()+1),e}function fI(s){if(!s)return"";const r=new Date(s.date).toLocaleDateString(void 0,{day:"2-digit",month:"short",year:"numeric"}),a=[];return s.ldl!=null&&a.push(`LDL ${s.ldl.toFixed(1)}`),s.tchol!=null&&a.push(`TChol ${s.tchol.toFixed(1)}`),s.hdl!=null&&a.push(`HDL ${s.hdl.toFixed(1)}`),s.nonHDL!=null&&a.push(`Non-HDL ${s.nonHDL.toFixed(1)}`),`${r}
${a.join(" ¬∑ ")}`}const xI=({readings:s,settings:e,overlay:r,therapyPhases:a,onPointClick:n})=>{const i=m.useRef(null),o=m.useRef(null),[l,c]=m.useState(null),[A,d]=m.useState({width:600,height:340});m.useEffect(()=>{const b=()=>{if(!o.current)return;const N=o.current.clientWidth;d({width:Math.max(420,N-12),height:340})};return b(),window.addEventListener("resize",b),()=>window.removeEventListener("resize",b)},[]);const h=m.useMemo(()=>e.ldlOnlyView?["ldl"]:e.selectedAnalytes,[e.ldlOnlyView,e.selectedAnalytes]);m.useEffect(()=>{const b=i.current;if(!b||s.length===0)return;const N=b.getContext("2d");if(!N)return;const{width:v,height:j}=A,I=window.devicePixelRatio||1;b.width=v*I,b.height=j*I,b.style.width=`${v}px`,b.style.height=`${j}px`,N.scale(I,I),N.clearRect(0,0,v,j);const C={top:40,right:70,bottom:60,left:70},E=v-C.left-C.right,T=j-C.top-C.bottom,Q=s.filter(H=>h.some(Y=>jd(H,Y)!=null));if(Q.length===0)return;const D=Q.flatMap(H=>h.map(Y=>jd(H,Y)??null).filter(Y=>Y!=null)),k=0,R=Math.max(...D,r.bands.reduce((H,Y)=>Math.max(H,Y.threshold),0)+.5),w=s.map(H=>Oo(H.date));w.sort((H,Y)=>H.getTime()-Y.getTime());const L=Ed(w[0]),M=Ed(w[w.length-1]),P=[];let K=new Date(L);for(;K<=M;)P.push(new Date(K)),K=kd(K);P.length===1&&P.push(kd(P[0]));const $=P.length-1||1,O=H=>{const Y=P.findIndex(G=>G.getUTCFullYear()===H.getUTCFullYear()&&G.getUTCMonth()===H.getUTCMonth());if(Y>=0){const G=(H.getUTCDate()-1)/new Date(H.getUTCFullYear(),H.getUTCMonth()+1,0).getUTCDate();return C.left+(Y+G)/$*E}const te=(H.getUTCFullYear()-P[0].getUTCFullYear())*12+(H.getUTCMonth()-P[0].getUTCMonth());return C.left+te/$*E},W=H=>C.top+T-(H-k)/(R-k)*T,ee=()=>{N.strokeStyle="#cbd5f5",N.lineWidth=1,N.beginPath(),N.moveTo(C.left,C.top),N.lineTo(C.left,C.top+T),N.lineTo(C.left+E,C.top+T),N.stroke(),N.fillStyle="#6b7280",N.font="10px Inter",N.textAlign="center",N.textBaseline="top",P.forEach((Y,te)=>{const G=C.left+te/$*E;N.fillText(Y.toLocaleDateString(void 0,{month:"short",year:"2-digit"}),G,C.top+T+10),N.beginPath(),N.strokeStyle="#e5e7eb",N.moveTo(G,C.top),N.lineTo(G,C.top+T),N.stroke()}),N.textAlign="right",N.textBaseline="middle";const H=6;for(let Y=0;Y<=H;Y+=1){const te=k+Y/H*(R-k),G=W(te);N.fillText(te.toFixed(1),C.left-6,G),N.beginPath(),N.strokeStyle="#eef2ff",N.moveTo(C.left,G),N.lineTo(C.left+E,G),N.stroke()}},V=()=>{N.save(),r.bands.forEach(H=>{const Y=W(H.threshold),te=C.top+T-Y;te>0&&(N.fillStyle="rgba(37, 99, 235, 0.08)",N.fillRect(C.left,Y,E,te)),N.strokeStyle="rgba(37, 99, 235, 0.5)",N.lineWidth=1,N.beginPath(),N.moveTo(C.left,Y),N.lineTo(C.left+E,Y),N.stroke(),N.fillStyle="#1d4ed8",N.font="10px Inter",N.textAlign="right",N.fillText(`${H.label}`,C.left+E,Y-4)}),N.restore()},q=()=>{!e.showTherapyBands||a.length===0||(N.save(),a.forEach(H=>{const Y=Oo(H.startDate),te=H.endDate?Oo(H.endDate):M,G=O(Y),X=O(te),le=Math.max(6,X-G);N.fillStyle="rgba(34, 197, 94, 0.14)",N.fillRect(G,C.top,le,T),N.strokeStyle="rgba(22, 163, 74, 0.4)",N.strokeRect(G,C.top,le,T),N.fillStyle="rgba(22, 163, 74, 0.85)",N.font="10px Inter",N.textAlign="left",N.fillText(H.label,G+6,C.top+12)}),N.restore())},S=()=>{h.forEach(H=>{N.beginPath(),N.lineWidth=H==="ldl"?2.4:1.8,N.strokeStyle=f0[H],N.fillStyle=f0[H];let Y=!1;s.forEach(te=>{const G=jd(te,H);if(G==null)return;const X=O(Oo(te.date)),le=W(G);Y?N.lineTo(X,le):(N.moveTo(X,le),Y=!0)}),N.stroke(),s.forEach(te=>{const G=jd(te,H);if(G==null)return;const X=O(Oo(te.date)),le=W(G);N.beginPath(),N.arc(X,le,H==="ldl"?4:3,0,Math.PI*2),N.fill()})})};V(),q(),ee(),S()},[s,A,r,a,h,e.showTherapyBands]);const f=b=>{const N=i.current;if(!N)return;const v=N.getBoundingClientRect(),j=b.clientX-v.left,I=b.clientY-v.top,{width:C,height:E}=A,T={top:40,right:70,bottom:60,left:70},Q=C-T.left-T.right,D=E-T.top-T.bottom,k=s.map(V=>Oo(V.date));k.sort((V,q)=>V.getTime()-q.getTime());const R=Ed(k[0]),w=Ed(k[k.length-1]),L=[];let M=new Date(R);for(;M<=w;)L.push(new Date(M)),M=kd(M);L.length===1&&L.push(kd(L[0]));const P=L.length-1||1,K=8;let $=null;const O=s.filter(V=>V.ldl!=null).map(V=>V.ldl);if(O.length===0)return;const W=Math.max(0,Math.min(...O)-.5),ee=Math.max(...O,r.bands.reduce((V,q)=>Math.max(V,q.threshold),0)+.5);if(s.forEach(V=>{if(V.ldl==null)return;const q=Oo(V.date),S=(q.getUTCFullYear()-L[0].getUTCFullYear())*12+(q.getUTCMonth()-L[0].getUTCMonth())+(q.getUTCDate()-1)/30,H=T.left+S/P*Q,Y=T.top+D-(V.ldl-W)/(ee-W)*D,te=Math.hypot(H-j,Y-I);te<K&&(!$||te<$.distance)&&($={reading:V,distance:te})}),$!==null){const{reading:V}=$;c({visible:!0,x:j,y:I,reading:V})}else c(null)},u=()=>{c(null)},x=()=>{l&&l.visible&&l.reading&&n&&n(l.reading)};return t.jsxs("div",{ref:o,className:"relative",children:[t.jsx("canvas",{ref:i,width:A.width,height:A.height,onMouseMove:f,onMouseLeave:u,onClick:x,className:"w-full h-[340px] cursor-crosshair select-none border border-gray-200 rounded-xl bg-white shadow-sm"}),l&&l.visible&&l.reading&&t.jsxs("div",{className:"absolute pointer-events-none bg-white border border-gray-200 rounded-lg shadow-lg p-2 text-xs text-gray-700 whitespace-pre-line",style:{left:l.x+12,top:l.y+12},children:[fI(l.reading),l.reading.therapyNote?`
(${l.reading.therapyNote})`:"",l.reading.source?`
${l.reading.source}`:""]})]})},x0={"3m":"Last 3 months","6m":"Last 6 months","12m":"Last 12 months",all:"All data"},yI=({settings:s,onChange:e,availableAnalytes:r})=>{const a=Ol[s.framework]??Ol[Op],n=c=>{const A=Ol[c]??a;e({...s,framework:A.id,selectedBandId:A.bands[0]?.id??s.selectedBandId})},i=c=>{e({...s,selectedBandId:c})},o=c=>{e({...s,timeFilter:c})},l=c=>{const A=s.selectedAnalytes.includes(c)?s.selectedAnalytes.filter(d=>d!==c):[...s.selectedAnalytes,c];e({...s,selectedAnalytes:A})};return t.jsxs("div",{className:"grid gap-4 bg-white border border-gray-200 rounded-xl p-4 shadow-sm",children:[t.jsxs("div",{children:[t.jsx("h4",{className:"text-sm font-semibold text-gray-800 mb-2",children:"Guideline overlay"}),t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx("select",{value:s.framework,onChange:c=>n(c.target.value),className:"border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500",children:Object.values(Ol).map(c=>t.jsx("option",{value:c.id,children:c.name},c.id))}),t.jsx("select",{value:s.selectedBandId,onChange:c=>i(c.target.value),className:"border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500",children:a.bands.map(c=>t.jsx("option",{value:c.id,children:c.label},c.id))}),a.allowCustomPrimaryTarget&&s.selectedBandId==="primary-custom"&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("label",{htmlFor:"customTarget",className:"text-xs text-gray-600",children:"Target <"}),t.jsx("input",{id:"customTarget",type:"number",step:.1,min:1,value:s.customPrimaryTarget??a.bands.find(c=>c.id==="primary-custom")?.threshold??2,onChange:c=>{const A=parseFloat(c.target.value||"0");e({...s,customPrimaryTarget:Number.isFinite(A)?A:void 0})},className:"w-24 border border-gray-200 rounded-lg px-2 py-1 text-sm focus:ring-blue-500 focus:border-blue-500"}),t.jsx("span",{className:"text-xs text-gray-500",children:"mmol/L"})]})]})]}),t.jsxs("div",{children:[t.jsx("h4",{className:"text-sm font-semibold text-gray-800 mb-2",children:"Time filter"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:Object.keys(x0).map(c=>t.jsx(ye,{onClick:()=>o(c),variant:s.timeFilter===c?"primary":"outline",size:"sm",className:"text-xs",children:x0[c]},c))})]}),t.jsxs("div",{children:[t.jsx("h4",{className:"text-sm font-semibold text-gray-800 mb-2",children:"Series"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:r.map(c=>{const A=s.selectedAnalytes.includes(c);return t.jsx(ye,{onClick:()=>l(c),variant:A?"secondary":"outline",size:"sm",className:"text-xs",children:c.toUpperCase()},c)})}),t.jsxs("label",{className:"mt-3 flex items-center gap-2 text-xs text-gray-600",children:[t.jsx("input",{type:"checkbox",checked:s.ldlOnlyView,onChange:c=>e({...s,ldlOnlyView:c.target.checked}),className:"rounded border-gray-300"}),"LDL-only focus"]}),t.jsxs("label",{className:"mt-2 flex items-center gap-2 text-xs text-gray-600",children:[t.jsx("input",{type:"checkbox",checked:s.showTherapyBands,onChange:c=>e({...s,showTherapyBands:c.target.checked}),className:"rounded border-gray-300"}),"Show therapy phase bands"]})]})]})},bI={ldl:"LDL-C",tchol:"Total Chol",hdl:"HDL",tg:"Triglycerides",apob:"ApoB",nonHDL:"Non-HDL"},vI={inputMode:"decimal",step:.1,min:0},y0=typeof Intl<"u"?new Intl.DateTimeFormat(void 0,{day:"2-digit",month:"short",year:"numeric"}):null;function wI(s){try{return y0?y0.format(new Date(s)):s}catch{return s}}const CI=({readings:s,onChange:e,analyteOrder:r})=>{const a=m.useCallback((n,i,o)=>{e(s.map(l=>{if(l.id!==n)return l;if(i==="date")return{...l,date:o,isEdited:!0};if(i==="therapyNote")return{...l,therapyNote:o||null,isEdited:!0,isPreTherapy:o?/\boff\s+statin|pre-therapy|baseline/i.test(o):!1};const c=o===""?void 0:Number(o),A=c!==void 0&&Number.isFinite(c)?parseFloat(c.toFixed(2)):void 0,d={...l,[i]:A,isEdited:!0};return(i==="tchol"||i==="hdl")&&(d.tchol!=null&&d.hdl!=null?d.nonHDL=parseFloat((d.tchol-d.hdl).toFixed(2)):(i==="tchol"&&d.hdl==null||i==="hdl"&&d.tchol==null)&&(d.nonHDL=void 0)),d}))},[s,e]);return s.length===0?t.jsx("div",{className:"border border-dashed border-gray-300 rounded-lg p-6 text-center text-sm text-gray-500",children:"No lipid results parsed yet."}):t.jsx("div",{className:"overflow-x-auto border border-gray-200 rounded-xl shadow-sm",children:t.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[t.jsx("thead",{className:"bg-gray-50 text-xs uppercase",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-3 py-2 text-left font-semibold text-gray-600",children:"Date"}),r.map(n=>t.jsxs("th",{className:"px-3 py-2 text-left font-semibold text-gray-600 whitespace-nowrap",children:[bI[n]," (mmol/L)"]},n)),t.jsx("th",{className:"px-3 py-2 text-left font-semibold text-gray-600",children:"Therapy note"}),t.jsx("th",{className:"px-3 py-2 text-right font-semibold text-gray-600",children:"Provenance"})]})}),t.jsx("tbody",{className:"divide-y divide-gray-100 bg-white",children:s.map(n=>t.jsxs("tr",{className:n.isEdited?"bg-amber-50":void 0,children:[t.jsx("td",{className:"px-3 py-2 align-top",children:t.jsx("input",{type:"date",className:"w-full border border-gray-200 rounded-lg px-2 py-1 text-sm focus:ring-blue-500 focus:border-blue-500",value:n.date,onChange:i=>a(n.id,"date",i.target.value)})}),r.map(i=>t.jsx("td",{className:"px-3 py-2 align-top",children:t.jsx("input",{type:"number",...vI,className:"w-24 border border-gray-200 rounded-lg px-2 py-1 text-sm focus:ring-blue-500 focus:border-blue-500",value:n[i]??"",onChange:o=>a(n.id,i,o.target.value),placeholder:"‚Äì"})},`${n.id}-${i}`)),t.jsx("td",{className:"px-3 py-2 align-top",children:t.jsx("input",{type:"text",className:"w-full border border-gray-200 rounded-lg px-2 py-1 text-sm focus:ring-blue-500 focus:border-blue-500",value:n.therapyNote??"",onChange:i=>a(n.id,"therapyNote",i.target.value),placeholder:"Optional note"})}),t.jsx("td",{className:"px-3 py-2 text-right text-xs text-gray-500 align-top",children:t.jsx("span",{title:n.source,children:wI(n.date)})})]},n.id))})]})})},NI=({summary:s})=>s?t.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-xl p-4 space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Ma,{className:"w-5 h-5 text-blue-600"}),t.jsx("h3",{className:"text-sm font-semibold text-blue-900",children:"Clinical Insights"})]}),t.jsxs("ul",{className:"space-y-2 text-sm text-gray-900",children:[t.jsxs("li",{children:[t.jsx("strong",{className:"text-gray-700",children:"Latest status:"})," ",s.latestSummary]}),t.jsxs("li",{children:[t.jsx("strong",{className:"text-gray-700",children:"Change vs prior:"})," ",s.priorComparison]}),t.jsxs("li",{children:[t.jsx("strong",{className:"text-gray-700",children:"Baseline context:"})," ",s.baselineComparison]}),t.jsxs("li",{children:[t.jsx("strong",{className:"text-gray-700",children:"Trajectory:"})," ",s.trajectory]}),t.jsxs("li",{children:[t.jsx("strong",{className:"text-gray-700",children:"Time in target:"})," ",s.timeInTarget]}),s.therapyResponse&&t.jsxs("li",{children:[t.jsx("strong",{className:"text-gray-700",children:"Therapy response:"})," ",s.therapyResponse]}),s.nadirAndRise&&t.jsxs("li",{children:[t.jsx("strong",{className:"text-gray-700",children:"Notable points:"})," ",s.nadirAndRise]}),s.riskContext&&t.jsxs("li",{children:[t.jsx("strong",{className:"text-gray-700",children:"Risk context:"})," ",s.riskContext]}),t.jsxs("li",{children:[t.jsx("strong",{className:"text-gray-700",children:"Why LDL matters:"})," ",s.whyItMatters]})]})]}):null,b0=Ni.getInstance(),BI=({phases:s})=>s.length===0?null:t.jsxs("div",{className:"bg-emerald-50 border border-emerald-200 rounded-xl p-3 space-y-2",children:[t.jsx("div",{className:"text-xs font-semibold text-emerald-700 uppercase tracking-wide",children:"Therapy phases"}),t.jsx("div",{className:"flex flex-wrap gap-2",children:s.map((e,r)=>t.jsxs("div",{className:"flex items-center gap-2 rounded-lg bg-white border border-emerald-200 px-3 py-2 text-xs text-emerald-800 shadow-sm",children:[t.jsx("span",{className:"font-semibold",children:e.label}),t.jsxs("span",{className:"text-emerald-600",children:[e.startDate," ‚Üí ",e.endDate??"current"]})]},`${e.startDate}-${r}`))})]});function v0(s,e){if(e==="all"||s.length===0)return s;const r=e==="3m"?3:e==="6m"?6:12,a=new Date(s.at(-1).date),n=new Date(a);return n.setMonth(n.getMonth()-r),s.filter(i=>new Date(i.date)>=n)}function w0(s){const e=Ol[s.framework]??Ol[Op],r=s.customPrimaryTarget;return!e.allowCustomPrimaryTarget||r==null?{...e,bands:e.bands.map(a=>({...a}))}:{...e,bands:e.bands.map(a=>a.id==="primary-custom"?{...a,threshold:r}:{...a})}}const SI=({isOpen:s,onClose:e})=>{const[r,a]=m.useState("idle"),[n,i]=m.useState(""),[o,l]=m.useState([]),[c,A]=m.useState({therapyPhases:[]}),[d,h]=m.useState(Wv),[f,u]=m.useState(null),[x,b]=m.useState(null),[N,v]=m.useState("emr"),[j,I]=m.useState(!1),[C,E]=m.useState(!1),[T,Q]=m.useState([]),D=m.useRef(Hl.getInstance());m.useEffect(()=>{(async()=>{const V=await D.current.loadSettings();h(q=>({...q,...V}))})()},[]),m.useEffect(()=>{D.current.saveSettings(d).catch(()=>{})},[d]),m.useEffect(()=>{if(o.length===0){u(null),Q([]);return}const V=w0(d),q=V.bands.some(te=>te.id===d.selectedBandId)?d.selectedBandId:V.bands[0].id,S=v0(o,d.timeFilter),H=mI(S,c,V,q,d.timeFilter,n),Y=hI(H);u(Y)},[o,c,d,n]);const k=m.useMemo(()=>{const V=new Set;return o.forEach(S=>{["ldl","tchol","hdl","tg","apob","nonHDL"].forEach(H=>{S[H]!=null&&V.add(H)})}),["ldl","tchol","hdl","nonHDL","tg","apob"].filter(S=>V.has(S))},[o]),R=["ldl","tchol","hdl","nonHDL"],w=k.length>0?k:R,L=m.useMemo(()=>w0(d),[d]),M=m.useMemo(()=>v0(o,d.timeFilter),[o,d.timeFilter]),P=m.useCallback(async()=>{a("capturing"),b0.recordMetrics("agent-processing",0,{agentType:"lipid-profile-import"});try{const V=await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"investigation-summary",data:{extractOnly:!0}});if(!V?.success)throw new Error(V?.error||"Capture failed");if(!V.data||V.data.trim().length===0){a("error"),E(!0),gt.getInstance().warning("No Investigation Summary content","Click ‚ÄúPaste text‚Äù to provide the lipid results manually.");return}const q=performance.now(),S=g0(V.data),H=performance.now()-q;if(b0.recordMetrics("agent-processing",H,{agentType:"lipid-profile-import"}),S.readings.length===0){a("error"),Q(S.warnings),gt.getInstance().warning("No lipid results found","Review the capture or paste text manually.");return}i(V.data),l(S.readings),A(S.metadata),Q(S.warnings),b(Date.now()),a("ready"),v("emr"),E(!1),I(!1);const Y={id:`lipid-${Date.now()}`,capturedAt:Date.now(),source:"emr",sourceRawText:V.data,readings:S.readings,settings:d,metadata:S.metadata};D.current.saveSession(Y).catch(()=>{}),gt.getInstance().success("Captured Investigation Summary",`Parsed ${S.readings.length} lipid results.`)}catch(V){console.error("Lipid capture failed:",V),a("error"),Q([V instanceof Error?V.message:"Unknown capture error"]),gt.getInstance().error("EMR capture failed","Use ‚ÄúPaste text‚Äù to continue manually."),E(!0)}},[d]),K=m.useCallback((V,q)=>{const S=g0(V);if(S.readings.length===0){Q(S.warnings.length>0?S.warnings:["No lipid results recognised."]),gt.getInstance().warning("Unable to parse lipid results","Check the formatting or include Bloods (DATE) lines."),l([]),A({therapyPhases:[]}),a("error");return}i(V),l(S.readings),A(S.metadata),Q(S.warnings),b(Date.now()),a("ready"),v(q),I(!1);const H={id:`lipid-${Date.now()}`,capturedAt:Date.now(),source:q,sourceRawText:V,readings:S.readings,settings:d,metadata:S.metadata};D.current.saveSession(H).catch(()=>{}),gt.getInstance().success("Lipid results parsed",`Found ${S.readings.length} records.`)},[d]),$=m.useCallback(V=>{V.preventDefault();const q=V.currentTarget,S=new FormData(q),H=String(S.get("lipidPaste")??"").trim();if(!H){gt.getInstance().warning("No text provided","Paste the Investigation Summary content first.");return}K(H,"paste")},[K]),O=V=>{const q=[...V].sort((S,H)=>S.date<H.date?-1:1);l(q),A(Gv(q)),a("ready")},W=async()=>{const V=await D.current.loadLatestSession();if(!V){gt.getInstance().info("No saved capture","Import from EMR or paste text to begin.");return}l(V.readings),A(V.metadata),i(V.sourceRawText),h(V.settings),b(V.capturedAt),v(V.source),a("ready"),gt.getInstance().success("Loaded last capture",`Restored ${V.readings.length} lipid readings.`)},ee=V=>{gt.getInstance().info(`Reading ${new Date(V.date).toLocaleDateString()}`,V.source)};return s?t.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-2",children:t.jsxs("div",{className:"bg-white rounded-modal w-full max-h-[92vh] overflow-hidden shadow-modal flex flex-col",children:[t.jsxs("header",{className:"flex items-start justify-between px-3 py-2.5 border-b border-gray-200",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-base font-semibold text-gray-900",children:"Lipid Profile Importer"}),t.jsx("p",{className:"text-[11px] text-gray-600",children:"Capture & visualize lipid trends"})]}),t.jsx(Zt,{onClick:e,icon:es,variant:"ghost",size:"sm","aria-label":"Close importer",className:"text-gray-400 hover:text-gray-600"})]}),t.jsxs("main",{className:"flex-1 overflow-y-auto p-2 space-y-2 bg-surface-secondary",children:[t.jsxs("section",{className:"bg-white border border-gray-200 rounded-xl p-2.5 shadow-sm",children:[t.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-2",children:[t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx(ye,{onClick:P,disabled:r==="capturing",variant:"primary",size:"sm",startIcon:BA,className:"text-xs",children:"Import"}),t.jsx(ye,{onClick:W,variant:"outline",size:"sm",startIcon:Xa,className:"text-xs",children:"Load last"})]}),r==="capturing"&&t.jsxs("div",{className:"text-sm text-gray-500 flex items-center gap-2",children:[t.jsx("span",{className:"w-3 h-3 border-2 border-gray-900 border-t-transparent rounded-full animate-spin"}),"Capturing Investigation Summary‚Ä¶"]})]}),(x||C)&&t.jsxs("div",{className:"mt-2 bg-gray-50 border border-gray-200 rounded-lg p-2 text-[10px] text-gray-600 flex flex-wrap items-center gap-2",children:[t.jsxs("span",{className:"font-medium text-gray-700",children:["Source: Inv. summary ¬∑ ",x?new Date(x).toLocaleDateString():"manual"]}),t.jsx(ye,{variant:"ghost",size:"sm",onClick:P,className:"text-blue-600 hover:text-blue-800 text-[10px] px-2 py-1",children:"Refetch"}),t.jsx(ye,{variant:"ghost",size:"sm",onClick:()=>I(V=>!V),className:"text-blue-600 hover:text-blue-800 text-[10px] px-2 py-1",children:j?"Hide raw":"Edit raw"}),t.jsx(ye,{variant:"ghost",size:"sm",onClick:()=>E(!0),className:"text-blue-600 hover:text-blue-800 text-[10px] px-2 py-1",children:"Change source ‚Üí Paste text"})]}),C&&t.jsxs("form",{className:"mt-2 space-y-1.5",onSubmit:$,children:[t.jsx("label",{htmlFor:"lipidPaste",className:"text-[10px] uppercase tracking-wide text-gray-500",children:"Paste Investigation Summary text"}),t.jsx("textarea",{id:"lipidPaste",name:"lipidPaste",className:"w-full min-h-[100px] border border-gray-200 rounded-lg px-2 py-1.5 text-xs focus:ring-blue-500 focus:border-blue-500",placeholder:"Bloods (20 Mar 2025): TChol 7.5, LDL 5.2...",defaultValue:n}),t.jsxs("div",{className:"flex items-center justify-end gap-1.5",children:[t.jsx(ye,{type:"button",onClick:()=>E(!1),variant:"ghost",size:"sm",className:"text-[10px] px-2 py-1",children:"Cancel"}),t.jsx(ye,{type:"submit",variant:"primary",size:"sm",startIcon:CA,className:"text-[10px] px-2 py-1",children:"Parse"})]})]}),j&&!C&&t.jsxs("div",{className:"mt-4 space-y-2",children:[t.jsx("label",{htmlFor:"rawSourceEditor",className:"text-xs uppercase tracking-wide text-gray-500",children:"Raw Investigation Summary"}),t.jsx("textarea",{id:"rawSourceEditor",className:"w-full min-h-[160px] border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500",value:n,onChange:V=>i(V.target.value)}),t.jsx(ye,{onClick:()=>K(n,N),variant:"outline",size:"sm",startIcon:si,className:"text-xs",children:"Re-parse raw text"})]}),T.length>0&&t.jsx("div",{className:"mt-4 bg-amber-50 border border-amber-200 text-amber-900 rounded-lg p-3 text-xs space-y-1",children:T.map((V,q)=>t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx(Ma,{className:"w-3.5 h-3.5 mt-0.5"}),t.jsx("span",{children:V})]},q))}),r==="ready"&&o.length>0&&t.jsxs("div",{className:"mt-2",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[t.jsx("h3",{className:"text-xs font-semibold text-gray-800",children:"Parsed results"}),t.jsxs("span",{className:"text-[10px] text-gray-500",children:[o.length," readings"]})]}),t.jsx(CI,{readings:o,analyteOrder:w,onChange:O})]})]}),r==="ready"&&o.length>0&&t.jsx(t.Fragment,{children:t.jsxs("section",{className:"grid lg:grid-cols-3 gap-4",children:[t.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[t.jsx(xI,{readings:M,settings:d,overlay:L,therapyPhases:c.therapyPhases,onPointClick:ee}),t.jsxs("div",{className:"text-xs text-gray-500 flex items-center gap-2",children:[t.jsx(w2,{className:"w-4 h-4"}),"Click any point to view the original source snippet."]}),t.jsx(BI,{phases:c.therapyPhases})]}),t.jsxs("div",{className:"space-y-4",children:[t.jsx(yI,{settings:d,onChange:h,availableAnalytes:w}),t.jsx(NI,{summary:f})]})]})}),r!=="ready"&&o.length===0&&!C&&t.jsx("section",{className:"border border-dashed border-gray-300 rounded-xl p-8 text-center text-sm text-gray-500",children:"Import from the EMR or paste text to begin visualising lipid trends."})]}),t.jsx("footer",{className:"flex items-center justify-end gap-3 p-4 border-t border-gray-200 bg-white",children:t.jsx(ye,{onClick:e,variant:"ghost",size:"md",className:"text-sm",children:"Close"})})]})}):null},C0={jan:0,january:0,feb:1,february:1,mar:2,march:2,apr:3,april:3,may:4,jun:5,june:5,jul:6,july:6,aug:7,august:7,sep:8,sept:8,september:8,oct:9,october:9,nov:10,november:10,dec:11,december:11},N0=["trace","trivial","mild","mildly","moderate","moderately","mod","severe","severely"],wi=()=>{const s=typeof globalThis<"u"?globalThis.crypto:void 0;return s&&typeof s.randomUUID=="function"?s.randomUUID():`tte-${Math.random().toString(36).slice(2,11)}`};function jI(s){return s.replace(/(\d+)(st|nd|rd|th)/gi,"$1")}function Id(s,e,r){return new Date(Date.UTC(s,e,r)).toISOString().slice(0,10)}function B0(s){const e=[];if(!s)return{precision:"unknown",warnings:[]};const r=jI(s.replace(/[.,]/g," ")).replace(/\s+/g," ").trim(),a=r.match(/^(\d{1,2})\s+([A-Za-z]+)\s+(\d{4})$/);if(a){const[,l,c,A]=a,d=Number(l),h=C0[c.toLowerCase()],f=Number(A);if(Number.isInteger(d)&&h!=null&&Number.isInteger(f))return{iso:Id(f,h,d),precision:"day",warnings:[],label:`${l.padStart(2,"0")} ${c.slice(0,3)} ${f}`}}const n=r.match(/^([A-Za-z]+)\s+(\d{4})$/);if(n){const[,l,c]=n,A=C0[l.toLowerCase()],d=Number(c);if(A!=null&&Number.isInteger(d))return{iso:Id(d,A,1),precision:"month",warnings:[],label:`${l.slice(0,3)} ${d}`}}const i=r.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);if(i){const[,l,c,A]=i,d=Number(l),h=Number(c)-1;let f=Number(A);if(A.length===2&&(f+=f>=70?1900:2e3),d>=1&&d<=31&&h>=0&&h<=11)return{iso:Id(f,h,d),precision:"day",warnings:[],label:`${l.padStart(2,"0")}/${c.padStart(2,"0")}/${f}`}}const o=r.match(/^(\d{4})$/);if(o){const l=Number(o[1]);return{iso:Id(l,0,1),precision:"month",warnings:[`Only year provided (${l}); assuming January baseline.`],label:String(l)}}return r.length>0&&e.push(`Unable to parse date token "${s}"`),{precision:"unknown",warnings:e,label:r||void 0}}function EI(s){return/^(?:stress\s+)?echo\b/i.test(s)||/^tte\b/i.test(s)}function kI(s){return/^tte[s]?:?$/i.test(s.replace(/\s+/g,""))}function II(s){return/^stress\s+echo/i.test(s)?"stress-echo":/^echo/i.test(s)?"echo":"tte"}function TI(s){const e=s.match(/\(([^)]+)\)/);return e?{inner:e[1],remainder:s.replace(e[0],"").trim()}:{inner:null,remainder:s.trim()}}function kn(s,e){return{id:wi(),type:"numeric",value:e.value,unit:e.unit,display:e.display??(e.unit?`${e.value}${e.unit.startsWith("%")?"%":` ${e.unit}`}`:String(e.value)),sourceText:s[0].trim(),rawText:s.input?.trim(),flags:e.flags,qualitativeLabel:e.qualitativeLabel,precision:e.precision??"measured",highlight:e.highlight}}function S0(s,e,r){return{id:wi(),type:"text",text:e,sourceText:s[0].trim(),rawText:s.input?.trim(),flags:r}}function FI(s,e){s.includes(e)||s.push(e)}function PI(s,e,r,a){return{id:wi(),valve:s,severity:r,qualifiers:a,sourceText:e[0].trim(),rawText:e.input?.trim()}}function UI(s){return s.map(e=>e.trim()).filter(Boolean).join(" ")}function LI(s){const e=[],r=s.split(/\r?\n/);let a=null,n=!1;for(const i of r){const o=i.trim();if(!o){a&&a.body.push("");continue}const l=o.replace(/^[‚Ä¢¬∑‚ñ™‚ó¶‚Ä¢-]\s*/,"");if(kI(l)){n=!0;continue}if(n&&/^[‚Ä¢¬∑‚ñ™‚ó¶-]/.test(i.trim())){a&&e.push(a),a={modality:"tte",header:l,body:[],sourceLines:[i]};continue}if(EI(l)){a&&e.push(a),a={modality:II(l),header:l,body:[],sourceLines:[i]},n=!1;continue}a&&(a.body.push(l),a.sourceLines.push(i))}return a&&e.push(a),e}function DI(s){const{inner:e,remainder:r}=TI(s);let a,n={precision:"unknown",warnings:[]};if(e){const i=e.split(/,\s*/).filter(Boolean);for(const o of i){const l=B0(o);l.iso?n=l:a||(a=o.trim())}}if(!n.iso){const i=r.split(":")[0].split(",");for(const o of i){const l=o.trim();if(!l)continue;const c=B0(l);c.iso?n=c:!a&&l.length>0&&l.split(" ").length<=3&&(/^(?:TTE|Echo|Stress Echo)/i.test(l)||(a=l))}}return{date:n.iso,datePrecision:n.precision,site:a,warnings:n.warnings,label:n.label}}function RI(s){const e=s.toLowerCase();return/normal\s+lv\s+(function|size\s+and\s+function|systolic\s+function)/.test(e)?"normal LV function":/(mildly?\s+reduced|mild\s+lv\s+dysfunction|mild\s+systolic\s+dysfunction)/.test(e)?"mild LV dysfunction":/(moderately?\s+reduced|mod(erate)?\s+lv\s+dysfunction|mod\s+dysfunction)/.test(e)?"moderate LV dysfunction":/(severely?\s+reduced|severe\s+lv\s+dysfunction|severe\s+systolic\s+dysfunction)/.test(e)?"severe LV dysfunction":/hyperdynamic/.test(e)?"hyperdynamic LV function":/low\s+normal/.test(e)?"low-normal LV function":null}function MI(s){const e=s.match(/\b(?:at|performed\s+at)\s+([A-Za-z\s]+(?:Hospital|Heart|Centre|Center|Clinic))\b/i);if(e)return e[1].trim()}function _I(s){const e=UI([s.header,...s.body]),r=DI(s.header),a=[...r.warnings];let n=r.site;n||(n=MI(e));const i={id:wi(),modality:s.modality,label:s.header.split(":")[0].trim(),dateIso:r.date,datePrecision:r.datePrecision,site:n,capturedAt:Date.now(),valveGrades:{},structuralFindings:[],notes:[],rawSource:s.sourceLines.join(`
`)},o=e.toLowerCase(),l=s.modality==="stress-echo"?{id:wi(),modality:"stress-echo",label:i.label,description:e,dateIso:i.dateIso,datePrecision:i.datePrecision}:void 0,c=new Set,A=/\b(?:lvef|ef)\s*(?:[:=]?\s*)?(\d{1,3}(?:\.\d+)?)\s*(%|percent)?/gi,d=e.matchAll(A);for(const w of d){const L=Number(w[1]);Number.isFinite(L)&&(!i.lvef||L!==i.lvef?.value)&&(i.lvef=kn(w,{value:L,unit:"%",display:`${L}%`}),c.add("lvef"))}if(!i.lvef||i.lvef&&i.lvef.value==null){const w=RI(o);if(w){const L=e.match(new RegExp(w,"i"));L&&(i.lvefCategory=S0(L,w),c.add("lvefCategory"))}}const h=/\bgls\s*(?:[:=]\s*)?(-?\d{1,2}(?:\.\d+)?)\b/gi;for(const w of e.matchAll(h)){const L=Number(w[1]);Number.isFinite(L)&&(i.gls=kn(w,{value:L,unit:"%",display:`${L}%`}))}const f=/\blvedd\s*[:=]?\s*(\d{2,3}(?:\.\d+)?)\s*(mm)?/gi;for(const w of e.matchAll(f)){const L=Number(w[1]);Number.isFinite(L)&&(i.lvedd=kn(w,{value:L,unit:"mm"}))}const u=/\blavi\s*[:=]?\s*(\d{2,3}(?:\.\d+)?)\s*(?:ml\/m2|ml\/m¬≤|mlm2|ml)?/gi;for(const w of e.matchAll(u)){const L=Number(w[1]);Number.isFinite(L)&&(i.lavi=kn(w,{value:L,unit:"mL/m¬≤"}))}const x=/\btapse\s*[:=]?\s*(\d{1,2}(?:\.\d+)?)\s*(?:mm)?/gi;for(const w of e.matchAll(x)){const L=Number(w[1]);Number.isFinite(L)&&(i.tapse=kn(w,{value:L,unit:"mm"}))}const b=/\b(?:av\s*)?(?:mean\s*gradient|mpg)\s*[:=]?\s*(\d{1,2}(?:\.\d+)?)\s*(?:mm\s*hg|mmhg|mm)?/gi;for(const w of e.matchAll(b)){const L=Number(w[1]);Number.isFinite(L)&&(i.avMpg=kn(w,{value:L,unit:"mmHg",display:`${L} mmHg`}))}const N=/\bdi\s*[:=]?\s*(0\.\d{1,2}|\d(?:\.\d{1,2})?)\b/gi;for(const w of e.matchAll(N)){const L=Number(w[1]);Number.isFinite(L)&&(i.di=kn(w,{value:L,display:L.toFixed(2)}))}const v=/\bava\s*[:=]?\s*(\d(?:\.\d+)?)\s*(?:cm2|cm¬≤|cm\^2|cm\*cm)?/gi;for(const w of e.matchAll(v)){const L=Number(w[1]);Number.isFinite(L)&&(i.ava=kn(w,{value:L,unit:"cm¬≤",display:`${L.toFixed(2)} cm¬≤`}))}const j=/\bsvi\s*[:=]?\s*(\d{2,3}(?:\.\d+)?)\s*(?:ml\/m2|ml\/m¬≤|ml)?/gi;for(const w of e.matchAll(j)){const L=Number(w[1]);Number.isFinite(L)&&(i.svi=kn(w,{value:L,unit:"mL/m¬≤"}))}const I=/\b(RVSP|PASP|TR\s*(?:gradient|‚àÜ|delta|grad))\s*[:=]?\s*(\d{1,3}(?:\.\d+)?)\s*(?:mm\s*hg|mmhg|mm)?(\s*\+\s*RA)?/gi;for(const w of e.matchAll(I)){const L=w[1].toUpperCase(),M=Number(w[2]),P=!!w[3];Number.isFinite(M)&&(P||/TR/.test(L)?(i.trGradient=kn(w,{value:M,unit:"mmHg",flags:["requires-rap"],highlight:"+RA",display:`${M} mmHg`}),i.pasp=S0(w,`${L} ${M}+RA`,["rap-unknown"]),FI(a,`Detected ${L} ${M}+RA ‚Äì RAP not provided.`)):L==="PASP"?i.pasp=kn(w,{value:M,unit:"mmHg",display:`${M} mmHg`}):i.rvsp=kn(w,{value:M,unit:"mmHg",display:`${M} mmHg`}))}const C=new RegExp(`\\b((?:${N0.join("|")})(?:[-/\\s](?:${N0.join("|")}))?)\\s+(AR|MR|TR|aortic regurg(?:itation)?|mitral regurg(?:itation)?|tricuspid regurg(?:itation)?)`,"gi");for(const w of e.matchAll(C)){const L=w[1].replace(/\s+/g," ").toLowerCase(),M=w[2].toLowerCase();let P=null;if((M.startsWith("aortic")||M==="ar")&&(P="ar"),(M.startsWith("mitral")||M==="mr")&&(P="mr"),(M.startsWith("tricuspid")||M==="tr")&&(P="tr"),!P)continue;const K=L.replace(/moderately/g,"mod").replace(/mildly/g,"mild"),$=[];K.includes("mod")&&K.includes("severe")&&$.push("mixed-severity"),K.includes("mild")&&K.includes("mod")&&$.push("mild-mod"),i.valveGrades[P]=PI(P,w,K,$.length?$:void 0)}const E=[],T=/\bholodiastolic\s+flow\s+reversal\b[^.]*?(ascending|descending|upper\s+desc(?:ending)?)?\s*aorta?/gi;for(const w of e.matchAll(T))E.push({id:wi(),label:"Holodiastolic flow reversal",description:w[0].trim(),sourceText:w[0].trim(),category:"ar"});const Q=/\bPHT\s*[:=]?\s*(\d{2,4})\b/gi;for(const w of e.matchAll(Q))E.push({id:wi(),label:"AR pressure half-time",description:`PHT ${w[1]} ms`,sourceText:w[0].trim(),category:"ar"});const D=/\b(rv|right ventricle)\s+(?:mildly\s+|moderately\s+|severely\s+)?(?:dilated|enlarged)\b/gi;for(const w of e.matchAll(D))E.push({id:wi(),label:"RV dilation",description:w[0].trim(),sourceText:w[0].trim(),category:"rv"});const k=/\b(right atrium|RA)\s+(?:mildly\s+|moderately\s+|severely\s+)?(?:enlarged|dilated)\b/gi;for(const w of e.matchAll(k))E.push({id:wi(),label:"RA enlargement",description:w[0].trim(),sourceText:w[0].trim(),category:"rv"});const R=/\bRV\s+(?:function|systolic\s+function)\s+(?:normal|reduced|depressed|impaired)\b/gi;for(const w of e.matchAll(R))E.push({id:wi(),label:"RV function",description:w[0].trim(),sourceText:w[0].trim(),category:"rv"});return s.modality==="stress-echo"&&(i.stressEchoDetails=e),i.structuralFindings=E,i.notes=[...E],i.dateIso||a.push(`No reliable date identified for "${i.label}".`),!c.has("lvef")&&!i.lvefCategory&&a.push(`No EF value detected for "${i.label}".`),{row:i,event:l,rowWarnings:a}}function QI(s,e){const r=s.trim();if(!r)return{rows:[],events:[],warnings:["No input text provided."],notes:[]};const a=LI(r),n=[],i=[],o=[],l=[];return a.forEach(c=>{const{row:A,event:d,rowWarnings:h}=_I(c);n.push(A),d&&i.push(d),h.length>0&&o.push(...h),l.push(...A.structuralFindings)}),n.sort((c,A)=>c.dateIso&&A.dateIso?c.dateIso.localeCompare(A.dateIso):c.dateIso?-1:A.dateIso?1:c.label.localeCompare(A.label)),bt.info("Parsed TTE trend entries",{agent:"tte-trend",rows:n.length,events:i.length,warnings:o.length}),{rows:n,events:i,warnings:o,notes:l}}const OI=864e5,HI=OI*30.4375;function kl(s){if(!s.dateIso)return null;const e=new Date(s.dateIso);return Number.isNaN(e.valueOf())?null:e}function Yn(s){return!s||s.type!=="numeric"?null:typeof s.value=="number"?s.value:null}function tA(s){if(s){if(s.type==="text")return s.text;if(s.type==="numeric")return s.display??`${s.value}${s.unit?` ${s.unit}`:""}`}}function VI(s,e){return(e.getTime()-s.getTime())/HI}function Rc(s){if(s.length<2)return null;const e=s.map(A=>VI(s[0].date,A.date)),r=s.map(A=>A.value),a=s.length,n=e.reduce((A,d)=>A+d,0),i=r.reduce((A,d)=>A+d,0),o=e.reduce((A,d,h)=>A+d*r[h],0),l=e.reduce((A,d)=>A+d*d,0),c=a*l-n*n;return c===0?null:(a*o-n*i)/c}function Mc(s){return s==null?"insufficient-data":s>.25?"rising":s<-.25?"falling":"stable"}function Hi(s,e,r="",a=1){if(s==null||e==null)return;const n=s-e;return Math.abs(n)<.01?void 0:`${n>0?`+${n.toFixed(a)}`:n.toFixed(a)}${r?` ${r}`:""}`}function $I(s,e){if(s==null||e==null||e===0)return;const r=(s-e)/e*100;if(!(!Number.isFinite(r)||Math.abs(r)<1))return`${r>0?"+":""}${r.toFixed(0)}% vs baseline`}function KI(s,e){const r=[...s].sort((a,n)=>a.dateIso&&n.dateIso?a.dateIso.localeCompare(n.dateIso):a.dateIso?1:n.dateIso?-1:0);for(let a=r.length-1;a>=0;a-=1){const n=e(r[a]);if(n)return{row:r[a],value:n}}return{}}function GI(s){const e=[...s].filter(c=>kl(c)!==null).sort((c,A)=>c.dateIso&&A.dateIso?c.dateIso.localeCompare(A.dateIso):0),r=e.map(c=>{const A=Yn(c.lvef);return A!=null?{row:c,date:kl(c),value:A}:null}).filter(c=>c!=null),a=e.map(c=>{const A=Yn(c.rvsp);return A!=null?{row:c,date:kl(c),value:A}:null}).filter(c=>c!=null),n=e.map(c=>{const A=Yn(c.avMpg);return A!=null?{row:c,date:kl(c),value:A}:null}).filter(c=>c!=null),i=e.map(c=>{const A=Yn(c.lvedd);return A!=null?{row:c,date:kl(c),value:A}:null}).filter(c=>c!=null),o=e.map(c=>{const A=Yn(c.lavi);return A!=null?{row:c,date:kl(c),value:A}:null}).filter(c=>c!=null),l=[];if(r.length>0){const c=r.at(-1),A=r.length>1?r.at(-2):void 0,d=r[0],h=Rc(r.map(x=>({date:x.date,value:x.value}))),f=A?A.value:null,u=d?d.value:null;l.push({field:"lvef",label:"LVEF / EF",current:c.row.lvef,previous:A?.row.lvef,baseline:d?.row.lvef,deltaFromPrevious:Hi(c.value,f,"%",0),deltaFromBaseline:$I(c.value,u),slopeValue:h,trajectory:Mc(h),thresholdCrossings:[]})}else{const c=KI(s,A=>A.lvefCategory);c.value&&l.push({field:"lvef",label:"LVEF",current:c.value,previous:void 0,baseline:void 0,deltaFromBaseline:void 0,deltaFromPrevious:void 0,slopeValue:null,trajectory:"insufficient-data",thresholdCrossings:[]})}if(a.length>0){const c=a.at(-1),A=a.length>1?a.at(-2):void 0,d=a[0],h=Rc(a.map(x=>({date:x.date,value:x.value}))),f=A?A.value:null,u=d?d.value:null;l.push({field:"rvsp",label:"RVSP",current:c.row.rvsp,previous:A?.row.rvsp,baseline:d?.row.rvsp,deltaFromPrevious:Hi(c.value,f,"mmHg",0),deltaFromBaseline:Hi(c.value,u,"mmHg",0),slopeValue:h,trajectory:Mc(h),thresholdCrossings:[]})}if(i.length>0){const c=i.at(-1),A=i.length>1?i.at(-2):void 0,d=i[0],h=Rc(i.map(x=>({date:x.date,value:x.value}))),f=A?A.value:null,u=d?d.value:null;l.push({field:"lvedd",label:"LVEDD",current:c.row.lvedd,previous:A?.row.lvedd,baseline:d?.row.lvedd,deltaFromPrevious:Hi(c.value,f,"mm",0),deltaFromBaseline:Hi(c.value,u,"mm",0),slopeValue:h,trajectory:Mc(h),thresholdCrossings:[]})}if(n.length>0){const c=n.at(-1),A=n.length>1?n.at(-2):void 0,d=n[0],h=Rc(n.map(x=>({date:x.date,value:x.value}))),f=A?A.value:null,u=d?d.value:null;l.push({field:"avMpg",label:"AV mean gradient",current:c.row.avMpg,previous:A?.row.avMpg,baseline:d?.row.avMpg,deltaFromPrevious:Hi(c.value,f,"mmHg",0),deltaFromBaseline:Hi(c.value,u,"mmHg",0),slopeValue:h,trajectory:Mc(h),thresholdCrossings:[]})}if(o.length>0){const c=o.at(-1),A=o.length>1?o.at(-2):void 0,d=o[0],h=Rc(o.map(x=>({date:x.date,value:x.value}))),f=A?A.value:null,u=d?d.value:null;l.push({field:"lavi",label:"LAVI",current:c.row.lavi,previous:A?.row.lavi,baseline:d?.row.lavi,deltaFromPrevious:Hi(c.value,f,"mL/m¬≤",0),deltaFromBaseline:Hi(c.value,u,"mL/m¬≤",0),slopeValue:h,trajectory:Mc(h),thresholdCrossings:[]})}return l}function zI(s,e){const r=[],a=s.find(l=>l.field==="lvef");if(a){const l=Yn(a.current),c=Yn(a.previous),A=Yn(a.baseline),d=(h,f)=>{if(l==null)return;const u=[c,A].filter(b=>b!=null);if(u.length===0)return;u.some(b=>b>=h&&l<h||b<h&&l>=h)&&r.push(`LVEF crossed ${h}% (${f})`)};d(50,"HFpEF boundary"),d(40,"HFrEF boundary")}const n=s.find(l=>l.field==="rvsp");if(n){const l=Yn(n.current);l!=null&&(l>=50?r.push("RVSP ‚â•50 mmHg ‚Äì high probability of pulmonary hypertension"):l>=40&&r.push("RVSP ‚â•40 mmHg ‚Äì intermediate probability of pulmonary hypertension"))}const i=s.find(l=>l.field==="avMpg");if(i){const l=Yn(i.current);l!=null&&l>=40&&r.push("AV mean gradient ‚â•40 mmHg ‚Äì severe AS range");const c=[...e].filter(A=>A.di&&A.di.type==="numeric").sort((A,d)=>A.dateIso&&d.dateIso?A.dateIso.localeCompare(d.dateIso):0).at(-1);c&&c.di&&c.di.type==="numeric"&&c.di.value<=.25&&r.push("DI ‚â§0.25 ‚Äì supportive of severe AS")}const o=[...e].filter(l=>l.tapse&&l.tapse.type==="numeric").sort((l,c)=>l.dateIso&&c.dateIso?l.dateIso.localeCompare(c.dateIso):0).at(-1);return o&&o.tapse&&o.tapse.type==="numeric"&&o.tapse.value<17&&r.push("TAPSE <17 mm ‚Äì reduced RV longitudinal function"),r}function Xm(s,e){return s.filter(e).map(a=>a.description||a.label)}function WI(s){const e=[],r=[];s.some(i=>i.lvef&&i.lvef.type==="numeric")||e.push("Numeric EF absent"),s.some(i=>i.avMpg&&i.avMpg.type==="numeric")||e.push("AV mean gradient absent"),s.some(i=>i.rvsp)||e.push("RVSP missing"),s.some(i=>i.lvedd)||e.push("LVEDD missing"),s.some(i=>i.lavi)||e.push("LAVI missing"),s.forEach(i=>{i.pasp?.type==="text"&&i.pasp.flags?.includes("rap-unknown")&&r.push(`PASP ${i.pasp.text} ‚Äì RA pressure not specified`)});const n=Array.from(new Set(s.map(i=>i.site).filter(i=>!!i))).length>1?["Site variability noted"]:[];return{missingMetrics:e,ambiguousFindings:r,interLabChanges:n}}function qI(s,e){if(s.length===0)return"No numeric TTE metrics available";const r=s.find(n=>n.field==="lvef");if(!r)return"Qualitative EF only ‚Äì numeric metrics not captured";const a=Yn(r.current);if(a!=null){const n=e.filter(o=>o.lvef&&o.lvef===r.current).sort((o,l)=>o.dateIso&&l.dateIso?o.dateIso.localeCompare(l.dateIso):0).at(-1),i=n?.dateIso?new Date(n.dateIso).toLocaleDateString(void 0,{month:"short",year:"numeric"}):"";return`Latest EF ${a.toFixed(0)}%${i?` (${i})`:""}`}return`Latest EF: ${tA(r.current)??"qualitative only"}`}function JI(s,e,r,a,n){const i=[],o=s.find(h=>h.field==="lvef");if(o&&o.current){const h=tA(o.current),f=o.deltaFromBaseline??o.deltaFromPrevious,u=o.trajectory&&o.trajectory!=="insufficient-data"?o.trajectory:void 0;i.push(`EF ${h??"unavailable"}${f?` (${f})`:""}${u?`, ${u}`:""}`)}const l=s.find(h=>h.field==="rvsp");if(l&&l.current){const h=tA(l.current),f=l.deltaFromPrevious;i.push(`RVSP ${h??"n/a"}${f?` (${f})`:""}`)}const c=s.find(h=>h.field==="avMpg");if(c&&c.current){const h=tA(c.current);i.push(`AV MPG ${h??"n/a"}`)}const A=s.find(h=>h.field==="lavi");if(A&&A.current){const h=tA(A.current);i.push(`LAVI ${h??"n/a"}`)}const d=[];return i.length>0&&d.push(i.join(" ¬∑ ")),e.length>0&&d.push(e.join("; ")),r.length>0&&d.push(`Right heart: ${r.join("; ")}`),a.length>0&&d.push(`Valves: ${a.join("; ")}`),n.ambiguousFindings.length>0&&d.push(`Ambiguities: ${n.ambiguousFindings.join("; ")}`),n.missingMetrics.length>0&&d.push(`Missing: ${n.missingMetrics.join(", ")}`),d.join(". ")}function YI(s){const e=s.filter(A=>A.modality!=="stress-echo"),r=GI(e),a=zI(r,e),n=Xm(s.flatMap(A=>A.structuralFindings),A=>A.category==="rv"||A.category==="tr"),i=Xm(s.flatMap(A=>A.structuralFindings),A=>A.category==="ar"||A.category==="mr"),o=Xm(s.flatMap(A=>A.structuralFindings),A=>A.category==="other"||A.category==="context"),l=WI(e),c=JI(r,a,n,i,l);return{headline:qI(r,e),narrative:c,metrics:r,thresholds:a,rightHeartContext:n,valveContext:i,structuralHighlights:o,dataQuality:l,patientFriendly:r.length>0?"Your heart ultrasound trend has been summarised for your clinician.":void 0}}const qn={lvef:{key:"lvef",label:"LVEF / EF (%)",color:"#1f2937",unit:"%",precision:0},rvsp:{key:"rvsp",label:"RVSP (mmHg)",color:"#dc2626",unit:"mmHg",precision:0},lvedd:{key:"lvedd",label:"LVEDD (mm)",color:"#0369a1",unit:"mm",precision:0},avMpg:{key:"avMpg",label:"AV MPG (mmHg)",color:"#9a3412",unit:"mmHg",precision:0},lavi:{key:"lavi",label:"LAVI (mL/m¬≤)",color:"#2563eb",unit:"mL/m¬≤",precision:0}},j0=[{id:"hfreF",label:"HFrEF ‚â§40%",max:40,color:"rgba(220, 38, 38, 0.10)",description:"Reduced EF range"},{id:"hfmrEF",label:"HFmrEF 41‚Äì49%",min:40,max:50,color:"rgba(234, 179, 8, 0.12)",description:"Mid-range EF"},{id:"hfpEF",label:"HFpEF ‚â•50%",min:50,color:"rgba(34, 197, 94, 0.10)",description:"Preserved EF"}],E0=[{id:"normal",label:"<40 mmHg",max:40,color:"rgba(59, 130, 246, 0.08)",description:"Low probability PH"},{id:"intermediate",label:"40‚Äì49 mmHg",min:40,max:50,color:"rgba(234, 179, 8, 0.12)",description:"Intermediate probability PH"},{id:"high",label:"‚â•50 mmHg",min:50,color:"rgba(220, 38, 38, 0.12)",description:"High probability PH"}],k0=[{id:"reference",label:"Reference 35‚Äì60 mm (general)",min:35,max:60,color:"rgba(148, 163, 184, 0.10)",description:"ASE reference range (sex/BSA dependent)"}],I0=[{id:"mild",label:"<20 mmHg",max:20,color:"rgba(34, 197, 94, 0.10)",description:"Mild AS"},{id:"moderate",label:"20‚Äì39 mmHg",min:20,max:40,color:"rgba(234, 179, 8, 0.12)",description:"Moderate AS"},{id:"severe",label:"‚â•40 mmHg",min:40,color:"rgba(220, 38, 38, 0.12)",description:"Severe AS"}],_c={label:"TAPSE 17 mm",value:17,color:"#dc2626",dash:[6,6]},Vl={timeFilter:"12m",showLVEFOnly:!1,enabledSeries:{lvef:!0,rvsp:!1,lvedd:!1,avMpg:!1,lavi:!1},contextBands:{lvef:!0,rvsp:!0,lvedd:!0,avMpg:!0,tapse:!0,lavi:!1}},XI=[{value:"6m",label:"Last 6 months"},{value:"12m",label:"Last 12 months"},{value:"24m",label:"Last 24 months"},{value:"all",label:"All time"}],xi={LATEST:"tte-trend-latest",SETTINGS:"tte-trend-settings",HISTORY:"tte-trend-history"},ZI=5;class $l{static instance;static getInstance(){return $l.instance||($l.instance=new $l),$l.instance}async saveSession(e){await chrome.storage.local.set({[xi.LATEST]:e}),await this.appendHistory(e),bt.info("TTE trend session saved",{component:"tte-trend-storage",rows:e.rows.length})}async loadLatestSession(){return(await chrome.storage.local.get(xi.LATEST))[xi.LATEST]??null}async clearLatest(){await chrome.storage.local.remove(xi.LATEST)}async saveSettings(e){await chrome.storage.local.set({[xi.SETTINGS]:e})}async loadSettings(){const r=(await chrome.storage.local.get(xi.SETTINGS))[xi.SETTINGS];return r?{...Vl,...r,enabledSeries:{...Vl.enabledSeries,...r.enabledSeries},contextBands:{...Vl.contextBands,...r.contextBands}}:Vl}async appendHistory(e){try{const a=(await chrome.storage.local.get(xi.HISTORY))[xi.HISTORY]??[];a.unshift(e);const n=a.slice(0,ZI);await chrome.storage.local.set({[xi.HISTORY]:n})}catch(r){bt.warn("Failed to append TTE trend history",{component:"tte-trend-storage",error:r instanceof Error?r.message:"unknown"})}}}function e3(s){if(!s.dateIso)return null;const e=new Date(s.dateIso);return Number.isNaN(e.valueOf())?null:e}function t3(s,e){switch(e){case"lvef":return s.lvef&&s.lvef.type==="numeric"?s.lvef.value:null;case"rvsp":return s.rvsp&&s.rvsp.type==="numeric"?s.rvsp.value:null;case"lvedd":return s.lvedd&&s.lvedd.type==="numeric"?s.lvedd.value:null;case"avMpg":return s.avMpg&&s.avMpg.type==="numeric"?s.avMpg.value:null;case"lavi":return s.lavi&&s.lavi.type==="numeric"?s.lavi.value:null;default:return null}}function T0(s,e){return s.map(r=>{const a=e3(r);if(!a)return null;const n=t3(r,e);return n==null?null:{row:r,date:a,value:n,field:e}}).filter(r=>r!=null).sort((r,a)=>r.date.getTime()-a.date.getTime())}function F0(s){return new Date(Date.UTC(s.getUTCFullYear(),s.getUTCMonth(),1))}function Qc(s){const e=new Date(s);return e.setUTCMonth(e.getUTCMonth()+1),e}function P0(s){if(s.length===0)return[];const e=s.map(o=>o.date).sort((o,l)=>o.getTime()-l.getTime()),r=F0(e[0]),a=F0(e.at(-1)),n=[];let i=new Date(r);for(;i<=a;)n.push({date:new Date(i),label:i.toLocaleDateString(void 0,{month:"short",year:"2-digit"})}),i=Qc(i);return n.length===0&&(n.push({date:new Date(r),label:r.toLocaleDateString(void 0,{month:"short",year:"2-digit"})}),n.push({date:Qc(r),label:Qc(r).toLocaleDateString(void 0,{month:"short",year:"2-digit"})})),n.length===1&&n.push({date:Qc(n[0].date),label:Qc(n[0].date).toLocaleDateString(void 0,{month:"short",year:"2-digit"})}),n}function U0(s,e){if(s===e)return{min:s-5,max:e+5};const r=(e-s)*.15;return{min:Math.floor(s-r),max:Math.ceil(e+r)}}const s3=2,r3=({rows:s,settings:e,onPointClick:r})=>{const a=m.useRef(null),n=m.useRef(null),[i,o]=m.useState({visible:!1,x:0,y:0,text:""}),[l,c]=m.useState({width:640,height:360}),A=m.useMemo(()=>T0(s,"lvef"),[s]),d=m.useMemo(()=>e.showLVEFOnly?null:["rvsp","lvedd","avMpg","lavi"].find(b=>e.enabledSeries[b])??null,[e]),h=m.useMemo(()=>d?T0(s,d):[],[s,d]),f=m.useMemo(()=>{const u=[...A,...h];return u.length===0?[]:P0(u)},[A,h]);return m.useEffect(()=>{const u=()=>{if(!n.current)return;const x=n.current.clientWidth;c({width:Math.max(320,x-12),height:360})};return u(),window.addEventListener("resize",u),()=>window.removeEventListener("resize",u)},[]),m.useEffect(()=>{const u=a.current;if(!u)return;const x=u.getContext("2d");if(!x)return;const{width:b,height:N}=l,v=window.devicePixelRatio||1;u.width=b*v,u.height=N*v,u.style.width=`${b}px`,u.style.height=`${N}px`,x.scale(v,v),x.clearRect(0,0,b,N);const j={top:48,right:d?70:40,bottom:64,left:60},I=b-j.left-j.right,C=N-j.top-j.bottom;if(A.length===0&&h.length===0){x.fillStyle="#94a3b8",x.font="13px Inter, sans-serif",x.textAlign="center",x.fillText("No chartable metrics detected",b/2,N/2);return}const E=A.map(G=>G.value),Q=(e.contextBands.lvef?j0:[]).reduce((G,X)=>(typeof X.min=="number"&&(G.min=Math.min(G.min,X.min)),typeof X.max=="number"&&(G.max=Math.max(G.max,X.max)),G),{min:Math.min(...E,20),max:Math.max(...E,80)});let D=Math.min(...E,Q.min),k=Math.max(...E,Q.max);(!Number.isFinite(D)||Number.isNaN(D))&&(D=20),(!Number.isFinite(k)||Number.isNaN(k))&&(k=80),{min:D,max:k}=U0(D,k),D=Math.min(D,0),k=Math.max(k,90);const R=h.map(G=>G.value);let w=R.length>0?Math.min(...R):0,L=R.length>0?Math.max(...R):0;d&&R.length>=s3?((d==="rvsp"?E0:d==="lvedd"?k0:d==="avMpg"?I0:[]).forEach(X=>{typeof X.min=="number"&&(w=Math.min(w,X.min)),typeof X.max=="number"&&(L=Math.max(L,X.max))}),{min:w,max:L}=U0(w,L),d==="rvsp"&&(w=Math.max(w,0))):d&&(w=0,L=d==="rvsp"?80:d==="lvedd"?70:d==="avMpg"?60:120);const M=f.length>0?f:P0(A),P=M[0]?.date??A[0]?.date??h[0]?.date??new Date,K=M.at(-1)?.date??A.at(-1)?.date??h.at(-1)?.date??new Date(P),$=G=>{const X=K.getTime()-P.getTime()||1,le=G.getTime()-P.getTime();return j.left+le/X*I},O=G=>j.top+C-(G-D)/(k-D||1)*C,W=G=>j.top+C-(G-w)/(L-w||1)*C;if(x.strokeStyle="#e2e8f0",x.lineWidth=1,x.beginPath(),x.moveTo(j.left,j.top),x.lineTo(j.left,j.top+C),x.lineTo(j.left+I,j.top+C),x.stroke(),x.fillStyle="#64748b",x.font="11px Inter, sans-serif",x.textAlign="center",x.textBaseline="top",M.forEach((G,X)=>{const le=M.length===1?j.left+I/2:j.left+X/(M.length-1)*I;x.fillText(G.label,le,j.top+C+12),x.beginPath(),x.strokeStyle="rgba(226, 232, 240, 0.6)",x.moveTo(le,j.top),x.lineTo(le,j.top+C),x.stroke()}),x.save(),e.contextBands.lvef&&j0.forEach(G=>{const X=G.max!=null?O(G.max):j.top,le=G.min!=null?O(G.min):j.top+C;x.fillStyle=G.color,x.fillRect(j.left,Math.min(X,le),I,Math.abs(le-X)),x.fillStyle="#475569",x.font="10px Inter, sans-serif",x.fillText(G.label,j.left+6,Math.min(X,le)+10)}),d&&e.contextBands[d]&&(d==="rvsp"?E0:d==="lvedd"?k0:d==="avMpg"?I0:[]).forEach(X=>{const le=X.max!=null?W(X.max):j.top,he=X.min!=null?W(X.min):j.top+C;x.fillStyle=X.color,x.fillRect(j.left,Math.min(le,he),I,Math.abs(he-le)),x.fillStyle="#475569",x.font="10px Inter, sans-serif",x.textAlign="right",x.fillText(X.label,j.left+I-6,Math.min(le,he)+10),x.textAlign="left"}),x.restore(),x.fillStyle="#0f172a",x.font="12px Inter, sans-serif",x.textAlign="center",x.fillText("Month",j.left+I/2,j.top+C+42),x.save(),x.translate(20,j.top+C/2),x.rotate(-Math.PI/2),x.fillText("LVEF / EF (%)",0,0),x.restore(),d&&(x.save(),x.translate(b-18,j.top+C/2),x.rotate(Math.PI/2),x.fillText(qn[d].label,0,0),x.restore()),e.contextBands.tapse){const G=[...s].filter(X=>X.tapse&&X.tapse.type==="numeric").sort((X,le)=>X.dateIso&&le.dateIso?X.dateIso.localeCompare(le.dateIso):0).at(-1);if(G&&G.tapse&&G.tapse.type==="numeric"){const X=_c.value,le=d?W(X):O(X);x.save(),x.setLineDash(_c.dash??[5,5]),x.strokeStyle=_c.color,x.lineWidth=1,x.beginPath(),x.moveTo(j.left,le),x.lineTo(j.left+I,le),x.stroke(),x.restore(),x.fillStyle=_c.color,x.font="10px Inter, sans-serif",x.fillText(_c.label,j.left+I-6,le-6)}}const ee=(G,X,le)=>{if(G.length===0)return;const he=qn[X];x.strokeStyle=he.color,x.lineWidth=2,x.lineJoin="round",x.beginPath(),G.forEach((ve,ke)=>{const Le=$(ve.date),Be=le(ve.value);ke===0?x.moveTo(Le,Be):x.lineTo(Le,Be)}),x.stroke(),G.forEach(ve=>{const ke=$(ve.date),Le=le(ve.value);x.beginPath(),x.fillStyle="#fff",x.strokeStyle=he.color,x.lineWidth=2,x.arc(ke,Le,4,0,Math.PI*2),x.fill(),x.stroke()})};ee(A,"lvef",O),d&&ee(h,d,d==="lvef"?O:W),x.fillStyle="#475569",x.font="10px Inter, sans-serif",x.textAlign="right";const V=6;for(let G=0;G<=V;G+=1){const X=D+G/V*(k-D),le=O(X);x.fillText(`${X.toFixed(0)}`,j.left-6,le+3),x.beginPath(),x.strokeStyle="rgba(226, 232, 240, 0.45)",x.moveTo(j.left,le),x.lineTo(j.left+I,le),x.stroke()}if(d){x.textAlign="left";for(let G=0;G<=V;G+=1){const X=w+G/V*(L-w),le=W(X);x.fillText(`${X.toFixed(0)}`,j.left+I+6,le+3)}}const q=[{label:qn.lvef.label,color:qn.lvef.color}];d&&d!=="lvef"&&q.push({label:qn[d].label,color:qn[d].color});const S=j.left,H=j.top-32;x.font="11px Inter, sans-serif",x.textAlign="left",q.forEach((G,X)=>{const le=S,he=H+X*16;x.fillStyle=G.color,x.fillRect(le,he,28,2),x.fillStyle="#0f172a",x.fillText(G.label,le+36,he+4)});const Y=G=>{const X=u.getBoundingClientRect(),le=u.width/X.width,he=u.height/X.height,ve=(G.clientX-X.left)*le,ke=(G.clientY-X.top)*he,Le=[...A,...h].find(Be=>{const Re=$(Be.date),re=Be.field==="lvef"?O(Be.value):W(Be.value);return Math.sqrt((Re*v-ve)**2+(re*v-ke)**2)<12});if(Le){const Be=Le.date.toLocaleDateString(void 0,{day:"numeric",month:"short",year:"numeric"}),Re=Le.value.toFixed(qn[Le.field].precision),re=Le.row.site?` ¬∑ ${Le.row.site}`:"";o({visible:!0,x:$(Le.date),y:Le.field==="lvef"?O(Le.value):W(Le.value),text:`${Be}${re}
${qn[Le.field].label.split(" ")[0]} ${Re}`}),u.style.cursor="pointer"}else o(Be=>Be.visible?{...Be,visible:!1}:Be),u.style.cursor="default"},te=G=>{if(!r)return;const X=u.getBoundingClientRect(),le=u.width/X.width,he=u.height/X.height,ve=(G.clientX-X.left)*le,ke=(G.clientY-X.top)*he,Le=[...A,...h].find(Be=>{const Re=$(Be.date),re=Be.field==="lvef"?O(Be.value):W(Be.value);return Math.sqrt((Re*v-ve)**2+(re*v-ke)**2)<14});Le&&r(Le.row.id,Le.field)};return u.addEventListener("pointermove",Y),u.addEventListener("click",te),()=>{u.removeEventListener("pointermove",Y),u.removeEventListener("click",te)}},[l,A,h,d,f,r,s,e]),t.jsxs("div",{ref:n,className:"relative w-full",children:[t.jsx("canvas",{ref:a,className:"w-full rounded-xl border border-slate-200 bg-white shadow-sm"}),i.visible&&t.jsx("div",{className:"absolute z-10 rounded-md border border-slate-300 bg-white px-3 py-2 text-xs text-slate-700 shadow-lg",style:{left:i.x+12,top:i.y+12},children:i.text.split(`
`).map(u=>t.jsx("div",{children:u},u))})]})},a3=({settings:s,onToggleSeries:e,onTimeFilterChange:r,onShowLVEFOnlyChange:a,onToggleContext:n})=>{const i=["rvsp","lvedd","avMpg","lavi"],o=["lvef","rvsp","lvedd","avMpg","tapse"];return t.jsx("div",{className:"rounded-xl border border-slate-200 bg-surface-secondary px-3 py-3 text-sm text-slate-700",children:t.jsxs("div",{className:"flex flex-col gap-3",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("span",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Series"}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs(ye,{type:"button",variant:"outline",size:"sm",fullWidth:!0,className:"!justify-between border-slate-300 bg-white text-slate-800 shadow-sm !h-auto py-1.5",disabled:!0,children:[t.jsx("span",{children:qn.lvef.label}),t.jsx("span",{className:"rounded bg-slate-200 px-2 py-0.5 text-[10px] font-semibold uppercase text-slate-600",children:"Default"})]}),t.jsx("div",{className:"flex flex-col gap-2",children:i.map(l=>{const c=s.enabledSeries[l];return t.jsxs(ye,{type:"button",variant:c?"primary":"outline",size:"sm",fullWidth:!0,className:`!h-auto py-1.5 ${c?"border-slate-900 bg-slate-900 hover:bg-slate-800":"border-slate-300 bg-white text-slate-700 hover:border-slate-400"}`,onClick:()=>e(l),children:[t.jsx("span",{className:"inline-flex h-2.5 w-2.5 rounded-full mr-2",style:{backgroundColor:qn[l].color}}),qn[l].label]},l)})})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("span",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Time window"}),t.jsx("div",{className:"flex flex-col gap-2",children:XI.map(l=>t.jsx(ye,{type:"button",onClick:()=>r(l.value),variant:s.timeFilter===l.value?"primary":"outline",size:"sm",fullWidth:!0,className:`!justify-start !h-auto py-1.5 ${s.timeFilter===l.value?"border-slate-900 bg-slate-900":"border-slate-300 bg-white text-slate-700 hover:border-slate-400"}`,children:l.label},l.value))})]}),t.jsxs("label",{className:"inline-flex w-full cursor-pointer items-center gap-2 rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-xs text-slate-700",children:[t.jsx("input",{type:"checkbox",className:"h-3 w-3 rounded border-slate-300",checked:s.showLVEFOnly,onChange:l=>a(l.target.checked)}),"Show LVEF only"]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("span",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Context overlays"}),t.jsx("div",{className:"grid grid-cols-2 gap-2",children:o.map(l=>{const c=s.contextBands[l];return t.jsx(ye,{type:"button",variant:c?"primary":"outline",size:"sm",className:`!h-auto py-1 ${c?"border-slate-900 bg-slate-900/90":"border-slate-300 bg-white text-slate-600 hover:border-slate-400"}`,onClick:()=>n(l),children:l.toUpperCase()},l)})})]})]})})};function n3(s){if(!s.dateIso)return s.label;const e=new Date(s.dateIso),r=s.datePrecision==="month"?{month:"short",year:"numeric"}:{day:"numeric",month:"short",year:"numeric"};return e.toLocaleDateString(void 0,r)}function i3(s){switch(s){case"lvef":return"%";case"rvsp":return"mmHg";case"lvedd":return"mm";case"avMpg":return"mmHg";case"tapse":return"mm";case"gls":return"%";case"lavi":return"mL/m¬≤";case"di":return"ratio";case"ava":return"cm¬≤";case"svi":return"mL/m¬≤";default:return""}}const o3=({rows:s,onMetricUpdate:e})=>{const r=m.useMemo(()=>[...s].sort((n,i)=>n.dateIso&&i.dateIso?n.dateIso.localeCompare(i.dateIso):n.dateIso?-1:i.dateIso?1:n.label.localeCompare(i.label)),[s]),a=(n,i,o)=>{const l=o&&o.type==="numeric"?o.value.toString():o&&o.type==="text"?o.text:"",c=i3(i),A=o?.sourceText?`Source: ${o.sourceText}`:void 0,d=o?.type==="numeric";return t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"text",className:"w-full rounded-md border border-slate-300 px-2 py-1 text-xs text-slate-800",value:l,placeholder:c,title:A,onChange:h=>e(n.id,i,h.target.value)}),o?.sourceText&&t.jsx("span",{className:"inline-flex",title:o.sourceText,children:t.jsx(Ma,{className:"h-3.5 w-3.5 text-slate-400","aria-hidden":"true"})}),!l&&!d&&c&&t.jsx("span",{className:"text-[10px] text-slate-400",children:c})]})};return t.jsxs("div",{className:"overflow-x-auto rounded-xl border border-slate-200 bg-white shadow-sm",children:[t.jsxs("table",{className:"min-w-full divide-y divide-slate-200 text-xs",children:[t.jsx("thead",{className:"bg-slate-50 text-left uppercase tracking-wide text-slate-500",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-3 py-2 font-semibold",children:"Date"}),t.jsx("th",{className:"px-3 py-2 font-semibold",children:"Site"}),t.jsx("th",{className:"px-3 py-2 font-semibold",children:"LVEF / EF"}),t.jsx("th",{className:"px-3 py-2 font-semibold",children:"RVSP / PASP"}),t.jsx("th",{className:"px-3 py-2 font-semibold",children:"LVEDD"}),t.jsx("th",{className:"px-3 py-2 font-semibold",children:"AV MPG"}),t.jsx("th",{className:"px-3 py-2 font-semibold",children:"TAPSE"}),t.jsx("th",{className:"px-3 py-2 font-semibold",children:"GLS"}),t.jsx("th",{className:"px-3 py-2 font-semibold",children:"LAVI"}),t.jsx("th",{className:"px-3 py-2 font-semibold",children:"DI"}),t.jsx("th",{className:"px-3 py-2 font-semibold",children:"AVA"}),t.jsx("th",{className:"px-3 py-2 font-semibold",children:"Valves"}),t.jsx("th",{className:"px-3 py-2 font-semibold",children:"Notes"})]})}),t.jsx("tbody",{className:"divide-y divide-slate-100",children:r.map(n=>t.jsxs("tr",{className:"hover:bg-slate-50/60",children:[t.jsx("td",{className:"px-3 py-2 font-medium text-slate-800",children:n3(n)}),t.jsx("td",{className:"px-3 py-2 text-slate-600",children:n.site??"‚Äî"}),t.jsx("td",{className:"px-3 py-2",children:a(n,"lvef",n.lvef??n.lvefCategory)}),t.jsx("td",{className:"px-3 py-2",children:a(n,"rvsp",n.rvsp??n.pasp??n.trGradient)}),t.jsx("td",{className:"px-3 py-2",children:a(n,"lvedd",n.lvedd)}),t.jsx("td",{className:"px-3 py-2",children:a(n,"avMpg",n.avMpg)}),t.jsx("td",{className:"px-3 py-2",children:a(n,"tapse",n.tapse)}),t.jsx("td",{className:"px-3 py-2",children:a(n,"gls",n.gls)}),t.jsx("td",{className:"px-3 py-2",children:a(n,"lavi",n.lavi)}),t.jsx("td",{className:"px-3 py-2",children:a(n,"di",n.di)}),t.jsx("td",{className:"px-3 py-2",children:a(n,"ava",n.ava)}),t.jsxs("td",{className:"px-3 py-2 text-slate-600",children:[["ar","mr","tr"].map(i=>n.valveGrades[i]).filter(i=>!!i).map(i=>t.jsxs("span",{className:"mr-2 inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-700",title:i.sourceText,children:[i.valve.toUpperCase()," ",i.severity]},i.id)),!n.valveGrades.ar&&!n.valveGrades.mr&&!n.valveGrades.tr&&t.jsx("span",{children:"‚Äî"})]}),t.jsx("td",{className:"px-3 py-2 text-slate-600",children:n.notes.length>0?t.jsx("div",{className:"flex flex-col gap-1",children:n.notes.map(i=>t.jsxs("span",{className:"rounded bg-slate-100 px-2 py-0.5 text-[10px] text-slate-700",title:i.sourceText,children:[i.label,": ",i.description]},i.id))}):"‚Äî"})]},n.id))})]}),r.length===0&&t.jsx("div",{className:"p-6 text-center text-sm text-slate-500",children:"Import TTE entries from the EMR to populate this table."})]})},l3=({insights:s})=>{const e=m.useCallback(()=>{if(!s)return;const r=`${s.headline}
${s.narrative}`;navigator.clipboard.writeText(r).then(()=>{gt.getInstance().success("Copied","Insights copied to clipboard.")}).catch(()=>{gt.getInstance().error("Copy failed","Unable to access clipboard.")})},[s]);return s?t.jsxs("div",{className:"space-y-4 rounded-xl border border-slate-200 bg-white p-5 shadow-sm",children:[t.jsxs("div",{className:"flex items-start justify-between gap-4",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-base font-semibold text-slate-900",children:s.headline}),t.jsx("p",{className:"mt-1 text-sm text-slate-700",children:s.narrative})]}),t.jsx(ye,{onClick:e,variant:"secondary",size:"sm",startIcon:t.jsx(CA,{}),className:"bg-slate-900 text-white hover:bg-slate-800",children:"Copy summary"})]}),t.jsxs("div",{className:"grid gap-4 lg:grid-cols-2",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx("h4",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500",children:"Metric trajectory"}),t.jsx("div",{className:"space-y-2 text-sm text-slate-700",children:s.metrics.map(r=>t.jsxs("div",{className:"rounded-lg border border-slate-200 bg-slate-50 px-3 py-2",children:[t.jsx("div",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500",children:r.label}),t.jsxs("div",{className:"mt-1 text-sm text-slate-700",children:[r.current?t.jsxs(t.Fragment,{children:["Latest:"," ",t.jsx("span",{className:"font-semibold",children:(r.current.type==="numeric"?r.current.display??`${r.current.value}${r.current.unit?` ${r.current.unit}`:""}`:r.current.text)||"n/a"})]}):"No recent value",r.deltaFromPrevious&&t.jsxs("span",{className:"ml-2 text-xs text-slate-500",children:["vs prior ",r.deltaFromPrevious]}),r.deltaFromBaseline&&t.jsxs("span",{className:"ml-2 text-xs text-slate-500",children:["(",r.deltaFromBaseline,")"]}),r.trajectory&&r.trajectory!=="insufficient-data"&&t.jsxs("span",{className:"ml-2 inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 text-[11px] text-slate-700",children:[t.jsx(ei,{className:"h-3 w-3 text-emerald-500"}),r.trajectory]})]})]},r.field))})]}),t.jsxs("div",{className:"space-y-3",children:[s.thresholds.length>0&&t.jsxs("div",{children:[t.jsx("h4",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500",children:"Thresholds crossed"}),t.jsx("ul",{className:"mt-1 space-y-1 text-sm text-slate-700",children:s.thresholds.map(r=>t.jsxs("li",{className:"flex items-center gap-2",children:[t.jsx(xr,{className:"h-3.5 w-3.5 text-amber-500"}),r]},r))})]}),s.rightHeartContext.length>0&&t.jsxs("div",{children:[t.jsx("h4",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500",children:"Right heart"}),t.jsx("ul",{className:"mt-1 space-y-1 text-sm text-slate-700",children:s.rightHeartContext.map(r=>t.jsx("li",{children:r},r))})]}),s.valveContext.length>0&&t.jsxs("div",{children:[t.jsx("h4",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500",children:"Valve trajectory"}),t.jsx("ul",{className:"mt-1 space-y-1 text-sm text-slate-700",children:s.valveContext.map(r=>t.jsx("li",{children:r},r))})]}),(s.dataQuality.missingMetrics.length>0||s.dataQuality.ambiguousFindings.length>0)&&t.jsxs("div",{children:[t.jsx("h4",{className:"text-xs font-semibold uppercase tracking-wide text-slate-500",children:"Data quality"}),t.jsxs("ul",{className:"mt-1 space-y-1 text-sm text-slate-700",children:[s.dataQuality.missingMetrics.map(r=>t.jsxs("li",{children:["Missing: ",r]},r)),s.dataQuality.ambiguousFindings.map(r=>t.jsxs("li",{children:["Ambiguity: ",r]},r))]})]})]})]})]}):t.jsx("div",{className:"rounded-xl border border-slate-200 bg-white p-4 text-sm text-slate-600 shadow-sm",children:"Clinical insights will appear once TTE data is parsed."})},c3=Ni.getInstance(),A3=(s,e)=>({id:`manual-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,type:"numeric",value:s,unit:e,display:e?e==="%"?`${s}${e}`:`${s} ${e}`:s.toString(),sourceText:"Manual edit",rawText:"Manual edit",flags:["manual"]}),d3=s=>({id:`manual-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,type:"text",text:s,sourceText:"Manual edit",rawText:s,flags:["manual"]});function u3(s,e){if(e==="all")return s;const r=e==="6m"?6:e==="12m"?12:24,a=s.filter(o=>o.dateIso);if(a.length===0)return s;const n=new Date(a.at(-1).dateIso),i=new Date(n);return i.setMonth(i.getMonth()-r),s.filter(o=>o.dateIso?new Date(o.dateIso)>=i:!0)}const m3=({isOpen:s,onClose:e})=>{const[r,a]=m.useState("idle"),[n,i]=m.useState([]),[o,l]=m.useState(""),[c,A]=m.useState([]),[d,h]=m.useState(null),[f,u]=m.useState("emr"),[x,b]=m.useState(!1),[N,v]=m.useState(!1),[j,I]=m.useState(Vl),[C,E]=m.useState(null),[T,Q]=m.useState(null),[D,k]=m.useState(!1),[R,w]=m.useState([]),L=m.useRef($l.getInstance());m.useEffect(()=>{(async()=>{const G=await L.current.loadSettings().catch(()=>Vl);I(X=>({...X,...G,enabledSeries:{...X.enabledSeries,...G.enabledSeries},contextBands:{...X.contextBands,...G.contextBands}}))})()},[]),m.useEffect(()=>{if(n.length===0){E(null);return}E(YI(n))},[n]),m.useEffect(()=>{L.current.saveSettings(j).catch(()=>{})},[j]);const M=m.useMemo(()=>u3(n,j.timeFilter),[n,j.timeFilter]),P=m.useCallback(G=>{if(G==="lvef"){I(X=>({...X,showLVEFOnly:!X.showLVEFOnly}));return}I(X=>{const le={...X.enabledSeries,lvef:!0};return Object.keys(le).forEach(he=>{he!=="lvef"&&(le[he]=!1)}),le[G]=!X.enabledSeries[G],{...X,enabledSeries:le,showLVEFOnly:!1}})},[]),K=m.useCallback(G=>{I(X=>({...X,timeFilter:G}))},[]),$=m.useCallback(G=>{I(X=>({...X,contextBands:{...X.contextBands,[G]:!X.contextBands[G]}}))},[]),O=m.useCallback(async G=>{try{await L.current.saveSession(G)}catch(X){console.warn("Failed to persist TTE trend session",X)}},[]);m.useEffect(()=>{if(r!=="ready"||n.length===0)return;const G={id:`tte-session-${d??Date.now()}`,timestamp:d??Date.now(),sourceType:f,rawText:o,rows:n,notes:n.flatMap(X=>X.notes),settings:j};O(G)},[n,j,o,f,r,d,O]);const W=m.useCallback(async(G,X)=>{a("capturing");try{const le=performance.now(),he=QI(G),ve=performance.now()-le;if(c3.recordMetrics("agent-processing",ve,{agentType:"tte-trend-import"}),he.rows.length===0){a("error"),A(he.warnings),gt.getInstance().warning("No TTE entries detected","Review the capture or paste text manually.");return}i(he.rows),l(G),A(he.warnings),h(Date.now()),u(X),w(he.events.map(Le=>`${Le.label} ‚Ä¢ ${Le.description}`)),a("ready");const ke={id:`tte-session-${Date.now()}`,timestamp:Date.now(),sourceType:X,rawText:G,rows:he.rows,notes:he.notes,settings:j};O(ke),gt.getInstance().success("TTE data captured",`Parsed ${he.rows.length} echo${he.rows.length===1?"":"es"} from Investigation summary.`)}catch(le){console.error("Failed to parse TTE trends",le),a("error"),gt.getInstance().error("Parsing failed",le instanceof Error?le.message:"Unknown error")}},[O,j]),ee=m.useCallback(async()=>{a("capturing");try{const G=await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"investigation-summary",data:{extractOnly:!0}});if(!G?.success)throw new Error(G?.error||"Capture failed");if(!G.data||G.data.trim().length===0){v(!0),a("error"),gt.getInstance().warning("No Investigation Summary content","Click ‚ÄúPaste text‚Äù to provide the investigation entries manually.");return}await W(G.data,"emr")}catch(G){console.error("EMR capture failed",G),a("error"),v(!0),gt.getInstance().error("Capture failed",G instanceof Error?G.message:"Unknown error")}},[W]),V=m.useCallback(async G=>{G.preventDefault();const le=new FormData(G.currentTarget).get("ttePaste")??"";if(!le.trim()){gt.getInstance().warning("Paste text missing","Provide Investigation summary text to parse.");return}await W(le,"paste"),v(!1)},[W]),q=m.useCallback(async()=>{k(!0);try{const G=await L.current.loadLatestSession();if(!G){gt.getInstance().info("No stored session","Import from EMR to create a session.");return}G.settings&&I(X=>({...X,...G.settings,enabledSeries:{...X.enabledSeries,...G.settings.enabledSeries},contextBands:{...X.contextBands,...G.settings.contextBands}})),i(G.rows),l(G.rawText),h(G.timestamp),u(G.sourceType),A([]),a("ready"),gt.getInstance().success("Loaded previous capture","Restored the most recent TTE trend session.")}finally{k(!1)}},[]),S=m.useCallback((G,X,le)=>{i(he=>he.map(ve=>{if(ve.id!==G)return ve;const ke=le.trim(),Le={...ve},Be=be=>{switch(X){case"rvsp":be.rvsp=void 0;break;case"lvef":be.lvef=void 0,be.lvefCategory=void 0;break;case"lvedd":be.lvedd=void 0;break;case"avMpg":be.avMpg=void 0;break;case"tapse":be.tapse=void 0;break;case"gls":be.gls=void 0;break;case"lavi":be.lavi=void 0;break;case"di":be.di=void 0;break;case"ava":be.ava=void 0;break;case"svi":be.svi=void 0;break}};if(!ke)return Be(Le),Le;const Re=Number(ke.replace(/[^\d.-]/g,"")),Pe=Number.isFinite(Re)?A3(Re,X==="lvef"?"%":X==="rvsp"?"mmHg":X==="lvedd"?"mm":X==="avMpg"?"mmHg":X==="tapse"?"mm":X==="gls"?"%":X==="lavi"?"mL/m¬≤":X==="di"?void 0:X==="ava"?"cm¬≤":X==="svi"?"mL/m¬≤":void 0):d3(ke);if(X==="rvsp")Le.rvsp=Pe;else if(X==="lvef")Pe.type==="numeric"?(Le.lvef=Pe,Le.lvefCategory=void 0):(Le.lvef=void 0,Le.lvefCategory=Pe);else switch(X){case"lvedd":Le.lvedd=Pe;break;case"avMpg":Le.avMpg=Pe;break;case"tapse":Le.tapse=Pe;break;case"gls":Le.gls=Pe;break;case"lavi":Le.lavi=Pe;break;case"di":Le.di=Pe;break;case"ava":Le.ava=Pe;break;case"svi":Le.svi=Pe;break}return Le}))},[]),H=m.useCallback(G=>{I(X=>({...X,showLVEFOnly:G,enabledSeries:{...X.enabledSeries,rvsp:!1,lvedd:!1,avMpg:!1}}))},[]),Y=m.useCallback((G,X)=>{Q({rowId:G,field:X})},[]),te=m.useMemo(()=>{if(!T)return null;const G=n.find(le=>le.id===T.rowId);if(!G)return null;let X;return T.field==="rvsp"?X=G.rvsp??G.pasp??G.trGradient:T.field==="lvef"?X=G.lvef??G.lvefCategory:T.field==="lvedd"?X=G.lvedd:T.field==="avMpg"?X=G.avMpg:T.field==="lavi"&&(X=G.lavi),{row:G,value:X}},[n,T]);return s?t.jsx("div",{className:"fixed inset-0 z-40 flex items-center justify-center bg-slate-900/40 p-2",children:t.jsxs("div",{className:"flex h-[90vh] w-full flex-col overflow-hidden rounded-modal border border-slate-200 bg-white shadow-modal",children:[t.jsxs("header",{className:"flex items-start justify-between border-b border-slate-200 px-3 py-2.5",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-base font-semibold text-slate-900",children:"Echo (TTE) Trends"}),t.jsx("p",{className:"mt-0.5 text-[11px] text-slate-600",children:"Import & visualize TTE metrics"})]}),t.jsx(Zt,{onClick:e,icon:t.jsx(es,{}),variant:"ghost",size:"md","aria-label":"Close TTE Trend Importer"})]}),t.jsxs("main",{className:"flex-1 overflow-y-auto bg-surface-secondary p-2",children:[t.jsxs("section",{className:"rounded-xl border border-slate-200 bg-white p-2.5 shadow-sm",children:[t.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-1.5",children:[t.jsx(ye,{onClick:ee,disabled:r==="capturing",isLoading:r==="capturing",variant:"primary",size:"sm",startIcon:t.jsx(BA,{className:"h-3.5 w-3.5"}),className:"bg-slate-900 hover:bg-slate-800 shadow-sm",children:"Import"}),t.jsx(ye,{onClick:q,disabled:D,isLoading:D,variant:"outline",size:"sm",startIcon:t.jsx(Xa,{className:"h-3.5 w-3.5"}),className:"border-slate-300 text-slate-700 hover:border-slate-400",children:"Load last"})]}),r==="capturing"&&t.jsxs("div",{className:"inline-flex items-center gap-2 text-xs text-slate-500",children:[t.jsx("span",{className:"h-2 w-2 animate-ping rounded-full bg-slate-900"}),"Capturing Investigation summary‚Ä¶"]})]}),(d||N||o)&&t.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2 rounded-lg border border-slate-200 bg-slate-50 px-2 py-1.5 text-[10px] text-slate-600",children:[t.jsxs("span",{className:"font-semibold text-slate-700",children:["Source: Inv. summary ¬∑"," ",d?new Date(d).toLocaleDateString():f==="paste"?"manual":"unknown"]}),t.jsx(ye,{variant:"ghost",size:"sm",className:"text-slate-700 underline underline-offset-2 h-auto px-1 py-0",onClick:ee,children:"Refetch"}),t.jsx(ye,{variant:"ghost",size:"sm",className:"text-slate-700 underline underline-offset-2 h-auto px-1 py-0",onClick:()=>b(G=>!G),children:x?"Hide raw":"Edit raw"}),t.jsx(ye,{variant:"ghost",size:"sm",className:"text-slate-700 underline underline-offset-2 h-auto px-1 py-0",onClick:()=>v(!0),children:"Change source ‚Üí Paste text"})]}),N&&t.jsxs("form",{className:"mt-4 space-y-2",onSubmit:V,children:[t.jsx("label",{htmlFor:"ttePaste",className:"text-xs uppercase tracking-wide text-slate-500",children:"Paste Investigation summary text"}),t.jsx("textarea",{id:"ttePaste",name:"ttePaste",className:"min-h-[140px] w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-800 focus:border-slate-400 focus:outline-none focus:ring-1 focus:ring-slate-400",defaultValue:o,placeholder:"TTE (15 Jan 2023): LVEDD 66, EF 45%..."}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx(ye,{type:"button",onClick:()=>v(!1),variant:"ghost",size:"sm",children:"Cancel"}),t.jsx(ye,{type:"submit",variant:"primary",size:"sm",startIcon:t.jsx(CA,{className:"h-3.5 w-3.5"}),className:"bg-slate-900 hover:bg-slate-800",children:"Parse pasted text"})]})]}),x&&!N&&t.jsxs("div",{className:"mt-4 space-y-2",children:[t.jsx("label",{htmlFor:"rawSourceEditor",className:"text-xs uppercase tracking-wide text-slate-500",children:"Raw Investigation summary"}),t.jsx("textarea",{id:"rawSourceEditor",className:"min-h-[160px] w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-800 focus:border-slate-400 focus:outline-none focus:ring-1 focus:ring-slate-400",value:o,onChange:G=>l(G.target.value)}),t.jsx(ye,{onClick:()=>W(o,f),variant:"outline",size:"sm",startIcon:t.jsx(si,{className:"h-3.5 w-3.5"}),className:"border-slate-300 text-slate-700 hover:border-slate-400",children:"Re-parse raw text"})]}),c.length>0&&t.jsxs("div",{className:"mt-4 space-y-1 rounded-lg border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-700",children:[t.jsxs("div",{className:"flex items-center gap-2 font-semibold",children:[t.jsx(xr,{className:"h-3.5 w-3.5"}),"Parsing warnings"]}),c.map(G=>t.jsxs("div",{children:["‚Ä¢ ",G]},G))]})]}),t.jsxs("section",{className:"mt-2 space-y-2",children:[t.jsx(a3,{settings:j,onToggleSeries:P,onTimeFilterChange:K,onShowLVEFOnlyChange:H,onToggleContext:$}),t.jsx(r3,{rows:M,settings:j,onPointClick:Y}),te&&te.value&&t.jsx("div",{className:"rounded-xl border border-slate-200 bg-white p-4 text-sm text-slate-700",children:t.jsxs("div",{className:"flex items-start justify-between gap-2",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Source snippet"}),t.jsxs("div",{className:"mt-1 font-semibold text-slate-900",children:[te.row.site?`${te.row.site} ¬∑ `:"",te.row.dateIso?new Date(te.row.dateIso).toLocaleDateString(void 0,{day:"numeric",month:"short",year:"numeric"}):te.row.label]}),t.jsx("p",{className:"mt-1 text-sm text-slate-700",children:te.value.sourceText})]}),t.jsx(ye,{onClick:()=>Q(null),variant:"ghost",size:"sm",className:"text-xs text-slate-500 hover:text-slate-700 h-auto px-2 py-1",children:"Clear"})]})}),R.length>0&&t.jsxs("div",{className:"rounded-xl border border-slate-200 bg-white p-4 text-sm text-slate-700",children:[t.jsx("div",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Timeline events"}),t.jsx("ul",{className:"mt-2 space-y-1 text-sm text-slate-700",children:R.map(G=>t.jsxs("li",{children:["‚Ä¢ ",G]},G))})]}),t.jsx(o3,{rows:M,onMetricUpdate:S}),t.jsx(l3,{insights:C})]})]})]})}):null},L0={"medgemma-27b-text-it-mlx":{displayName:"MedGemma 27B (Best Quality)",memoryGB:10,speed:"slow",quality:"excellent",useCases:["Complex procedural reports (TAVI, PCI, RHC)","Comprehensive AI medical review","Detailed consultation notes"],family:"medgemma"},"medgemma-4b-it-mlx":{displayName:"MedGemma 4B (Fast & Medical)",memoryGB:3,speed:"fast",quality:"very-good",useCases:["Quick medical letters","Investigation summaries","Medication lists","Medical backgrounds"],family:"medgemma"},"qwen/qwen3-4b-2507":{displayName:"Qwen 4B (Fastest)",memoryGB:3,speed:"very-fast",quality:"good",useCases:["Simple formatting tasks","Blood test ordering","Quick clinical notes","Investigation formatting"],family:"qwen"},"qwen/qwen3-vl-8b":{displayName:"Qwen Vision 8B (Multimodal)",memoryGB:5,speed:"moderate",quality:"very-good",useCases:["BP diary image extraction","ECG interpretation","Radiology image analysis"],family:"qwen",supportsVision:!0},"google/gemma-3n-e4b":{displayName:"Gemma 3N (Vision-capable)",memoryGB:3,speed:"fast",quality:"good",useCases:["BP diary extraction (vision)","Document OCR","Image-based data extraction"],family:"gemma",supportsVision:!0}};function Zd(s){if(L0[s])return L0[s];const e=s.toLowerCase();let r=4;const a=e.match(/(\d+)b/);if(a){const o=parseInt(a[1]);r=Math.max(2,Math.ceil(o*.4))}let n="other";e.includes("medgemma")?n="medgemma":e.includes("qwen")?n="qwen":e.includes("gemma")&&(n="gemma");const i=e.includes("vision")||e.includes("-vl-")||e.includes("multimodal");return{displayName:s,memoryGB:r,speed:"moderate",quality:"good",useCases:["General text generation"],family:n,supportsVision:i}}function h3(s,e){const a=["medgemma-4b-it-mlx","qwen/qwen3-4b-2507","google/gemma-3n-e4b"];for(const n of a)if(e.includes(n))return n;return e.find(n=>!Zd(n).supportsVision)||null}function Zm(s){return s<1?`${Math.round(s*1024)} MB`:`${s.toFixed(1)} GB`}const p3=({error:s,onRetry:e,onSwitchModel:r,onClose:a})=>{const[n,i]=m.useState(null),[o,l]=m.useState(!1),[c,A]=m.useState(!1),d=Zd(s.requestedModel),h=m.useMemo(()=>s.availableModels.filter(b=>b!==s.requestedModel),[s.availableModels,s.requestedModel]),f=m.useMemo(()=>h3("",h),[h]);bs.useEffect(()=>{f&&!n&&i(f)},[f,n]);const u=async()=>{l(!0);try{await e()}finally{l(!1)}},x=async()=>{if(n){A(!0);try{await r(n),a()}finally{A(!1)}}};return t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm",children:t.jsxs("div",{className:"w-full max-w-2xl max-h-[90vh] overflow-y-auto bg-white rounded-modal shadow-modal m-4",children:[t.jsx("div",{className:"sticky top-0 bg-gradient-to-r from-rose-50 to-orange-50 border-b-2 border-rose-200 px-6 py-4",children:t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"p-2 bg-rose-100 rounded-lg",children:t.jsx(xr,{className:"w-6 h-6 text-rose-600"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Model Loading Failed"}),t.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Insufficient System Memory"})]})]}),t.jsx(Zt,{onClick:a,icon:es,variant:"ghost",size:"sm","aria-label":"Close dialog",className:"hover:bg-rose-100"})]})}),t.jsxs("div",{className:"p-6 space-y-6",children:[t.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 border border-gray-200",children:[t.jsxs("h3",{className:"font-semibold text-gray-900 mb-3 flex items-center gap-2",children:[t.jsx(C2,{className:"w-5 h-5 text-gray-600"}),"What Happened?"]}),t.jsxs("div",{className:"space-y-2 text-sm text-gray-700",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Requested Model:"})," ",t.jsx("code",{className:"px-2 py-0.5 bg-white rounded border border-gray-300 text-xs font-mono",children:s.requestedModel})]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Memory Required:"})," ",t.jsxs("span",{className:"font-semibold text-rose-600",children:["~",Zm(d.memoryGB)]})]}),t.jsxs("p",{className:"bg-rose-50 border border-rose-200 rounded p-3 mt-3",children:[t.jsx("strong",{className:"text-rose-800",children:"LM Studio blocked model loading"})," to prevent system freeze. Your system doesn't have enough free memory to load this model safely."]})]})]}),t.jsxs("div",{className:"border-2 border-blue-200 rounded-lg overflow-hidden",children:[t.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-cyan-50 px-4 py-3 border-b border-blue-200",children:t.jsxs("h3",{className:"font-bold text-blue-900 flex items-center gap-2",children:[t.jsx("span",{className:"flex items-center justify-center w-6 h-6 bg-blue-500 text-white rounded-full text-sm font-bold",children:"1"}),"Option 1: Free Up Memory & Retry"]})}),t.jsxs("div",{className:"p-4 space-y-3",children:[t.jsxs("p",{className:"text-sm text-gray-700",children:["Close memory-intensive applications to free up ~",Zm(d.memoryGB),":"]}),t.jsxs("ul",{className:"text-sm text-gray-700 space-y-1 ml-4",children:[t.jsxs("li",{className:"flex items-start gap-2",children:[t.jsx("span",{className:"text-blue-600 mt-0.5",children:"‚Ä¢"}),t.jsxs("span",{children:["Close ",t.jsx("strong",{children:"Google Chrome"})," (may free 500+ MB)"]})]}),t.jsxs("li",{className:"flex items-start gap-2",children:[t.jsx("span",{className:"text-blue-600 mt-0.5",children:"‚Ä¢"}),t.jsxs("span",{children:["Close ",t.jsx("strong",{children:"Mail"})," and ",t.jsx("strong",{children:"Messages"})," apps"]})]}),t.jsxs("li",{className:"flex items-start gap-2",children:[t.jsx("span",{className:"text-blue-600 mt-0.5",children:"‚Ä¢"}),t.jsxs("span",{children:["Close unused ",t.jsx("strong",{children:"VSCode windows"})]})]})]}),t.jsx(ye,{onClick:u,disabled:o,variant:"primary",size:"md",fullWidth:!0,isLoading:o,startIcon:Xa,className:"mt-4",children:o?"Retrying...":`Retry with ${s.requestedModel}`})]})]}),t.jsxs("div",{className:"border-2 border-emerald-200 rounded-lg overflow-hidden",children:[t.jsx("div",{className:"bg-gradient-to-r from-emerald-50 to-teal-50 px-4 py-3 border-b border-emerald-200",children:t.jsxs("h3",{className:"font-bold text-emerald-900 flex items-center gap-2",children:[t.jsx("span",{className:"flex items-center justify-center w-6 h-6 bg-emerald-500 text-white rounded-full text-sm font-bold",children:"2"}),"Option 2: Use a Different Model"]})}),t.jsxs("div",{className:"p-4 space-y-3",children:[t.jsx("p",{className:"text-sm text-gray-700",children:"Select a lighter model that fits in available memory:"}),h.length===0?t.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-800",children:[t.jsx("strong",{children:"No alternative models available."})," Please free up memory to continue."]}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"space-y-2",children:h.map(b=>{const N=Zd(b),v=b===f,j=b===n;return t.jsx(ye,{onClick:()=>i(b),variant:j?"success":"outline",size:"md",fullWidth:!0,className:`!justify-start text-left px-4 py-3 ${j?"border-emerald-500 bg-emerald-50":"border-gray-200 bg-white hover:border-emerald-300 hover:bg-emerald-50/50"}`,children:t.jsxs("div",{className:"flex items-start justify-between gap-3",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[t.jsx("span",{className:"font-semibold text-gray-900 truncate",children:N.displayName}),v&&t.jsx("span",{className:"flex-shrink-0 px-2 py-0.5 bg-emerald-100 text-emerald-700 text-xs font-semibold rounded-full",children:"RECOMMENDED"})]}),t.jsxs("div",{className:"flex items-center gap-3 text-xs text-gray-600",children:[t.jsxs("span",{children:["Memory: ",t.jsx("strong",{className:"text-emerald-600",children:Zm(N.memoryGB)})]}),t.jsx("span",{children:"‚Ä¢"}),t.jsxs("span",{children:["Speed: ",t.jsx("strong",{children:N.speed})]}),t.jsx("span",{children:"‚Ä¢"}),t.jsxs("span",{children:["Quality: ",t.jsx("strong",{children:N.quality})]})]}),t.jsx("div",{className:"mt-1 text-xs text-gray-500",children:N.useCases[0]})]}),j&&t.jsx(ei,{className:"w-5 h-5 text-emerald-600 flex-shrink-0"})]})},b)})}),t.jsx(ye,{onClick:x,disabled:!n||c,variant:"success",size:"md",fullWidth:!0,isLoading:c,startIcon:c?Xa:ei,className:"mt-4",children:c?"Switching Models...":`Switch to ${n&&Zd(n).displayName}`})]})]})]}),t.jsxs("details",{className:"text-xs text-gray-500",children:[t.jsx("summary",{className:"cursor-pointer hover:text-gray-700 font-medium",children:"Technical Details"}),t.jsx("div",{className:"mt-2 p-3 bg-gray-50 rounded border border-gray-200 font-mono text-xs whitespace-pre-wrap break-all",children:s.rawErrorMessage})]})]})]})})},qv="/assets/card.glb",Jv="/assets/lanyard.png";U2({MeshLineGeometry:z2,MeshLineMaterial:G2});const D0=32;function g3({position:s=[0,13,20],gravity:e=[0,-40,0],fov:r=20,transparent:a=!0,cardText:n="Ready to Record",cardTextureUrl:i}){const[o,l]=m.useState(null);return m.useEffect(()=>{console.log("üé® Lanyard component mounted")},[]),o?(console.error("üé® Lanyard error:",o),t.jsx(R0,{text:n})):t.jsx("div",{className:"lanyard-wrapper",children:t.jsx(m.Suspense,{fallback:t.jsx(R0,{text:n}),children:t.jsxs(L2,{camera:{position:s,fov:r},gl:{alpha:a},onCreated:({gl:c,camera:A})=>{console.log("üé® Canvas created successfully"),c.setClearColor(new M2(0),a?0:1),A.lookAt(0,15,0)},onError:c=>{console.error("üé® Canvas error:",c),l(c instanceof Error?c:new Error(String(c)))},children:[t.jsx("ambientLight",{intensity:Math.PI}),t.jsx(D2,{gravity:e,timeStep:1/60,children:t.jsx(f3,{cardText:n,cardTextureUrl:i})}),t.jsxs(R2,{blur:.75,children:[t.jsx(qA,{intensity:2,color:"white",position:[0,-1,5],rotation:[0,0,Math.PI/3],scale:[100,.1,1]}),t.jsx(qA,{intensity:3,color:"white",position:[-1,-1,1],rotation:[0,0,Math.PI/3],scale:[100,.1,1]}),t.jsx(qA,{intensity:3,color:"white",position:[1,1,1],rotation:[0,0,Math.PI/3],scale:[100,.1,1]}),t.jsx(qA,{intensity:10,color:"white",position:[-10,0,14],rotation:[0,Math.PI/2,Math.PI/3],scale:[100,10,1]})]})]})})})}function R0({text:s}){return t.jsx("div",{className:"lanyard-loading",children:t.jsxs("div",{className:"text-center space-y-4",children:[t.jsx("div",{className:"w-16 h-16 mx-auto bg-blue-50 rounded-full flex items-center justify-center",children:t.jsx("svg",{className:"w-8 h-8 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"})})}),t.jsx("p",{className:"text-sm text-gray-600",children:s})]})})}function f3({maxSpeed:s=50,minSpeed:e=0,cardText:r="Ready to Record",cardTextureUrl:a}){const n=m.useRef(null),i=m.useRef(null),o=m.useRef(null),l=m.useRef(null),c=m.useRef(null),A=m.useRef(null),d=new hi,h=new hi,f=new hi,u=new hi,x={type:"dynamic",canSleep:!0,colliders:!1,angularDamping:4,linearDamping:4},[b,N]=m.useState(null),v=Ry(qv,!0),j=v?.nodes||{},I=v?.materials||{},C=My(Jv);m.useEffect(()=>{C&&(C.wrapS=Og,C.wrapT=Og,C.repeat.set(D0,1),C.needsUpdate=!0)},[C]),m.useEffect(()=>{if(!a){N($=>($&&$.dispose(),null));return}let P=!1;return new _2().load(a,$=>{if(P){$.dispose();return}$.wrapS=$.wrapT=Q2,$.anisotropy=16,$.colorSpace=O2,$.flipY=!1,N(O=>(O&&O!==$&&O.dispose(),$))},void 0,$=>{console.error("üé® Failed to load card texture:",$),N(O=>(O&&O.dispose(),null))}),()=>{P=!0}},[a]);const E=b??I.base?.map,T=C?[-D0,1]:[-3,1],Q=m.useState(()=>{const P=new H2([new hi,new hi,new hi,new hi]);return P.curveType="chordal",P})[0],[D,k]=m.useState(!1),[R,w]=m.useState(!1),[L,M]=m.useState(()=>typeof window<"u"?window.innerWidth<1024:!1);return m.useEffect(()=>{const P=()=>{M(window.innerWidth<1024)};return window.addEventListener("resize",P),()=>window.removeEventListener("resize",P)},[]),jm(i,o,[[0,0,0],[0,0,0],1]),jm(o,l,[[0,0,0],[0,0,0],1]),jm(l,c,[[0,0,0],[0,0,0],1]),V2(c,A,[[0,0,0],[0,1.5,0]]),m.useEffect(()=>{if(R)return document.body.style.cursor=D?"grabbing":"grab",()=>{document.body.style.cursor="auto"}},[R,D]),$2((P,K)=>{D&&typeof D!="boolean"&&(d.set(P.pointer.x,P.pointer.y,.5).unproject(P.camera),u.copy(d).sub(P.camera.position).normalize(),d.add(u.multiplyScalar(P.camera.position.length())),[A,o,l,c,i].forEach($=>$.current?.wakeUp()),A.current?.setNextKinematicTranslation({x:d.x-D.x,y:d.y-D.y,z:d.z-D.z})),i.current&&([o,l].forEach($=>{$.current.lerped||($.current.lerped=new hi().copy($.current.translation()));const O=Math.max(.1,Math.min(1,$.current.lerped.distanceTo($.current.translation())));$.current.lerped.lerp($.current.translation(),K*(e+O*(s-e)))}),Q.points[0].copy(c.current.translation()),Q.points[1].copy(l.current.lerped),Q.points[2].copy(o.current.lerped),Q.points[3].copy(i.current.translation()),n.current&&n.current.geometry.setPoints(Q.getPoints(32)),h.copy(A.current.angvel()),f.copy(A.current.rotation()),A.current.setAngvel({x:h.x,y:h.y-f.y*.25,z:h.z}))}),t.jsxs(t.Fragment,{children:[t.jsxs("group",{position:[0,19,0],children:[t.jsx(Ic,{ref:i,...x,type:"fixed"}),t.jsx(Ic,{position:[.5,0,0],ref:o,...x,type:"dynamic",children:t.jsx(Em,{args:[.1]})}),t.jsx(Ic,{position:[1,0,0],ref:l,...x,type:"dynamic",children:t.jsx(Em,{args:[.1]})}),t.jsx(Ic,{position:[1.5,0,0],ref:c,...x,type:"dynamic",children:t.jsx(Em,{args:[.1]})}),t.jsxs(Ic,{position:[2,0,0],ref:A,...x,type:D?"kinematicPosition":"dynamic",children:[t.jsx(K2,{args:[.8,1.125,.01]}),t.jsxs("group",{scale:2.25,position:[0,-1.2,-.05],onPointerOver:()=>w(!0),onPointerOut:()=>w(!1),onPointerUp:P=>{P.target.releasePointerCapture(P.pointerId),k(!1)},onPointerDown:P=>{P.target.setPointerCapture(P.pointerId),k(new hi().copy(P.point).sub(d.copy(A.current.translation())))},children:[j.card&&j.card.geometry?t.jsx("mesh",{geometry:j.card.geometry,children:t.jsx("meshPhysicalMaterial",{map:E??void 0,clearcoat:1,clearcoatRoughness:.15,roughness:.9,metalness:.8})}):t.jsxs("mesh",{children:[t.jsx("boxGeometry",{args:[1.6,2.25,.02]}),t.jsx("meshPhysicalMaterial",{map:b??void 0,color:"#f8f9fa",clearcoat:1,clearcoatRoughness:.15,roughness:.3,metalness:.1})]}),j.clip&&j.clip.geometry&&I.metal?t.jsxs(t.Fragment,{children:[t.jsx("mesh",{geometry:j.clip.geometry,material:I.metal,"material-roughness":.3}),t.jsx("mesh",{geometry:j.clamp?.geometry,material:I.metal})]}):t.jsxs("mesh",{position:[0,1.125,0],children:[t.jsx("cylinderGeometry",{args:[.1,.1,.1,16]}),t.jsx("meshStandardMaterial",{color:"#888888",metalness:.8,roughness:.2})]})]})]})]}),t.jsxs("mesh",{ref:n,children:[t.jsx("meshLineGeometry",{}),t.jsx("meshLineMaterial",{color:C?"white":"#3b82f6",depthTest:!1,resolution:L?[1e3,2e3]:[1e3,1e3],useMap:C?1:0,map:C,repeat:T,lineWidth:1})]})]})}Ry.preload(qv);My.preload(Jv);const Yv={isRecording:!1,isProcessing:!1,currentAgent:null,transcription:"",results:"",resultsSummary:"",aiGeneratedSummary:void 0,missingInfo:null,missingInfoAnswers:{},processingStatus:"idle",voiceActivityLevel:0,frequencyData:[],modelStatus:{isConnected:!1,classifierModel:"",processorModel:"",lastPing:0,latency:0},recordingTime:null,transcriptionTime:null,agentProcessingTime:null,totalProcessingTime:null,currentAgentName:null,processingStartTime:null,failedAudioRecordings:[],reviewData:null,taviStructuredSections:void 0,educationData:void 0,preOpPlanData:void 0,rhcReport:void 0,taviValidationResult:null,taviValidationStatus:void 0,taviExtractedData:void 0,angiogramValidationResult:null,angiogramValidationStatus:void 0,angiogramExtractedData:void 0,mteerValidationResult:null,mteerValidationStatus:void 0,mteerExtractedData:void 0,patientVersionSessionId:null,patientVersion:null,isGeneratingPatientVersion:!1,streamBuffer:"",ttftMs:null,streaming:!1,processingPhase:void 0,processingStepProgress:{},processingGlobalProgress:0,pipelineProgress:null,transcriptionApproval:{status:"pending",originalText:"",currentText:"",hasBeenEdited:!1},patientMismatchData:{comparison:null,textToInsert:null,onConfirm:null,onCancel:null},patientSessions:[],currentPatientInfo:null,currentSessionId:null,selectedSessionId:null,displaySession:{isDisplayingSession:!1,displaySessionId:null,displayTranscription:"",displayResults:"",displaySummary:void 0,displayTaviStructuredSections:void 0,displayEducationData:void 0,displayPreOpPlanData:void 0,displayReviewData:void 0,displayRhcReport:void 0,displayTaviValidationResult:void 0,displayTaviValidationStatus:void 0,displayAngioValidationResult:void 0,displayAngioValidationStatus:void 0,displayMteerValidationResult:void 0,displayMteerValidationStatus:void 0,displayAgent:null,displayAgentName:null,displayPatientInfo:null,displayProcessingTime:void 0,displayModelUsed:null,displayPipelineProgress:null},resultRevisions:{},persistedSessionIds:new Set,storageMetadata:null,ui:{mode:"idle",modeContext:{sessionId:null,origin:"auto"},overlay:"none",sidePanel:"none",activeWorkflow:null,isCancelling:!1,showAlerts:!0,isExtractingPatients:!1,isBatchProcessing:!1,processingProgress:0,processingStartTime:0,warnings:[],errors:[],resultSummary:"",calendarData:null,extractError:null,batchProcessingProgress:null}};function x3(s,e){switch(e.type){case"SET_RECORDING":return s.isRecording===e.payload?s:{...s,isRecording:e.payload};case"SET_PROCESSING":return s.isProcessing===e.payload?s:{...s,isProcessing:e.payload};case"SET_CURRENT_AGENT":return s.currentAgent===e.payload?s:{...s,currentAgent:e.payload};case"SET_TRANSCRIPTION":return s.transcription===e.payload?s:{...s,transcription:e.payload};case"SET_RESULTS":return s.results===e.payload?s:{...s,results:e.payload};case"SET_RESULTS_SUMMARY":return s.resultsSummary===e.payload?s:{...s,resultsSummary:e.payload};case"SET_AI_GENERATED_SUMMARY":return s.aiGeneratedSummary===e.payload?s:{...s,aiGeneratedSummary:e.payload};case"SET_MISSING_INFO":return{...s,missingInfo:e.payload};case"SET_MISSING_INFO_ANSWERS":return{...s,missingInfoAnswers:e.payload};case"CLEAR_MISSING_INFO":return{...s,missingInfo:null,missingInfoAnswers:{}};case"SET_PROCESSING_PHASE":return{...s,processingPhase:e.payload.phase,processingStepProgress:e.payload.stepProgress,processingGlobalProgress:e.payload.globalProgress};case"SET_PROCESSING_STATUS":return s.processingStatus===e.payload?s:{...s,processingStatus:e.payload};case"SET_VOICE_ACTIVITY":return Date.now()-(s.modelStatus.lastPing||0)<200?s:{...s,voiceActivityLevel:e.payload.level,frequencyData:e.payload.frequencyData,modelStatus:{...s.modelStatus,lastPing:Date.now()}};case"SET_MODEL_STATUS":return{...s,modelStatus:e.payload};case"SET_TIMING_DATA":return{...s,...e.payload};case"SET_CURRENT_AGENT_NAME":return s.currentAgentName===e.payload?s:{...s,currentAgentName:e.payload};case"SET_FAILED_RECORDINGS":return{...s,failedAudioRecordings:e.payload};case"SET_REVIEW_DATA":return{...s,reviewData:e.payload};case"SET_TAVI_STRUCTURED_SECTIONS":return s.taviStructuredSections===e.payload?s:{...s,taviStructuredSections:e.payload};case"SET_EDUCATION_DATA":return s.educationData===e.payload?s:{...s,educationData:e.payload};case"SET_PREOP_PLAN_DATA":return s.preOpPlanData===e.payload?s:{...s,preOpPlanData:e.payload};case"SET_RHC_REPORT":return s.rhcReport===e.payload?s:{...s,rhcReport:e.payload};case"SET_TAVI_VALIDATION":return{...s,taviValidationResult:e.payload.result??null,taviValidationStatus:e.payload.status,taviExtractedData:e.payload.extractedData??void 0};case"SET_ANGIO_VALIDATION":return{...s,angiogramValidationResult:e.payload.result??null,angiogramValidationStatus:e.payload.status,angiogramExtractedData:e.payload.extractedData??void 0};case"SET_MTEER_VALIDATION":return{...s,mteerValidationResult:e.payload.result??null,mteerValidationStatus:e.payload.status,mteerExtractedData:e.payload.extractedData??void 0};case"SET_ACTIVE_WORKFLOW":return s.ui.activeWorkflow===e.payload?s:{...s,ui:{...s.ui,activeWorkflow:e.payload}};case"SET_CANCELLING":return s.ui.isCancelling===e.payload?s:{...s,ui:{...s.ui,isCancelling:e.payload}};case"SET_WARNINGS":return{...s,ui:{...s.ui,warnings:e.payload}};case"SET_ERRORS":return{...s,ui:{...s.ui,errors:e.payload}};case"SET_ALERTS_VISIBLE":return s.ui.showAlerts===e.payload?s:{...s,ui:{...s.ui,showAlerts:e.payload}};case"SET_RESULT_SUMMARY":return s.ui.resultSummary===e.payload?s:{...s,ui:{...s.ui,resultSummary:e.payload}};case"SET_UI_MODE":{if(s.ui.mode===e.payload.mode&&(e.payload.context?.sessionId===void 0||s.ui.modeContext.sessionId===e.payload.context?.sessionId))return s;const r={sessionId:e.payload.context?.sessionId??null,origin:e.payload.context?.origin??"auto"};let a=s.ui.overlay,n=s.ui.sidePanel;return e.payload.mode!=="processing"&&a==="processing-phase"&&(a="none"),e.payload.mode!=="processing"&&a==="field-ingestion"&&(a="none"),e.payload.mode==="processing"&&a==="none"&&(a="processing-phase"),e.payload.mode==="recording"&&(n=n==="metrics-dashboard"?"none":n),e.payload.mode!=="configuring"&&n==="metrics-dashboard"&&(n="none"),e.payload.mode!=="recording"&&n==="recording-prompts"&&(n="none"),{...s,ui:{...s.ui,mode:e.payload.mode,modeContext:r,overlay:a,sidePanel:n}}}case"SET_UI_OVERLAY":return s.ui.overlay===e.payload?s:{...s,ui:{...s.ui,overlay:e.payload}};case"CLEAR_UI_OVERLAY":return e.payload&&s.ui.overlay!==e.payload||s.ui.overlay==="none"?s:{...s,ui:{...s.ui,overlay:"none"}};case"SET_UI_SIDE_PANEL":return s.ui.sidePanel===e.payload?s:{...s,ui:{...s.ui,sidePanel:e.payload}};case"SET_PATIENT_MISMATCH_DATA":return{...s,patientMismatchData:e.payload};case"SET_CALENDAR_DATA":return{...s,ui:{...s.ui,calendarData:e.payload}};case"SET_EXTRACTING_PATIENTS":return s.ui.isExtractingPatients===e.payload?s:{...s,ui:{...s.ui,isExtractingPatients:e.payload}};case"SET_EXTRACT_ERROR":return s.ui.extractError===e.payload?s:{...s,ui:{...s.ui,extractError:e.payload}};case"SET_BATCH_PROCESSING":return s.ui.isBatchProcessing===e.payload?s:{...s,ui:{...s.ui,isBatchProcessing:e.payload}};case"SET_BATCH_PROGRESS":return{...s,ui:{...s.ui,batchProcessingProgress:e.payload}};case"SET_PROCESSING_START_TIME":return{...s,processingStartTime:e.payload};case"RESET_STATE":return Yv;case"CLEAR_RECORDING":return console.log("üîÑ CLEAR_RECORDING: Clearing state for new recording",{hadResults:!!s.results,hadReviewData:!!s.reviewData,currentAgent:s.currentAgent,processingStatus:s.processingStatus,wasDisplayingSession:s.displaySession.isDisplayingSession,wasStreaming:s.streaming,hadStreamBuffer:!!s.streamBuffer,currentSessionId:s.currentSessionId}),console.trace("üîç CLEAR_RECORDING called from:"),{...s,transcription:"",results:"",resultsSummary:"",aiGeneratedSummary:void 0,patientVersion:null,processingStatus:"idle",currentAgent:null,currentAgentName:null,recordingTime:null,transcriptionTime:null,agentProcessingTime:null,totalProcessingTime:null,processingStartTime:null,reviewData:null,taviStructuredSections:void 0,educationData:void 0,preOpPlanData:void 0,rhcReport:void 0,taviValidationResult:null,taviValidationStatus:void 0,taviExtractedData:void 0,angiogramValidationResult:null,angiogramValidationStatus:void 0,angiogramExtractedData:void 0,mteerValidationResult:null,mteerValidationStatus:void 0,mteerExtractedData:void 0,streaming:!1,streamBuffer:"",ttftMs:null,processingPhase:void 0,processingStepProgress:{},processingGlobalProgress:0,pipelineProgress:null,currentSessionId:null,selectedSessionId:null,displaySession:{isDisplayingSession:!1,displaySessionId:null,displayTranscription:"",displayResults:"",displaySummary:void 0,displayTaviStructuredSections:void 0,displayEducationData:void 0,displayPreOpPlanData:void 0,displayReviewData:void 0,displayRhcReport:void 0,displayTaviValidationResult:void 0,displayTaviValidationStatus:void 0,displayAngioValidationResult:void 0,displayAngioValidationStatus:void 0,displayMteerValidationResult:void 0,displayMteerValidationStatus:void 0,displayAgent:null,displayAgentName:null,displayPatientInfo:null,displayProcessingTime:void 0,displayModelUsed:null,displayPipelineProgress:null},resultRevisions:{},transcriptionApproval:{status:"pending",originalText:"",currentText:"",hasBeenEdited:!1},ui:{...s.ui,activeWorkflow:null,warnings:[],errors:[],resultSummary:"",isCancelling:!1,mode:"idle",modeContext:{sessionId:null,origin:"auto"},overlay:"none",sidePanel:"none"}};case"SET_CURRENT_PATIENT_INFO":return{...s,currentPatientInfo:e.payload};case"ADD_PATIENT_SESSION":return{...s,patientSessions:[e.payload,...s.patientSessions]};case"UPDATE_PATIENT_SESSION":return{...s,patientSessions:s.patientSessions.map(r=>r.id===e.payload.id?{...r,...e.payload.updates}:r)};case"REMOVE_PATIENT_SESSION":return{...s,patientSessions:s.patientSessions.filter(r=>r.id!==e.payload)};case"CLEAR_PATIENT_SESSIONS":return{...s,patientSessions:[],currentPatientInfo:null,currentSessionId:null,selectedSessionId:null};case"SET_CURRENT_SESSION_ID":return{...s,currentSessionId:e.payload};case"SET_SELECTED_SESSION_ID":return{...s,selectedSessionId:e.payload};case"SET_PROCESSING_PROGRESS":return{...s,ui:{...s.ui,processingProgress:e.payload}};case"SET_AI_REVIEW_START_TIME":return{...s,ui:{...s.ui,processingStartTime:e.payload}};case"SET_PATIENT_VERSION_SESSION_ID":return s.patientVersionSessionId===e.payload?s:{...s,patientVersionSessionId:e.payload};case"SET_PATIENT_VERSION":return s.patientVersion===e.payload?s:{...s,patientVersion:e.payload};case"SET_GENERATING_PATIENT_VERSION":return s.isGeneratingPatientVersion===e.payload?s:{...s,isGeneratingPatientVersion:e.payload};case"RESULTS_STREAMING":return{...s,streaming:e.payload};case"RESULTS_CLEAR_STREAM":return{...s,streamBuffer:"",ttftMs:null};case"RESULTS_APPEND_STREAM_CHUNK":return{...s,streamBuffer:(s.streamBuffer||"")+e.payload};case"RESULTS_TTFT":return{...s,ttftMs:e.payload};case"RESULTS_STREAM_DONE":return{...s,results:e.payload.final,streamBuffer:"",streaming:!1,ttftMs:e.payload.ttftMs??s.ttftMs??null,processingStatus:"complete"};case"RESULTS_STREAM_ERROR":return{...s,ui:{...s.ui,errors:[...s.ui.errors,e.payload]},streaming:!1};case"RESULTS_STREAM_CANCELLED":return{...s,streaming:!1};case"SET_RESULT_REVISION":{const{key:r,revision:a}=e.payload;return s.resultRevisions[r]===a?s:{...s,resultRevisions:{...s.resultRevisions,[r]:a}}}case"UPDATE_RESULT_REVISION":{const{key:r,updates:a}=e.payload,n=s.resultRevisions[r];if(!n)return s;const i={...n,...a};return{...s,resultRevisions:{...s.resultRevisions,[r]:i}}}case"CLEAR_RESULT_REVISION":{const{key:r}=e.payload;if(!s.resultRevisions[r])return s;const{[r]:a,...n}=s.resultRevisions;return{...s,resultRevisions:n}}case"RESET_RESULT_REVISIONS":return Object.keys(s.resultRevisions).length===0?s:{...s,resultRevisions:{}};case"SET_TRANSCRIPTION_APPROVAL":return{...s,transcriptionApproval:e.payload};case"SET_PIPELINE_PROGRESS":return{...s,pipelineProgress:e.payload};case"UPDATE_PIPELINE_PROGRESS":return s.pipelineProgress?{...s,pipelineProgress:{...s.pipelineProgress,...e.payload}}:s;case"CLEAR_PIPELINE_PROGRESS":return{...s,pipelineProgress:null};case"COMPLETE_PROCESSING_ATOMIC":{console.log("üèÅ ATOMIC COMPLETION: Processing complete for session:",e.payload.sessionId);const r=e.payload.results||"Processing completed",a=e.payload.summary||e.payload.results||"Processing completed";console.log("üîí ATOMIC COMPLETION: Safety checks applied - Results length:",r.length,"Summary length:",a.length);const n=["processing-phase","field-ingestion"].includes(s.ui.overlay),i=s.ui.mode==="processing"&&s.ui.modeContext.sessionId===e.payload.sessionId;return{...s,isProcessing:!1,processingStatus:"complete",streaming:!1,currentSessionId:null,results:r,aiGeneratedSummary:a,resultsSummary:a,streamBuffer:"",ttftMs:null,processingStartTime:null,pipelineProgress:null,ui:{...s.ui,activeWorkflow:null,isCancelling:!1,processingProgress:0,processingStartTime:0,overlay:n?"none":s.ui.overlay,mode:i?"reviewing":s.ui.mode,modeContext:i?{sessionId:e.payload.sessionId,origin:"auto"}:s.ui.modeContext}}}case"VALIDATE_STATE":{const r=[];return s.processingStatus==="complete"&&s.isProcessing&&r.push("processingStatus is complete but isProcessing is true"),s.processingStatus==="complete"&&s.streaming&&r.push("processingStatus is complete but streaming is true"),s.currentSessionId&&s.processingStatus==="complete"&&!s.isProcessing&&r.push("currentSessionId set but processing is complete - may block record button"),r.length>0&&console.warn("‚ö†Ô∏è STATE VALIDATION WARNINGS:",r),s}case"RECOVER_STUCK_STATE":{console.log("üîÑ RECOVERING FROM STUCK STATE");const r=["processing-phase","field-ingestion"].includes(s.ui.overlay),a=s.ui.mode==="processing";return{...s,isProcessing:!1,processingStatus:"idle",streaming:!1,currentSessionId:null,streamBuffer:"",ttftMs:null,processingStartTime:null,transcriptionApproval:{status:"pending",originalText:"",currentText:"",hasBeenEdited:!1},ui:{...s.ui,isCancelling:!1,processingProgress:0,processingStartTime:0,activeWorkflow:null,warnings:[],errors:[],overlay:r?"none":s.ui.overlay,mode:a?"idle":s.ui.mode,modeContext:a?{sessionId:null,origin:"auto"}:s.ui.modeContext}}}case"SET_DISPLAY_SESSION":{const r=e.payload.session;return console.log("üîÑ SET_DISPLAY_SESSION - Loading session data:",{sessionId:r.id,agentType:r.agentType,patientName:r.patient?.name,hasTranscription:!!r.transcription,transcriptionLength:r.transcription?.length||0,hasResults:!!r.results,resultsLength:r.results?.length||0,hasSummary:!!r.summary,summaryLength:r.summary?.length||0,warningsCount:r.warnings?.length||0,errorsCount:r.errors?.length||0,pendingAudioSaved:!!r.pendingAudio?.saved,pendingAudioPath:r.pendingAudio?.audioPath,hasEducationData:!!r.educationData,hasPreOpPlanData:!!r.preOpPlanData,hasReviewData:!!r.reviewData,hasTaviSections:!!r.taviStructuredSections,hasPipelineProgress:!!r.pipelineProgress,pipelineStage:r.pipelineProgress?.stage,pipelineProgress:r.pipelineProgress?.progress}),{...s,selectedSessionId:r.id,displaySession:{isDisplayingSession:!0,displaySessionId:r.id,displayTranscription:r.transcription||"",displayResults:r.results||"",displaySummary:r.summary,displayTaviStructuredSections:r.taviStructuredSections,displayEducationData:r.educationData,displayPreOpPlanData:r.preOpPlanData,displayReviewData:r.reviewData,displayRhcReport:r.rhcReport,displayTaviValidationResult:r.taviValidationResult??null,displayTaviValidationStatus:r.taviValidationStatus,displayAngioValidationResult:r.angiogramValidationResult??null,displayAngioValidationStatus:r.angiogramValidationStatus,displayMteerValidationResult:r.mteerValidationResult??null,displayMteerValidationStatus:r.mteerValidationStatus,displayAgent:r.agentType||null,displayAgentName:r.agentName||null,displayPatientInfo:r.patient||null,displayProcessingTime:r.processingTime,displayProcessingStartTime:r.processingStartTime??null,displayModelUsed:r.modelUsed||null,displayAudioDuration:r.audioDuration||null,displayPipelineProgress:r.status==="completed"?null:r.pipelineProgress||null}}}case"CLEAR_DISPLAY_SESSION":return{...s,selectedSessionId:null,displaySession:{isDisplayingSession:!1,displaySessionId:null,displayTranscription:"",displayResults:"",displaySummary:void 0,displayTaviStructuredSections:void 0,displayEducationData:void 0,displayPreOpPlanData:void 0,displayReviewData:void 0,displayRhcReport:void 0,displayTaviValidationResult:void 0,displayTaviValidationStatus:void 0,displayAngioValidationResult:void 0,displayAngioValidationStatus:void 0,displayMteerValidationResult:void 0,displayMteerValidationStatus:void 0,displayAgent:null,displayAgentName:null,displayPatientInfo:null,displayProcessingTime:void 0,displayProcessingStartTime:null,displayAudioDuration:null,displayModelUsed:null,displayPipelineProgress:null}};case"FORCE_UI_READY_STATE":return console.log("üîß FORCING UI READY STATE - clearing all processing indicators"),{...s,isRecording:!1,isProcessing:!1,streaming:!1,currentSessionId:null,ui:{...s.ui,activeWorkflow:null,isCancelling:!1,processingProgress:0,processingStartTime:0,overlay:["processing-phase","field-ingestion"].includes(s.ui.overlay)?"none":s.ui.overlay,mode:s.ui.mode==="processing"?"idle":s.ui.mode,modeContext:s.ui.mode==="processing"?{sessionId:null,origin:"auto"}:s.ui.modeContext}};case"SET_PERSISTED_SESSION_IDS":return{...s,persistedSessionIds:e.payload};case"ADD_PERSISTED_SESSION_ID":{const r=new Set(s.persistedSessionIds);return r.add(e.payload),{...s,persistedSessionIds:r}}case"REMOVE_PERSISTED_SESSION_ID":{const r=new Set(s.persistedSessionIds);return r.delete(e.payload),{...s,persistedSessionIds:r}}case"SET_STORAGE_METADATA":return{...s,storageMetadata:e.payload};default:return s}}function y3(){const[s,e]=m.useReducer(x3,Yv),r=m.useRef(0),a={setRecording:m.useCallback(i=>{e({type:"SET_RECORDING",payload:i})},[]),setProcessing:m.useCallback(i=>{e({type:"SET_PROCESSING",payload:i})},[]),setCurrentAgent:m.useCallback(i=>{e({type:"SET_CURRENT_AGENT",payload:i})},[]),setTranscription:m.useCallback(i=>{e({type:"SET_TRANSCRIPTION",payload:i})},[]),setResults:m.useCallback(i=>{e({type:"SET_RESULTS",payload:i})},[]),setResultsSummary:m.useCallback(i=>{e({type:"SET_RESULTS_SUMMARY",payload:i})},[]),setAiGeneratedSummary:m.useCallback(i=>{e({type:"SET_AI_GENERATED_SUMMARY",payload:i})},[]),setMissingInfo:m.useCallback(i=>{e({type:"SET_MISSING_INFO",payload:i})},[]),setMissingInfoAnswers:m.useCallback(i=>{e({type:"SET_MISSING_INFO_ANSWERS",payload:i})},[]),clearMissingInfo:m.useCallback(()=>{e({type:"CLEAR_MISSING_INFO"})},[]),setProcessingStatus:m.useCallback(i=>{e({type:"SET_PROCESSING_STATUS",payload:i})},[]),setProcessingPhase:m.useCallback((i,o,l)=>{e({type:"SET_PROCESSING_PHASE",payload:{phase:i,stepProgress:o,globalProgress:l}})},[]),setVoiceActivity:m.useCallback((i,o)=>{const l=Date.now();l-r.current>=200&&(r.current=l,e({type:"SET_VOICE_ACTIVITY",payload:{level:i,frequencyData:o}}))},[]),setModelStatus:m.useCallback(i=>{e({type:"SET_MODEL_STATUS",payload:i})},[]),setTimingData:m.useCallback(i=>{e({type:"SET_TIMING_DATA",payload:i})},[]),setCurrentAgentName:m.useCallback(i=>{e({type:"SET_CURRENT_AGENT_NAME",payload:i})},[]),setFailedRecordings:m.useCallback(i=>{e({type:"SET_FAILED_RECORDINGS",payload:i})},[]),setReviewData:m.useCallback(i=>{e({type:"SET_REVIEW_DATA",payload:i})},[]),setTaviStructuredSections:m.useCallback(i=>{e({type:"SET_TAVI_STRUCTURED_SECTIONS",payload:i})},[]),setEducationData:m.useCallback(i=>{e({type:"SET_EDUCATION_DATA",payload:i})},[]),setPreOpPlanData:m.useCallback(i=>{e({type:"SET_PREOP_PLAN_DATA",payload:i})},[]),setRhcReport:m.useCallback(i=>{console.log("üö® ACTION: setRhcReport called with:",{hasRhcData:!!i?.rhcData,hasCalculations:!!i?.calculations,reportKeys:i?Object.keys(i):[]}),e({type:"SET_RHC_REPORT",payload:i})},[]),setTaviValidationState:m.useCallback(i=>{e({type:"SET_TAVI_VALIDATION",payload:i})},[]),setAngioValidationState:m.useCallback(i=>{e({type:"SET_ANGIO_VALIDATION",payload:i})},[]),setMteerValidationState:m.useCallback(i=>{e({type:"SET_MTEER_VALIDATION",payload:i})},[]),setActiveWorkflow:m.useCallback(i=>{e({type:"SET_ACTIVE_WORKFLOW",payload:i})},[]),setCancelling:m.useCallback(i=>{e({type:"SET_CANCELLING",payload:i})},[]),setWarnings:m.useCallback(i=>{e({type:"SET_WARNINGS",payload:i})},[]),setErrors:m.useCallback(i=>{e({type:"SET_ERRORS",payload:i})},[]),setAlertsVisible:m.useCallback(i=>{e({type:"SET_ALERTS_VISIBLE",payload:i})},[]),setResultSummary:m.useCallback(i=>{e({type:"SET_RESULT_SUMMARY",payload:i})},[]),setUIMode:m.useCallback((i,o)=>{e({type:"SET_UI_MODE",payload:{mode:i,context:o}})},[]),openOverlay:m.useCallback(i=>{e({type:"SET_UI_OVERLAY",payload:i})},[]),closeOverlay:m.useCallback(i=>{e({type:"CLEAR_UI_OVERLAY",payload:i})},[]),setSidePanel:m.useCallback(i=>{e({type:"SET_UI_SIDE_PANEL",payload:i})},[]),clearSidePanel:m.useCallback(()=>{e({type:"SET_UI_SIDE_PANEL",payload:"none"})},[]),setPatientMismatchData:m.useCallback(i=>{e({type:"SET_PATIENT_MISMATCH_DATA",payload:i})},[]),setCalendarData:m.useCallback(i=>{e({type:"SET_CALENDAR_DATA",payload:i})},[]),setExtractingPatients:m.useCallback(i=>{e({type:"SET_EXTRACTING_PATIENTS",payload:i})},[]),setExtractError:m.useCallback(i=>{e({type:"SET_EXTRACT_ERROR",payload:i})},[]),setBatchProcessing:m.useCallback(i=>{e({type:"SET_BATCH_PROCESSING",payload:i})},[]),setBatchProgress:m.useCallback(i=>{e({type:"SET_BATCH_PROGRESS",payload:i})},[]),setProcessingStartTime:m.useCallback(i=>{e({type:"SET_PROCESSING_START_TIME",payload:i})},[]),resetState:m.useCallback(()=>{e({type:"RESET_STATE"})},[]),clearRecording:m.useCallback(()=>{e({type:"CLEAR_RECORDING"})},[]),setCurrentPatientInfo:m.useCallback(i=>{e({type:"SET_CURRENT_PATIENT_INFO",payload:i})},[]),addPatientSession:m.useCallback(i=>{e({type:"ADD_PATIENT_SESSION",payload:i})},[]),updatePatientSession:m.useCallback((i,o)=>{e({type:"UPDATE_PATIENT_SESSION",payload:{id:i,updates:o}})},[]),updateSessionRhcReport:m.useCallback((i,o)=>{e({type:"UPDATE_PATIENT_SESSION",payload:{id:i,updates:{rhcReport:o}}})},[]),removePatientSession:m.useCallback(i=>{e({type:"REMOVE_PATIENT_SESSION",payload:i})},[]),clearPatientSessions:m.useCallback(()=>{e({type:"CLEAR_PATIENT_SESSIONS"})},[]),setCurrentSessionId:m.useCallback(i=>{e({type:"SET_CURRENT_SESSION_ID",payload:i})},[]),setSelectedSessionId:m.useCallback(i=>{e({type:"SET_SELECTED_SESSION_ID",payload:i})},[]),setProcessingProgress:m.useCallback(i=>{e({type:"SET_PROCESSING_PROGRESS",payload:i})},[]),setAIReviewStartTime:m.useCallback(i=>{e({type:"SET_AI_REVIEW_START_TIME",payload:i})},[]),setPatientVersion:m.useCallback(i=>{e({type:"SET_PATIENT_VERSION",payload:i})},[]),setPatientVersionSessionId:m.useCallback(i=>{e({type:"SET_PATIENT_VERSION_SESSION_ID",payload:i})},[]),setGeneratingPatientVersion:m.useCallback(i=>{e({type:"SET_GENERATING_PATIENT_VERSION",payload:i})},[]),setStreaming:m.useCallback(i=>{e({type:"RESULTS_STREAMING",payload:i})},[]),clearStream:m.useCallback(()=>{e({type:"RESULTS_CLEAR_STREAM"})},[]),appendStreamChunk:m.useCallback(i=>{e({type:"RESULTS_APPEND_STREAM_CHUNK",payload:i})},[]),setTTFT:m.useCallback(i=>{e({type:"RESULTS_TTFT",payload:i})},[]),streamDone:m.useCallback((i,o,l)=>{e({type:"RESULTS_STREAM_DONE",payload:{final:i,usage:o,ttftMs:l}})},[]),streamError:m.useCallback(i=>{e({type:"RESULTS_STREAM_ERROR",payload:i})},[]),streamCancelled:m.useCallback(()=>{e({type:"RESULTS_STREAM_CANCELLED"})},[]),setResultRevision:m.useCallback((i,o)=>{e({type:"SET_RESULT_REVISION",payload:{key:i,revision:o}})},[]),updateResultRevision:m.useCallback((i,o)=>{e({type:"UPDATE_RESULT_REVISION",payload:{key:i,updates:o}})},[]),clearResultRevision:m.useCallback(i=>{e({type:"CLEAR_RESULT_REVISION",payload:{key:i}})},[]),resetResultRevisions:m.useCallback(()=>{e({type:"RESET_RESULT_REVISIONS"})},[]),setTranscriptionApproval:m.useCallback(i=>{e({type:"SET_TRANSCRIPTION_APPROVAL",payload:i})},[]),setPipelineProgress:m.useCallback(i=>{e({type:"SET_PIPELINE_PROGRESS",payload:i})},[]),updatePipelineProgress:m.useCallback(i=>{e({type:"UPDATE_PIPELINE_PROGRESS",payload:i})},[]),clearPipelineProgress:m.useCallback(()=>{e({type:"CLEAR_PIPELINE_PROGRESS"})},[]),completeProcessingAtomic:m.useCallback((i,o,l)=>{e({type:"COMPLETE_PROCESSING_ATOMIC",payload:{sessionId:i,results:o,summary:l}})},[]),validateState:m.useCallback(()=>{e({type:"VALIDATE_STATE"})},[]),recoverStuckState:m.useCallback(()=>{e({type:"RECOVER_STUCK_STATE"})},[]),setDisplaySession:m.useCallback(i=>{e({type:"SET_DISPLAY_SESSION",payload:{session:i}})},[]),clearDisplaySession:m.useCallback(()=>{e({type:"CLEAR_DISPLAY_SESSION"})},[]),forceUIReadyState:m.useCallback(()=>{e({type:"FORCE_UI_READY_STATE"})},[]),setPersistedSessionIds:m.useCallback(i=>{e({type:"SET_PERSISTED_SESSION_IDS",payload:i})},[]),addPersistedSessionId:m.useCallback(i=>{e({type:"ADD_PERSISTED_SESSION_ID",payload:i})},[]),removePersistedSessionId:m.useCallback(i=>{e({type:"REMOVE_PERSISTED_SESSION_ID",payload:i})},[]),setStorageMetadata:m.useCallback(i=>{e({type:"SET_STORAGE_METADATA",payload:i})},[])},n=m.useMemo(()=>({isMode:i=>s.ui.mode===i,isOverlayActive:i=>s.ui.overlay===i,isSidePanelOpen:i=>s.ui.sidePanel===i,activeModeContext:s.ui.modeContext}),[s.ui.mode,s.ui.overlay,s.ui.sidePanel,s.ui.modeContext]);return{state:s,actions:a,selectors:n}}class Kl{static instance;defaultTimeout=15e3;defaultInterval=500;debugMode=!1;constructor(){}static getInstance(){return Kl.instance||(Kl.instance=new Kl),Kl.instance}setDebugMode(e){this.debugMode=e}async waitForPatientDataLoad(e,r,a=this.defaultTimeout){const n=[{name:"content_script_responsive",checker:()=>this.checkContentScriptResponsive(e),description:"Content script is responsive",timeout:5e3,interval:200},{name:"xestro_boxes_present",checker:()=>this.checkXestroBoxesPresent(e),description:"XestroBox elements are present",timeout:a,interval:this.defaultInterval},{name:"patient_data_populated",checker:()=>this.checkPatientDataPopulated(e,r),description:"Patient data fields are populated",timeout:a,interval:this.defaultInterval},{name:"clinical_sections_ready",checker:()=>this.checkClinicalSectionsReady(e),description:"Clinical sections have content",timeout:a,interval:this.defaultInterval}];return this.waitForMultipleConditions(n,{requireAll:!1,minConditions:2,earlyReturnOnCritical:!0})}async waitForClinicalSection(e,r,a=this.defaultTimeout){const n=[{name:`${r}_section_present`,checker:()=>this.checkSectionPresent(e,r),description:`${r} section is present in DOM`,timeout:a/2,interval:this.defaultInterval},{name:`${r}_content_loaded`,checker:()=>this.checkSectionContentLoaded(e,r),description:`${r} section has content`,timeout:a,interval:this.defaultInterval}];return this.waitForMultipleConditions(n,{requireAll:!0,minConditions:2,earlyReturnOnCritical:!1})}async waitForPatientActivation(e,r,a=1e4){const n=[{name:"patient_row_highlighted",checker:()=>this.checkPatientRowHighlighted(e,r),description:"Patient row is highlighted/selected",timeout:a/3,interval:200},{name:"patient_record_loading",checker:()=>this.checkPatientRecordLoading(e),description:"Patient record is loading",timeout:a/2,interval:this.defaultInterval},{name:"patient_record_loaded",checker:()=>this.checkPatientRecordLoaded(e),description:"Patient record is fully loaded",timeout:a,interval:this.defaultInterval}];return this.waitForMultipleConditions(n,{requireAll:!1,minConditions:1,earlyReturnOnCritical:!0,sequentialChecking:!0})}async waitForDOMStability(e,r=1e3,a=this.defaultTimeout){const n=Date.now(),i=[];let o=Date.now(),l="";for(;Date.now()-n<a;)try{const c=await this.getDOMHash(e),A=Date.now();if(c!==l)o=A,l=c,i.push({timestamp:A,conditionName:"dom_changed",passed:!1,details:"DOM structure changed"});else if(A-o>=r)return i.push({timestamp:A,conditionName:"dom_stable",passed:!0,details:`DOM stable for ${r}ms`}),{success:!0,timeElapsed:A-n,conditionMet:"dom_stable",intermediateChecks:i};await this.sleep(200)}catch(c){this.log("Error checking DOM stability:",c),await this.sleep(this.defaultInterval)}return{success:!1,timeElapsed:Date.now()-n,conditionMet:null,error:`DOM did not stabilize within ${a}ms`,intermediateChecks:i}}async waitForCondition(e,r={}){const a=Date.now(),n=[],{earlyReturn:i=!0,logProgress:o=this.debugMode}=r;for(this.log(`Starting wait for condition: ${e.name} - ${e.description}`);Date.now()-a<e.timeout;)try{const c=await e.checker(),A=Date.now();if(n.push({timestamp:A,conditionName:e.name,passed:c,details:c?"Condition met":"Condition not met"}),c){const d=A-a;return this.log(`‚úÖ Condition '${e.name}' met in ${d}ms`),{success:!0,timeElapsed:d,conditionMet:e.name,intermediateChecks:n}}o&&n.length%10===0&&this.log(`‚è≥ Still waiting for '${e.name}' (${Date.now()-a}ms elapsed)`),await this.sleep(e.interval)}catch(c){n.push({timestamp:Date.now(),conditionName:e.name,passed:!1,details:`Error: ${c instanceof Error?c.message:String(c)}`}),this.log(`‚ùå Error checking condition '${e.name}':`,c),await this.sleep(e.interval)}const l=Date.now()-a;return this.log(`‚è∞ Timeout waiting for condition '${e.name}' after ${l}ms`),{success:!1,timeElapsed:l,conditionMet:null,error:`Timeout waiting for condition '${e.name}'`,intermediateChecks:n}}async waitForMultipleConditions(e,r){const a=Date.now(),n=[],i=new Set,o=Math.max(...e.map(d=>d.timeout));if(this.log(`Starting multi-condition wait: ${e.length} conditions`),r.sequentialChecking)for(const d of e){const h=await this.waitForCondition(d);if(n.push(...h.intermediateChecks),h.success)i.add(d.name);else if(r.requireAll)return{success:!1,timeElapsed:Date.now()-a,conditionMet:null,error:`Sequential condition failed: ${d.name}`,intermediateChecks:n}}else for(;Date.now()-a<o;){for(const h of e)if(!i.has(h.name))try{const f=await h.checker(),u=Date.now();n.push({timestamp:u,conditionName:h.name,passed:f,details:f?"Condition met":"Condition not met"}),f&&(i.add(h.name),this.log(`‚úÖ Condition met: ${h.name}`))}catch(f){n.push({timestamp:Date.now(),conditionName:h.name,passed:!1,details:`Error: ${f instanceof Error?f.message:String(f)}`})}const d=i.size;if(r.requireAll&&d===e.length)break;if(!r.requireAll&&d>=r.minConditions)break;await this.sleep(Math.min(...e.map(h=>h.interval)))}const l=i.size,c=r.requireAll?l===e.length:l>=r.minConditions,A=Date.now()-a;return c?this.log(`‚úÖ Multi-condition wait successful: ${l}/${e.length} conditions met`):this.log(`‚ùå Multi-condition wait failed: ${l}/${e.length} conditions met`),{success:c,timeElapsed:A,conditionMet:c?Array.from(i).join(", "):null,error:c?void 0:`Insufficient conditions met: ${l}/${r.minConditions}`,intermediateChecks:n}}async checkContentScriptResponsive(e){try{return!!await this.sendMessage(e,{type:"PING"},2e3)}catch{return!1}}async checkXestroBoxesPresent(e){try{return(await this.sendMessage(e,{type:"CHECK_XESTRO_BOXES"},3e3))?.found===!0}catch{return!1}}async checkPatientDataPopulated(e,r){try{return(await this.sendMessage(e,{type:"CHECK_PATIENT_DATA",data:{expectedPatientName:r}},3e3))?.populated===!0}catch{return!1}}async checkClinicalSectionsReady(e){try{return(await this.sendMessage(e,{type:"CHECK_CLINICAL_SECTIONS"},3e3))?.sectionsReady===!0}catch{return!1}}async checkSectionPresent(e,r){try{return(await this.sendMessage(e,{type:"CHECK_SECTION_PRESENT",data:{sectionType:r}},3e3))?.present===!0}catch{return!1}}async checkSectionContentLoaded(e,r){try{const a=await this.sendMessage(e,{type:"CHECK_SECTION_CONTENT",data:{sectionType:r}},3e3);return a?.hasContent===!0&&a?.wordCount>0}catch{return!1}}async checkPatientRowHighlighted(e,r){try{return(await this.sendMessage(e,{type:"CHECK_PATIENT_ROW_HIGHLIGHTED",data:{patientIndex:r}},2e3))?.highlighted===!0}catch{return!1}}async checkPatientRecordLoading(e){try{const r=await this.sendMessage(e,{type:"CHECK_PATIENT_RECORD_STATE"},2e3);return r?.state==="loading"||r?.state==="loaded"}catch{return!1}}async checkPatientRecordLoaded(e){try{return(await this.sendMessage(e,{type:"CHECK_PATIENT_RECORD_STATE"},2e3))?.state==="loaded"}catch{return!1}}async getDOMHash(e){try{return(await this.sendMessage(e,{type:"GET_DOM_HASH"},2e3))?.hash||""}catch{return""}}async sendMessage(e,r,a=5e3){return new Promise((n,i)=>{const o=setTimeout(()=>{i(new Error(`Message timeout after ${a}ms`))},a);try{chrome.tabs.sendMessage(e,r,l=>{if(clearTimeout(o),chrome.runtime.lastError){i(new Error(`Message failed: ${chrome.runtime.lastError.message}`));return}n(l)})}catch(l){clearTimeout(o),i(l)}})}async sleep(e){return new Promise(r=>setTimeout(r,e))}log(...e){this.debugMode&&console.log("[DynamicWaitUtils]",...e)}setDefaultTimeout(e){this.defaultTimeout=e}setDefaultInterval(e){this.defaultInterval=e}getDefaultTimeout(){return this.defaultTimeout}getDefaultInterval(){return this.defaultInterval}}class Gl{static instance;debugMode=!1;medicalTermPatterns=[];commonErrorPatterns=[];defaultConfig={fields:["background","investigations","medications"],fallbackSelectors:{background:['textarea[data-field="background"]',"#background",".background textarea",'.XestroBox:contains("Background") textarea','textarea[placeholder*="background" i]'],investigations:['textarea[data-field="investigations"]',"#investigations",".investigations textarea",'.XestroBox:contains("Investigation") textarea','textarea[placeholder*="investigation" i]'],medications:['textarea[data-field="medications"]',"#medications",".medications textarea",'.XestroBox:contains("Medication") textarea','textarea[placeholder*="medication" i]']},qualityThresholds:{minWordCount:5,minMedicalTerms:1,minCompletenessScore:.3,acceptableConfidenceLevel:"medium"},retryAttempts:3,timeout:1e4,screenshotOnFailure:!0};constructor(){this.initializeMedicalPatterns(),this.initializeErrorPatterns()}static getInstance(){return Gl.instance||(Gl.instance=new Gl),Gl.instance}async extractPatientClinicalData(e,r,a={}){const n={...this.defaultConfig,...a},i=Date.now();this.log(`üîç Starting data extraction for patient: ${r.name}`);const o=await this.preExtractionValidation(e,r);if(!o.isValid)throw new Error(`Pre-extraction validation failed: ${o.errors.join(", ")}`);const l=new Map;for(const h of n.fields)try{const f=await this.extractField(e,h,n);l.set(h,f),f.success?this.log(`‚úÖ Successfully extracted ${h}: ${f.content.length} chars`):this.log(`‚ùå Failed to extract ${h}: ${f.errorMessage}`)}catch(f){this.log(`‚ùå Exception extracting ${h}:`,f),l.set(h,{fieldName:h,content:"",extractionTime:0,success:!1,errorMessage:f instanceof Error?f.message:String(f),quality:this.createEmptyQualityReport(),fallbackUsed:!1,selectorUsed:"none"})}const c={background:l.get("background")?.content||"",investigations:l.get("investigations")?.content||"",medications:l.get("medications")?.content||"",extractionTimestamp:Date.now(),extractionAttempts:1,qualityScore:this.calculateOverallQualityScore(l)},A=this.assessDataQuality(c);if(this.log("üìä Data quality assessment:",{completeness:A.completenessScore,richness:A.contentRichness,confidence:A.confidenceLevel,medicalTerms:A.medicalTermsFound}),A.completenessScore<n.qualityThresholds.minCompletenessScore){this.log("‚ö†Ô∏è Low quality data detected, attempting fallback extraction");const h=await this.attemptFallbackExtraction(e,c,l,n);if(h)return h}const d=Date.now()-i;return this.log(`‚úÖ Data extraction completed in ${d}ms`),c}assessDataQuality(e){const r=["background","investigations","medications"],a=r.length;let n=0,i=0,o=0;const l=[],c=[];for(const u of r){const x=e[u];if(this.isContentMeaningful(x)){n++;const b=this.countWords(x),N=this.countMedicalTerms(x);i+=b,o+=N,this.containsErrorPatterns(x)&&c.push(`${u} contains potential error text`),b<5&&c.push(`${u} has very little content (${b} words)`)}else l.push(u)}const A=n/a,d=n>0?i/n:0,h=Math.min(1,d/50*.7+o/10*.3);let f="low";return A>=.8&&h>=.6&&o>=3?f="high":A>=.5&&h>=.3&&o>=1&&(f="medium"),{completenessScore:A,contentRichness:h,confidenceLevel:f,missingFields:l,extractionWarnings:c,medicalTermsFound:o,estimatedWordCount:i}}async verifyPatientIdentity(e,r){try{const a=await this.sendMessage(e,{type:"VERIFY_PATIENT_IDENTITY",data:{expectedName:r.name,expectedFileNumber:r.fileNumber,expectedDOB:r.dob}});if(a?.verified===!0)return{isValid:!0,errors:[],warnings:[],score:1};{const n=[`Patient identity mismatch. Expected: ${r.name} (${r.fileNumber})`];return a?.currentPatient&&n.push(`Current patient: ${a.currentPatient.name} (${a.currentPatient.fileNumber})`),{isValid:!1,errors:n,warnings:a?.warnings||[],score:0}}}catch(a){return{isValid:!1,errors:[`Failed to verify patient identity: ${a}`],warnings:[],score:0}}}async extractField(e,r,a){const n=Date.now(),i=a.fallbackSelectors[r]||[];for(let o=0;o<i.length;o++){const l=i[o],c=o===0;try{this.log(`üîç Extracting ${r} with selector: ${l} (attempt ${o+1})`);const A=await this.sendMessage(e,{type:"EXTRACT_FIELD_DATA",data:{fieldName:r,selector:l,timeout:a.timeout/i.length}});if(A?.success&&A?.content){const d=this.sanitizeContent(A.content),h=this.assessFieldQuality(r,d);return{fieldName:r,content:d,extractionTime:Date.now()-n,success:!0,quality:h,fallbackUsed:!c,selectorUsed:l}}}catch(A){if(this.log(`‚ùå Extraction attempt ${o+1} failed for ${r}:`,A),o<i.length-1)continue;return{fieldName:r,content:"",extractionTime:Date.now()-n,success:!1,errorMessage:A instanceof Error?A.message:String(A),quality:this.createEmptyQualityReport(),fallbackUsed:!c,selectorUsed:l}}}return{fieldName:r,content:"",extractionTime:Date.now()-n,success:!1,errorMessage:"All selectors failed",quality:this.createEmptyQualityReport(),fallbackUsed:!0,selectorUsed:"none"}}async preExtractionValidation(e,r){const a=[],n=[];try{const i=await this.verifyPatientIdentity(e,r);i.isValid||a.push(...i.errors),n.push(...i.warnings);const o=await this.sendMessage(e,{type:"CHECK_PAGE_READY_FOR_EXTRACTION"});o?.ready||(a.push("Page not ready for data extraction"),o?.reason&&a.push(`Reason: ${o.reason}`));const l=await this.sendMessage(e,{type:"CHECK_CLINICAL_SECTIONS_EXIST"});l?.allSectionsFound||(n.push("Some clinical sections may not be available"),l?.missingSections&&n.push(`Missing: ${l.missingSections.join(", ")}`))}catch(i){a.push(`Pre-extraction validation failed: ${i}`)}return{isValid:a.length===0,errors:a,warnings:n,score:a.length===0?1:0}}async attemptFallbackExtraction(e,r,a,n){this.log("üîÑ Attempting fallback extraction strategies");const i=[];for(const[c,A]of a)(!A.success||A.quality.completenessScore<.5)&&i.push(c);if(i.length===0)return null;const o={...r};let l=!1;for(const c of i)try{const A=await this.tryOCRExtraction(e,c);if(A&&this.isContentMeaningful(A)&&(c==="background"||c==="investigations"||c==="medications")){o[c]=A,l=!0,this.log(`‚úÖ OCR extraction successful for ${c}`);continue}const d=await this.trySemanticExtraction(e,c);if(d&&this.isContentMeaningful(d)&&(c==="background"||c==="investigations"||c==="medications")){o[c]=d,l=!0,this.log(`‚úÖ Semantic extraction successful for ${c}`);continue}}catch(A){this.log(`‚ùå Fallback extraction failed for ${c}:`,A)}return l?(o.extractionAttempts++,o.qualityScore=this.calculateOverallQualityScore(new Map([["improved",{fieldName:"improved",content:JSON.stringify(o),extractionTime:0,success:!0,quality:this.assessDataQuality(o),fallbackUsed:!0,selectorUsed:"fallback"}]])),o):null}async tryOCRExtraction(e,r){try{return(await this.sendMessage(e,{type:"EXTRACT_FIELD_OCR",data:{fieldName:r}}))?.content||null}catch{return null}}async trySemanticExtraction(e,r){try{return(await this.sendMessage(e,{type:"EXTRACT_FIELD_SEMANTIC",data:{fieldName:r}}))?.content||null}catch{return null}}isContentMeaningful(e){if(!e||typeof e!="string")return!1;const r=e.trim();return r.length<3?!1:![/^(\s*|-|n\/a|none|nil|not?\s*applicable?)$/i,/^\s*\[.*extraction.*failed.*\]\s*$/i,/^\s*loading\.+\s*$/i,/^\s*please\s+wait\.+\s*$/i].some(n=>n.test(r))}countWords(e){return e?e.trim().split(/\s+/).filter(r=>r.length>0).length:0}countMedicalTerms(e){if(!e)return 0;let r=0;for(const a of this.medicalTermPatterns){const n=e.match(a);n&&(r+=n.length)}return r}containsErrorPatterns(e){return this.commonErrorPatterns.some(r=>r.test(e))}sanitizeContent(e){return e?e.trim().replace(/\s+/g," ").replace(/[\\u0000-\\u001F\\u007F]/g,""):""}assessFieldQuality(e,r){const a=this.countWords(r),n=this.countMedicalTerms(r),i=this.isContentMeaningful(r),o=i?1:0,l=Math.min(1,a/20);let c="low";return o===1&&a>=10&&n>=1?c="high":o===1&&a>=5&&(c="medium"),{completenessScore:o,contentRichness:l,confidenceLevel:c,missingFields:i?[]:[e],extractionWarnings:this.containsErrorPatterns(r)?["Contains error patterns"]:[],medicalTermsFound:n,estimatedWordCount:a}}createEmptyQualityReport(){return{completenessScore:0,contentRichness:0,confidenceLevel:"low",missingFields:[],extractionWarnings:[],medicalTermsFound:0,estimatedWordCount:0}}calculateOverallQualityScore(e){const r=Array.from(e.values());if(r.length===0)return 0;const a=r.reduce((o,l)=>o+l.quality.completenessScore,0)/r.length,n=r.reduce((o,l)=>o+l.quality.contentRichness,0)/r.length,i=r.filter(o=>o.success).length/r.length;return a*.4+n*.3+i*.3}initializeMedicalPatterns(){this.medicalTermPatterns=[/\b(?:diagnosis|treatment|medication|prescription|symptom|condition|disease|disorder|syndrome)\b/gi,/\b\d+\s*(?:mg|mcg|g|ml|cc|units?|mmHg|bpm|kg|lbs?)\b/gi,/\b(?:angiogram|angioplasty|stent|bypass|catheter|biopsy|surgery|procedure)\b/gi,/\b(?:abnormal|normal|elevated|decreased|hypertension|diabetes|coronary|cardiac|pulmonary)\b/gi,/\b(?:paracetamol|lignocaine|adrenaline|salbutamol|glyceryl trinitrate)\b/gi]}initializeErrorPatterns(){this.commonErrorPatterns=[/error|failed|timeout|exception|null|undefined/gi,/loading\.+|please\s+wait\.+/gi,/access\s+denied|permission\s+denied/gi,/not\s+found|404|500|503/gi]}async sendMessage(e,r,a=5e3){return new Promise((n,i)=>{const o=setTimeout(()=>{i(new Error(`Message timeout after ${a}ms`))},a);try{chrome.tabs.sendMessage(e,r,l=>{if(clearTimeout(o),chrome.runtime.lastError){i(new Error(`Message failed: ${chrome.runtime.lastError.message}`));return}n(l)})}catch(l){clearTimeout(o),i(l)}})}log(...e){this.debugMode&&console.log("[DataValidation]",...e)}setDebugMode(e){this.debugMode=e}updateConfig(e){Object.assign(this.defaultConfig,e)}getConfig(){return{...this.defaultConfig}}}class zl{static instance;strategies;circuitBreakers;failureHistory;config;debugMode=!1;constructor(){this.strategies=new Map,this.circuitBreakers=new Map,this.failureHistory=[],this.config=this.getDefaultConfig(),this.initializeStrategies()}static getInstance(){return zl.instance||(zl.instance=new zl),zl.instance}async executeWithRecovery(e,r,a){const n=`${r.operation}_${r.patientIndex}`;if(this.isCircuitBreakerOpen(n))throw new Error(`Circuit breaker is open for operation: ${r.operation}`);let i=null,o=0;const l=this.getMaxAttempts(r.operation);for(;o<l;)try{this.log(`üîÑ Executing ${r.operation} (attempt ${o+1}/${l})`);const c=await e();return this.resetCircuitBreaker(n),this.log(`‚úÖ Operation ${r.operation} succeeded on attempt ${o+1}`),c}catch(c){o++,i=c instanceof Error?c:new Error(String(c)),this.log(`‚ùå Attempt ${o} failed for ${r.operation}:`,i.message);const A=this.classifyError(i),d={patientIndex:r.patientIndex,patient:r.patient,operation:r.operation,error:i.message,timestamp:Date.now(),context:r,recoveryAttempted:!1},h=this.getStrategy(A,a);if(!h.shouldRetry(i,o,r)||o>=l){this.recordCircuitBreakerFailure(n),this.recordFailure(d);break}d.recoveryAttempted=!0,await this.applyRecoveryStrategy(h,i,o,r),this.recordFailure(d)}if(this.recordCircuitBreakerFailure(n),this.config.enableGracefulDegradation){const c=await this.attemptGracefulDegradation(r,i);if(c!==null)return this.log(`üîÑ Graceful degradation successful for ${r.operation}`),c}throw new Error(`Operation ${r.operation} failed after ${o} attempts. Last error: ${i?.message}`)}shouldRetryOperation(e,r,a){const n=this.classifyError(r),i=this.strategies.get(n);if(!i)return!1;const o={operation:e,patientIndex:0,patient:{name:"",dob:"",fileNumber:"",appointmentTime:"",appointmentType:"",confirmed:!1,isFirstAppointment:!1},timestamp:Date.now(),environmentState:{tabId:0,currentUrl:"",contentScriptVersion:"",lastHealthCheck:0},previousAttempts:a-1};return i.shouldRetry(r,a,o)}getRetryDelay(e,r){const a=this.strategies.get(e);return a?this.calculateBackoffDelay(a.backoffStrategy,r,1e3):1e3}resetCircuitBreaker(e){const r=this.circuitBreakers.get(e);r&&(r.failures=0,r.state="closed",r.resetAttempts=0)}getFailureStats(){const e=new Map,r=new Map;for(const i of this.failureHistory){const o=this.classifyError(new Error(i.error));e.set(o,(e.get(o)||0)+1),r.set(i.operation,(r.get(i.operation)||0)+1)}const a=this.failureHistory.filter(i=>Date.now()-i.timestamp<3e5).slice(-10),n=Array.from(this.circuitBreakers.entries()).filter(([i,o])=>o.state==="open").map(([i,o])=>i);return{totalFailures:this.failureHistory.length,failuresByType:e,failuresByOperation:r,recentFailures:a,circuitBreakersOpen:n}}initializeStrategies(){this.strategies.set("network_timeout",{errorType:"network_timeout",maxRetries:3,backoffStrategy:"exponential",recoveryTimeout:3e4,shouldRetry:(e,r,a)=>r<=3&&!e.message.includes("permanent")}),this.strategies.set("dom_not_found",{errorType:"dom_not_found",maxRetries:5,backoffStrategy:"linear",recoveryTimeout:2e4,shouldRetry:(e,r,a)=>r<=5,fallbackAction:async()=>null}),this.strategies.set("content_script_unresponsive",{errorType:"content_script_unresponsive",maxRetries:2,backoffStrategy:"fixed",recoveryTimeout:15e3,shouldRetry:(e,r,a)=>r<=2,fallbackAction:async()=>null}),this.strategies.set("extraction_failed",{errorType:"extraction_failed",maxRetries:4,backoffStrategy:"fibonacci",recoveryTimeout:25e3,shouldRetry:(e,r,a)=>r<=4&&!e.message.includes("no data available")}),this.strategies.set("ai_processing_failed",{errorType:"ai_processing_failed",maxRetries:2,backoffStrategy:"exponential",recoveryTimeout:6e4,shouldRetry:(e,r,a)=>r<=2&&!e.message.includes("model unavailable")}),this.strategies.set("navigation_failed",{errorType:"navigation_failed",maxRetries:3,backoffStrategy:"linear",recoveryTimeout:2e4,shouldRetry:(e,r,a)=>r<=3}),this.strategies.set("permission_denied",{errorType:"permission_denied",maxRetries:1,backoffStrategy:"fixed",recoveryTimeout:5e3,shouldRetry:(e,r,a)=>!1}),this.strategies.set("memory_limit",{errorType:"memory_limit",maxRetries:1,backoffStrategy:"fixed",recoveryTimeout:1e4,shouldRetry:(e,r,a)=>r===1,fallbackAction:async()=>{try{window.gc&&window.gc()}catch{}return null}}),this.strategies.set("unknown",{errorType:"unknown",maxRetries:2,backoffStrategy:"exponential",recoveryTimeout:15e3,shouldRetry:(e,r,a)=>r<=2})}classifyError(e){const r=e.message.toLowerCase();return r.includes("timeout")||r.includes("timed out")?"network_timeout":r.includes("not found")||r.includes("element")||r.includes("selector")?"dom_not_found":r.includes("content script")||r.includes("script not responsive")?"content_script_unresponsive":r.includes("extraction")||r.includes("data")||r.includes("field")?"extraction_failed":r.includes("ai")||r.includes("model")||r.includes("processing")?"ai_processing_failed":r.includes("navigation")||r.includes("navigate")||r.includes("tab")?"navigation_failed":r.includes("permission")||r.includes("access denied")?"permission_denied":r.includes("memory")||r.includes("heap")||r.includes("out of memory")?"memory_limit":"unknown"}getStrategy(e,r){const a=this.strategies.get(e)||this.strategies.get("unknown");return r?{...a,...r}:a}async applyRecoveryStrategy(e,r,a,n){const i=this.calculateBackoffDelay(e.backoffStrategy,a);if(this.log(`üîÑ Applying recovery strategy for ${e.errorType}, waiting ${i}ms`),e.fallbackAction)try{await e.fallbackAction(),this.log(`‚úÖ Fallback action executed for ${e.errorType}`)}catch(o){this.log(`‚ùå Fallback action failed for ${e.errorType}:`,o)}await this.sleep(i),await this.performContextSpecificRecovery(n,e.errorType)}async performContextSpecificRecovery(e,r){switch(r){case"content_script_unresponsive":await this.recoverContentScript(e.environmentState.tabId);break;case"dom_not_found":await this.recoverDOMElements(e.environmentState.tabId);break;case"navigation_failed":await this.recoverNavigation(e.environmentState.tabId);break;case"memory_limit":await this.recoverMemory();break}}async recoverContentScript(e){try{this.log(`üîß Attempting to recover content script on tab ${e}`),await chrome.scripting.executeScript({target:{tabId:e},files:["content-script.js"]}),await this.sleep(2e3)}catch(r){this.log("‚ùå Content script recovery failed:",r)}}async recoverDOMElements(e){try{this.log(`üîß Attempting to recover DOM elements on tab ${e}`),await this.sleep(1e3),await chrome.tabs.sendMessage(e,{type:"REFRESH_PAGE_SECTION"})}catch(r){this.log("‚ùå DOM recovery failed:",r)}}async recoverNavigation(e){try{if(this.log(`üîß Attempting to recover navigation on tab ${e}`),!await chrome.tabs.get(e))throw new Error("Tab no longer exists");await this.sleep(3e3)}catch(r){this.log("‚ùå Navigation recovery failed:",r)}}async recoverMemory(){this.log("üîß Attempting memory recovery"),this.failureHistory.length>100&&(this.failureHistory=this.failureHistory.slice(-50));const e=Date.now();for(const[r,a]of this.circuitBreakers)e-a.lastFailureTime>3e5&&this.circuitBreakers.delete(r);try{window.gc&&window.gc()}catch{}}calculateBackoffDelay(e,r,a=1e3){switch(e){case"exponential":return Math.min(a*Math.pow(2,r-1),3e4);case"linear":return Math.min(a*r,2e4);case"fibonacci":return Math.min(this.fibonacci(r)*a,25e3);case"fixed":default:return a}}fibonacci(e){if(e<=1)return 1;if(e===2)return 2;let r=1,a=2;for(let n=3;n<=e;n++){const i=r+a;r=a,a=i}return a}isCircuitBreakerOpen(e){const r=this.circuitBreakers.get(e);return r&&r.state==="open"?Date.now()-r.lastFailureTime>this.config.circuitBreakerResetTime?(r.state="half-open",r.resetAttempts++,!1):!0:!1}recordCircuitBreakerFailure(e){let r=this.circuitBreakers.get(e);r||(r={failures:0,lastFailureTime:0,state:"closed",resetAttempts:0},this.circuitBreakers.set(e,r)),r.failures++,r.lastFailureTime=Date.now(),r.failures>=this.config.circuitBreakerThreshold&&(r.state="open",this.log(`üö® Circuit breaker opened for operation: ${e}`))}recordFailure(e){this.failureHistory.push(e),this.failureHistory.length>500&&(this.failureHistory=this.failureHistory.slice(-250))}getMaxAttempts(e){const r=["extract-data","ai-review"],a=["navigate","activate-patient"];return r.some(n=>e.includes(n))?5:a.some(n=>e.includes(n))?3:2}async attemptGracefulDegradation(e,r){switch(this.log(`üîÑ Attempting graceful degradation for ${e.operation}`),e.operation){case"extract-data":return{background:"[Data extraction failed - manual review required]",investigations:"[Data extraction failed]",medications:"[Data extraction failed]"};case"ai-review":return{summary:"[AI review failed - manual review required]",findings:[],recommendations:[]};default:return null}}getDefaultConfig(){return{strategy:"conservative",maxTotalRetries:10,circuitBreakerThreshold:5,circuitBreakerResetTime:3e5,enableGracefulDegradation:!0,userNotificationEnabled:!0}}async sleep(e){return new Promise(r=>setTimeout(r,e))}log(...e){this.debugMode&&console.log("[ErrorRecoveryManager]",...e)}setDebugMode(e){this.debugMode=e}updateConfig(e){Object.assign(this.config,e)}getConfig(){return{...this.config}}clearHistory(){this.failureHistory=[],this.circuitBreakers.clear()}addCustomStrategy(e,r){this.strategies.set(e,r)}}class Wl{static instance;config;storagePrefix="batch_checkpoint_";backupPrefix="backup_checkpoint_";debugMode=!1;constructor(){this.config=this.getDefaultConfig()}static getInstance(){return Wl.instance||(Wl.instance=new Wl),Wl.instance}async saveCheckpoint(e,r,a,n,i,o,l,c){const A=this.generateCheckpointId(e),d=Date.now();this.log(`üíæ Saving checkpoint: ${A}`);const h={lastSuccessfulOperation:this.getLastSuccessfulOperation(a),skippedPatients:this.getSkippedPatients(a),retryQueue:this.buildRetryQueue(i),environmentState:c},f={id:A,batchId:e,timestamp:d,version:"1.0.0",totalPatients:r.selectedPatients.length,completedPatients:a,currentPatientIndex:n,failedAttempts:i,configuration:o,performanceMetrics:l,resumeData:h,integrityHash:""};f.integrityHash=await this.calculateIntegrityHash(f);try{const u=this.config.compressionEnabled?await this.compressData(f):JSON.stringify(f),x=this.config.encryptionEnabled?await this.encryptData(u):u,b=this.storagePrefix+A;if(await this.saveToStorage(b,x),this.config.backupEnabled){const N=this.backupPrefix+A;await this.saveToStorage(N,x)}return this.log(`‚úÖ Checkpoint saved successfully: ${A}`),await this.cleanupOldCheckpoints(e),A}catch(u){throw this.log("‚ùå Failed to save checkpoint:",u),new Error(`Checkpoint save failed: ${u instanceof Error?u.message:String(u)}`)}}async loadCheckpoint(e){this.log(`üìÇ Loading checkpoint: ${e}`);try{let r=await this.loadFromStorage(this.storagePrefix+e);if(!r&&this.config.backupEnabled&&(this.log("‚ö†Ô∏è Primary checkpoint not found, trying backup"),r=await this.loadFromStorage(this.backupPrefix+e)),!r)throw new Error(`Checkpoint not found: ${e}`);const a=this.config.encryptionEnabled?await this.decryptData(r):r,n=this.config.compressionEnabled?await this.decompressData(a):JSON.parse(a);if(this.config.integrityChecking&&!await this.validateIntegrity(n))throw new Error("Checkpoint integrity validation failed");const i=this.validateCheckpointStructure(n);if(!i.isValid)throw new Error(`Invalid checkpoint structure: ${i.errors.join(", ")}`);return this.log(`‚úÖ Checkpoint loaded successfully: ${e}`),n}catch(r){throw this.log("‚ùå Failed to load checkpoint:",r),new Error(`Checkpoint load failed: ${r instanceof Error?r.message:String(r)}`)}}async resumeFromCheckpoint(e,r,a={}){this.log(`üîÑ Resuming from checkpoint: ${e}`);const n=await this.loadCheckpoint(e),i={skipFailedPatients:!1,retryFailedPatients:!0,validateEnvironment:!0,allowConfigChanges:!0,resumeFromLastSuccessful:!0,...a},o=[];if(i.validateEnvironment){const c=await this.validateEnvironment(n.resumeData.environmentState);if(!c.isValid&&(o.push(`Environment validation warnings: ${c.warnings.join(", ")}`),c.errors.length>0))throw new Error(`Environment validation failed: ${c.errors.join(", ")}`)}if(r){if(!i.allowConfigChanges)throw new Error("Configuration changes not allowed during resume");const c=this.compareConfigurations(n.configuration,r);c.hasSignificantChanges&&o.push(`Significant configuration changes detected: ${c.changes.join(", ")}`),n.configuration={...n.configuration,...r}}const l=this.determineResumeStrategy(n,i);return n.resumeData.lastSuccessfulOperation=`resumed_from_checkpoint_${Date.now()}`,this.log("‚úÖ Resume strategy determined:",l),{checkpoint:n,resumeStrategy:l,warnings:o}}async listCheckpoints(e){try{const a=await chrome.storage.local.get(null),n=[];for(const[i,o]of Object.entries(a))if(i.startsWith(this.storagePrefix))try{const l=await this.extractCheckpointInfo(i,o);(!e||l.batchId===e)&&n.push(l)}catch(l){this.log(`‚ö†Ô∏è Error reading checkpoint ${i}:`,l)}return n.sort((i,o)=>o.timestamp-i.timestamp),n}catch(r){return this.log("‚ùå Failed to list checkpoints:",r),[]}}async deleteCheckpoint(e){try{const r=chrome.storage.local,a=[this.storagePrefix+e,this.backupPrefix+e];await r.remove(a),this.log(`üóëÔ∏è Checkpoint deleted: ${e}`)}catch(r){throw this.log("‚ùå Failed to delete checkpoint:",r),new Error(`Checkpoint deletion failed: ${r instanceof Error?r.message:String(r)}`)}}async cleanupOldCheckpoints(e){try{const r=await this.listCheckpoints(e);if(r.length<=this.config.maxCheckpoints)return 0;const a=r.slice(this.config.maxCheckpoints);let n=0;for(const i of a)try{await this.deleteCheckpoint(i.id),n++}catch(o){this.log(`‚ö†Ô∏è Failed to delete old checkpoint ${i.id}:`,o)}return this.log(`üßπ Cleaned up ${n} old checkpoints`),n}catch(r){return this.log("‚ùå Cleanup failed:",r),0}}generateCheckpointId(e){return`${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async calculateIntegrityHash(e){const r={...e};delete r.integrityHash;const a=JSON.stringify(r),i=new TextEncoder().encode(a),o=await crypto.subtle.digest("SHA-256",i);return Array.from(new Uint8Array(o)).map(c=>c.toString(16).padStart(2,"0")).join("")}async validateIntegrity(e){const r=e.integrityHash,a=await this.calculateIntegrityHash(e);return r===a}validateCheckpointStructure(e){const r=[],a=[],n=["id","batchId","timestamp","version","totalPatients","completedPatients","currentPatientIndex"];for(const i of n)(e[i]===void 0||e[i]===null)&&r.push(`Missing required field: ${i}`);return typeof e.currentPatientIndex!="number"&&r.push("currentPatientIndex must be a number"),Array.isArray(e.completedPatients)||r.push("completedPatients must be an array"),(e.currentPatientIndex<0||e.currentPatientIndex>e.totalPatients)&&a.push("currentPatientIndex seems out of bounds"),e.version!=="1.0.0"&&a.push(`Checkpoint version ${e.version} may not be fully compatible`),{isValid:r.length===0,errors:r,warnings:a,score:r.length===0?1:0}}async validateEnvironment(e){const r=[],a=[];try{if(e.tabId)try{await chrome.tabs.get(e.tabId)}catch{a.push("Original tab no longer exists")}if(e.currentUrl)try{new URL(e.currentUrl)}catch{a.push("Current URL appears invalid")}e.contentScriptVersion&&a.push("Content script version compatibility not verified"),Date.now()-e.lastHealthCheck>36e5&&a.push("Environment state is quite old (>1 hour)")}catch(n){r.push(`Environment validation error: ${n}`)}return{isValid:r.length===0,errors:r,warnings:a,score:r.length===0?1:0}}compareConfigurations(e,r){const a=[],n=["maxRetries","timeoutMs","errorRecoveryStrategy"];for(const[o,l]of Object.entries(r)){const c=e[o];c!==l&&a.push(`${o}: ${c} ‚Üí ${l}`)}return{hasSignificantChanges:a.some(o=>n.some(l=>o.startsWith(l))),changes:a}}determineResumeStrategy(e,r){const a={startIndex:e.currentPatientIndex,skipPatients:[],retryPatients:[],forceReprocessPatients:[],resumeMode:"continue"};if(r.resumeFromLastSuccessful){const n=this.findLastSuccessfulPatientIndex(e.completedPatients);a.startIndex=Math.max(n+1,e.currentPatientIndex)}return r.skipFailedPatients?a.skipPatients=e.failedAttempts.map(n=>n.patientIndex):r.retryFailedPatients&&(a.retryPatients=e.failedAttempts.map(n=>n.patientIndex)),a.retryPatients.length>0?a.resumeMode="retry_failed":a.skipPatients.length>0?a.resumeMode="skip_failed":a.resumeMode="continue",a}getLastSuccessfulOperation(e){const r=e.filter(n=>n.success);return r.length===0?"batch_start":`patient_completed_${r[r.length-1].patient.fileNumber}`}getSkippedPatients(e){const r=new Set(e.map((n,i)=>i)),a=[];for(let n=0;n<e.length;n++)r.has(n)||a.push(n);return a}buildRetryQueue(e){const r=[],a=new Map;for(const n of e){const i=a.get(n.patientIndex)||[];i.push(n),a.set(n.patientIndex,i)}for(const[n,i]of a){const o=i[i.length-1];r.push({patientIndex:n,patient:o.patient,lastError:o.error,retryCount:i.length,nextRetryTime:Date.now()+i.length*6e4})}return r}findLastSuccessfulPatientIndex(e){for(let r=e.length-1;r>=0;r--)if(e[r].success)return r;return-1}async extractCheckpointInfo(e,r){try{const a=e.replace(this.storagePrefix,"");let n;return this.config.encryptionEnabled?n={id:a,timestamp:0,batchId:"encrypted"}:this.config.compressionEnabled?n=await this.decompressData(r):n=JSON.parse(r),{id:n.id||a,batchId:n.batchId||"unknown",timestamp:n.timestamp||0,totalPatients:n.totalPatients||0,completedPatients:n.completedPatients?.length||0,currentIndex:n.currentPatientIndex||0,hasFailures:(n.failedAttempts?.length||0)>0}}catch(a){throw new Error(`Failed to extract checkpoint info: ${a}`)}}async saveToStorage(e,r){await chrome.storage.local.set({[e]:r})}async loadFromStorage(e){return(await chrome.storage.local.get(e))[e]||null}async compressData(e){return JSON.stringify(e).replace(/\s+/g,"").replace(/"completedPatients"/g,'"cp"').replace(/"currentPatientIndex"/g,'"ci"').replace(/"failedAttempts"/g,'"fa"').replace(/"timestamp"/g,'"ts"')}async decompressData(e){const r=e.replace(/"cp"/g,'"completedPatients"').replace(/"ci"/g,'"currentPatientIndex"').replace(/"fa"/g,'"failedAttempts"').replace(/"ts"/g,'"timestamp"');return JSON.parse(r)}async encryptData(e){return btoa(e)}async decryptData(e){return atob(e)}getDefaultConfig(){return{autoSaveInterval:5,maxCheckpoints:10,compressionEnabled:!0,encryptionEnabled:!1,integrityChecking:!0,backupEnabled:!0}}log(...e){this.debugMode&&console.log("[CheckpointManager]",...e)}setDebugMode(e){this.debugMode=e}updateConfig(e){Object.assign(this.config,e)}getConfig(){return{...this.config}}}class ql{static instance;metrics;config;memorySnapshots=[];activeOperations=new Map;memoryMonitorInterval;debugMode=!1;constructor(){this.config=this.getDefaultConfig(),this.metrics=this.initializeMetrics(),this.startMemoryMonitoring()}static getInstance(){return ql.instance||(ql.instance=new ql),ql.instance}startSession(e){this.log(`üìä Starting metrics session: ${e}`),this.metrics=this.initializeMetrics(),this.metrics.sessionId=e,this.metrics.batchStartTime=Date.now(),this.config.enablePerformanceMarks&&performance.mark(`batch-start-${e}`)}endSession(){const e=Date.now();this.metrics.totalProcessingTime=e-this.metrics.batchStartTime,this.log(`üìä Ending metrics session: ${this.metrics.sessionId}`),this.config.enablePerformanceMarks&&(performance.mark(`batch-end-${this.metrics.sessionId}`),performance.measure(`batch-duration-${this.metrics.sessionId}`,`batch-start-${this.metrics.sessionId}`,`batch-end-${this.metrics.sessionId}`));const r=this.generateReport();return this.config.autoExport&&this.exportMetrics(r),r}startOperation(e,r,a){const n=Date.now();this.activeOperations.set(e,n),this.log(`‚è±Ô∏è Started operation: ${r} (${e})`),this.config.enablePerformanceMarks&&performance.mark(`op-start-${e}`)}endOperation(e,r,a,n,i){const o=Date.now(),l=this.activeOperations.get(e);if(!l)return this.log(`‚ö†Ô∏è No start time found for operation: ${e}`),this.createEmptyTiming(r,e);const c=o-l;this.activeOperations.delete(e);const A={operation:r,startTime:l,endTime:o,duration:c,success:a,patientIndex:n,metadata:i};switch(this.metrics.operationTimings.push(A),r){case"patient-activation":this.metrics.patientActivationTimes.push(c);break;case"data-extraction":this.metrics.dataExtractionTimes.push(c);break;case"ai-review":this.metrics.aiReviewTimes.push(c);break;case"content-script-response":this.metrics.contentScriptResponseTimes.push(c);break}if(!a){const d=this.metrics.retryCount.get(r)||0;this.metrics.retryCount.set(r,d+1)}return this.log(`‚úÖ Completed operation: ${r} in ${c}ms (success: ${a})`),this.config.enablePerformanceMarks&&(performance.mark(`op-end-${e}`),performance.measure(`op-duration-${e}`,`op-start-${e}`,`op-end-${e}`)),A}recordError(e,r,a){const n=this.classifyError(r),i=this.metrics.errorFrequency.get(n)||0;this.metrics.errorFrequency.set(n,i+1);const o=this.metrics.errorFrequency.get(e)||0;this.metrics.errorFrequency.set(e,o+1),this.log(`‚ùå Recorded error: ${n} in ${e} (patient ${a})`)}takeMemorySnapshot(){const e={timestamp:Date.now(),heapUsed:0,heapTotal:0,external:0};if(performance.memory){const r=performance.memory;e.heapUsed=r.usedJSHeapSize,e.heapTotal=r.totalJSHeapSize,e.external=r.usedJSHeapSize}return this.memorySnapshots.push(e),this.metrics.memoryUsageHistory.push(e),this.memorySnapshots.length>1e3&&(this.memorySnapshots=this.memorySnapshots.slice(-500)),e}getPerformanceIndicators(){const e=this.getRecentTimings(3e5),r=this.metrics.operationTimings.length,a=this.metrics.operationTimings.filter(f=>f.success).length,n=e.filter(f=>f.patientIndex!==void 0),i=n.length>0?n.reduce((f,u)=>f+u.duration,0)/n.length:0,o=r>0?a/r:1;let l="normal";i>0&&(i<3e4?l="fast":i<6e4?l="normal":i<12e4?l="slow":l="degraded");const c=Array.from(this.metrics.errorFrequency.values()).reduce((f,u)=>f+u,0),A=r>0?c/r:0,d=this.memorySnapshots[this.memorySnapshots.length-1],h=d?d.heapUsed/(1024*1024):0;return{averageTimePerPatient:i,successRate:o,currentSpeed:l,errorRate:A,memoryUsage:h}}generateReport(){const e=this.generateSummary(),r=this.analyzeTimings(),a=this.analyzeMemory(),n=this.analyzeErrors(),i=this.generateInsights(),o=this.generateRecommendations(i);return{summary:e,timingAnalysis:r,memoryAnalysis:a,errorAnalysis:n,performanceInsights:i,recommendations:o}}async exportMetrics(e){const r=new Date().toISOString().replace(/[:.]/g,"-"),a=`batch-metrics-${e.summary.sessionId}-${r}`;return this.config.exportFormat==="csv"?this.exportAsCSV(e,a):this.exportAsJSON(e,a)}generateSummary(){const e=new Set(this.metrics.operationTimings.filter(A=>A.patientIndex!==void 0).map(A=>A.patientIndex)).size,r=new Set(this.metrics.operationTimings.filter(A=>A.patientIndex!==void 0&&A.success).map(A=>A.patientIndex)).size,a=e-r,n=this.metrics.operationTimings.filter(A=>A.patientIndex!==void 0),i=n.length>0?n.reduce((A,d)=>A+d.duration,0)/n.length:0,o=e>0?r/e:0,l=this.metrics.totalProcessingTime/(1e3*60*60),c=l>0?e/l:0;return{sessionId:this.metrics.sessionId,totalDuration:this.metrics.totalProcessingTime,totalPatients:e,successfulPatients:r,failedPatients:a,averageTimePerPatient:i,successRate:o,throughputPatientsPerHour:c}}analyzeTimings(){const e=new Map,r=[];for(const o of this.metrics.operationTimings){r.push(o.duration);let l=e.get(o.operation);l||(l={operation:o.operation,count:0,totalTime:0,averageTime:0,minTime:1/0,maxTime:0,standardDeviation:0,successRate:0},e.set(o.operation,l)),l.count++,l.totalTime+=o.duration,l.minTime=Math.min(l.minTime,o.duration),l.maxTime=Math.max(l.maxTime,o.duration),o.success&&l.successRate++}for(const o of e.values()){o.averageTime=o.totalTime/o.count,o.successRate=o.successRate/o.count;const l=this.metrics.operationTimings.filter(A=>A.operation===o.operation).map(A=>A.duration),c=l.reduce((A,d)=>A+Math.pow(d-o.averageTime,2),0)/l.length;o.standardDeviation=Math.sqrt(c)}r.sort((o,l)=>o-l);const a={p50:this.getPercentile(r,50),p90:this.getPercentile(r,90),p95:this.getPercentile(r,95),p99:this.getPercentile(r,99)},n=this.identifyBottlenecks(e),i=this.determineCriticalPath(e);return{operationBreakdown:e,criticalPath:i,bottlenecks:n,percentiles:a}}analyzeMemory(){if(this.memorySnapshots.length<2)return{peakUsage:0,averageUsage:0,growthRate:0,leakDetection:[],gcImpact:0};const e=this.memorySnapshots.map(d=>d.heapUsed),r=Math.max(...e),a=e.reduce((d,h)=>d+h,0)/e.length,n=this.memorySnapshots[0],i=this.memorySnapshots[this.memorySnapshots.length-1],o=(i.timestamp-n.timestamp)/(1e3*60),l=(i.heapUsed-n.heapUsed)/(1024*1024),c=o>0?l/o:0,A=this.detectMemoryLeaks();return{peakUsage:r/(1024*1024),averageUsage:a/(1024*1024),growthRate:c,leakDetection:A,gcImpact:0}}analyzeErrors(){const e=Array.from(this.metrics.errorFrequency.values()).reduce((u,x)=>u+x,0),r=this.metrics.operationTimings.length,a=this.metrics.operationTimings.filter(u=>u.success).length,n=r>0?e/r:0,i=r>e?(a-(r-e))/e:0,o=new Map,l=new Map;for(const[u,x]of this.metrics.errorFrequency)this.isErrorType(u)?o.set(u,x):l.set(u,x);const c=this.metrics.operationTimings.filter(u=>!u.success),A=c.length>0?c.reduce((u,x)=>u+x.duration,0)/c.length:0,d=this.metrics.operationTimings.filter(u=>u.success),h=d.length>0?d.reduce((u,x)=>u+x.duration,0)/d.length:0,f=h>0?(A-h)/h:0;return{totalErrors:e,errorsByType:o,errorsByOperation:l,errorRate:n,recoveryRate:i,impactOnPerformance:f}}generateInsights(){const e=[],r=this.getPerformanceIndicators();return r.currentSpeed==="degraded"&&e.push({type:"warning",title:"Severely Degraded Performance",description:`Average processing time per patient is ${Math.round(r.averageTimePerPatient/1e3)}s, indicating severe performance issues.`,impact:"high",actionRequired:!0}),r.errorRate>.1&&e.push({type:"warning",title:"High Error Rate",description:`Error rate of ${Math.round(r.errorRate*100)}% is concerning and may indicate system issues.`,impact:"high",actionRequired:!0}),r.memoryUsage>500&&e.push({type:"warning",title:"High Memory Usage",description:`Memory usage of ${Math.round(r.memoryUsage)}MB is high and may cause performance issues.`,impact:"medium",actionRequired:!1}),r.successRate<.9&&e.push({type:"optimization",title:"Low Success Rate",description:`Success rate of ${Math.round(r.successRate*100)}% suggests opportunities for improvement.`,impact:"medium",actionRequired:!1}),e}generateRecommendations(e){const r=[];for(const a of e)switch(a.title){case"Severely Degraded Performance":r.push("Consider reducing batch size or increasing timeout values"),r.push("Check for network connectivity issues");break;case"High Error Rate":r.push("Review error logs to identify common failure patterns"),r.push("Consider implementing additional retry strategies");break;case"High Memory Usage":r.push("Implement more frequent garbage collection"),r.push("Reduce the number of concurrent operations");break;case"Low Success Rate":r.push("Improve error handling and recovery mechanisms"),r.push("Add more robust validation checks");break}return r}identifyBottlenecks(e){const r=[];for(const a of e.values()){let n="low",i="";a.averageTime>6e4?(n="critical",i="This operation is extremely slow and should be optimized immediately"):a.averageTime>3e4?(n="high",i="Consider optimizing this operation or implementing caching"):a.averageTime>15e3&&(n="medium",i="Monitor this operation for potential optimization opportunities"),n!=="low"&&r.push({operation:a.operation,averageTime:a.averageTime,impact:n,description:`${a.operation} takes an average of ${Math.round(a.averageTime/1e3)}s`,suggestion:i})}return r.sort((a,n)=>n.averageTime-a.averageTime)}determineCriticalPath(e){return Array.from(e.values()).sort((a,n)=>n.averageTime*n.count-a.averageTime*a.count).slice(0,5).map(a=>a.operation)}detectMemoryLeaks(){const e=[];if(this.memorySnapshots.length<10)return e;const r=this.memorySnapshots.slice(-10),a=[];for(let i=1;i<r.length;i++){const o=r[i].heapUsed-r[i-1].heapUsed;a.push(o)}const n=a.reduce((i,o)=>i+o,0)/a.length;return r[r.length-1].heapUsed-r[0].heapUsed,n>1024*1024&&e.push({suspected:!0,confidence:Math.min(n/(5*1024*1024),1),description:"Consistent memory growth detected",growthPattern:"linear"}),e}getPercentile(e,r){const a=Math.ceil(r/100*e.length)-1;return e[Math.max(0,Math.min(a,e.length-1))]||0}getRecentTimings(e){const r=Date.now()-e;return this.metrics.operationTimings.filter(a=>a.startTime>=r)}classifyError(e){const r=e.toLowerCase();return r.includes("timeout")?"timeout":r.includes("network")?"network":r.includes("permission")?"permission":r.includes("not found")?"not_found":r.includes("memory")?"memory":"unknown"}isErrorType(e){return["timeout","network","permission","not_found","memory","unknown"].includes(e)}createEmptyTiming(e,r){return{operation:e,startTime:Date.now(),endTime:Date.now(),duration:0,success:!1,metadata:{error:"No start time found",operationId:r}}}async exportAsJSON(e,r){const a=JSON.stringify(e,null,2);if(typeof window<"u"){const n=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=`${r}.json`,o.click(),URL.revokeObjectURL(i)}return a}async exportAsCSV(e,r){const a=[];a.push("Category,Metric,Value,Unit"),a.push(`Summary,Session ID,${e.summary.sessionId},`),a.push(`Summary,Total Duration,${e.summary.totalDuration},ms`),a.push(`Summary,Total Patients,${e.summary.totalPatients},count`),a.push(`Summary,Success Rate,${e.summary.successRate},percentage`),a.push(`Summary,Avg Time Per Patient,${e.summary.averageTimePerPatient},ms`);for(const[i,o]of e.timingAnalysis.operationBreakdown)a.push(`Timing,${i} Count,${o.count},count`),a.push(`Timing,${i} Avg Time,${o.averageTime},ms`),a.push(`Timing,${i} Success Rate,${o.successRate},percentage`);a.push(`Memory,Peak Usage,${e.memoryAnalysis.peakUsage},MB`),a.push(`Memory,Average Usage,${e.memoryAnalysis.averageUsage},MB`),a.push(`Memory,Growth Rate,${e.memoryAnalysis.growthRate},MB/min`);const n=a.join(`
`);if(typeof window<"u"){const i=new Blob([n],{type:"text/csv"}),o=URL.createObjectURL(i),l=document.createElement("a");l.href=o,l.download=`${r}.csv`,l.click(),URL.revokeObjectURL(o)}return n}startMemoryMonitoring(){this.config.enableMemoryTracking&&(this.memoryMonitorInterval=setInterval(()=>{this.takeMemorySnapshot()},this.config.sampleInterval))}stopMemoryMonitoring(){this.memoryMonitorInterval&&(clearInterval(this.memoryMonitorInterval),this.memoryMonitorInterval=void 0)}initializeMetrics(){return{sessionId:"",batchStartTime:0,patientActivationTimes:[],dataExtractionTimes:[],aiReviewTimes:[],contentScriptResponseTimes:[],totalProcessingTime:0,retryCount:new Map,errorFrequency:new Map,memoryUsageHistory:[],operationTimings:[]}}getDefaultConfig(){return{enableDetailedTiming:!0,enableMemoryTracking:!0,enablePerformanceMarks:!0,sampleInterval:5e3,retentionPeriod:36e5,exportFormat:"json",autoExport:!1}}log(...e){this.debugMode&&console.log("[MetricsCollector]",...e)}setDebugMode(e){this.debugMode=e}updateConfig(e){Object.assign(this.config,e),(e.sampleInterval!==void 0||e.enableMemoryTracking!==void 0)&&(this.stopMemoryMonitoring(),this.startMemoryMonitoring())}getConfig(){return{...this.config}}getMetrics(){return{...this.metrics}}clearMetrics(){this.metrics=this.initializeMetrics(),this.memorySnapshots=[],this.activeOperations.clear()}cleanup(){this.stopMemoryMonitoring(),this.clearMetrics()}}class Xv{batchPatientReviewAgent;dynamicWait;dataValidation;errorRecovery;cacheManager;checkpointManager;metricsCollector;isProcessing=!1;abortController=null;currentBatchId=null;config;currentProcessingContext=null;constructor(e={}){this.batchPatientReviewAgent=null,this.dynamicWait=Kl.getInstance(),this.dataValidation=Gl.getInstance(),this.errorRecovery=zl.getInstance(),this.cacheManager=aC.getInstance(),this.checkpointManager=Wl.getInstance(),this.metricsCollector=ql.getInstance(),this.config=this.getDefaultConfig(),this.updateConfig(e),this.log("üöÄ Enhanced Batch AI Review Orchestrator initialized")}async loadAgent(){if(!this.batchPatientReviewAgent){const{BatchPatientReviewAgent:e}=await ns(async()=>{const{BatchPatientReviewAgent:r}=await import("./chunks/BatchPatientReviewAgent.BLkmsmC_.js");return{BatchPatientReviewAgent:r}},__vite__mapDeps([20,5,6,4,2,1,21]));this.batchPatientReviewAgent=new e}}async processBatch(e,r){if(this.isProcessing)throw new Error("Batch processing already in progress");this.isProcessing=!0,this.abortController=new AbortController,this.currentBatchId=this.generateBatchId(e);const a=Date.now(),n=[],i=[];this.log(`üîÑ Starting enhanced batch AI review for ${e.selectedPatients.length} patients`);try{const o=await this.getCurrentTabId();this.log("üìÖ Ensuring we're on the appointment book page...");const l=await this.sendMessageWithTimeout(o,{type:"EXECUTE_ACTION",action:"navigate-to-appointment-book",data:{}},1e4);l?.success?this.log("‚úÖ Confirmed on appointment book page"):this.log(`‚ö†Ô∏è Warning: Could not ensure appointment book state: ${l?.error||"Unknown error"}`),await new Promise(c=>setTimeout(c,1e3))}catch(o){this.log("‚ö†Ô∏è Warning: Failed to navigate to appointment book:",o)}this.config.enableMetrics&&this.metricsCollector.startSession(this.currentBatchId),this.config.enableCaching&&await this.cacheManager.warmup(e.selectedPatients);try{const o=await this.checkForResumableCheckpoint(this.currentBatchId);let l=0;o&&await this.handleResumeOption(o,r)&&(n.push(...o.completedPatients),l=o.currentPatientIndex,this.log(`üìÇ Resuming from checkpoint at patient ${l}`));const c=e.selectedPatients.slice(l);if(this.config.parallelProcessing&&c.length>1){this.log(`üöÄ Using PARALLEL processing for ${c.length} patients (max ${this.config.maxConcurrentOperations} concurrent)`);const h=await this.processPatientsBatchParallel(c,l,r,a);n.push(...h.results),i.push(...h.errors)}else{this.log(`üîÑ Using SEQUENTIAL processing for ${c.length} patients`);for(let h=0;h<c.length;h++){const f=c[h],u=l+h;if(this.abortController?.signal.aborted)throw this.log("üõë Batch processing was cancelled by user"),new Error("Batch processing was cancelled");await this.validateAppointmentBookState(f,u);const x=this.createEnhancedProgress(u,e.selectedPatients.length,f,n,i,a);r?.(x);try{this.log(`üß≠ Processing patient ${u+1}/${e.selectedPatients.length}: ${f.name}`);const b=await this.processIndividualPatientEnhanced(f,u,(N,v)=>{x.phase=N,x.subPhase=v,r?.(x)});n.push(b),this.log(`‚úÖ Completed patient ${u+1}: ${f.name}`),this.config.enableCheckpoints&&(u+1)%this.config.checkpointInterval===0&&await this.saveProgressCheckpoint(e,n,u+1,i,a)}catch(b){const N=b instanceof Error?b.message:"Unknown error";this.log(`‚ùå Failed to process patient ${f.name}:`,N),this.config.enableMetrics&&this.metricsCollector.recordError("patient-processing",N,u),n.push({patient:f,reviewReport:null,extractedData:{background:"",investigations:"",medications:""},processingTime:0,success:!1,error:N}),i.push(`${f.name}: ${N}`);const v=i.length/(u+1);if(v>.5&&i.length>3)throw this.log(`üö® High error rate detected (${Math.round(v*100)}%), stopping batch`),new Error(`Batch stopped due to high error rate: ${Math.round(v*100)}%`)}}}const A=this.createEnhancedProgress(e.selectedPatients.length,e.selectedPatients.length,null,n,i,a);A.phase="completed",r?.(A);const d=await this.generateEnhancedBatchReport(e,n,a,Date.now());this.log(`üéâ Batch processing completed: ${n.filter(h=>h.success).length}/${e.selectedPatients.length} successful`);try{const h=Date.now()-a,f=n.filter(b=>b.success).length,u=e.selectedPatients.length,x=`${f}/${u} patients processed successfully`;await _y.showCompletionNotification("batch-ai-review",h,x),console.log(`üîî Batch completion notification sent: ${f}/${u} patients (${h}ms)`)}catch(h){console.warn("Failed to send batch completion notification:",h)}return d}catch(o){this.log("‚ùå Batch processing failed:",o);const l=this.createEnhancedProgress(0,e.selectedPatients.length,null,n,[...i,o instanceof Error?o.message:"Unknown error"],a);throw l.phase="error",r?.(l),o}finally{await this.finalizeProcessing()}}async resumeFromCheckpoint(e,r){this.log(`üîÑ Resuming batch processing from checkpoint: ${e}`);const{checkpoint:a,resumeStrategy:n,warnings:i}=await this.checkpointManager.resumeFromCheckpoint(e);for(const l of i)this.log(`‚ö†Ô∏è Resume warning: ${l}`);const o={selectedPatients:[],appointmentDate:new Date().toISOString(),calendarUrl:a.resumeData.environmentState?.currentUrl||""};return this.processBatch(o,r)}cancelProcessing(){this.abortController&&(this.abortController.abort(),this.log("üõë Batch processing cancelled by user"))}isCurrentlyProcessing(){return this.isProcessing}getProcessingStats(){return{isProcessing:this.isProcessing,currentBatchId:this.currentBatchId,performanceIndicators:this.config.enableMetrics?this.metricsCollector.getPerformanceIndicators():null,cacheStats:this.config.enableCaching?this.cacheManager.getStats():null,errorStats:this.errorRecovery.getFailureStats()}}async processPatientsBatchParallel(e,r,a,n){const i=[],o=[];this.log(`üöÄ Starting parallel batch processing for ${e.length} patients`),this.log(`üìä PHASE 1: Collecting data from all ${e.length} patients...`);const l=[];for(let d=0;d<e.length;d++){const h=e[d],f=r+d;if(this.abortController?.signal.aborted)throw new Error("Batch processing was cancelled");a?.({currentPatientIndex:f,totalPatients:e.length,currentPatient:h,phase:"extracting",subPhase:`collecting-data-${d+1}/${e.length}`,completedPatients:[],errors:[],percentComplete:d/e.length*50,estimatedTimeRemaining:0,currentOperationDetails:`Collecting data from ${h.name}`,performanceIndicators:{averageTimePerPatient:0,successRate:1,currentSpeed:"normal",errorRate:0,memoryUsage:0}});try{await this.validateAppointmentBookState(h,f);const u=await this.getCurrentTabId(),x=await this.extractPatientDataEnhanced(u,h);l.push({patient:h,extractedData:x,patientIndex:f,success:!0}),this.log(`‚úÖ Phase 1: Collected data for ${h.name} (${d+1}/${e.length})`)}catch(u){const x=u instanceof Error?u.message:"Unknown error";this.log(`‚ùå Phase 1: Failed to collect data for ${h.name}: ${x}`),l.push({patient:h,extractedData:{background:"",investigations:"",medications:"",extractionTimestamp:Date.now(),extractionAttempts:1,qualityScore:0},patientIndex:f,success:!1,error:x}),o.push(`${h.name}: ${x}`)}}this.log(`üìä PHASE 1 COMPLETE: Collected data from ${l.length} patients`),this.log(`ü§ñ PHASE 2: Processing AI reviews in parallel (max ${this.config.maxConcurrentOperations} concurrent)...`);const c=l.filter(d=>d.success),A=this.chunkArray(c,this.config.maxConcurrentOperations);for(const d of A){const h=d.map(async(u,x)=>{try{const b=50+i.length/e.length*50;a?.({currentPatientIndex:u.patientIndex,totalPatients:e.length,currentPatient:u.patient,phase:"reviewing",subPhase:"ai-processing-parallel",completedPatients:i,errors:[],percentComplete:b,estimatedTimeRemaining:0,currentOperationDetails:`AI review: ${u.patient.name} (parallel)`,performanceIndicators:{averageTimePerPatient:0,successRate:1,currentSpeed:"normal",errorRate:0,memoryUsage:0}}),this.log(`ü§ñ Processing AI review for ${u.patient.name} (parallel batch)`);const N=await this.performAIReviewWithCaching(u.extractedData,u.patient),v={patient:u.patient,reviewReport:N,extractedData:u.extractedData,processingTime:0,success:!0};return this.log(`‚úÖ Completed AI review for ${u.patient.name}`),v}catch(b){const N=b instanceof Error?b.message:"Unknown error";this.log(`‚ùå AI review failed for ${u.patient.name}: ${N}`);const v={patient:u.patient,reviewReport:null,extractedData:u.extractedData,processingTime:0,success:!1,error:N};return o.push(`${u.patient.name}: ${N}`),v}}),f=await Promise.allSettled(h);for(const u of f)u.status==="fulfilled"&&i.push(u.value);this.log(`‚úÖ Completed AI processing chunk: ${i.filter(u=>u.success).length}/${i.length} successful`)}for(const d of l.filter(h=>!h.success))i.push({patient:d.patient,reviewReport:null,extractedData:d.extractedData,processingTime:0,success:!1,error:d.error});return this.log(`üéâ PARALLEL PROCESSING COMPLETE: ${i.filter(d=>d.success).length}/${i.length} patients successful`),{results:i,errors:o}}chunkArray(e,r){const a=[];for(let n=0;n<e.length;n+=r)a.push(e.slice(n,n+r));return a}async processIndividualPatientEnhanced(e,r,a){const n=Date.now();this.currentProcessingContext={patient:e};const i={operation:"process-patient",patientIndex:r,patient:e,timestamp:n,environmentState:await this.getCurrentEnvironmentState(),previousAttempts:0};try{const o=`patient-${r}`;this.config.enableMetrics&&this.metricsCollector.startOperation(o,"patient-processing",r),a?.("navigating","activating-patient"),this.log(`üñ±Ô∏è Activating patient ${r}: ${e.name} (${e.fileNumber})`),await this.errorRecovery.executeWithRecovery(()=>this.activatePatientWithIntelligentWaiting(r),{...i,operation:"patient-activation"}),a?.("waiting-for-load","patient-data-loading");const l=await this.getCurrentTabId(),c=await this.dynamicWait.waitForPatientDataLoad(l,e.name);if(!c.success)throw new Error(`Patient data failed to load: ${c.error}`);a?.("extracting","clinical-data-extraction"),this.log(`üìã Extracting clinical data for: ${e.name}`);const A=await this.errorRecovery.executeWithRecovery(()=>this.extractPatientDataEnhanced(l,e),{...i,operation:"data-extraction"});a?.("reviewing","ai-medical-review"),A.dataCompleteness&&!A.dataCompleteness.hasRealData?this.log(`ü§ñ Running AI review for ${e.name} (incomplete data - ${A.dataCompleteness.emptyFieldCount}/${A.dataCompleteness.totalFields} fields empty)`):this.log(`ü§ñ Running AI review for: ${e.name}`);const d=await this.errorRecovery.executeWithRecovery(()=>this.performAIReviewWithCaching(A,e),{...i,operation:"ai-review"}),h=Date.now()-n;return this.config.enableMetrics&&this.metricsCollector.endOperation(o,"patient-processing",!0,r,{processingTime:h,dataQuality:A.qualityScore}),{patient:e,reviewReport:d,extractedData:A,processingTime:h,success:!0}}catch(o){const l=Date.now()-n;throw this.log(`‚ùå Failed to process patient ${e.name}:`,o),this.config.enableMetrics&&this.metricsCollector.endOperation(`patient-${r}`,"patient-processing",!1,r,{processingTime:l,error:o instanceof Error?o.message:String(o)}),o}finally{this.currentProcessingContext=null}}async activatePatientWithIntelligentWaiting(e){const r=await this.getCurrentTabId(),a=this.getCurrentProcessingContext();if(!a?.patient)throw new Error("No patient context available for activation");const n=a.patient;try{this.log(`üëÜ SPA Workflow: Starting patient processing for ${n.name} (${n.fileNumber})`),this.log(`üëÜ Step 1: Double-clicking patient ${n.name}`);const i=await this.sendMessageWithTimeout(r,{type:"EXECUTE_ACTION",action:"double-click-patient",data:{patientName:n.name,patientId:n.fileNumber}},1e4);if(!i?.success)throw new Error(`Double-click patient failed: ${i?.error||"Unknown error"}`);this.log("üè• Step 2: Navigating to Patient Record view");const o=await this.sendMessageWithTimeout(r,{type:"EXECUTE_ACTION",action:"navigate-to-patient-record",data:{}},15e3);if(!o?.success)throw new Error(`Navigate to patient record failed: ${o?.error||"Unknown error"}`);await this.waitForPatientDataReady(r,n.name),this.log(`‚úÖ SPA Workflow: Patient ${n.name} activated and Patient Record view ready`)}catch(i){throw this.log("‚ùå SPA Workflow activation failed:",i),new Error(`SPA patient activation failed: ${i instanceof Error?i.message:"Unknown error"}`)}}getCurrentProcessingContext(){return this.currentProcessingContext||null}async waitForPatientDataReady(e,r){this.log(`‚è≥ Waiting for patient data to load for: ${r}`);for(let i=0;i<30;i++)try{const o=await this.sendMessageWithTimeout(e,{type:"CHECK_XESTRO_BOXES"},3e3);if(o?.found&&o.count>0){this.log(`‚úÖ Patient data ready after ${(i+1)*500}ms (${o.count} XestroBoxes found)`),await this.sleep(1e3);return}i%5===0&&this.log(`‚è≥ Still waiting for patient data... (attempt ${i+1}/30, ${o?.count||0} XestroBoxes)`),await this.sleep(500)}catch(o){if(this.log(`‚ùå Error checking patient data readiness (attempt ${i+1}):`,o),o instanceof Error&&o.message.includes("message channel")?(this.log("üîß Message channel error detected, waiting longer before retry..."),await this.sleep(500*2)):await this.sleep(500),i===29)throw new Error(`Patient data failed to load after ${30*500}ms: ${o instanceof Error?o.message:"Unknown error"}`)}throw new Error(`Patient data did not load within ${30*500}ms for patient: ${r}`)}async sleep(e){return new Promise(r=>setTimeout(r,e))}async sendMessageWithTimeout(e,r,a=5e3){return new Promise((n,i)=>{const o=setTimeout(()=>{i(new Error(`Message timeout after ${a}ms`))},a);try{chrome.tabs.sendMessage(e,r,l=>{if(clearTimeout(o),chrome.runtime.lastError){i(new Error(`Message failed: ${chrome.runtime.lastError.message}`));return}n(l)})}catch(l){clearTimeout(o),i(l)}})}async extractPatientDataEnhanced(e,r){if(this.config.enableCaching){const a={patientId:r.fileNumber,dataType:"extracted_data"},n=await this.cacheManager.get(a);if(n.hit&&n.data)return this.log(`üíæ Using cached data for patient: ${r.name}`),await this.navigateBackToAppointmentBook(e),n.data}try{this.log(`üìã Step 3: Extracting patient fields for ${r.name}`);const a=await this.sendMessageWithTimeout(e,{type:"EXECUTE_ACTION",action:"extract-patient-fields",data:{}},3e4);if(!a?.success||!a?.data)throw new Error(`Patient fields extraction failed: ${a?.error||"No data returned"}`);const n=a.data,i=n.hasAnyData;this.log(`üìä Data completeness check for ${r.name}:`,{hasAnyData:i,backgroundLength:n.background?.length||0,investigationsLength:n.investigations?.length||0,medicationsLength:n.medications?.length||0});const o=n.background?.trim()?n.background:"No data available in Background section",l=n.investigations?.trim()?n.investigations:"No data available in Investigations section",c=n.medications?.trim()?n.medications:"No data available in Medications section";this.log(`üìù Processed field data for ${r.name}:`,{backgroundMarked:!n.background?.trim(),investigationsMarked:!n.investigations?.trim(),medicationsMarked:!n.medications?.trim(),hasAnyRealData:i});const A={background:o,investigations:l,medications:c,extractionTimestamp:n.extractionTimestamp||Date.now(),extractionAttempts:1,qualityScore:this.calculateDataQuality(n),dataCompleteness:{hasRealData:i,emptyFieldCount:[!n.background?.trim(),!n.investigations?.trim(),!n.medications?.trim()].filter(Boolean).length,totalFields:3}};if(await this.navigateBackToAppointmentBook(e),this.config.enableCaching){const d={patientId:r.fileNumber,dataType:"extracted_data"},h=this.dataValidation.assessDataQuality(A);await this.cacheManager.set(d,A,h)}return this.log(`‚úÖ SPA Workflow: Patient ${r.name} data extraction completed and returned to appointment book`),A}catch(a){this.log("‚ùå SPA Workflow extraction failed:",a);try{await this.navigateBackToAppointmentBook(e)}catch(n){this.log("‚ùå Failed to navigate back to appointment book:",n)}throw new Error(`SPA data extraction failed: ${a instanceof Error?a.message:"Unknown error"}`)}}async navigateBackToAppointmentBook(e){this.log("üìÖ Step 4: Navigating back to Appointment Book");const r=await this.sendMessageWithTimeout(e,{type:"EXECUTE_ACTION",action:"navigate-to-appointment-book",data:{}},15e3);if(!r?.success)throw new Error(`Navigate to appointment book failed: ${r?.error||"Unknown error"}`)}calculateDataQuality(e){let r=0,a=0;return["background","investigations","medications"].forEach(i=>{a++;const o=e[i]||"";o.trim().length>0&&(r+=1,o.trim().length>50&&(r+=.5))}),Math.min(r/(a*1.5),1)}async performAIReviewWithCaching(e,r){if(this.config.enableCaching){const i={patientId:r.fileNumber,dataType:"ai_review"},o=await this.cacheManager.get(i);if(o.hit&&o.data&&!await this.cacheManager.hasChanged({patientId:r.fileNumber,dataType:"extracted_data"},e))return this.log(`üíæ Using cached AI review for patient: ${r.name}`),o.data}const a=this.formatReviewInput(e,r);await this.loadAgent();const n=await this.batchPatientReviewAgent.process(a);if(this.config.enableCaching){const i={patientId:r.fileNumber,dataType:"ai_review"};await this.cacheManager.set(i,n)}return n}createEnhancedProgress(e,r,a,n,i,o){const c=Date.now()-o,A=n.filter(b=>b.success).length,d=e>0?c/e:0,f=(r-e)*d,u=r>0?e/r*100:0,x=this.config.enableMetrics?this.metricsCollector.getPerformanceIndicators():{averageTimePerPatient:d,successRate:e>0?A/e:1,currentSpeed:"normal",errorRate:e>0?i.length/e:0,memoryUsage:0};return{currentPatientIndex:e,totalPatients:r,currentPatient:a,phase:"navigating",completedPatients:n,errors:i,percentComplete:u,estimatedTimeRemaining:f,currentOperationDetails:a?`Processing ${a.name} (${a.fileNumber})`:"Initializing...",performanceIndicators:x}}async generateEnhancedBatchReport(e,r,a,n){const i=r.filter(u=>u.success),o=r.filter(u=>!u.success);let l=null;this.config.enableMetrics&&(l=this.metricsCollector.endSession());let c=0,A=0,d=0;const h=[];return i.forEach(u=>{if(u.reviewReport?.reviewData){const x=u.reviewReport.reviewData;c+=x.findings?.length||0,A+=x.findings?.filter(b=>b.urgency==="Immediate").length||0,d+=x.medicationSafetyIssues||0,x.findings?.forEach(b=>{b.finding&&!h.includes(b.finding)&&h.push(b.finding)})}}),{id:`batch-${Date.now()}`,agentName:"Enhanced Batch AI Review Orchestrator v3.0",content:`Enhanced batch AI medical review completed for ${e.selectedPatients.length} patients on ${e.appointmentDate}`,sections:[],metadata:{confidence:i.length/e.selectedPatients.length,processingTime:n-a,modelUsed:"BatchPatientReviewAgent",enhancedFeatures:{intelligentWaiting:!0,dataValidation:!0,errorRecovery:!0,caching:this.config.enableCaching,checkpointing:this.config.enableCheckpoints,metrics:this.config.enableMetrics}},timestamp:n,warnings:o.map(u=>`Failed to process ${u.patient.name}: ${u.error}`),errors:o.map(u=>u.error||"Unknown error"),batchData:{appointmentDate:e.appointmentDate,totalPatients:e.selectedPatients.length,successfulReviews:i.length,failedReviews:o.length,processingStartTime:a,processingEndTime:n,patientResults:r,summary:{totalFindings:c,immediateFindings:A,medicationSafetyIssues:d,commonFindings:h.slice(0,10)},enhancedMetrics:l}}}async checkForResumableCheckpoint(e){if(!this.config.enableCheckpoints)return null;try{const r=await this.checkpointManager.listCheckpoints(e);if(r.length>0){const a=r[0];return this.log(`üìÇ Found resumable checkpoint: ${a.id}`),await this.checkpointManager.loadCheckpoint(a.id)}}catch(r){this.log("‚ùå Error checking for resumable checkpoint:",r)}return null}async handleResumeOption(e,r){return this.log(`üîÑ Auto-resuming from checkpoint with ${e.completedPatients.length} completed patients`),!0}async saveProgressCheckpoint(e,r,a,n,i){if(!(!this.config.enableCheckpoints||!this.currentBatchId))try{const o=await this.getCurrentEnvironmentState(),l=this.config.enableMetrics?this.metricsCollector.getMetrics():this.createEmptyMetrics(),c=await this.checkpointManager.saveCheckpoint(this.currentBatchId,e,r,a,[],this.getBatchConfiguration(),l,o);this.log(`üíæ Saved checkpoint: ${c} (${r.length} patients completed)`)}catch(o){this.log("‚ùå Failed to save checkpoint:",o)}}async getCurrentTabId(){const e=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e[0]?.id)throw new Error("No active tab found");return e[0].id}async getCurrentEnvironmentState(){const e=await chrome.tabs.query({active:!0,currentWindow:!0});return{tabId:e[0]?.id||0,currentUrl:e[0]?.url||"",contentScriptVersion:"2.6.0",lastHealthCheck:Date.now()}}formatReviewInput(e,r){let a="";if(e.dataCompleteness){const{hasRealData:n,emptyFieldCount:i,totalFields:o}=e.dataCompleteness;n?i>0&&(a=`

DATA COMPLETENESS NOTE: ${i}/${o} clinical sections are incomplete. Consider if missing information is clinically significant.`):a=`

DATA COMPLETENESS ALERT: This patient record has ${i}/${o} empty clinical sections. Please assess if missing data represents a clinical oversight or if additional data collection is needed.`}return`Patient: ${r.name} (DOB: ${r.dob}, File: ${r.fileNumber})

Background: ${e.background}

Investigations: ${e.investigations}

Medications: ${e.medications}${a}`}generateBatchId(e){return`batch-${e.appointmentDate}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getBatchConfiguration(){return{maxRetries:this.config.retryAttempts,timeoutMs:this.config.timeoutMs,parallelProcessing:this.config.parallelProcessing,cacheEnabled:this.config.enableCaching,diagnosticsEnabled:this.config.enableAdvancedDiagnostics,checkpointInterval:this.config.checkpointInterval,errorRecoveryStrategy:"conservative"}}createEmptyMetrics(){return{sessionId:this.currentBatchId||"",batchStartTime:Date.now(),patientActivationTimes:[],dataExtractionTimes:[],aiReviewTimes:[],contentScriptResponseTimes:[],totalProcessingTime:0,retryCount:new Map,errorFrequency:new Map,memoryUsageHistory:[],operationTimings:[]}}async finalizeProcessing(){this.isProcessing=!1,this.abortController=null,this.currentBatchId=null,this.config.enableCaching&&await this.cacheManager.applyInvalidationRules(),this.log("üèÅ Batch processing finalized")}getDefaultConfig(){return{enableCheckpoints:!0,checkpointInterval:5,enableCaching:!0,enableMetrics:!0,enableAdvancedDiagnostics:!1,parallelProcessing:!0,maxConcurrentOperations:3,timeoutMs:3e5,retryAttempts:3}}updateConfig(e){Object.assign(this.config,e),this.dynamicWait.setDebugMode(e.enableAdvancedDiagnostics||!1),this.dataValidation.setDebugMode(e.enableAdvancedDiagnostics||!1),this.errorRecovery.setDebugMode(e.enableAdvancedDiagnostics||!1),this.cacheManager.setDebugMode(e.enableAdvancedDiagnostics||!1),this.checkpointManager.setDebugMode(e.enableAdvancedDiagnostics||!1),this.metricsCollector.setDebugMode(e.enableAdvancedDiagnostics||!1)}getConfig(){return{...this.config}}async validateAppointmentBookState(e,r){const a=await this.getCurrentTabId();this.log(`üîç Validating appointment book state for patient ${r}: ${e.name}`);try{const n=await this.sendMessageWithTimeout(a,{type:"EXECUTE_ACTION",action:"extract-calendar-patients",data:{}},1e4);if(!n?.success||!n?.data?.patients){this.log("‚ö†Ô∏è WARNING: Could not validate current patient list");return}const i=n.data.patients;if(this.log(`üîç Current appointment book has ${i.length} patients`),this.log("üîç Current patient list:",i.map((o,l)=>({index:l,name:o.name,fileNumber:o.fileNumber,dob:o.dob}))),r<i.length){const o=i[r];if(this.log(`üîç Expected patient at index ${r}:`,{name:e.name,fileNumber:e.fileNumber,dob:e.dob}),this.log(`üîç Actual patient at index ${r}:`,{name:o.name,fileNumber:o.fileNumber,dob:o.dob}),o.fileNumber!==e.fileNumber)throw this.log("üö® CRITICAL ERROR: Patient mismatch detected!"),this.log(`üö® Expected: ${e.name} (${e.fileNumber})`),this.log(`üö® Found: ${o.name} (${o.fileNumber})`),new Error(`Patient list state corrupted. Expected ${e.name} but found ${o.name} at index ${r}`);this.log(`‚úÖ Patient validation successful: ${e.name} is at correct position ${r}`)}else throw this.log(`üö® CRITICAL ERROR: Patient index ${r} is out of bounds (current list has ${i.length} patients)`),new Error(`Patient index ${r} is out of bounds for current appointment book`)}catch(n){throw this.log("‚ùå Patient validation failed:",n),new Error(`Patient validation failed: ${n instanceof Error?n.message:"Unknown error"}`)}}log(...e){console.log("[Enhanced BatchAIReviewOrchestrator]",...e)}async getAvailableCheckpoints(){return this.checkpointManager.listCheckpoints()}async deleteCheckpoint(e){return this.checkpointManager.deleteCheckpoint(e)}async exportMetrics(){if(!this.config.enableMetrics)throw new Error("Metrics collection is disabled");const e=this.metricsCollector.generateReport();return this.metricsCollector.exportMetrics(e)}async clearCaches(){return this.cacheManager.clear()}getDetailedStats(){return{processing:this.getProcessingStats(),cache:this.config.enableCaching?this.cacheManager.getCacheInfo():null,errors:this.errorRecovery.getFailureStats(),metrics:this.config.enableMetrics?this.metricsCollector.getMetrics():null}}}const b3=Object.freeze(Object.defineProperty({__proto__:null,BatchAIReviewOrchestrator:Xv},Symbol.toStringTag,{value:"Module"})),v3={background:"background","investigation-summary":"investigation-summary",medication:"medications",bloods:null,imaging:null,tavi:null,"angiogram-pci":null,mteer:null,tteer:null,"pfo-closure":null,"asd-closure":null,"pvl-plug":null,"bypass-graft":null,"right-heart-cath":null,"tavi-workup":null,"pre-op-plan":null,"quick-letter":null,consultation:null,"ai-medical-review":null,"batch-ai-review":null,"aus-medical-review":null,"patient-education":null,"ohif-viewer":null,enhancement:null,transcription:null,generation:null},w3={background:"Background","investigation-summary":"Investigation Summary",medications:"Medications (Problem List for Phil)","social-history":"Social & Family History"};function Zv(s){return s&&v3[s]||null}function eh(s){return w3[s]||s}function M0(s){return s!==null&&Zv(s)!==null}class Jl{static instance;config={minSimilarityScore:.8,caseSensitive:!1,ignoreTitles:!0,allowPartialMatches:!0,enabled:!0};constructor(){bt.debug("PatientNameValidator initialized")}static getInstance(){return Jl.instance||(Jl.instance=new Jl),Jl.instance}updateConfig(e){this.config={...this.config,...e},bt.debug("PatientNameValidator config updated:",this.config)}validatePatientNames(e,r){const a=[];if(!this.config.enabled)return{sessionPatientName:e,emrPatientName:r,similarityScore:1,isMatch:!0,confidence:"high",normalizedSessionName:e,normalizedEmrName:r,warnings:["Validation disabled"]};if(!e||!r)return a.push("Missing patient name data"),{sessionPatientName:e||"Unknown",emrPatientName:r||"Unknown",similarityScore:0,isMatch:!1,confidence:"low",normalizedSessionName:"",normalizedEmrName:"",warnings:a};(this.isFallbackPatientName(e)||this.isFallbackPatientName(r))&&a.push("Fallback patient name detected - validation may be unreliable");const n=this.normalizeName(e),i=this.normalizeName(r),o=this.calculateSimilarity(n,i),l=o>=this.config.minSimilarityScore;let c;o>=.95?c="high":o>=.75?c="medium":c="low",l||(o>.5?a.push("Names are similar but not identical - possible transcription variation"):a.push("Names appear to be completely different"));const A={sessionPatientName:e,emrPatientName:r,similarityScore:o,isMatch:l,confidence:c,normalizedSessionName:n,normalizedEmrName:i,warnings:a};return bt.debug("Patient name validation result:",A),A}normalizeName(e){if(!e)return"";let r=e.trim();return this.config.ignoreTitles&&(r=r.replace(/^(Mr\.?|Mrs\.?|Ms\.?|Dr\.?|Miss)\s+/i,"")),r=r.replace(/\s*\(\d+\)$/,""),r=r.replace(/\s*\(Session-\d+\)$/,""),r=r.replace(/\s+/g," ").trim(),this.config.caseSensitive||(r=r.toLowerCase()),r}calculateSimilarity(e,r){if(!e||!r)return 0;if(e===r)return 1;if(this.config.allowPartialMatches){const i=e.length>r.length?e:r,o=e.length>r.length?r:e;if(i.includes(o)&&o.length>=3)return .85}const a=this.levenshteinDistance(e,r),n=Math.max(e.length,r.length);return n===0?1:1-a/n}levenshteinDistance(e,r){const a=[];for(let n=0;n<=r.length;n++)a[n]=[n];for(let n=0;n<=e.length;n++)a[0][n]=n;for(let n=1;n<=r.length;n++)for(let i=1;i<=e.length;i++)r.charAt(n-1)===e.charAt(i-1)?a[n][i]=a[n-1][i-1]:a[n][i]=Math.min(a[n-1][i-1]+1,a[n][i-1]+1,a[n-1][i]+1);return a[r.length][e.length]}isFallbackPatientName(e){return e?[/^Patient \d+/i,/^Patient \d+ \(\d{1,2}:\d{2}\)$/i,/^Session-\d+$/i,/^Unknown$/i,/^Patient$/i].some(a=>a.test(e.trim())):!0}getValidationExplanation(e){return this.config.enabled?e.isMatch?`Patient names match with ${Math.round(e.similarityScore*100)}% confidence.`:e.similarityScore>.5?`Patient names are similar (${Math.round(e.similarityScore*100)}% match) but may represent different patients or transcription variations.`:`Patient names appear to be different (${Math.round(e.similarityScore*100)}% match). You may be inserting into the wrong patient file.`:"Patient name validation is disabled."}shouldSkipValidation(e,r){if(!this.config.enabled)return!0;if(this.isFallbackPatientName(e)&&this.isFallbackPatientName(r))return bt.debug("Skipping validation - both names are fallback names"),!0;const a=3;return e.trim().length<a||r.trim().length<a?(bt.debug("Skipping validation - names too short to validate"),!0):!1}}const Fu=Jl.getInstance();function Hp(s){const{onRecordingComplete:e,onVoiceActivityUpdate:r,onRecordingTimeUpdate:a,onError:n,selectedMicrophoneId:i,getMicrophoneId:o}=s,[l,c]=m.useState({isRecording:!1,isPaused:!1,recordingTime:0,voiceActivityLevel:0,frequencyData:[],hasPermission:null,isRequestingPermission:!1,activeDeviceInfo:null,audioLevelHistory:[]}),A=m.useRef(null),d=m.useRef(null),h=m.useRef(null),f=m.useRef(null),u=m.useRef([]),x=m.useRef(),b=m.useRef(),N=m.useRef(!1),v=m.useCallback(async()=>{try{const D=h.current,k=d.current;if(!D){console.log("üîá detectVoiceActivity: analyser is null");return}if(!N.current){console.log("üîá detectVoiceActivity: not recording (ref check)");return}if(!k){console.log("üîá detectVoiceActivity: audio context is null");return}if(k.state!=="running")if(console.log("üîá detectVoiceActivity: audio context state is",k.state),k.state==="suspended"){console.log("üé§ Attempting to resume suspended audio context...");try{await k.resume(),console.log("‚úÖ Audio context resumed successfully")}catch(ee){console.error("‚ùå Failed to resume audio context:",ee);return}}else return;const R=D.frequencyBinCount,w=new Uint8Array(R);D.getByteFrequencyData(w),!(Math.max(...w)>0)&&Math.random()<.05&&console.warn("‚ö†Ô∏è No audio data detected in frequency analysis:",{contextState:k.state,analyserFftSize:D.fftSize,bufferLength:R,isRecording:N.current});const P=w.reduce((ee,V)=>ee+V,0)/R,K=Math.min(P/128,1),$=64,O=[],W=Math.floor(R/$);for(let ee=0;ee<$;ee++){let V=0;const q=ee*W,S=Math.min(q+W,R);for(let Y=q;Y<S;Y++)V+=w[Y];const H=Math.min(V/(S-q)/128,1);O.push(Math.pow(H,.7))}c(ee=>{const V=[...ee.audioLevelHistory,K].slice(-30),S=(V.length>10?V.slice(-10).reduce((H,Y)=>H+Y,0)/10:0)>.01||K>.05;return K>.1&&Math.random()<.001&&console.log("üé§ Audio Debug:",{level:Math.round(K*100)+"%",frequencyBars:O.length,avgFreq:Math.round(O.reduce((H,Y)=>H+Y,0)/O.length*100)+"%",maxFreq:Math.round(Math.max(...O)*100)+"%"}),{...ee,voiceActivityLevel:K,frequencyData:O,audioLevelHistory:V,activeDeviceInfo:ee.activeDeviceInfo?{...ee.activeDeviceInfo,isWorking:S}:null}}),r?.(K,O),N.current&&(x.current=requestAnimationFrame(()=>v()))}catch(D){console.error("üîá detectVoiceActivity error:",D),N.current&&(x.current=requestAnimationFrame(()=>v()))}},[r]),j=m.useCallback(()=>{c(D=>({...D,recordingTime:0})),b.current=setInterval(()=>{c(D=>{const k=D.recordingTime+1;return a?.(k),{...D,recordingTime:k}})},1e3)},[a]),I=m.useCallback(()=>{b.current&&(clearInterval(b.current),b.current=void 0)},[]),C=m.useCallback(async()=>{try{const D=await navigator.permissions.query({name:"microphone"});c(k=>({...k,hasPermission:D.state==="granted"})),D.addEventListener("change",()=>{c(k=>({...k,hasPermission:D.state==="granted"}))})}catch{c(k=>({...k,hasPermission:null}))}},[]),E=m.useCallback(()=>{N.current=!1,I(),x.current&&(cancelAnimationFrame(x.current),x.current=void 0),A.current&&A.current.state==="recording"&&A.current.stop(),f.current&&(f.current.getTracks().forEach(D=>D.stop()),f.current=null),d.current&&(d.current.close(),d.current=null),c(D=>({...D,isRecording:!1,voiceActivityLevel:0,frequencyData:[],activeDeviceInfo:null,audioLevelHistory:[]}))},[I]),T=m.useCallback(async()=>{console.log("üé§ useRecorder.startRecording() called"),c(D=>({...D,isRequestingPermission:!0}));try{const D=o?.()||i,R=await(async V=>{if(!V)return!1;try{const S=(await navigator.mediaDevices.enumerateDevices()).find(H=>H.deviceId===V);return S?.label?.toLowerCase().includes("airpods")||S?.label?.toLowerCase().includes("bluetooth")||!1}catch{return!1}})(D||null);R&&D&&(console.log("üéß Bluetooth device detected, adding initialization delay..."),await new Promise(V=>setTimeout(V,200)));const w={audio:D?{deviceId:{exact:D},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}};console.log("üé§ Requesting media stream with constraints:",{deviceId:D,exact:!0,isBluetooth:R});const L=await navigator.mediaDevices.getUserMedia(w);f.current=L;const M=L.getAudioTracks();if(M.length===0)throw new Error("No audio tracks available in the media stream");const P=M[0];if(P.readyState!=="live"&&console.warn("‚ö†Ô∏è Audio track is not live:",P.readyState),P.enabled||(P.enabled=!0),P.muted&&(console.warn("‚ö†Ô∏è Microphone appears muted, attempting recovery..."),P.enabled=!1,await new Promise(V=>setTimeout(V,100)),P.enabled=!0,await new Promise(V=>setTimeout(V,100)),P.muted))throw console.error("‚ùå Microphone is muted. Please check System Settings ‚Üí Sound ‚Üí Input"),new Error("Microphone is muted at system level. Please restart your computer or check Sound settings.");let K=null;if(M.length>0){const V=M[0],q=V.getSettings();if(K={label:V.label||"Unknown Microphone",deviceId:q.deviceId||"unknown",isWorking:!1,hasMismatch:!1},D&&q.deviceId!==D){console.error("‚ùå DEVICE MISMATCH DETECTED",{requested:D,received:q.deviceId,receivedLabel:V.label}),L.getTracks().forEach(G=>G.stop());const S=await navigator.mediaDevices.enumerateDevices(),H=S.find(G=>G.deviceId===D),Y=S.find(G=>G.deviceId===q.deviceId),te=`Failed to access selected microphone "${H?.label||"unknown"}". System used "${Y?.label||V.label||"unknown"}" instead. 

Possible fixes:
‚Ä¢ Ensure AirPods are connected and selected as input device in macOS Sound settings
‚Ä¢ Try disconnecting and reconnecting your AirPods
‚Ä¢ Restart Chrome to refresh device permissions
‚Ä¢ Check System Settings ‚Üí Privacy & Security ‚Üí Microphone`;throw new Error(te)}console.log("‚úÖ Device validation passed:",{requested:D,received:q.deviceId,label:V.label,match:!0})}N.current=!0,c(V=>({...V,hasPermission:!0,isRequestingPermission:!1,isRecording:!0,voiceActivityLevel:0,frequencyData:[],activeDeviceInfo:K,audioLevelHistory:[]}));const $=new AudioContext;$.state==="suspended"&&(console.log("üé§ Resuming suspended audio context..."),await $.resume());const O=$.createMediaStreamSource(L),W=$.createAnalyser();if(W.fftSize=512,W.smoothingTimeConstant=.7,W.minDecibels=-90,W.maxDecibels=-10,O.connect(W),$.state!=="running")throw console.error("‚ùå AudioContext failed to start:",$.state),new Error(`AudioContext is in ${$.state} state, expected "running"`);d.current=$,h.current=W;const ee=new MediaRecorder(L,{mimeType:"audio/webm;codecs=opus"});u.current=[],ee.ondataavailable=V=>{V.data.size>0&&u.current.push(V.data)},ee.onerror=V=>{console.error("‚ùå MediaRecorder error:",V)},ee.onstop=()=>{const V=new Blob(u.current,{type:"audio/webm;codecs=opus"});V.size===0&&console.error("‚ùå No audio data captured"),e(V),E()},ee.start(100),A.current=ee,j(),setTimeout(async()=>{await v()},100)}catch(D){console.error("üé§ Recording start failed:",D),N.current=!1,c(k=>({...k,hasPermission:!1,isRequestingPermission:!1})),n?.(D)}},[i,e,n,v,j,l.recordingTime,E,o]),Q=m.useCallback(()=>{console.log("üõë useRecorder.stopRecording() called"),N.current=!1,A.current&&A.current.state==="recording"&&A.current.stop(),c(D=>({...D,isRecording:!1})),I(),x.current&&(cancelAnimationFrame(x.current),x.current=void 0)},[I]);return bs.useEffect(()=>(C(),E),[C,E]),{...l,startRecording:T,stopRecording:Q,cleanup:E}}function C3({enabled:s=!0,defaultMode:e="dictate",onActionTriggered:r}={}){const a=m.useCallback(n=>{if(!s)return;const i=n.target;if(i.tagName==="INPUT"||i.tagName==="TEXTAREA"||i.isContentEditable||i.closest('[role="combobox"]')||i.closest("[data-command-bar]")||!n.shiftKey||n.ctrlKey||n.altKey||n.metaKey||n.key.length!==1||!/[a-zA-Z]/.test(n.key))return;const l=n.key.toUpperCase(),c=U4(l);if(c&&!c.comingSoon){n.preventDefault(),n.stopPropagation();const A=c.modes.includes(e)?e:c.modes[0];ca().execute(c.id,A,{origin:"keyboard"}).then(h=>{h.success&&r?.(c.id,l)})}},[s,e,r]);m.useEffect(()=>{if(s)return document.addEventListener("keydown",a,{capture:!0}),()=>{document.removeEventListener("keydown",a,{capture:!0})}},[a,s])}function N3(s={}){const{maxVersions:e=10}=s,[r,a]=m.useState("idle"),[n,i]=m.useState(null),[o,l]=m.useState(!1),[c,A]=m.useState(null),[d,h]=m.useState({currentIndex:-1,versions:[],maxVersions:e}),[f,u]=m.useState(""),x=m.useRef({}),b=m.useRef(""),N=m.useCallback((P,K,$)=>({id:`v-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,content:P,timestamp:Date.now(),changeDescription:K,integratedSuggestionIds:$}),[]),v=m.useCallback(P=>{h(K=>{const $=K.versions.slice(0,K.currentIndex+1);$.push(P);const O=$.slice(-e);return{...K,versions:O,currentIndex:O.length-1}})},[e]),j=m.useCallback(async(P,K,$,O)=>{x.current=K,b.current=$,u(P);const W=N(P,"Initial letter");v(W),a("processing"),i(null),A(null),bt.info("useNextStepEngine: Starting inference",{component:"next-step-hook",operation:"run-inference",sessionId:$,letterLength:P.length});try{const V=await Kg().inferNextSteps({letterText:P,patientContext:K,sessionId:$,sourceAgentType:O});return i(V),a(V.status),bt.info("useNextStepEngine: Inference complete",{component:"next-step-hook",operation:"inference-complete",sessionId:$,suggestionCount:V.suggestions.length,processingTime:V.processingTime}),V}catch(ee){const V=ee instanceof Error?ee.message:String(ee),q={suggestions:[],status:"error",processingTime:0,error:V,timestamp:Date.now()};return i(q),a("error"),bt.error("useNextStepEngine: Inference failed",ee,{component:"next-step-hook",operation:"inference-error",sessionId:$}),q}},[N,v]),I=m.useCallback(async P=>{if(P.length===0)return null;l(!0),A(null),bt.info("useNextStepEngine: Starting integration",{component:"next-step-hook",operation:"integrate",sessionId:b.current,suggestionCount:P.length});try{const $=await Kg().integrateIntoLetter({currentLetter:f,suggestions:P,sessionId:b.current,patientContext:x.current});if(!$.success)throw new Error($.error||"Integration failed");const O=N($.rewrittenLetter,`Integrated ${P.length} suggestion(s): ${P.map(W=>W.title).join(", ")}`,$.integratedSuggestionIds);return v(O),u($.rewrittenLetter),bt.info("useNextStepEngine: Integration complete",{component:"next-step-hook",operation:"integrate-complete",sessionId:b.current,processingTime:$.processingTime}),l(!1),$.rewrittenLetter}catch(K){const $=K instanceof Error?K.message:String(K);return A($),l(!1),bt.error("useNextStepEngine: Integration failed",K,{component:"next-step-hook",operation:"integrate-error",sessionId:b.current}),null}},[f,N,v]),C=m.useCallback(()=>{if(d.currentIndex<=0)return null;const P=d.currentIndex-1,K=d.versions[P];return K?(h($=>({...$,currentIndex:P})),u(K.content),bt.info("useNextStepEngine: Undo performed",{component:"next-step-hook",operation:"undo",sessionId:b.current,restoredVersionId:K.id}),K.content):null},[d]),E=m.useCallback(()=>{a("idle"),i(null),l(!1),A(null),u(""),h({currentIndex:-1,versions:[],maxVersions:e}),x.current={},b.current="",bt.info("useNextStepEngine: Reset",{component:"next-step-hook",operation:"reset"})},[e]),T=m.useCallback((P,K,$,O)=>{if(x.current=K,b.current=$,u(P),l(!1),A(null),P&&P.trim().length>0){const W=N(P,"Initial letter");h({currentIndex:0,versions:[W],maxVersions:e})}else h({currentIndex:-1,versions:[],maxVersions:e});O?(i(O),a(O.status)):(i(null),a("idle")),bt.info("useNextStepEngine: Hydrated from session",{component:"next-step-hook",operation:"hydrate",sessionId:$,hasStoredResult:!!O})},[N,e]),Q=m.useCallback((P,K)=>{if(P!==f&&P.trim().length>0&&(u(P),K==="manual-edit")){const $=N(P,"Manual edit");v($)}},[f,N,v]),D=m.useCallback(()=>{A(null)},[]),k=d.currentIndex>0,R=d.currentIndex<d.versions.length-1,w=d.versions.length,L=m.useMemo(()=>({status:r,result:n,isIntegrating:o,integrationError:c,currentLetter:f,canUndo:k,canRedo:R,versionCount:w}),[r,n,o,c,f,k,R,w]),M=m.useMemo(()=>({runInference:j,integrateSelected:I,undo:C,reset:E,hydrateFromSession:T,setCurrentLetter:Q,clearIntegrationError:D}),[j,I,C,E,T,Q,D]);return[L,M]}const Vp=gt.getInstance(),vi=(s,e,r=3e3)=>Vp.success(s,e,r),Oc=(s,e,r=4e3)=>Vp.error(s,e,r),B3=(s,e,r=3e3)=>Vp.info(s,e,r);function _0(s){return s.trim().replace(/[-‚Äì‚Äî]+\s*$/,"").trim()}function S3(s){return s.replace(/^Patient\s+[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*\s+/i,"").replace(/^[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*\s+(?:had|has|presented|underwent|received)\s+/i,"").replace(/\s+/g," ").replace(/\.\s*\./g,".").replace(/;\s*;/g,";").replace(/,\s*,/g,",").trim()}function j3(s){const e=[];return s.toLowerCase(),[/(?:ejection fraction|ef)\s+(?:of\s+)?(\d+%?)/gi,/(?:blood pressure|bp)\s+(?:of\s+)?(\d+\/\d+)/gi,/(?:heart rate|hr)\s+(?:of\s+)?(\d+)/gi,/(?:chest pain|dyspnoea|palpitations|dizziness|syncope)/gi,/(?:atrial fibrillation|af|coronary artery disease|cad|heart failure|hypertension)/gi,/(?:aspirin|metoprolol|ramipril|atorvastatin|warfarin|apixaban)/gi].forEach(a=>{const n=s.match(a);n&&n.forEach(i=>{e.some(o=>o.toLowerCase().includes(i.toLowerCase()))||e.push(i)})}),s.includes("normal")&&(s.includes("ejection fraction")||s.includes("ef"))&&e.push("Normal EF"),e}function E3(s){const e=s.split(/[.!?]+/).filter(n=>n.trim().length>15),a=e.filter(n=>{const i=n.toLowerCase();return!i.includes("thank you")&&!i.includes("dear")&&!i.includes("kind regards")&&!i.includes("yours sincerely")&&!i.includes("best wishes")}).slice(0,3);return a.length===0?e.length>0?e[0].trim()+".":"No summary available.":a.join(". ").trim()+"."}function k3(s){const e=j3(s);if(e.length>0){const r=[],a=e.filter(o=>/(?:atrial fibrillation|af|coronary artery disease|cad|heart failure|hypertension)/i.test(o)),n=e.filter(o=>/(?:ejection fraction|blood pressure|heart rate)/i.test(o)),i=e.filter(o=>/(?:chest pain|dyspnoea|palpitations|dizziness|syncope)/i.test(o));if(a.length>0&&r.push(`${a.slice(0,2).join(" and ")}`),i.length>0&&r.push(`${i.slice(0,2).join(" and ")}`),n.length>0&&r.push(`${n.slice(0,2).join(", ")}`),r.length>0)return r.join(". ")+"."}return E3(s)}function ew(s){try{console.log("üîß Parsing QuickLetter structured response for SUMMARY: and LETTER: markers");const e=s.lastIndexOf("SUMMARY:"),r=s.lastIndexOf("LETTER:");if(console.log("üîç Found SUMMARY: at index (last occurrence):",e),console.log("üîç Found LETTER: at index (last occurrence):",r),e!==-1&&r!==-1&&e<r){console.log("‚úÖ Found both SUMMARY: and LETTER: markers in correct order");let l=s.substring(e+8,r).trim();l=l.replace(/^[-\s]+|[-\s]+$/g,"").trim();let c=s.substring(r+7).trim();c=c.replace(/<unused\d+>|<\|endoftext\|>|<\|end\|>/gi,"").trim(),console.log("üìã Extracted summary raw:",l.substring(0,100)+(l.length>100?"...":"")),console.log("üìù Extracted letter content length:",c.length),console.log("üìù Letter preview:",c.substring(0,100)+(c.length>100?"...":""));const A=_0(l);return console.log("üßπ Cleaned summary:",A),{summary:A,letterContent:c}}console.log("üîç Checking for legacy --- divider pattern");const a=s.match(/SUMMARY:\s*([\s\S]+?)(?=---)/),n=s.match(/LETTER:\s*([\s\S]*)/);if(a&&n){console.log("‚úÖ Found legacy pattern with --- divider");const l=_0(a[1].trim()),c=n[1].trim();return{summary:l,letterContent:c}}console.log("‚ö†Ô∏è No SUMMARY:/LETTER: markers found, using fallback parsing"),console.log("üìÑ Raw output for fallback:",s.substring(0,200)+"...");const i=k3(s),o=i.length>150?i.substring(0,147)+"...":i;return console.log("üîÑ Generated fallback summary:",o),console.log("üìù Using entire output as letter content (length:",s.length,")"),{summary:o,letterContent:s}}catch(e){console.warn("‚ùå Error parsing structured response:",e);const r=s.length>150?s.substring(0,147)+"...":s;return console.log("üö® Using emergency fallback parsing"),{summary:r,letterContent:s}}}function I3(s){const{summary:e}=ew(s);return S3(e)}const dr=(s="rnd")=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${s}-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,Rt=()=>new Date().toISOString(),$p=(s=[],e=4)=>s.length?[...s].sort((n,i)=>new Date(n.date).getTime()-new Date(i.date).getTime()).slice(-e).map(n=>{const i=Number.isFinite(n.value)?n.value.toString():"";return n.units?`${i} ${n.units}`:i}).join(" ‚Üí "):"",Kp=(s,e)=>{if(!s.length)return[];const r=s.filter(a=>a.pinToHud);if(r.length)return r;if(e){const a=s.filter(e);if(a.length)return a}return s},T3=s=>Kp(s).map(r=>({id:r.id,type:r.type,name:r.name,trendString:r.type==="lab"&&r.labSeries?$p(r.labSeries):void 0,summary:r.type!=="lab"?r.summary:void 0})),F3=s=>Kp(s.issues,r=>r.status==="open").map(r=>({id:r.id,title:r.title,status:r.status,latestSubpoint:tw(r.subpoints?.slice(-1)[0])})),P3=s=>Kp(s,r=>r.status==="open").map(r=>({id:r.id,text:r.text,status:r.status})),Td=s=>{if(!s)return null;const e=new Date(s);if(Number.isNaN(e.getTime()))return null;const r=new Date(e.getFullYear(),e.getMonth(),e.getDate()).getTime(),a=new Date,n=new Date(a.getFullYear(),a.getMonth(),a.getDate()).getTime();return Math.floor((n-r)/(1e3*60*60*24))},tw=s=>{if(s)return s.type==="procedure"?s.procedure?.name||s.text:s.type==="antibiotic"&&s.antibiotic?.name||s.text},U3=s=>!s||s.hudEnabled===!1?null:{patientId:s.id,name:s.name,bed:s.bed,oneLiner:s.oneLiner,issues:F3(s),investigations:T3(s.investigations),tasks:P3(s.tasks)},L3=(s,e)=>{const r=[],a=new Date(e).getTime();return s.wardEntries?.forEach(n=>{new Date(n.timestamp).getTime()>=a&&r.push({type:"ward",text:`Ward/bed updated: ${s.site} ${s.bed}`,timestamp:n.timestamp})}),s.issues?.forEach(n=>{n.lastUpdatedAt&&new Date(n.lastUpdatedAt).getTime()>=a&&r.push({type:"issue",text:`Issue "${n.title}" updated (${n.status})`,timestamp:n.lastUpdatedAt}),n.subpoints?.forEach(i=>{if(i.type==="procedure"&&i.procedure){const o=i.procedure.date;o&&new Date(o).getTime()>=a&&r.push({type:"procedure",text:`Procedure: ${i.procedure.name} on ${o}`,timestamp:o})}})}),s.investigations?.forEach(n=>{n.lastUpdatedAt&&new Date(n.lastUpdatedAt).getTime()>=a&&r.push({type:"investigation",text:`Investigation "${n.name}" updated`,timestamp:n.lastUpdatedAt})}),s.tasks?.forEach(n=>{new Date(n.createdAt).getTime()>=a&&r.push({type:"task_created",text:`New task: ${n.text}`,timestamp:n.createdAt}),n.completedAt&&new Date(n.completedAt).getTime()>=a&&r.push({type:"task_completed",text:`Task completed: ${n.text}`,timestamp:n.completedAt})}),s.intakeNotes?.forEach(n=>{new Date(n.timestamp).getTime()>=a&&r.push({type:"intake",text:"New intake note added",timestamp:n.timestamp})}),r.sort((n,i)=>new Date(i.timestamp).getTime()-new Date(n.timestamp).getTime())},D3=(s,e)=>{const r=new Date;switch(s){case"6h":return new Date(r.getTime()-6*60*60*1e3).toISOString();case"12h":return new Date(r.getTime()-12*60*60*1e3).toISOString();case"24h":return new Date(r.getTime()-24*60*60*1e3).toISOString();case"48h":return new Date(r.getTime()-48*60*60*1e3).toISOString();case"today6am":{const a=new Date(r.getFullYear(),r.getMonth(),r.getDate(),6,0,0);return r.getHours()<6&&a.setDate(a.getDate()-1),a.toISOString()}case"lastRound":return e?.wardEntries?.[e.wardEntries.length-1]?.timestamp||new Date(r.getTime()-24*60*60*1e3).toISOString();default:return new Date(r.getTime()-24*60*60*1e3).toISOString()}},R3="http://127.0.0.1:5858";class Yl{static instance=null;apiBase;constructor(e=R3){this.apiBase=e}async requestWithTimeout(e,r,a=3e3){const n=new AbortController,i=setTimeout(()=>n.abort(),a);try{return await this.request(e,{...r,signal:n.signal})}finally{clearTimeout(i)}}static getInstance(){return Yl.instance||(Yl.instance=new Yl),Yl.instance}async request(e,r){const a=`${this.apiBase}${e}`,n=await fetch(a,{...r,headers:{"Content-Type":"application/json",...r?.headers||{}}});if(!n.ok){const i=await n.text();throw new Error(`Rounds backend error (${n.status}): ${i||n.statusText}`)}return await n.json()}async fetchPatients(){return(await this.requestWithTimeout("/rounds/patients")).patients||[]}async savePatients(e){await this.requestWithTimeout("/rounds/patients",{method:"POST",body:JSON.stringify({patients:e})})}async quickAddPatient(e){try{return(await this.requestWithTimeout("/rounds/patients/quick_add",{method:"POST",body:JSON.stringify(e)},3e3)).patient}catch(r){if(r instanceof Error&&r.name==="AbortError"){console.log("[RoundsBackend] Quick Add timed out, retrying with 6s timeout...");try{return(await this.requestWithTimeout("/rounds/patients/quick_add",{method:"POST",body:JSON.stringify(e)},6e3)).patient}catch(a){throw console.warn("[RoundsBackend] Quick Add retry failed, falling back to local-only"),a}}throw r}}}const Fd=Yl.getInstance(),Q0=250;class Xl{static instance=null;cache=[];cliniciansCache=[];saveTimer=null;cliniciansSaveTimer=null;listeners=new Set;backendAvailable=!1;lastLocalSaveTime=0;optimisticPatientIds=new Set;optimisticTimestamps=new Map;OPTIMISTIC_TTL_MS=3e4;constructor(){typeof chrome<"u"&&chrome.storage?.onChanged&&chrome.storage.onChanged.addListener((e,r)=>{if(r==="local"&&e[bl.ROUNDS_PATIENTS]){const a=e[bl.ROUNDS_PATIENTS].newValue||[],n=this.cache.filter(i=>this.isOptimistic(i.id));if(n.length>0){console.log(`[RoundsStorage] Storage change detected, preserving ${n.length} optimistic patient(s)`),new Set(a.map(o=>o.id));const i=[...n,...a.filter(o=>!n.some(l=>l.id===o.id))];this.cache=i}else this.cache=a;this.notify()}})}static getInstance(){return Xl.instance||(Xl.instance=new Xl),Xl.instance}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}getCachedPatients(){return[...this.cache]}async loadPatients(){const e=await this.loadPatientsFromLocal(),r=this.cache.filter(i=>this.isOptimistic(i.id));r.length>0?(console.log(`[RoundsStorage] loadPatients - preserving ${r.length} optimistic patient(s)`),this.cache=[...r,...e.filter(i=>!r.some(o=>o.id===i.id))]):this.cache=[...e],this.lastLocalSaveTime=this.getNewestTimestamp(this.cache);const a=await this.fetchFromBackend();if(!a||a.length===0&&e.length>0)return[...this.cache];const n=this.mergePatients(this.cache,a);return this.cache=n,this.lastLocalSaveTime=this.getNewestTimestamp(n),this.arePatientsEqual(n,e)||this.schedulePersist(),[...n]}async savePatients(e){this.cache=[...e],this.lastLocalSaveTime=Date.now(),await this.persistToBackend(),this.schedulePersist(),this.notify()}addOptimistic(e){this.optimisticPatientIds.add(e),this.optimisticTimestamps.set(e,Date.now())}isOptimistic(e){if(!this.optimisticPatientIds.has(e))return!1;const r=this.optimisticTimestamps.get(e);return r?Date.now()-r>this.OPTIMISTIC_TTL_MS?(this.optimisticPatientIds.delete(e),this.optimisticTimestamps.delete(e),!1):!0:!1}confirmOptimistic(e){this.optimisticPatientIds.delete(e),this.optimisticTimestamps.delete(e)}createLocalPatient(e){const r=new Date().toISOString();return{id:`patient-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,name:e.name,mrn:"",bed:"",oneLiner:"",status:"active",site:e.ward||"1 South",intakeNotes:e.scratchpad?[{id:`intake-${r}`,timestamp:r,text:e.scratchpad}]:[],issues:[],investigations:[],tasks:[],wardEntries:[],clinicianIds:[],createdAt:r,lastUpdatedAt:r}}async quickAddPatient(e){try{const r=await Fd.quickAddPatient(e);return this.backendAvailable=!0,this.cache=[...this.cache,r],this.schedulePersist(),this.notify(),r}catch(r){console.warn("‚ö†Ô∏è Failed to quick-add patient via backend, falling back to local storage",r),this.backendAvailable=!1;const a=this.createLocalPatient(e);return this.cache=[...this.cache,a],this.addOptimistic(a.id),this.lastLocalSaveTime=Date.now(),this.schedulePersist(),this.notify(),a}}async loadPatientsFromBackend(){const e=await this.fetchFromBackend();if(e){const r=this.mergePatients(this.cache,e);this.arePatientsEqual(r,this.cache)||(this.cache=r,this.lastLocalSaveTime=this.getNewestTimestamp(r),this.notify(),this.schedulePersist())}return e}mergePatients(e,r){const a=r.reduce((c,A)=>{const d=new Date(A.lastUpdatedAt).getTime();return d>c?d:c},0);if(this.lastLocalSaveTime>0&&this.lastLocalSaveTime>a)return console.log(`[RoundsStorage] Ignoring stale remote data (local save ${this.lastLocalSaveTime} > remote ${a})`),e;const n=new Map(e.map(c=>[c.id,c])),i=new Map(r.map(c=>[c.id,c])),o=new Set([...n.keys(),...i.keys()]),l=[];for(const c of o){const A=n.get(c),d=i.get(c);if(A&&d){const h=new Date(A.lastUpdatedAt).getTime(),f=new Date(d.lastUpdatedAt).getTime(),u=h>=f?A:d;l.push(u),d&&this.isOptimistic(c)&&this.confirmOptimistic(c)}else A?(this.isOptimistic(A.id)&&console.log(`[RoundsStorage] Preserving optimistic patient: ${A.name}`),l.push(A)):d&&l.push(d)}return l}notify(){const e=[...this.cache];this.listeners.forEach(r=>{try{r(e)}catch(a){console.error("RoundsStorageService listener error",a)}})}schedulePersist(){this.saveTimer&&clearTimeout(this.saveTimer),this.saveTimer=setTimeout(()=>{this.saveTimer=null,this.persist().catch(e=>{console.error("‚ùå Failed to persist rounds patients",e)})},Q0)}async fetchFromBackend(){try{const e=await Fd.fetchPatients();return this.backendAvailable=!0,e}catch{return this.backendAvailable=!1,null}}async persistToBackend(){if(!this.backendAvailable){try{await Fd.savePatients(this.cache),this.backendAvailable=!0}catch{this.backendAvailable=!1}return}try{await Fd.savePatients(this.cache)}catch{this.backendAvailable=!1}}async persist(){try{await Ih({roundsPatients:this.cache});return}catch(e){console.warn("‚ö†Ô∏è Failed to persist rounds patients to chrome.storage.local, attempting localStorage",e)}try{localStorage.setItem(bl.ROUNDS_PATIENTS,JSON.stringify(this.cache))}catch(e){throw console.error("‚ùå Failed to persist rounds patients to localStorage",e),e}}async loadPatientsFromLocal(){try{return[...(await Gg()).roundsPatients||[]]}catch(e){console.warn("‚ö†Ô∏è Failed to load rounds patients from chrome.storage.local, falling back to localStorage",e)}try{const e=localStorage.getItem(bl.ROUNDS_PATIENTS);if(e)return[...JSON.parse(e)]}catch(e){console.warn("‚ö†Ô∏è Failed to load rounds patients from localStorage",e)}return[]}getNewestTimestamp(e){return e.reduce((r,a)=>{const n=new Date(a.lastUpdatedAt||a.createdAt||0).getTime();return Number.isFinite(n)&&n>r?n:r},0)}arePatientsEqual(e,r){return e.length!==r.length?!1:JSON.stringify(e)===JSON.stringify(r)}async loadClinicians(){try{const r=(await Gg()).roundsClinicians||[];return this.cliniciansCache=r,[...r]}catch(e){console.warn("‚ö†Ô∏è Failed to load clinicians from chrome.storage.local, falling back to localStorage",e)}try{const e=localStorage.getItem(bl.ROUNDS_CLINICIANS);if(e){const r=JSON.parse(e);return this.cliniciansCache=r,[...r]}}catch(e){console.warn("‚ö†Ô∏è Failed to load clinicians from localStorage",e)}return this.cliniciansCache=[],[]}async saveClinicians(e){this.cliniciansCache=[...e],this.scheduleCliniciansPersist()}scheduleCliniciansPersist(){this.cliniciansSaveTimer&&clearTimeout(this.cliniciansSaveTimer),this.cliniciansSaveTimer=setTimeout(()=>{this.cliniciansSaveTimer=null,this.persistClinicians().catch(e=>{console.error("‚ùå Failed to persist clinicians",e)})},Q0)}async persistClinicians(){try{await Ih({roundsClinicians:this.cliniciansCache});return}catch(e){console.warn("‚ö†Ô∏è Failed to persist clinicians to chrome.storage.local, attempting localStorage",e)}try{localStorage.setItem(bl.ROUNDS_CLINICIANS,JSON.stringify(this.cliniciansCache))}catch(e){throw console.error("‚ùå Failed to persist clinicians to localStorage",e),e}}}const vo=s=>s.trim().toLowerCase(),Pu=(s=[])=>s.map(e=>e.type==="procedure"&&e.procedure?{id:e.id,timestamp:e.timestamp,type:"procedure",text:"text"in e?e.text||"":void 0,procedure:e.procedure}:e.type==="antibiotic"&&e.antibiotic?{id:e.id,timestamp:e.timestamp,type:"antibiotic",text:"text"in e?e.text||"":void 0,antibiotic:e.antibiotic}:{id:e.id,timestamp:e.timestamp,type:"note",text:"text"in e&&e.text||""}),sw=s=>({...s,admissionFlags:s.admissionFlags?{...s.admissionFlags}:void 0,checklistSkips:s.checklistSkips?[...s.checklistSkips]:[],intakeNotes:[...s.intakeNotes],issues:s.issues.map(e=>({...e,subpoints:(e.subpoints||[]).map(r=>({...r,type:r.type||"note",text:"text"in r&&r.text||"",procedure:r.type==="procedure"?{...r.procedure}:void 0,antibiotic:r.type==="antibiotic"?{...r.antibiotic}:void 0}))})),investigations:s.investigations.map(e=>({...e,labSeries:e.labSeries?[...e.labSeries]:void 0})),tasks:s.tasks.map(e=>({...e})),wardEntries:[...s.wardEntries]}),rw=(s,e)=>{const r=Rt(),a=dr("patient"),n=e?.intakeNoteText?[{id:dr("intake"),timestamp:r,text:e.intakeNoteText}]:[];return{id:a,name:s,mrn:e?.mrn||"",bed:e?.bed||"",oneLiner:e?.oneLiner||"",status:"active",site:e?.site||"Cabrini",admissionId:a,createdAt:r,lastUpdatedAt:r,roundOrder:void 0,hudEnabled:!0,markedForTeaching:!1,tags:[],intakeNotes:n,issues:[],investigations:[],tasks:[],wardEntries:[],expectedDischargeDate:void 0,admissionFlags:{dvtProphylaxisConsidered:!1,followupArranged:!1,lastUpdatedAt:r},checklistSkips:[],roundCompletedDate:void 0}},aw=s=>({...s,id:s.id||dr("issue"),status:s.status||"open",subpoints:Pu(s.subpoints),lastUpdatedAt:s.lastUpdatedAt||Rt()}),nw=s=>({...s,id:s.id||dr("task"),status:s.status||"open",createdAt:s.createdAt||Rt()}),M3=(s,e)=>{const r=sw(s),a=Rt();return e.issues?.forEach(n=>{const i=vo(n.title),o=r.issues.find(l=>vo(l.title)===i);o?(n.subpoints?.length&&(o.subpoints=[...o.subpoints,...Pu(n.subpoints)]),o.lastUpdatedAt=a):r.issues.push(aw({...n,subpoints:Pu(n.subpoints)}))}),e.investigations?.forEach(n=>{const i=vo(n.name),o=r.investigations.find(l=>vo(l.name)===i);o?n.type==="lab"&&n.labSeries?.length?(o.labSeries=[...o.labSeries||[],...n.labSeries],o.lastUpdatedAt=a):n.summary&&(o.summary=n.summary,o.lastUpdatedAt=a):r.investigations.push({...n,id:n.id||dr("inv"),lastUpdatedAt:n.lastUpdatedAt||a})}),e.tasks?.forEach(n=>{const i=vo(n.text);r.tasks.some(l=>vo(l.text)===i)||r.tasks.push(nw(n))}),r.lastUpdatedAt=a,r},_3=(s,e)=>s.map(r=>{const a=e.find(i=>i.issueId===r.id);if(!a)return r;const n=a.newSubpoints?.length?[...r.subpoints||[],...Pu(a.newSubpoints)]:r.subpoints;return{...r,status:a.newStatus||r.status,subpoints:n,lastUpdatedAt:Rt()}}),iw=(s,e,r)=>{const a=sw(s),n=Rt();if(e.issuesAdded?.forEach(o=>{a.issues.push(aw(o))}),e.issuesUpdated?.length&&(a.issues=_3(a.issues,e.issuesUpdated)),e.investigationsAdded?.forEach(o=>{a.investigations.push({...o,id:o.id||dr("inv"),lastUpdatedAt:o.lastUpdatedAt||n,labSeries:o.labSeries?[...o.labSeries]:void 0})}),e.investigationsUpdated?.forEach(o=>{const l=a.investigations.find(c=>c.id===o.investigationId);l&&(o.newLabValues?.length&&(l.labSeries=[...l.labSeries||[],...o.newLabValues]),o.newSummaryText&&(l.summary=o.newSummaryText),l.lastUpdatedAt=n)}),e.tasksAdded?.forEach(o=>{a.tasks.push(nw(o))}),e.tasksUpdated?.forEach(o=>{const l=a.tasks.find(c=>c.id===o.taskId);l&&(l.text=o.newText||l.text,l.status=o.newStatus||l.status,l.status==="done"&&!l.completedAt&&(l.completedAt=n))}),e.tasksCompletedById?.forEach(o=>{const l=a.tasks.find(c=>c.id===o);l&&(l.status="done",l.completedAt=l.completedAt||n)}),e.tasksCompletedByText?.forEach(o=>{const l=vo(o),c=a.tasks.find(A=>vo(A.text)===l);c&&(c.status="done",c.completedAt=c.completedAt||n)}),e.eddUpdate&&e.eddUpdate.newDate!==void 0&&(a.expectedDischargeDate=e.eddUpdate.newDate||void 0),e.admissionFlags&&(a.admissionFlags={...a.admissionFlags||{},...e.admissionFlags,lastUpdatedAt:n}),e.checklistSkips?.length){const o=a.checklistSkips||[],l=new Map;o.forEach(c=>{const A=`${c.condition||"base"}::${c.itemId}`;l.set(A,c)}),e.checklistSkips.forEach(c=>{const A=`${c.condition||"base"}::${c.itemId}`;l.set(A,c)}),a.checklistSkips=Array.from(l.values())}a.lastUpdatedAt=n;const i={id:dr("ward"),timestamp:n,transcript:r,diff:e};return a.wardEntries=[...a.wardEntries,i],{patient:a,wardEntry:i}},Q3={issues:[],investigations:[],tasks:[]},O3={issuesAdded:[],issuesUpdated:[],investigationsAdded:[],investigationsUpdated:[],tasksAdded:[],tasksUpdated:[],tasksCompletedById:[],tasksCompletedByText:[],checklistSkips:[]},H3=s=>{const e=s.match(/\{[\s\S]*\}/);return e?e[0]:s},O0=(s,e)=>{try{return JSON.parse(H3(s))}catch(r){return bt.warn("RoundsLLMService: failed to parse JSON response",{error:r instanceof Error?r.message:r,raw:s?.slice(0,500)}),e}};class Bi{static instance=null;lmStudio=Ei.getInstance();static getInstance(){return Bi.instance||(Bi.instance=new Bi),Bi.instance}async parseIntake(e,r){const a={model:Tr.QUICK_MODEL,temperature:.2,max_tokens:1200,context_length:6e3,messages:[{role:"system",content:["You are a clinician assistant that converts rough intake notes into structured ward data.",'Return ONLY JSON with keys "issues", "investigations", "tasks".','Issue shape: { id?, title, status ("open"|"resolved"), subpoints: [{ id?, timestamp, text }], pinToHud? }','Investigation shape: { id?, type: "lab"|"imaging"|"procedure"|"other", name, lastUpdatedAt, labSeries?, summary?, pinToHud? }','Task shape: { id?, text, status ("open"|"done"), createdAt, completedAt?, category?, pinToHud? }',"Use timestamps if provided; otherwise leave generation to the client (do not invent dates).","Do not invent labs or imaging not present in the intake. Prefer concise, clinical wording."].join(" ")},{role:"user",content:[`Intake scratchpad:
${e}`,r?`Current patient snapshot (for context, do not repeat fields):
${JSON.stringify(r)}`:""].join(`
`)}],response_format:{type:"json_schema",json_schema:{name:"intake_result",strict:!0,schema:{type:"object",properties:{issues:{type:"array"},investigations:{type:"array"},tasks:{type:"array"}},required:["issues","investigations","tasks"]}}}},n=await this.lmStudio.makeRequest(a,void 0,"rounds-intake");return O0(n,Q3)}async parseWardUpdate(e,r){const a={model:Tr.QUICK_MODEL,temperature:.2,max_tokens:1600,context_length:6e3,messages:[{role:"system",content:["You are updating an inpatient ward list based on a natural language ward round dictation.","Return ONLY JSON for WardUpdateDiff with keys: issuesAdded, issuesUpdated, investigationsAdded, investigationsUpdated, tasksAdded, tasksUpdated, tasksCompletedById, tasksCompletedByText.","Prefer matching existing issues/investigations/tasks by similarity instead of creating duplicates.","For labs, append new LabValue entries with numbers you hear. For imaging/procedure, summarise briefly.","Only mark tasks done if clearly completed. Do not hallucinate values or procedures.","Use concise subpoints and summaries."].join(" ")},{role:"user",content:["Current patient state (for matching):",JSON.stringify({id:r.id,name:r.name,mrn:r.mrn,bed:r.bed,issues:r.issues,investigations:r.investigations,tasks:r.tasks}),`
Ward dictation:`,e].join(`
`)}],response_format:{type:"json_schema",json_schema:{name:"ward_update_diff",strict:!0,schema:{type:"object",properties:{issuesAdded:{type:"array"},issuesUpdated:{type:"array"},investigationsAdded:{type:"array"},investigationsUpdated:{type:"array"},tasksAdded:{type:"array"},tasksUpdated:{type:"array"},tasksCompletedById:{type:"array"},tasksCompletedByText:{type:["array","null"]}},required:["issuesAdded","issuesUpdated","investigationsAdded","investigationsUpdated","tasksAdded","tasksUpdated","tasksCompletedById"]}}}},n=await this.lmStudio.makeRequest(a,void 0,"rounds-ward-update");return O0(n,O3)}async generateGpLetter(e){const r=e.tasks.filter(i=>i.status==="open");await this.lmStudio.ensureModelLoaded(Tr.REASONING_MODEL);const a={model:Tr.REASONING_MODEL,temperature:.25,max_tokens:1200,context_length:8e3,messages:[{role:"system",content:["You are writing a GP-facing discharge letter in the same style as Operator Quick Letter: polished, clinical, and narrative with short, well-structured paragraphs (no bullet lists).","Include: reason for admission, succinct hospital course, key investigations (labs/imaging) that matter long term, any medication changes if present, and clear GP follow-up actions inferred from open tasks, and completed tasks mentioned in the summary.","Keep it concise, professional, and readable; return plain text only (no JSON, no headings)."].join(" ")},{role:"user",content:[`Patient: ${e.name}${e.mrn?` (MRN ${e.mrn})`:""}`,`Bed: ${e.bed||"n/a"}`,`One-liner: ${e.oneLiner||"not provided"}`,"Issues:",JSON.stringify(e.issues),"Investigations:",JSON.stringify(e.investigations),"Ward entries (hospital course):",JSON.stringify(e.wardEntries.slice(-8)),"Open tasks (for follow-up):",JSON.stringify(r)].join(`
`)}]},n=await this.lmStudio.makeRequest(a,void 0,"rounds-gp-letter");return typeof n=="string"?n.trim():""}async generateHandoverSummary(e){await this.lmStudio.ensureModelLoaded(Tr.REASONING_MODEL);const r=e.map(i=>({name:i.name,mrn:i.mrn,bed:i.bed,ward:i.site,oneLiner:i.oneLiner,issues:i.issues.filter(o=>o.status==="open").map(o=>({title:o.title,latest:o.subpoints[o.subpoints.length-1]?.text})),investigations:i.investigations.map(o=>({type:o.type,name:o.name,summary:o.summary,labTrend:o.type==="lab"?o.labSeries?.slice(-3):void 0})),openTasks:i.tasks.filter(o=>o.status==="open").map(o=>o.text)})),a={model:Tr.REASONING_MODEL,temperature:.25,max_tokens:1200,context_length:8e3,messages:[{role:"system",content:["You are writing a clinician-to-clinician ward handover message for multiple inpatients.","For each patient, summarise: active issues, key investigations (pending/results), and outstanding tasks.","Be concise, accurate, and avoid repeating irrelevant detail.","Formatting:","- One paragraph per patient.",'- Start each paragraph with: "<Name> ‚Äì Bed <bed> ‚Äì <one-liner>" (omit missing fields).',"- Write a short narrative covering active issues, key investigations in the context of those issues, and then the plan.","Use Australian spelling. Return plain text only."].join(" ")},{role:"user",content:["Patients JSON:",JSON.stringify(r),"","Write the handover message:"].join(`
`)}]},n=await this.lmStudio.makeRequest(a,void 0,"rounds-handover-summary");return typeof n=="string"?n.trim():""}async refineGpLetter(e,r,a){await this.lmStudio.ensureModelLoaded(Tr.REASONING_MODEL);const n={model:Tr.REASONING_MODEL,temperature:.2,max_tokens:900,context_length:8e3,messages:[{role:"system",content:["You are revising a GP-facing discharge letter. Make concise edits only; keep structure and tone.","Return the full revised letter."].join(" ")},{role:"user",content:["Current letter:",r,"","Patient context (for consistency, do not restate all):",JSON.stringify({name:e.name,mrn:e.mrn,bed:e.bed,site:e.site,oneLiner:e.oneLiner}),"","Edit request:",a].join(`
`)}]},i=await this.lmStudio.makeRequest(n,void 0,"rounds-gp-letter");return typeof i=="string"?i.trim():""}async generatePatientUpdateMessage(e,r){if(r.length===0)return"No significant changes.";const a=r.map(i=>`- ${i.text}`).join(`
`),n={model:Tr.QUICK_MODEL,temperature:.3,max_tokens:150,context_length:2e3,messages:[{role:"system",content:["You are a clinical assistant.","You will receive a list of changes for a ward patient over the last 24 hours.","Produce a single concise message, maximum 280 characters.","The audience is another clinician who already knows the patient.","Use plain English, no bullet points, no headings.",'Do NOT explicitly mention "in the last 24 hours"; just describe what changed.','If there are no meaningful changes, respond exactly with "No significant changes."',"Use Australian spelling."].join(" ")},{role:"user",content:`Patient: ${e.name}
Ward: ${e.site||"Unknown"}
Bed: ${e.bed}

Recent changes:
${a}

Generate a concise update message (‚â§280 chars):`}]};try{const o=(await this.lmStudio.makeRequest(n,void 0,"rounds-message-update")).trim();return o.length>280?o.substring(0,277)+"...":o}catch(i){return bt.error("[RoundsLLMService] generatePatientUpdateMessage error",{error:i instanceof Error?i.message:i}),"Could not generate update."}}}const lp={base:{daily:[{id:"issues",title:"Issues",type:"issues",description:"Summarise active issues, pick one at a time, and capture concise updates or changes."},{id:"new_results",title:"New investigation results",type:"investigations",description:"Surface recent investigations and ask whether to record or update them today."},{id:"plan_items",title:"Plan items & tasks",type:"plan",description:"Review open plan items/tasks, mark completed ones, and add new tasks from today."},{id:"edd",title:"Expected discharge date",type:"edd",description:"Check if EDD needs updating and capture the clinician-proposed date."}],oncePerAdmission:[{id:"dvt_prophylaxis",title:"Confirm DVT prophylaxis addressed",action:"task",description:"Confirm DVT prophylaxis has been considered; create a task if needed and mark flag to avoid repeat prompts.",allowSkipForAdmission:!0,flagKey:"dvtProphylaxisConsidered",suggestedCategory:"other",linkedIssueHint:"venous thromboembolism risk"},{id:"followup_arranged",title:"Follow-up arranged",action:"task",description:"Ensure appropriate outpatient follow-up (cardiology clinic and/or GP) is organised.",allowSkipForAdmission:!0,flagKey:"followupArranged",suggestedCategory:"followup"}]},conditions:[{key:"acute_decompensated_hf",label:"Acute decompensated heart failure",hints:["acute pulmonary oedema","ADHF","decompensated heart failure"],issueExamples:["Acute pulmonary oedema on background HFpEF","ADHF requiring IV diuretics"],items:[{id:"adhf_iron_studies",title:"Order iron studies / ferritin for HF optimisation",action:"task",suggestedCategory:"lab",allowSkipForAdmission:!0},{id:"adhf_gdmt",title:"Optimise HF therapy (ACEi/ARB/ARNI, beta-blocker, MRA, SGLT2i as tolerated)",action:"issue_update",allowSkipForAdmission:!0,linkedIssueHint:"heart failure therapy"},{id:"adhf_diuretic_plan",title:"Clarify IV/oral diuretic plan, weight goal, and fluid balance targets",action:"task",suggestedCategory:"other",allowSkipForAdmission:!0},{id:"adhf_daily_weights",title:"Ensure daily weights and fluid balance charting",action:"task",suggestedCategory:"other",allowSkipForAdmission:!0},{id:"adhf_followup",title:"Arrange HF clinic or telehealth follow-up after discharge",action:"task",suggestedCategory:"followup",allowSkipForAdmission:!0}]},{key:"aortic_stenosis",label:"Aortic stenosis",hints:["severe AS","TAVI workup","calcific aortic stenosis"],issueExamples:["Severe calcific aortic stenosis awaiting TAVI"],items:[{id:"as_ct_tavi",title:"Arrange CT TAVI planning",action:"task",suggestedCategory:"imaging",allowSkipForAdmission:!0},{id:"as_ecg_review",title:"Review recent ECG for conduction disease",action:"task",suggestedCategory:"other",allowSkipForAdmission:!0},{id:"as_amyloid_screen",title:"Consider amyloidosis screen if phenotype fits",action:"investigation",suggestedCategory:"lab",allowSkipForAdmission:!0},{id:"as_coronary_angio",title:"Consider coronary angiogram before TAVI",action:"task",suggestedCategory:"imaging",allowSkipForAdmission:!0}]},{key:"hfpef",label:"HFpEF",hints:["heart failure with preserved EF","HFpEF","diastolic dysfunction"],issueExamples:["HFpEF with recurrent congestion"],items:[{id:"hfpef_amyloid",title:"Screen for amyloidosis if red flags present",action:"investigation",suggestedCategory:"lab",allowSkipForAdmission:!0},{id:"hfpef_bp_volume",title:"Optimise blood pressure and volume status plan",action:"issue_update",allowSkipForAdmission:!0},{id:"hfpef_sleep",title:"Consider sleep apnoea screening",action:"task",suggestedCategory:"other",allowSkipForAdmission:!0},{id:"hfpef_trial",title:"Assess suitability for HFpEF clinic or trial",action:"task",suggestedCategory:"followup",allowSkipForAdmission:!0}]},{key:"atrial_fibrillation",label:"Atrial fibrillation",hints:["paroxysmal AF","atrial fibrillation","AF with RVR"],issueExamples:["Paroxysmal AF on apixaban","AF with RVR"],items:[{id:"af_anticoagulation",title:"Confirm anticoagulation/CHA2DS2-VASc plan",action:"issue_update",allowSkipForAdmission:!0},{id:"af_rate_control",title:"Review rate control plan and beta-blocker/CCB dosing",action:"issue_update",allowSkipForAdmission:!0},{id:"af_rhythm_control",title:"Consider rhythm control or ablation referral",action:"task",suggestedCategory:"followup",allowSkipForAdmission:!0},{id:"af_sleep_apnoea",title:"Screen for sleep apnoea contributing to AF",action:"task",suggestedCategory:"other",allowSkipForAdmission:!0},{id:"af_followup",title:"Plan outpatient ECG/monitor or clinic follow-up",action:"task",suggestedCategory:"followup",allowSkipForAdmission:!0}]}],quickResponses:["yes","no","skip this item","not now","done"]},Hc=s=>s.trim().toLowerCase(),ow={issuesAdded:[],issuesUpdated:[],investigationsAdded:[],investigationsUpdated:[],tasksAdded:[],tasksUpdated:[],tasksCompletedById:[],tasksCompletedByText:[],checklistSkips:[]},V3=s=>{const e=s.match(/\{[\s\S]*\}/);return e?e[0]:s},fA=s=>{const e=s||{};return{...ow,...e,issuesAdded:e.issuesAdded?[...e.issuesAdded]:[],issuesUpdated:e.issuesUpdated?[...e.issuesUpdated]:[],investigationsAdded:e.investigationsAdded?[...e.investigationsAdded]:[],investigationsUpdated:e.investigationsUpdated?[...e.investigationsUpdated]:[],tasksAdded:e.tasksAdded?[...e.tasksAdded]:[],tasksUpdated:e.tasksUpdated?[...e.tasksUpdated]:[],tasksCompletedById:e.tasksCompletedById?[...e.tasksCompletedById]:[],tasksCompletedByText:e.tasksCompletedByText?[...e.tasksCompletedByText]:[],checklistSkips:e.checklistSkips?[...e.checklistSkips]:[]}},$3=(s,e)=>{const r=new Map;return s.forEach(a=>{r.set(a.issueId,{...a,newSubpoints:a.newSubpoints?[...a.newSubpoints]:void 0})}),e.forEach(a=>{const n=r.get(a.issueId);if(!n){r.set(a.issueId,{...a,newSubpoints:a.newSubpoints?[...a.newSubpoints]:void 0});return}const i=[...n.newSubpoints||[],...a.newSubpoints||[]];r.set(a.issueId,{issueId:a.issueId,newStatus:a.newStatus??n.newStatus,newSubpoints:i.length?i:void 0})}),Array.from(r.values())},K3=(s,e)=>{const r=new Map;return s.forEach(a=>{r.set(a.investigationId,{...a,newLabValues:a.newLabValues?[...a.newLabValues]:void 0})}),e.forEach(a=>{const n=r.get(a.investigationId);if(!n){r.set(a.investigationId,{...a,newLabValues:a.newLabValues?[...a.newLabValues]:void 0});return}const i=[...n.newLabValues||[],...a.newLabValues||[]];r.set(a.investigationId,{investigationId:a.investigationId,newLabValues:i.length?i:void 0,newSummaryText:a.newSummaryText??n.newSummaryText})}),Array.from(r.values())},G3=(s,e)=>{const r=new Map;return s.forEach(a=>r.set(a.taskId,{...a})),e.forEach(a=>{const n=r.get(a.taskId);if(!n){r.set(a.taskId,{...a});return}r.set(a.taskId,{taskId:a.taskId,newStatus:a.newStatus??n.newStatus,newText:a.newText??n.newText})}),Array.from(r.values())},eu=(s,e)=>{const r=new Map;return s.forEach(a=>{r.set(e(a),a)}),Array.from(r.values())},lw=(s=[],e=[])=>{const r=[...s,...e];return eu(r,a=>`${a.condition||"base"}::${a.itemId}`)},z3=(s,e)=>{const r=fA(s),a=fA(e),n=eu([...r.issuesAdded,...a.issuesAdded],A=>A.id||Hc(A.title)),i=eu([...r.investigationsAdded,...a.investigationsAdded],A=>A.id||Hc(A.name)),o=eu([...r.tasksAdded,...a.tasksAdded],A=>A.id||Hc(A.text)),l=Array.from(new Set([...r.tasksCompletedById,...a.tasksCompletedById])),c=Array.from(new Set([...(r.tasksCompletedByText||[]).map(Hc),...(a.tasksCompletedByText||[]).map(Hc)]));return{...r,issuesAdded:n,issuesUpdated:$3(r.issuesUpdated,a.issuesUpdated),investigationsAdded:i,investigationsUpdated:K3(r.investigationsUpdated,a.investigationsUpdated),tasksAdded:o,tasksUpdated:G3(r.tasksUpdated,a.tasksUpdated),tasksCompletedById:l,tasksCompletedByText:c,eddUpdate:a.eddUpdate??r.eddUpdate,admissionFlags:{...r.admissionFlags||{},...a.admissionFlags||{}},checklistSkips:lw(r.checklistSkips,a.checklistSkips),patientId:a.patientId??r.patientId,admissionId:a.admissionId??r.admissionId}},W3=s=>{const e=fA(s),r=[e.issuesAdded.length,e.issuesUpdated.length,e.investigationsAdded.length,e.investigationsUpdated.length,e.tasksAdded.length,e.tasksUpdated.length,e.tasksCompletedById.length,(e.tasksCompletedByText||[]).length,(e.checklistSkips||[]).length].some(n=>n>0),a=!!(e.eddUpdate?.newDate||e.admissionFlags);return!r&&!a};class q3{lmStudio;constructor(){this.lmStudio=Ei.getInstance()}buildPatientSnapshot(e){const r=a=>a.subpoints?.slice(-1)[0];return{id:e.id,admissionId:e.admissionId||e.id,name:e.name,mrn:e.mrn,bed:e.bed,oneLiner:e.oneLiner,expectedDischargeDate:e.expectedDischargeDate,admissionFlags:e.admissionFlags,checklistSkips:e.checklistSkips||[],issues:e.issues.map(a=>({id:a.id,title:a.title,status:a.status,lastUpdatedAt:a.lastUpdatedAt,latestNote:r(a)?.text,pinToHud:a.pinToHud})),investigations:e.investigations.map(a=>({id:a.id,type:a.type,name:a.name,lastUpdatedAt:a.lastUpdatedAt,summary:a.summary,labSeries:a.labSeries?a.labSeries.slice(-2):void 0})),tasks:e.tasks.map(a=>({id:a.id,text:a.text,status:a.status,category:a.category,createdAt:a.createdAt,completedAt:a.completedAt}))}}buildMessages(e,r){const a=e.checklistBank||lp,n=["You are a cardiology ward registrar running a structured ward round conversation.","Work one patient and one question at a time. Keep replies concise (1-2 short sentences).","Base checklist order: issues -> new results -> plan/tasks -> EDD.","Once-per-admission items: ask until flagged as done, then stop.","Infer likely conditions from issue text using provided hints, propose relevant condition-specific checklist items.","For each checklist item, accept short responses (yes/no/skip/not now).","Never change data directly; return a structured diff only. Use existing IDs when updating items.","Use Australian clinical wording.","If input is ambiguous, ask a clarifying question before making changes.","Always return JSON with: assistant_message, human_summary, diff, and optional follow_up_questions/clarifications.","diff fields: issuesAdded, issuesUpdated, investigationsAdded, investigationsUpdated, tasksAdded, tasksUpdated, tasksCompletedById, tasksCompletedByText (strings), eddUpdate { oldDate?, newDate? }, admissionFlags { dvtProphylaxisConsidered?, followupArranged? }, checklistSkips [{ condition?, itemId, reason? }], patientId, admissionId."].join(" "),i=this.buildPatientSnapshot(e.patient),o=r?.length?r:[],l=a.quickResponses||[],c=[`Mode: ${e.mode}`,"Checklist bank JSON:",JSON.stringify(a),"Patient snapshot:",JSON.stringify(i),o.length?`Session summary so far:
${o.join(`
`)}`:"Session summary so far: none",e.userInput?`Clinician input this turn:
${e.userInput}`:"No clinician input provided; start the checklist with an intro question.",l.length?`Short responses to interpret: ${l.join(", ")}`:"","Respond with the next assistant_message plus updated diff/human_summary for this session."].filter(Boolean).join(`
`),A=e.session?.history||[],d=A.length>8?A.slice(-8):A;return[{role:"system",content:n},...d,{role:"user",content:c}]}parseResponse(e){try{return JSON.parse(V3(e))}catch(r){return bt.warn("WardConversationEngine: failed to parse JSON response, falling back to text-only",{error:r instanceof Error?r.message:r,raw:e?.slice(0,400)}),{assistant_message:e||"Could you clarify?",human_summary:[],diff:ow}}}async runTurn(e){await this.lmStudio.ensureModelLoaded(Tr.REASONING_MODEL);const r=this.buildMessages(e,e.session?.humanSummary||[]),a={model:Tr.REASONING_MODEL,temperature:.25,max_tokens:900,context_length:8e3,messages:r,response_format:{type:"json_schema",json_schema:{name:"ward_conversation_response",strict:!0,schema:{type:"object",properties:{assistant_message:{type:"string"},human_summary:{type:["array","string"],items:{type:"string"}},diff:{type:"object",properties:{issuesAdded:{type:"array"},issuesUpdated:{type:"array"},investigationsAdded:{type:"array"},investigationsUpdated:{type:"array"},tasksAdded:{type:"array"},tasksUpdated:{type:"array"},tasksCompletedById:{type:"array"},tasksCompletedByText:{type:["array","null"]},eddUpdate:{type:"object"},admissionFlags:{type:"object"},checklistSkips:{type:"array"},patientId:{type:"string"},admissionId:{type:"string"}},required:["issuesAdded","issuesUpdated","investigationsAdded","investigationsUpdated","tasksAdded","tasksUpdated","tasksCompletedById"]},follow_up_questions:{type:"array",items:{type:"string"}},clarifications:{type:"array",items:{type:"string"}}},required:["assistant_message","diff"]}}}},n=await this.lmStudio.makeRequest(a,void 0,"ward-conversation"),i=this.parseResponse(n),o=Array.isArray(i.human_summary)?i.human_summary:i.human_summary?[i.human_summary]:[],l=fA(i.diff);return{assistantMessage:(i.assistant_message||"").trim(),humanSummary:o,diff:l,followUpQuestions:i.follow_up_questions,clarifications:i.clarifications,raw:n}}}class Xo{static instance=null;sessions=new Map;engine=new q3;static getInstance(){return Xo.instance||(Xo.instance=new Xo),Xo.instance}getSession(e){return this.sessions.get(e)}listSessions(){return Array.from(this.sessions.values())}updateHistory(e,r,a){const n=[...e.history];n.push({role:"user",content:r||"Start ward conversation"}),n.push({role:"assistant",content:a});const i=n.length>10?n.slice(-10):n;e.history=i}buildSession(e,r){const a=Rt();return{id:dr("ward-session"),patientId:e.id,admissionId:e.admissionId||e.id,mode:r,createdAt:a,updatedAt:a,history:[],pendingDiff:fA(),humanSummary:[],checklistSkips:e.checklistSkips||[]}}mergeAndPersist(e,r,a){const n=z3(e.pendingDiff,r.diff),i=Array.from(new Set([...e.humanSummary,...r.humanSummary]));return e.pendingDiff=n,e.humanSummary=i,e.lastAssistantMessage=r.assistantMessage,e.updatedAt=Rt(),this.updateHistory(e,a,r.assistantMessage),e.checklistSkips=lw(e.checklistSkips,n.checklistSkips),this.sessions.set(e.id,e),{...r,diff:n,humanSummary:i}}async startSession(e,r="ward_round",a){const n=this.buildSession(e,r);this.sessions.set(n.id,n);const i=await this.engine.runTurn({patient:e,mode:r,session:n,userInput:a??null,checklistBank:lp}),o=this.mergeAndPersist(n,i,a??null);return{session:n,turn:o}}async continueSession(e,r,a){const n=this.sessions.get(e);if(!n)throw new Error(`No ward conversation session found for id ${e}`);const i=await this.engine.runTurn({patient:r,mode:n.mode,session:n,userInput:a,checklistBank:lp});return this.mergeAndPersist(n,i,a)}async runDictation(e,r,a){if(!a)return this.startSession(e,"dictation",r);const n=await this.continueSession(a,e,r);return{session:this.sessions.get(a),turn:n}}applyPendingDiff(e,r,a){const n=this.sessions.get(e);if(!n)throw new Error(`No ward conversation session found for id ${e}`);return W3(n.pendingDiff)?null:iw(r,n.pendingDiff,a||n.humanSummary.join(" | ")||n.lastAssistantMessage||"Ward conversation update")}discardSession(e){this.sessions.delete(e)}}Xo.getInstance();const cw=m.createContext(void 0),yn=()=>{const s=m.useContext(cw);if(!s)throw new Error("useRounds must be used within RoundsProvider");return s},J3=({children:s})=>{const e=m.useMemo(()=>Xl.getInstance(),[]),r=m.useMemo(()=>Bi.getInstance(),[]),a=m.useMemo(()=>Xo.getInstance(),[]),[n,i]=m.useState([]),[o,l]=m.useState([]),[c,A]=m.useState(!0),[d,h]=m.useState(null),[f,u]=m.useState({}),[x,b]=m.useState({}),[N,v]=m.useState("1 South"),[j,I]=m.useState(!1),[C,E]=m.useState(!1),T=m.useRef(!1);m.useEffect(()=>{Tc.isAvailable().then(E)},[]),m.useEffect(()=>{if(typeof chrome>"u"||!chrome.storage?.onChanged)return;const pe=(fe,we)=>{we==="local"&&fe[Qy]&&(Tc.isAvailable().then(E),Tc.reloadConfig().catch(de=>{console.warn("[RoundsContext] Failed to reload Notion config",de)}))};return chrome.storage.onChanged.addListener(pe),()=>chrome.storage.onChanged.removeListener(pe)},[]),m.useEffect(()=>{let pe=!0;Promise.all([e.loadPatients(),e.loadClinicians()]).then(([we,de])=>{pe&&(i(we),l(de),A(!1),we.length>0&&h(xe=>xe??we[0].id))});const fe=e.subscribe(we=>{i(we)});return()=>{pe=!1,fe()}},[e]),m.useEffect(()=>{const pe=setInterval(async()=>{if(T.current){console.log("[RoundsContext] Skipping backend poll - Quick Add in progress");return}const fe=await e.loadPatientsFromBackend();!d&&fe&&fe.length>0&&h(fe[0].id)},15e3);return()=>clearInterval(pe)},[d,e]);const Q=m.useCallback(pe=>{i(fe=>{const we=pe(fe);return e.savePatients(we),we})},[e]),D=m.useCallback(pe=>{l(fe=>{const we=pe(fe);return e.saveClinicians(we),we})},[e]),k=m.useCallback(async pe=>{Q(fe=>[...fe,pe]),d||h(pe.id)},[Q,d]),R=m.useCallback(async(pe,fe)=>{const we=Rt();Q(de=>de.map(xe=>xe.id===pe?{...xe,intakeNotes:[...xe.intakeNotes,{id:`intake-${we}`,timestamp:we,text:fe}],lastUpdatedAt:we}:xe))},[Q]),w=m.useCallback(async(pe,fe,we)=>{u(de=>({...de,[pe]:"running"}));try{const de=await r.parseIntake(fe,we);Q(xe=>xe.map(Ne=>Ne.id===pe?M3(Ne,de):Ne)),u(xe=>({...xe,[pe]:"idle"}))}catch(de){console.error("Intake parser failed",de),u(xe=>({...xe,[pe]:"error"}))}},[r,Q]),L=m.useCallback(async(pe,fe,we)=>{T.current=!0;try{const de=we||N,xe=await e.quickAddPatient({name:pe,scratchpad:fe,ward:de});if(xe)return h(xe.id),fe.trim()&&w(xe.id,fe,xe),xe;const Ne=rw(pe,{intakeNoteText:fe,site:de});return await k(Ne),h(Ne.id),fe.trim()&&w(Ne.id,fe,Ne),Ne}finally{T.current=!1}},[N,k,e,w]),M=m.useCallback(async(pe,fe)=>{Q(we=>we.map(de=>de.id===pe?fe(de):de))},[Q]),P=m.useCallback(async(pe,fe,we)=>{Q(de=>{const xe=de.find(Ne=>Ne.id===pe);if(xe){const Ne=JSON.parse(JSON.stringify(xe));b(it=>({...it,[pe]:Ne}))}return de.map(Ne=>Ne.id===pe?iw(Ne,fe,we).patient:Ne)})},[Q]),K=m.useCallback(async pe=>{const fe=x[pe];fe&&(Q(we=>we.map(de=>de.id===pe?fe:de)),b(we=>({...we,[pe]:null})))},[x,Q]),$=m.useCallback(async(pe,fe="ward_round",we)=>{const de=n.find(xe=>xe.id===pe);if(!de)throw new Error(`Patient ${pe} not found for ward conversation`);return a.startSession(de,fe,we??null)},[n,a]),O=m.useCallback(async(pe,fe)=>{const we=a.getSession(pe);if(!we)throw new Error(`Ward conversation session ${pe} not found`);const de=n.find(xe=>xe.id===we.patientId);if(!de)throw new Error(`Patient ${we.patientId} not found for ward conversation`);return a.continueSession(pe,de,fe)},[n,a]),W=m.useCallback(async(pe,fe,we)=>{const de=n.find(xe=>xe.id===pe);if(!de)throw new Error(`Patient ${pe} not found for ward dictation`);return a.runDictation(de,fe,we)},[n,a]),ee=m.useCallback(async(pe,fe)=>{const we=a.getSession(pe);if(!we)throw new Error(`Ward conversation session ${pe} not found`);const de=fe||we.humanSummary.join(" | ")||we.lastAssistantMessage||"Ward conversation update";await P(we.patientId,we.pendingDiff,de),a.discardSession(pe)},[P,a]),V=m.useCallback(pe=>{a.discardSession(pe)},[a]),q=m.useCallback(pe=>a.getSession(pe),[a]),S=m.useCallback(async()=>{const pe=await e.loadPatients();i(pe)},[e]),H=m.useCallback(async(pe,fe)=>{const we=Rt();console.log(`[RoundsContext] markDischarged: ${pe} -> ${fe}`),Q(de=>{const xe=de.map(Ne=>Ne.id===pe?{...Ne,status:fe,lastUpdatedAt:we}:Ne);return console.log(`[RoundsContext] After markDischarged - Total: ${xe.length}, Active: ${xe.filter(Ne=>Ne.status==="active").length}, Discharged: ${xe.filter(Ne=>Ne.status==="discharged").length}`),xe}),fe==="discharged"&&d===pe&&(h(null),I(!1))},[Q,d]),Y=m.useCallback(async pe=>{console.log(`[RoundsContext] deletePatient: ${pe}`),Q(fe=>{const we=fe.filter(de=>de.id!==pe);return console.log(`[RoundsContext] After deletePatient - Remaining: ${we.length}`),we}),d===pe&&(h(null),I(!1))},[Q,d]),te=m.useMemo(()=>d&&n.find(pe=>pe.id===d)||null,[n,d]),G=m.useMemo(()=>U3(te),[te]),X=m.useCallback(()=>{I(pe=>!pe)},[]),le=m.useCallback(pe=>{const fe=n.filter(xe=>xe.status==="active").sort((xe,Ne)=>(xe.roundOrder??0)-(Ne.roundOrder??0));if(fe.length===0)return;const we=d?fe.findIndex(xe=>xe.id===d):-1;let de;we===-1?de=0:pe==="next"?de=(we+1)%fe.length:de=we===0?fe.length-1:we-1,h(fe[de].id)},[n,d]),he=m.useCallback(async pe=>{D(fe=>[...fe,pe])},[D]),ve=m.useCallback(async(pe,fe)=>{const we=Rt();D(de=>de.map(xe=>xe.id===pe?{...xe,...fe,lastUpdatedAt:we}:xe))},[D]),ke=m.useCallback(async pe=>{D(fe=>fe.filter(we=>we.id!==pe)),Q(fe=>fe.map(we=>({...we,clinicianIds:we.clinicianIds?.filter(de=>de!==pe),lastUpdatedAt:Rt()})))},[D,Q]),Le=m.useCallback(async(pe,fe)=>{const we=Rt();Q(de=>de.map(xe=>{if(xe.id===pe){const Ne=xe.clinicianIds||[];return Ne.includes(fe)?xe:{...xe,clinicianIds:[...Ne,fe],lastUpdatedAt:we}}return xe}))},[Q]),Be=m.useCallback(async(pe,fe)=>{const we=Rt();Q(de=>de.map(xe=>xe.id===pe?{...xe,clinicianIds:(xe.clinicianIds||[]).filter(Ne=>Ne!==fe),lastUpdatedAt:we}:xe))},[Q]),Re=m.useCallback(async(pe,fe)=>{const we=Rt(),de={...fe,id:dr("bill"),patientId:pe,createdAt:we,updatedAt:we};Q(xe=>xe.map(Ne=>Ne.id===pe?{...Ne,billingEntries:[...Ne.billingEntries||[],de],lastUpdatedAt:we}:Ne))},[Q]),re=m.useCallback(async(pe,fe,we)=>{const de=Rt();Q(xe=>xe.map(Ne=>Ne.id===pe?{...Ne,billingEntries:(Ne.billingEntries||[]).map(it=>it.id===fe?{...it,...we,updatedAt:de}:it),lastUpdatedAt:de}:Ne))},[Q]),Me=m.useCallback(async(pe,fe)=>{const we=Rt();Q(de=>de.map(xe=>xe.id===pe?{...xe,billingEntries:(xe.billingEntries||[]).filter(Ne=>Ne.id!==fe),lastUpdatedAt:we}:xe))},[Q]),Pe=m.useCallback(async(pe,fe)=>{const we=Rt(),de=n.find(Ne=>Ne.id===pe),xe=de?.billingEntries?.find(Ne=>Ne.id===fe);if(!(!xe||!de)&&(Q(Ne=>Ne.map(it=>it.id===pe?{...it,billingEntries:(it.billingEntries||[]).map(st=>st.id===fe?{...st,status:"entered",updatedAt:we,notionSyncError:void 0}:st),lastUpdatedAt:we}:it)),C))try{const Ne=xe.notionId,it=Ne?(await Tc.updateBillingEntry(Ne,{status:"entered"}),Ne):await Tc.createBillingEntry({...xe,status:"entered"},de.name);Q(st=>st.map($e=>$e.id===pe?{...$e,billingEntries:($e.billingEntries||[]).map(Xe=>Xe.id===fe?{...Xe,notionId:it,notionLastSyncedAt:Rt(),notionSyncError:void 0,updatedAt:Rt()}:Xe),lastUpdatedAt:Rt()}:$e)),console.log(`[Billing] Synced entry ${fe} to Notion: ${it}`)}catch(Ne){console.error("[Billing] Failed to sync to Notion:",Ne);const it=Ne instanceof Error?Ne.message:String(Ne);Q(st=>st.map($e=>$e.id===pe?{...$e,billingEntries:($e.billingEntries||[]).map(Xe=>Xe.id===fe?{...Xe,notionSyncError:it,updatedAt:Rt()}:Xe),lastUpdatedAt:Rt()}:$e))}},[n,Q,C]),be=m.useCallback(async(pe,fe)=>{const we=Rt();Q(de=>de.map(xe=>xe.id===pe?{...xe,checklist:{...xe.checklist,...fe,lastUpdatedAt:we},lastUpdatedAt:we}:xe))},[Q]),ce=m.useCallback(async(pe,fe)=>{const we=Rt();Q(de=>de.map(xe=>xe.id===pe?{...xe,checklist:{...xe.checklist,dischargePlanning:fe,lastUpdatedAt:we},lastUpdatedAt:we}:xe))},[Q]);m.useEffect(()=>{(async()=>{try{await Ih({roundsHudState:G})}catch(fe){console.warn("‚ö†Ô∏è Failed to persist HUD state",fe)}})()},[G]);const Ie={patients:n,loading:c,selectedPatientId:d,selectedPatient:te,hudState:G,intakeParsing:f,activeWard:N,isPatientListCollapsed:j,clinicians:o,setSelectedPatientId:h,addPatient:k,quickAddPatient:L,updatePatient:M,applyWardDiff:P,undoLastWardUpdate:K,startWardConversation:$,continueWardConversation:O,applyWardConversation:ee,discardWardConversation:V,runWardDictation:W,getWardConversationSession:q,refresh:S,markDischarged:H,addIntakeNote:R,setActiveWard:v,deletePatient:Y,togglePatientList:X,navigateToPatient:le,addClinician:he,updateClinician:ve,removeClinician:ke,assignClinicianToPatient:Le,unassignClinicianFromPatient:Be,notionAvailable:C,addBillingEntry:Re,updateBillingEntry:re,deleteBillingEntry:Me,markBillingEntered:Pe,updateChecklist:be,toggleDischargePlanning:ce};return t.jsx(cw.Provider,{value:Ie,children:s})};class Zo{static instance=null;cache=null;extractionInProgress=!1;lastExtractionAttempt=0;CACHE_TTL=6e4;MIN_EXTRACTION_INTERVAL=2e3;MAX_RETRIES=2;constructor(){console.log("üèóÔ∏è PatientDataCacheService initialized")}static getInstance(){return Zo.instance||(Zo.instance=new Zo),Zo.instance}getCachedData(){if(!this.cache)return console.log("üì≠ Patient data cache is empty"),null;const r=Date.now()-this.cache.timestamp;if(r>this.CACHE_TTL)return console.log(`‚è∞ Patient data cache expired (age: ${Math.round(r/1e3)}s)`),null;const a=window.location.href;return this.cache.url!==a?(console.log("üîÑ Patient data cache invalidated - URL changed"),null):!this.cache.isValid||!this.cache.data?(console.log("‚ùå Patient data cache is invalid"),null):(console.log(`‚úÖ Patient data cache hit (age: ${Math.round(r/1e3)}s)`),this.cache.data)}async extractAndCache(){const e=Date.now();if(e-this.lastExtractionAttempt<this.MIN_EXTRACTION_INTERVAL){console.log("‚è±Ô∏è Skipping patient extraction - too soon since last attempt");return}if(this.extractionInProgress){console.log("‚è≥ Patient extraction already in progress - skipping");return}this.extractionInProgress=!0,this.lastExtractionAttempt=e;try{console.log("üîç Background patient data extraction started");const r=performance.now(),a=await this.performExtraction(),n=Math.round(performance.now()-r);console.log(`‚úÖ Background patient extraction completed in ${n}ms`),this.cache={data:a,timestamp:Date.now(),url:window.location.href,isValid:a!==null},a?console.log("üíæ Patient data cached:",{name:a.name,id:a.id,duration:`${n}ms`}):console.log("üì≠ No patient data found - cached null result")}catch(r){console.error("‚ùå Background patient extraction failed:",r),this.cache={data:null,timestamp:Date.now(),url:window.location.href,isValid:!1}}finally{this.extractionInProgress=!1}}async performExtraction(){for(let e=1;e<=this.MAX_RETRIES;e++)try{const r=await this.getActiveEmrTabId(),a=await this.requestPatientDataViaBackground(r??void 0);if(a?.success&&a?.data){const n=a.data,i=n.name&&n.name.trim()!=="",o=n.id&&n.id.trim()!=="";if(i||o)return{name:n.name||"Patient",id:n.id||"No ID",dob:n.dob||"",age:n.age||"",phone:n.phone,email:n.email,medicare:n.medicare,insurance:n.insurance,address:n.address,extractedAt:n.extractedAt||Date.now()};console.warn("Extracted patient data lacked name and ID, skipping cache update.")}else console.warn("Patient extraction succeeded without usable data",a?.error)}catch(r){if(console.warn("Patient extraction attempt failed:",r),e<this.MAX_RETRIES){const a=500*e;await new Promise(n=>setTimeout(n,a))}}return null}invalidateCache(){console.log("üóëÔ∏è Patient data cache invalidated"),this.cache=null}async refreshCache(){this.invalidateCache(),await this.extractAndCache()}isCacheValid(){if(!this.cache)return!1;const r=Date.now()-this.cache.timestamp,a=window.location.href;return this.cache.isValid&&r<this.CACHE_TTL&&this.cache.url===a}getCacheStats(){if(!this.cache)return{cached:!1};const e=Date.now()-this.cache.timestamp;return{cached:!0,valid:this.isCacheValid(),age:Math.round(e/1e3),hasData:this.cache.data!==null,url:this.cache.url,patientName:this.cache.data?.name||"N/A"}}async sendMessageToTab(e,r){return new Promise((a,n)=>{chrome.tabs.sendMessage(e,r,i=>{const o=chrome.runtime.lastError;o?n(new Error(o.message)):a(i)})})}isEmrUrl(e){if(!e)return!1;try{return new URL(e).hostname.includes("my.xestro.com")}catch{return!1}}async getActiveEmrTabId(){const[e]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});return e?.id&&this.isEmrUrl(e.url)?e.id:(await chrome.tabs.query({})).find(n=>n.id&&this.isEmrUrl(n.url))?.id??null}async requestPatientDataViaBackground(e){return new Promise((r,a)=>{chrome.runtime.sendMessage({type:"EXECUTE_ACTION_ACTIVE_EMR",action:"extract-patient-data",tabId:e},n=>{const i=chrome.runtime.lastError;i?a(new Error(i.message)):r(n)})})}}const Y3="http://127.0.0.1:5858";class Zl{static instance=null;apiBase;constructor(e=Y3){this.apiBase=e}static getInstance(){return Zl.instance||(Zl.instance=new Zl),Zl.instance}async request(e,r){const a=`${this.apiBase}${e}`,n=await fetch(a,{...r,headers:{"Content-Type":"application/json",...r?.headers||{}}});if(!n.ok){const i=await n.text();throw new Error(`Mobile jobs API error (${n.status}): ${i||n.statusText}`)}return await n.json()}async listJobs(){return(await this.request("/jobs")).jobs}async getJob(e){return await this.request(`/jobs/${e}`)}async deleteJob(e){await this.request(`/jobs/${e}`,{method:"DELETE"})}async markAttached(e,r,a,n){await this.request(`/jobs/${e}/attach`,{method:"POST",body:JSON.stringify({session_id:r,patient_name:a,agent_type:n})})}}const Pd=Zl.getInstance(),X3=s=>{const e=s.issuesAdded.length>0||s.issuesUpdated.length>0||s.investigationsAdded.length>0||s.investigationsUpdated.length>0||s.tasksAdded.length>0||s.tasksUpdated.length>0||s.tasksCompletedById.length>0||(s.tasksCompletedByText?.length??0)>0||!!s.eddUpdate?.newDate||(s.checklistSkips?.length??0)>0||!!s.admissionFlags;return t.jsxs("div",{className:"space-y-2 text-sm text-gray-800",children:[s.issuesAdded.length>0&&t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold",children:"Issues to add"}),t.jsx("ul",{className:"list-disc pl-5",children:s.issuesAdded.map(r=>t.jsx("li",{children:r.title},r.id))})]}),s.issuesUpdated.length>0&&t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold",children:"Issue updates"}),t.jsx("ul",{className:"list-disc pl-5",children:s.issuesUpdated.map(r=>t.jsxs("li",{children:[r.newStatus&&t.jsxs("span",{children:["Status ‚Üí ",r.newStatus,". "]}),r.newSubpoints?.length?`${r.newSubpoints.length} new notes`:null]},r.issueId))})]}),s.investigationsAdded.length>0&&t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold",children:"Investigations to add"}),t.jsx("ul",{className:"list-disc pl-5",children:s.investigationsAdded.map(r=>t.jsx("li",{children:r.name},r.id))})]}),s.investigationsUpdated.length>0&&t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold",children:"Investigation updates"}),t.jsx("ul",{className:"list-disc pl-5",children:s.investigationsUpdated.map(r=>t.jsxs("li",{children:[r.newLabValues?.length?`${r.newLabValues.length} lab values`:"",r.newSummaryText?`Summary: ${r.newSummaryText}`:""]},r.investigationId))})]}),s.tasksAdded.length>0&&t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold",children:"Tasks to add"}),t.jsx("ul",{className:"list-disc pl-5",children:s.tasksAdded.map(r=>t.jsx("li",{children:r.text},r.id))})]}),(s.tasksCompletedById.length>0||(s.tasksCompletedByText?.length??0)>0)&&t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold",children:"Tasks to mark done"}),t.jsxs("ul",{className:"list-disc pl-5",children:[s.tasksCompletedById.map(r=>t.jsxs("li",{children:["Task #",r]},r)),s.tasksCompletedByText?.map(r=>t.jsx("li",{children:r},r))]})]}),s.tasksUpdated.length>0&&t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold",children:"Task edits"}),t.jsx("ul",{className:"list-disc pl-5",children:s.tasksUpdated.map(r=>t.jsx("li",{children:r.newText||"Update task"},r.taskId))})]}),s.eddUpdate?.newDate&&t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold",children:"Expected discharge date"}),t.jsx("p",{className:"pl-1",children:s.eddUpdate.oldDate?`Update EDD to ${s.eddUpdate.newDate} (was ${s.eddUpdate.oldDate})`:`Set EDD to ${s.eddUpdate.newDate}`})]}),s.admissionFlags&&t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold",children:"Admission flags"}),t.jsxs("ul",{className:"list-disc pl-5",children:["dvtProphylaxisConsidered"in s.admissionFlags&&s.admissionFlags.dvtProphylaxisConsidered!==void 0&&t.jsxs("li",{children:["DVT prophylaxis considered: ",s.admissionFlags.dvtProphylaxisConsidered?"yes":"no"]}),"followupArranged"in s.admissionFlags&&s.admissionFlags.followupArranged!==void 0&&t.jsxs("li",{children:["Follow-up arranged: ",s.admissionFlags.followupArranged?"yes":"no"]})]})]}),(s.checklistSkips?.length??0)>0&&t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold",children:"Skip for this admission"}),t.jsx("ul",{className:"list-disc pl-5",children:s.checklistSkips?.map(r=>t.jsxs("li",{children:[r.itemId," ",r.condition?`(${r.condition})`:"",r.reason?` ‚Äì ${r.reason}`:""]},`${r.condition||"base"}-${r.itemId}`))})]}),!e&&t.jsx("p",{className:"text-sm text-gray-500",children:"No changes detected."})]})},Aw=({open:s,onClose:e,patient:r})=>{const[a,n]=m.useState(""),[i,o]=m.useState(!1),[l,c]=m.useState(null),[A,d]=m.useState(null),[h,f]=m.useState(!1),[u,x]=m.useState(null),[b,N]=m.useState(null),[v,j]=m.useState([]),[I,C]=m.useState(null),{runWardDictation:E,applyWardConversation:T,discardWardConversation:Q,applyWardDiff:D}=yn(),k=()=>{I&&Q(I),C(null),c(null),N(null),j([]),x(null),d(null)},R=$=>{C($.session.id),c($.turn.diff),N($.turn.assistantMessage||null),j($.turn.humanSummary||[])},w=Hp({onRecordingComplete:async $=>{f(!0),x("Transcribing audio‚Ä¶");try{const O=await Ei.getInstance().transcribeAudio($,void 0,"rounds-ward-update");n(O),x("Parsing ward update‚Ä¶");const W=await E(r.id,O,I||void 0);R(W),x("Ready to apply")}catch(O){d(O instanceof Error?O.message:"Failed to transcribe ward update")}finally{f(!1)}},onError:$=>{f(!1),x(null),d($.message||"Recording failed")}});if(!s)return null;const L=async()=>{if(a.trim()){o(!0),d(null);try{const $=await E(r.id,a,I||void 0);R($),x("Ready to apply")}catch($){d($ instanceof Error?$.message:"Failed to parse update")}finally{o(!1)}}},M=()=>{w.isRecording?w.stopRecording():(d(null),k(),x("Recording‚Ä¶"),w.startRecording())},P=async()=>{l&&(I?await T(I,a):await D(r.id,l,a),k(),n(""),e())},K=()=>{k(),n(""),e()};return t.jsxs("div",{className:"fixed inset-x-0 bottom-0 z-50 animate-in slide-in-from-bottom duration-200",children:[t.jsx("div",{className:"fixed inset-0 bg-gradient-to-t from-black/20 to-transparent pointer-events-none","aria-hidden":"true"}),t.jsxs("div",{className:"relative bg-white border-t border-gray-200 shadow-lg max-h-[60vh] overflow-y-auto",children:[t.jsxs("div",{className:"sticky top-0 bg-white border-b border-gray-100 px-4 py-2 flex items-center justify-between",children:[t.jsx("div",{className:"flex items-center gap-3",children:t.jsxs("div",{children:[t.jsx("span",{className:"text-xs text-gray-500",children:"Ward update"}),t.jsx("span",{className:"mx-2 text-gray-300",children:"‚Ä¢"}),t.jsx("span",{className:"text-sm font-medium text-gray-900",children:r.name})]})}),t.jsx("button",{onClick:K,className:"p-1.5 rounded-full hover:bg-gray-100 text-gray-400 hover:text-gray-600 transition-colors","aria-label":"Close ward update",children:t.jsx(es,{className:"w-4 h-4"})})]}),t.jsxs("div",{className:"p-4 space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[t.jsx(ye,{variant:w.isRecording?"danger":"primary",size:"sm",startIcon:w.isRecording?Fy:$r,onClick:M,className:"shrink-0",children:w.isRecording?"Stop":"Dictate"}),u&&t.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[h&&t.jsx(Za,{className:"w-3.5 h-3.5 animate-spin"}),t.jsx("span",{children:u})]})]}),t.jsx("textarea",{className:"w-full rounded-lg border border-gray-200 px-3 py-2 text-sm min-h-[100px] resize-y focus:outline-none focus:ring-2 focus:ring-violet-500/30 focus:border-violet-400 transition-colors",placeholder:"Dictation transcript...",value:a,onChange:$=>n($.target.value)}),t.jsxs("div",{className:"flex items-center justify-between gap-4 flex-wrap",children:[t.jsx("p",{className:"text-xs text-gray-400 max-w-[200px]",children:"Output stays local; structured diff is previewed before apply."}),t.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[t.jsx(ye,{variant:"ghost",size:"sm",onClick:K,children:"Cancel"}),t.jsx(ye,{size:"sm",onClick:L,disabled:i||!a.trim()||h,isLoading:i||h,children:h?"Transcribing":i?"Parsing":"Parse"})]})]}),A&&t.jsx("div",{className:"text-sm text-rose-600 bg-rose-50 rounded-lg px-3 py-2",children:A}),b&&t.jsxs("div",{className:"border border-blue-100 rounded-lg p-3 bg-blue-50/70 space-y-1",children:[t.jsx("div",{className:"text-sm font-semibold text-blue-900",children:"Assistant"}),t.jsx("p",{className:"text-sm text-blue-900",children:b}),v.length>0&&t.jsx("ul",{className:"list-disc pl-5 text-sm text-blue-900",children:v.map($=>t.jsx("li",{children:$},$))})]}),l&&t.jsxs("div",{className:"border border-gray-200 rounded-lg p-3 bg-gray-50 space-y-2",children:[t.jsx("div",{className:"text-sm font-semibold text-gray-900",children:"Proposed updates"}),X3(l),t.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[t.jsx(ye,{variant:"ghost",size:"sm",onClick:k,children:"Reset"}),t.jsx(ye,{variant:"success",size:"sm",onClick:P,children:"Apply"})]})]})]})]})]})},H0=[{key:"post-cardiac-surgery",label:"Post cardiac surgery",items:[{text:"Remove IDC (Day 2)",day:2},{text:"Remove ICC (Day 2)",day:2},{text:"Remove CVC (Day 3)",day:3},{text:"Remove pacing wires (Day 4)",day:4},{text:"Repeat bloods and CXR (Day 5)",day:5}]}],Z3="~/Library/Mobile Documents/com~apple~CloudDocs/Shortcuts/Operator/nok_calls.json",eT=s=>{const e=s.site?.trim(),r=s.bed?.trim(),a=(s.name||"").trim().split(/\s+/).filter(Boolean),n=a.length>1?a[a.length-1]:a[0]||"",o=[(a.length>1,a[0]?.[0]),n].filter(Boolean).join(" ").trim();return[...[e,r?`Bed ${r}`:null].filter(Boolean),o].filter(Boolean).join(" ‚Ä¢ ")},tT=s=>{const e=s.filter(r=>r.nextOfKin?.phone?.trim()).map(r=>{const a=r.nextOfKin.phone.trim(),n=r.nextOfKin.relation?.trim();return{id:r.id,label:eT(r),phone:a,...n?{relation:n}:{}}});return{updated_at:Rt(),entries:e}},sT=async(s,e)=>{const r=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),a=URL.createObjectURL(r);try{if(typeof chrome<"u"&&chrome.downloads?.download)await chrome.downloads.download({url:a,filename:e,saveAs:!1});else{const n=document.createElement("a");n.href=a,n.download=e,document.body.appendChild(n),n.click(),document.body.removeChild(n)}}finally{URL.revokeObjectURL(a)}},rT={exportList:async(s,e=Z3)=>{const r=tT(s);await sT(r,e)}},om=[{code:"110",description:"Initial consultation - referred patient (rooms)",fee:157.55,category:"consult",common:1},{code:"116",description:"Subsequent consultation (rooms)",fee:78.8,category:"consult",common:2},{code:"119",description:"Minor subsequent consultation (rooms)",fee:39.4,category:"consult",common:3},{code:"132",description:"Consultant physician attendance - inpatient",fee:108.35,category:"inpatient",common:4},{code:"133",description:"Consultant physician attendance - inpatient (subsequent)",fee:54.2,category:"inpatient",common:5},{code:"38200",description:"Coronary angiography",fee:535.55,category:"procedure",common:10},{code:"38203",description:"Coronary angiography with LV angiography",fee:669.45,category:"procedure",common:11},{code:"38206",description:"Right heart catheterisation",fee:401.65,category:"procedure",common:12},{code:"38209",description:"Combined left and right heart catheterisation",fee:803.3,category:"procedure",common:13},{code:"38212",description:"Coronary angiography - graft study",fee:669.45,category:"procedure",common:14},{code:"38306",description:"PCI - single vessel",fee:1139.8,category:"procedure",common:20},{code:"38309",description:"PCI - additional vessel",fee:455.9,category:"procedure",common:21},{code:"38312",description:"PCI with stent - single vessel",fee:1481.7,category:"procedure",common:22},{code:"38315",description:"PCI with stent - additional vessel",fee:592.7,category:"procedure",common:23},{code:"38350",description:"TAVI (Transcatheter aortic valve implantation)",fee:2500,category:"procedure",common:30},{code:"38353",description:"mTEER (Transcatheter mitral valve repair)",fee:2500,category:"procedure",common:31},{code:"38356",description:"ASD/PFO closure",fee:1200,category:"procedure",common:32},{code:"38359",description:"Left atrial appendage closure",fee:1500,category:"procedure",common:33},{code:"38400",description:"Permanent pacemaker insertion - single chamber",fee:1200,category:"procedure",common:40},{code:"38403",description:"Permanent pacemaker insertion - dual chamber",fee:1400,category:"procedure",common:41},{code:"38406",description:"ICD insertion",fee:1800,category:"procedure",common:42},{code:"38409",description:"CRT-D insertion",fee:2200,category:"procedure",common:43},{code:"38412",description:"Generator change",fee:600,category:"procedure",common:44},{code:"38415",description:"Lead revision",fee:800,category:"procedure",common:45},{code:"11712",description:"Transthoracic echocardiography (TTE)",fee:246.8,category:"procedure",common:50},{code:"11714",description:"Transoesophageal echocardiography (TOE)",fee:370.2,category:"procedure",common:51},{code:"11721",description:"Stress echocardiography",fee:370.2,category:"procedure",common:52},{code:"11700",description:"ECG interpretation",fee:22.5,category:"other",common:53},{code:"11709",description:"Holter monitoring - interpretation",fee:72.9,category:"other",common:54},{code:"38500",description:"DC cardioversion",fee:265.3,category:"procedure",common:60},{code:"38503",description:"EP study",fee:1200,category:"procedure",common:61},{code:"38506",description:"Catheter ablation - simple",fee:1600,category:"procedure",common:62},{code:"38509",description:"Catheter ablation - complex (AF)",fee:2400,category:"procedure",common:63},{code:"91822",description:"Telehealth initial consultation",fee:157.55,category:"consult",common:70},{code:"91823",description:"Telehealth subsequent consultation",fee:78.8,category:"consult",common:71},{code:"14224",description:"Hospital initiation - complex (cardiac)",fee:300,category:"inpatient",common:80}],aT=()=>[...om].sort((s,e)=>(s.common??999)-(e.common??999)),dw=s=>{const e=s.toLowerCase().trim();return e?om.filter(r=>r.code.toLowerCase().includes(e)||r.description.toLowerCase().includes(e)).sort((r,a)=>(r.common??999)-(a.common??999)):aT().slice(0,10)},V0={pending:{label:"Pending",color:"text-amber-600 bg-amber-50 border-amber-200",icon:_a},entered:{label:"Entered",color:"text-green-600 bg-green-50 border-green-200",icon:Ms},rejected:{label:"Rejected",color:"text-red-600 bg-red-50 border-red-200",icon:or}},nT=({patient:s})=>{const{addBillingEntry:e,updateBillingEntry:r,deleteBillingEntry:a,markBillingEntered:n,notionAvailable:i}=yn(),[o,l]=m.useState(!1),[c,A]=m.useState(!1),[d,h]=m.useState(""),[f,u]=m.useState(!1),[x,b]=m.useState(!1),[N,v]=m.useState(""),[j,I]=m.useState(""),[C,E]=m.useState(""),[T,Q]=m.useState(new Date().toISOString().slice(0,10)),[D,k]=m.useState(""),R=s.billingEntries||[],w=R.filter(S=>S.status==="pending").length,L=R.filter(S=>S.status==="entered").length,M=m.useMemo(()=>d.trim()?dw(d):om.slice(0,10),[d]),P=()=>{h(""),v(""),I(""),E(""),Q(new Date().toISOString().slice(0,10)),k(""),b(!1),u(!1),A(!1)},K=S=>{const H={mbsCode:S.code,description:S.description,fee:S.fee,serviceDate:T,status:"pending",notes:D.trim()||void 0};e(s.id,H),P()},$=()=>{if(!N.trim()||!j.trim())return;const S={mbsCode:N.trim(),description:j.trim(),fee:C?parseFloat(C):void 0,serviceDate:T,status:"pending",notes:D.trim()||void 0};e(s.id,S),P()},O=async S=>{await n(s.id,S)},W=S=>{window.confirm("Delete this billing entry?")&&a(s.id,S)},ee=S=>S?`$${S.toFixed(2)}`:"-",V=S=>`https://www.notion.so/${S.replace(/-/g,"")}`,q=R.filter(S=>S.status==="pending").reduce((S,H)=>S+(H.fee||0),0);return t.jsxs("div",{className:"rounded-xl border border-blue-500 p-4 bg-white shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between cursor-pointer",onClick:()=>l(!o),children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Hu,{className:"w-4 h-4 text-blue-600"}),t.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Billing"}),R.length>0&&t.jsxs("span",{className:"text-xs text-gray-500",children:["(",w," pending, ",L," entered)"]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[i&&t.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700",children:"Notion"}),t.jsx(ps,{className:`w-4 h-4 text-gray-400 transition-transform ${o?"rotate-0":"-rotate-90"}`})]})]}),o&&t.jsxs("div",{className:"mt-3 space-y-3",children:[R.length>0&&q>0&&t.jsxs("div",{className:"text-xs text-gray-600 bg-gray-50 rounded-lg px-3 py-2",children:["Pending total: ",t.jsx("span",{className:"font-medium",children:ee(q)})]}),t.jsx("div",{className:"space-y-2",children:R.map(S=>{const H=V0[S.status].icon;return t.jsx("div",{className:`border rounded-lg px-3 py-2 ${V0[S.status].color}`,children:t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"font-mono text-sm font-medium",children:S.mbsCode}),t.jsx(H,{className:"w-3 h-3"})]}),t.jsx("p",{className:"text-xs text-gray-700 truncate",children:S.description}),t.jsxs("div",{className:"flex items-center gap-3 mt-1 text-[10px] text-gray-500",children:[t.jsx("span",{children:S.serviceDate}),S.fee&&t.jsx("span",{children:ee(S.fee)}),S.notes&&t.jsx("span",{className:"italic truncate",children:S.notes}),i&&S.status==="entered"&&S.notionId&&t.jsxs("a",{className:"inline-flex items-center gap-1 text-purple-700 hover:text-purple-800 hover:underline",href:V(S.notionId),target:"_blank",rel:"noreferrer noopener",title:"Open in Notion",onClick:Y=>Y.stopPropagation(),children:["Notion synced ",t.jsx(Po,{className:"w-3 h-3"})]}),i&&S.status==="entered"&&!S.notionId&&S.notionSyncError&&t.jsx("span",{className:"text-red-600",title:S.notionSyncError,children:"Notion sync failed"})]})]}),t.jsxs("div",{className:"flex items-center gap-1 ml-2",children:[S.status==="pending"&&t.jsx("button",{onClick:()=>O(S.id),className:"p-1 rounded hover:bg-green-100 text-green-600",title:"Mark as entered",children:t.jsx(Ms,{className:"w-4 h-4"})}),t.jsx("button",{onClick:()=>W(S.id),className:"p-1 rounded hover:bg-red-100 text-red-400",title:"Delete",children:t.jsx(es,{className:"w-3 h-3"})})]})]})},S.id)})}),c?t.jsxs("div",{className:"border border-dashed border-gray-200 rounded-lg p-3 space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-xs uppercase text-gray-500",children:"Add billing item"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>b(!1),className:`text-[10px] px-2 py-0.5 rounded ${x?"text-gray-500 hover:bg-gray-100":"bg-blue-100 text-blue-700"}`,children:"MBS Search"}),t.jsx("button",{onClick:()=>b(!0),className:`text-[10px] px-2 py-0.5 rounded ${x?"bg-blue-100 text-blue-700":"text-gray-500 hover:bg-gray-100"}`,children:"Custom"})]})]}),x?t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-[10px] text-gray-500",children:"Code"}),t.jsx("input",{className:"w-full rounded-md border px-2 py-1 text-sm",placeholder:"e.g., 23010",value:N,onChange:S=>v(S.target.value)})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-[10px] text-gray-500",children:"Fee (optional)"}),t.jsx("input",{type:"number",step:"0.01",className:"w-full rounded-md border px-2 py-1 text-sm",placeholder:"0.00",value:C,onChange:S=>E(S.target.value)})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-[10px] text-gray-500",children:"Description"}),t.jsx("input",{className:"w-full rounded-md border px-2 py-1 text-sm",placeholder:"Description",value:j,onChange:S=>I(S.target.value)})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-[10px] text-gray-500",children:"Service Date"}),t.jsx("input",{type:"date",className:"w-full rounded-md border px-2 py-1 text-sm",value:T,onChange:S=>Q(S.target.value)})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-[10px] text-gray-500",children:"Notes (optional)"}),t.jsx("input",{className:"w-full rounded-md border px-2 py-1 text-sm",placeholder:"Notes",value:D,onChange:S=>k(S.target.value)})]})]}),t.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[t.jsx(ye,{size:"xs",variant:"ghost",onClick:P,children:"Cancel"}),t.jsx(ye,{size:"xs",onClick:$,disabled:!N.trim()||!j.trim(),children:"Add"})]})]}):t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"relative",children:[t.jsx(cl,{className:"absolute left-2 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),t.jsx("input",{className:"w-full rounded-md border px-8 py-2 text-sm",placeholder:"Search MBS code or description...",value:d,onChange:S=>{h(S.target.value),u(!0)},onFocus:()=>u(!0)})]}),f&&t.jsx("div",{className:"max-h-48 overflow-y-auto border rounded-lg divide-y",children:M.length===0?t.jsx("div",{className:"p-3 text-sm text-gray-500 text-center",children:"No codes found. Try custom entry."}):M.map(S=>t.jsxs("button",{onClick:()=>K(S),className:"w-full text-left p-2 hover:bg-blue-50 transition-colors",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"font-mono text-sm font-medium text-blue-600",children:S.code}),S.fee&&t.jsx("span",{className:"text-xs text-gray-500",children:ee(S.fee)})]}),t.jsx("p",{className:"text-xs text-gray-600 truncate",children:S.description})]},S.code))}),t.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-[10px] text-gray-500",children:"Service Date"}),t.jsx("input",{type:"date",className:"w-full rounded-md border px-2 py-1 text-sm",value:T,onChange:S=>Q(S.target.value)})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-[10px] text-gray-500",children:"Notes (optional)"}),t.jsx("input",{className:"w-full rounded-md border px-2 py-1 text-sm",placeholder:"Notes",value:D,onChange:S=>k(S.target.value)})]})]})]}),!x&&t.jsx("div",{className:"flex justify-end",children:t.jsx(ye,{size:"xs",variant:"ghost",onClick:P,children:"Cancel"})})]}):t.jsxs("button",{onClick:()=>A(!0),className:"w-full flex items-center justify-center gap-1 py-2 text-sm text-blue-600 hover:bg-blue-50 rounded-lg border border-dashed border-blue-200 transition-colors",children:[t.jsx(Fr,{className:"w-4 h-4"}),"Add billing item"]}),R.length===0&&!c&&t.jsx("p",{className:"text-sm text-gray-500 text-center py-2",children:"No billing items yet."})]})]})},Il=[{key:"medicationReconciliation",label:"Medication reconciliation",description:"Medications reviewed and reconciled"},{key:"dischargeInstructions",label:"Discharge instructions",description:"Patient/family given discharge instructions"},{key:"followupScheduled",label:"Follow-up scheduled",description:"Outpatient follow-up appointment booked"},{key:"transportArranged",label:"Transport arranged",description:"Transport home or to facility arranged"},{key:"gpLetterSent",label:"GP letter sent",description:"Discharge summary sent to GP"}],$0=[{key:"dischargePlanning",label:"Discharge planning",color:"bg-purple-100 text-purple-700 border-purple-200"},{key:"familyMeeting",label:"Family meeting needed",color:"bg-orange-100 text-orange-700 border-orange-200"},{key:"socialWork",label:"Social work consult",color:"bg-pink-100 text-pink-700 border-pink-200"},{key:"palliativeCare",label:"Palliative care",color:"bg-indigo-100 text-indigo-700 border-indigo-200"}],iT=({patient:s})=>{const{updateChecklist:e,toggleDischargePlanning:r}=yn(),[a,n]=m.useState(!1),i=s.checklist||{},o=i.dischargePlanning||!1,l=Il.filter(h=>i[h.key]).length,c=$0.filter(h=>i[h.key]).length,A=h=>{e(s.id,{[h]:!i[h]})},d=()=>{r(s.id,!o)};return t.jsxs("div",{className:"rounded-xl border border-purple-400 p-4 bg-white shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between cursor-pointer",onClick:()=>n(!a),children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(N2,{className:"w-4 h-4 text-purple-600"}),t.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Admission & Discharge"}),(c>0||o)&&t.jsxs("span",{className:"text-xs text-gray-500",children:["(",c," flag",c!==1?"s":"",")"]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[o&&t.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-purple-100 text-purple-700 flex items-center gap-1",children:[t.jsx(Sm,{className:"w-3 h-3"}),"D/C ",l,"/",Il.length]}),t.jsx(ps,{className:`w-4 h-4 text-gray-400 transition-transform ${a?"rotate-0":"-rotate-90"}`})]})]}),a&&t.jsxs("div",{className:"mt-3 space-y-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(B2,{className:"w-3 h-3 text-gray-400"}),t.jsx("span",{className:"text-xs uppercase text-gray-500",children:"Admission Flags"})]}),t.jsx("div",{className:"flex flex-wrap gap-2",children:$0.map(h=>t.jsx("button",{onClick:()=>A(h.key),className:`px-2.5 py-1 text-xs rounded-full border transition-all ${i[h.key]?h.color:"bg-gray-50 text-gray-400 border-gray-200 hover:bg-gray-100"}`,children:h.label},h.key))})]}),t.jsx("div",{className:"border-t border-gray-100 pt-3",children:t.jsxs("label",{className:"flex items-center gap-3 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:o,onChange:d,className:"w-4 h-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Discharge planning active"}),t.jsx("p",{className:"text-xs text-gray-500",children:"Enable to show discharge checklist"})]}),t.jsx(Sm,{className:`w-4 h-4 ${o?"text-purple-600":"text-gray-300"}`})]})}),o&&t.jsxs("div",{className:"border-t border-gray-100 pt-3 space-y-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Sm,{className:"w-3 h-3 text-purple-500"}),t.jsx("span",{className:"text-xs uppercase text-gray-500",children:"Discharge Checklist"}),t.jsxs("span",{className:"text-xs text-gray-400",children:[l,"/",Il.length," complete"]})]}),t.jsx("div",{className:"space-y-1",children:Il.map(h=>t.jsxs("label",{className:`flex items-start gap-3 p-2 rounded-lg cursor-pointer transition-colors ${i[h.key]?"bg-green-50":"hover:bg-gray-50"}`,children:[t.jsx("input",{type:"checkbox",checked:!!i[h.key],onChange:()=>A(h.key),className:"mt-0.5 w-4 h-4 rounded border-gray-300 text-green-600 focus:ring-green-500"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("span",{className:`text-sm ${i[h.key]?"text-green-700 font-medium":"text-gray-700"}`,children:h.label}),h.description&&t.jsx("p",{className:"text-xs text-gray-500",children:h.description})]})]},h.key))}),t.jsxs("div",{className:"mt-3",children:[t.jsx("div",{className:"h-2 bg-gray-100 rounded-full overflow-hidden",children:t.jsx("div",{className:"h-full bg-gradient-to-r from-purple-500 to-green-500 transition-all duration-300",style:{width:`${l/Il.length*100}%`}})}),l===Il.length&&t.jsx("p",{className:"text-xs text-green-600 font-medium mt-1 text-center",children:"‚úì Ready for discharge"})]})]})]})]})},ho=()=>({name:"",date:"",notes:"",showDayCounter:!0,checklistKey:""}),po=()=>({name:"",startDate:"",stopDate:"",notes:""}),K0=(s,e)=>{if(!s)return"";const r=new Date(s);if(Number.isNaN(r.getTime()))return"";const a=new Date(r);return a.setDate(a.getDate()+e-1),a.toISOString().split("T")[0]},oT=({patient:s})=>{const{patients:e,updatePatient:r,clinicians:a,addClinician:n,assignClinicianToPatient:i,unassignClinicianFromPatient:o}=yn(),[l,c]=m.useState(s.mrn),[A,d]=m.useState(s.bed),[h,f]=m.useState(s.oneLiner),[u,x]=m.useState(s.name),[b,N]=m.useState(""),[v,j]=m.useState(""),[I,C]=m.useState(""),[E,T]=m.useState(""),[Q,D]=m.useState(""),[k,R]=m.useState(""),[w,L]=m.useState(""),[M,P]=m.useState(""),[K,$]=m.useState(""),[O,W]=m.useState(!1),[ee,V]=m.useState(""),q=["1 South","1 West","ICU","3 Central","1 Central","Other"],[S,H]=m.useState(s.site&&q.includes(s.site)?s.site:s.site?"Other":""),[Y,te]=m.useState(s.site&&!q.includes(s.site)?s.site:""),[G,X]=m.useState(s.nextOfKin?.name||""),[le,he]=m.useState(s.nextOfKin?.relation||""),[ve,ke]=m.useState(s.nextOfKin?.phone||""),[Le,Be]=m.useState(!1),[Re,re]=m.useState(!1),[Me,Pe]=m.useState(!1),[be,ce]=m.useState(!1),[Ie,pe]=m.useState(!1),[fe,we]=m.useState(!1),[de,xe]=m.useState({}),[Ne,it]=m.useState(null),[st,$e]=m.useState({}),[Xe,Ze]=m.useState({}),[ct,pt]=m.useState({}),[dt,xt]=m.useState({}),[Se,qe]=m.useState({}),[ut,Ge]=m.useState(Date.now()),[rt,Tt]=m.useState(null),[At,mt]=m.useState(null),[Qt,ts]=m.useState(null),[Yt,Ht]=m.useState(new Set),[Es,vt]=m.useState(!1),[Ft,Hs]=m.useState(!1),[ks,Is]=m.useState({}),[Nt,gs]=m.useState(null),[Vt,Kr]=m.useState(""),[Kt,Js]=m.useState(""),[fs,Zs]=m.useState(!1),[Ot,qt]=m.useState(""),[ur,kr]=m.useState(!1),[Zr,Qa]=m.useState("24h"),Oa=()=>Be(ie=>!ie),tn=()=>Be(!0);m.useEffect(()=>{x(s.name),c(s.mrn),d(s.bed),f(s.oneLiner),H(s.site&&q.includes(s.site)?s.site:s.site?"Other":""),te(s.site&&!q.includes(s.site)?s.site:""),X(s.nextOfKin?.name||""),he(s.nextOfKin?.relation||""),ke(s.nextOfKin?.phone||""),Hs(!1),vt(!1),Is({}),gs(null)},[s.id,s.name,s.mrn,s.bed,s.oneLiner,s.site]),m.useEffect(()=>{const ie=setInterval(()=>Ge(Date.now()),9e5);return()=>clearInterval(ie)},[]),m.useEffect(()=>{fe&&Tt(null)},[fe]),m.useEffect(()=>{Ht(new Set)},[s.id]),m.useEffect(()=>{if(!rt)return;const ie=Qe=>{const _e=document.querySelector(`[data-issue-menu-root="${rt}"]`);_e&&_e.contains(Qe.target)||Tt(null)};return document.addEventListener("mousedown",ie),()=>document.removeEventListener("mousedown",ie)},[rt]),m.useEffect(()=>{Ft&&gs(null)},[Ft]);const Ha=()=>{r(s.id,ie=>({...ie,name:u.trim()||ie.name,mrn:l.trim(),bed:A.trim(),oneLiner:h,lastUpdatedAt:Rt()}))},sn=async()=>{const ie=G.trim(),Qe=le.trim(),_e=ve.trim(),zt={...s,nextOfKin:ie||Qe||_e?{name:ie,relation:Qe,phone:_e}:void 0,lastUpdatedAt:Rt()};await r(s.id,()=>zt);try{await rT.exportList(e.map(ot=>ot.id===s.id?zt:ot))}catch(ot){console.warn("‚ö†Ô∏è Failed to export NOK call list",ot)}},Mn=()=>{const ie={};s.investigations.forEach(Qe=>{ie[Qe.id]={name:Qe.name,summary:Qe.summary||"",date:(Qe.lastUpdatedAt||"").slice(0,10)}}),Is(ie),Hs(!0)},lr=()=>{Hs(!1),Is({})},os=()=>{r(s.id,ie=>({...ie,investigations:ie.investigations.map(Qe=>{const _e=ks[Qe.id];if(!_e)return Qe;const St=_e.date?new Date(_e.date):null,zt=St instanceof Date&&!Number.isNaN(St.valueOf());return{...Qe,name:_e.name.trim()||Qe.name,summary:(_e.summary||"").trim()?(_e.summary||"").trim():void 0,lastUpdatedAt:zt?St.toISOString():Qe.lastUpdatedAt}}),lastUpdatedAt:Rt()})),Hs(!1)},ua=ie=>{if(!window.confirm("Delete this investigation?"))return;const Qe=Rt();gs(null),r(s.id,_e=>({..._e,investigations:_e.investigations.filter(St=>St.id!==ie),lastUpdatedAt:Qe}))},_n=ie=>{if(H(ie),ie!=="Other")te(""),r(s.id,Qe=>({...Qe,site:ie,lastUpdatedAt:Rt()}));else{const Qe=s.site&&!q.includes(s.site)?s.site:"";te(Qe)}},Va=()=>{const ie=Y.trim();ie&&r(s.id,Qe=>({...Qe,site:ie,lastUpdatedAt:Rt()}))},Qn=()=>{if(!b.trim())return;const ie=Rt();r(s.id,Qe=>({...Qe,issues:[...Qe.issues,{id:dr("issue"),title:b.trim(),status:"open",subpoints:v.trim()?[{id:dr("sub"),timestamp:ie,type:"note",text:v.trim()}]:[],lastUpdatedAt:ie}],lastUpdatedAt:ie})),N(""),j("")},rn=(ie,Qe)=>{const _e=Rt();let St;Qe.type==="procedure"?St={...Qe,id:Qe.id||dr("sub"),timestamp:Qe.timestamp||_e,type:"procedure",procedure:{...Qe.procedure,showDayCounter:Qe.procedure?.showDayCounter??!1}}:Qe.type==="antibiotic"?St={...Qe,id:Qe.id||dr("sub"),timestamp:Qe.timestamp||_e,type:"antibiotic",antibiotic:{...Qe.antibiotic}}:St={...Qe,id:Qe.id||dr("sub"),timestamp:Qe.timestamp||_e,type:"note",text:Qe.text||""},r(s.id,zt=>({...zt,issues:zt.issues.map(ot=>ot.id===ie?{...ot,subpoints:[...ot.subpoints,St],lastUpdatedAt:_e}:ot),lastUpdatedAt:_e}))},an=ie=>{it(Qe=>Qe===ie?null:ie),$e(Qe=>({...Qe,[ie]:Qe[ie]||""})),Ze(Qe=>({...Qe,[ie]:Qe[ie]||"note"})),pt(Qe=>({...Qe,[ie]:Qe[ie]||{...ho(),checklistKey:void 0}})),xt(Qe=>({...Qe,[ie]:Qe[ie]||po()}))},Gr=ie=>{const Qe=Xe[ie]||"note";if(Qe==="procedure"){const _e=ct[ie]||ho();if(!_e.name.trim()||!_e.date)return;rn(ie,{id:dr("sub"),timestamp:Rt(),type:"procedure",procedure:{name:_e.name.trim(),date:_e.date,notes:_e.notes.trim()||void 0,showDayCounter:_e.showDayCounter,checklistKey:_e.checklistKey||void 0}}),pt(St=>({...St,[ie]:{...ho(),checklistKey:void 0}}))}else if(Qe==="antibiotic"){const _e=dt[ie]||po();if(!_e.name.trim()||!_e.startDate)return;rn(ie,{id:dr("sub"),timestamp:Rt(),type:"antibiotic",antibiotic:{name:_e.name.trim(),startDate:_e.startDate,stopDate:_e.stopDate||void 0,notes:_e.notes.trim()||void 0}}),xt(St=>({...St,[ie]:po()}))}else{const _e=st[ie]?.trim()||"";if(!_e)return;rn(ie,{id:dr("sub"),timestamp:Rt(),type:"note",text:_e}),$e(St=>({...St,[ie]:""}))}it(null)},ea=()=>{it(null)},mr=ie=>{const Qe=Rt();r(s.id,_e=>({..._e,issues:_e.issues.map(St=>St.id===ie?{...St,status:St.status==="open"?"resolved":"open",lastUpdatedAt:Qe}:St),lastUpdatedAt:Qe}))},Ts=ie=>{if(!window.confirm("Delete this issue?"))return;const Qe=Rt();Tt(null),r(s.id,_e=>{const St=new Set;return _e.issues.find(ot=>ot.id===ie)?.subpoints.forEach(ot=>{ot.type==="procedure"&&St.add(ot.id)}),{..._e,issues:_e.issues.filter(ot=>ot.id!==ie),tasks:_e.tasks.filter(ot=>!ot.procedureId||!St.has(ot.procedureId)),lastUpdatedAt:Qe}})},On=()=>{const ie={};s.issues.forEach(Qe=>{ie[`issue-${Qe.id}`]=Qe.title,Qe.subpoints.forEach(_e=>{_e.type==="procedure"?(ie[`subpoint-name-${_e.id}`]=_e.procedure?.name||"",ie[`subpoint-date-${_e.id}`]=_e.procedure?.date||"",ie[`subpoint-notes-${_e.id}`]=_e.procedure?.notes||"",qe(St=>({...St,[_e.id]:_e.procedure?.showDayCounter??!1}))):_e.type==="antibiotic"?(ie[`subpoint-abx-name-${_e.id}`]=_e.antibiotic?.name||"",ie[`subpoint-abx-date-${_e.id}`]=_e.antibiotic?.startDate||"",ie[`subpoint-abx-stop-${_e.id}`]=_e.antibiotic?.stopDate||"",ie[`subpoint-abx-notes-${_e.id}`]=_e.antibiotic?.notes||""):ie[`subpoint-${_e.id}`]=_e.text})}),xe(ie),we(!0)},Ur=()=>{const ie=Rt(),Qe=new Set;r(s.id,_e=>({..._e,issues:_e.issues.map(St=>({...St,title:de[`issue-${St.id}`]?.trim()||St.title,subpoints:St.subpoints.reduce((zt,ot)=>{if(ot.type==="procedure"){const ze=de[`subpoint-name-${ot.id}`]!==void 0?de[`subpoint-name-${ot.id}`]?.trim()||"":ot.procedure?.name||"",Gt=de[`subpoint-date-${ot.id}`]??ot.procedure?.date??"",Bs=de[`subpoint-notes-${ot.id}`]!==void 0?de[`subpoint-notes-${ot.id}`]?.trim()||"":ot.procedure?.notes||"",ls=Se[ot.id]??ot.procedure?.showDayCounter??!1,Qs=ot.procedure?.checklistKey;return ze?(zt.push({...ot,type:"procedure",procedure:{...ot.procedure,name:ze,date:Gt,notes:Bs,showDayCounter:ls,checklistKey:Qs}}),zt):(Qe.add(ot.id),zt)}if(ot.type==="antibiotic"){const ze=de[`subpoint-abx-name-${ot.id}`]!==void 0?de[`subpoint-abx-name-${ot.id}`]?.trim()||"":ot.antibiotic?.name||"",Gt=de[`subpoint-abx-date-${ot.id}`]??ot.antibiotic?.startDate??"",Bs=de[`subpoint-abx-stop-${ot.id}`]??ot.antibiotic?.stopDate??"",ls=de[`subpoint-abx-notes-${ot.id}`]!==void 0?de[`subpoint-abx-notes-${ot.id}`]?.trim()||"":ot.antibiotic?.notes||"";return ze&&zt.push({...ot,type:"antibiotic",antibiotic:{...ot.antibiotic,name:ze,startDate:Gt,stopDate:Bs||void 0,notes:ls}}),zt}const yr=de[`subpoint-${ot.id}`],kt=yr!==void 0?yr.trim():ot.text;return kt&&zt.push({...ot,type:"note",text:kt}),zt},[]),lastUpdatedAt:ie})),tasks:_e.tasks.filter(St=>!St.procedureId||!Qe.has(St.procedureId)),lastUpdatedAt:ie})),we(!1),xe({}),qe({})},zr=()=>{we(!1),xe({}),qe({})},er=(ie,Qe)=>{xe(_e=>({..._e,[ie]:Qe}))},tr=()=>{if(!I.trim())return;const ie=Rt();r(s.id,Qe=>({...Qe,tasks:[...Qe.tasks,{id:dr("task"),text:I.trim(),status:"open",createdAt:ie}],lastUpdatedAt:ie})),C("")},_s=ie=>{const Qe=Rt();r(s.id,_e=>({..._e,tasks:_e.tasks.map(St=>St.id===ie?{...St,status:St.status==="open"?"done":"open",completedAt:St.status==="open"?Qe:void 0}:St),lastUpdatedAt:Qe}))},Lr=()=>{if(!E.trim()||!Q.trim()||!k)return;const ie=Number(Q),Qe=new Date(k);if(Number.isNaN(ie)||Number.isNaN(Qe.valueOf()))return;const _e=Qe.toISOString();r(s.id,St=>{const zt=St.investigations.find(ot=>ot.type==="lab"&&ot.name.toLowerCase()===E.trim().toLowerCase());if(zt){const ot={...zt,labSeries:[...zt.labSeries||[],{date:_e,value:ie}],lastUpdatedAt:_e};return{...St,investigations:St.investigations.map(yr=>yr.id===zt.id?ot:yr),lastUpdatedAt:_e}}return{...St,investigations:[...St.investigations,{id:dr("inv"),type:"lab",name:E.trim(),lastUpdatedAt:_e,labSeries:[{date:_e,value:ie}]}],lastUpdatedAt:_e}}),T(""),D(""),R("")},oi=()=>{if(!w.trim()||!M.trim()||!K)return;const ie=new Date(K);if(Number.isNaN(ie.valueOf()))return;const Qe=ie.toISOString();r(s.id,_e=>({..._e,investigations:[..._e.investigations,{id:dr("inv"),type:"imaging",name:w.trim(),summary:M.trim(),lastUpdatedAt:Qe}],lastUpdatedAt:Qe})),L(""),P("")},Fi=async()=>{Kt&&(await i(s.id,Kt),Js(""))},Sa=async()=>{if(!Vt.trim())return;const ie=Rt(),Qe={id:dr("clin"),name:Vt.trim(),createdAt:ie,lastUpdatedAt:ie};await n(Qe),await i(s.id,Qe.id),Kr("")},ta=async ie=>{await o(s.id,ie)},ja=async()=>{Zs(!0),qt("");try{const ie=D3(Zr,s),Qe=L3(s,ie),St=await Bi.getInstance().generatePatientUpdateMessage(s,Qe);qt(St)}catch(ie){console.error("Failed to generate message update:",ie),qt("Error generating update. Please try again.")}finally{Zs(!1)}},ma=async()=>{if(Ot)try{await navigator.clipboard.writeText(Ot),kr(!0),setTimeout(()=>kr(!1),2e3)}catch(ie){console.error("Failed to copy message:",ie)}},sr=m.useMemo(()=>{const ie=s.issues.filter(_e=>_e.status==="open"),Qe=s.issues.filter(_e=>_e.status==="resolved");return[...ie,...Qe]},[s.issues]),$a=(ie,Qe)=>{if(ie===Qe)return;const _e=s.issues.find(ot=>ot.id===ie),St=s.issues.find(ot=>ot.id===Qe);if(!_e||!St||_e.status!==St.status)return;const zt=Rt();r(s.id,ot=>{const yr=ot.issues.filter(Vs=>Vs.status==="open"),kt=ot.issues.filter(Vs=>Vs.status==="resolved"),ze=_e.status==="open"?yr:kt,Gt=ze.findIndex(Vs=>Vs.id===ie),Bs=ze.findIndex(Vs=>Vs.id===Qe);if(Gt===-1||Bs===-1)return ot;const ls=[...ze],[Qs]=ls.splice(Gt,1);return ls.splice(Bs,0,Qs),{...ot,issues:_e.status==="open"?[...ls,...kt]:[...yr,...ls],lastUpdatedAt:zt}})},nn=m.useMemo(()=>{const ie=[];return s.site?.trim()&&ie.push(s.site.trim()),A.trim()&&ie.push(`Bed ${A.trim()}`),ie.join(" ‚Ä¢ ")},[s.site,A]),on=s.tasks.filter(ie=>ie.status==="open"),Ea=s.tasks.filter(ie=>ie.status==="done");return m.useEffect(()=>{const ie=[];sr.forEach(Qe=>{Qe.subpoints.forEach(_e=>{if(_e.type!=="procedure"||!_e.procedure?.date||!_e.procedure.checklistKey)return;const St=H0.find(ot=>ot.key===_e.procedure?.checklistKey);if(!St)return;const zt=Td(_e.procedure.date);zt!==null&&St.items.forEach(ot=>{zt>=ot.day&&(s.tasks.some(kt=>kt.procedureId===_e.id&&kt.scheduledDayOffset===ot.day&&kt.text===ot.text)||ie.push({id:dr("task"),text:ot.text,status:"open",createdAt:Rt(),origin:"procedure-checklist",procedureId:_e.id,scheduledDayOffset:ot.day}))})})}),ie.length&&r(s.id,Qe=>({...Qe,tasks:[...Qe.tasks,...ie],lastUpdatedAt:Rt()}))},[s.id,s.tasks,sr,r,ut]),t.jsxs("div",{className:"h-full overflow-y-auto p-4 space-y-4",children:[t.jsx("div",{className:"relative rounded-xl p-4 bg-white shadow-sm",children:t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"min-w-0 space-y-1",onClick:Oa,children:[t.jsx("div",{className:"text-[11px] text-gray-500 select-none",children:"Patient"}),t.jsx("input",{className:"text-lg sm:text-xl font-semibold text-gray-900 bg-transparent border-b border-transparent focus:border-gray-300 focus:outline-none w-full",value:u,onChange:ie=>x(ie.target.value),onBlur:Ha,onClick:ie=>{ie.stopPropagation(),tn()},onFocus:tn}),nn&&t.jsx("div",{className:"text-sm text-gray-600 truncate",children:nn})]}),Le&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3 items-end",children:[t.jsxs("div",{className:"sm:col-span-1",children:[t.jsx("label",{className:"text-xs font-medium text-gray-600",children:"Ward"}),t.jsxs("select",{className:"mt-1 w-full rounded-md border px-2 py-2 text-sm",value:S,onChange:ie=>_n(ie.target.value),children:[t.jsx("option",{value:"",children:"Select ward"}),q.map(ie=>t.jsx("option",{value:ie,children:ie},ie))]}),S==="Other"&&t.jsx("input",{className:"mt-2 w-full rounded-md border px-2 py-2 text-sm",placeholder:"Enter ward name",value:Y,onChange:ie=>te(ie.target.value),onBlur:Va,onKeyDown:ie=>{ie.key==="Enter"&&(ie.preventDefault(),Va())}})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs font-medium text-gray-600",children:"MRN / UR"}),t.jsx("input",{className:"mt-1 w-full rounded-md border px-2 py-2 text-sm",value:l,onChange:ie=>c(ie.target.value),onBlur:Ha})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs font-medium text-gray-600",children:"Bed"}),t.jsx("input",{className:"mt-1 w-full rounded-md border px-2 py-2 text-sm",value:A,onChange:ie=>d(ie.target.value),onBlur:Ha})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs font-medium text-gray-600",children:"One-liner"}),t.jsx("textarea",{className:"mt-1 w-full rounded-md border px-3 py-2 text-sm min-h-[60px]",value:h,onChange:ie=>f(ie.target.value),onBlur:Ha})]}),t.jsxs("div",{className:"rounded-lg border border-gray-200 bg-gray-50 p-3 space-y-2",children:[t.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Next of Kin"}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-2",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-xs font-medium text-gray-600",children:"Name"}),t.jsx("input",{className:"mt-1 w-full rounded-md border px-2 py-2 text-sm",placeholder:"NOK name",value:G,onChange:ie=>X(ie.target.value),onBlur:sn})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs font-medium text-gray-600",children:"Relation"}),t.jsx("input",{className:"mt-1 w-full rounded-md border px-2 py-2 text-sm",placeholder:"e.g. Spouse, Son",value:le,onChange:ie=>he(ie.target.value),onBlur:sn})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-xs font-medium text-gray-600",children:"Phone"}),t.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[t.jsx("input",{className:"flex-1 rounded-md border px-2 py-2 text-sm",placeholder:"Phone number",type:"tel",value:ve,onChange:ie=>ke(ie.target.value),onBlur:sn}),ve.trim()&&t.jsx("a",{href:`tel:${ve.trim()}`,className:"flex items-center justify-center w-9 h-9 rounded-md bg-emerald-500 text-white hover:bg-emerald-600 transition-colors",title:"Call NOK",children:t.jsx(Py,{className:"w-4 h-4"})})]})]})]})]}),t.jsxs("div",{className:"rounded-lg border border-gray-200 bg-gray-50 p-3 space-y-2",children:[t.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Clinicians"}),t.jsxs("div",{className:"flex flex-wrap gap-2",children:[s.clinicianIds?.map(ie=>{const Qe=a.find(_e=>_e.id===ie);return Qe?t.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 rounded-full bg-blue-100 text-blue-800 text-xs",children:[t.jsx("span",{children:Qe.name}),Qe.role&&t.jsxs("span",{className:"text-blue-600",children:["(",Qe.role,")"]}),t.jsx("button",{type:"button",onClick:()=>ta(Qe.id),className:"ml-1 hover:bg-blue-200 rounded-full p-0.5 transition-colors",title:`Remove ${Qe.name}`,"aria-label":`Remove ${Qe.name}`,children:t.jsx(es,{className:"w-3 h-3"})})]},Qe.id):null}),(!s.clinicianIds||s.clinicianIds.length===0)&&t.jsx("span",{className:"text-sm text-gray-500",children:"No clinicians assigned"})]}),t.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[t.jsxs("select",{className:"flex-1 rounded-md border px-2 py-1 text-sm",value:Kt,onChange:ie=>Js(ie.target.value),"aria-label":"Select clinician to assign",children:[t.jsx("option",{value:"",children:"Select existing clinician"}),a.filter(ie=>!s.clinicianIds?.includes(ie.id)).map(ie=>t.jsxs("option",{value:ie.id,children:[ie.name,ie.role?` (${ie.role})`:""]},ie.id))]}),t.jsx(ye,{size:"xs",onClick:Fi,disabled:!Kt,children:"Assign"})]}),t.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 pt-1 border-t border-gray-200",children:[t.jsx("input",{className:"flex-1 rounded-md border px-2 py-1 text-sm",placeholder:"Quick add new clinician",value:Vt,onChange:ie=>Kr(ie.target.value),onKeyDown:ie=>{ie.key==="Enter"&&(ie.preventDefault(),Sa())}}),t.jsx(ye,{size:"xs",startIcon:Fr,onClick:Sa,disabled:!Vt.trim(),children:"Add & Assign"})]})]}),t.jsxs("div",{className:"rounded-lg border border-gray-200 bg-gray-50 p-3 space-y-2",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Intake notes"}),t.jsx("p",{className:"text-xs text-gray-500",children:"Stored as typed; not modified."})]}),t.jsx(ye,{size:"xs",variant:"ghost",onClick:()=>pe(ie=>!ie),children:Ie?"Hide":"Show"})]}),Ie&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx("input",{className:"flex-1 rounded-md border px-2 py-1 text-sm",placeholder:"Add intake note",value:ee,onChange:ie=>V(ie.target.value)}),t.jsx(ye,{size:"xs",onClick:()=>{if(!ee.trim())return;const ie=Rt();r(s.id,Qe=>({...Qe,intakeNotes:[...Qe.intakeNotes,{id:dr("intake"),timestamp:ie,text:ee.trim()}],lastUpdatedAt:ie})),V("")},children:"Add"})]}),t.jsxs("div",{className:"space-y-2",children:[s.intakeNotes.map(ie=>t.jsxs("div",{className:"border border-gray-200 rounded-lg p-3 bg-white",children:[t.jsx("div",{className:"text-xs text-gray-500 mb-1",children:new Date(ie.timestamp).toLocaleString()}),t.jsx("div",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:ie.text})]},ie.id)),s.intakeNotes.length===0&&t.jsx("p",{className:"text-sm text-gray-500",children:"No intake notes yet."})]})]})]}),t.jsxs("div",{className:"rounded-lg border border-gray-200 bg-gray-50 p-3 space-y-2",children:[t.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Message Update"}),t.jsx("p",{className:"text-xs text-gray-500",children:"Generate a brief update based on recent changes"}),t.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[t.jsxs("select",{className:"rounded-md border px-2 py-1 text-sm",value:Zr,onChange:ie=>Qa(ie.target.value),"aria-label":"Select time window for update",children:[t.jsx("option",{value:"6h",children:"Last 6 hours"}),t.jsx("option",{value:"12h",children:"Last 12 hours"}),t.jsx("option",{value:"24h",children:"Last 24 hours"}),t.jsx("option",{value:"48h",children:"Last 48 hours"}),t.jsx("option",{value:"today6am",children:"Since 6am today"}),t.jsx("option",{value:"lastRound",children:"Since last round"})]}),t.jsx(ye,{size:"xs",onClick:ja,disabled:fs,children:fs?"Generating...":"Generate"})]}),Ot&&t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"border border-gray-200 rounded-lg p-3 bg-white",children:[t.jsx("div",{className:"text-sm text-gray-800",children:Ot}),t.jsxs("div",{className:"text-xs text-gray-500 mt-2",children:[Ot.length,"/280 characters"]})]}),t.jsx("div",{className:"flex justify-end",children:t.jsx(ye,{size:"xs",startIcon:ur?Ms:Xn,onClick:ma,variant:ur?"ghost":"secondary",children:ur?"Copied!":"Copy"})})]})]})]})]})}),t.jsxs("div",{className:"rounded-xl border border-amber-200 bg-white shadow-sm overflow-hidden",children:[t.jsxs("div",{className:"px-3 sm:px-4 py-3 bg-amber-50/60 border-b border-amber-100",children:[t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsxs("div",{className:"flex items-baseline gap-2 min-w-0",children:[t.jsx("h4",{className:"text-xs font-semibold uppercase tracking-wide text-amber-900",children:"Issues"}),t.jsx("span",{className:"text-[11px] text-amber-900/70",children:sr.length})]}),t.jsx("div",{className:"flex items-center gap-1",children:fe?t.jsxs(t.Fragment,{children:[t.jsx("button",{type:"button",onClick:Ur,className:"text-[10px] px-2 py-1 rounded bg-white/70 text-amber-900 hover:bg-white transition-colors border border-amber-200",children:"Save"}),t.jsx("button",{type:"button",onClick:zr,className:"text-[10px] px-2 py-1 rounded text-amber-900/80 hover:bg-white/70 transition-colors",children:"Cancel"})]}):t.jsxs(t.Fragment,{children:[t.jsxs("button",{type:"button",onClick:()=>re(ie=>!ie),className:"text-[10px] px-2 py-1 rounded text-amber-900/80 hover:bg-white/70 transition-colors flex items-center gap-1 border border-transparent hover:border-amber-200",children:[t.jsx(Fr,{className:"w-3 h-3"}),Re?"Close":"Add"]}),t.jsx("button",{type:"button",onClick:On,className:"text-[10px] px-2 py-1 rounded text-amber-900/80 hover:bg-white/70 transition-colors border border-transparent hover:border-amber-200",children:"Edit"})]})})]}),Re&&t.jsxs("div",{className:"mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2",children:[t.jsx("input",{className:"rounded-md border px-2 py-2 text-sm w-full bg-white",placeholder:"Issue title",value:b,onChange:ie=>N(ie.target.value)}),t.jsx("input",{className:"rounded-md border px-2 py-2 text-sm w-full bg-white",placeholder:"Initial note",value:v,onChange:ie=>j(ie.target.value)}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(ye,{size:"xs",onClick:Qn,disabled:!b.trim(),children:"Save"}),t.jsx(ye,{size:"xs",variant:"ghost",onClick:()=>{re(!1),N(""),j("")},children:"Cancel"})]})]})]}),t.jsxs("div",{className:"p-3 sm:p-4 space-y-3",children:[sr.map((ie,Qe)=>{const _e=At===ie.id,St=Qt===ie.id&&At&&At!==ie.id,zt=ie.status==="resolved",ot=!fe,yr=Yt.has(ie.id),kt=fe||!zt||yr;return t.jsxs("div",{className:`relative rounded-lg border bg-white p-3 shadow-sm transition ${zt?"border-gray-200 opacity-75":"border-gray-200"} ${St?"ring-2 ring-amber-200":""} ${_e?"opacity-50":""}`,onDragOver:ze=>{!ot||!At||(ze.preventDefault(),ts(ie.id))},onDragLeave:()=>{Qt===ie.id&&ts(null)},onDrop:ze=>{!ot||!At||(ze.preventDefault(),$a(At,ie.id),mt(null),ts(null))},children:[t.jsxs("div",{className:"flex items-start justify-between gap-3",children:[t.jsxs("div",{className:"flex items-start gap-3 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{className:`w-8 h-8 rounded-lg flex items-center justify-center text-sm font-semibold ${zt?"bg-gray-100 text-gray-500":"bg-amber-100 text-amber-800"}`,title:`Issue ${Qe+1}`,children:Qe+1}),!fe&&t.jsx("span",{draggable:ot,onDragStart:ze=>{ze.stopPropagation(),mt(ie.id);try{ze.dataTransfer.setData("text/plain",ie.id)}catch{}ze.dataTransfer.effectAllowed="move"},onDragEnd:()=>{mt(null),ts(null)},className:"text-gray-300 hover:text-gray-500 cursor-grab",title:"Drag to reorder",children:t.jsx(cu,{className:"w-4 h-4"})})]}),t.jsxs("div",{className:"min-w-0",children:[fe?t.jsx("input",{className:"w-full rounded-md border px-2 py-1.5 text-sm font-semibold",value:de[`issue-${ie.id}`]||"",onChange:ze=>er(`issue-${ie.id}`,ze.target.value),placeholder:"Issue title"}):t.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[t.jsx("div",{className:`text-sm font-semibold break-words ${zt?"text-gray-500 line-through":"text-gray-900"}`,children:ie.title}),ie.pinToHud&&t.jsx(Sp,{className:"w-4 h-4 text-amber-500 flex-shrink-0"})]}),!fe&&zt&&t.jsxs("div",{className:"mt-0.5 flex items-center gap-2",children:[t.jsx("div",{className:"text-[11px] text-gray-400",children:"Resolved"}),ie.subpoints.length>0&&t.jsxs("button",{type:"button",className:"inline-flex items-center gap-1 text-[11px] text-gray-500 hover:text-gray-700 hover:underline",onClick:ze=>{ze.stopPropagation(),Ht(Gt=>{const Bs=new Set(Gt);return Bs.has(ie.id)?Bs.delete(ie.id):Bs.add(ie.id),Bs})},children:[yr?"Hide notes":`Show notes (${ie.subpoints.length})`,t.jsx(ps,{className:`w-3 h-3 transition-transform ${yr?"rotate-180":""}`})]})]})]})]}),!fe&&t.jsxs("div",{className:"relative","data-issue-menu-root":ie.id,children:[t.jsx("button",{type:"button",className:"p-1.5 rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition-colors",onClick:ze=>{ze.stopPropagation(),Tt(Gt=>Gt===ie.id?null:ie.id)},title:"Issue actions",children:t.jsx(Uy,{className:"w-4 h-4"})}),rt===ie.id&&t.jsxs("div",{className:`absolute right-0 w-44 rounded-lg border border-gray-200 bg-white shadow-lg z-20 overflow-hidden ${Qe>=sr.length-1?"bottom-full mb-1":"mt-1"}`,children:[t.jsxs("button",{type:"button",className:"w-full px-3 py-2 text-xs text-left hover:bg-gray-50 flex items-center gap-2",onClick:()=>{Tt(null),an(ie.id)},children:[t.jsx(Fr,{className:"w-3.5 h-3.5 text-gray-600"}),"Add detail"]}),t.jsxs("button",{type:"button",className:"w-full px-3 py-2 text-xs text-left hover:bg-gray-50 flex items-center gap-2",onClick:()=>{Tt(null),mr(ie.id)},children:[t.jsx("span",{className:`w-2 h-2 rounded-full ${ie.status==="open"?"bg-amber-500":"bg-emerald-500"}`}),ie.status==="open"?"Mark resolved":"Mark open"]}),t.jsx("div",{className:"border-t border-gray-100"}),t.jsxs("button",{type:"button",className:"w-full px-3 py-2 text-xs text-left hover:bg-rose-50 text-rose-700 flex items-center gap-2",onClick:()=>{Tt(null),Ts(ie.id)},children:[t.jsx(es,{className:"w-3.5 h-3.5"}),"Delete"]})]})]})]}),kt&&ie.subpoints.length>0&&t.jsx("div",{className:"mt-2 space-y-2",children:ie.subpoints.map(ze=>{if(ze.type==="procedure"&&ze.procedure){const ls=Td(ze.procedure?.date||""),Qs=ls!==null?ls<0?"Upcoming":`Day ${ls}`:"No date";return t.jsx("div",{className:"text-sm text-gray-800 flex flex-col gap-1 border border-gray-100 rounded-md p-2 bg-gray-50",children:fe?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[t.jsx("input",{className:"flex-1 rounded-md border px-2 py-1 text-sm",value:de[`subpoint-name-${ze.id}`]||"",onChange:Vs=>er(`subpoint-name-${ze.id}`,Vs.target.value),placeholder:"Procedure name"}),t.jsx("input",{type:"date",className:"rounded-md border px-2 py-1 text-sm",value:de[`subpoint-date-${ze.id}`]||"",onChange:Vs=>er(`subpoint-date-${ze.id}`,Vs.target.value)})]}),t.jsx("input",{className:"rounded-md border px-2 py-1 text-sm",value:de[`subpoint-notes-${ze.id}`]||"",onChange:Vs=>er(`subpoint-notes-${ze.id}`,Vs.target.value),placeholder:"Notes (optional)"}),t.jsxs("label",{className:"flex items-center gap-2 text-xs text-gray-700",children:[t.jsx("input",{type:"checkbox",checked:Se[ze.id]??!1,onChange:Vs=>qe(ha=>({...ha,[ze.id]:Vs.target.checked}))}),"Show day counter"]})]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[t.jsx("span",{className:"font-medium text-gray-900",children:ze.procedure?.name}),ze.procedure?.showDayCounter&&t.jsx("span",{className:"text-[11px] px-2 py-0.5 rounded-full bg-slate-100 text-slate-700",children:Qs})]}),t.jsx("div",{className:"text-xs text-gray-600",children:ze.procedure?.date?new Date(ze.procedure.date).toLocaleDateString("en-AU"):"Date not set"}),ze.procedure?.notes&&t.jsx("div",{className:"text-sm text-gray-700 whitespace-pre-wrap",children:ze.procedure.notes})]})},ze.id)}if(ze.type==="antibiotic"&&ze.antibiotic){const ls=Td(ze.antibiotic?.startDate||""),Qs=ls!==null?ls+1:null,Vs=ze.antibiotic?.stopDate?Td(ze.antibiotic.stopDate):null,ha=Vs===0,sa=Vs!==null&&Vs>0;let Dr,ra="bg-emerald-100 text-emerald-700";return Qs===null?Dr="No date":ls!==null&&ls<0?Dr="Upcoming":ha?(Dr=`Day ${Qs} ‚Äî FINAL DAY`,ra="bg-amber-100 text-amber-800 font-semibold"):sa?(Dr=`Day ${Qs} ‚Äî Course ended`,ra="bg-gray-100 text-gray-600"):Dr=`Day ${Qs}`,t.jsx("div",{className:`text-sm text-gray-800 flex flex-col gap-1 border rounded-md p-2 ${ha?"border-amber-200 bg-amber-50":sa?"border-gray-200 bg-gray-50":"border-emerald-100 bg-emerald-50"}`,children:fe?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[t.jsx("input",{className:"flex-1 rounded-md border px-2 py-1 text-sm",value:de[`subpoint-abx-name-${ze.id}`]||"",onChange:pa=>er(`subpoint-abx-name-${ze.id}`,pa.target.value),placeholder:"Antibiotic name"}),t.jsx("input",{type:"date",className:"rounded-md border px-2 py-1 text-sm",value:de[`subpoint-abx-date-${ze.id}`]||"",onChange:pa=>er(`subpoint-abx-date-${ze.id}`,pa.target.value),title:"Start date"})]}),t.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 items-start sm:items-center",children:[t.jsxs("label",{className:"text-xs text-gray-600 flex items-center gap-1",children:["Stop date:",t.jsx("input",{type:"date",className:"rounded-md border px-2 py-1 text-sm",value:de[`subpoint-abx-stop-${ze.id}`]||"",onChange:pa=>er(`subpoint-abx-stop-${ze.id}`,pa.target.value)})]}),de[`subpoint-abx-stop-${ze.id}`]&&t.jsx("button",{type:"button",className:"text-xs text-gray-500 hover:text-gray-700",onClick:()=>er(`subpoint-abx-stop-${ze.id}`,""),children:"Clear"})]}),t.jsx("input",{className:"rounded-md border px-2 py-1 text-sm",value:de[`subpoint-abx-notes-${ze.id}`]||"",onChange:pa=>er(`subpoint-abx-notes-${ze.id}`,pa.target.value),placeholder:"Notes (optional)"})]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[t.jsxs("span",{className:"font-medium text-gray-900",children:["üíä ",ze.antibiotic?.name]}),t.jsx("span",{className:`text-[11px] px-2 py-0.5 rounded-full ${ra}`,children:Dr})]}),t.jsxs("div",{className:"text-xs text-gray-600",children:["Started ",ze.antibiotic?.startDate?new Date(ze.antibiotic.startDate).toLocaleDateString("en-AU"):"Date not set",ze.antibiotic?.stopDate&&t.jsxs("span",{children:[" ¬∑ Ends ",new Date(ze.antibiotic.stopDate).toLocaleDateString("en-AU")]})]}),ze.antibiotic?.notes&&t.jsx("div",{className:"text-sm text-gray-700 whitespace-pre-wrap",children:ze.antibiotic.notes})]})},ze.id)}return t.jsxs("div",{className:"text-[13px] text-gray-600 flex items-start",children:[t.jsx("span",{className:"mr-2 flex-shrink-0 text-gray-400",children:"‚Ä¢"}),fe?t.jsx("input",{className:"flex-1 rounded-md border px-2 py-1 text-sm",value:de[`subpoint-${ze.id}`]||"",onChange:ls=>er(`subpoint-${ze.id}`,ls.target.value),placeholder:"Subpoint text"}):t.jsx("span",{children:ze.text})]},ze.id)})}),!fe&&ie.subpoints.length===0&&Ne!==ie.id&&t.jsx("div",{className:"mt-2 text-xs text-gray-400",children:"No notes yet."}),!fe&&Ne===ie.id&&t.jsxs("div",{className:"mt-2 space-y-2 rounded-md border border-gray-200 p-2 bg-gray-50",children:[t.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-700",children:[t.jsx("span",{className:"font-medium",children:"Add as"}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("button",{type:"button",className:`px-2 py-1 rounded-full border text-[11px] ${(Xe[ie.id]||"note")==="note"?"bg-white border-gray-300 text-gray-900":"bg-transparent border-transparent text-gray-600 hover:bg-white/70"}`,onClick:()=>Ze(ze=>({...ze,[ie.id]:"note"})),children:"Note"}),t.jsx("button",{type:"button",className:`px-2 py-1 rounded-full border text-[11px] ${(Xe[ie.id]||"note")==="procedure"?"bg-white border-gray-300 text-gray-900":"bg-transparent border-transparent text-gray-600 hover:bg-white/70"}`,onClick:()=>Ze(ze=>({...ze,[ie.id]:"procedure"})),children:"Procedure"}),t.jsx("button",{type:"button",className:`px-2 py-1 rounded-full border text-[11px] ${(Xe[ie.id]||"note")==="antibiotic"?"bg-white border-gray-300 text-gray-900":"bg-transparent border-transparent text-gray-600 hover:bg-white/70"}`,onClick:()=>Ze(ze=>({...ze,[ie.id]:"antibiotic"})),children:"Antibiotic"})]})]}),(Xe[ie.id]||"note")==="note"?t.jsx("input",{className:"w-full rounded-md border px-2 py-1 text-sm",placeholder:"Add subpoint",value:st[ie.id]||"",onChange:ze=>$e(Gt=>({...Gt,[ie.id]:ze.target.value})),onKeyDown:ze=>{ze.key==="Enter"&&(ze.preventDefault(),Gr(ie.id)),ze.key==="Escape"&&ea()}}):(Xe[ie.id]||"note")==="antibiotic"?t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[t.jsx("input",{className:"rounded-md border px-2 py-1 text-sm",placeholder:"Antibiotic name",value:dt[ie.id]?.name||"",onChange:ze=>xt(Gt=>({...Gt,[ie.id]:{...Gt[ie.id]||po(),name:ze.target.value}}))}),t.jsx("input",{type:"date",className:"rounded-md border px-2 py-1 text-sm",value:dt[ie.id]?.startDate||"",onChange:ze=>xt(Gt=>({...Gt,[ie.id]:{...Gt[ie.id]||po(),startDate:ze.target.value}}))}),t.jsx("input",{className:"sm:col-span-2 rounded-md border px-2 py-1 text-sm",placeholder:"Notes (optional)",value:dt[ie.id]?.notes||"",onChange:ze=>xt(Gt=>({...Gt,[ie.id]:{...Gt[ie.id]||po(),notes:ze.target.value}}))})]}),t.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-700",children:[t.jsx("span",{children:"Course:"}),t.jsx("div",{className:"inline-flex rounded-md border border-gray-300 overflow-hidden",children:[3,5,7].map((ze,Gt)=>{const Bs=dt[ie.id]?.stopDate===K0(dt[ie.id]?.startDate||"",ze);return t.jsxs("button",{type:"button",className:`px-3 py-1 text-[11px] transition-colors ${Bs?"bg-emerald-100 text-emerald-800 font-medium":"bg-white text-gray-700 hover:bg-gray-50"} ${Gt>0?"border-l border-gray-300":""} disabled:opacity-50`,onClick:()=>{const ls=dt[ie.id]?.startDate||"";ls&&xt(Qs=>({...Qs,[ie.id]:{...Qs[ie.id]||po(),stopDate:K0(ls,ze)}}))},disabled:!dt[ie.id]?.startDate,children:[ze,"d"]},ze)})}),dt[ie.id]?.stopDate&&t.jsxs(t.Fragment,{children:[t.jsxs("span",{className:"text-emerald-600",children:["‚Üí ",new Date(dt[ie.id].stopDate).toLocaleDateString("en-AU")]}),t.jsx("button",{type:"button",className:"text-gray-400 hover:text-gray-600",onClick:()=>xt(ze=>({...ze,[ie.id]:{...ze[ie.id]||po(),stopDate:""}})),title:"Clear stop date",children:"√ó"})]})]}),t.jsx("div",{className:"text-xs text-gray-500",children:"Day 1 starts on the date entered (first dose date)"})]}):t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[t.jsx("input",{className:"rounded-md border px-2 py-1 text-sm",placeholder:"Procedure name",value:ct[ie.id]?.name||"",onChange:ze=>pt(Gt=>({...Gt,[ie.id]:{...Gt[ie.id]||ho(),name:ze.target.value}}))}),t.jsx("input",{type:"date",className:"rounded-md border px-2 py-1 text-sm",value:ct[ie.id]?.date||"",onChange:ze=>pt(Gt=>({...Gt,[ie.id]:{...Gt[ie.id]||ho(),date:ze.target.value}}))}),t.jsx("input",{className:"sm:col-span-2 rounded-md border px-2 py-1 text-sm",placeholder:"Notes (optional)",value:ct[ie.id]?.notes||"",onChange:ze=>pt(Gt=>({...Gt,[ie.id]:{...Gt[ie.id]||ho(),notes:ze.target.value}}))})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-xs text-gray-700",children:[t.jsxs("label",{className:"flex items-center gap-1",children:[t.jsx("input",{type:"checkbox",checked:ct[ie.id]?.showDayCounter??!0,onChange:ze=>pt(Gt=>({...Gt,[ie.id]:{...Gt[ie.id]||ho(),showDayCounter:ze.target.checked}}))}),"Show day counter"]}),t.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[t.jsx("span",{children:"Checklist"}),t.jsxs("select",{className:"rounded-md border px-1.5 py-1 text-xs",value:ct[ie.id]?.checklistKey||"",onChange:ze=>pt(Gt=>({...Gt,[ie.id]:{...Gt[ie.id]||ho(),checklistKey:ze.target.value||""}})),children:[t.jsx("option",{value:"",children:"None"}),H0.map(ze=>t.jsx("option",{value:ze.key,children:ze.label},ze.key))]})]})]})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(ye,{size:"xs",onClick:()=>Gr(ie.id),disabled:(Xe[ie.id]||"note")==="note"?!(st[ie.id]||"").trim():(Xe[ie.id]||"note")==="antibiotic"?!((dt[ie.id]?.name||"").trim()&&dt[ie.id]?.startDate):!((ct[ie.id]?.name||"").trim()&&ct[ie.id]?.date),children:"Add"}),t.jsx(ye,{size:"xs",variant:"ghost",onClick:ea,children:"Cancel"})]})]})]},ie.id)}),sr.length===0&&t.jsx("p",{className:"text-sm text-gray-500",children:"No issues documented yet."})]})]}),t.jsxs("div",{className:"rounded-xl border border-blue-400 p-4 bg-white shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Investigations"}),t.jsxs("div",{className:"flex items-center gap-1",children:[!Ft&&t.jsxs("button",{type:"button",onClick:()=>vt(ie=>!ie),className:"text-[10px] px-1.5 py-0.5 rounded text-gray-600 hover:bg-gray-100 transition-colors flex items-center gap-0.5",children:[t.jsx(Fr,{className:"w-3 h-3"}),Es?"Close":"Add"]}),Ft?t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("button",{type:"button",onClick:os,className:"text-[10px] px-1.5 py-0.5 rounded bg-blue-50 text-blue-700 hover:bg-blue-100 transition-colors",children:"Save"}),t.jsx("button",{type:"button",onClick:lr,className:"text-[10px] px-1.5 py-0.5 rounded text-gray-600 hover:bg-gray-100 transition-colors",children:"Cancel"})]}):t.jsx("button",{type:"button",onClick:Mn,className:"text-[10px] px-1.5 py-0.5 rounded text-gray-600 hover:bg-gray-100 transition-colors",children:"Edit"})]})]}),t.jsxs("div",{className:"space-y-3",children:[s.investigations.map(ie=>t.jsx("div",{className:"border border-gray-200 rounded-lg p-3",children:Ft?t.jsxs("div",{className:"space-y-2",children:[t.jsx("input",{className:"w-full rounded-md border px-2 py-1 text-sm font-medium text-gray-900",value:ks[ie.id]?.name??ie.name,onChange:Qe=>Is(_e=>({..._e,[ie.id]:{..._e[ie.id]||{date:(ie.lastUpdatedAt||"").slice(0,10)},name:Qe.target.value}}))}),t.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[t.jsx("span",{className:"whitespace-nowrap",children:"Last updated"}),t.jsx("input",{type:"date",className:"rounded-md border px-2 py-1 text-sm",value:ks[ie.id]?.date??(ie.lastUpdatedAt||"").slice(0,10),onChange:Qe=>Is(_e=>({..._e,[ie.id]:{..._e[ie.id]||{name:ie.name},date:Qe.target.value}}))})]}),t.jsx("textarea",{className:"w-full rounded-md border px-2 py-2 text-sm",placeholder:"Notes / summary (optional)",value:ks[ie.id]?.summary??(ie.summary||""),onChange:Qe=>Is(_e=>({..._e,[ie.id]:{..._e[ie.id]||{name:ie.name,date:(ie.lastUpdatedAt||"").slice(0,10)},summary:Qe.target.value}})),rows:ie.type==="lab"?2:3})]}):t.jsxs(t.Fragment,{children:[t.jsxs("button",{type:"button",onClick:()=>gs(Qe=>Qe===ie.id?null:ie.id),className:"w-full flex items-center justify-between rounded-md px-2 py-1 -mx-2 hover:bg-gray-50 transition-colors",children:[t.jsx("div",{className:"font-medium text-left text-gray-900",children:ie.name}),t.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[t.jsx("span",{children:new Date(ie.lastUpdatedAt).toLocaleDateString("en-AU")}),t.jsx(ps,{className:`w-4 h-4 transition-transform ${Nt===ie.id?"rotate-180":""}`})]})]}),ie.type==="lab"?t.jsxs("div",{className:"space-y-1",children:[t.jsxs("div",{className:"text-sm text-gray-700",children:["Trend: ",$p(ie.labSeries||[])||"‚Äî"]}),ie.summary&&t.jsx("div",{className:"text-sm text-gray-700",children:ie.summary})]}):t.jsx("div",{className:"text-sm text-gray-700",children:ie.summary||"No summary yet"}),Nt===ie.id&&t.jsx("div",{className:"mt-2 flex flex-wrap items-center gap-2 text-xs",children:t.jsx("button",{type:"button",onClick:()=>ua(ie.id),className:"px-3 py-1 rounded-full border bg-rose-50 border-rose-200 text-rose-700 hover:bg-rose-100 transition-colors",children:"Delete"})})]})},ie.id)),Es&&t.jsxs("div",{className:"border border-dashed border-gray-200 rounded-lg p-3 space-y-2",children:[t.jsx("div",{className:"text-xs uppercase text-gray-500",children:"Add lab"}),t.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[t.jsx("input",{className:"rounded-md border px-2 py-1 text-sm",placeholder:"Name",value:E,onChange:ie=>T(ie.target.value)}),t.jsx("input",{className:"rounded-md border px-2 py-1 text-sm",placeholder:"Value",value:Q,onChange:ie=>D(ie.target.value)}),t.jsx("input",{type:"date",className:"rounded-md border px-2 py-1 text-sm",value:k,onChange:ie=>R(ie.target.value)})]}),t.jsx("div",{className:"flex justify-end gap-2",children:t.jsx("button",{type:"button",onClick:Lr,disabled:!E.trim()||!Q.trim()||!k,className:"text-[10px] px-2 py-1 rounded text-gray-600 hover:text-gray-800 hover:bg-gray-50 disabled:opacity-50 disabled:hover:bg-transparent",children:"Add lab"})}),t.jsx("div",{className:"text-xs uppercase text-gray-500 pt-2",children:"Add imaging / procedure"}),t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx("input",{className:"rounded-md border px-2 py-1 text-sm w-full",placeholder:"Name (e.g., Echo)",value:w,onChange:ie=>L(ie.target.value)}),t.jsx("input",{className:"rounded-md border px-2 py-1 text-sm w-full",placeholder:"Summary",value:M,onChange:ie=>P(ie.target.value)}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"text-xs text-gray-600 whitespace-nowrap",children:"Date"}),t.jsx("input",{type:"date",className:"rounded-md border px-2 py-1 text-sm w-full",value:K,onChange:ie=>$(ie.target.value)})]})]}),t.jsx("div",{className:"flex justify-end mt-2",children:t.jsx("button",{type:"button",onClick:oi,disabled:!w.trim()||!M.trim()||!K,className:"text-[10px] px-2 py-1 rounded text-gray-600 hover:text-gray-800 hover:bg-gray-50 disabled:opacity-50 disabled:hover:bg-transparent",children:"Add summary"})})]})]})]}),t.jsx(nT,{patient:s}),t.jsx(iT,{patient:s}),t.jsxs("div",{className:"rounded-xl border border-green-500 p-4 bg-white shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Tasks"}),t.jsxs("button",{type:"button",onClick:()=>Pe(ie=>!ie),className:"text-[10px] px-1.5 py-0.5 rounded text-gray-600 hover:bg-gray-100 transition-colors flex items-center gap-0.5",children:[t.jsx(Fr,{className:"w-3 h-3"}),Me?"Close":"Add"]})]}),Me&&t.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[t.jsx("input",{className:"rounded-md border px-2 py-2 text-sm flex-1",placeholder:"Add task",value:I,onChange:ie=>C(ie.target.value)}),t.jsx(ye,{size:"xs",startIcon:Fr,onClick:tr,disabled:!I.trim(),children:"Save"}),t.jsx(ye,{size:"xs",variant:"ghost",onClick:()=>{Pe(!1),C("")},children:"Cancel"})]}),t.jsxs("div",{className:"space-y-2",children:[on.map(ie=>t.jsx("div",{className:"flex items-center justify-between border border-gray-200 rounded-lg px-3 py-2",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:!1,onChange:()=>_s(ie.id)}),t.jsx("span",{className:"text-gray-800",children:ie.text})]})},ie.id)),Ea.length>0&&t.jsxs(t.Fragment,{children:[t.jsxs("button",{type:"button",onClick:()=>ce(ie=>!ie),className:"flex items-center gap-1 text-xs text-gray-500 hover:text-gray-700 py-1",children:[t.jsx(ps,{className:`w-3 h-3 transition-transform ${be?"rotate-0":"-rotate-90"}`}),Ea.length," completed ",Ea.length===1?"task":"tasks"]}),be&&Ea.map(ie=>t.jsxs("div",{className:"flex items-center justify-between border border-gray-200 rounded-lg px-3 py-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:!0,onChange:()=>_s(ie.id)}),t.jsx("span",{className:"line-through text-gray-500",children:ie.text})]}),t.jsx("span",{className:"text-xs text-gray-400",children:"Done"})]},ie.id))]}),s.tasks.length===0&&t.jsx("p",{className:"text-sm text-gray-500",children:"No tasks yet."})]})]}),t.jsx(Aw,{open:O,onClose:()=>W(!1),patient:s})]})},lT=om.filter(s=>s.common&&s.common<=15).sort((s,e)=>(s.common||999)-(e.common||999)).slice(0,8),cT=({patient:s,serviceDate:e,onClose:r,onComplete:a})=>{const{addBillingEntry:n}=yn(),[i,o]=m.useState(""),[l,c]=m.useState([]),[A,d]=m.useState(!1),h=m.useMemo(()=>i.trim()?dw(i).slice(0,10):[],[i]),f=j=>{l.find(I=>I.code===j.code)?c(I=>I.filter(C=>C.code!==j.code)):c(I=>[...I,j]),o(""),d(!1)},u=j=>{c(I=>I.filter(C=>C.code!==j))},x=async()=>{for(const j of l){const I={mbsCode:j.code,description:j.description,fee:j.fee,serviceDate:e,status:"pending"};await n(s.id,I)}a()},b=()=>{a()},N=j=>j?`$${j.toFixed(2)}`:"",v=l.reduce((j,I)=>j+(I.fee||0),0);return t.jsx("div",{className:"fixed inset-0 bg-black/30 z-50 flex items-center justify-center p-4",children:t.jsxs("div",{className:"bg-white border border-gray-200 rounded-xl shadow-xl w-full max-w-lg overflow-hidden",children:[t.jsx("div",{className:"px-4 py-3 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"p-1.5 bg-blue-100 rounded-lg",children:t.jsx(Hu,{className:"w-4 h-4 text-blue-600"})}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Bill for today's round?"}),t.jsxs("p",{className:"text-xs text-gray-500",children:[s.name," ‚Ä¢ ",e]})]})]}),t.jsx("button",{onClick:r,className:"p-1 rounded-lg hover:bg-gray-100 text-gray-400",children:t.jsx(es,{className:"w-5 h-5"})})]})}),t.jsxs("div",{className:"p-4 space-y-3",children:[t.jsx("div",{className:"text-xs uppercase text-gray-500 font-medium",children:"Common Codes"}),t.jsx("div",{className:"grid grid-cols-2 gap-2",children:lT.map(j=>{const I=l.find(C=>C.code===j.code);return t.jsxs("button",{onClick:()=>f(j),className:`flex items-center justify-between p-2.5 rounded-lg border text-left transition-all ${I?"border-blue-500 bg-blue-50 ring-1 ring-blue-500":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,children:[t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:`font-mono text-sm font-medium ${I?"text-blue-700":"text-gray-900"}`,children:j.code}),I&&t.jsx(Ms,{className:"w-3.5 h-3.5 text-blue-600"})]}),t.jsx("p",{className:"text-[11px] text-gray-500 truncate",children:j.description})]}),j.fee&&t.jsx("span",{className:"text-xs text-gray-400 ml-2",children:N(j.fee)})]},j.code)})}),A?t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"relative",children:[t.jsx(cl,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),t.jsx("input",{autoFocus:!0,className:"w-full rounded-lg border border-gray-300 px-9 py-2 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500",placeholder:"Search by code or description...",value:i,onChange:j=>o(j.target.value)}),t.jsx("button",{onClick:()=>{d(!1),o("")},className:"absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded hover:bg-gray-100",children:t.jsx(es,{className:"w-4 h-4 text-gray-400"})})]}),h.length>0&&t.jsx("div",{className:"max-h-40 overflow-y-auto border border-gray-200 rounded-lg divide-y",children:h.map(j=>{const I=l.find(C=>C.code===j.code);return t.jsxs("button",{onClick:()=>f(j),className:`w-full text-left p-2 hover:bg-gray-50 flex items-center justify-between ${I?"bg-blue-50":""}`,children:[t.jsxs("div",{children:[t.jsx("span",{className:"font-mono text-sm font-medium text-blue-600",children:j.code}),t.jsx("span",{className:"text-xs text-gray-500 ml-2",children:j.description})]}),I&&t.jsx(Ms,{className:"w-4 h-4 text-blue-600"})]},j.code)})})]}):t.jsxs("button",{onClick:()=>d(!0),className:"w-full flex items-center justify-center gap-2 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-50 rounded-lg border border-dashed border-gray-300 transition-colors",children:[t.jsx(cl,{className:"w-4 h-4"}),"Search for more codes"]}),l.length>0&&t.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 space-y-2",children:[t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsxs("span",{className:"text-gray-500 uppercase font-medium",children:["Selected (",l.length,")"]}),t.jsx("span",{className:"font-semibold text-gray-900",children:N(v)})]}),t.jsx("div",{className:"flex flex-wrap gap-1.5",children:l.map(j=>t.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-white border border-gray-200 rounded-full text-xs",children:[t.jsx("span",{className:"font-mono font-medium",children:j.code}),t.jsx("button",{onClick:()=>u(j.code),className:"p-0.5 rounded-full hover:bg-gray-100",children:t.jsx(es,{className:"w-3 h-3 text-gray-400"})})]},j.code))})]})]}),t.jsxs("div",{className:"px-4 py-3 border-t border-gray-200 bg-gray-50 flex items-center justify-between",children:[t.jsxs("button",{onClick:b,className:"text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1",children:[t.jsx(_a,{className:"w-4 h-4"}),"Skip for now"]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(ye,{variant:"ghost",size:"sm",onClick:r,children:"Cancel"}),t.jsxs(ye,{size:"sm",onClick:x,disabled:l.length===0,className:"flex items-center gap-1 whitespace-nowrap",children:["Add ",l.length>0?`${l.length} item${l.length>1?"s":""}`:"billing",t.jsx(ti,{className:"w-4 h-4"})]})]})]})]})})};var G0={};const AT="~/Library/Mobile Documents/com~apple~CloudDocs",Gp="Operator/WardRounds",z0=(s,e)=>s?e?s.replace(/\/+$/,""):s.replace(/^\/+|\/+$/g,""):"",Uu=(...s)=>{const e=s.filter(Boolean);if(e.length===0)return"";const[r,...a]=e;return[z0(r,!0),...a.map(n=>z0(n,!1))].join("/")},W0=s=>s?s.startsWith("~/")&&typeof process<"u"&&G0?.HOME?Uu(G0.HOME,s.slice(2)):s.startsWith("/")?s:typeof process<"u"&&typeof process.cwd=="function"?Uu(process.cwd(),s):s:"",dT=s=>{const e=W0(s?.icloudRoot??AT),r=s?.wardRoundRoot!==void 0?s.wardRoundRoot:Gp;return r?r.startsWith("~/")?W0(r):r.startsWith("/")?r:Uu(e,r):e},uw=(s="",e)=>Uu(dT(e),"Exports",s),uT={ward_round_v1:{template_id:"ward_round_v1",layout_version:1,image_width:1668,image_height:2388,regions:{patient_id:{x:80,y:60,width:1500,height:150},obs:{x:80,y:260,width:1500,height:260},bloods:{x:80,y:560,width:1500,height:260},imaging:{x:80,y:860,width:1500,height:260},meds:{x:80,y:1160,width:1500,height:260},plan:{x:80,y:1460,width:1500,height:360}}}},mT=s=>{const e=s.trim().split(/\s+/);if(e.length===1)return{first:e[0],last:e[0]};const r=e.slice(-1).join(" ");return{first:e.slice(0,-1).join(" "),last:r}},hT=(s,e)=>{const r=s.mrn?.trim()||s.id,{first:a,last:n}=mT(s.name||"Unknown"),i=o=>o.replace(/\s+/g,"_").replace(/[^A-Za-z0-9_-]/g,"");return`${i(r)}_${i(n).toUpperCase()}_${i(a).toUpperCase()}_${i(e.roundId)}_${e.templateId||"ward_round_v1"}.png`},q0=async(s,e)=>{const r=URL.createObjectURL(s);try{if(typeof chrome<"u"&&chrome.downloads?.download)await chrome.downloads.download({url:r,filename:e,saveAs:!1});else{const a=document.createElement("a");a.href=r,a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a)}}finally{URL.revokeObjectURL(r)}},pT=(s,e,r)=>{const a=document.createElement("canvas");a.width=r.image_width,a.height=r.image_height;const n=a.getContext("2d");if(!n)throw new Error("Canvas 2D context unavailable");n.fillStyle="#ffffff",n.fillRect(0,0,a.width,a.height),n.fillStyle="#111827",n.font='bold 32px "Helvetica Neue", Helvetica, Arial, sans-serif';const o=`${s.mrn?.trim()||s.id} ‚Äì ${s.name||"Unknown"} ‚Äì ${e.roundId} ‚Äì ${e.ward}`;n.fillText(o,r.regions.patient_id.x+10,r.regions.patient_id.y+50),n.font='20px "Helvetica Neue", Helvetica, Arial, sans-serif',n.fillStyle="#374151",n.fillText(`Consultant: ${e.consultant||"‚Äî"}`,r.regions.patient_id.x+10,r.regions.patient_id.y+90);const l={obs:"Observations",bloods:"Bloods / Pathology",imaging:"Imaging",meds:"Medications",plan:"Plan"};return n.strokeStyle="#9ca3af",n.lineWidth=2,n.font='18px "Helvetica Neue", Helvetica, Arial, sans-serif',n.fillStyle="#4b5563",Object.entries(r.regions).forEach(([c,A])=>{if(c==="patient_id")return;n.strokeRect(A.x,A.y,A.width,A.height);const d=l[c]||c;n.fillText(d,A.x+12,A.y+28)}),new Promise((c,A)=>{a.toBlob(d=>{if(!d){A(new Error("Failed to create PNG blob"));return}c(d)},"image/png")})};class gT{layout;constructor(){this.layout=uT.ward_round_v1}async exportRound(e,r){const a=r.roundId.trim();if(!a)return{success:!1,message:"Round ID required",filesSaved:[],errors:["Round ID missing"]};const n=r.exportedAt||Rt(),i=uw(a,{icloudRoot:"",wardRoundRoot:Gp}),o=r.templateId||"ward_round_v1",l={round_id:a,created_at:n,exported_at:n,ward:r.ward,consultant:r.consultant,patient_count:e.length,template_id:o,layout_version:r.layoutVersion||this.layout.layout_version},c=[],A=[];try{const h=new Blob([JSON.stringify(l,null,2)],{type:"application/json"});await q0(h,`${i}/round.json`),c.push(`${i}/round.json`)}catch(h){A.push(`round.json: ${h.message}`)}for(const h of e)try{const f=await pT(h,{...r,roundId:a,templateId:o},this.layout),u=hT(h,{...r,roundId:a,templateId:o});await q0(f,`${i}/${u}`),c.push(`${i}/${u}`)}catch(f){A.push(`${h.name||h.id}: ${f.message}`)}const d=A.length===0;return{success:d,message:d?`Exported ${c.length} files to ${i}`:"Export completed with errors",filesSaved:c,errors:A}}}const J0="http://127.0.0.1:5859";class th{static async listPending(){const e=await fetch(`${J0}/wardround/pending`);return e.ok?(await e.json()).pending||[]:[]}static async resolvePending(e){await fetch(`${J0}/wardround/pending/${e}`,{method:"POST"})}}const fT=(s,e)=>{const r={issuesAdded:[],issuesUpdated:[],investigationsAdded:[],investigationsUpdated:[],tasksAdded:[],tasksUpdated:[],tasksCompletedById:[],tasksCompletedByText:[]};return s.issues?.forEach(a=>{if(a.action==="create_issue"&&a.issue_label&&a.initial_subpoint){r.issuesAdded.push({id:"",title:a.issue_label,status:"open",subpoints:[{id:"",timestamp:a.initial_subpoint.date||Rt(),text:a.initial_subpoint.text,type:"note"}]});return}if(a.action==="append_subpoint"){const n=e.issues.find(i=>i.id===a.issue_id||i.title===a.issue_label);n&&a.subpoint?r.issuesUpdated.push({issueId:n.id,newSubpoints:[{id:"",timestamp:a.subpoint.date||Rt(),text:a.subpoint.text,type:"note"}]}):a.issue_label&&a.subpoint&&r.issuesAdded.push({id:"",title:a.issue_label,status:"open",subpoints:[{id:"",timestamp:a.subpoint.date||Rt(),text:a.subpoint.text,type:"note"}]})}}),s.investigations?.forEach(a=>{const n=a.investigation_type==="bloods"?"Bloods":a.investigation_type;r.investigationsAdded.push({id:"",type:a.investigation_type==="bloods"?"lab":a.investigation_type==="imaging"?"imaging":"other",name:n,lastUpdatedAt:a.date||Rt(),summary:a.detail})}),s.tasks?.forEach(a=>{a.action==="add_task"&&r.tasksAdded.push({id:"",text:a.task,status:"open",createdAt:Rt(),category:a.priority==="high"?"imaging":"other"})}),r},xT=(s,e)=>fT(s.proposedChanges,e),yT=({onOpenQuickAdd:s})=>{const{patients:e,selectedPatient:r,setSelectedPatientId:a,addPatient:n,markDischarged:i,intakeParsing:o,updatePatient:l,isPatientListCollapsed:c,togglePatientList:A,clinicians:d}=yn(),h=["1 South","1 West","ICU","3 Central","1 Central","Other"],[f,u]=m.useState(!1),[x,b]=m.useState("ward"),[N,v]=m.useState(""),[j,I]=m.useState(""),[C,E]=m.useState(""),[T,Q]=m.useState(""),[D,k]=m.useState(h[0]),[R,w]=m.useState(null),L=()=>{const Se=new Date,qe=Se.getFullYear(),ut=String(Se.getMonth()+1).padStart(2,"0"),Ge=String(Se.getDate()).padStart(2,"0");return`${qe}-${ut}-${Ge}`},[M,P]=m.useState(()=>{const Se=new Date,qe=Se.toISOString().slice(0,10),ut=Se.getHours(),Ge=ut<12?"AM":ut<18?"PM":"EVE";return`${qe}_${Ge}`}),[K,$]=m.useState("1 South"),[O,W]=m.useState("SN"),[ee,V]=m.useState(!1),[q,S]=m.useState(null),[H,Y]=m.useState([]),[te,G]=m.useState([]),[X,le]=m.useState(!1),[he,ve]=m.useState(!1),[ke,Le]=m.useState(null),[Be,Re]=m.useState(""),{applyWardDiff:re}=yn(),Me=m.useMemo(()=>uw(M||"<round id>",{icloudRoot:"",wardRoundRoot:Gp}),[M]),Pe=m.useMemo(()=>{const Se=[...e].filter(qe=>qe.status==="active").sort((qe,ut)=>{const Ge=qe.roundOrder??Number.MAX_SAFE_INTEGER,rt=ut.roundOrder??Number.MAX_SAFE_INTEGER;return Ge!==rt?Ge-rt:new Date(ut.lastUpdatedAt).getTime()-new Date(qe.lastUpdatedAt).getTime()});return console.log(`[PatientsView] activePatients recalculated - Total patients: ${e.length}, Active: ${Se.length}, Discharged: ${e.filter(qe=>qe.status==="discharged").length}`),Se},[e]),be=m.useMemo(()=>[...e].filter(Se=>Se.status==="discharged").sort((Se,qe)=>new Date(qe.lastUpdatedAt).getTime()-new Date(Se.lastUpdatedAt).getTime()),[e]),ce=m.useMemo(()=>{const Se=new Map;Pe.forEach(rt=>{const Tt=rt.site?.trim()||"Unassigned",At=Se.get(Tt)||[];At.push(rt),Se.set(Tt,At)});const qe=[...h,"Unassigned"],ut=Array.from(Se.keys()).filter(rt=>!qe.includes(rt)).sort();return[...h,...ut,"Unassigned"].filter((rt,Tt,At)=>At.indexOf(rt)===Tt).filter(rt=>Se.has(rt)).map(rt=>({ward:rt,patients:(Se.get(rt)||[]).sort((Tt,At)=>{const mt=Tt.roundOrder??Number.MAX_SAFE_INTEGER,Qt=At.roundOrder??Number.MAX_SAFE_INTEGER;return mt!==Qt?mt-Qt:new Date(At.lastUpdatedAt).getTime()-new Date(Tt.lastUpdatedAt).getTime()})}))},[Pe,h]),Ie=m.useMemo(()=>{const Se=new Map;return Pe.forEach(ut=>{if(!ut.clinicianIds||ut.clinicianIds.length===0){const Ge=Se.get("Unassigned")||[];Ge.push(ut),Se.set("Unassigned",Ge)}else ut.clinicianIds.forEach(Ge=>{const rt=Se.get(Ge)||[];rt.push(ut),Se.set(Ge,rt)})}),[...d.map(ut=>ut.id),"Unassigned"].filter(ut=>Se.has(ut)).map(ut=>{const Ge=d.find(rt=>rt.id===ut);return{clinicianId:ut,clinicianName:Ge?.name||"Unassigned",clinicianRole:Ge?.role,patients:(Se.get(ut)||[]).sort((rt,Tt)=>{const At=rt.roundOrder??Number.MAX_SAFE_INTEGER,mt=Tt.roundOrder??Number.MAX_SAFE_INTEGER;return At!==mt?At-mt:new Date(Tt.lastUpdatedAt).getTime()-new Date(rt.lastUpdatedAt).getTime()})}})},[Pe,d]),pe=Se=>Se.wardEntries.some(qe=>Date.now()-new Date(qe.timestamp).getTime()<24*60*60*1e3),fe=Se=>Se.roundCompletedDate===L(),we=Se=>{const qe=L();fe(Se)?l(Se.id,Ge=>({...Ge,roundCompletedDate:void 0,lastUpdatedAt:Rt()})):(Le(Se),Re(qe))},de=()=>{if(ke){const Se=L();l(ke.id,qe=>({...qe,roundCompletedDate:Se,lastUpdatedAt:Rt()}))}Le(null),Re("")},xe=()=>{Le(null),Re("")},Ne=Se=>{w(Se)},it=(Se,qe)=>{$e(Se,qe),w(null)},st=()=>{w(null)},$e=(Se,qe)=>{if(!R||R===qe)return;const ut=ce.find(ts=>ts.ward===Se);if(!ut)return;const Ge=[...ut.patients],rt=Ge.findIndex(ts=>ts.id===R),Tt=Ge.findIndex(ts=>ts.id===qe);if(rt===-1||Tt===-1)return;const[At]=Ge.splice(rt,1);Ge.splice(Tt,0,At),ce.map(ts=>ts.ward===Se?{...ts,patients:Ge}:ts).flatMap(ts=>ts.patients).forEach((ts,Yt)=>{l(ts.id,Ht=>({...Ht,roundOrder:Yt}))})},Xe=async()=>{if(!N.trim())return;const Se=rw(N.trim(),{mrn:j.trim(),bed:C.trim(),oneLiner:T.trim(),site:D});await n(Se),u(!1),v(""),I(""),E(""),Q(""),k(h[0])},Ze=Se=>{const qe=o[Se.id]==="running",ut=Se.site?.trim()||"Unassigned",Ge=fe(Se),rt=L(),Tt=(Se.billingEntries||[]).filter(Ft=>(Ft.serviceDate||"").slice(0,10)===rt),At=Tt.filter(Ft=>Ft.status==="entered").length,mt=Tt.filter(Ft=>Ft.status==="pending").length,Qt=Tt.length>0,ts=At>0?Hu:_a,Yt=At>0&&mt===0?"text-emerald-700 bg-emerald-50 border-emerald-200":At>0?"text-blue-700 bg-blue-50 border-blue-200":"text-amber-700 bg-amber-50 border-amber-200",Ht=At>0?`Billed today (${At}${mt?` entered, ${mt} pending`:" entered"})`:mt>0?`Billing pending today (${mt})`:"",Es=Ge?"w-full text-left rounded-lg border px-3 py-2 shadow-sm transition opacity-50 bg-gray-100 border-gray-200 hover:opacity-70 hover:border-gray-300":`w-full text-left rounded-lg border p-3 shadow-sm transition border-gray-200 bg-white ${R===Se.id?"ring-2 ring-blue-200":""} hover:border-blue-400`,vt=()=>{a(Se.id),c||A()};return Ge?t.jsx("button",{onClick:vt,className:Es,draggable:!0,onDragStart:Ft=>{Ft.stopPropagation(),Ne(Se.id)},onDragOver:Ft=>Ft.preventDefault(),onDrop:Ft=>{Ft.preventDefault(),it(ut,Se.id)},onDragEnd:st,children:t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[t.jsx("label",{className:"flex items-center",onClick:Ft=>Ft.stopPropagation(),children:t.jsx("input",{type:"checkbox",checked:Ge,onChange:Ft=>{Ft.stopPropagation(),we(Se)},className:"w-3.5 h-3.5"})}),t.jsx("span",{className:"text-sm font-medium text-gray-600 truncate",children:Se.name}),Qt&&t.jsx("span",{className:`inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[10px] ${Yt}`,title:Ht,children:bs.createElement(ts,{className:"w-3 h-3"})}),t.jsx("span",{className:"text-xs text-gray-400",children:"‚Ä¢"}),t.jsxs("span",{className:"text-xs text-gray-500",children:[ut,Se.bed?` ‚Ä¢ ${Se.bed}`:""]})]}),t.jsx(cu,{className:"w-3.5 h-3.5 text-gray-300 cursor-grab flex-shrink-0"})]})},Se.id):t.jsxs("button",{onClick:vt,className:Es,draggable:!0,onDragStart:Ft=>{Ft.stopPropagation(),Ne(Se.id)},onDragOver:Ft=>Ft.preventDefault(),onDrop:Ft=>{Ft.preventDefault(),it(ut,Se.id)},onDragEnd:st,children:[t.jsxs("div",{className:"flex items-start justify-between gap-3",children:[t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsxs("label",{className:"flex items-center gap-2 text-xs text-gray-700",onClick:Ft=>Ft.stopPropagation(),children:[t.jsx("input",{type:"checkbox",checked:Ge,onChange:Ft=>{Ft.stopPropagation(),we(Se)}}),t.jsx("span",{className:"uppercase tracking-wide",children:"Done today"})]}),t.jsxs("div",{children:[t.jsx("div",{className:"text-base font-semibold text-gray-900",children:Se.name}),t.jsxs("div",{className:"text-sm text-gray-600",children:[ut,Se.bed?` ‚Ä¢ Bed ${Se.bed}`:""]})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(cu,{className:"w-4 h-4 text-gray-400 cursor-grab"}),qe&&t.jsx("span",{className:"inline-flex items-center gap-1 text-xs text-blue-700 bg-blue-50 px-2 py-1 rounded-full",children:"parsing intake‚Ä¶"}),Qt&&t.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full border px-2 py-1 text-xs ${Yt}`,title:Ht,children:[bs.createElement(ts,{className:"w-3 h-3"}),t.jsx("span",{className:"font-mono text-[11px]",children:At>0?At:mt})]}),pe(Se)&&t.jsxs("span",{className:"inline-flex items-center gap-1 text-xs text-emerald-700 bg-emerald-50 px-2 py-1 rounded-full",children:[t.jsx(ei,{className:"w-3 h-3"})," updated"]})]})]}),t.jsxs("div",{className:"mt-1 flex items-center gap-2 text-sm text-gray-600",children:[t.jsx(S2,{className:"w-4 h-4"}),t.jsxs("span",{children:[Se.site?Se.site:"Ward: not set",Se.bed?` ‚Ä¢ Bed ${Se.bed}`:""]}),t.jsx("span",{className:"text-gray-300",children:"‚Ä¢"}),t.jsxs("span",{children:["MRN: ",Se.mrn||"pending"]})]}),Se.oneLiner&&t.jsx("p",{className:"mt-2 text-sm text-gray-700 line-clamp-2",children:Se.oneLiner})]},Se.id)},ct=async()=>{if(S(null),Y([]),!Pe.length){S("No active patients to export.");return}V(!0);try{const qe=await new gT().exportRound(Pe,{roundId:M,ward:K,consultant:O,templateId:"ward_round_v1",layoutVersion:1});S(qe.message),Y(qe.errors)}catch(Se){S(Se instanceof Error?Se.message:"Export failed")}finally{V(!1)}},pt=async()=>{le(!0);try{const Se=await th.listPending();G(Se)}catch(Se){console.warn("Failed to fetch pending ward round updates",Se)}finally{le(!1)}},dt=async Se=>{const qe=e.find(Ge=>Ge.id===Se.patientId);if(!qe)return;const ut=xT(Se,qe);await re(qe.id,ut,"Ward round import (reviewed)"),await th.resolvePending(Se.id),G(Ge=>Ge.filter(rt=>rt.id!==Se.id))},xt=async Se=>{await th.resolvePending(Se.id),G(qe=>qe.filter(ut=>ut.id!==Se.id))};return t.jsxs("div",{className:"relative h-full",children:[t.jsx("div",{className:"h-full",children:r&&r.status==="active"?t.jsx(oT,{patient:r}):t.jsxs("button",{onClick:A,className:"h-full w-full flex flex-col items-center justify-center gap-3 text-sm text-gray-500 hover:bg-gray-50 transition cursor-pointer",children:[t.jsx("div",{className:"w-12 h-12 rounded-full bg-indigo-50 flex items-center justify-center",children:t.jsx(ji,{className:"w-6 h-6 text-indigo-500"})}),t.jsxs("div",{className:"text-center",children:[t.jsx("p",{className:"font-medium text-gray-700",children:"No patient selected"}),t.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Tap here to open patient list"})]})]})}),!c&&t.jsxs("div",{className:"fixed inset-0 z-40 flex",children:[t.jsx("div",{className:"flex-1 bg-black/30",onClick:A}),t.jsxs("div",{className:"relative w-full max-w-md bg-white h-full shadow-modal border-l border-gray-200 flex flex-col",children:[t.jsxs("div",{className:"sticky top-0 z-10 bg-white border-b border-gray-200 px-3 py-2 space-y-2",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h3",{className:"text-sm font-semibold text-gray-900 whitespace-nowrap",children:"Ward list"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(ye,{variant:"outline",size:"xs",onClick:()=>u(Se=>!Se),startIcon:Fr,children:"Add patient"}),t.jsx(ye,{variant:"ghost",size:"xs",onClick:A,children:"Close"})]})]}),t.jsxs("div",{className:"flex items-center gap-1 text-xs",children:[t.jsx("span",{className:"text-gray-600",children:"Group by:"}),t.jsx("button",{type:"button",onClick:()=>b("ward"),className:`px-2 py-1 rounded ${x==="ward"?"bg-indigo-100 text-indigo-700 font-medium":"text-gray-600 hover:bg-gray-100"}`,children:"Ward"}),t.jsx("button",{type:"button",onClick:()=>b("clinician"),className:`px-2 py-1 rounded ${x==="clinician"?"bg-indigo-100 text-indigo-700 font-medium":"text-gray-600 hover:bg-gray-100"}`,children:"Clinician"})]})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto px-3 pt-3 pb-4 space-y-3",children:[f&&t.jsxs("div",{className:"border border-gray-200 rounded-lg p-3 space-y-2 bg-gray-50",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[t.jsx("input",{className:"rounded-md border px-2 py-1 text-sm",placeholder:"Name",value:N,onChange:Se=>v(Se.target.value)}),t.jsx("input",{className:"rounded-md border px-2 py-1 text-sm",placeholder:"MRN/UR",value:j,onChange:Se=>I(Se.target.value)}),t.jsx("input",{className:"rounded-md border px-2 py-1 text-sm",placeholder:"Bed",value:C,onChange:Se=>E(Se.target.value)}),t.jsx("input",{className:"rounded-md border px-2 py-1 text-sm col-span-2",placeholder:"One-liner",value:T,onChange:Se=>Q(Se.target.value)}),t.jsx("select",{className:"rounded-md border px-2 py-1 text-sm col-span-2",value:D,onChange:Se=>k(Se.target.value),children:h.map(Se=>t.jsx("option",{value:Se,children:Se},Se))})]}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx(ye,{size:"xs",variant:"outline",onClick:()=>u(!1),children:"Cancel"}),t.jsx(ye,{size:"xs",onClick:Xe,disabled:!N.trim(),children:"Save"})]})]}),t.jsxs("div",{className:"space-y-4",children:[x==="ward"&&ce.map(Se=>t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center gap-2 text-[11px] font-semibold uppercase text-gray-500 px-1",children:[t.jsx("span",{children:Se.ward}),t.jsx("div",{className:"flex-1 h-px bg-gray-200"})]}),t.jsx("div",{className:"space-y-2",children:Se.patients.map(Ze)})]},Se.ward)),x==="clinician"&&Ie.map(Se=>t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center gap-2 text-[11px] font-semibold uppercase text-gray-500 px-1",children:[t.jsx("span",{children:Se.clinicianName}),Se.clinicianRole&&t.jsxs("span",{className:"text-gray-400 normal-case",children:["(",Se.clinicianRole,")"]}),t.jsx("div",{className:"flex-1 h-px bg-gray-200"})]}),t.jsx("div",{className:"space-y-2",children:Se.patients.map(Ze)})]},Se.clinicianId)),Pe.length===0&&t.jsxs("div",{className:"flex flex-col items-center justify-center py-8 px-4 text-center",children:[t.jsx("div",{className:"w-12 h-12 rounded-full bg-indigo-50 flex items-center justify-center mb-3",children:t.jsx(ji,{className:"w-6 h-6 text-indigo-500"})}),t.jsx("h4",{className:"text-sm font-medium text-gray-900 mb-1",children:"No patients yet"}),t.jsx("p",{className:"text-xs text-gray-500 mb-4 max-w-[200px]",children:"Add your first patient to start tracking rounds and tasks."}),t.jsx(ye,{size:"sm",startIcon:Fr,onClick:s,children:"Quick Add Patient"})]})]}),be.length>0&&t.jsxs("details",{className:"pt-1",children:[t.jsxs("summary",{className:"text-sm font-medium text-gray-700 cursor-pointer",children:["Discharged / archived (",be.length,")"]}),t.jsx("div",{className:"mt-2 space-y-2",children:be.map(Se=>t.jsxs("div",{className:"p-3 rounded-lg border border-gray-200 bg-gray-50",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("div",{className:"font-semibold text-gray-800",children:Se.name}),t.jsx(ye,{size:"xs",variant:"ghost",onClick:()=>i(Se.id,"active"),children:"Reopen"})]}),t.jsx("p",{className:"text-sm text-gray-600",children:Se.oneLiner||"No summary"})]},Se.id))})]})]}),t.jsxs("div",{className:"border-t border-gray-200",children:[!he&&t.jsxs("button",{onClick:()=>ve(!0),className:"w-full px-3 py-2 flex items-center justify-between text-sm text-gray-600 hover:bg-gray-50 transition",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Ya,{className:"w-4 h-4"}),t.jsx("span",{children:"Export & Import"})]}),t.jsx(Vr,{className:"w-4 h-4"})]}),he&&t.jsxs("div",{className:"px-3 py-3 space-y-3",children:[t.jsxs("button",{onClick:()=>ve(!1),className:"w-full flex items-center justify-between text-sm text-gray-600 hover:text-gray-900 transition -mt-1 mb-1",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Ya,{className:"w-4 h-4"}),t.jsx("span",{className:"font-medium",children:"Export & Import"})]}),t.jsx(ps,{className:"w-4 h-4"})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-sm font-semibold text-gray-900",children:"Export ward round cards"}),t.jsxs("div",{className:"text-xs text-gray-600",children:["Saves PNGs + round.json into ",Me]})]}),t.jsx(ye,{size:"sm",startIcon:Ya,isLoading:ee,onClick:ct,children:"Export"})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[t.jsx("input",{className:"rounded-md border px-2 py-1 text-sm col-span-2",placeholder:"Round ID",value:M,onChange:Se=>P(Se.target.value)}),t.jsx("input",{className:"rounded-md border px-2 py-1 text-sm",placeholder:"Ward",value:K,onChange:Se=>$(Se.target.value)}),t.jsx("input",{className:"rounded-md border px-2 py-1 text-sm",placeholder:"Consultant",value:O,onChange:Se=>W(Se.target.value)})]}),q&&t.jsxs("div",{className:"text-xs text-gray-700 bg-gray-50 border border-gray-200 rounded-md p-2",children:[q,H.length>0&&t.jsx("ul",{className:"list-disc pl-4 mt-1 text-rose-600",children:H.map(Se=>t.jsx("li",{children:Se},Se))})]}),t.jsxs("div",{className:"flex items-center justify-between pt-2",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-sm font-semibold text-gray-900",children:"Pending ward round updates"}),t.jsx("div",{className:"text-xs text-gray-600",children:"Review imports that need approval"})]}),t.jsx(ye,{size:"xs",variant:"outline",onClick:pt,isLoading:X,children:"Refresh"})]}),te.length===0&&t.jsx("div",{className:"text-xs text-gray-500",children:"No pending updates."}),te.length>0&&t.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:te.map(Se=>t.jsxs("div",{className:"border border-gray-200 rounded-md p-2",children:[t.jsxs("div",{className:"flex items-center justify-between text-sm font-semibold text-gray-900",children:[t.jsx("span",{children:Se.patientId}),t.jsx("span",{className:"text-xs text-gray-500",children:Se.reason})]}),t.jsx("div",{className:"text-xs text-gray-700 mt-1",children:Se.llmNotes||"Proposed changes ready for review."}),t.jsxs("div",{className:"text-xs text-gray-800 mt-2 space-y-1",children:[Se.proposedChanges.issues?.length>0&&t.jsxs("div",{children:["Issues: ",Se.proposedChanges.issues.length]}),Se.proposedChanges.investigations?.length>0&&t.jsxs("div",{children:["Investigations: ",Se.proposedChanges.investigations.length]}),Se.proposedChanges.tasks?.length>0&&t.jsxs("div",{children:["Tasks: ",Se.proposedChanges.tasks.length]})]}),t.jsxs("div",{className:"flex gap-2 mt-2",children:[t.jsx(ye,{size:"xs",onClick:()=>dt(Se),children:"Apply"}),t.jsx(ye,{size:"xs",variant:"outline",onClick:()=>xt(Se),children:"Reject"})]})]},Se.id))})]})]})]})]}),ke&&t.jsx(cT,{patient:ke,serviceDate:Be,onClose:xe,onComplete:de})]})},bT=({onSelectPatient:s})=>{const{patients:e,updatePatient:r,setSelectedPatientId:a}=yn(),[n,i]=m.useState(""),[o,l]=m.useState("all"),[c,A]=m.useState(!1),d=m.useMemo(()=>{const u=e.filter(b=>c?!0:b.status==="active"),x={};return u.forEach(b=>{const N=b.tasks.filter(v=>v.status==="open").filter(v=>!n||v.text.toLowerCase().includes(n.toLowerCase())).filter(v=>o==="all"||v.category===o);N.length&&(x[b.id]={patient:b,tasks:N})}),x},[e,n,o,c]),h=async(u,x)=>{r(x,b=>({...b,tasks:b.tasks.map(N=>N.id===u?{...N,status:N.status==="open"?"done":"open",completedAt:new Date().toISOString()}:N)}))},f=u=>{a(u),s?.()};return t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Global tasks"}),t.jsx("p",{className:"text-xs text-gray-500",children:"Open tasks across all patients"})]}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsxs("label",{className:"text-xs text-gray-600 flex items-center gap-1",children:[t.jsx("input",{type:"checkbox",checked:c,onChange:u=>A(u.target.checked)}),"Include discharged"]})})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs("div",{className:"relative flex-1",children:[t.jsx(cl,{className:"w-4 h-4 text-gray-400 absolute left-2 top-2.5"}),t.jsx("input",{className:"w-full rounded-md border px-3 py-2 text-sm pl-8",placeholder:"Search tasks",value:n,onChange:u=>i(u.target.value)})]}),t.jsxs("select",{className:"rounded-md border px-2 py-2 text-sm",value:o,onChange:u=>l(u.target.value),children:[t.jsx("option",{value:"all",children:"All categories"}),t.jsx("option",{value:"imaging",children:"Imaging"}),t.jsx("option",{value:"lab",children:"Lab"}),t.jsx("option",{value:"discharge",children:"Discharge"}),t.jsx("option",{value:"followup",children:"Follow-up"}),t.jsx("option",{value:"other",children:"Other"})]})]}),t.jsxs("div",{className:"space-y-4",children:[Object.values(d).map(u=>t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"text-sm font-semibold text-gray-900",children:[u.patient.name," ",u.patient.bed?`‚Äì Bed ${u.patient.bed}`:""]}),u.tasks.map(x=>t.jsx("div",{className:"border border-gray-200 rounded-lg p-3 bg-white shadow-sm",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"checkbox",checked:x.status==="done",onChange:()=>h(x.id,u.patient.id)}),t.jsxs("div",{children:[t.jsx("div",{className:"text-sm text-gray-900",children:x.text}),x.category&&t.jsx("div",{className:"text-xs text-gray-500",children:x.category})]})]}),t.jsx(ye,{size:"xs",variant:"ghost",startIcon:ei,onClick:()=>f(u.patient.id),children:"Go to patient"})]})},x.id))]},u.patient.id)),Object.values(d).length===0&&t.jsx("p",{className:"text-sm text-gray-500",children:"No open tasks."})]})]})},vT=[{value:"7d",label:"7d",fullLabel:"7 Days"},{value:"30d",label:"30d",fullLabel:"30 Days"},{value:"90d",label:"90d",fullLabel:"90 Days"},{value:"1y",label:"1y",fullLabel:"1 Year"},{value:"ytd",label:"YTD",fullLabel:"Year to Date"}],Ud=({title:s,value:e,subtitle:r,icon:a,color:n})=>t.jsx("div",{className:"bg-white rounded-xl border border-gray-200 p-4 shadow-sm",children:t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide",children:s}),t.jsx("p",{className:"text-2xl font-bold text-gray-900 mt-1",children:e}),r&&t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:r})]}),t.jsx("div",{className:`p-2 rounded-lg ${n}`,children:t.jsx(a,{className:"w-5 h-5"})})]})}),wT=({className:s=""})=>{const{patients:e,markBillingEntered:r}=yn(),[a,n]=m.useState("30d"),[i,o]=m.useState(new Set),l=I=>{const C=new Date,E=new Date;switch(I){case"7d":E.setDate(C.getDate()-7);break;case"30d":E.setDate(C.getDate()-30);break;case"90d":E.setDate(C.getDate()-90);break;case"1y":E.setFullYear(C.getFullYear()-1);break;case"ytd":E.setMonth(0,1),E.setHours(0,0,0,0);break}return{start:E,end:C}},c=m.useMemo(()=>{const{start:I,end:C}=l(a),E=e,T=E.filter(S=>S.status==="active"),Q=E.filter(S=>S.status==="discharged"),D=[];E.forEach(S=>{(S.billingEntries||[]).forEach(H=>{const Y=new Date(H.serviceDate);Y>=I&&Y<=C&&D.push({...H,patientId:S.id})})});const k=D.length,R=D.filter(S=>S.status==="entered"),w=D.filter(S=>S.status==="pending"),L=R.reduce((S,H)=>S+(H.fee||0),0),M=w.reduce((S,H)=>S+(H.fee||0),0),P=[];E.forEach(S=>{(S.billingEntries||[]).forEach(H=>{if(H.status==="pending"){const Y=new Date(H.serviceDate);Y>=I&&Y<=C&&P.push({...H,patientId:S.id,patientName:S.name})}})}),P.sort((S,H)=>H.serviceDate.localeCompare(S.serviceDate));const K=E.length,$=new Set(D.map(S=>S.mbsCode)),O=K>0?L/K:0,W={};D.forEach(S=>{W[S.mbsCode]||(W[S.mbsCode]={count:0,revenue:0,description:S.description}),W[S.mbsCode].count++,W[S.mbsCode].revenue+=S.fee||0});const ee=Object.entries(W).sort((S,H)=>H[1].count-S[1].count).slice(0,5),V={};D.forEach(S=>{const H=S.serviceDate.slice(0,10);V[H]||(V[H]={date:H,revenue:0,count:0}),V[H].count++,S.status==="entered"&&(V[H].revenue+=S.fee||0)});const q=Object.values(V).sort((S,H)=>S.date.localeCompare(H.date));return{totalPatients:K,activePatients:T.length,dischargedPatients:Q.length,totalBillingEntries:k,enteredCount:R.length,pendingCount:w.length,totalRevenue:L,pendingRevenue:M,uniqueCodesCount:$.size,avgBillingPerPatient:O,topCodes:ee,chartData:q,pendingItems:P}},[e,a]),A=I=>new Intl.NumberFormat("en-AU",{style:"currency",currency:"AUD",minimumFractionDigits:0,maximumFractionDigits:0}).format(I),d=I=>new Intl.DateTimeFormat("en-AU",{day:"2-digit",month:"short"}).format(new Date(I)),h=I=>new Intl.DateTimeFormat("en-AU",{day:"2-digit",month:"short",year:"numeric"}).format(new Date(I)),f=m.useMemo(()=>c.chartData.slice(-14),[c.chartData]),u=m.useMemo(()=>Math.max(...f.map(I=>I.revenue),0),[f]),x=m.useMemo(()=>Math.max(...f.map(I=>I.count),0),[f]),b=u<=0&&x>0,N=b?x:Math.max(u,1),v=b?`${N}`:A(N),j=f.length>0&&f.length<=7;return t.jsxs("div",{className:`h-full overflow-y-auto p-4 space-y-4 ${s}`,children:[t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(mc,{className:"w-5 h-5 text-indigo-600"}),t.jsx("h2",{className:"text-lg font-semibold text-gray-900 leading-tight",children:"Analytics"})]}),t.jsx("div",{className:"w-full overflow-x-auto",children:t.jsx("div",{className:"flex items-center gap-1 bg-gray-100 rounded-lg p-0.5 w-full",children:vT.map(I=>t.jsx("button",{onClick:()=>n(I.value),title:I.fullLabel,className:`flex-1 px-2 py-1 text-xs rounded-md transition-colors whitespace-nowrap text-center ${a===I.value?"bg-white text-gray-900 shadow-sm font-medium":"text-gray-600 hover:text-gray-900"}`,children:I.label},I.value))})})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsx(Ud,{title:"Total Revenue",value:A(c.totalRevenue),subtitle:`${c.enteredCount} items entered`,icon:Hu,color:"bg-green-100 text-green-600"}),t.jsx(Ud,{title:"Pending",value:A(c.pendingRevenue),subtitle:`${c.pendingCount} items pending`,icon:_a,color:"bg-amber-100 text-amber-600"}),t.jsx(Ud,{title:"Active Patients",value:c.activePatients,subtitle:`${c.dischargedPatients} discharged`,icon:ji,color:"bg-blue-100 text-blue-600"}),t.jsx(Ud,{title:"Avg per Patient",value:A(c.avgBillingPerPatient),subtitle:`${c.uniqueCodesCount} unique codes`,icon:uc,color:"bg-purple-100 text-purple-600"})]}),c.pendingItems.length>0&&t.jsxs("div",{className:"bg-white rounded-xl border border-amber-200 p-4 shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(or,{className:"w-4 h-4 text-amber-500"}),t.jsxs("h3",{className:"text-sm font-semibold text-gray-900",children:["Pending Billing (",c.pendingItems.length,")"]})]}),t.jsx("button",{onClick:async()=>{const I=c.pendingItems.map(C=>({patientId:C.patientId,entryId:C.id}));o(new Set(I.map(C=>C.entryId)));for(const{patientId:C,entryId:E}of I)await r(C,E);o(new Set)},className:"text-xs font-medium text-amber-600 hover:text-amber-700 hover:underline",children:"Mark All Entered"})]}),t.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:c.pendingItems.map(I=>t.jsxs("div",{className:"flex items-center justify-between py-2 px-2 bg-amber-50 rounded-lg border border-amber-100",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"font-mono text-xs font-medium text-amber-700",children:I.mbsCode}),t.jsx("span",{className:"text-xs text-gray-600 truncate",children:I.patientName})]}),t.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500 mt-0.5",children:[t.jsx("span",{children:I.description}),t.jsx("span",{children:"‚Ä¢"}),t.jsx("span",{children:I.serviceDate.slice(0,10)}),t.jsx("span",{children:"‚Ä¢"}),t.jsx("span",{className:"font-medium",children:A(I.fee||0)})]})]}),t.jsxs("button",{onClick:async()=>{o(C=>new Set([...C,I.id])),await r(I.patientId,I.id),o(C=>{const E=new Set(C);return E.delete(I.id),E})},disabled:i.has(I.id),className:"flex items-center gap-1 px-2 py-1 text-xs font-medium text-green-600 hover:text-green-700 hover:bg-green-50 rounded transition disabled:opacity-50",children:[t.jsx(ei,{className:"w-3.5 h-3.5"}),i.has(I.id)?"Saving...":"Entered"]})]},I.id))})]}),c.topCodes.length>0&&t.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 p-4 shadow-sm",children:[t.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Top MBS Codes"}),t.jsx("div",{className:"space-y-2",children:c.topCodes.map(([I,C])=>t.jsxs("div",{className:"flex items-center justify-between py-1.5 border-b border-gray-100 last:border-0",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("span",{className:"font-mono text-sm font-medium text-indigo-600",children:I}),t.jsx("span",{className:"text-xs text-gray-500 truncate max-w-[150px]",children:C.description})]}),t.jsxs("div",{className:"flex items-center gap-3 text-xs",children:[t.jsxs("span",{className:"text-gray-500",children:[C.count,"√ó"]}),t.jsx("span",{className:"font-medium text-gray-900",children:A(C.revenue)})]})]},I))})]}),t.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 p-4 shadow-sm",children:[t.jsxs("div",{className:"flex items-center justify-between gap-3 mb-3",children:[t.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Daily Billing"}),c.chartData.length>0&&t.jsx("span",{className:"text-[10px] text-gray-500",children:b?"Showing items":"Showing revenue"})]}),c.chartData.length===0?t.jsxs("div",{className:"py-10 text-center",children:[t.jsx("p",{className:"text-sm text-gray-500",children:"No billing entries in this range."}),t.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Add billing items to patients to see a daily trend."})]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex items-stretch gap-1",children:[t.jsxs("div",{className:"w-8 flex flex-col justify-between text-[9px] text-gray-400 select-none text-right",children:[t.jsx("span",{children:v}),t.jsx("span",{children:b?"0":"$0"})]}),t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"relative h-32",children:[t.jsxs("div",{className:"absolute inset-0 pointer-events-none",children:[t.jsx("div",{className:"absolute left-0 right-0 top-0 border-t border-gray-100"}),t.jsx("div",{className:"absolute left-0 right-0 top-1/2 border-t border-gray-100"}),t.jsx("div",{className:"absolute left-0 right-0 bottom-0 border-t border-gray-100"})]}),t.jsx("div",{className:"relative h-full flex items-end gap-1",children:f.map(I=>{const C=b?I.count:I.revenue,E=C/N*100,T=b?`${h(I.date)}: ${I.count} items (${A(I.revenue)} entered)`:`${h(I.date)}: ${A(I.revenue)} (${I.count} items)`,Q=b?`${I.count}`:A(I.revenue);return t.jsxs("div",{className:"flex-1 h-full flex flex-col justify-end items-center gap-1",title:T,children:[t.jsx("span",{className:"text-[9px] text-gray-600 leading-none",children:C>0?Q:""}),t.jsx("div",{className:"w-full bg-indigo-500 rounded-t transition-colors hover:bg-indigo-600",style:{height:`${Math.max(E,4)}%`}})]},I.date)})})]}),t.jsx("div",{className:"flex gap-1 mt-1 ml-8",children:f.map((I,C)=>{const E=j||C%3===0;return t.jsx("div",{className:"flex-1 text-center",children:E&&t.jsx("span",{className:"text-[9px] text-gray-400 leading-none",children:d(I.date)})},I.date)})})]})]}),b&&t.jsx("div",{className:"mt-2 text-[10px] text-gray-500",children:"Revenue is $0 because only entered items count towards revenue; chart scales by item count."})]})]}),c.totalBillingEntries===0&&t.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center",children:[t.jsx(mc,{className:"w-12 h-12 text-gray-300 mb-3"}),t.jsx("p",{className:"text-sm text-gray-500",children:"No billing data yet"}),t.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Add billing items to patients to see analytics"})]}),t.jsxs("div",{className:"bg-gray-50 rounded-xl p-4 border border-gray-100",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[t.jsx(Da,{className:"w-4 h-4 text-gray-400"}),t.jsx("h3",{className:"text-sm font-medium text-gray-700",children:"Summary"})]}),t.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xl font-bold text-gray-900",children:c.totalPatients}),t.jsx("p",{className:"text-xs text-gray-500",children:"Total Patients"})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xl font-bold text-gray-900",children:c.totalBillingEntries}),t.jsx("p",{className:"text-xs text-gray-500",children:"Billing Items"})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-xl font-bold text-gray-900",children:A(c.totalRevenue+c.pendingRevenue)}),t.jsx("p",{className:"text-xs text-gray-500",children:"Total Value"})]})]})]})]})},CT=["1 South","1 West","ICU","3 Central","1 Central","Other"],mw=({open:s,onClose:e,onSave:r,defaultWard:a="1 South"})=>{const[n,i]=m.useState(""),[o,l]=m.useState(""),[c,A]=m.useState(a),[d,h]=m.useState(!1);if(!s)return null;const f=async u=>{if(u.preventDefault(),!!n.trim()){h(!0);try{await r({name:n.trim(),scratchpad:o,ward:c}),i(""),l(""),A(a),e()}finally{h(!1)}}};return t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 p-4",children:t.jsxs("div",{className:"bg-white rounded-modal shadow-modal w-full max-w-lg border border-gray-200",children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-200",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Quick Add Patient"}),t.jsx("button",{onClick:e,className:"p-2 rounded-full hover:bg-gray-100 text-gray-500","aria-label":"Close quick add",children:t.jsx(es,{className:"w-5 h-5"})})]}),t.jsxs("form",{onSubmit:f,className:"p-4 space-y-3",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Name"}),t.jsx("input",{className:"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",value:n,onChange:u=>i(u.target.value),placeholder:"Jane Smith",required:!0})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Ward"}),t.jsx("select",{className:"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",value:c,onChange:u=>A(u.target.value),children:CT.map(u=>t.jsx("option",{value:u,children:u},u))})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Scratchpad / referral"}),t.jsx("textarea",{className:"mt-1 w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 min-h-[120px]",value:o,onChange:u=>l(u.target.value),placeholder:"Phone handover notes..."}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Saved as an intake note; parsed in the background to seed issues, investigations, and tasks."})]}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx(ye,{type:"button",variant:"outline",size:"sm",onClick:e,children:"Cancel"}),t.jsx(ye,{type:"submit",size:"sm",disabled:d||!n.trim(),children:d?"Saving...":"Save"})]})]})]})})},wo=({icon:s,onClick:e,tooltip:r,size:a="xs",variant:n="default",disabled:i=!1,loading:o=!1,className:l=""})=>{const c={xs:"h-6 w-6",sm:"h-7 w-7"},A={xs:"h-3.5 w-3.5",sm:"h-4 w-4"},d={default:"text-gray-700 hover:bg-gray-100 hover:text-gray-900",subtle:"text-gray-400 hover:bg-gray-50 hover:text-gray-600",danger:"text-rose-600 hover:bg-rose-50 hover:text-rose-700"};return t.jsx("button",{type:"button",onClick:e,disabled:i||o,title:r,"aria-label":r,className:`
        ${c[a]}
        ${d[n]}
        inline-flex items-center justify-center
        rounded-md
        transition-colors
        disabled:opacity-50 disabled:cursor-not-allowed
        flex-shrink-0
        ${l}
      `,children:o?t.jsx("div",{className:`${A[a]} animate-spin`,children:t.jsxs("svg",{className:"w-full h-full",fill:"none",viewBox:"0 0 24 24",children:[t.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),t.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}):t.jsx(s,{className:A[a]})})},NT=({className:s=""})=>{const{patients:e,selectedPatient:r,isPatientListCollapsed:a,togglePatientList:n,navigateToPatient:i}=yn(),o=u=>{if(!u)return!1;const x=u.tagName;return["INPUT","TEXTAREA","SELECT","OPTION","BUTTON"].includes(x)||u.isContentEditable?!0:!!u.closest('input, textarea, select, [contenteditable="true"]')},l=e.filter(u=>u.status==="active").sort((u,x)=>(u.roundOrder??0)-(x.roundOrder??0)),c=r?l.findIndex(u=>u.id===r.id):-1,A=l.length>1,d=l.length>1,h=m.useCallback(u=>{o(u.target)||(u.key==="ArrowLeft"&&A?(u.preventDefault(),i("prev")):u.key==="ArrowRight"&&d?(u.preventDefault(),i("next")):u.key==="ArrowUp"&&(u.ctrlKey||u.metaKey)&&A?(u.preventDefault(),i("prev")):u.key==="ArrowDown"&&(u.ctrlKey||u.metaKey)&&d&&(u.preventDefault(),i("next")))},[A,d,i]);if(m.useEffect(()=>(window.addEventListener("keydown",h),()=>window.removeEventListener("keydown",h)),[h]),!r)return null;const f=c>=0?`${c+1}/${l.length}`:"";return t.jsxs("div",{className:`flex items-center gap-0.5 ${s}`,role:"navigation","aria-label":"Patient selector",children:[t.jsx(wo,{icon:Np,onClick:()=>i("prev"),disabled:!A,tooltip:"Previous patient (‚Üê)"}),t.jsxs("button",{type:"button",onClick:n,className:"flex-1 flex items-center justify-center gap-1 px-2 py-0.5 rounded hover:bg-gray-100 transition-colors min-w-0 text-xs",title:"Click to toggle patient list","aria-label":`${r.name}, ${f}. Click to ${a?"show":"hide"} list`,children:[t.jsx("span",{className:"font-medium truncate text-gray-900",children:r.name}),f&&t.jsxs("span",{className:"text-[10px] text-gray-500 flex-shrink-0",children:["(",f,")"]})]}),t.jsx(wo,{icon:ti,onClick:()=>i("next"),disabled:!d,tooltip:"Next patient (‚Üí)"})]})},BT=({onQuickAdd:s,onDischarge:e,onUndo:r,onDelete:a,canUndo:n,className:i=""})=>{const[o,l]=m.useState(!1),c=m.useRef(null);m.useEffect(()=>{const d=h=>{c.current&&!c.current.contains(h.target)&&l(!1)};if(o)return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[o]),m.useEffect(()=>{const d=h=>{h.key==="Escape"&&l(!1)};if(o)return document.addEventListener("keydown",d),()=>document.removeEventListener("keydown",d)},[o]);const A=d=>{d(),l(!1)};return t.jsxs("div",{ref:c,className:`relative ${i}`,children:[t.jsx(wo,{icon:Uy,onClick:()=>l(!o),tooltip:"More actions"}),o&&t.jsx("div",{className:"absolute right-0 top-full mt-1 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-50",children:t.jsxs("div",{className:"py-1",children:[t.jsxs("button",{type:"button",onClick:()=>A(s),className:"w-full px-3 py-2 text-xs text-left hover:bg-gray-50 flex items-center gap-2 transition-colors",children:[t.jsx(Fr,{className:"h-3.5 w-3.5 text-gray-600"}),t.jsx("span",{children:"Quick Add Patient"})]}),t.jsx("div",{className:"border-t border-gray-100 my-1"}),t.jsxs("button",{type:"button",onClick:()=>A(e),className:"w-full px-3 py-2 text-xs text-left hover:bg-gray-50 flex items-center gap-2 transition-colors",children:[t.jsx(ll,{className:"h-3.5 w-3.5 text-gray-600"}),t.jsx("span",{children:"Discharge"})]}),t.jsxs("button",{type:"button",onClick:()=>A(r),disabled:!n,className:"w-full px-3 py-2 text-xs text-left hover:bg-gray-50 flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[t.jsx(Cy,{className:"h-3.5 w-3.5 text-gray-600"}),t.jsx("span",{children:"Undo Last Update"})]}),t.jsx("div",{className:"border-t border-gray-100 my-1"}),t.jsxs("button",{type:"button",onClick:()=>A(a),className:"w-full px-3 py-2 text-xs text-left hover:bg-rose-50 flex items-center gap-2 transition-colors text-rose-600",children:[t.jsx(Ln,{className:"h-3.5 w-3.5"}),t.jsx("span",{children:"Delete Patient"})]})]})})]})},ST=({onClose:s})=>{const[e,r]=m.useState("patients"),[a,n]=m.useState(!1),[i,o]=m.useState(!1),{quickAddPatient:l,patients:c,activeWard:A,selectedPatient:d,setSelectedPatientId:h,markDischarged:f,undoLastWardUpdate:u,deletePatient:x}=yn(),[b,N]=m.useState({}),[v,j]=m.useState(""),[I,C]=m.useState(!1),[E,T]=m.useState(null),[Q,D]=m.useState(!1),[k,R]=m.useState(!1),[w,L]=m.useState(""),[M,P]=m.useState(!1),[K,$]=m.useState(null),[O,W]=m.useState(null),[ee,V]=m.useState(""),[q,S]=m.useState(!1),[H,Y]=m.useState(!1),te=c.filter(Pe=>Pe.status==="active").length,G=c.reduce((Pe,be)=>Pe+be.tasks.filter(ce=>ce.status==="open").length,0),X=Pe=>$p(Pe||[]),le=d&&d.status==="active"?d:null,he=m.useMemo(()=>c.filter(Pe=>Pe.status==="active"),[c]),ve=m.useMemo(()=>he.filter(Pe=>b[Pe.id]??!0),[he,b]),ke=m.useMemo(()=>ve.map(be=>{const ce=be.issues.filter(fe=>fe.status==="open").map(fe=>{const we=fe.subpoints[fe.subpoints.length-1],de=tw(we);return`‚Ä¢ ${fe.title}${de?` ‚Äì ${de}`:""}`}).join(`
`)||"‚Ä¢ (no active issues)",Ie=be.investigations.map(fe=>fe.type==="lab"?`‚Ä¢ ${fe.name}: ${X(fe.labSeries)}`:`‚Ä¢ ${fe.name}: ${fe.summary||"pending"}`).join(`
`)||"‚Ä¢ (no key investigations)",pe=be.tasks.filter(fe=>fe.status==="open").map(fe=>`‚Ä¢ ${fe.text}`).join(`
`)||"‚Ä¢ (no open tasks)";return[`${be.name}${be.bed?` ‚Äì Bed ${be.bed}`:""}${be.oneLiner?` ‚Äì ${be.oneLiner}`:""}`,"Issues:",ce,"Investigations:",Ie,"Open tasks:",pe].join(`
`)}).join(`

`)||"No active patients.",[X,ve]),Le=async()=>{if(le)try{await chrome.runtime.sendMessage({type:"NAVIGATE_TO_PATIENT",fileNumber:le.mrn||le.name,patientName:le.name})}catch(Pe){console.error("Failed to navigate to patient",Pe)}},Be=async()=>{if(le){P(!0),$(null),W("Ensuring model is ready‚Ä¶");try{const Pe=await Bi.getInstance().generateGpLetter(le);L(Pe),W("Complete"),R(!0)}catch(Pe){$(Pe instanceof Error?Pe.message:"Failed to generate letter")}finally{P(!1),W(null)}}},Re=async()=>{if(!(!le||!w.trim()||!ee.trim())){S(!0),$(null);try{const Pe=await Bi.getInstance().refineGpLetter(le,w,ee.trim());L(Pe),V(""),vi("Updated","Letter refined")}catch(Pe){$(Pe instanceof Error?Pe.message:"Failed to refine letter")}finally{S(!1)}}},re=()=>{N(Pe=>{const be={...Pe};return he.forEach(ce=>{be[ce.id]===void 0&&(be[ce.id]=!0)}),be}),j(""),T(null),o(!0),B3("Handover",`${ve.length} patients selected`)},Me=async()=>{if(ve.length!==0){C(!0),T(null);try{const Pe=await Bi.getInstance().generateHandoverSummary(ve);j(Pe),vi("Handover summary ready","Generated via reasoning model")}catch(Pe){T(Pe instanceof Error?Pe.message:String(Pe))}finally{C(!1)}}};return t.jsxs("div",{className:"h-full flex flex-col bg-white max-w-full",children:[t.jsx("div",{className:"px-4 py-3 border-b border-gray-200 sticky top-0 z-10 bg-white",children:t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[t.jsx(wo,{icon:Ly,onClick:s,tooltip:"Back"}),t.jsx("h2",{className:"text-sm font-semibold text-gray-900 truncate",children:"Ward List"})]}),t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx(wo,{icon:Qu,onClick:re,tooltip:"Handover"}),t.jsxs("div",{className:"flex items-center gap-0.5 bg-gray-100 rounded-lg p-0.5",children:[t.jsxs("button",{onClick:()=>r("patients"),className:`flex items-center gap-1 px-2 py-1 text-xs rounded-md transition-colors ${e==="patients"?"bg-white text-gray-900 shadow-sm font-medium":"text-gray-600 hover:text-gray-900"}`,children:[t.jsx(ji,{className:"w-3.5 h-3.5"}),t.jsx("span",{children:te})]}),t.jsxs("button",{onClick:()=>r("tasks"),className:`flex items-center gap-1 px-2 py-1 text-xs rounded-md transition-colors ${e==="tasks"?"bg-white text-gray-900 shadow-sm font-medium":"text-gray-600 hover:text-gray-900"}`,children:[t.jsx(ll,{className:"w-3.5 h-3.5"}),t.jsx("span",{children:G})]}),t.jsx("button",{onClick:()=>r("analytics"),className:`flex items-center gap-1 px-2 py-1 text-xs rounded-md transition-colors ${e==="analytics"?"bg-white text-gray-900 shadow-sm font-medium":"text-gray-600 hover:text-gray-900"}`,children:t.jsx(mc,{className:"w-3.5 h-3.5"})})]})]})]})}),le&&e!=="analytics"&&t.jsxs("div",{className:"h-10 px-4 flex items-center gap-1.5 border-b border-gray-200 sticky top-[52px] z-10 bg-white",children:[t.jsx(NT,{className:"flex-1 min-w-0"}),t.jsx(wo,{icon:j2,onClick:Le,tooltip:"Go To Patient",variant:"subtle"}),t.jsx(wo,{icon:$r,onClick:()=>D(!0),tooltip:"Ward Update"}),t.jsx(wo,{icon:Rn,onClick:Be,disabled:M,loading:M,tooltip:"GP Letter"}),t.jsx(BT,{onQuickAdd:()=>n(!0),onDischarge:()=>{f(le.id,"discharged"),vi("Patient discharged",`${le.name} moved to archive`)},onUndo:()=>{u(le.id),vi("Undo successful","Last ward update reverted")},onDelete:()=>Y(!0),canUndo:!0})]}),t.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto px-3 pb-4",children:e==="patients"?t.jsx(yT,{onOpenQuickAdd:()=>n(!0)}):e==="tasks"?t.jsx(bT,{onSelectPatient:()=>r("patients")}):t.jsx(wT,{})}),t.jsx(mw,{open:a,onClose:()=>n(!1),defaultWard:A,onSave:async({name:Pe,scratchpad:be,ward:ce})=>{await l(Pe,be,ce)}}),i&&t.jsx("div",{className:"fixed inset-0 bg-black/30 z-50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white border border-gray-200 rounded-modal shadow-modal w-full max-w-2xl p-4 space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Handover"}),t.jsx(ye,{variant:"ghost",size:"sm",onClick:()=>o(!1),children:"Close"})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"text-xs font-medium text-gray-700",children:["Include patients (",ve.length,"/",he.length,")"]}),t.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-2",children:he.map(Pe=>t.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-800",children:[t.jsx("input",{type:"checkbox",checked:b[Pe.id]??!0,onChange:be=>{N(ce=>({...ce,[Pe.id]:be.target.checked})),j(""),T(null)}}),t.jsx("span",{className:"truncate",children:Pe.name}),t.jsx("span",{className:"text-gray-400 text-xs",children:Pe.bed?`‚Äì Bed ${Pe.bed}`:""})]},Pe.id))})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("div",{className:"text-xs font-medium text-gray-700",children:"Draft (auto)"}),t.jsx("textarea",{className:"w-full h-64 rounded-lg border px-3 py-2 text-sm",value:ke,readOnly:!0})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("div",{className:"text-xs font-medium text-gray-700",children:"Handover summary (AI)"}),t.jsx(ye,{size:"sm",onClick:Me,disabled:I||ve.length===0,isLoading:I,startIcon:Ac,children:"Generate"})]}),E&&t.jsx("div",{className:"text-sm text-rose-600",children:E}),t.jsx("textarea",{className:"w-full h-44 rounded-lg border px-3 py-2 text-sm",value:v,onChange:Pe=>j(Pe.target.value),placeholder:"Click Generate to create a concise handover message..."})]}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx(ye,{variant:"outline",size:"sm",onClick:async()=>{await navigator.clipboard.writeText(ke),vi("Copied","Draft handover copied to clipboard")},children:"Copy Draft"}),t.jsx(ye,{size:"sm",onClick:async()=>{const Pe=v.trim()||ke;await navigator.clipboard.writeText(Pe),vi("Copied",v.trim()?"AI summary copied to clipboard":"Draft copied to clipboard")},disabled:!ke.trim(),children:"Copy Summary"})]})]})}),le&&t.jsx(PC,{isOpen:H,onClose:()=>Y(!1),onConfirm:()=>{const Pe=le.name;x(le.id),h(null),Y(!1),vi("Patient deleted",`${Pe} removed from ward list`)},title:"Delete Patient?",message:`Are you sure you want to permanently delete ${le.name} from the ward list? This action cannot be undone.`,confirmText:"Delete",cancelText:"Cancel",confirmVariant:"danger"}),le&&t.jsx(Aw,{open:Q,onClose:()=>D(!1),patient:le}),k&&t.jsx("div",{className:"fixed inset-0 bg-black/30 z-50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white border border-gray-200 rounded-modal shadow-modal w-full max-w-2xl p-4 space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"GP discharge letter"}),t.jsx(ye,{variant:"ghost",size:"sm",onClick:()=>R(!1),children:"Close"})]}),O&&t.jsxs("div",{className:"text-xs text-gray-500",children:["Status: ",O]}),K&&t.jsx("div",{className:"text-sm text-rose-600",children:K}),t.jsx("textarea",{className:"w-full h-64 rounded-lg border px-3 py-2 text-sm",value:w,readOnly:!0}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("label",{className:"text-xs text-gray-700",children:"Refine letter (adds a revision pass)"}),t.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[t.jsx("input",{className:"flex-1 rounded-md border px-3 py-2 text-sm",placeholder:"e.g., Add follow-up plans, shorten hospital course, adjust tone",value:ee,onChange:Pe=>V(Pe.target.value),disabled:q}),t.jsx(ye,{size:"sm",onClick:Re,disabled:!ee.trim()||q,isLoading:q,children:"Refine"})]})]}),t.jsx("div",{className:"flex justify-end gap-2",children:t.jsx(ye,{variant:"outline",size:"sm",onClick:async()=>{await navigator.clipboard.writeText(w),vi("Copied","GP letter copied to clipboard")},children:"Copy"})})]})})]})},hw=s=>{const{complexity:e,modality:r,type:a}=s;return r==="f2f"?e==="simple"?a==="new"?"110":"116":a==="new"?"132":"133":r==="telehealth"?e==="simple"?a==="new"?"91824":"91825":a==="new"?"92422":"92423":r==="phone"?e==="simple"?"92440":"92443":"116"},jT=s=>{const{followUpMethod:e,followUp:r}=s;if(r==="none")return"no follow up required";const a=e==="f2f"?"F2F":e==="telehealth"?"TH":"Phone",i={"1wk":"1 week","6wk":"6 weeks","3mth":"3 months","6mth":"6 months","12mth":"12 months",none:""}[r]||"3 months";return`${a} follow up in ${i} please`},pw=s=>{const e=jT(s);if(s.followUpTasks.length===0)return e;const r=s.followUpTasks.map(a=>{let n=`- ${a.name}`;return a.location&&(n+=` @ ${a.location}`),a.timeframe&&(n+=` (${a.timeframe})`),a.notes&&(n+=`, notes: ${a.notes}`),n});return`${e}

Tasks to complete please:
${r.join(`
`)}`},ET=s=>{const e=hw(s),r="",a=pw(s),n=s.complexity==="complex"?"complex ":"",i=s.type,o=s.modality==="f2f"?"F2F":s.modality==="telehealth"?"TH":"Phone",c={none:"no FUP","1wk":"FUP 1wk","6wk":"FUP 6wk","3mth":"FUP 3mth","6mth":"FUP 6mth","12mth":"FUP 12mth"}[s.followUp],A=`${n}${i} ${o} + ${c}`;return{id:`matrix-${e}-${c.replace(/\s+/g,"-")}`,displayName:A,itemCode:e,notes:r,taskMessage:a}},kT=[{value:"simple",label:"Simple",icon:_a},{value:"complex",label:"Complex",icon:tl}],Y0=[{value:"f2f",label:"F2F",icon:Do},{value:"telehealth",label:"Telehealth",icon:E2},{value:"phone",label:"Phone",icon:Py}],IT=[{value:"new",label:"New",icon:k2},{value:"review",label:"Review",icon:vy}],TT=[{value:"1wk",label:"1 Week",icon:Da},{value:"6wk",label:"6 Weeks",icon:Da},{value:"3mth",label:"3 Months",icon:Da},{value:"6mth",label:"6 Months",icon:Da},{value:"12mth",label:"12 Months",icon:Da},{value:"none",label:"No Follow-up",icon:I2}],FT=({onGenerate:s})=>{const[e,r]=m.useState({complexity:"simple",modality:"f2f",type:"review",followUp:"3mth",followUpMethod:"f2f",followUpTasks:[]}),[a,n]=m.useState(""),i=(u,x)=>{r(b=>({...b,[u]:x}))};m.useEffect(()=>{i("followUpMethod",e.modality)},[]),m.useEffect(()=>{const u=x=>{const b=x.target;if(!(b.tagName==="INPUT"||b.tagName==="TEXTAREA"||b.isContentEditable)&&["1","2","3","4","5"].includes(x.key))switch(x.preventDefault(),x.key){case"1":{const v=e.complexity==="simple"?"complex":"simple";i("complexity",v);break}case"2":{const v=["f2f","telehealth","phone"],I=(v.indexOf(e.modality)+1)%v.length;i("modality",v[I]);break}case"3":{const v=e.type==="new"?"review":"new";i("type",v);break}case"4":{const v=["1wk","6wk","3mth","6mth","12mth","none"],I=(v.indexOf(e.followUp)+1)%v.length;i("followUp",v[I]);break}case"5":{const v=["f2f","telehealth","phone"],I=(v.indexOf(e.followUpMethod)+1)%v.length;i("followUpMethod",v[I]);break}}};return window.addEventListener("keydown",u),()=>window.removeEventListener("keydown",u)},[e]);const o=()=>{const u=ET(e);s({itemCode:u.itemCode,notes:u.notes,displayName:u.displayName,taskMessage:u.taskMessage})},l=(u,x,b,N)=>{const v={name:u,location:x,timeframe:b,notes:N};r(j=>({...j,followUpTasks:[...j.followUpTasks,v]}))},c=(u,x,b)=>{r(N=>({...N,followUpTasks:N.followUpTasks.map((v,j)=>j===u?{...v,[x]:b}:v)}))},A=u=>{r(x=>({...x,followUpTasks:x.followUpTasks.filter((b,N)=>N!==u)}))},d=()=>{a.trim()&&(l(a.trim()),n(""))},h=hw(e),f=pw(e);return t.jsxs("div",{className:"space-y-2.5",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-1.5",children:["1. Complexity ",t.jsx("span",{className:"text-xs text-gray-500 font-normal",children:"(Press 1)"})]}),t.jsx(qo,{options:kT.map(u=>({id:u.value,label:u.label,icon:u.icon})),value:e.complexity,onChange:u=>i("complexity",u),size:"sm",accentColor:"blue",fullWidth:!0})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-1.5",children:["2. Modality ",t.jsx("span",{className:"text-xs text-gray-500 font-normal",children:"(Press 2)"})]}),t.jsx(qo,{options:Y0.map(u=>({id:u.value,label:u.label,icon:u.icon})),value:e.modality,onChange:u=>i("modality",u),size:"sm",accentColor:"blue",fullWidth:!0})]}),t.jsx("div",{className:"h-0.5 bg-gradient-to-r from-blue-200 via-purple-100 to-purple-200 rounded-full"}),t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-1.5",children:["3. Appointment Type ",t.jsx("span",{className:"text-xs text-gray-500 font-normal",children:"(Press 3)"})]}),t.jsx(qo,{options:IT.map(u=>({id:u.value,label:u.label,icon:u.icon})),value:e.type,onChange:u=>i("type",u),size:"sm",accentColor:"purple",fullWidth:!0})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-1.5",children:["4. Follow-up Period ",t.jsx("span",{className:"text-xs text-gray-500 font-normal",children:"(Press 4)"})]}),t.jsx("div",{className:"grid grid-cols-3 gap-1.5",children:TT.map(u=>t.jsxs("button",{type:"button",onClick:()=>i("followUp",u.value),className:`
                px-2.5 py-1.5 text-[11px] rounded-md font-medium transition-all
                inline-flex items-center justify-between gap-1.5 border-2 leading-tight
                ${e.followUp===u.value?"bg-purple-50 text-purple-900 border-purple-200 shadow-sm":"bg-white border-purple-100 text-gray-700 hover:border-purple-200 hover:bg-purple-50/30"}
              `,children:[t.jsx(u.icon,{className:"w-3.5 h-3.5 flex-shrink-0"}),t.jsx("span",{className:"flex-1 text-left truncate",children:u.label}),e.followUp===u.value&&t.jsx(Ms,{className:"w-3.5 h-3.5 flex-shrink-0 text-purple-600"})]},u.value))})]}),t.jsx("div",{className:"h-0.5 bg-gradient-to-r from-purple-200 via-emerald-100 to-emerald-200 rounded-full"}),t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-1.5",children:["5. Follow Up Method ",t.jsx("span",{className:"text-xs text-gray-500 font-normal",children:"(Press 5)"})]}),t.jsx(qo,{options:Y0.map(u=>({id:u.value,label:u.label,icon:u.icon})),value:e.followUpMethod,onChange:u=>i("followUpMethod",u),size:"sm",accentColor:"emerald",fullWidth:!0})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-semibold text-gray-700 mb-1.5",children:["6. Follow-up Tasks ",t.jsx("span",{className:"text-xs text-gray-500 font-normal",children:"(Optional)"})]}),t.jsxs("div",{className:"mb-3 space-y-1",children:[t.jsx("div",{className:"text-xs text-gray-600",children:"Tests:"}),t.jsxs("div",{className:"space-y-1.5",children:[t.jsx("div",{className:"text-[11px] font-medium text-gray-600",children:"Imaging"}),t.jsx("div",{className:"grid grid-cols-3 gap-1",children:["TTE","CTCA","Stress Echo"].map(u=>t.jsxs("button",{type:"button",onClick:()=>l(u),className:"w-full text-[11px] py-1.5 px-2 border border-amber-200 rounded-md bg-white hover:border-amber-300 hover:bg-amber-50/50 transition-colors",children:["+ ",u]},u))}),t.jsx("div",{className:"text-[11px] font-medium text-gray-600",children:"Monitoring & Labs"}),t.jsx("div",{className:"grid grid-cols-4 gap-1",children:[{label:"Holter",value:"Holter"},{label:"HeartBug",value:"HeartBug"},{label:"RFT",value:"Respiratory Function Tests"},{label:"Bloods",value:"Review Bloods"}].map(({label:u,value:x})=>t.jsxs("button",{type:"button",onClick:()=>l(x),className:"w-full text-[11px] py-1.5 px-2 border border-amber-200 rounded-md bg-white hover:border-amber-300 hover:bg-amber-50/50 transition-colors",children:["+ ",u]},u))})]})]}),t.jsxs("div",{className:"mb-3 space-y-1",children:[t.jsx("div",{className:"text-xs text-gray-600",children:"Locations:"}),t.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-1",children:[{short:"Alfred",full:"The Alfred"},{short:"Cap Rad",full:"Capital Radiology Carlton"},{short:"Bayside",full:"Bayside Heart"},{short:"Vision Rad",full:"Vision Radiology Shepparton"},{short:"Shepp",full:"Shepparton Medical Suites"},{short:"Cabrini",full:"Cabrini"}].map(({short:u,full:x})=>t.jsxs("button",{type:"button",onClick:()=>{if(e.followUpTasks.length>0){const b=e.followUpTasks[e.followUpTasks.length-1];b.location||r(N=>({...N,followUpTasks:[...N.followUpTasks.slice(0,-1),{...b,location:x}]}))}},className:"w-full text-[11px] py-1.5 px-2 border border-amber-200 rounded-md bg-white hover:border-amber-300 hover:bg-amber-50/50 transition-colors",children:["@ ",u]},x))})]}),t.jsxs("div",{className:"mb-3 space-y-1",children:[t.jsx("div",{className:"text-xs text-gray-600",children:"Timeframe:"}),t.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-1",children:[{short:"2wk",full:"2 weeks"},{short:"4wk",full:"4 weeks"},{short:"6-8wk",full:"6-8 weeks"},{short:"Before appt",full:"prior to next appointment"},{short:"ASAP",full:"next available"}].map(({short:u,full:x})=>t.jsx("button",{type:"button",onClick:()=>{e.followUpTasks.length>0&&c(e.followUpTasks.length-1,"timeframe",x)},className:"w-full text-[11px] py-1.5 px-2 border border-amber-200 rounded-md bg-white hover:border-amber-300 hover:bg-amber-50/50 transition-colors",children:u},x))})]}),t.jsxs("div",{className:"mb-3 space-y-1",children:[t.jsx("div",{className:"text-xs text-gray-600",children:"Notes:"}),t.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-1",children:["chest discomfort","worsening dyspnoea"].map(u=>t.jsx("button",{type:"button",onClick:()=>{e.followUpTasks.length>0&&c(e.followUpTasks.length-1,"notes",u)},className:"w-full text-[11px] py-1.5 px-2 border border-amber-200 rounded-md bg-white hover:border-amber-300 hover:bg-amber-50/50 transition-colors",children:u},u))})]}),e.followUpTasks.length>0&&t.jsx("div",{className:"mb-2 space-y-1 max-h-24 overflow-y-auto",children:e.followUpTasks.map((u,x)=>t.jsxs("div",{className:"flex items-center justify-between bg-gray-50 border border-gray-200 rounded-md p-2 text-xs",children:[t.jsxs("span",{className:"text-gray-900 flex-1",children:[u.name,u.location&&t.jsxs("span",{className:"text-gray-600",children:[" @ ",u.location]}),u.timeframe&&t.jsxs("span",{className:"text-indigo-600",children:[" (",u.timeframe,")"]}),u.notes&&t.jsxs("span",{className:"text-pink-600",children:[", notes: ",u.notes]})]}),t.jsx(Zt,{onClick:()=>A(x),icon:es,variant:"ghost",size:"sm","aria-label":"Remove task",className:"text-gray-400 hover:text-red-600 ml-2 w-auto h-auto p-0.5"})]},x))}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:"text",value:a,onChange:u=>n(u.target.value),onKeyPress:u=>{u.key==="Enter"&&d()},placeholder:"Add custom task...",className:"flex-1 text-xs px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),t.jsx(Zt,{onClick:d,disabled:!a.trim(),icon:Fr,variant:"secondary",size:"md","aria-label":"Add custom task",className:"disabled:bg-gray-300"})]})]}),t.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-purple-50 rounded-lg p-2.5 border border-blue-200",children:[t.jsxs("div",{className:"flex items-start space-x-2 mb-2",children:[t.jsx(Ac,{className:"w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"text-xs font-medium text-gray-700 mb-2",children:"Preview"}),t.jsxs("div",{className:"space-y-1",children:[t.jsxs("div",{className:"text-sm font-semibold text-gray-900",children:["Item Code: ",t.jsx("span",{className:"text-blue-600",children:h})]}),t.jsxs("div",{className:"text-xs text-gray-700",children:["Task: ",t.jsxs("span",{className:"italic",children:['"',f.split(`
`)[0],'..."']})]})]})]})]}),t.jsx(Ye.button,{onClick:o,className:"w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-2.5 px-4 rounded-lg font-medium text-sm shadow-md",whileHover:{scale:1.02},whileTap:{scale:.98},children:"Apply This Appointment"})]})]})};function sh(){return{patient:{content:"",missing:[]},clinical:{content:"",missing:[]},laboratory:{content:"",missing:[]},ecg:{content:"",missing:[]},background:{content:"",missing:[]},medications:{content:"",missing:[]},social_history:{content:"",missing:[]},investigations:{content:"",missing:[]},echocardiography:{content:"",missing:[]},procedure_planning:{content:"",missing:[]},alerts:{content:"",missing:[],pre_anaesthetic_review_text:"",pre_anaesthetic_review_json:null},missing_summary:{missing_clinical:[],missing_diagnostic:[],missing_measurements:[],completeness_score:"0"}}}function xA(s){let r=0;return Object.keys(s).forEach(a=>{if(a==="missing_summary")return;const n=s[a];n&&"content"in n&&n.content&&n.content!=="Not provided"&&r++}),Math.round(r/10*100)}const gw=m.createContext(void 0),zp=["patient","status","category","referrer","location","procedureDate","referralDate","notes","datePresented"],PT={draft:"Undergoing Workup",ready:"Workup Complete Awaiting Presentation",presented:"Presentation Complete Awaiting Booking",pending:"Undergoing Workup","in-progress":"Undergoing Workup"},yA=s=>{if(typeof s=="string"){const e=s.trim();return e.length>0?e:void 0}if(s!=null)return String(s)},rh=s=>{const e={};return zp.forEach(r=>{e[r]=yA(s[r])}),e},UT=(s,e)=>{const r={},a={};return zp.forEach(n=>{const i=yA(s[n]),o=yA(e[n]);i!==o&&(r[n]=i,a[n]=o)}),{local:r,notion:a}},X0=s=>{const e=s.status?.trim(),r=e?PT[e]||e:"Undergoing Workup";return{...s,status:r,notionFieldsUpdatedAt:s.notionFieldsUpdatedAt??s.lastUpdatedAt}},LT=({children:s})=>{const e=m.useMemo(()=>yC.getInstance(),[]),r=m.useMemo(()=>W2.getInstance(),[]),[a,n]=m.useState([]),[i,o]=m.useState(null),[l,c]=m.useState(!0),A=m.useRef([]),d=m.useRef(new Set),[h,f]=m.useState(!1),[u,x]=m.useState([]),b=m.useMemo(()=>a.find(P=>P.id===i)||null,[a,i]);m.useEffect(()=>{A.current=a},[a]),m.useEffect(()=>{r.isAvailable().then(f)},[r]),m.useEffect(()=>{if(typeof chrome>"u"||!chrome.storage?.onChanged)return;const P=(K,$)=>{$==="local"&&K[Qy]&&(r.isAvailable().then(f),r.reloadConfig().catch(O=>{console.warn("[TAVIWorkupContext] Failed to reload Notion config",O)}))};return chrome.storage.onChanged.addListener(P),()=>chrome.storage.onChanged.removeListener(P)},[r]),m.useEffect(()=>{let P=!0;return(async()=>{try{const $=await e.loadWorkups();if(P){const O=$.map(X0),W=$.some((ee,V)=>ee.status!==O[V].status||ee.notionFieldsUpdatedAt!==O[V].notionFieldsUpdatedAt);n(O),W&&await e.saveWorkups(O),c(!1)}}catch($){console.error("[TAVIWorkupContext] Failed to load workups:",$),P&&(n([]),c(!1))}})(),()=>{P=!1}},[e]),m.useEffect(()=>{const P=e.subscribe(K=>{n(K.map(X0))});return()=>{P()}},[e]);const N=m.useCallback(async P=>{const K=Date.now(),$=!!P?.notionPageId,O=P?.status?.trim()||"Undergoing Workup",W={id:`workup-${K}-${Math.random().toString(36).substr(2,9)}`,patient:P?.patient||"New TAVI Workup",notionPageId:$?P?.notionPageId:void 0,notionUrl:$?P?.notionUrl:void 0,referralDate:P?.referralDate,referrer:P?.referrer,location:P?.location,procedureDate:P?.procedureDate,category:P?.category,notes:P?.notes,datePresented:P?.datePresented,structuredSections:sh(),createdAt:K,lastUpdatedAt:K,completionPercentage:0,status:O,lastSyncedAt:$?K:void 0,notionLastEditedAt:$?P?.lastEditedTime:void 0,notionFieldsUpdatedAt:$?void 0:K};return await e.addWorkup(W),o(W.id),W},[e]),v=m.useCallback(async(P,K,$={})=>{const O=$.source??"local";await e.updateWorkup(P,W=>{const ee=Date.now(),V=K(W),q=rh(W),S=rh(V),H=O!=="notion"&&zp.some(te=>yA(q[te])!==yA(S[te])),Y={...V,lastUpdatedAt:ee,notionFieldsUpdatedAt:H?ee:W.notionFieldsUpdatedAt};return $.clearSyncError&&(Y.notionSyncError=void 0),$.clearSyncConflict&&(Y.notionSyncConflict=void 0),Y})},[e]),j=m.useCallback(async P=>{await e.deleteWorkup(P),i===P&&o(null)},[e,i]),I=m.useCallback(P=>({patient:P.patient||"New TAVI Workup",status:P.status?.trim()||"Undergoing Workup",category:P.category,referrer:P.referrer,location:P.location,procedureDate:P.procedureDate,referralDate:P.referralDate,notes:P.notes,datePresented:P.datePresented}),[]),C=m.useCallback(P=>({patient:P.patient||"New TAVI Workup",status:P.status?.trim()||"Undergoing Workup",category:P.category,referrer:P.referrer,location:P.location,procedureDate:P.procedureDate,referralDate:P.referralDate,notes:P.notes,datePresented:P.datePresented}),[]),E=m.useCallback(async(P,K={})=>{if(!h||P.notionSyncConflict||P.notionSyncError&&!K.force)return;const $=I(P),O=Date.now();try{if(P.notionPageId){const W=await r.updateWorkupPage(P.notionPageId,$),ee=W.last_edited_time?new Date(W.last_edited_time).getTime():O;await v(P.id,V=>({...V,lastSyncedAt:O,notionLastEditedAt:ee,notionUrl:W.url??V.notionUrl}),{source:"notion",clearSyncError:!0,clearSyncConflict:K.clearConflict}),console.log(`[TAVIWorkupContext] Updated Notion workup: ${P.notionPageId}`)}else{const W=await r.createWorkupPage($),ee=W.last_edited_time?new Date(W.last_edited_time).getTime():O;await v(P.id,V=>({...V,notionPageId:W.id,notionUrl:W.url??V.notionUrl,lastSyncedAt:O,notionLastEditedAt:ee}),{source:"notion",clearSyncError:!0,clearSyncConflict:K.clearConflict}),console.log(`[TAVIWorkupContext] Created Notion workup: ${W.id}`)}}catch(W){const ee=W instanceof Error?W.message:String(W);await v(P.id,V=>({...V,notionSyncError:ee}),{source:"notion"}),console.error("[TAVIWorkupContext] Failed to sync workup to Notion:",W)}},[I,h,r,v]),T=m.useCallback(async P=>{const K=new Map;A.current.forEach($=>{$.notionPageId&&K.set($.notionPageId,$)});for(const $ of P){const O=K.get($.notionPageId);if(!O||O.notionSyncConflict)continue;const W=C($),ee=rh(O),{local:V,notion:q}=UT(ee,W),S=Object.keys(V).length>0,H=$.lastEditedTime,Y=O.notionFieldsUpdatedAt||0,te=O.lastSyncedAt||0,G=Y>te,X=H>(O.notionLastEditedAt||0);if(!S){X&&await v(O.id,le=>({...le,notionLastEditedAt:H,notionUrl:$.notionUrl,lastSyncedAt:Date.now()}),{source:"notion",clearSyncError:!0});continue}if(G&&X){const le={detectedAt:Date.now(),localEditedAt:O.notionFieldsUpdatedAt,notionEditedAt:H,preferredSource:H>=Y?"notion":"local",local:V,notion:q};await v(O.id,he=>({...he,notionSyncConflict:le}),{source:"notion"});continue}X&&!G&&await v(O.id,le=>({...le,...W,notionUrl:$.notionUrl,lastSyncedAt:Date.now(),notionLastEditedAt:H}),{source:"notion",clearSyncError:!0,clearSyncConflict:!0})}},[C,v]),Q=m.useCallback(async()=>{try{const P=await r.isAvailable();if(f(P),!P){x([]);return}const K=await r.fetchPatientList({includePresented:!0});x(K),await T(K),console.log(`[TAVIWorkupContext] Fetched ${K.length} Notion patients`)}catch(P){console.error("[TAVIWorkupContext] Failed to fetch Notion patient list:",P)}},[T,r]),D=m.useCallback(async P=>{const K=A.current.find($=>$.id===P);K&&(await v(P,$=>({...$,notionSyncError:void 0}),{source:"notion",clearSyncError:!0}),await E({...K,notionSyncError:void 0},{force:!0}))},[E,v]),k=m.useCallback(async(P,K)=>{const $=A.current.find(W=>W.id===P);if(!$?.notionSyncConflict)return;const O=$.notionSyncConflict;if(K==="notion"){await v(P,W=>({...W,...O.notion,notionSyncError:void 0,notionSyncConflict:void 0,lastSyncedAt:Date.now(),notionLastEditedAt:O.notionEditedAt??W.notionLastEditedAt}),{source:"notion",clearSyncError:!0,clearSyncConflict:!0});return}await v(P,W=>({...W,notionSyncError:void 0,notionSyncConflict:void 0}),{source:"notion",clearSyncError:!0,clearSyncConflict:!0}),await E({...$,notionSyncConflict:void 0},{force:!0,clearConflict:!0})},[E,v]);m.useEffect(()=>{Q();const P=setInterval(()=>{Q()},15e3);return()=>{clearInterval(P)}},[Q]),m.useEffect(()=>{l||!h||a.forEach(P=>{if(P.notionSyncConflict||P.notionSyncError)return;const K=P.notionFieldsUpdatedAt||0,$=P.lastSyncedAt||0;K>$&&(d.current.has(P.id)||(d.current.add(P.id),E(P).finally(()=>{d.current.delete(P.id)})))})},[l,h,E,a]);const R=m.useCallback(async P=>{const{TAVIWorkupAgent:K}=await ns(async()=>{const{TAVIWorkupAgent:q}=await import("./chunks/agents.D6Qu3kid.js").then(S=>S.k);return{TAVIWorkupAgent:q}},__vite__mapDeps([5,6,4,2,1])),O=await new K().process(P),W=O.patientData?.name||"New TAVI Workup",ee=Date.now(),V={id:`workup-${ee}-${Math.random().toString(36).substr(2,9)}`,patient:W,structuredSections:O.structuredSections||sh(),createdAt:ee,lastUpdatedAt:ee,completionPercentage:xA(O.structuredSections||sh()),status:"Undergoing Workup",notionFieldsUpdatedAt:ee,validationResult:O.validationResult,extractedData:O.extractedData};return await e.addWorkup(V),o(V.id),console.log(`[TAVIWorkupContext] Generated full workup: ${V.id}`),V},[e]),w=m.useCallback(async(P,K,$)=>{const{TAVIWorkupIncrementalService:O}=await ns(async()=>{const{TAVIWorkupIncrementalService:ee}=await Promise.resolve().then(()=>DT);return{TAVIWorkupIncrementalService:ee}},void 0),W=O.getInstance();await v(P,ee=>{const V=ee.structuredSections[K];if(!V||!("content"in V))throw new Error(`Invalid section key: ${K}`);const q=W.mergeContent(V.content,$),S={...ee.structuredSections,[K]:{...V,content:q}};return{...ee,structuredSections:S,completionPercentage:xA(S)}}),console.log(`[TAVIWorkupContext] Appended content to section ${K} in workup ${P}`)},[v]),L=m.useCallback(async P=>{const K=a.find(W=>W.id===P);if(!K)throw new Error(`Workup not found: ${P}`);const{TAVIWorkupPresentationService:$}=await ns(async()=>{const{TAVIWorkupPresentationService:W}=await Promise.resolve().then(()=>gF);return{TAVIWorkupPresentationService:W}},void 0);return await $.getInstance().presentWorkup(K),console.log(`[TAVIWorkupContext] Generated presentation for workup ${P}`),`TAVI_Workup_${K.patient.replace(/\s+/g,"_")}_${new Date().toISOString().split("T")[0]}.html`},[a]),M={workups:a,loading:l,selectedWorkupId:i,selectedWorkup:b,notionAvailable:h,notionPatients:u,setSelectedWorkupId:o,createWorkup:N,updateWorkup:v,deleteWorkup:j,generateFullWorkup:R,appendToSection:w,refreshNotionList:Q,retryNotionSync:D,resolveNotionConflict:k,generatePresentation:L};return t.jsx(gw.Provider,{value:M,children:s})},fw=()=>{const s=m.useContext(gw);if(!s)throw new Error("useTAVIWorkup must be used within a TAVIWorkupProvider");return s};class ko{static instance=null;lmService;constructor(){this.lmService=Ei.getInstance()}static getInstance(){return ko.instance||(ko.instance=new ko),ko.instance}async parseDictation(e,r){const a=`You are a medical documentation assistant helping update TAVI workup sections.

The user will provide additional dictated content to append to the "${this.getSectionTitle(r)}" section.

Your task:
1. Parse and clean up the dictated content
2. Format it appropriately for medical documentation
3. Return ONLY the cleaned content, ready to append

Rules:
- Keep medical terminology precise
- Use proper abbreviations (e.g., EF, LVEDD, mod, dil)
- Format measurements correctly (e.g., "LVEDD 59" not "LVEDD-59")
- Remove filler words but preserve clinical meaning
- Return ONLY the content, no preamble or explanation`,n=`Dictated content to add to ${this.getSectionTitle(r)}:

${e}`;try{const o=(await this.lmService.chat([{role:"system",content:a},{role:"user",content:n}],{model:"qwen/qwen3-4b-2507",maxTokens:500,temperature:.3})).choices[0].message.content.trim();return{sectionKey:r,parsedContent:o,confidence:.9}}catch(i){throw console.error("[TAVIWorkupIncrementalService] Failed to parse dictation:",i),i}}mergeContent(e,r){const a=e.trim(),n=r.trim();return!a||a==="Not provided"?n:`${a}

--- Additional Information ---
${n}`}getSectionTitle(e){return{patient:"Patient Demographics",clinical:"Clinical Assessment",laboratory:"Laboratory Values",ecg:"ECG Assessment",background:"Background History",medications:"Medications",social_history:"Social History",investigations:"Other Investigations",echocardiography:"Echocardiography",procedure_planning:"Procedure Planning",alerts:"Alerts & Considerations"}[e]}}const DT=Object.freeze(Object.defineProperty({__proto__:null,TAVIWorkupIncrementalService:ko},Symbol.toStringTag,{value:"Module"})),RT=({sectionKey:s,sectionTitle:e,onClose:r,onMerge:a})=>{const[n,i]=m.useState("idle"),[o,l]=m.useState(""),[c,A]=m.useState(""),[d,h]=m.useState(null),{isRecording:f,startRecording:u,stopRecording:x}=Hp({onRecordingComplete:b});async function b(C){i("transcribing"),h(null);try{const T=await hC.getInstance().transcribe(C);l(T.text),i("parsing");const D=await ko.getInstance().parseDictation(T.text,s);A(D.parsedContent),i("preview")}catch(E){console.error("[DictateSectionModal] Processing failed:",E),h(E instanceof Error?E.message:"Failed to process dictation"),i("idle")}}const N=m.useCallback(async()=>{h(null),l(""),A(""),await u(),i("recording")},[u]),v=m.useCallback(async()=>{await x()},[x]),j=m.useCallback(async()=>{i("merging"),h(null);try{await a(c),r()}catch(C){console.error("[DictateSectionModal] Merge failed:",C),h(C instanceof Error?C.message:"Failed to merge content"),i("preview")}},[c,a,r]),I=m.useCallback(()=>{i("idle"),l(""),A(""),h(null)},[]);return t.jsx("div",{className:"fixed inset-0 z-50 flex items-end justify-center bg-black/20",onClick:r,children:t.jsxs("div",{className:"bg-white rounded-t-2xl shadow-2xl max-w-2xl w-full mx-3 mb-3 max-h-[80vh] overflow-hidden flex flex-col",onClick:C=>C.stopPropagation(),children:[t.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-line-primary",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-semibold text-ink-primary",children:"Dictate Additional Content"}),t.jsx("p",{className:"text-sm text-ink-secondary",children:e})]}),t.jsx(ye,{variant:"ghost",size:"sm",onClick:r,icon:t.jsx(es,{className:"w-4 h-4"})})]}),t.jsxs("div",{className:"p-6 space-y-6 overflow-y-auto",children:[d&&t.jsx("div",{className:"bg-rose-50 border border-rose-200 rounded-lg p-3",children:t.jsx("p",{className:"text-sm text-rose-900",children:d})}),n==="idle"&&t.jsxs("div",{className:"text-center space-y-4",children:[t.jsx("div",{className:"w-20 h-20 rounded-full bg-purple-100 flex items-center justify-center mx-auto",children:t.jsx($r,{className:"w-10 h-10 text-purple-600"})}),t.jsx("p",{className:"text-sm text-ink-secondary",children:"Press the button below to start recording additional content for this section."}),t.jsx(ye,{variant:"primary",size:"lg",onClick:N,icon:t.jsx($r,{className:"w-4 h-4"}),children:"Start Recording"})]}),n==="recording"&&t.jsxs("div",{className:"space-y-4",children:[t.jsx(Vv,{isRecording:f}),t.jsxs("div",{className:"text-center",children:[t.jsx("p",{className:"text-sm text-ink-secondary mb-4",children:"Recording in progress..."}),t.jsx(ye,{variant:"danger",size:"lg",onClick:v,children:"Stop Recording"})]})]}),n==="transcribing"&&t.jsxs("div",{className:"text-center space-y-4",children:[t.jsx("div",{className:"w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto"}),t.jsx("p",{className:"text-sm text-ink-secondary",children:"Transcribing audio..."})]}),n==="parsing"&&t.jsxs("div",{className:"text-center space-y-4",children:[t.jsx("div",{className:"w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto"}),t.jsx("p",{className:"text-sm text-ink-secondary",children:"Parsing and formatting content..."})]}),n==="preview"&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-ink-primary mb-2",children:"Original Transcription"}),t.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-3",children:t.jsx("p",{className:"text-sm text-ink-primary whitespace-pre-wrap",children:o})})]}),t.jsxs("div",{children:[t.jsx("h3",{className:"text-sm font-semibold text-ink-primary mb-2",children:"Parsed Content (Ready to Merge)"}),t.jsx("div",{className:"bg-emerald-50 border border-emerald-200 rounded-lg p-3",children:t.jsx("p",{className:"text-sm text-ink-primary whitespace-pre-wrap",children:c})})]}),t.jsxs("div",{className:"flex items-center justify-end gap-2 pt-4 border-t border-line-primary",children:[t.jsx(ye,{variant:"ghost",size:"md",onClick:I,children:"Record Again"}),t.jsx(ye,{variant:"primary",size:"md",onClick:j,icon:t.jsx(Ms,{className:"w-4 h-4"}),children:"Merge Content"})]})]}),n==="merging"&&t.jsxs("div",{className:"text-center space-y-4",children:[t.jsx("div",{className:"w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto"}),t.jsx("p",{className:"text-sm text-ink-secondary",children:"Merging content into workup..."})]})]})]})})},MT=({planning:s,onUpdate:e,selectedValveName:r})=>{const[a,n]=m.useState(!0),[i,o]=m.useState(!1),[l,c]=m.useState(s||Ld()),A=m.useCallback(()=>{c(s||Ld()),o(!0)},[s]),d=m.useCallback(()=>{e(l),o(!1)},[l,e]),h=m.useCallback(()=>{c(s||Ld()),o(!1)},[s]),f=m.useCallback((b,N)=>{c(v=>({...v,[b]:N}))},[]),u=i?l:s||Ld(),x=s&&(s.access||s.wire||s.pacing||s.closure||s.predilation?.planned||s.protamine||s.notes);return t.jsxs("div",{className:"bg-white rounded-lg border border-line-primary overflow-hidden",children:[t.jsxs("button",{type:"button",onClick:()=>n(!a),className:`w-full flex items-center justify-between p-3 hover:bg-gray-50 transition-colors ${x?"bg-purple-50 border-l-4 border-l-purple-500":"bg-gray-50 border-l-4 border-l-gray-300"}`,children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Qu,{className:"w-4 h-4 text-purple-600"}),t.jsxs("div",{className:"text-left",children:[t.jsx("h3",{className:"text-sm font-semibold text-ink-primary",children:"Procedure Planning"}),t.jsx("p",{className:"text-xs text-ink-tertiary",children:x?"Planning details entered":"No planning details"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[!i&&t.jsx(ye,{variant:"ghost",size:"sm",onClick:b=>{b.stopPropagation(),A()},icon:t.jsx(Vu,{className:"w-3 h-3"}),children:"Edit"}),a?t.jsx(Vr,{className:"w-4 h-4 text-ink-tertiary"}):t.jsx(ps,{className:"w-4 h-4 text-ink-tertiary"})]})]}),a&&t.jsxs("div",{className:"p-4 border-t border-line-primary space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-[140px_1fr] gap-2 items-center",children:[t.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Device:"}),t.jsx("div",{className:"px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-600",children:r||u.device||"Not selected"})]}),t.jsxs("div",{className:"grid grid-cols-[140px_1fr] gap-2 items-start",children:[t.jsx("label",{className:"text-sm font-medium text-gray-700 pt-2",children:"Access:"}),i?t.jsx($o,{options:[...uo.access],value:u.access||"",onChange:b=>f("access",b||void 0),placeholder:bC,size:"sm"}):t.jsx("div",{className:"px-3 py-2 text-sm text-gray-900",children:u.access||"-"})]}),t.jsxs("div",{className:"grid grid-cols-[140px_1fr] gap-2 items-start",children:[t.jsx("label",{className:"text-sm font-medium text-gray-700 pt-2",children:"Wire:"}),i?t.jsx($o,{options:[...uo.wire],value:u.wire||"",onChange:b=>f("wire",b||void 0),placeholder:"Select wire",size:"sm"}):t.jsx("div",{className:"px-3 py-2 text-sm text-gray-900",children:u.wire||"-"})]}),t.jsxs("div",{className:"grid grid-cols-[140px_1fr] gap-2 items-start",children:[t.jsx("label",{className:"text-sm font-medium text-gray-700 pt-2",children:"Pacing:"}),t.jsx("div",{className:"space-y-2",children:i?t.jsxs(t.Fragment,{children:[t.jsx($o,{options:[...uo.pacing],value:u.pacing||"",onChange:b=>f("pacing",b||void 0),placeholder:"Select pacing method",size:"sm"}),u.pacing==="Existing Device"&&t.jsxs("div",{className:"pl-4 border-l-2 border-purple-200",children:[t.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Manufacturer:"}),t.jsx($o,{options:[...uo.pacingManufacturers],value:u.pacingManufacturer||"",onChange:b=>f("pacingManufacturer",b||void 0),placeholder:"Select manufacturer",size:"sm"})]})]}):t.jsxs("div",{className:"space-y-1",children:[t.jsx("div",{className:"px-3 py-2 text-sm text-gray-900",children:u.pacing||"-"}),u.pacing==="Existing Device"&&u.pacingManufacturer&&t.jsxs("div",{className:"px-3 py-1 text-xs text-gray-600 bg-gray-50 rounded",children:["Manufacturer: ",u.pacingManufacturer]})]})})]}),t.jsxs("div",{className:"grid grid-cols-[140px_1fr] gap-2 items-start",children:[t.jsx("label",{className:"text-sm font-medium text-gray-700 pt-2",children:"Closure:"}),i?t.jsx($o,{options:[...uo.closure],value:u.closure||"",onChange:b=>f("closure",b||void 0),placeholder:"Select closure device",size:"sm"}):t.jsx("div",{className:"px-3 py-2 text-sm text-gray-900",children:u.closure||"-"})]}),t.jsx("div",{className:"border-t border-gray-200 my-4"}),t.jsxs("div",{className:"space-y-3",children:[t.jsx("div",{className:"flex items-center gap-2",children:i?t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:u.predilation?.planned||!1,onChange:b=>f("predilation",{planned:b.target.checked,brand:b.target.checked?u.predilation?.brand:void 0,size:b.target.checked?u.predilation?.size:void 0}),className:"w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"}),t.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Pre-dilation planned"})]}):t.jsxs("div",{className:"text-sm font-medium text-gray-700",children:["Pre-dilation: ",u.predilation?.planned?"Planned":"Not planned"]})}),u.predilation?.planned&&t.jsxs("div",{className:"pl-6 space-y-3 border-l-2 border-purple-200",children:[t.jsxs("div",{className:"grid grid-cols-[100px_1fr] gap-2 items-start",children:[t.jsx("label",{className:"text-xs font-medium text-gray-600 pt-2",children:"Brand:"}),i?t.jsxs("select",{value:u.predilation.brand||"",onChange:b=>{const N=b.target.value||void 0,v=u.predilation?.size,j=N&&v&&[...uo.predilationSizes[N]].includes(v)?v:void 0;f("predilation",{planned:u.predilation?.planned??!1,brand:N,size:j})},className:"w-full px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500","aria-label":"Pre-dilation balloon brand",children:[t.jsx("option",{value:"",children:"Select brand"}),uo.predilationBrands.map(b=>t.jsx("option",{value:b,children:b},b))]}):t.jsx("div",{className:"px-3 py-1.5 text-sm text-gray-900",children:u.predilation.brand||"-"})]}),u.predilation.brand&&t.jsxs("div",{className:"grid grid-cols-[100px_1fr] gap-2 items-start",children:[t.jsx("label",{className:"text-xs font-medium text-gray-600 pt-2",children:"Size:"}),i?t.jsxs("select",{value:u.predilation.size||"",onChange:b=>f("predilation",{planned:u.predilation?.planned??!1,brand:u.predilation?.brand,size:b.target.value?parseInt(b.target.value):void 0}),className:"w-full px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500","aria-label":"Pre-dilation balloon size",children:[t.jsx("option",{value:"",children:"Select size"}),uo.predilationSizes[u.predilation.brand].map(b=>t.jsxs("option",{value:b,children:[b," mm"]},b))]}):t.jsx("div",{className:"px-3 py-1.5 text-sm text-gray-900",children:u.predilation.size?`${u.predilation.size} mm`:"-"})]})]})]}),t.jsx("div",{className:"border-t border-gray-200 my-4"}),t.jsxs("div",{className:"space-y-3",children:[t.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Protamine:"}),i?t.jsxs("div",{className:"pl-2 space-y-3",children:[t.jsxs("div",{className:"flex gap-4",children:[t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"radio",checked:u.protamine?.suitable===!0,onChange:()=>f("protamine",{suitable:!0,reason:void 0}),className:"w-4 h-4 text-purple-600 border-gray-300 focus:ring-purple-500"}),t.jsx("span",{className:"text-sm text-gray-700",children:"Suitable"})]}),t.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[t.jsx("input",{type:"radio",checked:u.protamine?.suitable===!1,onChange:()=>f("protamine",{suitable:!1,reason:u.protamine?.reason}),className:"w-4 h-4 text-purple-600 border-gray-300 focus:ring-purple-500"}),t.jsx("span",{className:"text-sm text-gray-700",children:"Not Suitable"})]})]}),u.protamine?.suitable===!1&&t.jsxs("div",{className:"pl-6 border-l-2 border-purple-200",children:[t.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Reason:"}),t.jsx("textarea",{value:u.protamine.reason||"",onChange:b=>f("protamine",{suitable:u.protamine?.suitable??!0,reason:b.target.value||void 0}),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500 min-h-[60px]",placeholder:"Explain why protamine is not suitable..."})]})]}):t.jsxs("div",{className:"px-3 py-2 space-y-1",children:[t.jsxs("div",{className:"text-sm text-gray-900",children:[u.protamine?.suitable===!0&&"Suitable",u.protamine?.suitable===!1&&"Not Suitable",u.protamine?.suitable===void 0&&"-"]}),u.protamine?.suitable===!1&&u.protamine.reason&&t.jsxs("div",{className:"text-xs text-gray-600 bg-gray-50 p-2 rounded",children:["Reason: ",u.protamine.reason]})]})]}),t.jsx("div",{className:"border-t border-gray-200 my-4"}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Notes:"}),i?t.jsx("textarea",{value:u.notes||"",onChange:b=>f("notes",b.target.value||void 0),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500 min-h-[80px]",placeholder:"Additional procedure planning notes..."}):t.jsx("div",{className:"px-3 py-2 text-sm text-gray-900 whitespace-pre-wrap",children:u.notes||"-"})]}),i&&t.jsxs("div",{className:"flex items-center justify-end gap-2 pt-2 border-t border-line-primary",children:[t.jsx(ye,{variant:"ghost",size:"sm",onClick:h,icon:t.jsx(es,{className:"w-3 h-3"}),children:"Cancel"}),t.jsx(ye,{variant:"primary",size:"sm",onClick:d,icon:t.jsx(Ms,{className:"w-3 h-3"}),children:"Save"})]})]})]})};function Ld(){return{predilation:{planned:!1},protamine:{suitable:!0}}}const _T=({workup:s,clinicians:e,onUpdate:r})=>{const[a,n]=m.useState(!0),[i,o]=m.useState(!1),l=m.useCallback(()=>{if(s.referringPractitionerId){const O=e.find(W=>W.id===s.referringPractitionerId);if(O?.name)return O.name}return s.referrer||""},[s.referringPractitionerId,s.referrer,e]),[c,A]=m.useState(s.referralDate||""),[d,h]=m.useState(s.referringPractitionerId||""),[f,u]=m.useState(()=>l()),[x,b]=m.useState(s.procedureDate||""),[N,v]=m.useState(s.datePresented||""),[j,I]=m.useState(s.location||""),[C,E]=m.useState(s.category||""),[T,Q]=m.useState(s.status||"Undergoing Workup"),[D,k]=m.useState(s.notes||""),R=s.referralDate||s.referringPractitionerId||s.referrer,w=m.useCallback(()=>{A(s.referralDate||""),h(s.referringPractitionerId||""),u(l()),b(s.procedureDate||""),v(s.datePresented||""),I(s.location||""),E(s.category||""),Q(s.status||"Undergoing Workup"),k(s.notes||""),o(!0)},[s.referralDate,s.referringPractitionerId,s.procedureDate,s.datePresented,s.location,s.category,s.status,s.notes,l]),L=m.useCallback(async()=>{const O=f.trim(),W=!!d.trim(),V=(W?e.find(q=>q.id===d)?.name:void 0)||O;await r(q=>({...q,status:T.trim()||"Undergoing Workup",category:C.trim()||void 0,location:j.trim()||void 0,procedureDate:x||void 0,datePresented:N||void 0,referralDate:c||void 0,referringPractitionerId:W?d:void 0,referrer:V||void 0,notes:D.trim()||void 0})),o(!1)},[C,e,N,j,D,x,c,d,f,T,r]),M=m.useCallback(()=>{A(s.referralDate||""),h(s.referringPractitionerId||""),u(l()),b(s.procedureDate||""),v(s.datePresented||""),I(s.location||""),E(s.category||""),Q(s.status||"Undergoing Workup"),k(s.notes||""),o(!1)},[s.referralDate,s.referringPractitionerId,s.procedureDate,s.datePresented,s.location,s.category,s.status,s.notes,l]),P=O=>O?new Date(O).toLocaleDateString("en-AU",{year:"numeric",month:"short",day:"numeric"}):"-",K=()=>{if(s.referringPractitionerId){const O=e.find(W=>W.id===s.referringPractitionerId);if(O?.name)return O.name}return s.referrer||"-"},$=d&&e.find(O=>O.id===d)?.name||f;return t.jsxs("div",{className:"bg-white rounded-lg border border-line-primary overflow-hidden",children:[t.jsxs("button",{type:"button",onClick:()=>n(!a),className:`w-full flex items-center justify-between p-3 hover:bg-gray-50 transition-colors ${R?"bg-blue-50 border-l-4 border-l-blue-500":"bg-gray-50 border-l-4 border-l-gray-300"}`,children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Rn,{className:"w-4 h-4 text-blue-600"}),t.jsxs("div",{className:"text-left",children:[t.jsx("h3",{className:"text-sm font-semibold text-ink-primary",children:"Details"}),t.jsx("p",{className:"text-xs text-ink-tertiary",children:R?"Referral information entered":"No referral information"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[!i&&t.jsx(ye,{variant:"ghost",size:"sm",onClick:O=>{O.stopPropagation(),w()},icon:t.jsx(Vu,{className:"w-3 h-3"}),children:"Edit"}),a?t.jsx(Vr,{className:"w-4 h-4 text-ink-tertiary"}):t.jsx(ps,{className:"w-4 h-4 text-ink-tertiary"})]})]}),a&&t.jsxs("div",{className:"p-4 border-t border-line-primary",children:[t.jsxs("div",{className:"grid grid-cols-[140px_1fr] gap-x-4 gap-y-3",children:[t.jsx("label",{className:"text-sm font-medium text-gray-700 pt-2",children:"Status:"}),i?t.jsx("input",{value:T,onChange:O=>Q(O.target.value),className:"px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500"}):t.jsx("div",{className:"px-3 py-2 text-sm text-gray-900",children:s.status||"Undergoing Workup"}),t.jsx("label",{className:"text-sm font-medium text-gray-700 pt-2",children:"Category:"}),i?t.jsx("input",{value:C,onChange:O=>E(O.target.value),className:"px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500"}):t.jsx("div",{className:"px-3 py-2 text-sm text-gray-900",children:s.category||"-"}),t.jsx("label",{className:"text-sm font-medium text-gray-700 pt-2",children:"Location:"}),i?t.jsx("input",{value:j,onChange:O=>I(O.target.value),className:"px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500"}):t.jsx("div",{className:"px-3 py-2 text-sm text-gray-900",children:s.location||"-"}),t.jsx("label",{className:"text-sm font-medium text-gray-700 pt-2",children:"Procedure Date:"}),i?t.jsx("input",{type:"date",value:x,onChange:O=>b(O.target.value),className:"px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500"}):t.jsx("div",{className:"px-3 py-2 text-sm text-gray-900",children:s.procedureDate||"-"}),t.jsx("label",{className:"text-sm font-medium text-gray-700 pt-2",children:"Date Presented:"}),i?t.jsx("input",{type:"date",value:N,onChange:O=>v(O.target.value),className:"px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500"}):t.jsx("div",{className:"px-3 py-2 text-sm text-gray-900",children:s.datePresented||"-"}),t.jsx("label",{className:"text-sm font-medium text-gray-700 pt-2",children:"Referral Date:"}),i?t.jsx("input",{type:"date",value:c,onChange:O=>A(O.target.value),className:"px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500"}):t.jsx("div",{className:"px-3 py-2 text-sm text-gray-900",children:s.referralDate||"-"}),t.jsx("label",{className:"text-sm font-medium text-gray-700 pt-2",children:"Referring Practitioner:"}),i?t.jsx($o,{options:e.map(O=>O.name),value:$,onChange:O=>{const W=e.find(ee=>ee.name===O);h(W?.id||""),u(O)},placeholder:"Select or type practitioner name",size:"sm"}):t.jsx("div",{className:"px-3 py-2 text-sm text-gray-900",children:K()}),t.jsx("label",{className:"text-sm font-medium text-gray-700 pt-2",children:"Notes:"}),i?t.jsx("textarea",{value:D,onChange:O=>k(O.target.value),rows:3,className:"px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500"}):t.jsx("div",{className:"px-3 py-2 text-sm text-gray-900 whitespace-pre-wrap",children:s.notes||"-"}),t.jsx("div",{className:"col-span-2 border-t border-gray-200 my-2"}),t.jsx("label",{className:"text-sm text-gray-500 pt-2",children:"Created:"}),t.jsx("div",{className:"px-3 py-2 text-sm text-gray-700",children:P(s.createdAt)}),t.jsx("label",{className:"text-sm text-gray-500 pt-2",children:"Last Updated:"}),t.jsx("div",{className:"px-3 py-2 text-sm text-gray-700",children:P(s.lastUpdatedAt)})]}),i&&t.jsxs("div",{className:"flex items-center justify-end gap-2 pt-4 mt-4 border-t border-gray-200",children:[t.jsx(ye,{variant:"ghost",size:"sm",onClick:M,icon:t.jsx(es,{className:"w-3 h-3"}),children:"Cancel"}),t.jsx(ye,{variant:"primary",size:"sm",onClick:L,icon:t.jsx(Ms,{className:"w-3 h-3"}),children:"Save"})]})]})]})},xw=["echocardiography","laboratory","ecg","investigations"],QT=["Normal","Low normal","Mild","Moderate","Severe"],kA={echocardiography:{catchAllFieldKey:"comments",fields:[{key:"ef",label:"EF",type:"text",options:QT,placeholder:"e.g. 55 or Normal",aliases:["ef","lvef","ejection fraction","systolic function"]},{key:"mpg",label:"MPG",type:"number",step:"0.1",inputMode:"decimal",placeholder:"Mean gradient",aliases:["mpg","mean gradient","mean pressure gradient"]},{key:"ava",label:"AVA",type:"number",step:"0.01",inputMode:"decimal",placeholder:"Valve area",aliases:["ava","aortic valve area"]},{key:"di",label:"DI",type:"number",step:"0.01",inputMode:"decimal",placeholder:"Dimensionless index",aliases:["di","dimensionless index"]},{key:"svi",label:"SVi",type:"number",step:"0.1",inputMode:"decimal",placeholder:"Stroke volume index",aliases:["svi","stroke volume index"]},{key:"rvsp",label:"RVSP",type:"number",step:"0.1",inputMode:"decimal",placeholder:"RV systolic pressure",aliases:["rvsp","right ventricular systolic pressure"]},{key:"mr",label:"MR",type:"text",placeholder:"Grade",aliases:["mr","mitral regurgitation"]},{key:"comments",label:"Comments",type:"textarea",placeholder:"Free text comments",aliases:["comments","comment","notes"]}]},laboratory:{extraLabel:"Notes",fields:[{key:"hb",label:"Hb (g/L)",type:"number",step:"1",inputMode:"numeric",placeholder:"Haemoglobin",aliases:["hb","haemoglobin","hemoglobin"]},{key:"cr",label:"Cr (umol/L)",type:"number",step:"1",inputMode:"numeric",placeholder:"Creatinine",aliases:["cr","creatinine"]},{key:"egfr",label:"eGFR (mL/min/1.73m2)",type:"number",step:"1",inputMode:"numeric",placeholder:"eGFR",aliases:["egfr","e-gfr"]},{key:"albumin",label:"Albumin (g/L)",type:"number",step:"1",inputMode:"numeric",placeholder:"Albumin",aliases:["albumin"]}]},ecg:{extraLabel:"Notes",fields:[{key:"rate",label:"Rate (bpm)",type:"number",step:"1",inputMode:"numeric",placeholder:"Heart rate",aliases:["rate","heart rate","hr"]},{key:"rhythm",label:"Rhythm",type:"text",placeholder:"e.g. sinus rhythm",aliases:["rhythm"]},{key:"morphology",label:"Morphology",type:"text",placeholder:"e.g. LBBB",aliases:["morphology","qrs morphology"]},{key:"qrs_width",label:"QRS width (ms)",type:"number",step:"1",inputMode:"numeric",placeholder:"QRS duration",aliases:["qrs width","qrs duration"]},{key:"pr_interval",label:"PR interval (ms)",type:"number",step:"1",inputMode:"numeric",placeholder:"PR interval",aliases:["pr interval","pr"]}]},investigations:{catchAllFieldKey:"findings",fields:[{key:"approach",label:"Approach",type:"text",placeholder:"e.g. radial",aliases:["approach","access"]},{key:"findings",label:"Findings",type:"textarea",placeholder:"Summary findings",aliases:["findings","results","result"]}]}},OT=new Set(["","not provided","none","no data available","no data","not available"]),Lu=s=>s.toLowerCase().replace(/[*_]+/g,"").replace(/[^a-z0-9]+/g," ").replace(/\s+/g," ").trim(),HT=/^\s*(?:[-*]\s*)?(?:\*\*|__)?([^:*]+?)(?:\*\*|__)?\s*[:\-]\s*(.+)$/,VT=s=>{const e=new Map;return s.fields.forEach(r=>{e.set(Lu(r.label),r.key),r.aliases?.forEach(a=>e.set(Lu(a),r.key))}),e},$T=s=>Array.from(s.keys()).sort((e,r)=>r.length-e.length),KT=xw.reduce((s,e)=>{const r=kA[e],a=VT(r);return s[e]={map:a,aliases:$T(a)},s},{}),GT=[{key:"hb",pattern:/\b(?:hb|h[ae]moglobin)\s*:?\s*(\d+(?:\.\d+)?)\s*(?:g\/l|g\/dl)?\b/gi,fieldName:"Hb"},{key:"cr",pattern:/\b(?:cr|creatinine)\s*:?\s*(\d+(?:\.\d+)?)\s*(?:umol\/l|Œºmol\/l|micromol\/l)?\b/gi,fieldName:"Cr"},{key:"egfr",pattern:/\b(?:egfr|e-gfr|gfr)\s*:?\s*([<>‚â•‚â§]?\s*\d+(?:\.\d+)?)\s*(?:ml\/min(?:\/1\.73m[¬≤2])?)?/gi,fieldName:"eGFR",stripComparison:!0},{key:"albumin",pattern:/\b(?:albumin|alb)\s*:?\s*(\d+(?:\.\d+)?)\s*(?:g\/l)?\b/gi,fieldName:"Albumin"}],ah=s=>xw.includes(s),zT=s=>kA[s].fields.reduce((e,r)=>(e[r.key]="",e),{}),Vc=(s,e,r)=>{const a=r.trim();a&&(s[e]?s[e]=`${s[e]}
${a}`:s[e]=a)},WT=(s,e,r)=>{const a=r.toLowerCase();for(const n of s)if(a.startsWith(`${n} `)||a.startsWith(`${n}:`)||a.startsWith(`${n}-`)){const i=r.slice(n.length).replace(/^[:\-\s]+/,"").trim();if(i){const o=e.get(n);if(o)return{key:o,value:i}}}return null},Z0=(s,e)=>{const r=e.trim(),a=kA[s],n=zT(s),i=[];if(!r||OT.has(r.toLowerCase()))return{values:n,extra:""};let o=r;if(s==="laboratory"){const{values:h,remaining:f}=qT(r);Object.assign(n,h),o=f||r}const{map:l,aliases:c}=KT[s],A=a.extraLabel?Lu(a.extraLabel):"";let d=null;return o.split(/\r?\n/).forEach(h=>{const f=h.trimEnd(),u=f.trim();if(!u)return;const x=f.match(HT);if(x){const v=x[1].trim(),j=x[2].trim(),I=Lu(v);if(A&&I===A){i.push(j),d=null;return}const C=l.get(I);if(C){Vc(n,C,j),d=C;return}if(a.catchAllFieldKey){Vc(n,a.catchAllFieldKey,`${v}: ${j}`),d=a.catchAllFieldKey;return}i.push(`${v}: ${j}`),d=null;return}const b=WT(c,l,u);if(b){Vc(n,b.key,b.value),d=b.key;return}const N=/^\s/.test(f)||/^[\-*]/.test(u);if(d&&N){Vc(n,d,u.replace(/^[-*]\s*/,""));return}if(a.catchAllFieldKey){Vc(n,a.catchAllFieldKey,u),d=a.catchAllFieldKey;return}i.push(u),d=null}),{values:n,extra:i.join(`
`).trim()}},qT=s=>{const e={},r=[];GT.forEach(({key:n,pattern:i,stripComparison:o})=>{const l=new RegExp(i.source,i.flags);Array.from(s.matchAll(l)).forEach(A=>{if(A.index!==void 0){let d=A[1].trim();o&&(d=d.replace(/^[<>‚â•‚â§]\s*/,"")),e[n]=d,r.push({start:A.index,end:A.index+A[0].length})}})});let a=s;return r.sort((n,i)=>i.start-n.start),r.forEach(({start:n,end:i})=>{a=a.slice(0,n)+a.slice(i)}),a=a.replace(/,\s*,/g,",").replace(/^[,\s]+|[,\s]+$/g,"").replace(/\s+/g," ").trim(),{values:e,remaining:a}},ex=(s,e)=>{const r=e.trim();if(!r)return[];const a=r.split(/\r?\n/);return[`${s}: ${a[0]}`,...a.slice(1).map(n=>`  ${n}`)]},JT=(s,e,r)=>{const a=kA[s],n=[];a.fields.forEach(o=>{const l=e[o.key]||"";n.push(...ex(o.label,l))});const i=r.trim();return i&&n.push(...ex(a.extraLabel||"Notes",i)),n.join(`
`).trim()},nh=[{key:"patient",title:"Patient Demographics",emrField:"emrPatientDemographics"},{key:"clinical",title:"Symptoms"},{key:"background",title:"Past History",emrField:"emrBackground"},{key:"social_history",title:"Social History"},{key:"medications",title:"Medications",emrField:"emrMedications"},{key:"laboratory",title:"Lab Values",emrField:"emrLaboratory"},{key:"ecg",title:"ECG"},{key:"investigations",title:"Coronary Angiogram"},{key:"echocardiography",title:"Echocardiogram",emrField:"emrEchocardiography"},{key:"alerts",title:"Recommendation"},{key:"procedure_planning",title:"Procedure Planning"}],YT=({workup:s,onUpdate:e,className:r="",clinicians:a=[],selectedValveName:n})=>{const[i,o]=m.useState(null),[l,c]=m.useState(""),[A,d]=m.useState({}),[h,f]=m.useState(""),[u,x]=m.useState(null),b=m.useCallback(R=>{const w=s.structuredSections[R];if(w&&"content"in w){if(ah(R)){const L=Z0(R,w.content||"");d(L.values),f(L.extra),o(R);return}c(w.content||""),o(R)}},[s.structuredSections]),N=m.useCallback(async()=>{if(!i)return;const R=ah(i)?JT(i,A,h):l.trim();await e(w=>{const L={...w.structuredSections,[i]:{...w.structuredSections[i],content:R}};return{...w,structuredSections:L,completionPercentage:xA(L)}}),o(null),c(""),d({}),f("")},[i,l,h,A,e]),v=m.useCallback(()=>{o(null),c(""),d({}),f("")},[]),j=m.useCallback(R=>{const w=s.structuredSections[R];return!w||!("content"in w)?!1:w.content&&w.content!=="Not provided"&&w.content.trim().length>0},[s.structuredSections]),I=m.useCallback(R=>R?!!(s[R]&&s[R].trim().length>0):!1,[s]),C=m.useCallback((R,w)=>{d(L=>({...L,[R]:w}))},[]),E=m.useCallback(R=>{x(R)},[]),T=m.useCallback(async R=>{if(!u)return;const w=ko.getInstance(),L=s.structuredSections[u];if(L&&"content"in L){const M=w.mergeContent(L.content,R);await e(P=>{const K={...P.structuredSections,[u]:{...L,content:M}};return{...P,structuredSections:K,completionPercentage:xA(K)}})}x(null)},[u,s.structuredSections,e]),Q=R=>{if(R.key==="procedure_planning")return t.jsx(MT,{planning:s.procedurePlanning,onUpdate:V=>e(q=>({...q,procedurePlanning:V})),selectedValveName:n},R.key);const w=s.structuredSections[R.key],L=i===R.key,M=j(R.key),P=I(R.emrField),K=ah(R.key)?R.key:null,$=K?kA[K]:null,O=K?Z0(K,w&&"content"in w?w.content:""):null,W=O?Object.values(O.values).some(V=>V.trim().length>0):!1,ee=O?O.extra.trim().length>0:!1;return t.jsxs("div",{className:"bg-white rounded-lg border border-line-primary overflow-hidden",children:[t.jsxs("div",{className:`p-3 flex items-center justify-between ${M?"bg-emerald-50 border-l-4 border-l-emerald-500":"bg-gray-50 border-l-4 border-l-gray-300"}`,children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("h3",{className:"text-sm font-semibold text-ink-primary",children:R.title}),P&&t.jsx("span",{className:"cursor-help",title:"Auto-filled from EMR",children:t.jsx(Ty,{className:"w-3.5 h-3.5 text-blue-600"})})]}),R.key==="patient"&&s.patient?t.jsx("p",{className:"text-sm font-medium text-purple-700 mt-1",children:s.patient}):null,t.jsx("p",{className:"text-xs text-ink-tertiary mt-0.5",children:M?"Complete":"Not provided"})]}),!L&&t.jsxs("div",{className:"flex items-center gap-0.5 flex-shrink-0 bg-white/50 rounded-md border border-line-secondary",children:[t.jsx("button",{type:"button",onClick:()=>E(R.key),className:"p-1.5 hover:bg-gray-100 rounded-l-md transition-colors",title:"Dictate",children:t.jsx($r,{className:"w-3.5 h-3.5 text-ink-secondary"})}),t.jsx("div",{className:"w-px h-4 bg-line-secondary"}),t.jsx("button",{type:"button",onClick:()=>b(R.key),className:"p-1.5 hover:bg-gray-100 rounded-r-md transition-colors",title:"Edit",children:t.jsx(Vu,{className:"w-3.5 h-3.5 text-ink-secondary"})})]})]}),t.jsx("div",{className:"p-3 border-t border-line-primary",children:L?K&&$?t.jsxs("div",{className:"space-y-3",children:[t.jsx("div",{className:"grid grid-cols-[140px_1fr] gap-x-3 gap-y-3 text-xs",children:$.fields.map((V,q)=>{const S=V.options?`${R.key}-${V.key}-options`:void 0;return t.jsxs(bs.Fragment,{children:[t.jsx("label",{className:"font-medium text-ink-secondary",children:V.label}),V.type==="textarea"?t.jsx("textarea",{value:A[V.key]||"",onChange:H=>C(V.key,H.target.value),className:"w-full min-h-[80px] px-2 py-1.5 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-xs",placeholder:V.placeholder,autoFocus:q===0}):t.jsxs(t.Fragment,{children:[t.jsx("input",{type:V.type==="number"?"number":"text",inputMode:V.inputMode,step:V.step,value:A[V.key]||"",onChange:H=>C(V.key,H.target.value),className:"w-full px-2 py-1.5 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-xs",placeholder:V.placeholder,list:S,autoFocus:q===0}),S&&t.jsx("datalist",{id:S,children:V.options?.map(H=>t.jsx("option",{value:H},H))})]})]},V.key)})}),$.extraLabel&&h.trim().length>0&&t.jsxs("div",{className:"space-y-1",children:[t.jsx("label",{className:"text-xs font-medium text-ink-secondary",children:$.extraLabel}),t.jsx("textarea",{value:h,onChange:V=>f(V.target.value),className:"w-full min-h-[80px] px-2 py-1.5 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-xs"})]}),t.jsxs("div",{className:"flex items-center justify-end gap-2",children:[t.jsx(ye,{variant:"ghost",size:"sm",onClick:v,icon:t.jsx(es,{className:"w-3 h-3"}),children:"Cancel"}),t.jsx(ye,{variant:"primary",size:"sm",onClick:N,icon:t.jsx(Ms,{className:"w-3 h-3"}),children:"Save"})]})]}):t.jsxs("div",{className:"space-y-2",children:[t.jsx("textarea",{value:l,onChange:V=>c(V.target.value),className:"w-full min-h-[120px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm",placeholder:`Enter ${R.title.toLowerCase()}...`,autoFocus:!0}),t.jsxs("div",{className:"flex items-center justify-end gap-2",children:[t.jsx(ye,{variant:"ghost",size:"sm",onClick:v,icon:t.jsx(es,{className:"w-3 h-3"}),children:"Cancel"}),t.jsx(ye,{variant:"primary",size:"sm",onClick:N,icon:t.jsx(Ms,{className:"w-3 h-3"}),children:"Save"})]})]}):K&&$&&O?t.jsxs("div",{className:"space-y-2",children:[t.jsx("div",{className:"grid grid-cols-[140px_1fr] gap-x-3 gap-y-2 text-xs",children:$.fields.map(V=>{const q=O.values[V.key]||"";return t.jsxs(bs.Fragment,{children:[t.jsx("div",{className:"font-medium text-ink-secondary",children:V.label}),t.jsx("div",{className:`whitespace-pre-wrap ${q?"text-ink-primary":"text-ink-tertiary"}`,children:q||"-"})]},V.key)})}),ee&&$.extraLabel&&t.jsxs("div",{className:"text-xs",children:[t.jsx("div",{className:"font-medium text-ink-secondary",children:$.extraLabel}),t.jsx("div",{className:"whitespace-pre-wrap text-ink-primary mt-1",children:O.extra})]}),!W&&!ee&&t.jsx("div",{className:"text-sm text-ink-tertiary italic",children:'Click "Edit" to add content...'})]}):t.jsx("div",{className:"prose prose-sm max-w-none",children:M?t.jsx("div",{className:"text-sm text-ink-primary whitespace-pre-wrap",children:w&&"content"in w?w.content:""}):t.jsx("div",{className:"text-sm text-ink-tertiary italic",children:'Click "Edit" to add content...'})})})]},R.key)},D=nh.find(R=>R.key==="patient"),k=nh.filter(R=>R.key!=="patient");return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:`space-y-3 ${r}`,children:[D?Q(D):null,t.jsx(_T,{workup:s,clinicians:a,onUpdate:e}),k.map(Q)]}),u&&t.jsx(RT,{sectionKey:u,sectionTitle:nh.find(R=>R.key===u)?.title||u,onClose:()=>x(null),onMerge:T})]})},XT={ct:["annulus","perimeter","area","diameter","coronary height","left main","right coronary","lm height","rca height","sinus of valsalva","sinus width","sinus height","stj","lvot","lvot area","lvot perimeter","iliac","femoral","access","cfa","cia","eia","calcium score","av calcium","lvot calcium","ct shows","ct demonstrates","computed tomography"],echo:["ejection fraction","ef","lvedd","lvesd","lv function","aortic valve area","av area","peak gradient","mean gradient","peak velocity","aortic regurgitation","ar","regurgitant volume","mitral regurgitation","mr","tricuspid regurgitation","tr","echo shows","echocardiogram","tte","transthoracic"],clinical:["symptoms","nyha","angina","syncope","dyspnea","chest pain","shortness of breath","sob","exercise tolerance","examination","murmur","heart sounds","systolic murmur","blood pressure","bp","heart rate","hr","presents with","complained of","history of"],labs:["creatinine","gfr","egfr","renal function","hemoglobin","hb","hematocrit","hct","platelets","bnp","nt-probnp","troponin","inr","pt","aptt","sodium","potassium","albumin"],background:["history","past medical history","pmh","hypertension","diabetes","hyperlipidemia","ckd","prior cabg","prior pci","prior mi","copd","asthma","pvd","stroke","tia"],medications:["aspirin","clopidogrel","ticagrelor","prasugrel","warfarin","rivaroxaban","apixaban","edoxaban","statin","atorvastatin","rosuvastatin","ace inhibitor","arb","beta blocker","diuretic","medications","current medications","takes","on"]},ZT={echo:"echocardiography",clinical:"clinical",labs:"laboratory",background:"background",medications:"medications"},Jr={annulusAreaMm2:/annulus\s+area[:\s]*(\d+(?:\.\d+)?)\s*(?:mm¬≤|mm2|square\s*mm)?/i,annulusPerimeterMm:/annulus\s+perimeter[:\s]*(\d+(?:\.\d+)?)\s*(?:mm)?/i,annulusMinDiameterMm:/(?:annulus\s+)?min(?:imum)?\s+diameter[:\s]*(\d+(?:\.\d+)?)\s*(?:mm)?/i,annulusMaxDiameterMm:/(?:annulus\s+)?max(?:imum)?\s+diameter[:\s]*(\d+(?:\.\d+)?)\s*(?:mm)?/i,coronaryLeftMainMm:/(?:left\s+main|lm)\s+(?:coronary\s+)?height[:\s]*(\d+(?:\.\d+)?)\s*(?:mm)?/i,coronaryRightMm:/(?:right\s+coronary|rca)\s+height[:\s]*(\d+(?:\.\d+)?)\s*(?:mm)?/i,lvotAreaMm2:/lvot\s+area[:\s]*(\d+(?:\.\d+)?)\s*(?:mm¬≤|mm2)?/i,lvotPerimeterMm:/lvot\s+perimeter[:\s]*(\d+(?:\.\d+)?)\s*(?:mm)?/i,stjDiameterMm:/stj\s+diameter[:\s]*(\d+(?:\.\d+)?)\s*(?:mm)?/i,stjHeightMm:/stj\s+height[:\s]*(\d+(?:\.\d+)?)\s*(?:mm)?/i,rightCIAmm:/(?:right|r)\s+(?:common\s+)?iliac[:\s]*(\d+(?:\.\d+)?)\s*(?:mm)?/i,rightEIAmm:/(?:right|r)\s+(?:external\s+)?iliac[:\s]*(\d+(?:\.\d+)?)\s*(?:mm)?/i,rightCFAmm:/(?:right|r)\s+(?:common\s+)?femoral[:\s]*(\d+(?:\.\d+)?)\s*(?:mm)?/i,leftCIAmm:/(?:left|l)\s+(?:common\s+)?iliac[:\s]*(\d+(?:\.\d+)?)\s*(?:mm)?/i,leftEIAmm:/(?:left|l)\s+(?:external\s+)?iliac[:\s]*(\d+(?:\.\d+)?)\s*(?:mm)?/i,leftCFAmm:/(?:left|l)\s+(?:common\s+)?femoral[:\s]*(\d+(?:\.\d+)?)\s*(?:mm)?/i,calciumScore:/(?:av|aortic\s+valve)\s+calcium[:\s]*(\d+(?:\.\d+)?)\s*(?:au|agatston)?/i,lvotCalciumScore:/lvot\s+calcium[:\s]*(\d+(?:\.\d+)?)\s*(?:au|agatston)?/i},tx=new Set(["annulusAreaMm2","annulusPerimeterMm","annulusMinDiameterMm","annulusMaxDiameterMm","annulusMeanDiameterMm","coronaryHeights.leftMainMm","coronaryHeights.rightCoronaryMm","lvotAreaMm2","lvotPerimeterMm","stjDiameterMm","stjHeightMm","accessVessels.rightCIAmm","accessVessels.leftCIAmm","accessVessels.rightEIAmm","accessVessels.leftEIAmm","accessVessels.rightCFAmm","accessVessels.leftCFAmm","calciumScore","lvotCalciumScore"]),eF=s=>{const e=s.match(/\{[\s\S]*\}/);return e?e[0]:s},tF=(s,e)=>{try{return JSON.parse(eF(s))}catch(r){return console.warn("[TAVIWorkupDictationParser] Failed to parse quick model JSON",{error:r instanceof Error?r.message:r,rawPreview:s?.slice(0,300)}),e}};class ec{static instance=null;lmService;constructor(){this.lmService=Ei.getInstance()}static getInstance(){return ec.instance||(ec.instance=new ec),ec.instance}async parseDictation(e,r){console.log("[TAVIWorkupDictationParser] Parsing dictation:",{transcriptionLength:e.length,targetSection:r});const a=r||this.detectSection(e),n=this.extractMeasurements(e,a),i=this.generateTextContent(e,a);return await this.enhanceWithQuickModel(e,a,n,i)}detectSection(e){const r=e.toLowerCase(),a={ct:0,echo:0,clinical:0,labs:0,background:0,medications:0,freeform:0};for(const[o,l]of Object.entries(XT))for(const c of l)r.includes(c.toLowerCase())&&(a[o]+=1);if(Math.max(...Object.values(a))===0)return"freeform";const i=Object.entries(a).filter(([o])=>o!=="freeform").sort(([,o],[,l])=>l-o)[0][0];return console.log("[TAVIWorkupDictationParser] Section scores:",a,"‚Üí",i),i}extractMeasurements(e,r){const a={},n=r==="ct",i=e.match(Jr.annulusAreaMm2);if(i)a.annulusAreaMm2=parseFloat(i[1]);else if(n){const D=this.findLooseAnnulusArea(e);D!==null&&(a.annulusAreaMm2=D)}const o=e.match(Jr.annulusPerimeterMm);if(o)a.annulusPerimeterMm=parseFloat(o[1]);else if(n){const D=this.findLooseAnnulusPerimeter(e);D!==null&&(a.annulusPerimeterMm=D)}const l=e.match(Jr.annulusMinDiameterMm);l&&(a.annulusMinDiameterMm=parseFloat(l[1]));const c=e.match(Jr.annulusMaxDiameterMm);c&&(a.annulusMaxDiameterMm=parseFloat(c[1]));const A=e.match(Jr.coronaryLeftMainMm),d=e.match(Jr.coronaryRightMm);(A||d)&&(a.coronaryHeights={leftMainMm:A?parseFloat(A[1]):void 0,rightCoronaryMm:d?parseFloat(d[1]):void 0});const h=e.match(Jr.lvotAreaMm2);h&&(a.lvotAreaMm2=parseFloat(h[1]));const f=e.match(Jr.lvotPerimeterMm);f&&(a.lvotPerimeterMm=parseFloat(f[1]));const u=e.match(Jr.stjDiameterMm);u&&(a.stjDiameterMm=parseFloat(u[1]));const x=e.match(Jr.stjHeightMm);x&&(a.stjHeightMm=parseFloat(x[1]));const b={},N=e.match(Jr.rightCIAmm);N&&(b.rightCIAmm=parseFloat(N[1]));const v=e.match(Jr.rightEIAmm);v&&(b.rightEIAmm=parseFloat(v[1]));const j=e.match(Jr.rightCFAmm);j&&(b.rightCFAmm=parseFloat(j[1]));const I=e.match(Jr.leftCIAmm);I&&(b.leftCIAmm=parseFloat(I[1]));const C=e.match(Jr.leftEIAmm);C&&(b.leftEIAmm=parseFloat(C[1]));const E=e.match(Jr.leftCFAmm);E&&(b.leftCFAmm=parseFloat(E[1])),Object.keys(b).length>0&&(a.accessVessels=b);const T=e.match(Jr.calciumScore);T&&(a.calciumScore=parseFloat(T[1]));const Q=e.match(Jr.lvotCalciumScore);return Q&&(a.lvotCalciumScore=parseFloat(Q[1])),console.log("[TAVIWorkupDictationParser] Extracted measurements:",a),a}findLooseAnnulusArea(e){const r=/\barea\b[:\s]*(\d+(?:\.\d+)?)/gi,a=e.toLowerCase();let n;for(;(n=r.exec(e))!==null;){const i=n.index??0,o=a.slice(Math.max(0,i-24),i);if(/\b(lvot|aortic\s+valve|av)\s*$/.test(o))continue;const l=parseFloat(n[1]);if(Number.isFinite(l))return l}return null}findLooseAnnulusPerimeter(e){const r=/\bperimeter\b(?!\s*[- ]?derived)\s*[:\s]*(\d+(?:\.\d+)?)/gi,a=e.toLowerCase();let n;for(;(n=r.exec(e))!==null;){const i=n.index??0,o=a.slice(Math.max(0,i-16),i);if(/\blvot\s*$/.test(o))continue;const l=parseFloat(n[1]);if(Number.isFinite(l))return l}return null}generateTextContent(e,r){if(r==="freeform"||r==="ct")return[];const a=ZT[r];return a?[{section:a,content:e.trim()}]:[]}async enhanceWithQuickModel(e,r,a,n){const i=this.estimateConfidence(a),o=this.countNumericTokens(e),l=this.countMeasurements(a);if(!(r==="ct"&&o>l))return{detectedSection:r,extractedFields:a,textContent:n,confidence:i,suggestedCorrections:[]};const A=`You are a medical AI assistant extracting CT measurements from TAVI workup dictation.

Return ONLY JSON with this shape:
{
  "fields": [
    { "field": "annulusAreaMm2", "value": 650, "confidence": 0.9 }
  ],
  "overallConfidence": 0.8
}

Rules:
- Only use fields from the allowed list.
- Only include values explicitly present in the dictation.
- If ambiguous, omit the field.
- Units: areas in mm2, lengths in mm, calcium scores in AU.
- Do not invent values or infer missing measurements.
- If "area" or "perimeter" are unqualified in CT dictation, treat them as annulus area/perimeter.

Allowed fields:
${Array.from(tx).join(", ")}`,d=["Dictation:",e,"","Regex extracted CT fields (may be incomplete):",JSON.stringify(a,null,2)].join(`
`),h={model:Tr.QUICK_MODEL,temperature:.1,max_tokens:600,messages:[{role:"system",content:A},{role:"user",content:d}],response_format:{type:"json_schema",json_schema:{name:"ct_measurement_extraction",strict:!0,schema:{type:"object",properties:{fields:{type:"array",items:{type:"object",properties:{field:{type:"string"},value:{type:"number"},confidence:{type:"number"}},required:["field","value"]}},overallConfidence:{type:"number"}},required:["fields"]}}}};try{const f=await this.lmService.makeRequest(h,void 0,"tavi-workup"),u=tF(f,{fields:[]}),x=this.buildMeasurementsFromQuickFields(u.fields||[]),b=this.mergeMeasurements(a,x),N=u.overallConfidence??this.estimateConfidence(b);return{detectedSection:r,extractedFields:b,textContent:n,confidence:N,suggestedCorrections:u.suggestedCorrections||[]}}catch(f){return console.error("[TAVIWorkupDictationParser] Quick model enhancement failed:",f),{detectedSection:r,extractedFields:a,textContent:n,confidence:i,suggestedCorrections:[]}}}countNumericTokens(e){const r=e.match(/\d+(?:\.\d+)?/g);return r?r.length:0}countMeasurements(e){let r=0;const a=n=>{typeof n=="number"&&Number.isFinite(n)&&(r+=1)};return a(e.annulusAreaMm2),a(e.annulusPerimeterMm),a(e.annulusMinDiameterMm),a(e.annulusMaxDiameterMm),a(e.annulusMeanDiameterMm),a(e.lvotAreaMm2),a(e.lvotPerimeterMm),a(e.stjDiameterMm),a(e.stjHeightMm),a(e.calciumScore),a(e.lvotCalciumScore),e.coronaryHeights&&(a(e.coronaryHeights.leftMainMm),a(e.coronaryHeights.rightCoronaryMm)),e.accessVessels&&(a(e.accessVessels.rightCIAmm),a(e.accessVessels.leftCIAmm),a(e.accessVessels.rightEIAmm),a(e.accessVessels.leftEIAmm),a(e.accessVessels.rightCFAmm),a(e.accessVessels.leftCFAmm)),e.sinusOfValsalva&&(a(e.sinusOfValsalva.leftMm),a(e.sinusOfValsalva.rightMm),a(e.sinusOfValsalva.nonCoronaryMm)),r}estimateConfidence(e){const r=this.countMeasurements(e);return r===0?.35:r===1?.55:r<=3?.7:.8}buildMeasurementsFromQuickFields(e){const r={};for(const a of e){if(!a||!Number.isFinite(a.value))continue;const n=a.field?.trim();!n||!tx.has(n)||this.setMeasurementValue(r,n,a.value)}return r}setMeasurementValue(e,r,a){const n=r.split(".");let i=e;for(let o=0;o<n.length-1;o+=1){const l=n[o];(!i[l]||typeof i[l]!="object")&&(i[l]={}),i=i[l]}i[n[n.length-1]]=a}mergeMeasurements(e,r){const a={...e,...r};return(e.coronaryHeights||r.coronaryHeights)&&(a.coronaryHeights={...e.coronaryHeights,...r.coronaryHeights}),(e.accessVessels||r.accessVessels)&&(a.accessVessels={...e.accessVessels,...r.accessVessels}),(e.sinusOfValsalva||r.sinusOfValsalva)&&(a.sinusOfValsalva={...e.sinusOfValsalva,...r.sinusOfValsalva}),(e.aorticDimensions||r.aorticDimensions)&&(a.aorticDimensions={...e.aorticDimensions,...r.aorticDimensions}),a}}const sF=[{value:"annulusAreaMm2",label:"Annulus area (mm2)"},{value:"annulusPerimeterMm",label:"Annulus perimeter (mm)"},{value:"annulusMinDiameterMm",label:"Annulus min diameter (mm)"},{value:"annulusMaxDiameterMm",label:"Annulus max diameter (mm)"},{value:"annulusMeanDiameterMm",label:"Annulus mean diameter (mm)"},{value:"coronaryHeights.leftMainMm",label:"Left main height (mm)"},{value:"coronaryHeights.rightCoronaryMm",label:"Right coronary height (mm)"},{value:"lvotAreaMm2",label:"LVOT area (mm2)"},{value:"lvotPerimeterMm",label:"LVOT perimeter (mm)"},{value:"stjDiameterMm",label:"STJ diameter (mm)"},{value:"stjHeightMm",label:"STJ height (mm)"},{value:"accessVessels.rightCIAmm",label:"Right CIA (mm)"},{value:"accessVessels.leftCIAmm",label:"Left CIA (mm)"},{value:"accessVessels.rightEIAmm",label:"Right EIA (mm)"},{value:"accessVessels.leftEIAmm",label:"Left EIA (mm)"},{value:"accessVessels.rightCFAmm",label:"Right CFA (mm)"},{value:"accessVessels.leftCFAmm",label:"Left CFA (mm)"},{value:"calciumScore",label:"Aortic valve calcium score (AU)"},{value:"lvotCalciumScore",label:"LVOT calcium score (AU)"}],rF=s=>{const e=s.match(/\d+(?:\.\d+)?/g);return e?e.map(r=>parseFloat(r)).filter(r=>Number.isFinite(r)):[]},aF=(s,e,r)=>{const a=e.split(".");let n=s;for(let i=0;i<a.length-1;i+=1){const o=a[i];(!n[o]||typeof n[o]!="object")&&(n[o]={}),n=n[o]}n[a[a.length-1]]=r},nF=s=>{const e={};return s.forEach(r=>{!r.fieldKey||!Number.isFinite(r.value)||aF(e,r.fieldKey,r.value)}),e},iF=(s,e)=>{const r={...s,...e};return(s.coronaryHeights||e.coronaryHeights)&&(r.coronaryHeights={...s.coronaryHeights,...e.coronaryHeights}),(s.accessVessels||e.accessVessels)&&(r.accessVessels={...s.accessVessels,...e.accessVessels}),(s.sinusOfValsalva||e.sinusOfValsalva)&&(r.sinusOfValsalva={...s.sinusOfValsalva,...e.sinusOfValsalva}),(s.aorticDimensions||e.aorticDimensions)&&(r.aorticDimensions={...s.aorticDimensions,...e.aorticDimensions}),r},sx=s=>{let e=0;const r=a=>{typeof a=="number"&&Number.isFinite(a)&&(e+=1)};return r(s.annulusAreaMm2),r(s.annulusPerimeterMm),r(s.annulusMinDiameterMm),r(s.annulusMaxDiameterMm),r(s.annulusMeanDiameterMm),r(s.lvotAreaMm2),r(s.lvotPerimeterMm),r(s.stjDiameterMm),r(s.stjHeightMm),r(s.calciumScore),r(s.lvotCalciumScore),s.coronaryHeights&&(r(s.coronaryHeights.leftMainMm),r(s.coronaryHeights.rightCoronaryMm)),s.accessVessels&&(r(s.accessVessels.rightCIAmm),r(s.accessVessels.leftCIAmm),r(s.accessVessels.rightEIAmm),r(s.accessVessels.leftEIAmm),r(s.accessVessels.rightCFAmm),r(s.accessVessels.leftCFAmm)),s.sinusOfValsalva&&(r(s.sinusOfValsalva.leftMm),r(s.sinusOfValsalva.rightMm),r(s.sinusOfValsalva.nonCoronaryMm)),e},oF=({onClose:s,onMerge:e})=>{const[r,a]=m.useState("idle"),[n,i]=m.useState(""),[o,l]=m.useState({}),[c,A]=m.useState(""),[d,h]=m.useState(0),[f,u]=m.useState(null),[x,b]=m.useState(0),[N,v]=m.useState([]),[j,I]=m.useState(!1),C=m.useRef(null),E=m.useRef([]),T=m.useRef(null);m.useEffect(()=>()=>{T.current&&clearInterval(T.current),C.current&&C.current.state==="recording"&&C.current.stop()},[]),m.useEffect(()=>{if(!n){v([]);return}const O=rF(n);v(O.map(W=>({value:W,fieldKey:""})))},[n]);const Q=m.useMemo(()=>nF(N),[N]),D=m.useMemo(()=>iF(o,Q),[o,Q]),k=m.useMemo(()=>sx(D),[D]),R=m.useCallback(async()=>{try{u(null),E.current=[],b(0),I(!1),v([]);const O=await navigator.mediaDevices.getUserMedia({audio:!0}),W=new MediaRecorder(O,{mimeType:"audio/webm;codecs=opus"});W.ondataavailable=ee=>{ee.data.size>0&&E.current.push(ee.data)},W.onstop=async()=>{O.getTracks().forEach(V=>V.stop()),T.current&&(clearInterval(T.current),T.current=null);const ee=new Blob(E.current,{type:"audio/webm"});await L(ee)},C.current=W,W.start(1e3),T.current=setInterval(()=>{b(ee=>ee+1)},1e3),a("recording")}catch(O){console.error("[DictateCTModal] Failed to start recording:",O),u("Failed to access microphone. Please check permissions."),a("error")}},[]),w=m.useCallback(()=>{C.current&&C.current.state==="recording"&&C.current.stop()},[]),L=m.useCallback(async O=>{a("transcribing");try{const ee=await Ei.getInstance().transcribeAudio(O);if(!ee)throw new Error("Transcription returned empty result");i(ee),a("parsing");const q=await ec.getInstance().parseDictation(ee,"ct");l(q.extractedFields),h(q.confidence),I(sx(q.extractedFields)===0),q.detectedSection==="ct"&&A(ee),a("review")}catch(W){console.error("[DictateCTModal] Processing failed:",W),u(W instanceof Error?W.message:"Failed to process audio"),a("error")}},[]),M=m.useCallback(()=>{e(D,c)},[D,c,e]),P=O=>{const W=Math.floor(O/60),ee=O%60;return`${W}:${ee.toString().padStart(2,"0")}`},K=O=>{const W=[];return O.annulusAreaMm2!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["Annulus Area: ",t.jsxs("strong",{children:[O.annulusAreaMm2," mm¬≤"]})]},"area")),O.annulusPerimeterMm!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["Annulus Perimeter: ",t.jsxs("strong",{children:[O.annulusPerimeterMm," mm"]})]},"perim")),O.annulusMeanDiameterMm!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["Mean Diameter: ",t.jsxs("strong",{children:[O.annulusMeanDiameterMm," mm"]})]},"mean")),O.annulusMinDiameterMm!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["Min Diameter: ",t.jsxs("strong",{children:[O.annulusMinDiameterMm," mm"]})]},"min")),O.annulusMaxDiameterMm!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["Max Diameter: ",t.jsxs("strong",{children:[O.annulusMaxDiameterMm," mm"]})]},"max")),O.coronaryHeights?.leftMainMm!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["LM Height: ",t.jsxs("strong",{children:[O.coronaryHeights.leftMainMm," mm"]})]},"lm")),O.coronaryHeights?.rightCoronaryMm!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["RCA Height: ",t.jsxs("strong",{children:[O.coronaryHeights.rightCoronaryMm," mm"]})]},"rca")),O.accessVessels?.rightCFAmm!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["R CFA: ",t.jsxs("strong",{children:[O.accessVessels.rightCFAmm," mm"]})]},"rcfa")),O.accessVessels?.leftCFAmm!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["L CFA: ",t.jsxs("strong",{children:[O.accessVessels.leftCFAmm," mm"]})]},"lcfa")),O.accessVessels?.rightCIAmm!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["R CIA: ",t.jsxs("strong",{children:[O.accessVessels.rightCIAmm," mm"]})]},"rcia")),O.accessVessels?.leftCIAmm!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["L CIA: ",t.jsxs("strong",{children:[O.accessVessels.leftCIAmm," mm"]})]},"lcia")),O.accessVessels?.rightEIAmm!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["R EIA: ",t.jsxs("strong",{children:[O.accessVessels.rightEIAmm," mm"]})]},"reia")),O.accessVessels?.leftEIAmm!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["L EIA: ",t.jsxs("strong",{children:[O.accessVessels.leftEIAmm," mm"]})]},"leia")),O.lvotAreaMm2!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["LVOT Area: ",t.jsxs("strong",{children:[O.lvotAreaMm2," mm¬≤"]})]},"lvot")),O.lvotPerimeterMm!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["LVOT Perimeter: ",t.jsxs("strong",{children:[O.lvotPerimeterMm," mm"]})]},"lvot-perim")),O.stjDiameterMm!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["STJ Diameter: ",t.jsxs("strong",{children:[O.stjDiameterMm," mm"]})]},"stj-diam")),O.stjHeightMm!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["STJ Height: ",t.jsxs("strong",{children:[O.stjHeightMm," mm"]})]},"stj-height")),O.calciumScore!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["AV Calcium: ",t.jsxs("strong",{children:[O.calciumScore," AU"]})]},"calcium")),O.lvotCalciumScore!==void 0&&W.push(t.jsxs("div",{className:"measurement-preview",children:["LVOT Calcium: ",t.jsxs("strong",{children:[O.lvotCalciumScore," AU"]})]},"lvot-calcium")),W},$=(O,W)=>{v(ee=>ee.map((V,q)=>q===O?{...V,fieldKey:W}:V))};return t.jsx("div",{className:"fixed inset-0 bg-black/20 flex items-end justify-center z-50",children:t.jsxs("div",{className:"bg-white rounded-t-2xl shadow-2xl w-full max-w-md mx-3 mb-3 overflow-hidden flex flex-col max-h-[70vh]",children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-200 bg-purple-50",children:[t.jsx("h3",{className:"text-sm font-semibold text-ink-primary",children:"Dictate CT Measurements"}),t.jsx("button",{type:"button",onClick:s,className:"p-1 hover:bg-gray-200 rounded transition-colors",children:t.jsx(es,{className:"w-4 h-4 text-ink-tertiary"})})]}),t.jsxs("div",{className:"p-4 overflow-y-auto",children:[r==="idle"&&t.jsxs("div",{className:"text-center py-8",children:[t.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full bg-purple-100 flex items-center justify-center",children:t.jsx($r,{className:"w-8 h-8 text-purple-600"})}),t.jsxs("p",{className:"text-sm text-ink-secondary mb-4",children:["Click record and dictate your CT findings.",t.jsx("br",{}),t.jsx("span",{className:"text-xs text-ink-tertiary",children:'Example: "Annulus area 505 square millimeters, perimeter 81.2, left main height 14 millimeters..."'})]}),t.jsx(ye,{variant:"primary",onClick:R,icon:t.jsx($r,{className:"w-4 h-4"}),children:"Start Recording"})]}),r==="recording"&&t.jsxs("div",{className:"text-center py-8",children:[t.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center animate-pulse",children:t.jsx("div",{className:"w-4 h-4 bg-red-500 rounded-full"})}),t.jsx("p",{className:"text-sm text-ink-secondary mb-2",children:"Recording..."}),t.jsx("p",{className:"text-2xl font-mono text-ink-primary mb-4",children:P(x)}),t.jsx(ye,{variant:"outline",onClick:w,icon:t.jsx(dc,{className:"w-4 h-4"}),children:"Stop Recording"})]}),r==="transcribing"&&t.jsxs("div",{className:"text-center py-8",children:[t.jsx(Za,{className:"w-8 h-8 mx-auto mb-4 text-blue-500 animate-spin"}),t.jsx("p",{className:"text-sm text-ink-secondary",children:"Transcribing audio..."})]}),r==="parsing"&&t.jsxs("div",{className:"text-center py-8",children:[t.jsx(Za,{className:"w-8 h-8 mx-auto mb-4 text-purple-500 animate-spin"}),t.jsx("p",{className:"text-sm text-ink-secondary",children:"Parsing CT measurements..."})]}),r==="review"&&t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-xs font-medium text-ink-secondary block mb-1",children:"Transcription"}),t.jsx("div",{className:"bg-gray-50 rounded p-2 text-sm text-ink-primary max-h-24 overflow-y-auto",children:n})]}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsx("label",{className:"text-xs font-medium text-ink-secondary",children:"Extracted Measurements"}),t.jsxs("span",{className:`text-xs px-2 py-0.5 rounded ${d>=.8?"bg-green-100 text-green-700":d>=.5?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:[Math.round(d*100),"% confidence"]})]}),t.jsx("div",{className:"bg-purple-50 rounded p-3 space-y-1",children:K(D).length>0?K(D):t.jsx("p",{className:"text-sm text-ink-tertiary italic",children:"No measurements extracted"})})]}),t.jsxs("div",{className:"bg-gray-50 rounded p-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("label",{className:"text-xs font-medium text-ink-secondary",children:"Manual Mapping"}),k>0&&t.jsx("button",{type:"button",className:"text-xs text-purple-600 hover:text-purple-700",onClick:()=>I(O=>!O),children:j?"Hide":"Map Numbers"})]}),(j||k===0)&&t.jsxs("div",{className:"mt-2 space-y-2",children:[N.length>0?N.map((O,W)=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"w-16 text-xs font-mono text-ink-primary",children:O.value}),t.jsxs("select",{value:O.fieldKey,onChange:ee=>$(W,ee.target.value),className:"w-full rounded-md border border-gray-200 bg-white px-2 py-1 text-xs text-ink-primary focus:outline-none focus:ring-2 focus:ring-purple-400/40",children:[t.jsx("option",{value:"",children:"Unassigned"}),sF.map(ee=>t.jsx("option",{value:ee.value,children:ee.label},ee.value))]})]},`${O.value}-${W}`)):t.jsx("p",{className:"text-xs text-ink-tertiary",children:"No numeric values detected in the transcription."}),t.jsx("p",{className:"text-[11px] text-ink-tertiary",children:"Mapped values are merged with extracted measurements."})]})]}),t.jsxs("div",{className:"flex items-center justify-end gap-2 pt-2",children:[t.jsx(ye,{variant:"ghost",size:"sm",onClick:()=>{a("idle"),i(""),l({}),v([]),I(!1)},children:"Try Again"}),t.jsx(ye,{variant:"primary",size:"sm",onClick:M,icon:t.jsx(Ms,{className:"w-3 h-3"}),disabled:k===0,children:"Apply Measurements"})]})]}),r==="error"&&t.jsxs("div",{className:"text-center py-8",children:[t.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center",children:t.jsx(or,{className:"w-8 h-8 text-red-500"})}),t.jsx("p",{className:"text-sm text-red-600 mb-4",children:f}),t.jsx(ye,{variant:"outline",onClick:()=>a("idle"),children:"Try Again"})]})]})]})})},la=({label:s,value:e,unit:r,onChange:a,isEditing:n})=>t.jsxs("div",{className:"flex items-center justify-between py-1",children:[t.jsx("span",{className:"text-xs text-ink-secondary",children:s}),n?t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("input",{type:"number",step:"0.1",value:e??"",onChange:i=>a(i.target.value?parseFloat(i.target.value):void 0),className:"w-16 px-2 py-0.5 text-xs text-right border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 focus:border-transparent",placeholder:"-"}),t.jsx("span",{className:"text-xs text-ink-tertiary w-8",children:r})]}):t.jsx("span",{className:`text-xs font-medium ${e!==void 0?"text-ink-primary":"text-ink-tertiary"}`,children:e!==void 0?`${e} ${r}`:"-"})]}),lF=({measurements:s,onUpdate:e})=>{const[r,a]=m.useState(!0),[n,i]=m.useState(!1),[o,l]=m.useState(!1),[c,A]=m.useState(s||Dd()),d=m.useCallback(()=>{A(s||Dd()),i(!0)},[s]),h=m.useCallback((v,j)=>{const I={...s,...v,coronaryHeights:{...s?.coronaryHeights,...v.coronaryHeights},accessVessels:{...s?.accessVessels,...v.accessVessels},sinusOfValsalva:{...s?.sinusOfValsalva,...v.sinusOfValsalva},coplanarAngles:v.coplanarAngles||s?.coplanarAngles||[],narrative:j?s?.narrative?`${s.narrative}

${j}`:j:s?.narrative},C={...I,annulusArea:I.annulusAreaMm2,annulusPerimeter:I.annulusPerimeterMm};e(C),l(!1)},[s,e]),f=m.useCallback(()=>{const v={...c,annulusArea:c.annulusAreaMm2,annulusPerimeter:c.annulusPerimeterMm};e(v),i(!1)},[c,e]),u=m.useCallback(()=>{A(s||Dd()),i(!1)},[s]),x=m.useCallback((v,j)=>{A(I=>{const C={...I},E=v.split(".");return E.length===1?C[E[0]]=j:E.length===2&&(C[E[0]]={...C[E[0]],[E[1]]:j}),C})},[]),b=n?c:s||Dd(),N=s&&(s.annulusAreaMm2!==void 0||s.annulusPerimeterMm!==void 0||s.coronaryHeights?.leftMainMm!==void 0||s.coronaryHeights?.rightCoronaryMm!==void 0);return t.jsxs("div",{className:"bg-white rounded-lg border border-line-primary overflow-hidden",children:[t.jsxs("button",{type:"button",onClick:()=>a(!r),className:`w-full flex items-center justify-between p-3 hover:bg-gray-50 transition-colors ${N?"bg-purple-50 border-l-4 border-l-purple-500":"bg-gray-50 border-l-4 border-l-gray-300"}`,children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(qi,{className:"w-4 h-4 text-purple-600"}),t.jsxs("div",{className:"text-left",children:[t.jsx("h3",{className:"text-sm font-semibold text-ink-primary",children:"CT Measurements"}),t.jsx("p",{className:"text-xs text-ink-tertiary",children:N?"Valve sizing data available":"No measurements entered"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[!n&&t.jsxs(t.Fragment,{children:[t.jsx(ye,{variant:"ghost",size:"sm",onClick:v=>{v.stopPropagation(),l(!0)},icon:t.jsx($r,{className:"w-3 h-3"}),children:"Dictate"}),t.jsx(ye,{variant:"ghost",size:"sm",onClick:v=>{v.stopPropagation(),d()},icon:t.jsx(Vu,{className:"w-3 h-3"}),children:"Edit"})]}),r?t.jsx(Vr,{className:"w-4 h-4 text-ink-tertiary"}):t.jsx(ps,{className:"w-4 h-4 text-ink-tertiary"})]})]}),r&&t.jsxs("div",{className:"p-3 border-t border-line-primary space-y-4",children:[(b.narrative||n)&&t.jsxs("div",{children:[t.jsx("h4",{className:"text-xs font-semibold text-ink-primary mb-2",children:"Summary"}),n?t.jsx("textarea",{value:b.narrative||"",onChange:v=>x("narrative",v.target.value),className:"w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 focus:border-transparent min-h-[60px]",placeholder:"Descriptive summary of CT findings..."}):t.jsx("p",{className:"text-xs text-ink-primary whitespace-pre-wrap",children:b.narrative})]}),t.jsxs("div",{children:[t.jsx("h4",{className:"text-xs font-semibold text-ink-primary mb-2",children:"Annulus"}),t.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1",children:[t.jsx(la,{label:"Area",value:b.annulusAreaMm2,unit:"mm¬≤",onChange:v=>x("annulusAreaMm2",v),isEditing:n}),t.jsx(la,{label:"Perimeter",value:b.annulusPerimeterMm,unit:"mm",onChange:v=>x("annulusPerimeterMm",v),isEditing:n}),t.jsx(la,{label:"Min Diameter",value:b.annulusMinDiameterMm,unit:"mm",onChange:v=>x("annulusMinDiameterMm",v),isEditing:n}),t.jsx(la,{label:"Max Diameter",value:b.annulusMaxDiameterMm,unit:"mm",onChange:v=>x("annulusMaxDiameterMm",v),isEditing:n})]})]}),t.jsxs("div",{children:[t.jsx("h4",{className:"text-xs font-semibold text-ink-primary mb-2",children:"Coronary Heights"}),t.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1",children:[t.jsx(la,{label:"Left Main",value:b.coronaryHeights?.leftMainMm,unit:"mm",onChange:v=>x("coronaryHeights.leftMainMm",v),isEditing:n}),t.jsx(la,{label:"Right Coronary",value:b.coronaryHeights?.rightCoronaryMm,unit:"mm",onChange:v=>x("coronaryHeights.rightCoronaryMm",v),isEditing:n})]})]}),t.jsxs("div",{children:[t.jsx("h4",{className:"text-xs font-semibold text-ink-primary mb-2",children:"LVOT & STJ"}),t.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1",children:[t.jsx(la,{label:"LVOT Area",value:b.lvotAreaMm2,unit:"mm¬≤",onChange:v=>x("lvotAreaMm2",v),isEditing:n}),t.jsx(la,{label:"LVOT Perimeter",value:b.lvotPerimeterMm,unit:"mm",onChange:v=>x("lvotPerimeterMm",v),isEditing:n}),t.jsx(la,{label:"STJ Diameter",value:b.stjDiameterMm,unit:"mm",onChange:v=>x("stjDiameterMm",v),isEditing:n}),t.jsx(la,{label:"STJ Height",value:b.stjHeightMm,unit:"mm",onChange:v=>x("stjHeightMm",v),isEditing:n})]})]}),t.jsxs("div",{children:[t.jsx("h4",{className:"text-xs font-semibold text-ink-primary mb-2",children:"Access Vessels"}),t.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1",children:[t.jsx(la,{label:"R. Common Iliac",value:b.accessVessels?.rightCIAmm,unit:"mm",onChange:v=>x("accessVessels.rightCIAmm",v),isEditing:n}),t.jsx(la,{label:"L. Common Iliac",value:b.accessVessels?.leftCIAmm,unit:"mm",onChange:v=>x("accessVessels.leftCIAmm",v),isEditing:n}),t.jsx(la,{label:"R. External Iliac",value:b.accessVessels?.rightEIAmm,unit:"mm",onChange:v=>x("accessVessels.rightEIAmm",v),isEditing:n}),t.jsx(la,{label:"L. External Iliac",value:b.accessVessels?.leftEIAmm,unit:"mm",onChange:v=>x("accessVessels.leftEIAmm",v),isEditing:n}),t.jsx(la,{label:"R. Common Femoral",value:b.accessVessels?.rightCFAmm,unit:"mm",onChange:v=>x("accessVessels.rightCFAmm",v),isEditing:n}),t.jsx(la,{label:"L. Common Femoral",value:b.accessVessels?.leftCFAmm,unit:"mm",onChange:v=>x("accessVessels.leftCFAmm",v),isEditing:n})]})]}),t.jsxs("div",{children:[t.jsx("h4",{className:"text-xs font-semibold text-ink-primary mb-2",children:"Calcium Scores"}),t.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1",children:[t.jsx(la,{label:"AV Calcium",value:b.calciumScore,unit:"AU",onChange:v=>x("calciumScore",v),isEditing:n}),t.jsxs("div",{className:"flex items-center justify-between py-1",children:[t.jsx("span",{className:"text-xs text-ink-secondary",children:"LVOT Calcium"}),n?t.jsxs("select",{value:b.lvotCalcium||"",onChange:v=>x("lvotCalcium",v.target.value||void 0),className:"px-2 py-0.5 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 focus:border-transparent","aria-label":"LVOT Calcium Severity",children:[t.jsx("option",{value:"",children:"Not specified"}),t.jsx("option",{value:"trivial",children:"Trivial"}),t.jsx("option",{value:"mild",children:"Mild"}),t.jsx("option",{value:"moderate",children:"Moderate"}),t.jsx("option",{value:"severe",children:"Severe"})]}):t.jsx("span",{className:`text-xs font-medium ${b.lvotCalcium?"text-ink-primary capitalize":"text-ink-tertiary"}`,children:b.lvotCalcium||"-"})]})]})]}),n&&t.jsxs("div",{className:"flex items-center justify-end gap-2 pt-2 border-t border-line-primary",children:[t.jsx(ye,{variant:"ghost",size:"sm",onClick:u,icon:t.jsx(es,{className:"w-3 h-3"}),children:"Cancel"}),t.jsx(ye,{variant:"primary",size:"sm",onClick:f,icon:t.jsx(Ms,{className:"w-3 h-3"}),children:"Save"})]})]}),o&&t.jsx(oF,{onClose:()=>l(!1),onMerge:h})]})};function Dd(){return{coronaryHeights:{},sinusOfValsalva:{},coplanarAngles:[],accessVessels:{}}}const cF=({measurements:s})=>{const[e,r]=bs.useState(!0),a=Al.getInstance(),{bestPerBrand:n,hasData:i,overallBest:o}=m.useMemo(()=>{const d=s?.annulusArea,h=s?.annulusPerimeter;if(!d||!h)return{bestPerBrand:null,hasData:!1,overallBest:null};if(!a.validateMeasurements(d,h).valid)return{bestPerBrand:null,hasData:!1,overallBest:null};const u=a.getBestValvePerBrand(d,h);let x=null;for(const b of a.getBrandOrder()){const N=u[b];N?.isOptimal&&(!x||N.oversizing<x.oversizing)&&(x=N)}if(!x){for(const b of a.getBrandOrder())if(u[b]){x=u[b];break}}return{bestPerBrand:u,hasData:!0,overallBest:x}},[s,a]),l=d=>d.isOptimal?"text-emerald-700":"text-ink-secondary",c=d=>d.isOptimal?"bg-emerald-50 border-emerald-200":"bg-gray-50 border-gray-200",A=d=>d.isOptimal?"text-emerald-800":"text-ink-primary";return t.jsxs("div",{className:"bg-white rounded-lg border border-line-primary overflow-hidden",children:[t.jsxs("button",{type:"button",onClick:()=>r(!e),className:`w-full flex items-center justify-between p-3 hover:bg-gray-50 transition-colors ${o?.isOptimal?"bg-emerald-50 border-l-4 border-l-emerald-500":"bg-gray-50 border-l-4 border-l-gray-300"}`,children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(T2,{className:"w-4 h-4 text-purple-600"}),t.jsxs("div",{className:"text-left",children:[t.jsx("h3",{className:"text-sm font-semibold text-ink-primary",children:"AI Recommendation"}),t.jsx("p",{className:"text-xs text-ink-tertiary",children:o?`${a.getManufacturer(o.brand).displayName} ${o.size}mm (${o.oversizing.toFixed(1)}%)`:i?"Calculating...":"Enter annulus area & perimeter"})]})]}),e?t.jsx(Vr,{className:"w-4 h-4 text-ink-tertiary"}):t.jsx(ps,{className:"w-4 h-4 text-ink-tertiary"})]}),e&&t.jsxs("div",{className:"p-3 border-t border-line-primary space-y-3",children:[!i&&t.jsxs("div",{className:"flex items-start gap-2 p-3 bg-gray-50 rounded border border-gray-200",children:[t.jsx(Ma,{className:"w-4 h-4 text-gray-600 mt-0.5 flex-shrink-0"}),t.jsxs("div",{className:"text-xs text-gray-700",children:[t.jsx("p",{className:"font-medium mb-1",children:"Missing Measurements"}),t.jsx("p",{children:"Enter annulus area (mm¬≤) and perimeter (mm) to calculate valve recommendations."})]})]}),n&&t.jsxs("div",{className:"space-y-2",children:[t.jsx("h4",{className:"text-xs font-semibold text-ink-primary",children:"Best by Manufacturer"}),t.jsx("div",{className:"grid grid-cols-2 gap-2",children:a.getBrandOrder().map(d=>{const h=n[d];if(!h)return null;const f=a.getManufacturer(d);return t.jsxs("div",{className:`p-2 rounded border ${c(h)}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsx("span",{className:`text-xs font-semibold ${A(h)}`,children:f.displayName}),h.isOptimal&&t.jsx("span",{className:"flex items-center gap-0.5 text-xs text-emerald-600",children:t.jsx(Ms,{className:"w-3 h-3"})})]}),t.jsx("p",{className:`text-sm font-bold ${A(h)}`,children:h.sizeName}),t.jsxs("p",{className:`text-xs font-medium ${l(h)}`,children:[h.oversizing.toFixed(1),"% oversizing"]})]},d)})})]}),i&&s&&t.jsx("div",{className:"pt-2 border-t border-line-primary",children:t.jsxs("p",{className:"text-xs text-ink-tertiary",children:["Based on annulus area (",s.annulusArea.toFixed(0),"mm¬≤) and perimeter (",s.annulusPerimeter.toFixed(1),"mm). Optimal ranges: Evolut/Navitor 15-25%, Sapien 0-10%, MyVal 5-15%."]})})]})]})},yw=({brand:s,oversizing:e,isOptimal:r,showLabel:a=!0,height:n=20,className:i=""})=>{const o=Al.getInstance(),l=vC[s],c=o.getOptimalRange(s),A=l.max-l.min,d=(c.min-l.min)/A*100,h=(c.max-c.min)/A*100,f=e>=l.min&&e<=l.max,u=f?(e-l.min)/A*100:e<l.min?0:100,x=e<l.min,b=e>l.max;return t.jsxs("div",{className:`relative ${i}`,style:{height:a?n+24:n},children:[t.jsxs("div",{className:"relative w-full rounded overflow-hidden",style:{height:n},children:[t.jsx("div",{className:"absolute inset-0 bg-gray-100 rounded"}),t.jsx("div",{className:"absolute top-0 bottom-0 bg-blue-100 opacity-70",style:{left:`${d}%`,width:`${h}%`}}),f&&t.jsx("div",{className:"absolute top-0 w-0.5 bg-blue-400 transition-all duration-300",style:{left:`${u}%`,height:n+4,marginTop:-2,transform:"translateX(-50%)"}})]}),a&&t.jsxs("div",{className:"absolute transition-all duration-300 flex flex-col items-center",style:{top:n+4,left:x?0:b?void 0:`${u}%`,right:b?0:void 0,transform:f?"translateX(-50%)":void 0},children:[t.jsxs("span",{className:`text-xs px-1.5 py-0.5 rounded font-medium ${r?"bg-emerald-50 text-emerald-600":x||b?"bg-rose-50 text-rose-600":"bg-gray-100 text-gray-600"}`,children:[e.toFixed(1),"%"]}),(x||b)&&t.jsx("div",{className:"w-2 h-2 rounded-full bg-rose-400 mt-1"})]})]})},AF=s=>t.jsx(yw,{...s,showLabel:!1,height:12}),dF=({result:s,isSelected:e=!1,onSelect:r,onVolumeChange:a,compact:n=!1,showRange:i=!0,selectable:o=!0})=>{const l=s.brand==="sapien"&&a,c=s.brand==="sapien"&&s.volumeAdjustment&&s.volumeAdjustment!==0?`${s.volumeAdjustment>0?"+":""}${s.volumeAdjustment.toFixed(1).replace(/\.0$/,"")}mL`:null,A=f=>{f.stopPropagation(),a&&s.volumeAdjustment!==null&&a(s.volumeAdjustment-.5)},d=f=>{f.stopPropagation(),a&&s.volumeAdjustment!==null&&a(s.volumeAdjustment+.5)},h=()=>s.range?s.brand==="navitor"?t.jsxs(t.Fragment,{children:[s.range.perimeter&&t.jsxs(t.Fragment,{children:["P ",s.range.perimeter.min,"‚Äì",s.range.perimeter.max," mm"]}),s.range.perimeter&&s.range.area&&t.jsx("br",{}),s.range.area&&t.jsxs(t.Fragment,{children:["A ",s.range.area.min,"‚Äì",s.range.area.max," mm¬≤"]})]}):s.range.perimeter?`P ${s.range.perimeter.min}-${s.range.perimeter.max} mm`:null:null;return n?t.jsxs("button",{type:"button",onClick:o?r:void 0,className:`w-full flex items-center gap-2 px-2 py-1.5 rounded border transition-all ${e?"border-purple-500 bg-purple-50":s.isOptimal?"border-blue-400 bg-blue-50":o?"border-gray-200 hover:border-gray-300 hover:bg-gray-50":"border-gray-200 bg-white"} ${o?"cursor-pointer":"cursor-default"}`,children:[o&&t.jsx("div",{className:`w-4 h-4 rounded-full border-2 flex-shrink-0 flex items-center justify-center ${e?"border-purple-500 bg-purple-500":"border-gray-300"}`,children:e&&t.jsx(Ms,{className:"w-2.5 h-2.5 text-white"})}),t.jsxs("div",{className:"flex flex-col w-12 leading-tight",children:[t.jsx("span",{className:"text-xs font-medium text-ink-primary",children:s.sizeName}),c&&t.jsx("span",{className:"text-[10px] text-emerald-600",children:c})]}),l&&t.jsxs("div",{className:"flex items-center gap-1 text-ink-secondary",onClick:f=>f.stopPropagation(),children:[t.jsx("button",{type:"button",onClick:A,className:"p-0.5 text-ink-tertiary hover:text-ink-primary transition-colors",title:"Decrease balloon volume",children:t.jsx(Qg,{className:"w-3 h-3"})}),t.jsx("span",{className:"text-[11px] min-w-[24px] text-center font-medium",children:s.nominalVolume!==null&&(s.nominalVolume+(s.volumeAdjustment??0)).toFixed(1)}),t.jsx("button",{type:"button",onClick:d,className:"p-0.5 text-ink-tertiary hover:text-ink-primary transition-colors",title:"Increase balloon volume",children:t.jsx(Fr,{className:"w-3 h-3"})})]}),t.jsx("div",{className:"flex-1",children:t.jsx(AF,{brand:s.brand,oversizing:s.oversizing,isOptimal:s.isOptimal})}),t.jsxs("span",{className:`text-xs font-medium w-12 text-right ${s.isOptimal?"text-emerald-600":"text-ink-secondary"}`,children:[s.oversizing.toFixed(1),"%"]}),s.isOptimal&&t.jsx("span",{className:"text-xs px-1.5 py-0.5 bg-emerald-100 text-emerald-700 rounded font-medium",children:"Optimal"})]}):t.jsxs("div",{onClick:o?r:void 0,className:`p-3 rounded-lg border transition-all ${e?"border-purple-500 bg-purple-50 ring-1 ring-purple-200":s.isOptimal?"border-blue-400 bg-blue-50 shadow-sm":o?"border-gray-200 hover:border-gray-300 hover:bg-gray-50 cursor-pointer":"border-gray-200 bg-white"}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[o&&t.jsx("div",{className:`w-5 h-5 rounded-full border-2 flex-shrink-0 flex items-center justify-center ${e?"border-purple-500 bg-purple-500":"border-gray-300"}`,children:e&&t.jsx(Ms,{className:"w-3 h-3 text-white"})}),t.jsxs("div",{className:"flex flex-col leading-tight",children:[t.jsx("span",{className:"text-sm font-semibold text-ink-primary",children:s.sizeName}),c&&t.jsx("span",{className:"text-[11px] text-emerald-600",children:c})]}),s.isOptimal&&t.jsx("span",{className:"text-xs px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded-full font-medium",children:"Optimal"})]}),l&&t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("button",{type:"button",onClick:A,className:"p-1 rounded hover:bg-gray-200 transition-colors",title:"Decrease balloon volume",children:t.jsx(Qg,{className:"w-3.5 h-3.5 text-ink-secondary"})}),t.jsx("span",{className:"text-xs text-ink-secondary min-w-[32px] text-center font-medium",children:s.nominalVolume!==null&&s.nominalVolume+(s.volumeAdjustment??0)}),t.jsx("button",{type:"button",onClick:d,className:"p-1 rounded hover:bg-gray-200 transition-colors",title:"Increase balloon volume",children:t.jsx(Fr,{className:"w-3.5 h-3.5 text-ink-secondary"})}),s.volumeAdjustment!==null&&s.volumeAdjustment!==0&&t.jsxs("span",{className:"text-xs text-ink-tertiary",children:["(",s.volumeAdjustment>0?"+":"",s.volumeAdjustment.toFixed(1),"mL)"]})]})]}),i&&s.range&&t.jsx("div",{className:"text-xs text-ink-tertiary mb-2",children:h()}),t.jsx(yw,{brand:s.brand,oversizing:s.oversizing,isOptimal:s.isOptimal,height:16})]})},uF=s=>t.jsx(dF,{...s,compact:!0,showRange:!1}),mF=({brand:s,displayName:e,results:r,isExpanded:a,onToggle:n,selectedValve:i,onSelectValve:o,onVolumeChange:l,hasOptimal:c,area:A,perimeter:d})=>{const h=i?.brand===s;return h&&i.size,t.jsxs("div",{className:"border-b border-gray-100 last:border-b-0",children:[t.jsx("button",{type:"button",onClick:n,className:`w-full flex items-center justify-between px-3 py-2 hover:bg-gray-50 transition-colors ${h?"bg-purple-50":""}`,children:t.jsxs("div",{className:"flex items-center gap-2",children:[a?t.jsx(Vr,{className:"w-4 h-4 text-ink-tertiary"}):t.jsx(ps,{className:"w-4 h-4 text-ink-tertiary"}),t.jsx("span",{className:"text-sm font-medium text-ink-primary",children:e}),c&&!h&&t.jsx("span",{className:"text-xs px-1.5 py-0.5 bg-emerald-100 text-emerald-700 rounded font-medium",children:"Optimal available"}),h&&t.jsx("span",{className:"text-xs px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded font-medium",children:"Selected"})]})}),a&&t.jsx("div",{className:"px-2 pb-2 space-y-1",children:r.map(f=>t.jsx(uF,{result:f,isSelected:i?.brand===f.brand&&i?.size===f.size,onSelect:()=>o(f),onVolumeChange:f.brand==="sapien"?u=>l(f,u):void 0,selectable:!0},`${f.brand}-${f.size}`))})]})},hF=({area:s,perimeter:e,selectedValve:r,onSelectValve:a,expanded:n=!0})=>{const[i,o]=m.useState(n),[l,c]=m.useState(new Set(["evolut"])),[A,d]=m.useState({}),h=m.useRef(null),f=Al.getInstance(),{grouped:u,hasMeasurements:x,bestPerBrand:b}=m.useMemo(()=>{if(!s||!e)return{grouped:null,hasMeasurements:!1,bestPerBrand:null};if(!f.validateMeasurements(s,e).valid)return{grouped:null,hasMeasurements:!1,bestPerBrand:null};const T=f.getResultsByBrand(s,e);return T.sapien&&(T.sapien=T.sapien.map(Q=>{const D=A[Q.size]??0;return D!==0?f.adjustSapienVolume(Q,s,e,D):Q})),{grouped:T,hasMeasurements:!0,bestPerBrand:f.getBestValvePerBrand(s,e)}},[s,e,A,f]);m.useEffect(()=>{if(!b)return;const E=`${s??"na"}-${e??"na"}`;if(h.current===E)return;const T=[];for(const[Q,D]of Object.entries(b))D?.isOptimal&&T.push(Q);T.length>0&&(c(new Set([T[0]])),h.current=E)},[b,s,e]);const N=m.useCallback(E=>{c(T=>{const Q=new Set(T);return Q.has(E)?Q.delete(E):Q.add(E),Q})},[]),v=m.useCallback(E=>{const T={brand:E.brand,size:E.size,volumeAdjustment:E.volumeAdjustment??void 0,selectedAt:Date.now(),selectedBy:"user"};a(T)},[a]),j=m.useCallback((E,T)=>{E.brand==="sapien"&&(d(Q=>({...Q,[E.size]:T})),r?.brand==="sapien"&&r?.size===E.size&&a({...r,volumeAdjustment:T,selectedAt:Date.now()}))},[r,a]),I=m.useCallback(()=>{a(void 0)},[a]),C=f.getBrandOrder();return t.jsxs("div",{className:"bg-white rounded-lg border border-line-primary overflow-hidden",children:[t.jsxs("button",{type:"button",onClick:()=>o(!i),className:`w-full flex items-center justify-between p-3 hover:bg-gray-50 transition-colors ${r?"bg-purple-50 border-l-4 border-l-purple-500":x?"bg-blue-50 border-l-4 border-l-blue-500":"bg-gray-50 border-l-4 border-l-gray-300"}`,children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(F2,{className:"w-4 h-4 text-purple-600"}),t.jsxs("div",{className:"text-left",children:[t.jsx("h3",{className:"text-sm font-semibold text-ink-primary",children:"Valve Selection"}),t.jsx("p",{className:"text-xs text-ink-tertiary",children:r?`${f.getManufacturer(r.brand).displayName} ${r.size}mm`:x?"Select a valve based on CT measurements":"Enter annulus area & perimeter"})]})]}),i?t.jsx(Vr,{className:"w-4 h-4 text-ink-tertiary"}):t.jsx(ps,{className:"w-4 h-4 text-ink-tertiary"})]}),i&&t.jsxs("div",{className:"border-t border-line-primary",children:[x&&t.jsx("div",{className:"px-3 py-2 bg-gray-50 border-b border-gray-100",children:t.jsxs("p",{className:"text-xs text-ink-secondary",children:["Area: ",t.jsxs("span",{className:"font-medium",children:[s?.toFixed(0),"mm¬≤"]})," | ","Perimeter: ",t.jsxs("span",{className:"font-medium",children:[e?.toFixed(1),"mm"]})]})}),!x&&t.jsx("div",{className:"p-4 text-center",children:t.jsx("p",{className:"text-sm text-ink-secondary",children:"Enter annulus area and perimeter in CT Measurements to see valve sizing options."})}),u&&t.jsx("div",{children:C.map(E=>{const T=u[E],Q=T.some(D=>D.isOptimal);return t.jsx(mF,{brand:E,displayName:f.getManufacturer(E).displayName,results:T,isExpanded:l.has(E),onToggle:()=>N(E),selectedValve:r,onSelectValve:v,onVolumeChange:j,hasOptimal:Q,area:s,perimeter:e},E)})}),r&&t.jsxs("div",{className:"px-3 py-2 bg-purple-50 border-t border-purple-100 flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsxs("p",{className:"text-xs font-medium text-purple-700",children:["Selected: ",f.getManufacturer(r.brand).displayName," ",r.size,"mm",r.volumeAdjustment!==void 0&&r.volumeAdjustment!==0&&t.jsxs("span",{className:"ml-1",children:["(",r.volumeAdjustment>0?"+":"",r.volumeAdjustment.toFixed(1),"mL)"]})]}),t.jsx("p",{className:"text-xs text-purple-600",children:"User selected"})]}),t.jsx("button",{type:"button",onClick:I,className:"p-1 hover:bg-purple-100 rounded transition-colors",title:"Clear selection",children:t.jsx(es,{className:"w-4 h-4 text-purple-600"})})]})]})]})},pF=({snapshots:s=[],onSnapshotCapture:e,onSnapshotsChange:r})=>{const[a,n]=m.useState(!1),i=o=>{r&&r(s.filter(l=>l.id!==o))};return t.jsxs("div",{className:"bg-white rounded-lg border border-line-primary overflow-hidden",children:[t.jsxs("button",{type:"button",onClick:()=>n(!a),className:`w-full flex items-center justify-between p-3 hover:bg-gray-50 transition-colors ${s.length>0?"bg-blue-50 border-l-4 border-l-blue-500":"bg-gray-50 border-l-4 border-l-gray-300"}`,children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(wp,{className:"w-4 h-4 text-blue-600"}),t.jsxs("div",{className:"text-left",children:[t.jsx("h3",{className:"text-sm font-semibold text-ink-primary",children:"CT Images"}),t.jsx("p",{className:"text-xs text-ink-tertiary",children:s.length>0?`${s.length} snapshot${s.length!==1?"s":""} captured`:"No images loaded"})]})]}),a?t.jsx(Vr,{className:"w-4 h-4 text-ink-tertiary"}):t.jsx(ps,{className:"w-4 h-4 text-ink-tertiary"})]}),a&&t.jsxs("div",{className:"p-3 border-t border-line-primary space-y-3",children:[t.jsxs("div",{className:"flex flex-col items-center justify-center p-6 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300",children:[t.jsx(or,{className:"w-8 h-8 text-gray-400 mb-2"}),t.jsx("p",{className:"text-sm font-medium text-gray-600 text-center",children:"DICOM Viewer Coming Soon"}),t.jsx("p",{className:"text-xs text-gray-500 text-center mt-1 max-w-xs",children:"CornerstoneJS integration planned for Phase 8.2. For now, use external DICOM viewer and capture screenshots."}),t.jsxs("div",{className:"flex gap-2 mt-4",children:[t.jsx(ye,{variant:"outline",size:"sm",icon:t.jsx(BA,{className:"w-3 h-3"}),disabled:!0,children:"Load DICOM"}),t.jsx(ye,{variant:"outline",size:"sm",icon:t.jsx(Ou,{className:"w-3 h-3"}),disabled:!0,children:"Capture"})]})]}),s.length>0&&t.jsxs("div",{className:"space-y-2",children:[t.jsx("h4",{className:"text-xs font-semibold text-ink-primary",children:"Captured Snapshots"}),t.jsx("div",{className:"grid grid-cols-3 gap-2",children:s.map(o=>t.jsxs("div",{className:"relative group rounded-lg overflow-hidden border border-gray-200",children:[t.jsx("img",{src:o.thumbnailData||o.imageData,alt:o.label||"CT Snapshot",className:"w-full h-20 object-cover"}),t.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-opacity flex items-center justify-center",children:t.jsx("button",{type:"button",onClick:()=>i(o.id),className:"opacity-0 group-hover:opacity-100 transition-opacity text-white text-xs bg-red-500 px-2 py-1 rounded",children:"Remove"})}),o.label&&t.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 px-1 py-0.5",children:t.jsx("p",{className:"text-xs text-white truncate",children:o.label})})]},o.id))})]}),t.jsxs("div",{className:"text-xs text-ink-tertiary bg-amber-50 border border-amber-200 rounded p-2",children:[t.jsx("p",{className:"font-medium text-amber-800 mb-1",children:"Workaround:"}),t.jsxs("ol",{className:"list-decimal list-inside space-y-0.5 text-amber-700",children:[t.jsx("li",{children:"Open CT in external viewer (Horos, OsiriX, 3D Slicer)"}),t.jsx("li",{children:"Navigate to desired plane (annulus, coronaries, access)"}),t.jsx("li",{children:"Take screenshot and paste/upload here (coming soon)"})]})]})]})]})};class el{static instance=null;constructor(){}static getInstance(){return el.instance||(el.instance=new el),el.instance}generateBentoBoxHTML(e){const r=this.prepareSections(e.structuredSections),a=this.getBentoBoxCSS(),n=this.renderCTMeasurementsCard(e.ctMeasurements),i=this.renderValveRecommendationCard(e.ctMeasurements),o=this.renderValveSizingSection(e.ctMeasurements,e.selectedValve),l=this.renderSnapshotsGallery(e.snapshots);return`<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TAVI Workup - ${e.patient}</title>
  <style>${a}</style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>${e.patient} - TAVI Workup</h1>
      <div class="meta">
        <span>Procedure Date: ${e.procedureDate||"Not set"}</span>
        <span>Location: ${e.location||"Not specified"}</span>
        <span>Completion: ${e.completionPercentage}%</span>
      </div>
    </header>

    <div class="bento-grid">
      ${n}
      ${i}
      ${r.map(c=>this.renderSectionCard(c)).join(`
`)}
    </div>

    ${o}
    ${l}

    <footer class="footer">
      <p>Generated with Operator Extension - ${new Date().toLocaleDateString()}</p>
    </footer>
  </div>
</body>
</html>`}prepareSections(e){return[{key:"patient",title:"Patient",content:e.patient.content,size:"large",color:"blue",isAlert:!1},{key:"clinical",title:"Clinical",content:e.clinical.content,size:"large",color:"green",isAlert:!1},{key:"echocardiography",title:"Echo",content:e.echocardiography.content,size:"medium",color:"red",isAlert:!1},{key:"background",title:"Background",content:e.background.content,size:"medium",color:"gray",isAlert:!1},{key:"medications",title:"Medications",content:e.medications.content,size:"small",color:"orange",isAlert:!1},{key:"laboratory",title:"Labs",content:e.laboratory.content,size:"small",color:"purple",isAlert:!1},{key:"ecg",title:"ECG",content:e.ecg.content,size:"small",color:"red",isAlert:!1},{key:"investigations",title:"Investigations",content:e.investigations.content,size:"medium",color:"indigo",isAlert:!1},{key:"procedure_planning",title:"Procedure Plan",content:e.procedure_planning.content,size:"medium",color:"violet",isAlert:!1},{key:"social_history",title:"Social",content:e.social_history.content,size:"small",color:"cyan",isAlert:!1},{key:"alerts",title:"Alerts",content:e.alerts.content,size:"large",color:"red",isAlert:!0}]}renderSectionCard(e){const r=e.content&&e.content!=="Not provided";return`<div class="card card-${e.size} ${e.isAlert?"card-alert":""}" data-section="${e.key}">
  <div class="card-header color-${e.color}">
    <h3>${e.title}</h3>
  </div>
  <div class="card-content">
    ${r?`<p>${this.escapeHTML(e.content)}</p>`:'<p class="empty">Not provided</p>'}
  </div>
</div>`}getBentoBoxCSS(){return`
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: #f5f5f7;
  padding: 20px;
  line-height: 1.6;
}

.container { max-width: 1400px; margin: 0 auto; }

.header {
  background: white;
  padding: 24px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.header h1 { font-size: 28px; font-weight: 600; margin-bottom: 8px; }
.meta { display: flex; gap: 20px; font-size: 14px; color: #666; }

.bento-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 16px;
}

.card {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.15); }

.card-small { grid-column: span 1; }
.card-medium { grid-column: span 2; }
.card-large { grid-column: span 3; }

.card-alert { border: 3px solid #ef4444; }

.card-header {
  padding: 12px 16px;
  color: white;
  font-weight: 600;
}

.color-blue { background: #3b82f6; }
.color-green { background: #10b981; }
.color-purple { background: #8b5cf6; }
.color-red { background: #ef4444; }
.color-gray { background: #6b7280; }
.color-orange { background: #f59e0b; }
.color-indigo { background: #6366f1; }
.color-violet { background: #7c3aed; }
.color-cyan { background: #06b6d4; }
.color-teal { background: #14b8a6; }

.card-content {
  padding: 16px;
  font-size: 14px;
  color: #374151;
  white-space: pre-wrap;
}

.empty { color: #9ca3af; font-style: italic; }

/* CT Measurements Styles */
.ct-measurements .measurement-group {
  margin-bottom: 16px;
}
.ct-measurements .measurement-group:last-child { margin-bottom: 0; }
.ct-measurements h4 {
  font-size: 12px;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 8px;
}
.measurement-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
}
.measurement {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  border-bottom: 1px dotted #e5e7eb;
}
.measurement .label { color: #6b7280; font-size: 13px; }
.measurement .value { font-weight: 500; color: #111827; }
.narrative {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e5e7eb;
  font-style: italic;
  color: #4b5563;
}

/* Valve Recommendation Styles */
.valve-recommendation .primary-valve {
  text-align: center;
  padding: 12px;
  background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
  border-radius: 8px;
  margin-bottom: 12px;
}
.valve-name-large {
  font-size: 24px;
  font-weight: 700;
  color: #5b21b6;
  margin-bottom: 8px;
}
.valve-details-large {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-bottom: 8px;
}
.oversizing {
  font-size: 14px;
  font-weight: 500;
  padding: 2px 8px;
  border-radius: 4px;
}
.oversizing.optimal { background: #d1fae5; color: #065f46; }
.oversizing.within_range { background: #dbeafe; color: #1e40af; }
.oversizing.borderline { background: #fef3c7; color: #92400e; }
.oversizing.outside_range { background: #fee2e2; color: #991b1b; }
.category-badge {
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 4px;
  text-transform: capitalize;
}
.category-badge.optimal { background: #d1fae5; color: #065f46; }
.category-badge.within_range { background: #dbeafe; color: #1e40af; }
.category-badge.borderline { background: #fef3c7; color: #92400e; }
.category-badge.outside_range { background: #fee2e2; color: #991b1b; }
.rationale { font-size: 13px; color: #4b5563; margin-top: 8px; }
.alternatives h5 { font-size: 12px; color: #6b7280; margin-bottom: 8px; }
.alternative-valve {
  display: flex;
  justify-content: space-between;
  padding: 8px;
  background: #f9fafb;
  border-radius: 4px;
  margin-bottom: 4px;
}
.alternative-valve .valve-name { font-weight: 500; }
.alternative-valve .valve-details { color: #6b7280; font-size: 13px; }

/* Snapshots Gallery */
.snapshots-section {
  margin-top: 20px;
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.snapshots-section h2 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 16px;
  color: #111827;
}
.snapshots-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
}
.snapshot-card {
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid #e5e7eb;
  background: #f9fafb;
}
.snapshot-card img {
  width: 100%;
  height: 160px;
  object-fit: cover;
  background: #1f2937;
}
.snapshot-label {
  padding: 8px 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.snapshot-label .label-text {
  font-weight: 500;
  font-size: 13px;
  color: #111827;
}
.snapshot-label .slice-info {
  font-size: 11px;
  color: #6b7280;
}

.footer {
  text-align: center;
  padding: 20px;
  color: #6b7280;
  font-size: 12px;
}

/* Valve Sizing Section (Phase 9) */
.valve-sizing-section {
  margin-top: 20px;
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.valve-sizing-section h2 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 16px;
  color: #111827;
}
.selected-valve-summary {
  margin-top: 16px;
  padding: 12px 16px;
  background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
  border-radius: 8px;
  font-size: 14px;
  color: #5b21b6;
}

@media print {
  body { background: white; padding: 0; }
  .card { page-break-inside: avoid; box-shadow: none; border: 1px solid #e5e7eb; }
  .card:hover { transform: none; box-shadow: none; }
  .valve-sizing-section { page-break-before: always; box-shadow: none; border: 1px solid #e5e7eb; }
  .snapshots-section { page-break-before: always; }
  .snapshot-card { page-break-inside: avoid; }
}

@media (max-width: 768px) {
  .card-medium, .card-large { grid-column: span 1; }
  .snapshots-grid { grid-template-columns: repeat(2, 1fr); }
}
    `.trim()}escapeHTML(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/\n/g,"<br>")}async presentWorkup(e){const a=`chrome-extension://${chrome.runtime.id}/src/presentation/index.html?workupId=${e.id}`;await chrome.tabs.create({url:a,active:!0}),console.log(`[TAVIWorkupPresentationService] Opened presentation for workup ${e.id}`)}async downloadWorkupHTML(e){const r=this.generateBentoBoxHTML(e),a=new Blob([r],{type:"text/html"}),n=URL.createObjectURL(a),i=document.createElement("a");i.href=n,i.download=`TAVI_Workup_${e.patient.replace(/\s+/g,"_")}_${new Date().toISOString().split("T")[0]}.html`,i.click(),setTimeout(()=>URL.revokeObjectURL(n),1e3)}renderCTMeasurementsCard(e){if(!e)return`<div class="card card-large" data-section="ct-measurements">
  <div class="card-header color-teal">
    <h3>CT Measurements</h3>
  </div>
  <div class="card-content">
    <p class="empty">No CT measurements recorded</p>
  </div>
</div>`;const r=(l,c)=>l!==void 0?`${l}${c}`:"‚Äî",a=`
      <div class="measurement-group">
        <h4>Annulus</h4>
        <div class="measurement-grid">
          <div class="measurement">
            <span class="label">Area</span>
            <span class="value">${r(e.annulusAreaMm2," mm¬≤")}</span>
          </div>
          <div class="measurement">
            <span class="label">Perimeter</span>
            <span class="value">${r(e.annulusPerimeterMm," mm")}</span>
          </div>
          <div class="measurement">
            <span class="label">Mean Diameter</span>
            <span class="value">${r(e.annulusMeanDiameterMm," mm")}</span>
          </div>
          <div class="measurement">
            <span class="label">Min/Max</span>
            <span class="value">${e.annulusMinDiameterMm??"‚Äî"} / ${e.annulusMaxDiameterMm??"‚Äî"} mm</span>
          </div>
        </div>
      </div>
    `,n=e.coronaryHeights?`
      <div class="measurement-group">
        <h4>Coronary Heights</h4>
        <div class="measurement-grid">
          <div class="measurement">
            <span class="label">LM</span>
            <span class="value">${r(e.coronaryHeights.leftMainMm," mm")}</span>
          </div>
          <div class="measurement">
            <span class="label">RCA</span>
            <span class="value">${r(e.coronaryHeights.rightCoronaryMm," mm")}</span>
          </div>
        </div>
      </div>
    `:"",i=e.accessVessels?`
      <div class="measurement-group">
        <h4>Access Vessels</h4>
        <div class="measurement-grid">
          <div class="measurement">
            <span class="label">R CFA</span>
            <span class="value">${r(e.accessVessels.rightCFAmm," mm")}</span>
          </div>
          <div class="measurement">
            <span class="label">L CFA</span>
            <span class="value">${r(e.accessVessels.leftCFAmm," mm")}</span>
          </div>
          <div class="measurement">
            <span class="label">R EIA</span>
            <span class="value">${r(e.accessVessels.rightEIAmm," mm")}</span>
          </div>
          <div class="measurement">
            <span class="label">L EIA</span>
            <span class="value">${r(e.accessVessels.leftEIAmm," mm")}</span>
          </div>
        </div>
      </div>
    `:"",o=e.calciumScore!==void 0||e.lvotCalciumScore!==void 0?`
      <div class="measurement-group">
        <h4>Calcium Scoring</h4>
        <div class="measurement-grid">
          <div class="measurement">
            <span class="label">Leaflet</span>
            <span class="value">${r(e.calciumScore,"")}</span>
          </div>
          <div class="measurement">
            <span class="label">LVOT</span>
            <span class="value">${r(e.lvotCalciumScore,"")}</span>
          </div>
        </div>
      </div>
    `:"";return`<div class="card card-large" data-section="ct-measurements">
  <div class="card-header color-teal">
    <h3>CT Measurements</h3>
  </div>
  <div class="card-content ct-measurements">
    ${a}
    ${n}
    ${i}
    ${o}
    ${e.narrative?`<div class="narrative"><p>${this.escapeHTML(e.narrative)}</p></div>`:""}
  </div>
</div>`}renderValveRecommendationCard(e){const r=e?.annulusArea??e?.annulusAreaMm2,a=e?.annulusPerimeter??e?.annulusPerimeterMm;if(!r||!a)return"";try{const n=Al.getInstance();if(!n.validateMeasurements(r,a).valid)return`<div class="card card-medium" data-section="valve-recommendation">
  <div class="card-header color-violet">
    <h3>Valve Recommendation</h3>
  </div>
  <div class="card-content">
    <p class="empty">Measurements out of range for valve sizing</p>
  </div>
</div>`;const o=n.getBestValvePerBrand(r,a),l=n.getBrandOrder();let c=o[l[0]];for(const h of l){const f=o[h];f?.isOptimal&&(!c?.isOptimal||f.oversizing<c.oversizing)&&(c=f)}const A=l.map(h=>{const f=o[h];if(!f)return"";const u=n.getManufacturer(h),x=f.isOptimal?"optimal":"within_range";return`
          <div class="alternative-valve">
            <span class="valve-name">${u.displayName} ${f.sizeName}</span>
            <span class="valve-details ${x}">${f.oversizing.toFixed(1)}%${f.isOptimal?" ‚úì":""}</span>
          </div>
        `}).join(""),d=c?n.getManufacturer(c.brand):null;return`<div class="card card-medium" data-section="valve-recommendation">
  <div class="card-header color-violet">
    <h3>AI Valve Recommendation</h3>
  </div>
  <div class="card-content valve-recommendation">
    ${c?`
    <div class="primary-valve">
      <div class="valve-name-large">${d?.displayName} ${c.sizeName}</div>
      <div class="valve-details-large">
        <span class="oversizing ${c.isOptimal?"optimal":"within_range"}">${c.oversizing.toFixed(1)}% oversizing</span>
        ${c.isOptimal?'<span class="category-badge optimal">Optimal</span>':""}
      </div>
    </div>
    `:""}
    <div class="alternatives">
      <h5>Best by Manufacturer</h5>
      ${A}
    </div>
  </div>
</div>`}catch(n){return console.error("[TAVIWorkupPresentationService] Error generating valve recommendation:",n),""}}renderValveSizingSection(e,r){const a=e?.annulusArea??e?.annulusAreaMm2,n=e?.annulusPerimeter??e?.annulusPerimeterMm;if(!a||!n)return"";try{const i=Al.getInstance();return i.validateMeasurements(a,n).valid?`
    <div class="valve-sizing-section">
      <h2>Valve Sizing Comparison</h2>
      ${wC(a,n,r)}
      ${r?`
      <div class="selected-valve-summary">
        <strong>User Selected:</strong> ${i.getManufacturer(r.brand).displayName} ${r.size}mm
        ${r.volumeAdjustment!==void 0&&r.volumeAdjustment!==0?`(${r.volumeAdjustment>0?"+":""}${r.volumeAdjustment.toFixed(1)}mL balloon adjustment)`:""}
      </div>
      `:""}
    </div>
    `:""}catch(i){return console.error("[TAVIWorkupPresentationService] Error generating valve sizing section:",i),""}}renderSnapshotsGallery(e){return!e||e.length===0?"":`
    <div class="snapshots-section">
      <h2>CT Images</h2>
      <div class="snapshots-grid">
        ${e.map(a=>`
      <div class="snapshot-card">
        <img src="${a.thumbnailData||a.imageData}" alt="${this.escapeHTML(a.label||"CT Snapshot")}" />
        <div class="snapshot-label">
          <span class="label-text">${this.escapeHTML(a.label||"Unlabelled")}</span>
          <span class="slice-info">Slice ${a.sliceIndex}${a.sliceTotal?` / ${a.sliceTotal}`:""}</span>
        </div>
      </div>
    `).join("")}
      </div>
    </div>
    `}}const gF=Object.freeze(Object.defineProperty({__proto__:null,TAVIWorkupPresentationService:el},Symbol.toStringTag,{value:"Module"})),fF=({workup:s,onClose:e})=>{const r=m.useMemo(()=>el.getInstance(),[]),a=m.useMemo(()=>r.generateBentoBoxHTML(s),[s,r]),n=m.useMemo(()=>{const l=new Blob([a],{type:"text/html"});return URL.createObjectURL(l)},[a]),i=()=>{window.open(n,"_blank")},o=()=>{const l=document.createElement("a");l.href=n,l.download=`TAVI_Workup_${s.patient.replace(/\s+/g,"_")}_${new Date().toISOString().split("T")[0]}.html`,l.click()};return bs.useEffect(()=>()=>{URL.revokeObjectURL(n)},[n]),t.jsxs("div",{className:"fixed inset-0 z-50 flex flex-col bg-black bg-opacity-90",children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-gray-900 border-b border-gray-700",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("h2",{className:"text-lg font-semibold text-white",children:"Presentation Preview"}),t.jsx("span",{className:"text-sm text-gray-400",children:s.patient})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(ye,{variant:"ghost",size:"sm",onClick:o,icon:t.jsx(Ya,{className:"w-4 h-4"}),className:"text-gray-300 hover:text-white hover:bg-gray-700",children:"Download"}),t.jsx(ye,{variant:"ghost",size:"sm",onClick:i,icon:t.jsx(Po,{className:"w-4 h-4"}),className:"text-gray-300 hover:text-white hover:bg-gray-700",children:"Open in New Tab"}),t.jsx(ye,{variant:"ghost",size:"sm",onClick:e,icon:t.jsx(es,{className:"w-4 h-4"}),className:"text-gray-300 hover:text-white hover:bg-gray-700"})]})]}),t.jsx("div",{className:"flex-1 overflow-hidden p-4",children:t.jsx("iframe",{src:n,title:"TAVI Workup Presentation Preview",className:"w-full h-full rounded-lg bg-white shadow-2xl",sandbox:"allow-same-origin"})}),t.jsxs("div",{className:"flex items-center justify-between px-4 py-2 bg-gray-900 border-t border-gray-700",children:[t.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-400",children:[t.jsxs("span",{children:["Completion: ",s.completionPercentage,"%"]}),t.jsxs("span",{children:["Status: ",s.status]}),s.procedureDate&&t.jsxs("span",{children:["Procedure: ",s.procedureDate]})]}),t.jsx("p",{className:"text-xs text-gray-500",children:"Press ESC or click the X to close"})]})]})};function Rs(s){"@babel/helpers - typeof";return Rs=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Rs(s)}var ri=Uint8Array,fn=Uint16Array,Wp=Int32Array,qp=new ri([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Jp=new ri([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),rx=new ri([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),bw=function(s,e){for(var r=new fn(31),a=0;a<31;++a)r[a]=e+=1<<s[a-1];for(var n=new Wp(r[30]),a=1;a<30;++a)for(var i=r[a];i<r[a+1];++i)n[i]=i-r[a]<<5|a;return{b:r,r:n}},vw=bw(qp,2),xF=vw.b,cp=vw.r;xF[28]=258,cp[258]=28;var yF=bw(Jp,0),ax=yF.r,Ap=new fn(32768);for(var Xs=0;Xs<32768;++Xs){var go=(Xs&43690)>>1|(Xs&21845)<<1;go=(go&52428)>>2|(go&13107)<<2,go=(go&61680)>>4|(go&3855)<<4,Ap[Xs]=((go&65280)>>8|(go&255)<<8)>>1}var cA=function(s,e,r){for(var a=s.length,n=0,i=new fn(e);n<a;++n)s[n]&&++i[s[n]-1];var o=new fn(e);for(n=1;n<e;++n)o[n]=o[n-1]+i[n-1]<<1;var l;if(r){l=new fn(1<<e);var c=15-e;for(n=0;n<a;++n)if(s[n])for(var A=n<<4|s[n],d=e-s[n],h=o[s[n]-1]++<<d,f=h|(1<<d)-1;h<=f;++h)l[Ap[h]>>c]=A}else for(l=new fn(a),n=0;n<a;++n)s[n]&&(l[n]=Ap[o[s[n]-1]++]>>15-s[n]);return l},ul=new ri(288);for(var Xs=0;Xs<144;++Xs)ul[Xs]=8;for(var Xs=144;Xs<256;++Xs)ul[Xs]=9;for(var Xs=256;Xs<280;++Xs)ul[Xs]=7;for(var Xs=280;Xs<288;++Xs)ul[Xs]=8;var Du=new ri(32);for(var Xs=0;Xs<32;++Xs)Du[Xs]=5;var bF=cA(ul,9,0),vF=cA(Du,5,0),ww=function(s){return(s+7)/8|0},wF=function(s,e,r){return(r==null||r>s.length)&&(r=s.length),new ri(s.subarray(e,r))},Vi=function(s,e,r){r<<=e&7;var a=e/8|0;s[a]|=r,s[a+1]|=r>>8},$c=function(s,e,r){r<<=e&7;var a=e/8|0;s[a]|=r,s[a+1]|=r>>8,s[a+2]|=r>>16},ih=function(s,e){for(var r=[],a=0;a<s.length;++a)s[a]&&r.push({s:a,f:s[a]});var n=r.length,i=r.slice();if(!n)return{t:Nw,l:0};if(n==1){var o=new ri(r[0].s+1);return o[r[0].s]=1,{t:o,l:1}}r.sort(function(E,T){return E.f-T.f}),r.push({s:-1,f:25001});var l=r[0],c=r[1],A=0,d=1,h=2;for(r[0]={s:-1,f:l.f+c.f,l,r:c};d!=n-1;)l=r[r[A].f<r[h].f?A++:h++],c=r[A!=d&&r[A].f<r[h].f?A++:h++],r[d++]={s:-1,f:l.f+c.f,l,r:c};for(var f=i[0].s,a=1;a<n;++a)i[a].s>f&&(f=i[a].s);var u=new fn(f+1),x=dp(r[d-1],u,0);if(x>e){var a=0,b=0,N=x-e,v=1<<N;for(i.sort(function(T,Q){return u[Q.s]-u[T.s]||T.f-Q.f});a<n;++a){var j=i[a].s;if(u[j]>e)b+=v-(1<<x-u[j]),u[j]=e;else break}for(b>>=N;b>0;){var I=i[a].s;u[I]<e?b-=1<<e-u[I]++-1:++a}for(;a>=0&&b;--a){var C=i[a].s;u[C]==e&&(--u[C],++b)}x=e}return{t:new ri(u),l:x}},dp=function(s,e,r){return s.s==-1?Math.max(dp(s.l,e,r+1),dp(s.r,e,r+1)):e[s.s]=r},nx=function(s){for(var e=s.length;e&&!s[--e];);for(var r=new fn(++e),a=0,n=s[0],i=1,o=function(c){r[a++]=c},l=1;l<=e;++l)if(s[l]==n&&l!=e)++i;else{if(!n&&i>2){for(;i>138;i-=138)o(32754);i>2&&(o(i>10?i-11<<5|28690:i-3<<5|12305),i=0)}else if(i>3){for(o(n),--i;i>6;i-=6)o(8304);i>2&&(o(i-3<<5|8208),i=0)}for(;i--;)o(n);i=1,n=s[l]}return{c:r.subarray(0,a),n:e}},Kc=function(s,e){for(var r=0,a=0;a<e.length;++a)r+=s[a]*e[a];return r},Cw=function(s,e,r){var a=r.length,n=ww(e+2);s[n]=a&255,s[n+1]=a>>8,s[n+2]=s[n]^255,s[n+3]=s[n+1]^255;for(var i=0;i<a;++i)s[n+i+4]=r[i];return(n+4+a)*8},ix=function(s,e,r,a,n,i,o,l,c,A,d){Vi(e,d++,r),++n[256];for(var h=ih(n,15),f=h.t,u=h.l,x=ih(i,15),b=x.t,N=x.l,v=nx(f),j=v.c,I=v.n,C=nx(b),E=C.c,T=C.n,Q=new fn(19),D=0;D<j.length;++D)++Q[j[D]&31];for(var D=0;D<E.length;++D)++Q[E[D]&31];for(var k=ih(Q,7),R=k.t,w=k.l,L=19;L>4&&!R[rx[L-1]];--L);var M=A+5<<3,P=Kc(n,ul)+Kc(i,Du)+o,K=Kc(n,f)+Kc(i,b)+o+14+3*L+Kc(Q,R)+2*Q[16]+3*Q[17]+7*Q[18];if(c>=0&&M<=P&&M<=K)return Cw(e,d,s.subarray(c,c+A));var $,O,W,ee;if(Vi(e,d,1+(K<P)),d+=2,K<P){$=cA(f,u,0),O=f,W=cA(b,N,0),ee=b;var V=cA(R,w,0);Vi(e,d,I-257),Vi(e,d+5,T-1),Vi(e,d+10,L-4),d+=14;for(var D=0;D<L;++D)Vi(e,d+3*D,R[rx[D]]);d+=3*L;for(var q=[j,E],S=0;S<2;++S)for(var H=q[S],D=0;D<H.length;++D){var Y=H[D]&31;Vi(e,d,V[Y]),d+=R[Y],Y>15&&(Vi(e,d,H[D]>>5&127),d+=H[D]>>12)}}else $=bF,O=ul,W=vF,ee=Du;for(var D=0;D<l;++D){var te=a[D];if(te>255){var Y=te>>18&31;$c(e,d,$[Y+257]),d+=O[Y+257],Y>7&&(Vi(e,d,te>>23&31),d+=qp[Y]);var G=te&31;$c(e,d,W[G]),d+=ee[G],G>3&&($c(e,d,te>>5&8191),d+=Jp[G])}else $c(e,d,$[te]),d+=O[te]}return $c(e,d,$[256]),d+O[256]},CF=new Wp([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),Nw=new ri(0),NF=function(s,e,r,a,n,i){var o=i.z||s.length,l=new ri(a+o+5*(1+Math.ceil(o/7e3))+n),c=l.subarray(a,l.length-n),A=i.l,d=(i.r||0)&7;if(e){d&&(c[0]=i.r>>3);for(var h=CF[e-1],f=h>>13,u=h&8191,x=(1<<r)-1,b=i.p||new fn(32768),N=i.h||new fn(x+1),v=Math.ceil(r/3),j=2*v,I=function(Re){return(s[Re]^s[Re+1]<<v^s[Re+2]<<j)&x},C=new Wp(25e3),E=new fn(288),T=new fn(32),Q=0,D=0,k=i.i||0,R=0,w=i.w||0,L=0;k+2<o;++k){var M=I(k),P=k&32767,K=N[M];if(b[P]=K,N[M]=P,w<=k){var $=o-k;if((Q>7e3||R>24576)&&($>423||!A)){d=ix(s,c,0,C,E,T,D,R,L,k-L,d),R=Q=D=0,L=k;for(var O=0;O<286;++O)E[O]=0;for(var O=0;O<30;++O)T[O]=0}var W=2,ee=0,V=u,q=P-K&32767;if($>2&&M==I(k-q))for(var S=Math.min(f,$)-1,H=Math.min(32767,k),Y=Math.min(258,$);q<=H&&--V&&P!=K;){if(s[k+W]==s[k+W-q]){for(var te=0;te<Y&&s[k+te]==s[k+te-q];++te);if(te>W){if(W=te,ee=q,te>S)break;for(var G=Math.min(q,te-2),X=0,O=0;O<G;++O){var le=k-q+O&32767,he=b[le],ve=le-he&32767;ve>X&&(X=ve,K=le)}}}P=K,K=b[P],q+=P-K&32767}if(ee){C[R++]=268435456|cp[W]<<18|ax[ee];var ke=cp[W]&31,Le=ax[ee]&31;D+=qp[ke]+Jp[Le],++E[257+ke],++T[Le],w=k+W,++Q}else C[R++]=s[k],++E[s[k]]}}for(k=Math.max(k,w);k<o;++k)C[R++]=s[k],++E[s[k]];d=ix(s,c,A,C,E,T,D,R,L,k-L,d),A||(i.r=d&7|c[d/8|0]<<3,d-=7,i.h=N,i.p=b,i.i=k,i.w=w)}else{for(var k=i.w||0;k<o+A;k+=65535){var Be=k+65535;Be>=o&&(c[d/8|0]=A,Be=o),d=Cw(c,d+1,s.subarray(k,Be))}i.i=o}return wF(l,0,a+ww(d)+n)},Bw=function(){var s=1,e=0;return{p:function(r){for(var a=s,n=e,i=r.length|0,o=0;o!=i;){for(var l=Math.min(o+2655,i);o<l;++o)n+=a+=r[o];a=(a&65535)+15*(a>>16),n=(n&65535)+15*(n>>16)}s=a,e=n},d:function(){return s%=65521,e%=65521,(s&255)<<24|(s&65280)<<8|(e&255)<<8|e>>8}}},BF=function(s,e,r,a,n){if(!n&&(n={l:1},e.dictionary)){var i=e.dictionary.subarray(-32768),o=new ri(i.length+s.length);o.set(i),o.set(s,i.length),s=o,n.w=i.length}return NF(s,e.level==null?6:e.level,e.mem==null?n.l?Math.ceil(Math.max(8,Math.min(13,Math.log(s.length)))*1.5):20:12+e.mem,r,a,n)},Sw=function(s,e,r){for(;r;++e)s[e]=r,r>>>=8},SF=function(s,e){var r=e.level,a=r==0?0:r<6?1:r==9?3:2;if(s[0]=120,s[1]=a<<6|(e.dictionary&&32),s[1]|=31-(s[0]<<8|s[1])%31,e.dictionary){var n=Bw();n.p(e.dictionary),Sw(s,2,n.d())}};function up(s,e){e||(e={});var r=Bw();r.p(s);var a=BF(s,e,e.dictionary?6:2,4);return SF(a,e),Sw(a,a.length-4,r.d()),a}var jF=typeof TextDecoder<"u"&&new TextDecoder,EF=0;try{jF.decode(Nw,{stream:!0}),EF=1}catch{}function kF(s){if(Array.isArray(s))return s}function IF(s,e){var r=s==null?null:typeof Symbol<"u"&&s[Symbol.iterator]||s["@@iterator"];if(r!=null){var a,n,i,o,l=[],c=!0,A=!1;try{if(i=(r=r.call(s)).next,e!==0)for(;!(c=(a=i.call(r)).done)&&(l.push(a.value),l.length!==e);c=!0);}catch(d){A=!0,n=d}finally{try{if(!c&&r.return!=null&&(o=r.return(),Object(o)!==o))return}finally{if(A)throw n}}return l}}function ox(s,e){(e==null||e>s.length)&&(e=s.length);for(var r=0,a=Array(e);r<e;r++)a[r]=s[r];return a}function TF(s,e){if(s){if(typeof s=="string")return ox(s,e);var r={}.toString.call(s).slice(8,-1);return r==="Object"&&s.constructor&&(r=s.constructor.name),r==="Map"||r==="Set"?Array.from(s):r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?ox(s,e):void 0}}function FF(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function lx(s,e){return kF(s)||IF(s,e)||TF(s,e)||FF()}function cx(s,e="utf8"){return new TextDecoder(e).decode(s)}const PF=new TextEncoder;function UF(s){return PF.encode(s)}const LF=1024*8,DF=(()=>{const s=new Uint8Array(4),e=new Uint32Array(s.buffer);return!((e[0]=1)&s[0])})(),oh={int8:globalThis.Int8Array,uint8:globalThis.Uint8Array,int16:globalThis.Int16Array,uint16:globalThis.Uint16Array,int32:globalThis.Int32Array,uint32:globalThis.Uint32Array,uint64:globalThis.BigUint64Array,int64:globalThis.BigInt64Array,float32:globalThis.Float32Array,float64:globalThis.Float64Array};class Yp{buffer;byteLength;byteOffset;length;offset;lastWrittenByte;littleEndian;_data;_mark;_marks;constructor(e=LF,r={}){let a=!1;typeof e=="number"?e=new ArrayBuffer(e):(a=!0,this.lastWrittenByte=e.byteLength);const n=r.offset?r.offset>>>0:0,i=e.byteLength-n;let o=n;(ArrayBuffer.isView(e)||e instanceof Yp)&&(e.byteLength!==e.buffer.byteLength&&(o=e.byteOffset+n),e=e.buffer),a?this.lastWrittenByte=i:this.lastWrittenByte=0,this.buffer=e,this.length=i,this.byteLength=i,this.byteOffset=o,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,o,i),this._mark=0,this._marks=[]}available(e=1){return this.offset+e<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(e=1){return this.offset+=e,this}back(e=1){return this.offset-=e,this}seek(e){return this.offset=e,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const e=this._marks.pop();if(e===void 0)throw new Error("Mark stack empty");return this.seek(e),this}rewind(){return this.offset=0,this}ensureAvailable(e=1){if(!this.available(e)){const a=(this.offset+e)*2,n=new Uint8Array(a);n.set(new Uint8Array(this.buffer)),this.buffer=n.buffer,this.length=a,this.byteLength=a,this._data=new DataView(this.buffer)}return this}readBoolean(){return this.readUint8()!==0}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(e=1){return this.readArray(e,"uint8")}readArray(e,r){const a=oh[r].BYTES_PER_ELEMENT*e,n=this.byteOffset+this.offset,i=this.buffer.slice(n,n+a);if(this.littleEndian===DF&&r!=="uint8"&&r!=="int8"){const l=new Uint8Array(this.buffer.slice(n,n+a));l.reverse();const c=new oh[r](l.buffer);return this.offset+=a,c.reverse(),c}const o=new oh[r](i);return this.offset+=a,o}readInt16(){const e=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}readUint16(){const e=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,e}readInt32(){const e=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}readUint32(){const e=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}readFloat32(){const e=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}readFloat64(){const e=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}readBigInt64(){const e=this._data.getBigInt64(this.offset,this.littleEndian);return this.offset+=8,e}readBigUint64(){const e=this._data.getBigUint64(this.offset,this.littleEndian);return this.offset+=8,e}readChar(){return String.fromCharCode(this.readInt8())}readChars(e=1){let r="";for(let a=0;a<e;a++)r+=this.readChar();return r}readUtf8(e=1){return cx(this.readBytes(e))}decodeText(e=1,r="utf8"){return cx(this.readBytes(e),r)}writeBoolean(e){return this.writeUint8(e?255:0),this}writeInt8(e){return this.ensureAvailable(1),this._data.setInt8(this.offset++,e),this._updateLastWrittenByte(),this}writeUint8(e){return this.ensureAvailable(1),this._data.setUint8(this.offset++,e),this._updateLastWrittenByte(),this}writeByte(e){return this.writeUint8(e)}writeBytes(e){this.ensureAvailable(e.length);for(let r=0;r<e.length;r++)this._data.setUint8(this.offset++,e[r]);return this._updateLastWrittenByte(),this}writeInt16(e){return this.ensureAvailable(2),this._data.setInt16(this.offset,e,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(e){return this.ensureAvailable(2),this._data.setUint16(this.offset,e,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(e){return this.ensureAvailable(4),this._data.setInt32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(e){return this.ensureAvailable(4),this._data.setUint32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(e){return this.ensureAvailable(4),this._data.setFloat32(this.offset,e,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(e){return this.ensureAvailable(8),this._data.setFloat64(this.offset,e,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigInt64(e){return this.ensureAvailable(8),this._data.setBigInt64(this.offset,e,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeBigUint64(e){return this.ensureAvailable(8),this._data.setBigUint64(this.offset,e,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(e){return this.writeUint8(e.charCodeAt(0))}writeChars(e){for(let r=0;r<e.length;r++)this.writeUint8(e.charCodeAt(r));return this}writeUtf8(e){return this.writeBytes(UF(e))}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this.lastWrittenByte)}getWrittenByteLength(){return this.lastWrittenByte-this.byteOffset}_updateLastWrittenByte(){this.offset>this.lastWrittenByte&&(this.lastWrittenByte=this.offset)}}function fc(s){let e=s.length;for(;--e>=0;)s[e]=0}const RF=3,MF=258,jw=29,_F=256,QF=_F+1+jw,Ew=30,OF=512,HF=new Array((QF+2)*2);fc(HF);const VF=new Array(Ew*2);fc(VF);const $F=new Array(OF);fc($F);const KF=new Array(MF-RF+1);fc(KF);const GF=new Array(jw);fc(GF);const zF=new Array(Ew);fc(zF);const WF=(s,e,r,a)=>{let n=s&65535|0,i=s>>>16&65535|0,o=0;for(;r!==0;){o=r>2e3?2e3:r,r-=o;do n=n+e[a++]|0,i=i+n|0;while(--o);n%=65521,i%=65521}return n|i<<16|0};var mp=WF;const qF=()=>{let s,e=[];for(var r=0;r<256;r++){s=r;for(var a=0;a<8;a++)s=s&1?3988292384^s>>>1:s>>>1;e[r]=s}return e},JF=new Uint32Array(qF()),YF=(s,e,r,a)=>{const n=JF,i=a+r;s^=-1;for(let o=a;o<i;o++)s=s>>>8^n[(s^e[o])&255];return s^-1};var yi=YF,hp={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},kw={Z_NO_FLUSH:0,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_DEFLATED:8};const XF=(s,e)=>Object.prototype.hasOwnProperty.call(s,e);var ZF=function(s){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const r=e.shift();if(r){if(typeof r!="object")throw new TypeError(r+"must be non-object");for(const a in r)XF(r,a)&&(s[a]=r[a])}}return s},eP=s=>{let e=0;for(let a=0,n=s.length;a<n;a++)e+=s[a].length;const r=new Uint8Array(e);for(let a=0,n=0,i=s.length;a<i;a++){let o=s[a];r.set(o,n),n+=o.length}return r},Iw={assign:ZF,flattenChunks:eP};let Tw=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{Tw=!1}const bA=new Uint8Array(256);for(let s=0;s<256;s++)bA[s]=s>=252?6:s>=248?5:s>=240?4:s>=224?3:s>=192?2:1;bA[254]=bA[254]=1;var tP=s=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(s);let e,r,a,n,i,o=s.length,l=0;for(n=0;n<o;n++)r=s.charCodeAt(n),(r&64512)===55296&&n+1<o&&(a=s.charCodeAt(n+1),(a&64512)===56320&&(r=65536+(r-55296<<10)+(a-56320),n++)),l+=r<128?1:r<2048?2:r<65536?3:4;for(e=new Uint8Array(l),i=0,n=0;i<l;n++)r=s.charCodeAt(n),(r&64512)===55296&&n+1<o&&(a=s.charCodeAt(n+1),(a&64512)===56320&&(r=65536+(r-55296<<10)+(a-56320),n++)),r<128?e[i++]=r:r<2048?(e[i++]=192|r>>>6,e[i++]=128|r&63):r<65536?(e[i++]=224|r>>>12,e[i++]=128|r>>>6&63,e[i++]=128|r&63):(e[i++]=240|r>>>18,e[i++]=128|r>>>12&63,e[i++]=128|r>>>6&63,e[i++]=128|r&63);return e};const sP=(s,e)=>{if(e<65534&&s.subarray&&Tw)return String.fromCharCode.apply(null,s.length===e?s:s.subarray(0,e));let r="";for(let a=0;a<e;a++)r+=String.fromCharCode(s[a]);return r};var rP=(s,e)=>{const r=e||s.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(s.subarray(0,e));let a,n;const i=new Array(r*2);for(n=0,a=0;a<r;){let o=s[a++];if(o<128){i[n++]=o;continue}let l=bA[o];if(l>4){i[n++]=65533,a+=l-1;continue}for(o&=l===2?31:l===3?15:7;l>1&&a<r;)o=o<<6|s[a++]&63,l--;if(l>1){i[n++]=65533;continue}o<65536?i[n++]=o:(o-=65536,i[n++]=55296|o>>10&1023,i[n++]=56320|o&1023)}return sP(i,n)},aP=(s,e)=>{e=e||s.length,e>s.length&&(e=s.length);let r=e-1;for(;r>=0&&(s[r]&192)===128;)r--;return r<0||r===0?e:r+bA[s[r]]>e?r:e},pp={string2buf:tP,buf2string:rP,utf8border:aP};function nP(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var iP=nP;const Rd=16209,oP=16191;var lP=function(e,r){let a,n,i,o,l,c,A,d,h,f,u,x,b,N,v,j,I,C,E,T,Q,D,k,R;const w=e.state;a=e.next_in,k=e.input,n=a+(e.avail_in-5),i=e.next_out,R=e.output,o=i-(r-e.avail_out),l=i+(e.avail_out-257),c=w.dmax,A=w.wsize,d=w.whave,h=w.wnext,f=w.window,u=w.hold,x=w.bits,b=w.lencode,N=w.distcode,v=(1<<w.lenbits)-1,j=(1<<w.distbits)-1;e:do{x<15&&(u+=k[a++]<<x,x+=8,u+=k[a++]<<x,x+=8),I=b[u&v];t:for(;;){if(C=I>>>24,u>>>=C,x-=C,C=I>>>16&255,C===0)R[i++]=I&65535;else if(C&16){E=I&65535,C&=15,C&&(x<C&&(u+=k[a++]<<x,x+=8),E+=u&(1<<C)-1,u>>>=C,x-=C),x<15&&(u+=k[a++]<<x,x+=8,u+=k[a++]<<x,x+=8),I=N[u&j];s:for(;;){if(C=I>>>24,u>>>=C,x-=C,C=I>>>16&255,C&16){if(T=I&65535,C&=15,x<C&&(u+=k[a++]<<x,x+=8,x<C&&(u+=k[a++]<<x,x+=8)),T+=u&(1<<C)-1,T>c){e.msg="invalid distance too far back",w.mode=Rd;break e}if(u>>>=C,x-=C,C=i-o,T>C){if(C=T-C,C>d&&w.sane){e.msg="invalid distance too far back",w.mode=Rd;break e}if(Q=0,D=f,h===0){if(Q+=A-C,C<E){E-=C;do R[i++]=f[Q++];while(--C);Q=i-T,D=R}}else if(h<C){if(Q+=A+h-C,C-=h,C<E){E-=C;do R[i++]=f[Q++];while(--C);if(Q=0,h<E){C=h,E-=C;do R[i++]=f[Q++];while(--C);Q=i-T,D=R}}}else if(Q+=h-C,C<E){E-=C;do R[i++]=f[Q++];while(--C);Q=i-T,D=R}for(;E>2;)R[i++]=D[Q++],R[i++]=D[Q++],R[i++]=D[Q++],E-=3;E&&(R[i++]=D[Q++],E>1&&(R[i++]=D[Q++]))}else{Q=i-T;do R[i++]=R[Q++],R[i++]=R[Q++],R[i++]=R[Q++],E-=3;while(E>2);E&&(R[i++]=R[Q++],E>1&&(R[i++]=R[Q++]))}}else if(C&64){e.msg="invalid distance code",w.mode=Rd;break e}else{I=N[(I&65535)+(u&(1<<C)-1)];continue s}break}}else if(C&64)if(C&32){w.mode=oP;break e}else{e.msg="invalid literal/length code",w.mode=Rd;break e}else{I=b[(I&65535)+(u&(1<<C)-1)];continue t}break}}while(a<n&&i<l);E=x>>3,a-=E,x-=E<<3,u&=(1<<x)-1,e.next_in=a,e.next_out=i,e.avail_in=a<n?5+(n-a):5-(a-n),e.avail_out=i<l?257+(l-i):257-(i-l),w.hold=u,w.bits=x};const Tl=15,Ax=852,dx=592,ux=0,lh=1,mx=2,cP=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),AP=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),dP=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),uP=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),mP=(s,e,r,a,n,i,o,l)=>{const c=l.bits;let A=0,d=0,h=0,f=0,u=0,x=0,b=0,N=0,v=0,j=0,I,C,E,T,Q,D=null,k;const R=new Uint16Array(Tl+1),w=new Uint16Array(Tl+1);let L=null,M,P,K;for(A=0;A<=Tl;A++)R[A]=0;for(d=0;d<a;d++)R[e[r+d]]++;for(u=c,f=Tl;f>=1&&R[f]===0;f--);if(u>f&&(u=f),f===0)return n[i++]=1<<24|64<<16|0,n[i++]=1<<24|64<<16|0,l.bits=1,0;for(h=1;h<f&&R[h]===0;h++);for(u<h&&(u=h),N=1,A=1;A<=Tl;A++)if(N<<=1,N-=R[A],N<0)return-1;if(N>0&&(s===ux||f!==1))return-1;for(w[1]=0,A=1;A<Tl;A++)w[A+1]=w[A]+R[A];for(d=0;d<a;d++)e[r+d]!==0&&(o[w[e[r+d]]++]=d);if(s===ux?(D=L=o,k=20):s===lh?(D=cP,L=AP,k=257):(D=dP,L=uP,k=0),j=0,d=0,A=h,Q=i,x=u,b=0,E=-1,v=1<<u,T=v-1,s===lh&&v>Ax||s===mx&&v>dx)return 1;for(;;){M=A-b,o[d]+1<k?(P=0,K=o[d]):o[d]>=k?(P=L[o[d]-k],K=D[o[d]-k]):(P=96,K=0),I=1<<A-b,C=1<<x,h=C;do C-=I,n[Q+(j>>b)+C]=M<<24|P<<16|K|0;while(C!==0);for(I=1<<A-1;j&I;)I>>=1;if(I!==0?(j&=I-1,j+=I):j=0,d++,--R[A]===0){if(A===f)break;A=e[r+o[d]]}if(A>u&&(j&T)!==E){for(b===0&&(b=u),Q+=h,x=A-b,N=1<<x;x+b<f&&(N-=R[x+b],!(N<=0));)x++,N<<=1;if(v+=1<<x,s===lh&&v>Ax||s===mx&&v>dx)return 1;E=j&T,n[E]=u<<24|x<<16|Q-i|0}}return j!==0&&(n[Q+j]=A-b<<24|64<<16|0),l.bits=u,0};var AA=mP;const hP=0,Fw=1,Pw=2,{Z_FINISH:hx,Z_BLOCK:pP,Z_TREES:Md,Z_OK:ml,Z_STREAM_END:gP,Z_NEED_DICT:fP,Z_STREAM_ERROR:Dn,Z_DATA_ERROR:Uw,Z_MEM_ERROR:Lw,Z_BUF_ERROR:xP,Z_DEFLATED:px}=kw,lm=16180,gx=16181,fx=16182,xx=16183,yx=16184,bx=16185,vx=16186,wx=16187,Cx=16188,Nx=16189,Ru=16190,$i=16191,ch=16192,Bx=16193,Ah=16194,Sx=16195,jx=16196,Ex=16197,kx=16198,_d=16199,Qd=16200,Ix=16201,Tx=16202,Fx=16203,Px=16204,Ux=16205,dh=16206,Lx=16207,Dx=16208,nr=16209,Dw=16210,Rw=16211,yP=852,bP=592,vP=15,wP=vP,Rx=s=>(s>>>24&255)+(s>>>8&65280)+((s&65280)<<8)+((s&255)<<24);function CP(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const hl=s=>{if(!s)return 1;const e=s.state;return!e||e.strm!==s||e.mode<lm||e.mode>Rw?1:0},Mw=s=>{if(hl(s))return Dn;const e=s.state;return s.total_in=s.total_out=e.total=0,s.msg="",e.wrap&&(s.adler=e.wrap&1),e.mode=lm,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(yP),e.distcode=e.distdyn=new Int32Array(bP),e.sane=1,e.back=-1,ml},_w=s=>{if(hl(s))return Dn;const e=s.state;return e.wsize=0,e.whave=0,e.wnext=0,Mw(s)},Qw=(s,e)=>{let r;if(hl(s))return Dn;const a=s.state;return e<0?(r=0,e=-e):(r=(e>>4)+5,e<48&&(e&=15)),e&&(e<8||e>15)?Dn:(a.window!==null&&a.wbits!==e&&(a.window=null),a.wrap=r,a.wbits=e,_w(s))},Ow=(s,e)=>{if(!s)return Dn;const r=new CP;s.state=r,r.strm=s,r.window=null,r.mode=lm;const a=Qw(s,e);return a!==ml&&(s.state=null),a},NP=s=>Ow(s,wP);let Mx=!0,uh,mh;const BP=s=>{if(Mx){uh=new Int32Array(512),mh=new Int32Array(32);let e=0;for(;e<144;)s.lens[e++]=8;for(;e<256;)s.lens[e++]=9;for(;e<280;)s.lens[e++]=7;for(;e<288;)s.lens[e++]=8;for(AA(Fw,s.lens,0,288,uh,0,s.work,{bits:9}),e=0;e<32;)s.lens[e++]=5;AA(Pw,s.lens,0,32,mh,0,s.work,{bits:5}),Mx=!1}s.lencode=uh,s.lenbits=9,s.distcode=mh,s.distbits=5},Hw=(s,e,r,a)=>{let n;const i=s.state;return i.window===null&&(i.wsize=1<<i.wbits,i.wnext=0,i.whave=0,i.window=new Uint8Array(i.wsize)),a>=i.wsize?(i.window.set(e.subarray(r-i.wsize,r),0),i.wnext=0,i.whave=i.wsize):(n=i.wsize-i.wnext,n>a&&(n=a),i.window.set(e.subarray(r-a,r-a+n),i.wnext),a-=n,a?(i.window.set(e.subarray(r-a,r),0),i.wnext=a,i.whave=i.wsize):(i.wnext+=n,i.wnext===i.wsize&&(i.wnext=0),i.whave<i.wsize&&(i.whave+=n))),0},SP=(s,e)=>{let r,a,n,i,o,l,c,A,d,h,f,u,x,b,N=0,v,j,I,C,E,T,Q,D;const k=new Uint8Array(4);let R,w;const L=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(hl(s)||!s.output||!s.input&&s.avail_in!==0)return Dn;r=s.state,r.mode===$i&&(r.mode=ch),o=s.next_out,n=s.output,c=s.avail_out,i=s.next_in,a=s.input,l=s.avail_in,A=r.hold,d=r.bits,h=l,f=c,D=ml;e:for(;;)switch(r.mode){case lm:if(r.wrap===0){r.mode=ch;break}for(;d<16;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}if(r.wrap&2&&A===35615){r.wbits===0&&(r.wbits=15),r.check=0,k[0]=A&255,k[1]=A>>>8&255,r.check=yi(r.check,k,2,0),A=0,d=0,r.mode=gx;break}if(r.head&&(r.head.done=!1),!(r.wrap&1)||(((A&255)<<8)+(A>>8))%31){s.msg="incorrect header check",r.mode=nr;break}if((A&15)!==px){s.msg="unknown compression method",r.mode=nr;break}if(A>>>=4,d-=4,Q=(A&15)+8,r.wbits===0&&(r.wbits=Q),Q>15||Q>r.wbits){s.msg="invalid window size",r.mode=nr;break}r.dmax=1<<r.wbits,r.flags=0,s.adler=r.check=1,r.mode=A&512?Nx:$i,A=0,d=0;break;case gx:for(;d<16;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}if(r.flags=A,(r.flags&255)!==px){s.msg="unknown compression method",r.mode=nr;break}if(r.flags&57344){s.msg="unknown header flags set",r.mode=nr;break}r.head&&(r.head.text=A>>8&1),r.flags&512&&r.wrap&4&&(k[0]=A&255,k[1]=A>>>8&255,r.check=yi(r.check,k,2,0)),A=0,d=0,r.mode=fx;case fx:for(;d<32;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}r.head&&(r.head.time=A),r.flags&512&&r.wrap&4&&(k[0]=A&255,k[1]=A>>>8&255,k[2]=A>>>16&255,k[3]=A>>>24&255,r.check=yi(r.check,k,4,0)),A=0,d=0,r.mode=xx;case xx:for(;d<16;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}r.head&&(r.head.xflags=A&255,r.head.os=A>>8),r.flags&512&&r.wrap&4&&(k[0]=A&255,k[1]=A>>>8&255,r.check=yi(r.check,k,2,0)),A=0,d=0,r.mode=yx;case yx:if(r.flags&1024){for(;d<16;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}r.length=A,r.head&&(r.head.extra_len=A),r.flags&512&&r.wrap&4&&(k[0]=A&255,k[1]=A>>>8&255,r.check=yi(r.check,k,2,0)),A=0,d=0}else r.head&&(r.head.extra=null);r.mode=bx;case bx:if(r.flags&1024&&(u=r.length,u>l&&(u=l),u&&(r.head&&(Q=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Uint8Array(r.head.extra_len)),r.head.extra.set(a.subarray(i,i+u),Q)),r.flags&512&&r.wrap&4&&(r.check=yi(r.check,a,u,i)),l-=u,i+=u,r.length-=u),r.length))break e;r.length=0,r.mode=vx;case vx:if(r.flags&2048){if(l===0)break e;u=0;do Q=a[i+u++],r.head&&Q&&r.length<65536&&(r.head.name+=String.fromCharCode(Q));while(Q&&u<l);if(r.flags&512&&r.wrap&4&&(r.check=yi(r.check,a,u,i)),l-=u,i+=u,Q)break e}else r.head&&(r.head.name=null);r.length=0,r.mode=wx;case wx:if(r.flags&4096){if(l===0)break e;u=0;do Q=a[i+u++],r.head&&Q&&r.length<65536&&(r.head.comment+=String.fromCharCode(Q));while(Q&&u<l);if(r.flags&512&&r.wrap&4&&(r.check=yi(r.check,a,u,i)),l-=u,i+=u,Q)break e}else r.head&&(r.head.comment=null);r.mode=Cx;case Cx:if(r.flags&512){for(;d<16;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}if(r.wrap&4&&A!==(r.check&65535)){s.msg="header crc mismatch",r.mode=nr;break}A=0,d=0}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),s.adler=r.check=0,r.mode=$i;break;case Nx:for(;d<32;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}s.adler=r.check=Rx(A),A=0,d=0,r.mode=Ru;case Ru:if(r.havedict===0)return s.next_out=o,s.avail_out=c,s.next_in=i,s.avail_in=l,r.hold=A,r.bits=d,fP;s.adler=r.check=1,r.mode=$i;case $i:if(e===pP||e===Md)break e;case ch:if(r.last){A>>>=d&7,d-=d&7,r.mode=dh;break}for(;d<3;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}switch(r.last=A&1,A>>>=1,d-=1,A&3){case 0:r.mode=Bx;break;case 1:if(BP(r),r.mode=_d,e===Md){A>>>=2,d-=2;break e}break;case 2:r.mode=jx;break;case 3:s.msg="invalid block type",r.mode=nr}A>>>=2,d-=2;break;case Bx:for(A>>>=d&7,d-=d&7;d<32;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}if((A&65535)!==(A>>>16^65535)){s.msg="invalid stored block lengths",r.mode=nr;break}if(r.length=A&65535,A=0,d=0,r.mode=Ah,e===Md)break e;case Ah:r.mode=Sx;case Sx:if(u=r.length,u){if(u>l&&(u=l),u>c&&(u=c),u===0)break e;n.set(a.subarray(i,i+u),o),l-=u,i+=u,c-=u,o+=u,r.length-=u;break}r.mode=$i;break;case jx:for(;d<14;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}if(r.nlen=(A&31)+257,A>>>=5,d-=5,r.ndist=(A&31)+1,A>>>=5,d-=5,r.ncode=(A&15)+4,A>>>=4,d-=4,r.nlen>286||r.ndist>30){s.msg="too many length or distance symbols",r.mode=nr;break}r.have=0,r.mode=Ex;case Ex:for(;r.have<r.ncode;){for(;d<3;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}r.lens[L[r.have++]]=A&7,A>>>=3,d-=3}for(;r.have<19;)r.lens[L[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,R={bits:r.lenbits},D=AA(hP,r.lens,0,19,r.lencode,0,r.work,R),r.lenbits=R.bits,D){s.msg="invalid code lengths set",r.mode=nr;break}r.have=0,r.mode=kx;case kx:for(;r.have<r.nlen+r.ndist;){for(;N=r.lencode[A&(1<<r.lenbits)-1],v=N>>>24,j=N>>>16&255,I=N&65535,!(v<=d);){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}if(I<16)A>>>=v,d-=v,r.lens[r.have++]=I;else{if(I===16){for(w=v+2;d<w;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}if(A>>>=v,d-=v,r.have===0){s.msg="invalid bit length repeat",r.mode=nr;break}Q=r.lens[r.have-1],u=3+(A&3),A>>>=2,d-=2}else if(I===17){for(w=v+3;d<w;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}A>>>=v,d-=v,Q=0,u=3+(A&7),A>>>=3,d-=3}else{for(w=v+7;d<w;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}A>>>=v,d-=v,Q=0,u=11+(A&127),A>>>=7,d-=7}if(r.have+u>r.nlen+r.ndist){s.msg="invalid bit length repeat",r.mode=nr;break}for(;u--;)r.lens[r.have++]=Q}}if(r.mode===nr)break;if(r.lens[256]===0){s.msg="invalid code -- missing end-of-block",r.mode=nr;break}if(r.lenbits=9,R={bits:r.lenbits},D=AA(Fw,r.lens,0,r.nlen,r.lencode,0,r.work,R),r.lenbits=R.bits,D){s.msg="invalid literal/lengths set",r.mode=nr;break}if(r.distbits=6,r.distcode=r.distdyn,R={bits:r.distbits},D=AA(Pw,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,R),r.distbits=R.bits,D){s.msg="invalid distances set",r.mode=nr;break}if(r.mode=_d,e===Md)break e;case _d:r.mode=Qd;case Qd:if(l>=6&&c>=258){s.next_out=o,s.avail_out=c,s.next_in=i,s.avail_in=l,r.hold=A,r.bits=d,lP(s,f),o=s.next_out,n=s.output,c=s.avail_out,i=s.next_in,a=s.input,l=s.avail_in,A=r.hold,d=r.bits,r.mode===$i&&(r.back=-1);break}for(r.back=0;N=r.lencode[A&(1<<r.lenbits)-1],v=N>>>24,j=N>>>16&255,I=N&65535,!(v<=d);){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}if(j&&!(j&240)){for(C=v,E=j,T=I;N=r.lencode[T+((A&(1<<C+E)-1)>>C)],v=N>>>24,j=N>>>16&255,I=N&65535,!(C+v<=d);){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}A>>>=C,d-=C,r.back+=C}if(A>>>=v,d-=v,r.back+=v,r.length=I,j===0){r.mode=Ux;break}if(j&32){r.back=-1,r.mode=$i;break}if(j&64){s.msg="invalid literal/length code",r.mode=nr;break}r.extra=j&15,r.mode=Ix;case Ix:if(r.extra){for(w=r.extra;d<w;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}r.length+=A&(1<<r.extra)-1,A>>>=r.extra,d-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=Tx;case Tx:for(;N=r.distcode[A&(1<<r.distbits)-1],v=N>>>24,j=N>>>16&255,I=N&65535,!(v<=d);){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}if(!(j&240)){for(C=v,E=j,T=I;N=r.distcode[T+((A&(1<<C+E)-1)>>C)],v=N>>>24,j=N>>>16&255,I=N&65535,!(C+v<=d);){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}A>>>=C,d-=C,r.back+=C}if(A>>>=v,d-=v,r.back+=v,j&64){s.msg="invalid distance code",r.mode=nr;break}r.offset=I,r.extra=j&15,r.mode=Fx;case Fx:if(r.extra){for(w=r.extra;d<w;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}r.offset+=A&(1<<r.extra)-1,A>>>=r.extra,d-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){s.msg="invalid distance too far back",r.mode=nr;break}r.mode=Px;case Px:if(c===0)break e;if(u=f-c,r.offset>u){if(u=r.offset-u,u>r.whave&&r.sane){s.msg="invalid distance too far back",r.mode=nr;break}u>r.wnext?(u-=r.wnext,x=r.wsize-u):x=r.wnext-u,u>r.length&&(u=r.length),b=r.window}else b=n,x=o-r.offset,u=r.length;u>c&&(u=c),c-=u,r.length-=u;do n[o++]=b[x++];while(--u);r.length===0&&(r.mode=Qd);break;case Ux:if(c===0)break e;n[o++]=r.length,c--,r.mode=Qd;break;case dh:if(r.wrap){for(;d<32;){if(l===0)break e;l--,A|=a[i++]<<d,d+=8}if(f-=c,s.total_out+=f,r.total+=f,r.wrap&4&&f&&(s.adler=r.check=r.flags?yi(r.check,n,f,o-f):mp(r.check,n,f,o-f)),f=c,r.wrap&4&&(r.flags?A:Rx(A))!==r.check){s.msg="incorrect data check",r.mode=nr;break}A=0,d=0}r.mode=Lx;case Lx:if(r.wrap&&r.flags){for(;d<32;){if(l===0)break e;l--,A+=a[i++]<<d,d+=8}if(r.wrap&4&&A!==(r.total&4294967295)){s.msg="incorrect length check",r.mode=nr;break}A=0,d=0}r.mode=Dx;case Dx:D=gP;break e;case nr:D=Uw;break e;case Dw:return Lw;case Rw:default:return Dn}return s.next_out=o,s.avail_out=c,s.next_in=i,s.avail_in=l,r.hold=A,r.bits=d,(r.wsize||f!==s.avail_out&&r.mode<nr&&(r.mode<dh||e!==hx))&&Hw(s,s.output,s.next_out,f-s.avail_out),h-=s.avail_in,f-=s.avail_out,s.total_in+=h,s.total_out+=f,r.total+=f,r.wrap&4&&f&&(s.adler=r.check=r.flags?yi(r.check,n,f,s.next_out-f):mp(r.check,n,f,s.next_out-f)),s.data_type=r.bits+(r.last?64:0)+(r.mode===$i?128:0)+(r.mode===_d||r.mode===Ah?256:0),(h===0&&f===0||e===hx)&&D===ml&&(D=xP),D},jP=s=>{if(hl(s))return Dn;let e=s.state;return e.window&&(e.window=null),s.state=null,ml},EP=(s,e)=>{if(hl(s))return Dn;const r=s.state;return r.wrap&2?(r.head=e,e.done=!1,ml):Dn},kP=(s,e)=>{const r=e.length;let a,n,i;return hl(s)||(a=s.state,a.wrap!==0&&a.mode!==Ru)?Dn:a.mode===Ru&&(n=1,n=mp(n,e,r,0),n!==a.check)?Uw:(i=Hw(s,e,r,r),i?(a.mode=Dw,Lw):(a.havedict=1,ml))};var IP=_w,TP=Qw,FP=Mw,PP=NP,UP=Ow,LP=SP,DP=jP,RP=EP,MP=kP,_P="pako inflate (from Nodeca project)",Ki={inflateReset:IP,inflateReset2:TP,inflateResetKeep:FP,inflateInit:PP,inflateInit2:UP,inflate:LP,inflateEnd:DP,inflateGetHeader:RP,inflateSetDictionary:MP,inflateInfo:_P};function QP(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var OP=QP;const Vw=Object.prototype.toString,{Z_NO_FLUSH:HP,Z_FINISH:VP,Z_OK:vA,Z_STREAM_END:hh,Z_NEED_DICT:ph,Z_STREAM_ERROR:$P,Z_DATA_ERROR:_x,Z_MEM_ERROR:KP}=kw;function IA(s){this.options=Iw.assign({chunkSize:1024*64,windowBits:15,to:""},s||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),e.windowBits>=0&&e.windowBits<16&&!(s&&s.windowBits)&&(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&(e.windowBits&15||(e.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new iP,this.strm.avail_out=0;let r=Ki.inflateInit2(this.strm,e.windowBits);if(r!==vA)throw new Error(hp[r]);if(this.header=new OP,Ki.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=pp.string2buf(e.dictionary):Vw.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(r=Ki.inflateSetDictionary(this.strm,e.dictionary),r!==vA)))throw new Error(hp[r])}IA.prototype.push=function(s,e){const r=this.strm,a=this.options.chunkSize,n=this.options.dictionary;let i,o,l;if(this.ended)return!1;for(e===~~e?o=e:o=e===!0?VP:HP,Vw.call(s)==="[object ArrayBuffer]"?r.input=new Uint8Array(s):r.input=s,r.next_in=0,r.avail_in=r.input.length;;){for(r.avail_out===0&&(r.output=new Uint8Array(a),r.next_out=0,r.avail_out=a),i=Ki.inflate(r,o),i===ph&&n&&(i=Ki.inflateSetDictionary(r,n),i===vA?i=Ki.inflate(r,o):i===_x&&(i=ph));r.avail_in>0&&i===hh&&r.state.wrap>0&&s[r.next_in]!==0;)Ki.inflateReset(r),i=Ki.inflate(r,o);switch(i){case $P:case _x:case ph:case KP:return this.onEnd(i),this.ended=!0,!1}if(l=r.avail_out,r.next_out&&(r.avail_out===0||i===hh))if(this.options.to==="string"){let c=pp.utf8border(r.output,r.next_out),A=r.next_out-c,d=pp.buf2string(r.output,c);r.next_out=A,r.avail_out=a-A,A&&r.output.set(r.output.subarray(c,c+A),0),this.onData(d)}else this.onData(r.output.length===r.next_out?r.output:r.output.subarray(0,r.next_out));if(!(i===vA&&l===0)){if(i===hh)return i=Ki.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,!0;if(r.avail_in===0)break}}return!0};IA.prototype.onData=function(s){this.chunks.push(s)};IA.prototype.onEnd=function(s){s===vA&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Iw.flattenChunks(this.chunks)),this.chunks=[],this.err=s,this.msg=this.strm.msg};function GP(s,e){const r=new IA(e);if(r.push(s),r.err)throw r.msg||hp[r.err];return r.result}var zP=IA,WP=GP,qP={Inflate:zP,inflate:WP};const{Inflate:JP,inflate:YP}=qP;var Qx=JP,XP=YP;const $w=[];for(let s=0;s<256;s++){let e=s;for(let r=0;r<8;r++)e&1?e=3988292384^e>>>1:e=e>>>1;$w[s]=e}const Ox=4294967295;function ZP(s,e,r){let a=s;for(let n=0;n<r;n++)a=$w[(a^e[n])&255]^a>>>8;return a}function eU(s,e){return(ZP(Ox,s,e)^Ox)>>>0}function Hx(s,e,r){const a=s.readUint32(),n=eU(new Uint8Array(s.buffer,s.byteOffset+s.offset-e-4,e),e);if(n!==a)throw new Error(`CRC mismatch for chunk ${r}. Expected ${a}, found ${n}`)}function Kw(s,e,r){for(let a=0;a<r;a++)e[a]=s[a]}function Gw(s,e,r,a){let n=0;for(;n<a;n++)e[n]=s[n];for(;n<r;n++)e[n]=s[n]+e[n-a]&255}function zw(s,e,r,a){let n=0;if(r.length===0)for(;n<a;n++)e[n]=s[n];else for(;n<a;n++)e[n]=s[n]+r[n]&255}function Ww(s,e,r,a,n){let i=0;if(r.length===0){for(;i<n;i++)e[i]=s[i];for(;i<a;i++)e[i]=s[i]+(e[i-n]>>1)&255}else{for(;i<n;i++)e[i]=s[i]+(r[i]>>1)&255;for(;i<a;i++)e[i]=s[i]+(e[i-n]+r[i]>>1)&255}}function qw(s,e,r,a,n){let i=0;if(r.length===0){for(;i<n;i++)e[i]=s[i];for(;i<a;i++)e[i]=s[i]+e[i-n]&255}else{for(;i<n;i++)e[i]=s[i]+r[i]&255;for(;i<a;i++)e[i]=s[i]+tU(e[i-n],r[i],r[i-n])&255}}function tU(s,e,r){const a=s+e-r,n=Math.abs(a-s),i=Math.abs(a-e),o=Math.abs(a-r);return n<=i&&n<=o?s:i<=o?e:r}function sU(s,e,r,a,n,i){switch(s){case 0:Kw(e,r,n);break;case 1:Gw(e,r,n,i);break;case 2:zw(e,r,a,n);break;case 3:Ww(e,r,a,n,i);break;case 4:qw(e,r,a,n,i);break;default:throw new Error(`Unsupported filter: ${s}`)}}const rU=new Uint16Array([255]),aU=new Uint8Array(rU.buffer),nU=aU[0]===255;function iU(s){const{data:e,width:r,height:a,channels:n,depth:i}=s,o=[{x:0,y:0,xStep:8,yStep:8},{x:4,y:0,xStep:8,yStep:8},{x:0,y:4,xStep:4,yStep:8},{x:2,y:0,xStep:4,yStep:4},{x:0,y:2,xStep:2,yStep:4},{x:1,y:0,xStep:2,yStep:2},{x:0,y:1,xStep:1,yStep:2}],l=Math.ceil(i/8)*n,c=new Uint8Array(a*r*l);let A=0;for(let d=0;d<7;d++){const h=o[d],f=Math.ceil((r-h.x)/h.xStep),u=Math.ceil((a-h.y)/h.yStep);if(f<=0||u<=0)continue;const x=f*l,b=new Uint8Array(x);for(let N=0;N<u;N++){const v=e[A++],j=e.subarray(A,A+x);A+=x;const I=new Uint8Array(x);sU(v,j,I,b,x,l),b.set(I);for(let C=0;C<f;C++){const E=h.x+C*h.xStep,T=h.y+N*h.yStep;if(!(E>=r||T>=a))for(let Q=0;Q<l;Q++)c[(T*r+E)*l+Q]=I[C*l+Q]}}}if(i===16){const d=new Uint16Array(c.buffer);if(nU)for(let h=0;h<d.length;h++)d[h]=oU(d[h]);return d}else return c}function oU(s){return(s&255)<<8|s>>8&255}const lU=new Uint16Array([255]),cU=new Uint8Array(lU.buffer),AU=cU[0]===255,dU=new Uint8Array(0);function Vx(s){const{data:e,width:r,height:a,channels:n,depth:i}=s,o=Math.ceil(i/8)*n,l=Math.ceil(i/8*n*r),c=new Uint8Array(a*l);let A=dU,d=0,h,f;for(let u=0;u<a;u++){switch(h=e.subarray(d+1,d+1+l),f=c.subarray(u*l,(u+1)*l),e[d]){case 0:Kw(h,f,l);break;case 1:Gw(h,f,l,o);break;case 2:zw(h,f,A,l);break;case 3:Ww(h,f,A,l,o);break;case 4:qw(h,f,A,l,o);break;default:throw new Error(`Unsupported filter: ${e[d]}`)}A=f,d+=l+1}if(i===16){const u=new Uint16Array(c.buffer);if(AU)for(let x=0;x<u.length;x++)u[x]=uU(u[x]);return u}else return c}function uU(s){return(s&255)<<8|s>>8&255}const tu=Uint8Array.of(137,80,78,71,13,10,26,10);function $x(s){if(!mU(s.readBytes(tu.length)))throw new Error("wrong PNG signature")}function mU(s){if(s.length<tu.length)return!1;for(let e=0;e<tu.length;e++)if(s[e]!==tu[e])return!1;return!0}const hU="tEXt",pU=0,Jw=new TextDecoder("latin1");function gU(s){if(xU(s),s.length===0||s.length>79)throw new Error("keyword length must be between 1 and 79")}const fU=/^[\u0000-\u00FF]*$/;function xU(s){if(!fU.test(s))throw new Error("invalid latin1 text")}function yU(s,e,r){const a=Yw(e);s[a]=bU(e,r-a.length-1)}function Yw(s){for(s.mark();s.readByte()!==pU;);const e=s.offset;s.reset();const r=Jw.decode(s.readBytes(e-s.offset-1));return s.skip(1),gU(r),r}function bU(s,e){return Jw.decode(s.readBytes(e))}const hn={UNKNOWN:-1,GREYSCALE:0,TRUECOLOUR:2,INDEXED_COLOUR:3,GREYSCALE_ALPHA:4,TRUECOLOUR_ALPHA:6},gh={UNKNOWN:-1,DEFLATE:0},Kx={UNKNOWN:-1,ADAPTIVE:0},fh={UNKNOWN:-1,NO_INTERLACE:0,ADAM7:1},Od={NONE:0,BACKGROUND:1,PREVIOUS:2},xh={SOURCE:0,OVER:1};class vU extends Yp{_checkCrc;_inflator;_png;_apng;_end;_hasPalette;_palette;_hasTransparency;_transparency;_compressionMethod;_filterMethod;_interlaceMethod;_colorType;_isAnimated;_numberOfFrames;_numberOfPlays;_frames;_writingDataChunks;constructor(e,r={}){super(e);const{checkCrc:a=!1}=r;this._checkCrc=a,this._inflator=new Qx,this._png={width:-1,height:-1,channels:-1,data:new Uint8Array(0),depth:1,text:{}},this._apng={width:-1,height:-1,channels:-1,depth:1,numberOfFrames:1,numberOfPlays:0,text:{},frames:[]},this._end=!1,this._hasPalette=!1,this._palette=[],this._hasTransparency=!1,this._transparency=new Uint16Array(0),this._compressionMethod=gh.UNKNOWN,this._filterMethod=Kx.UNKNOWN,this._interlaceMethod=fh.UNKNOWN,this._colorType=hn.UNKNOWN,this._isAnimated=!1,this._numberOfFrames=1,this._numberOfPlays=0,this._frames=[],this._writingDataChunks=!1,this.setBigEndian()}decode(){for($x(this);!this._end;){const e=this.readUint32(),r=this.readChars(4);this.decodeChunk(e,r)}return this.decodeImage(),this._png}decodeApng(){for($x(this);!this._end;){const e=this.readUint32(),r=this.readChars(4);this.decodeApngChunk(e,r)}return this.decodeApngImage(),this._apng}decodeChunk(e,r){const a=this.offset;switch(r){case"IHDR":this.decodeIHDR();break;case"PLTE":this.decodePLTE(e);break;case"IDAT":this.decodeIDAT(e);break;case"IEND":this._end=!0;break;case"tRNS":this.decodetRNS(e);break;case"iCCP":this.decodeiCCP(e);break;case hU:yU(this._png.text,this,e);break;case"pHYs":this.decodepHYs();break;default:this.skip(e);break}if(this.offset-a!==e)throw new Error(`Length mismatch while decoding chunk ${r}`);this._checkCrc?Hx(this,e+4,r):this.skip(4)}decodeApngChunk(e,r){const a=this.offset;switch(r!=="fdAT"&&r!=="IDAT"&&this._writingDataChunks&&this.pushDataToFrame(),r){case"acTL":this.decodeACTL();break;case"fcTL":this.decodeFCTL();break;case"fdAT":this.decodeFDAT(e);break;default:this.decodeChunk(e,r),this.offset=a+e;break}if(this.offset-a!==e)throw new Error(`Length mismatch while decoding chunk ${r}`);this._checkCrc?Hx(this,e+4,r):this.skip(4)}decodeIHDR(){const e=this._png;e.width=this.readUint32(),e.height=this.readUint32(),e.depth=wU(this.readUint8());const r=this.readUint8();this._colorType=r;let a;switch(r){case hn.GREYSCALE:a=1;break;case hn.TRUECOLOUR:a=3;break;case hn.INDEXED_COLOUR:a=1;break;case hn.GREYSCALE_ALPHA:a=2;break;case hn.TRUECOLOUR_ALPHA:a=4;break;case hn.UNKNOWN:default:throw new Error(`Unknown color type: ${r}`)}if(this._png.channels=a,this._compressionMethod=this.readUint8(),this._compressionMethod!==gh.DEFLATE)throw new Error(`Unsupported compression method: ${this._compressionMethod}`);this._filterMethod=this.readUint8(),this._interlaceMethod=this.readUint8()}decodeACTL(){this._numberOfFrames=this.readUint32(),this._numberOfPlays=this.readUint32(),this._isAnimated=!0}decodeFCTL(){const e={sequenceNumber:this.readUint32(),width:this.readUint32(),height:this.readUint32(),xOffset:this.readUint32(),yOffset:this.readUint32(),delayNumber:this.readUint16(),delayDenominator:this.readUint16(),disposeOp:this.readUint8(),blendOp:this.readUint8(),data:new Uint8Array(0)};this._frames.push(e)}decodePLTE(e){if(e%3!==0)throw new RangeError(`PLTE field length must be a multiple of 3. Got ${e}`);const r=e/3;this._hasPalette=!0;const a=[];this._palette=a;for(let n=0;n<r;n++)a.push([this.readUint8(),this.readUint8(),this.readUint8()])}decodeIDAT(e){this._writingDataChunks=!0;const r=e,a=this.offset+this.byteOffset;if(this._inflator.push(new Uint8Array(this.buffer,a,r)),this._inflator.err)throw new Error(`Error while decompressing the data: ${this._inflator.err}`);this.skip(e)}decodeFDAT(e){this._writingDataChunks=!0;let r=e,a=this.offset+this.byteOffset;if(a+=4,r-=4,this._inflator.push(new Uint8Array(this.buffer,a,r)),this._inflator.err)throw new Error(`Error while decompressing the data: ${this._inflator.err}`);this.skip(e)}decodetRNS(e){switch(this._colorType){case hn.GREYSCALE:case hn.TRUECOLOUR:{if(e%2!==0)throw new RangeError(`tRNS chunk length must be a multiple of 2. Got ${e}`);if(e/2>this._png.width*this._png.height)throw new Error(`tRNS chunk contains more alpha values than there are pixels (${e/2} vs ${this._png.width*this._png.height})`);this._hasTransparency=!0,this._transparency=new Uint16Array(e/2);for(let r=0;r<e/2;r++)this._transparency[r]=this.readUint16();break}case hn.INDEXED_COLOUR:{if(e>this._palette.length)throw new Error(`tRNS chunk contains more alpha values than there are palette colors (${e} vs ${this._palette.length})`);let r=0;for(;r<e;r++){const a=this.readByte();this._palette[r].push(a)}for(;r<this._palette.length;r++)this._palette[r].push(255);break}case hn.UNKNOWN:case hn.GREYSCALE_ALPHA:case hn.TRUECOLOUR_ALPHA:default:throw new Error(`tRNS chunk is not supported for color type ${this._colorType}`)}}decodeiCCP(e){const r=Yw(this),a=this.readUint8();if(a!==gh.DEFLATE)throw new Error(`Unsupported iCCP compression method: ${a}`);const n=this.readBytes(e-r.length-2);this._png.iccEmbeddedProfile={name:r,profile:XP(n)}}decodepHYs(){const e=this.readUint32(),r=this.readUint32(),a=this.readByte();this._png.resolution={x:e,y:r,unit:a}}decodeApngImage(){this._apng.width=this._png.width,this._apng.height=this._png.height,this._apng.channels=this._png.channels,this._apng.depth=this._png.depth,this._apng.numberOfFrames=this._numberOfFrames,this._apng.numberOfPlays=this._numberOfPlays,this._apng.text=this._png.text,this._apng.resolution=this._png.resolution;for(let e=0;e<this._numberOfFrames;e++){const r={sequenceNumber:this._frames[e].sequenceNumber,delayNumber:this._frames[e].delayNumber,delayDenominator:this._frames[e].delayDenominator,data:this._apng.depth===8?new Uint8Array(this._apng.width*this._apng.height*this._apng.channels):new Uint16Array(this._apng.width*this._apng.height*this._apng.channels)},a=this._frames.at(e);if(a){if(a.data=Vx({data:a.data,width:a.width,height:a.height,channels:this._apng.channels,depth:this._apng.depth}),this._hasPalette&&(this._apng.palette=this._palette),this._hasTransparency&&(this._apng.transparency=this._transparency),e===0||a.xOffset===0&&a.yOffset===0&&a.width===this._png.width&&a.height===this._png.height)r.data=a.data;else{const n=this._apng.frames.at(e-1);this.disposeFrame(a,n,r),this.addFrameDataToCanvas(r,a)}this._apng.frames.push(r)}}return this._apng}disposeFrame(e,r,a){switch(e.disposeOp){case Od.NONE:break;case Od.BACKGROUND:for(let n=0;n<this._png.height;n++)for(let i=0;i<this._png.width;i++){const o=(n*e.width+i)*this._png.channels;for(let l=0;l<this._png.channels;l++)a.data[o+l]=0}break;case Od.PREVIOUS:a.data.set(r.data);break;default:throw new Error("Unknown disposeOp")}}addFrameDataToCanvas(e,r){const a=1<<this._png.depth,n=(i,o)=>{const l=((i+r.yOffset)*this._png.width+r.xOffset+o)*this._png.channels,c=(i*r.width+o)*this._png.channels;return{index:l,frameIndex:c}};switch(r.blendOp){case xh.SOURCE:for(let i=0;i<r.height;i++)for(let o=0;o<r.width;o++){const{index:l,frameIndex:c}=n(i,o);for(let A=0;A<this._png.channels;A++)e.data[l+A]=r.data[c+A]}break;case xh.OVER:for(let i=0;i<r.height;i++)for(let o=0;o<r.width;o++){const{index:l,frameIndex:c}=n(i,o);for(let A=0;A<this._png.channels;A++){const d=r.data[c+this._png.channels-1]/a,h=A%(this._png.channels-1)===0?1:r.data[c+A],f=Math.floor(d*h+(1-d)*e.data[l+A]);e.data[l+A]+=f}}break;default:throw new Error("Unknown blendOp")}}decodeImage(){if(this._inflator.err)throw new Error(`Error while decompressing the data: ${this._inflator.err}`);const e=this._isAnimated?(this._frames?.at(0)).data:this._inflator.result;if(this._filterMethod!==Kx.ADAPTIVE)throw new Error(`Filter method ${this._filterMethod} not supported`);if(this._interlaceMethod===fh.NO_INTERLACE)this._png.data=Vx({data:e,width:this._png.width,height:this._png.height,channels:this._png.channels,depth:this._png.depth});else if(this._interlaceMethod===fh.ADAM7)this._png.data=iU({data:e,width:this._png.width,height:this._png.height,channels:this._png.channels,depth:this._png.depth});else throw new Error(`Interlace method ${this._interlaceMethod} not supported`);this._hasPalette&&(this._png.palette=this._palette),this._hasTransparency&&(this._png.transparency=this._transparency)}pushDataToFrame(){const e=this._inflator.result,r=this._frames.at(-1);r?r.data=e:this._frames.push({sequenceNumber:0,width:this._png.width,height:this._png.height,xOffset:0,yOffset:0,delayNumber:0,delayDenominator:0,disposeOp:Od.NONE,blendOp:xh.SOURCE,data:e}),this._inflator=new Qx,this._writingDataChunks=!1}}function wU(s){if(s!==1&&s!==2&&s!==4&&s!==8&&s!==16)throw new Error(`invalid bit depth: ${s}`);return s}var Gx;(function(s){s[s.UNKNOWN=0]="UNKNOWN",s[s.METRE=1]="METRE"})(Gx||(Gx={}));function CU(s,e){return new vU(s,e).decode()}var Wt=function(){return typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:this}();function yh(){Wt.console&&typeof Wt.console.log=="function"&&Wt.console.log.apply(Wt.console,arguments)}var Gs={log:yh,warn:function(s){Wt.console&&(typeof Wt.console.warn=="function"?Wt.console.warn.apply(Wt.console,arguments):yh.call(null,arguments))},error:function(s){Wt.console&&(typeof Wt.console.error=="function"?Wt.console.error.apply(Wt.console,arguments):yh(s))}};function bh(s,e,r){var a=new XMLHttpRequest;a.open("GET",s),a.responseType="blob",a.onload=function(){Vo(a.response,e,r)},a.onerror=function(){Gs.error("could not download file")},a.send()}function zx(s){var e=new XMLHttpRequest;e.open("HEAD",s,!1);try{e.send()}catch{}return e.status>=200&&e.status<=299}function Hd(s){try{s.dispatchEvent(new MouseEvent("click"))}catch{var e=document.createEvent("MouseEvents");e.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),s.dispatchEvent(e)}}var Vo=Wt.saveAs||((typeof window>"u"?"undefined":Rs(window))!=="object"||window!==Wt?function(){}:typeof HTMLAnchorElement<"u"&&"download"in HTMLAnchorElement.prototype?function(s,e,r){var a=Wt.URL||Wt.webkitURL,n=document.createElement("a");e=e||s.name||"download",n.download=e,n.rel="noopener",typeof s=="string"?(n.href=s,n.origin!==location.origin?zx(n.href)?bh(s,e,r):Hd(n,n.target="_blank"):Hd(n)):(n.href=a.createObjectURL(s),setTimeout(function(){a.revokeObjectURL(n.href)},4e4),setTimeout(function(){Hd(n)},0))}:"msSaveOrOpenBlob"in navigator?function(s,e,r){if(e=e||s.name||"download",typeof s=="string")if(zx(s))bh(s,e,r);else{var a=document.createElement("a");a.href=s,a.target="_blank",setTimeout(function(){Hd(a)})}else navigator.msSaveOrOpenBlob(function(n,i){return i===void 0?i={autoBom:!1}:Rs(i)!=="object"&&(Gs.warn("Deprecated: Expected third argument to be a object"),i={autoBom:!i}),i.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(n.type)?new Blob(["\uFEFF",n],{type:n.type}):n}(s,r),e)}:function(s,e,r,a){if((a=a||open("","_blank"))&&(a.document.title=a.document.body.innerText="downloading..."),typeof s=="string")return bh(s,e,r);var n=s.type==="application/octet-stream",i=/constructor/i.test(Wt.HTMLElement)||Wt.safari,o=/CriOS\/[\d]+/.test(navigator.userAgent);if((o||n&&i)&&(typeof FileReader>"u"?"undefined":Rs(FileReader))==="object"){var l=new FileReader;l.onloadend=function(){var d=l.result;d=o?d:d.replace(/^data:[^;]*;/,"data:attachment/file;"),a?a.location.href=d:location=d,a=null},l.readAsDataURL(s)}else{var c=Wt.URL||Wt.webkitURL,A=c.createObjectURL(s);a?a.location=A:location.href=A,a=null,setTimeout(function(){c.revokeObjectURL(A)},4e4)}});function Xw(s){var e;s=s||"",this.ok=!1,s.charAt(0)=="#"&&(s=s.substr(1,6)),s={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"}[s=(s=s.replace(/ /g,"")).toLowerCase()]||s;for(var r=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(l){return[parseInt(l[1]),parseInt(l[2]),parseInt(l[3])]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(l){return[parseInt(l[1],16),parseInt(l[2],16),parseInt(l[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(l){return[parseInt(l[1]+l[1],16),parseInt(l[2]+l[2],16),parseInt(l[3]+l[3],16)]}}],a=0;a<r.length;a++){var n=r[a].re,i=r[a].process,o=n.exec(s);o&&(e=i(o),this.r=e[0],this.g=e[1],this.b=e[2],this.ok=!0)}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r,this.g=this.g<0||isNaN(this.g)?0:this.g>255?255:this.g,this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b,this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"},this.toHex=function(){var l=this.r.toString(16),c=this.g.toString(16),A=this.b.toString(16);return l.length==1&&(l="0"+l),c.length==1&&(c="0"+c),A.length==1&&(A="0"+A),"#"+l+c+A}}var su=Wt.atob.bind(Wt),Wx=Wt.btoa.bind(Wt);function vh(s,e){var r=s[0],a=s[1],n=s[2],i=s[3];r=ya(r,a,n,i,e[0],7,-680876936),i=ya(i,r,a,n,e[1],12,-389564586),n=ya(n,i,r,a,e[2],17,606105819),a=ya(a,n,i,r,e[3],22,-1044525330),r=ya(r,a,n,i,e[4],7,-176418897),i=ya(i,r,a,n,e[5],12,1200080426),n=ya(n,i,r,a,e[6],17,-1473231341),a=ya(a,n,i,r,e[7],22,-45705983),r=ya(r,a,n,i,e[8],7,1770035416),i=ya(i,r,a,n,e[9],12,-1958414417),n=ya(n,i,r,a,e[10],17,-42063),a=ya(a,n,i,r,e[11],22,-1990404162),r=ya(r,a,n,i,e[12],7,1804603682),i=ya(i,r,a,n,e[13],12,-40341101),n=ya(n,i,r,a,e[14],17,-1502002290),r=ba(r,a=ya(a,n,i,r,e[15],22,1236535329),n,i,e[1],5,-165796510),i=ba(i,r,a,n,e[6],9,-1069501632),n=ba(n,i,r,a,e[11],14,643717713),a=ba(a,n,i,r,e[0],20,-373897302),r=ba(r,a,n,i,e[5],5,-701558691),i=ba(i,r,a,n,e[10],9,38016083),n=ba(n,i,r,a,e[15],14,-660478335),a=ba(a,n,i,r,e[4],20,-405537848),r=ba(r,a,n,i,e[9],5,568446438),i=ba(i,r,a,n,e[14],9,-1019803690),n=ba(n,i,r,a,e[3],14,-187363961),a=ba(a,n,i,r,e[8],20,1163531501),r=ba(r,a,n,i,e[13],5,-1444681467),i=ba(i,r,a,n,e[2],9,-51403784),n=ba(n,i,r,a,e[7],14,1735328473),r=va(r,a=ba(a,n,i,r,e[12],20,-1926607734),n,i,e[5],4,-378558),i=va(i,r,a,n,e[8],11,-2022574463),n=va(n,i,r,a,e[11],16,1839030562),a=va(a,n,i,r,e[14],23,-35309556),r=va(r,a,n,i,e[1],4,-1530992060),i=va(i,r,a,n,e[4],11,1272893353),n=va(n,i,r,a,e[7],16,-155497632),a=va(a,n,i,r,e[10],23,-1094730640),r=va(r,a,n,i,e[13],4,681279174),i=va(i,r,a,n,e[0],11,-358537222),n=va(n,i,r,a,e[3],16,-722521979),a=va(a,n,i,r,e[6],23,76029189),r=va(r,a,n,i,e[9],4,-640364487),i=va(i,r,a,n,e[12],11,-421815835),n=va(n,i,r,a,e[15],16,530742520),r=wa(r,a=va(a,n,i,r,e[2],23,-995338651),n,i,e[0],6,-198630844),i=wa(i,r,a,n,e[7],10,1126891415),n=wa(n,i,r,a,e[14],15,-1416354905),a=wa(a,n,i,r,e[5],21,-57434055),r=wa(r,a,n,i,e[12],6,1700485571),i=wa(i,r,a,n,e[3],10,-1894986606),n=wa(n,i,r,a,e[10],15,-1051523),a=wa(a,n,i,r,e[1],21,-2054922799),r=wa(r,a,n,i,e[8],6,1873313359),i=wa(i,r,a,n,e[15],10,-30611744),n=wa(n,i,r,a,e[6],15,-1560198380),a=wa(a,n,i,r,e[13],21,1309151649),r=wa(r,a,n,i,e[4],6,-145523070),i=wa(i,r,a,n,e[11],10,-1120210379),n=wa(n,i,r,a,e[2],15,718787259),a=wa(a,n,i,r,e[9],21,-343485551),s[0]=Io(r,s[0]),s[1]=Io(a,s[1]),s[2]=Io(n,s[2]),s[3]=Io(i,s[3])}function cm(s,e,r,a,n,i){return e=Io(Io(e,s),Io(a,i)),Io(e<<n|e>>>32-n,r)}function ya(s,e,r,a,n,i,o){return cm(e&r|~e&a,s,e,n,i,o)}function ba(s,e,r,a,n,i,o){return cm(e&a|r&~a,s,e,n,i,o)}function va(s,e,r,a,n,i,o){return cm(e^r^a,s,e,n,i,o)}function wa(s,e,r,a,n,i,o){return cm(r^(e|~a),s,e,n,i,o)}function Zw(s){var e,r=s.length,a=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=s.length;e+=64)vh(a,NU(s.substring(e-64,e)));s=s.substring(e-64);var n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<s.length;e++)n[e>>2]|=s.charCodeAt(e)<<(e%4<<3);if(n[e>>2]|=128<<(e%4<<3),e>55)for(vh(a,n),e=0;e<16;e++)n[e]=0;return n[14]=8*r,vh(a,n),a}function NU(s){var e,r=[];for(e=0;e<64;e+=4)r[e>>2]=s.charCodeAt(e)+(s.charCodeAt(e+1)<<8)+(s.charCodeAt(e+2)<<16)+(s.charCodeAt(e+3)<<24);return r}var qx="0123456789abcdef".split("");function BU(s){for(var e="",r=0;r<4;r++)e+=qx[s>>8*r+4&15]+qx[s>>8*r&15];return e}function SU(s){return String.fromCharCode(255&s,(65280&s)>>8,(16711680&s)>>16,(4278190080&s)>>24)}function gp(s){return Zw(s).map(SU).join("")}var jU=function(s){for(var e=0;e<s.length;e++)s[e]=BU(s[e]);return s.join("")}(Zw("hello"))!="5d41402abc4b2a76b9719d911017c592";function Io(s,e){if(jU){var r=(65535&s)+(65535&e);return(s>>16)+(e>>16)+(r>>16)<<16|65535&r}return s+e&4294967295}function fp(s,e){var r,a,n,i;if(s!==r){for(var o=(n=s,i=1+(256/s.length|0),new Array(i+1).join(n)),l=[],c=0;c<256;c++)l[c]=c;var A=0;for(c=0;c<256;c++){var d=l[c];A=(A+d+o.charCodeAt(c))%256,l[c]=l[A],l[A]=d}r=s,a=l}else l=a;var h=e.length,f=0,u=0,x="";for(c=0;c<h;c++)u=(u+(d=l[f=(f+1)%256]))%256,l[f]=l[u],l[u]=d,o=l[(l[f]+l[u])%256],x+=String.fromCharCode(e.charCodeAt(c)^o);return x}var Jx={print:4,modify:8,copy:16,"annot-forms":32};function Dl(s,e,r,a){this.v=1,this.r=2;var n=192;s.forEach(function(l){if(Jx.perm!==void 0)throw new Error("Invalid permission: "+l);n+=Jx[l]}),this.padding="(¬øN^Nu¬äAd\0NV√ø√∫\b..\0¬∂√êh>¬Ä/\f¬©√ædSiz";var i=(e+this.padding).substr(0,32),o=(r+this.padding).substr(0,32);this.O=this.processOwnerPassword(i,o),this.P=-(1+(255^n)),this.encryptionKey=gp(i+this.O+this.lsbFirstWord(this.P)+this.hexToBytes(a)).substr(0,5),this.U=fp(this.encryptionKey,this.padding)}function Rl(s){if(/[^\u0000-\u00ff]/.test(s))throw new Error("Invalid PDF Name Object: "+s+", Only accept ASCII characters.");for(var e="",r=s.length,a=0;a<r;a++){var n=s.charCodeAt(a);e+=n<33||n===35||n===37||n===40||n===41||n===47||n===60||n===62||n===91||n===93||n===123||n===125||n>126?"#"+("0"+n.toString(16)).slice(-2):s[a]}return e}function Yx(s){if(Rs(s)!=="object")throw new Error("Invalid Context passed to initialize PubSub (jsPDF-module)");var e={};this.subscribe=function(r,a,n){if(n=n||!1,typeof r!="string"||typeof a!="function"||typeof n!="boolean")throw new Error("Invalid arguments passed to PubSub.subscribe (jsPDF-module)");e.hasOwnProperty(r)||(e[r]={});var i=Math.random().toString(35);return e[r][i]=[a,!!n],i},this.unsubscribe=function(r){for(var a in e)if(e[a][r])return delete e[a][r],Object.keys(e[a]).length===0&&delete e[a],!0;return!1},this.publish=function(r){if(e.hasOwnProperty(r)){var a=Array.prototype.slice.call(arguments,1),n=[];for(var i in e[r]){var o=e[r][i];try{o[0].apply(s,a)}catch(l){Wt.console&&Gs.error("jsPDF PubSub Error",l.message,l)}o[1]&&n.push(i)}n.length&&n.forEach(this.unsubscribe)}},this.getTopics=function(){return e}}function Mu(s){if(!(this instanceof Mu))return new Mu(s);var e="opacity,stroke-opacity".split(",");for(var r in s)s.hasOwnProperty(r)&&e.indexOf(r)>=0&&(this[r]=s[r]);this.id="",this.objectNumber=-1}function e1(s,e){this.gState=s,this.matrix=e,this.id="",this.objectNumber=-1}function zo(s,e,r,a,n){if(!(this instanceof zo))return new zo(s,e,r,a,n);this.type=s==="axial"?2:3,this.coords=e,this.colors=r,e1.call(this,a,n)}function tc(s,e,r,a,n){if(!(this instanceof tc))return new tc(s,e,r,a,n);this.boundingBox=s,this.xStep=e,this.yStep=r,this.stream="",this.cloneIndex=0,e1.call(this,a,n)}function Dt(s){var e,r=typeof arguments[0]=="string"?arguments[0]:"p",a=arguments[1],n=arguments[2],i=arguments[3],o=[],l=1,c=16,A="S",d=null;Rs(s=s||{})==="object"&&(r=s.orientation,a=s.unit||a,n=s.format||n,i=s.compress||s.compressPdf||i,(d=s.encryption||null)!==null&&(d.userPassword=d.userPassword||"",d.ownerPassword=d.ownerPassword||"",d.userPermissions=d.userPermissions||[]),l=typeof s.userUnit=="number"?Math.abs(s.userUnit):1,s.precision!==void 0&&(e=s.precision),s.floatPrecision!==void 0&&(c=s.floatPrecision),A=s.defaultPathOperation||"S"),o=s.filters||(i===!0?["FlateEncode"]:o),a=a||"mm",r=(""+(r||"P")).toLowerCase();var h=s.putOnlyUsedFonts||!1,f={},u={internal:{},__private__:{}};u.__private__.PubSub=Yx;var x="1.3",b=u.__private__.getPdfVersion=function(){return x};u.__private__.setPdfVersion=function(g){x=g};var N={a0:[2383.94,3370.39],a1:[1683.78,2383.94],a2:[1190.55,1683.78],a3:[841.89,1190.55],a4:[595.28,841.89],a5:[419.53,595.28],a6:[297.64,419.53],a7:[209.76,297.64],a8:[147.4,209.76],a9:[104.88,147.4],a10:[73.7,104.88],b0:[2834.65,4008.19],b1:[2004.09,2834.65],b2:[1417.32,2004.09],b3:[1000.63,1417.32],b4:[708.66,1000.63],b5:[498.9,708.66],b6:[354.33,498.9],b7:[249.45,354.33],b8:[175.75,249.45],b9:[124.72,175.75],b10:[87.87,124.72],c0:[2599.37,3676.54],c1:[1836.85,2599.37],c2:[1298.27,1836.85],c3:[918.43,1298.27],c4:[649.13,918.43],c5:[459.21,649.13],c6:[323.15,459.21],c7:[229.61,323.15],c8:[161.57,229.61],c9:[113.39,161.57],c10:[79.37,113.39],dl:[311.81,623.62],letter:[612,792],"government-letter":[576,756],legal:[612,1008],"junior-legal":[576,360],ledger:[1224,792],tabloid:[792,1224],"credit-card":[153,243]};u.__private__.getPageFormats=function(){return N};var v=u.__private__.getPageFormat=function(g){return N[g]};n=n||"a4";var j="compat",I="advanced",C=j;function E(){this.saveGraphicsState(),re(new vt(Xe,0,0,-Xe,0,Ui()*Xe).toString()+" cm"),this.setFontSize(this.getFontSize()/Xe),A="n",C=I}function T(){this.restoreGraphicsState(),A="S",C=j}var Q=u.__private__.combineFontStyleAndFontWeight=function(g,B){if(g=="bold"&&B=="normal"||g=="bold"&&B==400||g=="normal"&&B=="italic"||g=="bold"&&B=="italic")throw new Error("Invalid Combination of fontweight and fontstyle");return B&&(g=B==400||B==="normal"?g==="italic"?"italic":"normal":B!=700&&B!=="bold"||g!=="normal"?(B==700?"bold":B)+""+g:"bold"),g};u.advancedAPI=function(g){var B=C===j;return B&&E.call(this),typeof g!="function"||(g(this),B&&T.call(this)),this},u.compatAPI=function(g){var B=C===I;return B&&T.call(this),typeof g!="function"||(g(this),B&&E.call(this)),this},u.isAdvancedAPI=function(){return C===I};var D,k=function(g){if(C!==I)throw new Error(g+" is only available in 'advanced' API mode. You need to call advancedAPI() first.")},R=u.roundToPrecision=u.__private__.roundToPrecision=function(g,B){var z=e||B;if(isNaN(g)||isNaN(z))throw new Error("Invalid argument passed to jsPDF.roundToPrecision");return g.toFixed(z).replace(/0+$/,"")};D=u.hpf=u.__private__.hpf=typeof c=="number"?function(g){if(isNaN(g))throw new Error("Invalid argument passed to jsPDF.hpf");return R(g,c)}:c==="smart"?function(g){if(isNaN(g))throw new Error("Invalid argument passed to jsPDF.hpf");return R(g,g>-1&&g<1?16:5)}:function(g){if(isNaN(g))throw new Error("Invalid argument passed to jsPDF.hpf");return R(g,16)};var w=u.f2=u.__private__.f2=function(g){if(isNaN(g))throw new Error("Invalid argument passed to jsPDF.f2");return R(g,2)},L=u.__private__.f3=function(g){if(isNaN(g))throw new Error("Invalid argument passed to jsPDF.f3");return R(g,3)},M=u.scale=u.__private__.scale=function(g){if(isNaN(g))throw new Error("Invalid argument passed to jsPDF.scale");return C===j?g*Xe:C===I?g:void 0},P=function(g){return M(function(B){return C===j?Ui()-B:C===I?B:void 0}(g))};u.__private__.setPrecision=u.setPrecision=function(g){typeof parseInt(g,10)=="number"&&(e=parseInt(g,10))};var K,$="00000000000000000000000000000000",O=u.__private__.getFileId=function(){return $},W=u.__private__.setFileId=function(g){return $=g!==void 0&&/^[a-fA-F0-9]{32}$/.test(g)?g.toUpperCase():$.split("").map(function(){return"ABCDEF0123456789".charAt(Math.floor(16*Math.random()))}).join(""),d!==null&&(_s=new Dl(d.userPermissions,d.userPassword,d.ownerPassword,$)),$};u.setFileId=function(g){return W(g),this},u.getFileId=function(){return O()};var ee=u.__private__.convertDateToPDFDate=function(g){var B=g.getTimezoneOffset(),z=B<0?"+":"-",J=Math.floor(Math.abs(B/60)),ne=Math.abs(B%60),ge=[z,Y(J),"'",Y(ne),"'"].join("");return["D:",g.getFullYear(),Y(g.getMonth()+1),Y(g.getDate()),Y(g.getHours()),Y(g.getMinutes()),Y(g.getSeconds()),ge].join("")},V=u.__private__.convertPDFDateToDate=function(g){var B=parseInt(g.substr(2,4),10),z=parseInt(g.substr(6,2),10)-1,J=parseInt(g.substr(8,2),10),ne=parseInt(g.substr(10,2),10),ge=parseInt(g.substr(12,2),10),je=parseInt(g.substr(14,2),10);return new Date(B,z,J,ne,ge,je,0)},q=u.__private__.setCreationDate=function(g){var B;if(g===void 0&&(g=new Date),g instanceof Date)B=ee(g);else{if(!/^D:(20[0-2][0-9]|203[0-7]|19[7-9][0-9])(0[0-9]|1[0-2])([0-2][0-9]|3[0-1])(0[0-9]|1[0-9]|2[0-3])(0[0-9]|[1-5][0-9])(0[0-9]|[1-5][0-9])(\+0[0-9]|\+1[0-4]|-0[0-9]|-1[0-1])'(0[0-9]|[1-5][0-9])'?$/.test(g))throw new Error("Invalid argument passed to jsPDF.setCreationDate");B=g}return K=B},S=u.__private__.getCreationDate=function(g){var B=K;return g==="jsDate"&&(B=V(K)),B};u.setCreationDate=function(g){return q(g),this},u.getCreationDate=function(g){return S(g)};var H,Y=u.__private__.padd2=function(g){return("0"+parseInt(g)).slice(-2)},te=u.__private__.padd2Hex=function(g){return("00"+(g=g.toString())).substr(g.length)},G=0,X=[],le=[],he=0,ve=[],ke=[],Le=!1,Be=le;u.__private__.setCustomOutputDestination=function(g){Le=!0,Be=g};var Re=function(g){Le||(Be=g)};u.__private__.resetCustomOutputDestination=function(){Le=!1,Be=le};var re=u.__private__.out=function(g){return g=g.toString(),he+=g.length+1,Be.push(g),Be},Me=u.__private__.write=function(g){return re(arguments.length===1?g.toString():Array.prototype.join.call(arguments," "))},Pe=u.__private__.getArrayBuffer=function(g){for(var B=g.length,z=new ArrayBuffer(B),J=new Uint8Array(z);B--;)J[B]=g.charCodeAt(B);return z},be=[["Helvetica","helvetica","normal","WinAnsiEncoding"],["Helvetica-Bold","helvetica","bold","WinAnsiEncoding"],["Helvetica-Oblique","helvetica","italic","WinAnsiEncoding"],["Helvetica-BoldOblique","helvetica","bolditalic","WinAnsiEncoding"],["Courier","courier","normal","WinAnsiEncoding"],["Courier-Bold","courier","bold","WinAnsiEncoding"],["Courier-Oblique","courier","italic","WinAnsiEncoding"],["Courier-BoldOblique","courier","bolditalic","WinAnsiEncoding"],["Times-Roman","times","normal","WinAnsiEncoding"],["Times-Bold","times","bold","WinAnsiEncoding"],["Times-Italic","times","italic","WinAnsiEncoding"],["Times-BoldItalic","times","bolditalic","WinAnsiEncoding"],["ZapfDingbats","zapfdingbats","normal",null],["Symbol","symbol","normal",null]];u.__private__.getStandardFonts=function(){return be};var ce=s.fontSize||16;u.__private__.setFontSize=u.setFontSize=function(g){return ce=C===I?g/Xe:g,this};var Ie,pe=u.__private__.getFontSize=u.getFontSize=function(){return C===j?ce:ce*Xe},fe=s.R2L||!1;u.__private__.setR2L=u.setR2L=function(g){return fe=g,this},u.__private__.getR2L=u.getR2L=function(){return fe};var we,de=u.__private__.setZoomMode=function(g){if(/^(?:\d+\.\d*|\d*\.\d+|\d+)%$/.test(g))Ie=g;else if(isNaN(g)){if([void 0,null,"fullwidth","fullheight","fullpage","original"].indexOf(g)===-1)throw new Error('zoom must be Integer (e.g. 2), a percentage Value (e.g. 300%) or fullwidth, fullheight, fullpage, original. "'+g+'" is not recognized.');Ie=g}else Ie=parseInt(g,10)};u.__private__.getZoomMode=function(){return Ie};var xe,Ne=u.__private__.setPageMode=function(g){if([void 0,null,"UseNone","UseOutlines","UseThumbs","FullScreen"].indexOf(g)==-1)throw new Error('Page mode must be one of UseNone, UseOutlines, UseThumbs, or FullScreen. "'+g+'" is not recognized.');we=g};u.__private__.getPageMode=function(){return we};var it=u.__private__.setLayoutMode=function(g){if([void 0,null,"continuous","single","twoleft","tworight","two"].indexOf(g)==-1)throw new Error('Layout mode must be one of continuous, single, twoleft, tworight. "'+g+'" is not recognized.');xe=g};u.__private__.getLayoutMode=function(){return xe},u.__private__.setDisplayMode=u.setDisplayMode=function(g,B,z){return de(g),it(B),Ne(z),this};var st={title:"",subject:"",author:"",keywords:"",creator:""};u.__private__.getDocumentProperty=function(g){if(Object.keys(st).indexOf(g)===-1)throw new Error("Invalid argument passed to jsPDF.getDocumentProperty");return st[g]},u.__private__.getDocumentProperties=function(){return st},u.__private__.setDocumentProperties=u.setProperties=u.setDocumentProperties=function(g){for(var B in st)st.hasOwnProperty(B)&&g[B]&&(st[B]=g[B]);return this},u.__private__.setDocumentProperty=function(g,B){if(Object.keys(st).indexOf(g)===-1)throw new Error("Invalid arguments passed to jsPDF.setDocumentProperty");return st[g]=B};var $e,Xe,Ze,ct,pt,dt={},xt={},Se=[],qe={},ut={},Ge={},rt={},Tt=null,At=0,mt=[],Qt=new Yx(u),ts=s.hotfixes||[],Yt={},Ht={},Es=[],vt=function g(B,z,J,ne,ge,je){if(!(this instanceof g))return new g(B,z,J,ne,ge,je);isNaN(B)&&(B=1),isNaN(z)&&(z=0),isNaN(J)&&(J=0),isNaN(ne)&&(ne=1),isNaN(ge)&&(ge=0),isNaN(je)&&(je=0),this._matrix=[B,z,J,ne,ge,je]};Object.defineProperty(vt.prototype,"sx",{get:function(){return this._matrix[0]},set:function(g){this._matrix[0]=g}}),Object.defineProperty(vt.prototype,"shy",{get:function(){return this._matrix[1]},set:function(g){this._matrix[1]=g}}),Object.defineProperty(vt.prototype,"shx",{get:function(){return this._matrix[2]},set:function(g){this._matrix[2]=g}}),Object.defineProperty(vt.prototype,"sy",{get:function(){return this._matrix[3]},set:function(g){this._matrix[3]=g}}),Object.defineProperty(vt.prototype,"tx",{get:function(){return this._matrix[4]},set:function(g){this._matrix[4]=g}}),Object.defineProperty(vt.prototype,"ty",{get:function(){return this._matrix[5]},set:function(g){this._matrix[5]=g}}),Object.defineProperty(vt.prototype,"a",{get:function(){return this._matrix[0]},set:function(g){this._matrix[0]=g}}),Object.defineProperty(vt.prototype,"b",{get:function(){return this._matrix[1]},set:function(g){this._matrix[1]=g}}),Object.defineProperty(vt.prototype,"c",{get:function(){return this._matrix[2]},set:function(g){this._matrix[2]=g}}),Object.defineProperty(vt.prototype,"d",{get:function(){return this._matrix[3]},set:function(g){this._matrix[3]=g}}),Object.defineProperty(vt.prototype,"e",{get:function(){return this._matrix[4]},set:function(g){this._matrix[4]=g}}),Object.defineProperty(vt.prototype,"f",{get:function(){return this._matrix[5]},set:function(g){this._matrix[5]=g}}),Object.defineProperty(vt.prototype,"rotation",{get:function(){return Math.atan2(this.shx,this.sx)}}),Object.defineProperty(vt.prototype,"scaleX",{get:function(){return this.decompose().scale.sx}}),Object.defineProperty(vt.prototype,"scaleY",{get:function(){return this.decompose().scale.sy}}),Object.defineProperty(vt.prototype,"isIdentity",{get:function(){return this.sx===1&&this.shy===0&&this.shx===0&&this.sy===1&&this.tx===0&&this.ty===0}}),vt.prototype.join=function(g){return[this.sx,this.shy,this.shx,this.sy,this.tx,this.ty].map(D).join(g)},vt.prototype.multiply=function(g){var B=g.sx*this.sx+g.shy*this.shx,z=g.sx*this.shy+g.shy*this.sy,J=g.shx*this.sx+g.sy*this.shx,ne=g.shx*this.shy+g.sy*this.sy,ge=g.tx*this.sx+g.ty*this.shx+this.tx,je=g.tx*this.shy+g.ty*this.sy+this.ty;return new vt(B,z,J,ne,ge,je)},vt.prototype.decompose=function(){var g=this.sx,B=this.shy,z=this.shx,J=this.sy,ne=this.tx,ge=this.ty,je=Math.sqrt(g*g+B*B),Te=(g/=je)*z+(B/=je)*J;z-=g*Te,J-=B*Te;var Oe=Math.sqrt(z*z+J*J);return Te/=Oe,g*(J/=Oe)<B*(z/=Oe)&&(g=-g,B=-B,Te=-Te,je=-je),{scale:new vt(je,0,0,Oe,0,0),translate:new vt(1,0,0,1,ne,ge),rotate:new vt(g,B,-B,g,0,0),skew:new vt(1,0,Te,1,0,0)}},vt.prototype.toString=function(g){return this.join(" ")},vt.prototype.inversed=function(){var g=this.sx,B=this.shy,z=this.shx,J=this.sy,ne=this.tx,ge=this.ty,je=1/(g*J-B*z),Te=J*je,Oe=-B*je,We=-z*je,at=g*je;return new vt(Te,Oe,We,at,-Te*ne-We*ge,-Oe*ne-at*ge)},vt.prototype.applyToPoint=function(g){var B=g.x*this.sx+g.y*this.shx+this.tx,z=g.x*this.shy+g.y*this.sy+this.ty;return new bn(B,z)},vt.prototype.applyToRectangle=function(g){var B=this.applyToPoint(g),z=this.applyToPoint(new bn(g.x+g.w,g.y+g.h));return new Xi(B.x,B.y,z.x-B.x,z.y-B.y)},vt.prototype.clone=function(){var g=this.sx,B=this.shy,z=this.shx,J=this.sy,ne=this.tx,ge=this.ty;return new vt(g,B,z,J,ne,ge)},u.Matrix=vt;var Ft=u.matrixMult=function(g,B){return B.multiply(g)},Hs=new vt(1,0,0,1,0,0);u.unitMatrix=u.identityMatrix=Hs;var ks=function(g,B){if(!ut[g]){var z=(B instanceof zo?"Sh":"P")+(Object.keys(qe).length+1).toString(10);B.id=z,ut[g]=z,qe[z]=B,Qt.publish("addPattern",B)}};u.ShadingPattern=zo,u.TilingPattern=tc,u.addShadingPattern=function(g,B){return k("addShadingPattern()"),ks(g,B),this},u.beginTilingPattern=function(g){k("beginTilingPattern()"),li(g.boundingBox[0],g.boundingBox[1],g.boundingBox[2]-g.boundingBox[0],g.boundingBox[3]-g.boundingBox[1],g.matrix)},u.endTilingPattern=function(g,B){k("endTilingPattern()"),B.stream=ke[H].join(`
`),ks(g,B),Qt.publish("endTilingPattern",B),Es.pop().restore()};var Is,Nt=u.__private__.newObject=function(){var g=gs();return Vt(g,!0),g},gs=u.__private__.newObjectDeferred=function(){return G++,X[G]=function(){return he},G},Vt=function(g,B){return B=typeof B=="boolean"&&B,X[g]=he,B&&re(g+" 0 obj"),g},Kr=u.__private__.newAdditionalObject=function(){var g={objId:gs(),content:""};return ve.push(g),g},Kt=gs(),Js=gs(),fs=u.__private__.decodeColorString=function(g){var B=g.split(" ");if(B.length!==2||B[1]!=="g"&&B[1]!=="G")B.length!==5||B[4]!=="k"&&B[4]!=="K"||(B=[(1-B[0])*(1-B[3]),(1-B[1])*(1-B[3]),(1-B[2])*(1-B[3]),"r"]);else{var z=parseFloat(B[0]);B=[z,z,z,"r"]}for(var J="#",ne=0;ne<3;ne++)J+=("0"+Math.floor(255*parseFloat(B[ne])).toString(16)).slice(-2);return J},Zs=u.__private__.encodeColorString=function(g){var B;typeof g=="string"&&(g={ch1:g});var z=g.ch1,J=g.ch2,ne=g.ch3,ge=g.ch4,je=g.pdfColorType==="draw"?["G","RG","K"]:["g","rg","k"];if(typeof z=="string"&&z.charAt(0)!=="#"){var Te=new Xw(z);if(Te.ok)z=Te.toHex();else if(!/^\d*\.?\d*$/.test(z))throw new Error('Invalid color "'+z+'" passed to jsPDF.encodeColorString.')}if(typeof z=="string"&&/^#[0-9A-Fa-f]{3}$/.test(z)&&(z="#"+z[1]+z[1]+z[2]+z[2]+z[3]+z[3]),typeof z=="string"&&/^#[0-9A-Fa-f]{6}$/.test(z)){var Oe=parseInt(z.substr(1),16);z=Oe>>16&255,J=Oe>>8&255,ne=255&Oe}if(J===void 0||ge===void 0&&z===J&&J===ne)B=typeof z=="string"?z+" "+je[0]:g.precision===2?w(z/255)+" "+je[0]:L(z/255)+" "+je[0];else if(ge===void 0||Rs(ge)==="object"){if(ge&&!isNaN(ge.a)&&ge.a===0)return["1.","1.","1.",je[1]].join(" ");B=typeof z=="string"?[z,J,ne,je[1]].join(" "):g.precision===2?[w(z/255),w(J/255),w(ne/255),je[1]].join(" "):[L(z/255),L(J/255),L(ne/255),je[1]].join(" ")}else B=typeof z=="string"?[z,J,ne,ge,je[2]].join(" "):g.precision===2?[w(z),w(J),w(ne),w(ge),je[2]].join(" "):[L(z),L(J),L(ne),L(ge),je[2]].join(" ");return B},Ot=u.__private__.getFilters=function(){return o},qt=u.__private__.putStream=function(g){var B=(g=g||{}).data||"",z=g.filters||Ot(),J=g.alreadyAppliedFilters||[],ne=g.addLength1||!1,ge=B.length,je=g.objectId,Te=function(cs){return cs};if(d!==null&&je===void 0)throw new Error("ObjectId must be passed to putStream for file encryption");d!==null&&(Te=_s.encryptor(je,0));var Oe={};z===!0&&(z=["FlateEncode"]);var We=g.additionalKeyValues||[],at=(Oe=Dt.API.processDataByFilters!==void 0?Dt.API.processDataByFilters(B,z):{data:B,reverseChain:[]}).reverseChain+(Array.isArray(J)?J.join(" "):J.toString());if(Oe.data.length!==0&&(We.push({key:"Length",value:Oe.data.length}),ne===!0&&We.push({key:"Length1",value:ge})),at.length!=0)if(at.split("/").length-1==1)We.push({key:"Filter",value:at});else{We.push({key:"Filter",value:"["+at+"]"});for(var et=0;et<We.length;et+=1)if(We[et].key==="DecodeParms"){for(var Bt=[],It=0;It<Oe.reverseChain.split("/").length-1;It+=1)Bt.push("null");Bt.push(We[et].value),We[et].value="["+Bt.join(" ")+"]"}}re("<<");for(var ft=0;ft<We.length;ft++)re("/"+We[ft].key+" "+We[ft].value);re(">>"),Oe.data.length!==0&&(re("stream"),re(Te(Oe.data)),re("endstream"))},ur=u.__private__.putPage=function(g){var B=g.number,z=g.data,J=g.objId,ne=g.contentsObjId;Vt(J,!0),re("<</Type /Page"),re("/Parent "+g.rootDictionaryObjId+" 0 R"),re("/Resources "+g.resourceDictionaryObjId+" 0 R"),re("/MediaBox ["+parseFloat(D(g.mediaBox.bottomLeftX))+" "+parseFloat(D(g.mediaBox.bottomLeftY))+" "+D(g.mediaBox.topRightX)+" "+D(g.mediaBox.topRightY)+"]"),g.cropBox!==null&&re("/CropBox ["+D(g.cropBox.bottomLeftX)+" "+D(g.cropBox.bottomLeftY)+" "+D(g.cropBox.topRightX)+" "+D(g.cropBox.topRightY)+"]"),g.bleedBox!==null&&re("/BleedBox ["+D(g.bleedBox.bottomLeftX)+" "+D(g.bleedBox.bottomLeftY)+" "+D(g.bleedBox.topRightX)+" "+D(g.bleedBox.topRightY)+"]"),g.trimBox!==null&&re("/TrimBox ["+D(g.trimBox.bottomLeftX)+" "+D(g.trimBox.bottomLeftY)+" "+D(g.trimBox.topRightX)+" "+D(g.trimBox.topRightY)+"]"),g.artBox!==null&&re("/ArtBox ["+D(g.artBox.bottomLeftX)+" "+D(g.artBox.bottomLeftY)+" "+D(g.artBox.topRightX)+" "+D(g.artBox.topRightY)+"]"),typeof g.userUnit=="number"&&g.userUnit!==1&&re("/UserUnit "+g.userUnit),Qt.publish("putPage",{objId:J,pageContext:mt[B],pageNumber:B,page:z}),re("/Contents "+ne+" 0 R"),re(">>"),re("endobj");var ge=z.join(`
`);return C===I&&(ge+=`
Q`),Vt(ne,!0),qt({data:ge,filters:Ot(),objectId:ne}),re("endobj"),J},kr=u.__private__.putPages=function(){var g,B,z=[];for(g=1;g<=At;g++)mt[g].objId=gs(),mt[g].contentsObjId=gs();for(g=1;g<=At;g++)z.push(ur({number:g,data:ke[g],objId:mt[g].objId,contentsObjId:mt[g].contentsObjId,mediaBox:mt[g].mediaBox,cropBox:mt[g].cropBox,bleedBox:mt[g].bleedBox,trimBox:mt[g].trimBox,artBox:mt[g].artBox,userUnit:mt[g].userUnit,rootDictionaryObjId:Kt,resourceDictionaryObjId:Js}));Vt(Kt,!0),re("<</Type /Pages");var J="/Kids [";for(B=0;B<At;B++)J+=z[B]+" 0 R ";re(J+"]"),re("/Count "+At),re(">>"),re("endobj"),Qt.publish("postPutPages")},Zr=function(g){Qt.publish("putFont",{font:g,out:re,newObject:Nt,putStream:qt}),g.isAlreadyPutted!==!0&&(g.objectNumber=Nt(),re("<<"),re("/Type /Font"),re("/BaseFont /"+Rl(g.postScriptName)),re("/Subtype /Type1"),typeof g.encoding=="string"&&re("/Encoding /"+g.encoding),re("/FirstChar 32"),re("/LastChar 255"),re(">>"),re("endobj"))},Qa=function(g){g.objectNumber=Nt();var B=[];B.push({key:"Type",value:"/XObject"}),B.push({key:"Subtype",value:"/Form"}),B.push({key:"BBox",value:"["+[D(g.x),D(g.y),D(g.x+g.width),D(g.y+g.height)].join(" ")+"]"}),B.push({key:"Matrix",value:"["+g.matrix.toString()+"]"});var z=g.pages[1].join(`
`);qt({data:z,additionalKeyValues:B,objectId:g.objectNumber}),re("endobj")},Oa=function(g,B){B||(B=21);var z=Nt(),J=function(je,Te){var Oe,We=[],at=1/(Te-1);for(Oe=0;Oe<1;Oe+=at)We.push(Oe);if(We.push(1),je[0].offset!=0){var et={offset:0,color:je[0].color};je.unshift(et)}if(je[je.length-1].offset!=1){var Bt={offset:1,color:je[je.length-1].color};je.push(Bt)}for(var It="",ft=0,cs=0;cs<We.length;cs++){for(Oe=We[cs];Oe>je[ft+1].offset;)ft++;var As=je[ft].offset,Fs=(Oe-As)/(je[ft+1].offset-As),za=je[ft].color,xs=je[ft+1].color;It+=te(Math.round((1-Fs)*za[0]+Fs*xs[0]).toString(16))+te(Math.round((1-Fs)*za[1]+Fs*xs[1]).toString(16))+te(Math.round((1-Fs)*za[2]+Fs*xs[2]).toString(16))}return It.trim()}(g.colors,B),ne=[];ne.push({key:"FunctionType",value:"0"}),ne.push({key:"Domain",value:"[0.0 1.0]"}),ne.push({key:"Size",value:"["+B+"]"}),ne.push({key:"BitsPerSample",value:"8"}),ne.push({key:"Range",value:"[0.0 1.0 0.0 1.0 0.0 1.0]"}),ne.push({key:"Decode",value:"[0.0 1.0 0.0 1.0 0.0 1.0]"}),qt({data:J,additionalKeyValues:ne,alreadyAppliedFilters:["/ASCIIHexDecode"],objectId:z}),re("endobj"),g.objectNumber=Nt(),re("<< /ShadingType "+g.type),re("/ColorSpace /DeviceRGB");var ge="/Coords ["+D(parseFloat(g.coords[0]))+" "+D(parseFloat(g.coords[1]))+" ";g.type===2?ge+=D(parseFloat(g.coords[2]))+" "+D(parseFloat(g.coords[3])):ge+=D(parseFloat(g.coords[2]))+" "+D(parseFloat(g.coords[3]))+" "+D(parseFloat(g.coords[4]))+" "+D(parseFloat(g.coords[5])),re(ge+="]"),g.matrix&&re("/Matrix ["+g.matrix.toString()+"]"),re("/Function "+z+" 0 R"),re("/Extend [true true]"),re(">>"),re("endobj")},tn=function(g,B){var z=gs(),J=Nt();B.push({resourcesOid:z,objectOid:J}),g.objectNumber=J;var ne=[];ne.push({key:"Type",value:"/Pattern"}),ne.push({key:"PatternType",value:"1"}),ne.push({key:"PaintType",value:"1"}),ne.push({key:"TilingType",value:"1"}),ne.push({key:"BBox",value:"["+g.boundingBox.map(D).join(" ")+"]"}),ne.push({key:"XStep",value:D(g.xStep)}),ne.push({key:"YStep",value:D(g.yStep)}),ne.push({key:"Resources",value:z+" 0 R"}),g.matrix&&ne.push({key:"Matrix",value:"["+g.matrix.toString()+"]"}),qt({data:g.stream,additionalKeyValues:ne,objectId:g.objectNumber}),re("endobj")},Ha=function(g){for(var B in g.objectNumber=Nt(),re("<<"),g)switch(B){case"opacity":re("/ca "+w(g[B]));break;case"stroke-opacity":re("/CA "+w(g[B]))}re(">>"),re("endobj")},sn=function(g){Vt(g.resourcesOid,!0),re("<<"),re("/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]"),function(){for(var B in re("/Font <<"),dt)dt.hasOwnProperty(B)&&(h===!1||h===!0&&f.hasOwnProperty(B))&&re("/"+B+" "+dt[B].objectNumber+" 0 R");re(">>")}(),function(){if(Object.keys(qe).length>0){for(var B in re("/Shading <<"),qe)qe.hasOwnProperty(B)&&qe[B]instanceof zo&&qe[B].objectNumber>=0&&re("/"+B+" "+qe[B].objectNumber+" 0 R");Qt.publish("putShadingPatternDict"),re(">>")}}(),function(B){if(Object.keys(qe).length>0){for(var z in re("/Pattern <<"),qe)qe.hasOwnProperty(z)&&qe[z]instanceof u.TilingPattern&&qe[z].objectNumber>=0&&qe[z].objectNumber<B&&re("/"+z+" "+qe[z].objectNumber+" 0 R");Qt.publish("putTilingPatternDict"),re(">>")}}(g.objectOid),function(){if(Object.keys(Ge).length>0){var B;for(B in re("/ExtGState <<"),Ge)Ge.hasOwnProperty(B)&&Ge[B].objectNumber>=0&&re("/"+B+" "+Ge[B].objectNumber+" 0 R");Qt.publish("putGStateDict"),re(">>")}}(),function(){for(var B in re("/XObject <<"),Yt)Yt.hasOwnProperty(B)&&Yt[B].objectNumber>=0&&re("/"+B+" "+Yt[B].objectNumber+" 0 R");Qt.publish("putXobjectDict"),re(">>")}(),re(">>"),re("endobj")},Mn=function(g){xt[g.fontName]=xt[g.fontName]||{},xt[g.fontName][g.fontStyle]=g.id},lr=function(g,B,z,J,ne){var ge={id:"F"+(Object.keys(dt).length+1).toString(10),postScriptName:g,fontName:B,fontStyle:z,encoding:J,isStandardFont:ne||!1,metadata:{}};return Qt.publish("addFont",{font:ge,instance:this}),dt[ge.id]=ge,Mn(ge),ge.id},os=u.__private__.pdfEscape=u.pdfEscape=function(g,B){return function(z,J){var ne,ge,je,Te,Oe,We,at,et,Bt;if(je=(J=J||{}).sourceEncoding||"Unicode",Oe=J.outputEncoding,(J.autoencode||Oe)&&dt[$e].metadata&&dt[$e].metadata[je]&&dt[$e].metadata[je].encoding&&(Te=dt[$e].metadata[je].encoding,!Oe&&dt[$e].encoding&&(Oe=dt[$e].encoding),!Oe&&Te.codePages&&(Oe=Te.codePages[0]),typeof Oe=="string"&&(Oe=Te[Oe]),Oe)){for(at=!1,We=[],ne=0,ge=z.length;ne<ge;ne++)(et=Oe[z.charCodeAt(ne)])?We.push(String.fromCharCode(et)):We.push(z[ne]),We[ne].charCodeAt(0)>>8&&(at=!0);z=We.join("")}for(ne=z.length;at===void 0&&ne!==0;)z.charCodeAt(ne-1)>>8&&(at=!0),ne--;if(!at)return z;for(We=J.noBOM?[]:[254,255],ne=0,ge=z.length;ne<ge;ne++){if((Bt=(et=z.charCodeAt(ne))>>8)>>8)throw new Error("Character at position "+ne+" of string '"+z+"' exceeds 16bits. Cannot be encoded into UCS-2 BE");We.push(Bt),We.push(et-(Bt<<8))}return String.fromCharCode.apply(void 0,We)}(g,B).replace(/\\/g,"\\\\").replace(/\(/g,"\\(").replace(/\)/g,"\\)")},ua=u.__private__.beginPage=function(g){ke[++At]=[],mt[At]={objId:0,contentsObjId:0,userUnit:Number(l),artBox:null,bleedBox:null,cropBox:null,trimBox:null,mediaBox:{bottomLeftX:0,bottomLeftY:0,topRightX:Number(g[0]),topRightY:Number(g[1])}},Qn(At),Re(ke[H])},_n=function(g,B){var z,J,ne;switch(r=B||r,typeof g=="string"&&(z=v(g.toLowerCase()),Array.isArray(z)&&(J=z[0],ne=z[1])),Array.isArray(g)&&(J=g[0]*Xe,ne=g[1]*Xe),isNaN(J)&&(J=n[0],ne=n[1]),(J>14400||ne>14400)&&(Gs.warn("A page in a PDF can not be wider or taller than 14400 userUnit. jsPDF limits the width/height to 14400"),J=Math.min(14400,J),ne=Math.min(14400,ne)),n=[J,ne],r.substr(0,1)){case"l":ne>J&&(n=[ne,J]);break;case"p":J>ne&&(n=[ne,J])}ua(n),kt(ot),re(sa),Pi!==0&&re(Pi+" J"),Yi!==0&&re(Yi+" j"),Qt.publish("addPage",{pageNumber:At})},Va=function(g){g>0&&g<=At&&(ke.splice(g,1),mt.splice(g,1),At--,H>At&&(H=At),this.setPage(H))},Qn=function(g){g>0&&g<=At&&(H=g)},rn=u.__private__.getNumberOfPages=u.getNumberOfPages=function(){return ke.length-1},an=function(g,B,z){var J,ne=void 0;return z=z||{},g=g!==void 0?g:dt[$e].fontName,B=B!==void 0?B:dt[$e].fontStyle,J=g.toLowerCase(),xt[J]!==void 0&&xt[J][B]!==void 0?ne=xt[J][B]:xt[g]!==void 0&&xt[g][B]!==void 0?ne=xt[g][B]:z.disableWarning===!1&&Gs.warn("Unable to look up font label for font '"+g+"', '"+B+"'. Refer to getFontList() for available fonts."),ne||z.noFallback||(ne=xt.times[B])==null&&(ne=xt.times.normal),ne},Gr=u.__private__.putInfo=function(){var g=Nt(),B=function(J){return J};for(var z in d!==null&&(B=_s.encryptor(g,0)),re("<<"),re("/Producer ("+os(B("jsPDF "+Dt.version))+")"),st)st.hasOwnProperty(z)&&st[z]&&re("/"+z.substr(0,1).toUpperCase()+z.substr(1)+" ("+os(B(st[z]))+")");re("/CreationDate ("+os(B(K))+")"),re(">>"),re("endobj")},ea=u.__private__.putCatalog=function(g){var B=(g=g||{}).rootDictionaryObjId||Kt;switch(Nt(),re("<<"),re("/Type /Catalog"),re("/Pages "+B+" 0 R"),Ie||(Ie="fullwidth"),Ie){case"fullwidth":re("/OpenAction [3 0 R /FitH null]");break;case"fullheight":re("/OpenAction [3 0 R /FitV null]");break;case"fullpage":re("/OpenAction [3 0 R /Fit]");break;case"original":re("/OpenAction [3 0 R /XYZ null null 1]");break;default:var z=""+Ie;z.substr(z.length-1)==="%"&&(Ie=parseInt(Ie)/100),typeof Ie=="number"&&re("/OpenAction [3 0 R /XYZ null null "+w(Ie)+"]")}switch(xe||(xe="continuous"),xe){case"continuous":re("/PageLayout /OneColumn");break;case"single":re("/PageLayout /SinglePage");break;case"two":case"twoleft":re("/PageLayout /TwoColumnLeft");break;case"tworight":re("/PageLayout /TwoColumnRight")}we&&re("/PageMode /"+we),Qt.publish("putCatalog"),re(">>"),re("endobj")},mr=u.__private__.putTrailer=function(){re("trailer"),re("<<"),re("/Size "+(G+1)),re("/Root "+G+" 0 R"),re("/Info "+(G-1)+" 0 R"),d!==null&&re("/Encrypt "+_s.oid+" 0 R"),re("/ID [ <"+$+"> <"+$+"> ]"),re(">>")},Ts=u.__private__.putHeader=function(){re("%PDF-"+x),re("%¬∫√ü¬¨√†")},On=u.__private__.putXRef=function(){var g="0000000000";re("xref"),re("0 "+(G+1)),re("0000000000 65535 f ");for(var B=1;B<=G;B++)typeof X[B]=="function"?re((g+X[B]()).slice(-10)+" 00000 n "):X[B]!==void 0?re((g+X[B]).slice(-10)+" 00000 n "):re("0000000000 00000 n ")},Ur=u.__private__.buildDocument=function(){var g;G=0,he=0,le=[],X=[],ve=[],Kt=gs(),Js=gs(),Re(le),Qt.publish("buildDocument"),Ts(),kr(),function(){Qt.publish("putAdditionalObjects");for(var z=0;z<ve.length;z++){var J=ve[z];Vt(J.objId,!0),re(J.content),re("endobj")}Qt.publish("postPutAdditionalObjects")}(),g=[],function(){for(var z in dt)dt.hasOwnProperty(z)&&(h===!1||h===!0&&f.hasOwnProperty(z))&&Zr(dt[z])}(),function(){var z;for(z in Ge)Ge.hasOwnProperty(z)&&Ha(Ge[z])}(),function(){for(var z in Yt)Yt.hasOwnProperty(z)&&Qa(Yt[z])}(),function(z){var J;for(J in qe)qe.hasOwnProperty(J)&&(qe[J]instanceof zo?Oa(qe[J]):qe[J]instanceof tc&&tn(qe[J],z))}(g),Qt.publish("putResources"),g.forEach(sn),sn({resourcesOid:Js,objectOid:Number.MAX_SAFE_INTEGER}),Qt.publish("postPutResources"),d!==null&&(_s.oid=Nt(),re("<<"),re("/Filter /Standard"),re("/V "+_s.v),re("/R "+_s.r),re("/U <"+_s.toHexString(_s.U)+">"),re("/O <"+_s.toHexString(_s.O)+">"),re("/P "+_s.P),re(">>"),re("endobj")),Gr(),ea();var B=he;return On(),mr(),re("startxref"),re(""+B),re("%%EOF"),Re(ke[H]),le.join(`
`)},zr=u.__private__.getBlob=function(g){return new Blob([Pe(g)],{type:"application/pdf"})},er=u.output=u.__private__.output=(Is=function(g,B){switch(typeof(B=B||{})=="string"?B={filename:B}:B.filename=B.filename||"generated.pdf",g){case void 0:return Ur();case"save":u.save(B.filename);break;case"arraybuffer":return Pe(Ur());case"blob":return zr(Ur());case"bloburi":case"bloburl":if(Wt.URL!==void 0&&typeof Wt.URL.createObjectURL=="function")return Wt.URL&&Wt.URL.createObjectURL(zr(Ur()))||void 0;Gs.warn("bloburl is not supported by your system, because URL.createObjectURL is not supported by your browser.");break;case"datauristring":case"dataurlstring":var z="",J=Ur();try{z=Wx(J)}catch{z=Wx(unescape(encodeURIComponent(J)))}return"data:application/pdf;filename="+B.filename+";base64,"+z;case"pdfobjectnewwindow":if(Object.prototype.toString.call(Wt)==="[object Window]"){var ne="https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.1.1/pdfobject.min.js",ge=' integrity="sha512-4ze/a9/4jqu+tX9dfOqJYSvyYd5M6qum/3HpCLr+/Jqf0whc37VUbkpNGHR7/8pSnCFw47T1fmIpwBV7UySh3g==" crossorigin="anonymous"';B.pdfObjectUrl&&(ne=B.pdfObjectUrl,ge="");var je='<html><style>html, body { padding: 0; margin: 0; } iframe { width: 100%; height: 100%; border: 0;}  </style><body><script src="'+ne+'"'+ge+'><\/script><script >PDFObject.embed("'+this.output("dataurlstring")+'", '+JSON.stringify(B)+");<\/script></body></html>",Te=Wt.open();return Te!==null&&Te.document.write(je),Te}throw new Error("The option pdfobjectnewwindow just works in a browser-environment.");case"pdfjsnewwindow":if(Object.prototype.toString.call(Wt)==="[object Window]"){var Oe='<html><style>html, body { padding: 0; margin: 0; } iframe { width: 100%; height: 100%; border: 0;}  </style><body><iframe id="pdfViewer" src="'+(B.pdfJsUrl||"examples/PDF.js/web/viewer.html")+"?file=&downloadName="+B.filename+'" width="500px" height="400px" /></body></html>',We=Wt.open();if(We!==null){We.document.write(Oe);var at=this;We.document.documentElement.querySelector("#pdfViewer").onload=function(){We.document.title=B.filename,We.document.documentElement.querySelector("#pdfViewer").contentWindow.PDFViewerApplication.open(at.output("bloburl"))}}return We}throw new Error("The option pdfjsnewwindow just works in a browser-environment.");case"dataurlnewwindow":if(Object.prototype.toString.call(Wt)!=="[object Window]")throw new Error("The option dataurlnewwindow just works in a browser-environment.");var et='<html><style>html, body { padding: 0; margin: 0; } iframe { width: 100%; height: 100%; border: 0;}  </style><body><iframe src="'+this.output("datauristring",B)+'"></iframe></body></html>',Bt=Wt.open();if(Bt!==null&&(Bt.document.write(et),Bt.document.title=B.filename),Bt||typeof safari>"u")return Bt;break;case"datauri":case"dataurl":return Wt.document.location.href=this.output("datauristring",B);default:return null}},Is.foo=function(){try{return Is.apply(this,arguments)}catch(z){var g=z.stack||"";~g.indexOf(" at ")&&(g=g.split(" at ")[1]);var B="Error in function "+g.split(`
`)[0].split("<")[0]+": "+z.message;if(!Wt.console)throw new Error(B);Wt.console.error(B,z),Wt.alert&&alert(B)}},Is.foo.bar=Is,Is.foo),tr=function(g){return Array.isArray(ts)===!0&&ts.indexOf(g)>-1};switch(a){case"pt":Xe=1;break;case"mm":Xe=72/25.4;break;case"cm":Xe=72/2.54;break;case"in":Xe=72;break;case"px":Xe=tr("px_scaling")==1?.75:96/72;break;case"pc":case"em":Xe=12;break;case"ex":Xe=6;break;default:if(typeof a!="number")throw new Error("Invalid unit: "+a);Xe=a}var _s=null;q(),W();var Lr=u.__private__.getPageInfo=u.getPageInfo=function(g){if(isNaN(g)||g%1!=0)throw new Error("Invalid argument passed to jsPDF.getPageInfo");return{objId:mt[g].objId,pageNumber:g,pageContext:mt[g]}},oi=u.__private__.getPageInfoByObjId=function(g){if(isNaN(g)||g%1!=0)throw new Error("Invalid argument passed to jsPDF.getPageInfoByObjId");for(var B in mt)if(mt[B].objId===g)break;return Lr(B)},Fi=u.__private__.getCurrentPageInfo=u.getCurrentPageInfo=function(){return{objId:mt[H].objId,pageNumber:H,pageContext:mt[H]}};u.addPage=function(){return _n.apply(this,arguments),this},u.setPage=function(){return Qn.apply(this,arguments),Re.call(this,ke[H]),this},u.insertPage=function(g){return this.addPage(),this.movePage(H,g),this},u.movePage=function(g,B){var z,J;if(g>B){z=ke[g],J=mt[g];for(var ne=g;ne>B;ne--)ke[ne]=ke[ne-1],mt[ne]=mt[ne-1];ke[B]=z,mt[B]=J,this.setPage(B)}else if(g<B){z=ke[g],J=mt[g];for(var ge=g;ge<B;ge++)ke[ge]=ke[ge+1],mt[ge]=mt[ge+1];ke[B]=z,mt[B]=J,this.setPage(B)}return this},u.deletePage=function(){return Va.apply(this,arguments),this},u.__private__.text=u.text=function(g,B,z,J,ne){var ge,je,Te,Oe,We,at,et,Bt,It,ft=(J=J||{}).scope||this;if(typeof g=="number"&&typeof B=="number"&&(typeof z=="string"||Array.isArray(z))){var cs=z;z=B,B=g,g=cs}if(arguments[3]instanceof vt==0?(Te=arguments[4],Oe=arguments[5],Rs(et=arguments[3])==="object"&&et!==null||(typeof Te=="string"&&(Oe=Te,Te=null),typeof et=="string"&&(Oe=et,et=null),typeof et=="number"&&(Te=et,et=null),J={flags:et,angle:Te,align:Oe})):(k("The transform parameter of text() with a Matrix value"),It=ne),isNaN(B)||isNaN(z)||g==null)throw new Error("Invalid arguments passed to jsPDF.text");if(g.length===0)return ft;var As,Fs="",za=typeof J.lineHeightFactor=="number"?J.lineHeightFactor:zt,xs=ft.internal.scaleFactor;function cr(Ss){return Ss=Ss.split("	").join(Array(J.TabLen||9).join(" ")),os(Ss,et)}function Cs(Ss){for(var $s,vr=Ss.concat(),Mr=[],Di=vr.length;Di--;)typeof($s=vr.shift())=="string"?Mr.push($s):Array.isArray(Ss)&&($s.length===1||$s[1]===void 0&&$s[2]===void 0)?Mr.push($s[0]):Mr.push([$s[0],$s[1],$s[2]]);return Mr}function zs(Ss,$s){var vr;if(typeof Ss=="string")vr=$s(Ss)[0];else if(Array.isArray(Ss)){for(var Mr,Di,Cc=Ss.concat(),xl=[],FA=Cc.length;FA--;)typeof(Mr=Cc.shift())=="string"?xl.push($s(Mr)[0]):Array.isArray(Mr)&&typeof Mr[0]=="string"&&(Di=$s(Mr[0],Mr[1],Mr[2]),xl.push([Di[0],Di[1],Di[2]]));vr=xl}return vr}var Ps=!1,_t=!0;if(typeof g=="string")Ps=!0;else if(Array.isArray(g)){var aa=g.concat();je=[];for(var wt,vs=aa.length;vs--;)(typeof(wt=aa.shift())!="string"||Array.isArray(wt)&&typeof wt[0]!="string")&&(_t=!1);Ps=_t}if(Ps===!1)throw new Error('Type of text must be string or Array. "'+g+'" is not recognized.');typeof g=="string"&&(g=g.match(/[\r?\n]/)?g.split(/\r\n|\r|\n/g):[g]);var vn=ce/ft.internal.scaleFactor,wn=vn*(za-1);switch(J.baseline){case"bottom":z-=wn;break;case"top":z+=vn-wn;break;case"hanging":z+=vn-2*wn;break;case"middle":z+=vn/2-wn}if((at=J.maxWidth||0)>0&&(typeof g=="string"?g=ft.splitTextToSize(g,at):Object.prototype.toString.call(g)==="[object Array]"&&(g=g.reduce(function(Ss,$s){return Ss.concat(ft.splitTextToSize($s,at))},[]))),ge={text:g,x:B,y:z,options:J,mutex:{pdfEscape:os,activeFontKey:$e,fonts:dt,activeFontSize:ce}},Qt.publish("preProcessText",ge),g=ge.text,Te=(J=ge.options).angle,It instanceof vt==0&&Te&&typeof Te=="number"){Te*=Math.PI/180,J.rotationDirection===0&&(Te=-Te),C===I&&(Te=-Te);var Ar=Math.cos(Te),eo=Math.sin(Te);It=new vt(Ar,eo,-eo,Ar,0,0)}else Te&&Te instanceof vt&&(It=Te);C!==I||It||(It=Hs),(We=J.charSpace||ka)!==void 0&&(Fs+=D(M(We))+` Tc
`,this.setCharSpace(this.getCharSpace()||0)),(Bt=J.horizontalScale)!==void 0&&(Fs+=D(100*Bt)+` Tz
`),J.lang;var hr=-1,Cn=J.renderingMode!==void 0?J.renderingMode:J.stroke,Li=ft.internal.getCurrentPageInfo().pageContext;switch(Cn){case 0:case!1:case"fill":hr=0;break;case 1:case!0:case"stroke":hr=1;break;case 2:case"fillThenStroke":hr=2;break;case 3:case"invisible":hr=3;break;case 4:case"fillAndAddForClipping":hr=4;break;case 5:case"strokeAndAddPathForClipping":hr=5;break;case 6:case"fillThenStrokeAndAddToPathForClipping":hr=6;break;case 7:case"addToPathForClipping":hr=7}var nt=Li.usedRenderingMode!==void 0?Li.usedRenderingMode:-1;hr!==-1?Fs+=hr+` Tr
`:nt!==-1&&(Fs+=`0 Tr
`),hr!==-1&&(Li.usedRenderingMode=hr),Oe=J.align||"left";var Mt,is=ce*za,qr=ft.internal.pageSize.getWidth(),Ir=dt[$e];We=J.charSpace||ka,at=J.maxWidth||0,et=Object.assign({autoencode:!0,noBOM:!0},J.flags);var ms=[],ga=function(Ss){return ft.getStringUnitWidth(Ss,{font:Ir,charSpace:We,fontSize:ce,doKerning:!1})*ce/xs};if(Object.prototype.toString.call(g)==="[object Array]"){var rr;je=Cs(g),Oe!=="left"&&(Mt=je.map(ga));var Ns,Hn=0;if(Oe==="right"){B-=Mt[0],g=[],vs=je.length;for(var Nn=0;Nn<vs;Nn++)Nn===0?(Ns=ls(B),rr=Qs(z)):(Ns=M(Hn-Mt[Nn]),rr=-is),g.push([je[Nn],Ns,rr]),Hn=Mt[Nn]}else if(Oe==="center"){B-=Mt[0]/2,g=[],vs=je.length;for(var Ai=0;Ai<vs;Ai++)Ai===0?(Ns=ls(B),rr=Qs(z)):(Ns=M((Hn-Mt[Ai])/2),rr=-is),g.push([je[Ai],Ns,rr]),Hn=Mt[Ai]}else if(Oe==="left"){g=[],vs=je.length;for(var xc=0;xc<vs;xc++)g.push(je[xc])}else if(Oe==="justify"&&Ir.encoding==="Identity-H"){g=[],vs=je.length,at=at!==0?at:qr;for(var fl=0,br=0;br<vs;br++)if(rr=br===0?Qs(z):-is,Ns=br===0?ls(B):fl,br<vs-1){var TA=M((at-Mt[br])/(je[br].split(" ").length-1)),di=je[br].split(" ");g.push([di[0]+" ",Ns,rr]),fl=0;for(var ui=1;ui<di.length;ui++){var yc=(ga(di[ui-1]+" "+di[ui])-ga(di[ui]))*xs+TA;ui==di.length-1?g.push([di[ui],yc,0]):g.push([di[ui]+" ",yc,0]),fl-=yc}}else g.push([je[br],Ns,rr]);g.push(["",fl,0])}else{if(Oe!=="justify")throw new Error('Unrecognized alignment option, use "left", "center", "right" or "justify".');for(g=[],vs=je.length,at=at!==0?at:qr,br=0;br<vs;br++){rr=br===0?Qs(z):-is,Ns=br===0?ls(B):0;var bc=je[br].split(" ").length-1,vc=bc>0?(at-Mt[br])/bc:0;br<vs-1?ms.push(D(M(vc))):ms.push(0),g.push([je[br],Ns,rr])}}}(typeof J.R2L=="boolean"?J.R2L:fe)===!0&&(g=zs(g,function(Ss,$s,vr){return[Ss.split("").reverse().join(""),$s,vr]})),ge={text:g,x:B,y:z,options:J,mutex:{pdfEscape:os,activeFontKey:$e,fonts:dt,activeFontSize:ce}},Qt.publish("postProcessText",ge),g=ge.text,As=ge.mutex.isHex||!1;var wc=dt[$e].encoding;wc!=="WinAnsiEncoding"&&wc!=="StandardEncoding"||(g=zs(g,function(Ss,$s,vr){return[cr(Ss),$s,vr]})),je=Cs(g),g=[];for(var to,so,ro,Ro=Array.isArray(je[0])?1:0,ao="",Mo=function(Ss,$s,vr){var Mr="";return vr instanceof vt?(vr=typeof J.angle=="number"?Ft(vr,new vt(1,0,0,1,Ss,$s)):Ft(new vt(1,0,0,1,Ss,$s),vr),C===I&&(vr=Ft(new vt(1,0,0,-1,0,0),vr)),Mr=vr.join(" ")+` Tm
`):Mr=D(Ss)+" "+D($s)+` Td
`,Mr},Bn=0;Bn<je.length;Bn++){switch(ao="",Ro){case 1:ro=(As?"<":"(")+je[Bn][0]+(As?">":")"),to=parseFloat(je[Bn][1]),so=parseFloat(je[Bn][2]);break;case 0:ro=(As?"<":"(")+je[Bn]+(As?">":")"),to=ls(B),so=Qs(z)}ms!==void 0&&ms[Bn]!==void 0&&(ao=ms[Bn]+` Tw
`),Bn===0?g.push(ao+Mo(to,so,It)+ro):Ro===0?g.push(ao+ro):Ro===1&&g.push(ao+Mo(to,so,It)+ro)}g=Ro===0?g.join(` Tj
T* `):g.join(` Tj
`),g+=` Tj
`;var mi=`BT
/`;return mi+=$e+" "+ce+` Tf
`,mi+=D(ce*za)+` TL
`,mi+=ra+`
`,mi+=Fs,mi+=g,re(mi+="ET"),f[$e]=!0,ft};var Sa=u.__private__.clip=u.clip=function(g){return re(g==="evenodd"?"W*":"W"),this};u.clipEvenOdd=function(){return Sa("evenodd")},u.__private__.discardPath=u.discardPath=function(){return re("n"),this};var ta=u.__private__.isValidStyle=function(g){var B=!1;return[void 0,null,"S","D","F","DF","FD","f","f*","B","B*","n"].indexOf(g)!==-1&&(B=!0),B};u.__private__.setDefaultPathOperation=u.setDefaultPathOperation=function(g){return ta(g)&&(A=g),this};var ja=u.__private__.getStyle=u.getStyle=function(g){var B=A;switch(g){case"D":case"S":B="S";break;case"F":B="f";break;case"FD":case"DF":B="B";break;case"f":case"f*":case"B":case"B*":B=g}return B},ma=u.close=function(){return re("h"),this};u.stroke=function(){return re("S"),this},u.fill=function(g){return sr("f",g),this},u.fillEvenOdd=function(g){return sr("f*",g),this},u.fillStroke=function(g){return sr("B",g),this},u.fillStrokeEvenOdd=function(g){return sr("B*",g),this};var sr=function(g,B){Rs(B)==="object"?on(B,g):re(g)},$a=function(g){g===null||C===I&&g===void 0||(g=ja(g),re(g))};function nn(g,B,z,J,ne){var ge=new tc(B||this.boundingBox,z||this.xStep,J||this.yStep,this.gState,ne||this.matrix);ge.stream=this.stream;var je=g+"$$"+this.cloneIndex+++"$$";return ks(je,ge),ge}var on=function(g,B){var z=ut[g.key],J=qe[z];if(J instanceof zo)re("q"),re(Ea(B)),J.gState&&u.setGState(J.gState),re(g.matrix.toString()+" cm"),re("/"+z+" sh"),re("Q");else if(J instanceof tc){var ne=new vt(1,0,0,-1,0,Ui());g.matrix&&(ne=ne.multiply(g.matrix||Hs),z=nn.call(J,g.key,g.boundingBox,g.xStep,g.yStep,ne).id),re("q"),re("/Pattern cs"),re("/"+z+" scn"),J.gState&&u.setGState(J.gState),re(B),re("Q")}},Ea=function(g){switch(g){case"f":case"F":case"n":return"W n";case"f*":return"W* n";case"B":case"S":return"W S";case"B*":return"W* S"}},ie=u.moveTo=function(g,B){return re(D(M(g))+" "+D(P(B))+" m"),this},Qe=u.lineTo=function(g,B){return re(D(M(g))+" "+D(P(B))+" l"),this},_e=u.curveTo=function(g,B,z,J,ne,ge){return re([D(M(g)),D(P(B)),D(M(z)),D(P(J)),D(M(ne)),D(P(ge)),"c"].join(" ")),this};u.__private__.line=u.line=function(g,B,z,J,ne){if(isNaN(g)||isNaN(B)||isNaN(z)||isNaN(J)||!ta(ne))throw new Error("Invalid arguments passed to jsPDF.line");return C===j?this.lines([[z-g,J-B]],g,B,[1,1],ne||"S"):this.lines([[z-g,J-B]],g,B,[1,1]).stroke()},u.__private__.lines=u.lines=function(g,B,z,J,ne,ge){var je,Te,Oe,We,at,et,Bt,It,ft,cs,As,Fs;if(typeof g=="number"&&(Fs=z,z=B,B=g,g=Fs),J=J||[1,1],ge=ge||!1,isNaN(B)||isNaN(z)||!Array.isArray(g)||!Array.isArray(J)||!ta(ne)||typeof ge!="boolean")throw new Error("Invalid arguments passed to jsPDF.lines");for(ie(B,z),je=J[0],Te=J[1],We=g.length,cs=B,As=z,Oe=0;Oe<We;Oe++)(at=g[Oe]).length===2?(cs=at[0]*je+cs,As=at[1]*Te+As,Qe(cs,As)):(et=at[0]*je+cs,Bt=at[1]*Te+As,It=at[2]*je+cs,ft=at[3]*Te+As,cs=at[4]*je+cs,As=at[5]*Te+As,_e(et,Bt,It,ft,cs,As));return ge&&ma(),$a(ne),this},u.path=function(g){for(var B=0;B<g.length;B++){var z=g[B],J=z.c;switch(z.op){case"m":ie(J[0],J[1]);break;case"l":Qe(J[0],J[1]);break;case"c":_e.apply(this,J);break;case"h":ma()}}return this},u.__private__.rect=u.rect=function(g,B,z,J,ne){if(isNaN(g)||isNaN(B)||isNaN(z)||isNaN(J)||!ta(ne))throw new Error("Invalid arguments passed to jsPDF.rect");return C===j&&(J=-J),re([D(M(g)),D(P(B)),D(M(z)),D(M(J)),"re"].join(" ")),$a(ne),this},u.__private__.triangle=u.triangle=function(g,B,z,J,ne,ge,je){if(isNaN(g)||isNaN(B)||isNaN(z)||isNaN(J)||isNaN(ne)||isNaN(ge)||!ta(je))throw new Error("Invalid arguments passed to jsPDF.triangle");return this.lines([[z-g,J-B],[ne-z,ge-J],[g-ne,B-ge]],g,B,[1,1],je,!0),this},u.__private__.roundedRect=u.roundedRect=function(g,B,z,J,ne,ge,je){if(isNaN(g)||isNaN(B)||isNaN(z)||isNaN(J)||isNaN(ne)||isNaN(ge)||!ta(je))throw new Error("Invalid arguments passed to jsPDF.roundedRect");var Te=4/3*(Math.SQRT2-1);return ne=Math.min(ne,.5*z),ge=Math.min(ge,.5*J),this.lines([[z-2*ne,0],[ne*Te,0,ne,ge-ge*Te,ne,ge],[0,J-2*ge],[0,ge*Te,-ne*Te,ge,-ne,ge],[2*ne-z,0],[-ne*Te,0,-ne,-ge*Te,-ne,-ge],[0,2*ge-J],[0,-ge*Te,ne*Te,-ge,ne,-ge]],g+ne,B,[1,1],je,!0),this},u.__private__.ellipse=u.ellipse=function(g,B,z,J,ne){if(isNaN(g)||isNaN(B)||isNaN(z)||isNaN(J)||!ta(ne))throw new Error("Invalid arguments passed to jsPDF.ellipse");var ge=4/3*(Math.SQRT2-1)*z,je=4/3*(Math.SQRT2-1)*J;return ie(g+z,B),_e(g+z,B-je,g+ge,B-J,g,B-J),_e(g-ge,B-J,g-z,B-je,g-z,B),_e(g-z,B+je,g-ge,B+J,g,B+J),_e(g+ge,B+J,g+z,B+je,g+z,B),$a(ne),this},u.__private__.circle=u.circle=function(g,B,z,J){if(isNaN(g)||isNaN(B)||isNaN(z)||!ta(J))throw new Error("Invalid arguments passed to jsPDF.circle");return this.ellipse(g,B,z,z,J)},u.setFont=function(g,B,z){return z&&(B=Q(B,z)),$e=an(g,B,{disableWarning:!1}),this};var St=u.__private__.getFont=u.getFont=function(){return dt[an.apply(u,arguments)]};u.__private__.getFontList=u.getFontList=function(){var g,B,z={};for(g in xt)if(xt.hasOwnProperty(g))for(B in z[g]=[],xt[g])xt[g].hasOwnProperty(B)&&z[g].push(B);return z},u.addFont=function(g,B,z,J,ne){var ge=["StandardEncoding","MacRomanEncoding","Identity-H","WinAnsiEncoding"];return arguments[3]&&ge.indexOf(arguments[3])!==-1?ne=arguments[3]:arguments[3]&&ge.indexOf(arguments[3])==-1&&(z=Q(z,J)),lr.call(this,g,B,z,ne=ne||"Identity-H")};var zt,ot=s.lineWidth||.200025,yr=u.__private__.getLineWidth=u.getLineWidth=function(){return ot},kt=u.__private__.setLineWidth=u.setLineWidth=function(g){return ot=g,re(D(M(g))+" w"),this};u.__private__.setLineDash=Dt.API.setLineDash=Dt.API.setLineDashPattern=function(g,B){if(g=g||[],B=B||0,isNaN(B)||!Array.isArray(g))throw new Error("Invalid arguments passed to jsPDF.setLineDash");return g=g.map(function(z){return D(M(z))}).join(" "),B=D(M(B)),re("["+g+"] "+B+" d"),this};var ze=u.__private__.getLineHeight=u.getLineHeight=function(){return ce*zt};u.__private__.getLineHeight=u.getLineHeight=function(){return ce*zt};var Gt=u.__private__.setLineHeightFactor=u.setLineHeightFactor=function(g){return typeof(g=g||1.15)=="number"&&(zt=g),this},Bs=u.__private__.getLineHeightFactor=u.getLineHeightFactor=function(){return zt};Gt(s.lineHeight);var ls=u.__private__.getHorizontalCoordinate=function(g){return M(g)},Qs=u.__private__.getVerticalCoordinate=function(g){return C===I?g:mt[H].mediaBox.topRightY-mt[H].mediaBox.bottomLeftY-M(g)},Vs=u.__private__.getHorizontalCoordinateString=u.getHorizontalCoordinateString=function(g){return D(ls(g))},ha=u.__private__.getVerticalCoordinateString=u.getVerticalCoordinateString=function(g){return D(Qs(g))},sa=s.strokeColor||"0 G";u.__private__.getStrokeColor=u.getDrawColor=function(){return fs(sa)},u.__private__.setStrokeColor=u.setDrawColor=function(g,B,z,J){return sa=Zs({ch1:g,ch2:B,ch3:z,ch4:J,pdfColorType:"draw",precision:2}),re(sa),this};var Dr=s.fillColor||"0 g";u.__private__.getFillColor=u.getFillColor=function(){return fs(Dr)},u.__private__.setFillColor=u.setFillColor=function(g,B,z,J){return Dr=Zs({ch1:g,ch2:B,ch3:z,ch4:J,pdfColorType:"fill",precision:2}),re(Dr),this};var ra=s.textColor||"0 g",pa=u.__private__.getTextColor=u.getTextColor=function(){return fs(ra)};u.__private__.setTextColor=u.setTextColor=function(g,B,z,J){return ra=Zs({ch1:g,ch2:B,ch3:z,ch4:J,pdfColorType:"text",precision:3}),this};var ka=s.charSpace,gl=u.__private__.getCharSpace=u.getCharSpace=function(){return parseFloat(ka||0)};u.__private__.setCharSpace=u.setCharSpace=function(g){if(isNaN(g))throw new Error("Invalid argument passed to jsPDF.setCharSpace");return ka=g,this};var Pi=0;u.CapJoinStyles={0:0,butt:0,but:0,miter:0,1:1,round:1,rounded:1,circle:1,2:2,projecting:2,project:2,square:2,bevel:2},u.__private__.setLineCap=u.setLineCap=function(g){var B=u.CapJoinStyles[g];if(B===void 0)throw new Error("Line cap style of '"+g+"' is not recognized. See or extend .CapJoinStyles property for valid styles");return Pi=B,re(B+" J"),this};var Yi=0;u.__private__.setLineJoin=u.setLineJoin=function(g){var B=u.CapJoinStyles[g];if(B===void 0)throw new Error("Line join style of '"+g+"' is not recognized. See or extend .CapJoinStyles property for valid styles");return Yi=B,re(B+" j"),this},u.__private__.setLineMiterLimit=u.__private__.setMiterLimit=u.setLineMiterLimit=u.setMiterLimit=function(g){if(g=g||0,isNaN(g))throw new Error("Invalid argument passed to jsPDF.setLineMiterLimit");return re(D(M(g))+" M"),this},u.GState=Mu,u.setGState=function(g){(g=typeof g=="string"?Ge[rt[g]]:Ka(null,g)).equals(Tt)||(re("/"+g.id+" gs"),Tt=g)};var Ka=function(g,B){if(!g||!rt[g]){var z=!1;for(var J in Ge)if(Ge.hasOwnProperty(J)&&Ge[J].equals(B)){z=!0;break}if(z)B=Ge[J];else{var ne="GS"+(Object.keys(Ge).length+1).toString(10);Ge[ne]=B,B.id=ne}return g&&(rt[g]=B.id),Qt.publish("addGState",B),B}};u.addGState=function(g,B){return Ka(g,B),this},u.saveGraphicsState=function(){return re("q"),Se.push({key:$e,size:ce,color:ra}),this},u.restoreGraphicsState=function(){re("Q");var g=Se.pop();return $e=g.key,ce=g.size,ra=g.color,Tt=null,this},u.setCurrentTransformationMatrix=function(g){return re(g.toString()+" cm"),this},u.comment=function(g){return re("#"+g),this};var bn=function(g,B){var z=g||0;Object.defineProperty(this,"x",{enumerable:!0,get:function(){return z},set:function(ge){isNaN(ge)||(z=parseFloat(ge))}});var J=B||0;Object.defineProperty(this,"y",{enumerable:!0,get:function(){return J},set:function(ge){isNaN(ge)||(J=parseFloat(ge))}});var ne="pt";return Object.defineProperty(this,"type",{enumerable:!0,get:function(){return ne},set:function(ge){ne=ge.toString()}}),this},Xi=function(g,B,z,J){bn.call(this,g,B),this.type="rect";var ne=z||0;Object.defineProperty(this,"w",{enumerable:!0,get:function(){return ne},set:function(je){isNaN(je)||(ne=parseFloat(je))}});var ge=J||0;return Object.defineProperty(this,"h",{enumerable:!0,get:function(){return ge},set:function(je){isNaN(je)||(ge=parseFloat(je))}}),this},Rr=function(){this.page=At,this.currentPage=H,this.pages=ke.slice(0),this.pagesContext=mt.slice(0),this.x=Ze,this.y=ct,this.matrix=pt,this.width=us(H),this.height=ci(H),this.outputDestination=Be,this.id="",this.objectNumber=-1};Rr.prototype.restore=function(){At=this.page,H=this.currentPage,mt=this.pagesContext,ke=this.pages,Ze=this.x,ct=this.y,pt=this.matrix,Wr(H,this.width),Ga(H,this.height),Be=this.outputDestination};var li=function(g,B,z,J,ne){Es.push(new Rr),At=H=0,ke=[],Ze=g,ct=B,pt=ne,ua([z,J])};for(var lt in u.beginFormObject=function(g,B,z,J,ne){return li(g,B,z,J,ne),this},u.endFormObject=function(g){return function(B){if(Ht[B])Es.pop().restore();else{var z=new Rr,J="Xo"+(Object.keys(Yt).length+1).toString(10);z.id=J,Ht[B]=J,Yt[J]=z,Qt.publish("addFormObject",z),Es.pop().restore()}}(g),this},u.doFormObject=function(g,B){var z=Yt[Ht[g]];return re("q"),re(B.toString()+" cm"),re("/"+z.id+" Do"),re("Q"),this},u.getFormObject=function(g){var B=Yt[Ht[g]];return{x:B.x,y:B.y,width:B.width,height:B.height,matrix:B.matrix}},u.save=function(g,B){return g=g||"generated.pdf",(B=B||{}).returnPromise=B.returnPromise||!1,B.returnPromise===!1?(Vo(zr(Ur()),g),typeof Vo.unload=="function"&&Wt.setTimeout&&setTimeout(Vo.unload,911),this):new Promise(function(z,J){try{var ne=Vo(zr(Ur()),g);typeof Vo.unload=="function"&&Wt.setTimeout&&setTimeout(Vo.unload,911),z(ne)}catch(ge){J(ge.message)}})},Dt.API)Dt.API.hasOwnProperty(lt)&&(lt==="events"&&Dt.API.events.length?function(g,B){var z,J,ne;for(ne=B.length-1;ne!==-1;ne--)z=B[ne][0],J=B[ne][1],g.subscribe.apply(g,[z].concat(typeof J=="function"?[J]:J))}(Qt,Dt.API.events):u[lt]=Dt.API[lt]);function us(g){return mt[g].mediaBox.topRightX-mt[g].mediaBox.bottomLeftX}function Wr(g,B){mt[g].mediaBox.topRightX=B+mt[g].mediaBox.bottomLeftX}function ci(g){return mt[g].mediaBox.topRightY-mt[g].mediaBox.bottomLeftY}function Ga(g,B){mt[g].mediaBox.topRightY=B+mt[g].mediaBox.bottomLeftY}var Ia=u.getPageWidth=function(g){return us(g=g||H)/Xe},Zi=u.setPageWidth=function(g,B){Wr(g,B*Xe)},Ui=u.getPageHeight=function(g){return ci(g=g||H)/Xe},U=u.setPageHeight=function(g,B){Ga(g,B*Xe)};return u.internal={pdfEscape:os,getStyle:ja,getFont:St,getFontSize:pe,getCharSpace:gl,getTextColor:pa,getLineHeight:ze,getLineHeightFactor:Bs,getLineWidth:yr,write:Me,getHorizontalCoordinate:ls,getVerticalCoordinate:Qs,getCoordinateString:Vs,getVerticalCoordinateString:ha,collections:{},newObject:Nt,newAdditionalObject:Kr,newObjectDeferred:gs,newObjectDeferredBegin:Vt,getFilters:Ot,putStream:qt,events:Qt,scaleFactor:Xe,pageSize:{getWidth:function(){return Ia(H)},setWidth:function(g){Zi(H,g)},getHeight:function(){return Ui(H)},setHeight:function(g){U(H,g)}},encryptionOptions:d,encryption:_s,getEncryptor:function(g){return d!==null?_s.encryptor(g,0):function(B){return B}},output:er,getNumberOfPages:rn,get pages(){return ke},out:re,f2:w,f3:L,getPageInfo:Lr,getPageInfoByObjId:oi,getCurrentPageInfo:Fi,getPDFVersion:b,Point:bn,Rectangle:Xi,Matrix:vt,hasHotfix:tr},Object.defineProperty(u.internal.pageSize,"width",{get:function(){return Ia(H)},set:function(g){Zi(H,g)},enumerable:!0,configurable:!0}),Object.defineProperty(u.internal.pageSize,"height",{get:function(){return Ui(H)},set:function(g){U(H,g)},enumerable:!0,configurable:!0}),function(g){for(var B=0,z=be.length;B<z;B++){var J=lr.call(this,g[B][0],g[B][1],g[B][2],be[B][3],!0);h===!1&&(f[J]=!0);var ne=g[B][0].split("-");Mn({id:J,fontName:ne[0],fontStyle:ne[1]||""})}Qt.publish("addFonts",{fonts:dt,dictionary:xt})}.call(u,be),$e="F1",_n(n,r),Qt.publish("initialized"),u}Dl.prototype.lsbFirstWord=function(s){return String.fromCharCode(255&s,s>>8&255,s>>16&255,s>>24&255)},Dl.prototype.toHexString=function(s){return s.split("").map(function(e){return("0"+(255&e.charCodeAt(0)).toString(16)).slice(-2)}).join("")},Dl.prototype.hexToBytes=function(s){for(var e=[],r=0;r<s.length;r+=2)e.push(String.fromCharCode(parseInt(s.substr(r,2),16)));return e.join("")},Dl.prototype.processOwnerPassword=function(s,e){return fp(gp(e).substr(0,5),s)},Dl.prototype.encryptor=function(s,e){var r=gp(this.encryptionKey+String.fromCharCode(255&s,s>>8&255,s>>16&255,255&e,e>>8&255)).substr(0,10);return function(a){return fp(r,a)}},Mu.prototype.equals=function(s){var e,r="id,objectNumber,equals";if(!s||Rs(s)!==Rs(this))return!1;var a=0;for(e in this)if(!(r.indexOf(e)>=0)){if(this.hasOwnProperty(e)&&!s.hasOwnProperty(e)||this[e]!==s[e])return!1;a++}for(e in s)s.hasOwnProperty(e)&&r.indexOf(e)<0&&a--;return a===0},Dt.API={events:[]},Dt.version="3.0.4";var fr=Dt.API,Xp=1,pl=function(s){return s.replace(/\\/g,"\\\\").replace(/\(/g,"\\(").replace(/\)/g,"\\)")},Fl=function(s){return s.replace(/\\\\/g,"\\").replace(/\\\(/g,"(").replace(/\\\)/g,")")},Jt=function(s){return s.toFixed(2)},fo=function(s){return s.toFixed(5)};fr.__acroform__={};var en=function(s,e){s.prototype=Object.create(e.prototype),s.prototype.constructor=s},Xx=function(s){return s*Xp},bi=function(s){var e=new s1,r=Et.internal.getHeight(s)||0,a=Et.internal.getWidth(s)||0;return e.BBox=[0,0,Number(Jt(a)),Number(Jt(r))],e},EU=fr.__acroform__.setBit=function(s,e){if(s=s||0,e=e||0,isNaN(s)||isNaN(e))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.setBit");return s|1<<e},kU=fr.__acroform__.clearBit=function(s,e){if(s=s||0,e=e||0,isNaN(s)||isNaN(e))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.clearBit");return s&~(1<<e)},IU=fr.__acroform__.getBit=function(s,e){if(isNaN(s)||isNaN(e))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.getBit");return s&1<<e?1:0},Sr=fr.__acroform__.getBitForPdf=function(s,e){if(isNaN(s)||isNaN(e))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.getBitForPdf");return IU(s,e-1)},jr=fr.__acroform__.setBitForPdf=function(s,e){if(isNaN(s)||isNaN(e))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.setBitForPdf");return EU(s,e-1)},Er=fr.__acroform__.clearBitForPdf=function(s,e){if(isNaN(s)||isNaN(e))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.clearBitForPdf");return kU(s,e-1)},TU=fr.__acroform__.calculateCoordinates=function(s,e){var r=e.internal.getHorizontalCoordinate,a=e.internal.getVerticalCoordinate,n=s[0],i=s[1],o=s[2],l=s[3],c={};return c.lowerLeft_X=r(n)||0,c.lowerLeft_Y=a(i+l)||0,c.upperRight_X=r(n+o)||0,c.upperRight_Y=a(i)||0,[Number(Jt(c.lowerLeft_X)),Number(Jt(c.lowerLeft_Y)),Number(Jt(c.upperRight_X)),Number(Jt(c.upperRight_Y))]},FU=function(s){if(s.appearanceStreamContent)return s.appearanceStreamContent;if(s.V||s.DV){var e=[],r=s._V||s.DV,a=xp(s,r),n=s.scope.internal.getFont(s.fontName,s.fontStyle).id;e.push("/Tx BMC"),e.push("q"),e.push("BT"),e.push(s.scope.__private__.encodeColorString(s.color)),e.push("/"+n+" "+Jt(a.fontSize)+" Tf"),e.push("1 0 0 1 0 0 Tm"),e.push(a.text),e.push("ET"),e.push("Q"),e.push("EMC");var i=bi(s);return i.scope=s.scope,i.stream=e.join(`
`),i}},xp=function(s,e){var r=s.fontSize===0?s.maxFontSize:s.fontSize,a={text:"",fontSize:""},n=(e=(e=e.substr(0,1)=="("?e.substr(1):e).substr(e.length-1)==")"?e.substr(0,e.length-1):e).split(" ");n=s.multiline?n.map(function(w){return w.split(`
`)}):n.map(function(w){return[w]});var i=r,o=Et.internal.getHeight(s)||0;o=o<0?-o:o;var l=Et.internal.getWidth(s)||0;l=l<0?-l:l;var c=function(w,L,M){if(w+1<n.length){var P=L+" "+n[w+1][0];return Vd(P,s,M).width<=l-4}return!1};i++;e:for(;i>0;){e="",i--;var A,d,h=Vd("3",s,i).height,f=s.multiline?o-i:(o-h)/2,u=f+=2,x=0,b=0,N=0;if(i<=0){e=`(...) Tj
`,e+="% Width of Text: "+Vd(e,s,i=12).width+", FieldWidth:"+l+`
`;break}for(var v="",j=0,I=0;I<n.length;I++)if(n.hasOwnProperty(I)){var C=!1;if(n[I].length!==1&&N!==n[I].length-1){if((h+2)*(j+2)+2>o)continue e;v+=n[I][N],C=!0,b=I,I--}else{v=(v+=n[I][N]+" ").substr(v.length-1)==" "?v.substr(0,v.length-1):v;var E=parseInt(I),T=c(E,v,i),Q=I>=n.length-1;if(T&&!Q){v+=" ",N=0;continue}if(T||Q){if(Q)b=E;else if(s.multiline&&(h+2)*(j+2)+2>o)continue e}else{if(!s.multiline||(h+2)*(j+2)+2>o)continue e;b=E}}for(var D="",k=x;k<=b;k++){var R=n[k];if(s.multiline){if(k===b){D+=R[N]+" ",N=(N+1)%R.length;continue}if(k===x){D+=R[R.length-1]+" ";continue}}D+=R[0]+" "}switch(D=D.substr(D.length-1)==" "?D.substr(0,D.length-1):D,d=Vd(D,s,i).width,s.textAlign){case"right":A=l-d-2;break;case"center":A=(l-d)/2;break;default:A=2}e+=Jt(A)+" "+Jt(u)+` Td
`,e+="("+pl(D)+`) Tj
`,e+=-Jt(A)+` 0 Td
`,u=-(i+2),d=0,x=C?b:b+1,j++,v=""}break}return a.text=e,a.fontSize=i,a},Vd=function(s,e,r){var a=e.scope.internal.getFont(e.fontName,e.fontStyle),n=e.scope.getStringUnitWidth(s,{font:a,fontSize:parseFloat(r),charSpace:0})*parseFloat(r);return{height:e.scope.getStringUnitWidth("3",{font:a,fontSize:parseFloat(r),charSpace:0})*parseFloat(r)*1.5,width:n}},PU={fields:[],xForms:[],acroFormDictionaryRoot:null,printedOut:!1,internal:null,isInitialized:!1},UU=function(s,e){var r={type:"reference",object:s};e.internal.getPageInfo(s.page).pageContext.annotations.find(function(a){return a.type===r.type&&a.object===r.object})===void 0&&e.internal.getPageInfo(s.page).pageContext.annotations.push(r)},LU=function(s,e){if(e.scope=s,s.internal!==void 0&&(s.internal.acroformPlugin===void 0||s.internal.acroformPlugin.isInitialized===!1)){if(ni.FieldNum=0,s.internal.acroformPlugin=JSON.parse(JSON.stringify(PU)),s.internal.acroformPlugin.acroFormDictionaryRoot)throw new Error("Exception while creating AcroformDictionary");Xp=s.internal.scaleFactor,s.internal.acroformPlugin.acroFormDictionaryRoot=new r1,s.internal.acroformPlugin.acroFormDictionaryRoot.scope=s,s.internal.acroformPlugin.acroFormDictionaryRoot._eventID=s.internal.events.subscribe("postPutResources",function(){(function(r){r.internal.events.unsubscribe(r.internal.acroformPlugin.acroFormDictionaryRoot._eventID),delete r.internal.acroformPlugin.acroFormDictionaryRoot._eventID,r.internal.acroformPlugin.printedOut=!0})(s)}),s.internal.events.subscribe("buildDocument",function(){(function(r){r.internal.acroformPlugin.acroFormDictionaryRoot.objId=void 0;var a=r.internal.acroformPlugin.acroFormDictionaryRoot.Fields;for(var n in a)if(a.hasOwnProperty(n)){var i=a[n];i.objId=void 0,i.hasAnnotation&&UU(i,r)}})(s)}),s.internal.events.subscribe("putCatalog",function(){(function(r){if(r.internal.acroformPlugin.acroFormDictionaryRoot===void 0)throw new Error("putCatalogCallback: Root missing.");r.internal.write("/AcroForm "+r.internal.acroformPlugin.acroFormDictionaryRoot.objId+" 0 R")})(s)}),s.internal.events.subscribe("postPutPages",function(r){(function(a,n){var i=!a;for(var o in a||(n.internal.newObjectDeferredBegin(n.internal.acroformPlugin.acroFormDictionaryRoot.objId,!0),n.internal.acroformPlugin.acroFormDictionaryRoot.putStream()),a=a||n.internal.acroformPlugin.acroFormDictionaryRoot.Kids)if(a.hasOwnProperty(o)){var l=a[o],c=[],A=l.Rect;if(l.Rect&&(l.Rect=TU(l.Rect,n)),n.internal.newObjectDeferredBegin(l.objId,!0),l.DA=Et.createDefaultAppearanceStream(l),Rs(l)==="object"&&typeof l.getKeyValueListForStream=="function"&&(c=l.getKeyValueListForStream()),l.Rect=A,l.hasAppearanceStream&&!l.appearanceStreamContent){var d=FU(l);c.push({key:"AP",value:"<</N "+d+">>"}),n.internal.acroformPlugin.xForms.push(d)}if(l.appearanceStreamContent){var h="";for(var f in l.appearanceStreamContent)if(l.appearanceStreamContent.hasOwnProperty(f)){var u=l.appearanceStreamContent[f];if(h+="/"+f+" ",h+="<<",Object.keys(u).length>=1||Array.isArray(u)){for(var o in u)if(u.hasOwnProperty(o)){var x=u[o];typeof x=="function"&&(x=x.call(n,l)),h+="/"+o+" "+x+" ",n.internal.acroformPlugin.xForms.indexOf(x)>=0||n.internal.acroformPlugin.xForms.push(x)}}else typeof(x=u)=="function"&&(x=x.call(n,l)),h+="/"+o+" "+x,n.internal.acroformPlugin.xForms.indexOf(x)>=0||n.internal.acroformPlugin.xForms.push(x);h+=">>"}c.push({key:"AP",value:`<<
`+h+">>"})}n.internal.putStream({additionalKeyValues:c,objectId:l.objId}),n.internal.out("endobj")}i&&function(b,N){for(var v in b)if(b.hasOwnProperty(v)){var j=v,I=b[v];N.internal.newObjectDeferredBegin(I.objId,!0),Rs(I)==="object"&&typeof I.putStream=="function"&&I.putStream(),delete b[j]}}(n.internal.acroformPlugin.xForms,n)})(r,s)}),s.internal.acroformPlugin.isInitialized=!0}},t1=fr.__acroform__.arrayToPdfArray=function(s,e,r){var a=function(o){return o};if(Array.isArray(s)){for(var n="[",i=0;i<s.length;i++)switch(i!==0&&(n+=" "),Rs(s[i])){case"boolean":case"number":case"object":n+=s[i].toString();break;case"string":s[i].substr(0,1)!=="/"?(e!==void 0&&r&&(a=r.internal.getEncryptor(e)),n+="("+pl(a(s[i].toString()))+")"):n+=s[i].toString()}return n+"]"}throw new Error("Invalid argument passed to jsPDF.__acroform__.arrayToPdfArray")},wh=function(s,e,r){var a=function(n){return n};return e!==void 0&&r&&(a=r.internal.getEncryptor(e)),(s=s||"").toString(),"("+pl(a(s))+")"},Si=function(){this._objId=void 0,this._scope=void 0,Object.defineProperty(this,"objId",{get:function(){if(this._objId===void 0){if(this.scope===void 0)return;this._objId=this.scope.internal.newObjectDeferred()}return this._objId},set:function(s){this._objId=s}}),Object.defineProperty(this,"scope",{value:this._scope,writable:!0})};Si.prototype.toString=function(){return this.objId+" 0 R"},Si.prototype.putStream=function(){var s=this.getKeyValueListForStream();this.scope.internal.putStream({data:this.stream,additionalKeyValues:s,objectId:this.objId}),this.scope.internal.out("endobj")},Si.prototype.getKeyValueListForStream=function(){var s=[],e=Object.getOwnPropertyNames(this).filter(function(i){return i!="content"&&i!="appearanceStreamContent"&&i!="scope"&&i!="objId"&&i.substring(0,1)!="_"});for(var r in e)if(Object.getOwnPropertyDescriptor(this,e[r]).configurable===!1){var a=e[r],n=this[a];n&&(Array.isArray(n)?s.push({key:a,value:t1(n,this.objId,this.scope)}):n instanceof Si?(n.scope=this.scope,s.push({key:a,value:n.objId+" 0 R"})):typeof n!="function"&&s.push({key:a,value:n}))}return s};var s1=function(){Si.call(this),Object.defineProperty(this,"Type",{value:"/XObject",configurable:!1,writable:!0}),Object.defineProperty(this,"Subtype",{value:"/Form",configurable:!1,writable:!0}),Object.defineProperty(this,"FormType",{value:1,configurable:!1,writable:!0});var s,e=[];Object.defineProperty(this,"BBox",{configurable:!1,get:function(){return e},set:function(r){e=r}}),Object.defineProperty(this,"Resources",{value:"2 0 R",configurable:!1,writable:!0}),Object.defineProperty(this,"stream",{enumerable:!1,configurable:!0,set:function(r){s=r.trim()},get:function(){return s||null}})};en(s1,Si);var r1=function(){Si.call(this);var s,e=[];Object.defineProperty(this,"Kids",{enumerable:!1,configurable:!0,get:function(){return e.length>0?e:void 0}}),Object.defineProperty(this,"Fields",{enumerable:!1,configurable:!1,get:function(){return e}}),Object.defineProperty(this,"DA",{enumerable:!1,configurable:!1,get:function(){if(s){var r=function(a){return a};return this.scope&&(r=this.scope.internal.getEncryptor(this.objId)),"("+pl(r(s))+")"}},set:function(r){s=r}})};en(r1,Si);var ni=function s(){Si.call(this);var e=4;Object.defineProperty(this,"F",{enumerable:!1,configurable:!1,get:function(){return e},set:function(v){if(isNaN(v))throw new Error('Invalid value "'+v+'" for attribute F supplied.');e=v}}),Object.defineProperty(this,"showWhenPrinted",{enumerable:!0,configurable:!0,get:function(){return!!Sr(e,3)},set:function(v){v?this.F=jr(e,3):this.F=Er(e,3)}});var r=0;Object.defineProperty(this,"Ff",{enumerable:!1,configurable:!1,get:function(){return r},set:function(v){if(isNaN(v))throw new Error('Invalid value "'+v+'" for attribute Ff supplied.');r=v}});var a=[];Object.defineProperty(this,"Rect",{enumerable:!1,configurable:!1,get:function(){if(a.length!==0)return a},set:function(v){a=v!==void 0?v:[]}}),Object.defineProperty(this,"x",{enumerable:!0,configurable:!0,get:function(){return!a||isNaN(a[0])?0:a[0]},set:function(v){a[0]=v}}),Object.defineProperty(this,"y",{enumerable:!0,configurable:!0,get:function(){return!a||isNaN(a[1])?0:a[1]},set:function(v){a[1]=v}}),Object.defineProperty(this,"width",{enumerable:!0,configurable:!0,get:function(){return!a||isNaN(a[2])?0:a[2]},set:function(v){a[2]=v}}),Object.defineProperty(this,"height",{enumerable:!0,configurable:!0,get:function(){return!a||isNaN(a[3])?0:a[3]},set:function(v){a[3]=v}});var n="";Object.defineProperty(this,"FT",{enumerable:!0,configurable:!1,get:function(){return n},set:function(v){switch(v){case"/Btn":case"/Tx":case"/Ch":case"/Sig":n=v;break;default:throw new Error('Invalid value "'+v+'" for attribute FT supplied.')}}});var i=null;Object.defineProperty(this,"T",{enumerable:!0,configurable:!1,get:function(){if(!i||i.length<1){if(this instanceof _u)return;i="FieldObject"+s.FieldNum++}var v=function(j){return j};return this.scope&&(v=this.scope.internal.getEncryptor(this.objId)),"("+pl(v(i))+")"},set:function(v){i=v.toString()}}),Object.defineProperty(this,"fieldName",{configurable:!0,enumerable:!0,get:function(){return i},set:function(v){i=v}});var o="helvetica";Object.defineProperty(this,"fontName",{enumerable:!0,configurable:!0,get:function(){return o},set:function(v){o=v}});var l="normal";Object.defineProperty(this,"fontStyle",{enumerable:!0,configurable:!0,get:function(){return l},set:function(v){l=v}});var c=0;Object.defineProperty(this,"fontSize",{enumerable:!0,configurable:!0,get:function(){return c},set:function(v){c=v}});var A=void 0;Object.defineProperty(this,"maxFontSize",{enumerable:!0,configurable:!0,get:function(){return A===void 0?50/Xp:A},set:function(v){A=v}});var d="black";Object.defineProperty(this,"color",{enumerable:!0,configurable:!0,get:function(){return d},set:function(v){d=v}});var h="/F1 0 Tf 0 g";Object.defineProperty(this,"DA",{enumerable:!0,configurable:!1,get:function(){if(!(!h||this instanceof _u||this instanceof il))return wh(h,this.objId,this.scope)},set:function(v){v=v.toString(),h=v}});var f=null;Object.defineProperty(this,"DV",{enumerable:!1,configurable:!1,get:function(){if(f)return this instanceof Xr==0?wh(f,this.objId,this.scope):f},set:function(v){v=v.toString(),f=this instanceof Xr==0?v.substr(0,1)==="("?Fl(v.substr(1,v.length-2)):Fl(v):v}}),Object.defineProperty(this,"defaultValue",{enumerable:!0,configurable:!0,get:function(){return this instanceof Xr==1?Fl(f.substr(1,f.length-1)):f},set:function(v){v=v.toString(),f=this instanceof Xr==1?"/"+v:v}});var u=null;Object.defineProperty(this,"_V",{enumerable:!1,configurable:!1,get:function(){if(u)return u},set:function(v){this.V=v}}),Object.defineProperty(this,"V",{enumerable:!1,configurable:!1,get:function(){if(u)return this instanceof Xr==0?wh(u,this.objId,this.scope):u},set:function(v){v=v.toString(),u=this instanceof Xr==0?v.substr(0,1)==="("?Fl(v.substr(1,v.length-2)):Fl(v):v}}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,get:function(){return this instanceof Xr==1?Fl(u.substr(1,u.length-1)):u},set:function(v){v=v.toString(),u=this instanceof Xr==1?"/"+v:v}}),Object.defineProperty(this,"hasAnnotation",{enumerable:!0,configurable:!0,get:function(){return this.Rect}}),Object.defineProperty(this,"Type",{enumerable:!0,configurable:!1,get:function(){return this.hasAnnotation?"/Annot":null}}),Object.defineProperty(this,"Subtype",{enumerable:!0,configurable:!1,get:function(){return this.hasAnnotation?"/Widget":null}});var x,b=!1;Object.defineProperty(this,"hasAppearanceStream",{enumerable:!0,configurable:!0,get:function(){return b},set:function(v){v=!!v,b=v}}),Object.defineProperty(this,"page",{enumerable:!0,configurable:!0,get:function(){if(x)return x},set:function(v){x=v}}),Object.defineProperty(this,"readOnly",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,1)},set:function(v){v?this.Ff=jr(this.Ff,1):this.Ff=Er(this.Ff,1)}}),Object.defineProperty(this,"required",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,2)},set:function(v){v?this.Ff=jr(this.Ff,2):this.Ff=Er(this.Ff,2)}}),Object.defineProperty(this,"noExport",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,3)},set:function(v){v?this.Ff=jr(this.Ff,3):this.Ff=Er(this.Ff,3)}});var N=null;Object.defineProperty(this,"Q",{enumerable:!0,configurable:!1,get:function(){if(N!==null)return N},set:function(v){if([0,1,2].indexOf(v)===-1)throw new Error('Invalid value "'+v+'" for attribute Q supplied.');N=v}}),Object.defineProperty(this,"textAlign",{get:function(){var v;switch(N){case 0:default:v="left";break;case 1:v="center";break;case 2:v="right"}return v},configurable:!0,enumerable:!0,set:function(v){switch(v){case"right":case 2:N=2;break;case"center":case 1:N=1;break;default:N=0}}})};en(ni,Si);var nc=function(){ni.call(this),this.FT="/Ch",this.V="()",this.fontName="zapfdingbats";var s=0;Object.defineProperty(this,"TI",{enumerable:!0,configurable:!1,get:function(){return s},set:function(r){s=r}}),Object.defineProperty(this,"topIndex",{enumerable:!0,configurable:!0,get:function(){return s},set:function(r){s=r}});var e=[];Object.defineProperty(this,"Opt",{enumerable:!0,configurable:!1,get:function(){return t1(e,this.objId,this.scope)},set:function(r){var a,n;n=[],typeof(a=r)=="string"&&(n=function(i,o,l){l||(l=1);for(var c,A=[];c=o.exec(i);)A.push(c[l]);return A}(a,/\((.*?)\)/g)),e=n}}),this.getOptions=function(){return e},this.setOptions=function(r){e=r,this.sort&&e.sort()},this.addOption=function(r){r=(r=r||"").toString(),e.push(r),this.sort&&e.sort()},this.removeOption=function(r,a){for(a=a||!1,r=(r=r||"").toString();e.indexOf(r)!==-1&&(e.splice(e.indexOf(r),1),a!==!1););},Object.defineProperty(this,"combo",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,18)},set:function(r){r?this.Ff=jr(this.Ff,18):this.Ff=Er(this.Ff,18)}}),Object.defineProperty(this,"edit",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,19)},set:function(r){this.combo===!0&&(r?this.Ff=jr(this.Ff,19):this.Ff=Er(this.Ff,19))}}),Object.defineProperty(this,"sort",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,20)},set:function(r){r?(this.Ff=jr(this.Ff,20),e.sort()):this.Ff=Er(this.Ff,20)}}),Object.defineProperty(this,"multiSelect",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,22)},set:function(r){r?this.Ff=jr(this.Ff,22):this.Ff=Er(this.Ff,22)}}),Object.defineProperty(this,"doNotSpellCheck",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,23)},set:function(r){r?this.Ff=jr(this.Ff,23):this.Ff=Er(this.Ff,23)}}),Object.defineProperty(this,"commitOnSelChange",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,27)},set:function(r){r?this.Ff=jr(this.Ff,27):this.Ff=Er(this.Ff,27)}}),this.hasAppearanceStream=!1};en(nc,ni);var ic=function(){nc.call(this),this.fontName="helvetica",this.combo=!1};en(ic,nc);var oc=function(){ic.call(this),this.combo=!0};en(oc,ic);var ru=function(){oc.call(this),this.edit=!0};en(ru,oc);var Xr=function(){ni.call(this),this.FT="/Btn",Object.defineProperty(this,"noToggleToOff",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,15)},set:function(r){r?this.Ff=jr(this.Ff,15):this.Ff=Er(this.Ff,15)}}),Object.defineProperty(this,"radio",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,16)},set:function(r){r?this.Ff=jr(this.Ff,16):this.Ff=Er(this.Ff,16)}}),Object.defineProperty(this,"pushButton",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,17)},set:function(r){r?this.Ff=jr(this.Ff,17):this.Ff=Er(this.Ff,17)}}),Object.defineProperty(this,"radioIsUnison",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,26)},set:function(r){r?this.Ff=jr(this.Ff,26):this.Ff=Er(this.Ff,26)}});var s,e={};Object.defineProperty(this,"MK",{enumerable:!1,configurable:!1,get:function(){var r=function(i){return i};if(this.scope&&(r=this.scope.internal.getEncryptor(this.objId)),Object.keys(e).length!==0){var a,n=[];for(a in n.push("<<"),e)n.push("/"+a+" ("+pl(r(e[a]))+")");return n.push(">>"),n.join(`
`)}},set:function(r){Rs(r)==="object"&&(e=r)}}),Object.defineProperty(this,"caption",{enumerable:!0,configurable:!0,get:function(){return e.CA||""},set:function(r){typeof r=="string"&&(e.CA=r)}}),Object.defineProperty(this,"AS",{enumerable:!1,configurable:!1,get:function(){return s},set:function(r){s=r}}),Object.defineProperty(this,"appearanceState",{enumerable:!0,configurable:!0,get:function(){return s.substr(1,s.length-1)},set:function(r){s="/"+r}})};en(Xr,ni);var au=function(){Xr.call(this),this.pushButton=!0};en(au,Xr);var lc=function(){Xr.call(this),this.radio=!0,this.pushButton=!1;var s=[];Object.defineProperty(this,"Kids",{enumerable:!0,configurable:!1,get:function(){return s},set:function(e){s=e!==void 0?e:[]}})};en(lc,Xr);var _u=function(){var s,e;ni.call(this),Object.defineProperty(this,"Parent",{enumerable:!1,configurable:!1,get:function(){return s},set:function(n){s=n}}),Object.defineProperty(this,"optionName",{enumerable:!1,configurable:!0,get:function(){return e},set:function(n){e=n}});var r,a={};Object.defineProperty(this,"MK",{enumerable:!1,configurable:!1,get:function(){var n=function(l){return l};this.scope&&(n=this.scope.internal.getEncryptor(this.objId));var i,o=[];for(i in o.push("<<"),a)o.push("/"+i+" ("+pl(n(a[i]))+")");return o.push(">>"),o.join(`
`)},set:function(n){Rs(n)==="object"&&(a=n)}}),Object.defineProperty(this,"caption",{enumerable:!0,configurable:!0,get:function(){return a.CA||""},set:function(n){typeof n=="string"&&(a.CA=n)}}),Object.defineProperty(this,"AS",{enumerable:!1,configurable:!1,get:function(){return r},set:function(n){r=n}}),Object.defineProperty(this,"appearanceState",{enumerable:!0,configurable:!0,get:function(){return r.substr(1,r.length-1)},set:function(n){r="/"+n}}),this.caption="l",this.appearanceState="Off",this._AppearanceType=Et.RadioButton.Circle,this.appearanceStreamContent=this._AppearanceType.createAppearanceStream(this.optionName)};en(_u,ni),lc.prototype.setAppearance=function(s){if(!("createAppearanceStream"in s)||!("getCA"in s))throw new Error("Couldn't assign Appearance to RadioButton. Appearance was Invalid!");for(var e in this.Kids)if(this.Kids.hasOwnProperty(e)){var r=this.Kids[e];r.appearanceStreamContent=s.createAppearanceStream(r.optionName),r.caption=s.getCA()}},lc.prototype.createOption=function(s){var e=new _u;return e.Parent=this,e.optionName=s,this.Kids.push(e),DU.call(this.scope,e),e};var nu=function(){Xr.call(this),this.fontName="zapfdingbats",this.caption="3",this.appearanceState="On",this.value="On",this.textAlign="center",this.appearanceStreamContent=Et.CheckBox.createAppearanceStream()};en(nu,Xr);var il=function(){ni.call(this),this.FT="/Tx",Object.defineProperty(this,"multiline",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,13)},set:function(e){e?this.Ff=jr(this.Ff,13):this.Ff=Er(this.Ff,13)}}),Object.defineProperty(this,"fileSelect",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,21)},set:function(e){e?this.Ff=jr(this.Ff,21):this.Ff=Er(this.Ff,21)}}),Object.defineProperty(this,"doNotSpellCheck",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,23)},set:function(e){e?this.Ff=jr(this.Ff,23):this.Ff=Er(this.Ff,23)}}),Object.defineProperty(this,"doNotScroll",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,24)},set:function(e){e?this.Ff=jr(this.Ff,24):this.Ff=Er(this.Ff,24)}}),Object.defineProperty(this,"comb",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,25)},set:function(e){e?this.Ff=jr(this.Ff,25):this.Ff=Er(this.Ff,25)}}),Object.defineProperty(this,"richText",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,26)},set:function(e){e?this.Ff=jr(this.Ff,26):this.Ff=Er(this.Ff,26)}});var s=null;Object.defineProperty(this,"MaxLen",{enumerable:!0,configurable:!1,get:function(){return s},set:function(e){s=e}}),Object.defineProperty(this,"maxLength",{enumerable:!0,configurable:!0,get:function(){return s},set:function(e){Number.isInteger(e)&&(s=e)}}),Object.defineProperty(this,"hasAppearanceStream",{enumerable:!0,configurable:!0,get:function(){return this.V||this.DV}})};en(il,ni);var iu=function(){il.call(this),Object.defineProperty(this,"password",{enumerable:!0,configurable:!0,get:function(){return!!Sr(this.Ff,14)},set:function(s){s?this.Ff=jr(this.Ff,14):this.Ff=Er(this.Ff,14)}}),this.password=!0};en(iu,il);var Et={CheckBox:{createAppearanceStream:function(){return{N:{On:Et.CheckBox.YesNormal},D:{On:Et.CheckBox.YesPushDown,Off:Et.CheckBox.OffPushDown}}},YesPushDown:function(s){var e=bi(s);e.scope=s.scope;var r=[],a=s.scope.internal.getFont(s.fontName,s.fontStyle).id,n=s.scope.__private__.encodeColorString(s.color),i=xp(s,s.caption);return r.push("0.749023 g"),r.push("0 0 "+Jt(Et.internal.getWidth(s))+" "+Jt(Et.internal.getHeight(s))+" re"),r.push("f"),r.push("BMC"),r.push("q"),r.push("0 0 1 rg"),r.push("/"+a+" "+Jt(i.fontSize)+" Tf "+n),r.push("BT"),r.push(i.text),r.push("ET"),r.push("Q"),r.push("EMC"),e.stream=r.join(`
`),e},YesNormal:function(s){var e=bi(s);e.scope=s.scope;var r=s.scope.internal.getFont(s.fontName,s.fontStyle).id,a=s.scope.__private__.encodeColorString(s.color),n=[],i=Et.internal.getHeight(s),o=Et.internal.getWidth(s),l=xp(s,s.caption);return n.push("1 g"),n.push("0 0 "+Jt(o)+" "+Jt(i)+" re"),n.push("f"),n.push("q"),n.push("0 0 1 rg"),n.push("0 0 "+Jt(o-1)+" "+Jt(i-1)+" re"),n.push("W"),n.push("n"),n.push("0 g"),n.push("BT"),n.push("/"+r+" "+Jt(l.fontSize)+" Tf "+a),n.push(l.text),n.push("ET"),n.push("Q"),e.stream=n.join(`
`),e},OffPushDown:function(s){var e=bi(s);e.scope=s.scope;var r=[];return r.push("0.749023 g"),r.push("0 0 "+Jt(Et.internal.getWidth(s))+" "+Jt(Et.internal.getHeight(s))+" re"),r.push("f"),e.stream=r.join(`
`),e}},RadioButton:{Circle:{createAppearanceStream:function(s){var e={D:{Off:Et.RadioButton.Circle.OffPushDown},N:{}};return e.N[s]=Et.RadioButton.Circle.YesNormal,e.D[s]=Et.RadioButton.Circle.YesPushDown,e},getCA:function(){return"l"},YesNormal:function(s){var e=bi(s);e.scope=s.scope;var r=[],a=Et.internal.getWidth(s)<=Et.internal.getHeight(s)?Et.internal.getWidth(s)/4:Et.internal.getHeight(s)/4;a=Number((.9*a).toFixed(5));var n=Et.internal.Bezier_C,i=Number((a*n).toFixed(5));return r.push("q"),r.push("1 0 0 1 "+fo(Et.internal.getWidth(s)/2)+" "+fo(Et.internal.getHeight(s)/2)+" cm"),r.push(a+" 0 m"),r.push(a+" "+i+" "+i+" "+a+" 0 "+a+" c"),r.push("-"+i+" "+a+" -"+a+" "+i+" -"+a+" 0 c"),r.push("-"+a+" -"+i+" -"+i+" -"+a+" 0 -"+a+" c"),r.push(i+" -"+a+" "+a+" -"+i+" "+a+" 0 c"),r.push("f"),r.push("Q"),e.stream=r.join(`
`),e},YesPushDown:function(s){var e=bi(s);e.scope=s.scope;var r=[],a=Et.internal.getWidth(s)<=Et.internal.getHeight(s)?Et.internal.getWidth(s)/4:Et.internal.getHeight(s)/4;a=Number((.9*a).toFixed(5));var n=Number((2*a).toFixed(5)),i=Number((n*Et.internal.Bezier_C).toFixed(5)),o=Number((a*Et.internal.Bezier_C).toFixed(5));return r.push("0.749023 g"),r.push("q"),r.push("1 0 0 1 "+fo(Et.internal.getWidth(s)/2)+" "+fo(Et.internal.getHeight(s)/2)+" cm"),r.push(n+" 0 m"),r.push(n+" "+i+" "+i+" "+n+" 0 "+n+" c"),r.push("-"+i+" "+n+" -"+n+" "+i+" -"+n+" 0 c"),r.push("-"+n+" -"+i+" -"+i+" -"+n+" 0 -"+n+" c"),r.push(i+" -"+n+" "+n+" -"+i+" "+n+" 0 c"),r.push("f"),r.push("Q"),r.push("0 g"),r.push("q"),r.push("1 0 0 1 "+fo(Et.internal.getWidth(s)/2)+" "+fo(Et.internal.getHeight(s)/2)+" cm"),r.push(a+" 0 m"),r.push(a+" "+o+" "+o+" "+a+" 0 "+a+" c"),r.push("-"+o+" "+a+" -"+a+" "+o+" -"+a+" 0 c"),r.push("-"+a+" -"+o+" -"+o+" -"+a+" 0 -"+a+" c"),r.push(o+" -"+a+" "+a+" -"+o+" "+a+" 0 c"),r.push("f"),r.push("Q"),e.stream=r.join(`
`),e},OffPushDown:function(s){var e=bi(s);e.scope=s.scope;var r=[],a=Et.internal.getWidth(s)<=Et.internal.getHeight(s)?Et.internal.getWidth(s)/4:Et.internal.getHeight(s)/4;a=Number((.9*a).toFixed(5));var n=Number((2*a).toFixed(5)),i=Number((n*Et.internal.Bezier_C).toFixed(5));return r.push("0.749023 g"),r.push("q"),r.push("1 0 0 1 "+fo(Et.internal.getWidth(s)/2)+" "+fo(Et.internal.getHeight(s)/2)+" cm"),r.push(n+" 0 m"),r.push(n+" "+i+" "+i+" "+n+" 0 "+n+" c"),r.push("-"+i+" "+n+" -"+n+" "+i+" -"+n+" 0 c"),r.push("-"+n+" -"+i+" -"+i+" -"+n+" 0 -"+n+" c"),r.push(i+" -"+n+" "+n+" -"+i+" "+n+" 0 c"),r.push("f"),r.push("Q"),e.stream=r.join(`
`),e}},Cross:{createAppearanceStream:function(s){var e={D:{Off:Et.RadioButton.Cross.OffPushDown},N:{}};return e.N[s]=Et.RadioButton.Cross.YesNormal,e.D[s]=Et.RadioButton.Cross.YesPushDown,e},getCA:function(){return"8"},YesNormal:function(s){var e=bi(s);e.scope=s.scope;var r=[],a=Et.internal.calculateCross(s);return r.push("q"),r.push("1 1 "+Jt(Et.internal.getWidth(s)-2)+" "+Jt(Et.internal.getHeight(s)-2)+" re"),r.push("W"),r.push("n"),r.push(Jt(a.x1.x)+" "+Jt(a.x1.y)+" m"),r.push(Jt(a.x2.x)+" "+Jt(a.x2.y)+" l"),r.push(Jt(a.x4.x)+" "+Jt(a.x4.y)+" m"),r.push(Jt(a.x3.x)+" "+Jt(a.x3.y)+" l"),r.push("s"),r.push("Q"),e.stream=r.join(`
`),e},YesPushDown:function(s){var e=bi(s);e.scope=s.scope;var r=Et.internal.calculateCross(s),a=[];return a.push("0.749023 g"),a.push("0 0 "+Jt(Et.internal.getWidth(s))+" "+Jt(Et.internal.getHeight(s))+" re"),a.push("f"),a.push("q"),a.push("1 1 "+Jt(Et.internal.getWidth(s)-2)+" "+Jt(Et.internal.getHeight(s)-2)+" re"),a.push("W"),a.push("n"),a.push(Jt(r.x1.x)+" "+Jt(r.x1.y)+" m"),a.push(Jt(r.x2.x)+" "+Jt(r.x2.y)+" l"),a.push(Jt(r.x4.x)+" "+Jt(r.x4.y)+" m"),a.push(Jt(r.x3.x)+" "+Jt(r.x3.y)+" l"),a.push("s"),a.push("Q"),e.stream=a.join(`
`),e},OffPushDown:function(s){var e=bi(s);e.scope=s.scope;var r=[];return r.push("0.749023 g"),r.push("0 0 "+Jt(Et.internal.getWidth(s))+" "+Jt(Et.internal.getHeight(s))+" re"),r.push("f"),e.stream=r.join(`
`),e}}},createDefaultAppearanceStream:function(s){var e=s.scope.internal.getFont(s.fontName,s.fontStyle).id,r=s.scope.__private__.encodeColorString(s.color);return"/"+e+" "+s.fontSize+" Tf "+r}};Et.internal={Bezier_C:.551915024494,calculateCross:function(s){var e=Et.internal.getWidth(s),r=Et.internal.getHeight(s),a=Math.min(e,r);return{x1:{x:(e-a)/2,y:(r-a)/2+a},x2:{x:(e-a)/2+a,y:(r-a)/2},x3:{x:(e-a)/2,y:(r-a)/2},x4:{x:(e-a)/2+a,y:(r-a)/2+a}}}},Et.internal.getWidth=function(s){var e=0;return Rs(s)==="object"&&(e=Xx(s.Rect[2])),e},Et.internal.getHeight=function(s){var e=0;return Rs(s)==="object"&&(e=Xx(s.Rect[3])),e};var DU=fr.addField=function(s){if(LU(this,s),!(s instanceof ni))throw new Error("Invalid argument passed to jsPDF.addField.");var e;return(e=s).scope.internal.acroformPlugin.printedOut&&(e.scope.internal.acroformPlugin.printedOut=!1,e.scope.internal.acroformPlugin.acroFormDictionaryRoot=null),e.scope.internal.acroformPlugin.acroFormDictionaryRoot.Fields.push(e),s.page=s.scope.internal.getCurrentPageInfo().pageNumber,this};fr.AcroFormChoiceField=nc,fr.AcroFormListBox=ic,fr.AcroFormComboBox=oc,fr.AcroFormEditBox=ru,fr.AcroFormButton=Xr,fr.AcroFormPushButton=au,fr.AcroFormRadioButton=lc,fr.AcroFormCheckBox=nu,fr.AcroFormTextField=il,fr.AcroFormPasswordField=iu,fr.AcroFormAppearance=Et,fr.AcroForm={ChoiceField:nc,ListBox:ic,ComboBox:oc,EditBox:ru,Button:Xr,PushButton:au,RadioButton:lc,CheckBox:nu,TextField:il,PasswordField:iu,Appearance:Et},Dt.AcroForm={ChoiceField:nc,ListBox:ic,ComboBox:oc,EditBox:ru,Button:Xr,PushButton:au,RadioButton:lc,CheckBox:nu,TextField:il,PasswordField:iu,Appearance:Et};Dt.AcroForm;function a1(s){return s.reduce(function(e,r,a){return e[r]=a,e},{})}(function(s){var e="addImage_";s.__addimage__={};var r="UNKNOWN",a={PNG:[[137,80,78,71]],TIFF:[[77,77,0,42],[73,73,42,0]],JPEG:[[255,216,255,224,void 0,void 0,74,70,73,70,0],[255,216,255,225,void 0,void 0,69,120,105,102,0,0],[255,216,255,219],[255,216,255,238]],JPEG2000:[[0,0,0,12,106,80,32,32]],GIF87a:[[71,73,70,56,55,97]],GIF89a:[[71,73,70,56,57,97]],WEBP:[[82,73,70,70,void 0,void 0,void 0,void 0,87,69,66,80]],BMP:[[66,77],[66,65],[67,73],[67,80],[73,67],[80,84]]},n=s.__addimage__.getImageFileTypeByImageData=function(w,L){var M,P,K,$,O,W=r;if((L=L||r)==="RGBA"||w.data!==void 0&&w.data instanceof Uint8ClampedArray&&"height"in w&&"width"in w)return"RGBA";if(T(w))for(O in a)for(K=a[O],M=0;M<K.length;M+=1){for($=!0,P=0;P<K[M].length;P+=1)if(K[M][P]!==void 0&&K[M][P]!==w[P]){$=!1;break}if($===!0){W=O;break}}else for(O in a)for(K=a[O],M=0;M<K.length;M+=1){for($=!0,P=0;P<K[M].length;P+=1)if(K[M][P]!==void 0&&K[M][P]!==w.charCodeAt(P)){$=!1;break}if($===!0){W=O;break}}return W===r&&L!==r&&(W=L),W},i=function w(L){for(var M=this.internal.write,P=this.internal.putStream,K=(0,this.internal.getFilters)();K.indexOf("FlateEncode")!==-1;)K.splice(K.indexOf("FlateEncode"),1);L.objectId=this.internal.newObject();var $=[];if($.push({key:"Type",value:"/XObject"}),$.push({key:"Subtype",value:"/Image"}),$.push({key:"Width",value:L.width}),$.push({key:"Height",value:L.height}),L.colorSpace===v.INDEXED?$.push({key:"ColorSpace",value:"[/Indexed /DeviceRGB "+(L.palette.length/3-1)+" "+("sMask"in L&&L.sMask!==void 0?L.objectId+2:L.objectId+1)+" 0 R]"}):($.push({key:"ColorSpace",value:"/"+L.colorSpace}),L.colorSpace===v.DEVICE_CMYK&&$.push({key:"Decode",value:"[1 0 1 0 1 0 1 0]"})),$.push({key:"BitsPerComponent",value:L.bitsPerComponent}),"decodeParameters"in L&&L.decodeParameters!==void 0&&$.push({key:"DecodeParms",value:"<<"+L.decodeParameters+">>"}),"transparency"in L&&Array.isArray(L.transparency)&&L.transparency.length>0){for(var O="",W=0,ee=L.transparency.length;W<ee;W++)O+=L.transparency[W]+" "+L.transparency[W]+" ";$.push({key:"Mask",value:"["+O+"]"})}L.sMask!==void 0&&$.push({key:"SMask",value:L.objectId+1+" 0 R"});var V=L.filter!==void 0?["/"+L.filter]:void 0;if(P({data:L.data,additionalKeyValues:$,alreadyAppliedFilters:V,objectId:L.objectId}),M("endobj"),"sMask"in L&&L.sMask!==void 0){var q,S=(q=L.sMaskBitsPerComponent)!==null&&q!==void 0?q:L.bitsPerComponent,H={width:L.width,height:L.height,colorSpace:"DeviceGray",bitsPerComponent:S,data:L.sMask};"filter"in L&&(H.decodeParameters="/Predictor ".concat(L.predictor," /Colors 1 /BitsPerComponent ").concat(S," /Columns ").concat(L.width),H.filter=L.filter),w.call(this,H)}if(L.colorSpace===v.INDEXED){var Y=this.internal.newObject();P({data:D(new Uint8Array(L.palette)),objectId:Y}),M("endobj")}},o=function(){var w=this.internal.collections[e+"images"];for(var L in w)i.call(this,w[L])},l=function(){var w,L=this.internal.collections[e+"images"],M=this.internal.write;for(var P in L)M("/I"+(w=L[P]).index,w.objectId,"0","R")},c=function(){this.internal.collections[e+"images"]||(this.internal.collections[e+"images"]={},this.internal.events.subscribe("putResources",o),this.internal.events.subscribe("putXobjectDict",l))},A=function(){var w=this.internal.collections[e+"images"];return c.call(this),w},d=function(){return Object.keys(this.internal.collections[e+"images"]).length},h=function(w){return typeof s["process"+w.toUpperCase()]=="function"},f=function(w){return Rs(w)==="object"&&w.nodeType===1},u=function(w,L){if(w.nodeName==="IMG"&&w.hasAttribute("src")){var M=""+w.getAttribute("src");if(M.indexOf("data:image/")===0)return su(unescape(M).split("base64,").pop());var P=s.loadFile(M,!0);if(P!==void 0)return P}if(w.nodeName==="CANVAS"){if(w.width===0||w.height===0)throw new Error("Given canvas must have data. Canvas width: "+w.width+", height: "+w.height);var K;switch(L){case"PNG":K="image/png";break;case"WEBP":K="image/webp";break;default:K="image/jpeg"}return su(w.toDataURL(K,1).split("base64,").pop())}},x=function(w){var L=this.internal.collections[e+"images"];if(L){for(var M in L)if(w===L[M].alias)return L[M]}},b=function(w,L,M){return w||L||(w=-96,L=-96),w<0&&(w=-1*M.width*72/w/this.internal.scaleFactor),L<0&&(L=-1*M.height*72/L/this.internal.scaleFactor),w===0&&(w=L*M.width/M.height),L===0&&(L=w*M.height/M.width),[w,L]},N=function(w,L,M,P,K,$){var O=b.call(this,M,P,K),W=this.internal.getCoordinateString,ee=this.internal.getVerticalCoordinateString,V=A.call(this);if(M=O[0],P=O[1],V[K.index]=K,$){$*=Math.PI/180;var q=Math.cos($),S=Math.sin($),H=function(te){return te.toFixed(4)},Y=[H(q),H(S),H(-1*S),H(q),0,0,"cm"]}this.internal.write("q"),$?(this.internal.write([1,"0","0",1,W(w),ee(L+P),"cm"].join(" ")),this.internal.write(Y.join(" ")),this.internal.write([W(M),"0","0",W(P),"0","0","cm"].join(" "))):this.internal.write([W(M),"0","0",W(P),W(w),ee(L+P),"cm"].join(" ")),this.isAdvancedAPI()&&this.internal.write([1,0,0,-1,0,0,"cm"].join(" ")),this.internal.write("/I"+K.index+" Do"),this.internal.write("Q")},v=s.color_spaces={DEVICE_RGB:"DeviceRGB",DEVICE_GRAY:"DeviceGray",DEVICE_CMYK:"DeviceCMYK",CAL_GREY:"CalGray",CAL_RGB:"CalRGB",LAB:"Lab",ICC_BASED:"ICCBased",INDEXED:"Indexed",PATTERN:"Pattern",SEPARATION:"Separation",DEVICE_N:"DeviceN"};s.decode={DCT_DECODE:"DCTDecode",FLATE_DECODE:"FlateDecode",LZW_DECODE:"LZWDecode",JPX_DECODE:"JPXDecode",JBIG2_DECODE:"JBIG2Decode",ASCII85_DECODE:"ASCII85Decode",ASCII_HEX_DECODE:"ASCIIHexDecode",RUN_LENGTH_DECODE:"RunLengthDecode",CCITT_FAX_DECODE:"CCITTFaxDecode"};var j=s.image_compression={NONE:"NONE",FAST:"FAST",MEDIUM:"MEDIUM",SLOW:"SLOW"},I=s.__addimage__.sHashCode=function(w){var L,M,P=0;if(typeof w=="string")for(M=w.length,L=0;L<M;L++)P=(P<<5)-P+w.charCodeAt(L),P|=0;else if(T(w))for(M=w.byteLength/2,L=0;L<M;L++)P=(P<<5)-P+w[L],P|=0;return P},C=s.__addimage__.validateStringAsBase64=function(w){(w=w||"").toString().trim();var L=!0;return w.length===0&&(L=!1),w.length%4!=0&&(L=!1),/^[A-Za-z0-9+/]+$/.test(w.substr(0,w.length-2))===!1&&(L=!1),/^[A-Za-z0-9/][A-Za-z0-9+/]|[A-Za-z0-9+/]=|==$/.test(w.substr(-2))===!1&&(L=!1),L},E=s.__addimage__.extractImageFromDataUrl=function(w){if(w==null||!(w=w.trim()).startsWith("data:"))return null;var L=w.indexOf(",");return L<0?null:w.substring(0,L).trim().endsWith("base64")?w.substring(L+1):null};s.__addimage__.isArrayBuffer=function(w){return w instanceof ArrayBuffer};var T=s.__addimage__.isArrayBufferView=function(w){return w instanceof Int8Array||w instanceof Uint8Array||w instanceof Uint8ClampedArray||w instanceof Int16Array||w instanceof Uint16Array||w instanceof Int32Array||w instanceof Uint32Array||w instanceof Float32Array||w instanceof Float64Array},Q=s.__addimage__.binaryStringToUint8Array=function(w){for(var L=w.length,M=new Uint8Array(L),P=0;P<L;P++)M[P]=w.charCodeAt(P);return M},D=s.__addimage__.arrayBufferToBinaryString=function(w){for(var L="",M=T(w)?w:new Uint8Array(w),P=0;P<M.length;P+=8192)L+=String.fromCharCode.apply(null,M.subarray(P,P+8192));return L};s.addImage=function(){var w,L,M,P,K,$,O,W,ee;if(typeof arguments[1]=="number"?(L=r,M=arguments[1],P=arguments[2],K=arguments[3],$=arguments[4],O=arguments[5],W=arguments[6],ee=arguments[7]):(L=arguments[1],M=arguments[2],P=arguments[3],K=arguments[4],$=arguments[5],O=arguments[6],W=arguments[7],ee=arguments[8]),Rs(w=arguments[0])==="object"&&!f(w)&&"imageData"in w){var V=w;w=V.imageData,L=V.format||L||r,M=V.x||M||0,P=V.y||P||0,K=V.w||V.width||K,$=V.h||V.height||$,O=V.alias||O,W=V.compression||W,ee=V.rotation||V.angle||ee}var q=this.internal.getFilters();if(W===void 0&&q.indexOf("FlateEncode")!==-1&&(W="SLOW"),isNaN(M)||isNaN(P))throw new Error("Invalid coordinates passed to jsPDF.addImage");c.call(this);var S=k.call(this,w,L,O,W);return N.call(this,M,P,K,$,S,ee),this};var k=function(w,L,M,P){var K,$,O;if(typeof w=="string"&&n(w)===r){w=unescape(w);var W=R(w,!1);(W!==""||(W=s.loadFile(w,!0))!==void 0)&&(w=W)}if(f(w)&&(w=u(w,L)),L=n(w,L),!h(L))throw new Error("addImage does not support files of type '"+L+"', please ensure that a plugin for '"+L+"' support is added.");if(((O=M)==null||O.length===0)&&(M=function(ee){return typeof ee=="string"||T(ee)?I(ee):T(ee.data)?I(ee.data):null}(w)),(K=x.call(this,M))||(w instanceof Uint8Array||L==="RGBA"||($=w,w=Q(w)),K=this["process"+L.toUpperCase()](w,d.call(this),M,function(ee){return ee&&typeof ee=="string"&&(ee=ee.toUpperCase()),ee in s.image_compression?ee:j.NONE}(P),$)),!K)throw new Error("An unknown error occurred whilst processing the image.");return K},R=s.__addimage__.convertBase64ToBinaryString=function(w,L){L=typeof L!="boolean"||L;var M,P="";if(typeof w=="string"){var K;M=(K=E(w))!==null&&K!==void 0?K:w;try{P=su(M)}catch($){if(L)throw C(M)?new Error("atob-Error in jsPDF.convertBase64ToBinaryString "+$.message):new Error("Supplied Data is not a valid base64-String jsPDF.convertBase64ToBinaryString ")}}return P};s.getImageProperties=function(w){var L,M,P="";if(f(w)&&(w=u(w)),typeof w=="string"&&n(w)===r&&((P=R(w,!1))===""&&(P=s.loadFile(w)||""),w=P),M=n(w),!h(M))throw new Error("addImage does not support files of type '"+M+"', please ensure that a plugin for '"+M+"' support is added.");if(w instanceof Uint8Array||(w=Q(w)),!(L=this["process"+M.toUpperCase()](w)))throw new Error("An unknown error occurred whilst processing the image");return L.fileType=M,L}})(Dt.API),function(s){var e=function(r){if(r!==void 0&&r!="")return!0};Dt.API.events.push(["addPage",function(r){this.internal.getPageInfo(r.pageNumber).pageContext.annotations=[]}]),s.events.push(["putPage",function(r){for(var a,n,i,o=this.internal.getCoordinateString,l=this.internal.getVerticalCoordinateString,c=this.internal.getPageInfoByObjId(r.objId),A=r.pageContext.annotations,d=!1,h=0;h<A.length&&!d;h++)switch((a=A[h]).type){case"link":(e(a.options.url)||e(a.options.pageNumber))&&(d=!0);break;case"reference":case"text":case"freetext":d=!0}if(d!=0){this.internal.write("/Annots [");for(var f=0;f<A.length;f++){a=A[f];var u=this.internal.pdfEscape,x=this.internal.getEncryptor(r.objId);switch(a.type){case"reference":this.internal.write(" "+a.object.objId+" 0 R ");break;case"text":var b=this.internal.newAdditionalObject(),N=this.internal.newAdditionalObject(),v=this.internal.getEncryptor(b.objId),j=a.title||"Note";i="<</Type /Annot /Subtype /Text "+(n="/Rect ["+o(a.bounds.x)+" "+l(a.bounds.y+a.bounds.h)+" "+o(a.bounds.x+a.bounds.w)+" "+l(a.bounds.y)+"] ")+"/Contents ("+u(v(a.contents))+")",i+=" /Popup "+N.objId+" 0 R",i+=" /P "+c.objId+" 0 R",i+=" /T ("+u(v(j))+") >>",b.content=i;var I=b.objId+" 0 R";i="<</Type /Annot /Subtype /Popup "+(n="/Rect ["+o(a.bounds.x+30)+" "+l(a.bounds.y+a.bounds.h)+" "+o(a.bounds.x+a.bounds.w+30)+" "+l(a.bounds.y)+"] ")+" /Parent "+I,a.open&&(i+=" /Open true"),i+=" >>",N.content=i,this.internal.write(b.objId,"0 R",N.objId,"0 R");break;case"freetext":n="/Rect ["+o(a.bounds.x)+" "+l(a.bounds.y)+" "+o(a.bounds.x+a.bounds.w)+" "+l(a.bounds.y+a.bounds.h)+"] ";var C=a.color||"#000000";i="<</Type /Annot /Subtype /FreeText "+n+"/Contents ("+u(x(a.contents))+")",i+=" /DS(font: Helvetica,sans-serif 12.0pt; text-align:left; color:#"+C+")",i+=" /Border [0 0 0]",i+=" >>",this.internal.write(i);break;case"link":if(a.options.name){var E=this.annotations._nameMap[a.options.name];a.options.pageNumber=E.page,a.options.top=E.y}else a.options.top||(a.options.top=0);if(n="/Rect ["+a.finalBounds.x+" "+a.finalBounds.y+" "+a.finalBounds.w+" "+a.finalBounds.h+"] ",i="",a.options.url)i="<</Type /Annot /Subtype /Link "+n+"/Border [0 0 0] /A <</S /URI /URI ("+u(x(a.options.url))+") >>";else if(a.options.pageNumber)switch(i="<</Type /Annot /Subtype /Link "+n+"/Border [0 0 0] /Dest ["+this.internal.getPageInfo(a.options.pageNumber).objId+" 0 R",a.options.magFactor=a.options.magFactor||"XYZ",a.options.magFactor){case"Fit":i+=" /Fit]";break;case"FitH":i+=" /FitH "+a.options.top+"]";break;case"FitV":a.options.left=a.options.left||0,i+=" /FitV "+a.options.left+"]";break;default:var T=l(a.options.top);a.options.left=a.options.left||0,a.options.zoom===void 0&&(a.options.zoom=0),i+=" /XYZ "+a.options.left+" "+T+" "+a.options.zoom+"]"}i!=""&&(i+=" >>",this.internal.write(i))}}this.internal.write("]")}}]),s.createAnnotation=function(r){var a=this.internal.getCurrentPageInfo();switch(r.type){case"link":this.link(r.bounds.x,r.bounds.y,r.bounds.w,r.bounds.h,r);break;case"text":case"freetext":a.pageContext.annotations.push(r)}},s.link=function(r,a,n,i,o){var l=this.internal.getCurrentPageInfo(),c=this.internal.getCoordinateString,A=this.internal.getVerticalCoordinateString;l.pageContext.annotations.push({finalBounds:{x:c(r),y:A(a),w:c(r+n),h:A(a+i)},options:o,type:"link"})},s.textWithLink=function(r,a,n,i){var o,l,c=this.getTextWidth(r),A=this.internal.getLineHeight()/this.internal.scaleFactor;if(i.maxWidth!==void 0){l=i.maxWidth;var d=this.splitTextToSize(r,l).length;o=Math.ceil(A*d)}else l=c,o=A;return this.text(r,a,n,i),n+=.2*A,i.align==="center"&&(a-=c/2),i.align==="right"&&(a-=c),this.link(a,n-A,l,o,i),c},s.getTextWidth=function(r){var a=this.internal.getFontSize();return this.getStringUnitWidth(r)*a/this.internal.scaleFactor}}(Dt.API),function(s){var e={1569:[65152],1570:[65153,65154],1571:[65155,65156],1572:[65157,65158],1573:[65159,65160],1574:[65161,65162,65163,65164],1575:[65165,65166],1576:[65167,65168,65169,65170],1577:[65171,65172],1578:[65173,65174,65175,65176],1579:[65177,65178,65179,65180],1580:[65181,65182,65183,65184],1581:[65185,65186,65187,65188],1582:[65189,65190,65191,65192],1583:[65193,65194],1584:[65195,65196],1585:[65197,65198],1586:[65199,65200],1587:[65201,65202,65203,65204],1588:[65205,65206,65207,65208],1589:[65209,65210,65211,65212],1590:[65213,65214,65215,65216],1591:[65217,65218,65219,65220],1592:[65221,65222,65223,65224],1593:[65225,65226,65227,65228],1594:[65229,65230,65231,65232],1601:[65233,65234,65235,65236],1602:[65237,65238,65239,65240],1603:[65241,65242,65243,65244],1604:[65245,65246,65247,65248],1605:[65249,65250,65251,65252],1606:[65253,65254,65255,65256],1607:[65257,65258,65259,65260],1608:[65261,65262],1609:[65263,65264,64488,64489],1610:[65265,65266,65267,65268],1649:[64336,64337],1655:[64477],1657:[64358,64359,64360,64361],1658:[64350,64351,64352,64353],1659:[64338,64339,64340,64341],1662:[64342,64343,64344,64345],1663:[64354,64355,64356,64357],1664:[64346,64347,64348,64349],1667:[64374,64375,64376,64377],1668:[64370,64371,64372,64373],1670:[64378,64379,64380,64381],1671:[64382,64383,64384,64385],1672:[64392,64393],1676:[64388,64389],1677:[64386,64387],1678:[64390,64391],1681:[64396,64397],1688:[64394,64395],1700:[64362,64363,64364,64365],1702:[64366,64367,64368,64369],1705:[64398,64399,64400,64401],1709:[64467,64468,64469,64470],1711:[64402,64403,64404,64405],1713:[64410,64411,64412,64413],1715:[64406,64407,64408,64409],1722:[64414,64415],1723:[64416,64417,64418,64419],1726:[64426,64427,64428,64429],1728:[64420,64421],1729:[64422,64423,64424,64425],1733:[64480,64481],1734:[64473,64474],1735:[64471,64472],1736:[64475,64476],1737:[64482,64483],1739:[64478,64479],1740:[64508,64509,64510,64511],1744:[64484,64485,64486,64487],1746:[64430,64431],1747:[64432,64433]},r={65247:{65154:65269,65156:65271,65160:65273,65166:65275},65248:{65154:65270,65156:65272,65160:65274,65166:65276},65165:{65247:{65248:{65258:65010}}},1617:{1612:64606,1613:64607,1614:64608,1615:64609,1616:64610}},a={1612:64606,1613:64607,1614:64608,1615:64609,1616:64610},n=[1570,1571,1573,1575];s.__arabicParser__={};var i=s.__arabicParser__.isInArabicSubstitutionA=function(b){return e[b.charCodeAt(0)]!==void 0},o=s.__arabicParser__.isArabicLetter=function(b){return typeof b=="string"&&/^[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]+$/.test(b)},l=s.__arabicParser__.isArabicEndLetter=function(b){return o(b)&&i(b)&&e[b.charCodeAt(0)].length<=2},c=s.__arabicParser__.isArabicAlfLetter=function(b){return o(b)&&n.indexOf(b.charCodeAt(0))>=0};s.__arabicParser__.arabicLetterHasIsolatedForm=function(b){return o(b)&&i(b)&&e[b.charCodeAt(0)].length>=1};var A=s.__arabicParser__.arabicLetterHasFinalForm=function(b){return o(b)&&i(b)&&e[b.charCodeAt(0)].length>=2};s.__arabicParser__.arabicLetterHasInitialForm=function(b){return o(b)&&i(b)&&e[b.charCodeAt(0)].length>=3};var d=s.__arabicParser__.arabicLetterHasMedialForm=function(b){return o(b)&&i(b)&&e[b.charCodeAt(0)].length==4},h=s.__arabicParser__.resolveLigatures=function(b){var N=0,v=r,j="",I=0;for(N=0;N<b.length;N+=1)v[b.charCodeAt(N)]!==void 0?(I++,typeof(v=v[b.charCodeAt(N)])=="number"&&(j+=String.fromCharCode(v),v=r,I=0),N===b.length-1&&(v=r,j+=b.charAt(N-(I-1)),N-=I-1,I=0)):(v=r,j+=b.charAt(N-I),N-=I,I=0);return j};s.__arabicParser__.isArabicDiacritic=function(b){return b!==void 0&&a[b.charCodeAt(0)]!==void 0};var f=s.__arabicParser__.getCorrectForm=function(b,N,v){return o(b)?i(b)===!1?-1:!A(b)||!o(N)&&!o(v)||!o(v)&&l(N)||l(b)&&!o(N)||l(b)&&c(N)||l(b)&&l(N)?0:d(b)&&o(N)&&!l(N)&&o(v)&&A(v)?3:l(b)||!o(v)?1:2:-1},u=function(b){var N=0,v=0,j=0,I="",C="",E="",T=(b=b||"").split("\\s+"),Q=[];for(N=0;N<T.length;N+=1){for(Q.push(""),v=0;v<T[N].length;v+=1)I=T[N][v],C=T[N][v-1],E=T[N][v+1],o(I)?(j=f(I,C,E),Q[N]+=j!==-1?String.fromCharCode(e[I.charCodeAt(0)][j]):I):Q[N]+=I;Q[N]=h(Q[N])}return Q.join(" ")},x=s.__arabicParser__.processArabic=s.processArabic=function(){var b,N=typeof arguments[0]=="string"?arguments[0]:arguments[0].text,v=[];if(Array.isArray(N)){var j=0;for(v=[],j=0;j<N.length;j+=1)Array.isArray(N[j])?v.push([u(N[j][0]),N[j][1],N[j][2]]):v.push([u(N[j])]);b=v}else b=u(N);return typeof arguments[0]=="string"?b:(arguments[0].text=b,arguments[0])};s.events.push(["preProcessText",x])}(Dt.API),Dt.API.autoPrint=function(s){var e;return(s=s||{}).variant=s.variant||"non-conform",s.variant==="javascript"?this.addJS("print({});"):(this.internal.events.subscribe("postPutResources",function(){e=this.internal.newObject(),this.internal.out("<<"),this.internal.out("/S /Named"),this.internal.out("/Type /Action"),this.internal.out("/N /Print"),this.internal.out(">>"),this.internal.out("endobj")}),this.internal.events.subscribe("putCatalog",function(){this.internal.out("/OpenAction "+e+" 0 R")})),this},function(s){var e=function(){var r=void 0;Object.defineProperty(this,"pdf",{get:function(){return r},set:function(l){r=l}});var a=150;Object.defineProperty(this,"width",{get:function(){return a},set:function(l){a=isNaN(l)||Number.isInteger(l)===!1||l<0?150:l,this.getContext("2d").pageWrapXEnabled&&(this.getContext("2d").pageWrapX=a+1)}});var n=300;Object.defineProperty(this,"height",{get:function(){return n},set:function(l){n=isNaN(l)||Number.isInteger(l)===!1||l<0?300:l,this.getContext("2d").pageWrapYEnabled&&(this.getContext("2d").pageWrapY=n+1)}});var i=[];Object.defineProperty(this,"childNodes",{get:function(){return i},set:function(l){i=l}});var o={};Object.defineProperty(this,"style",{get:function(){return o},set:function(l){o=l}}),Object.defineProperty(this,"parentNode",{})};e.prototype.getContext=function(r,a){var n;if((r=r||"2d")!=="2d")return null;for(n in a)this.pdf.context2d.hasOwnProperty(n)&&(this.pdf.context2d[n]=a[n]);return this.pdf.context2d._canvas=this,this.pdf.context2d},e.prototype.toDataURL=function(){throw new Error("toDataURL is not implemented.")},s.events.push(["initialized",function(){this.canvas=new e,this.canvas.pdf=this}])}(Dt.API),function(s){var e={left:0,top:0,bottom:0,right:0},r=!1,a=function(){this.internal.__cell__===void 0&&(this.internal.__cell__={},this.internal.__cell__.padding=3,this.internal.__cell__.headerFunction=void 0,this.internal.__cell__.margins=Object.assign({},e),this.internal.__cell__.margins.width=this.getPageWidth(),n.call(this))},n=function(){this.internal.__cell__.lastCell=new i,this.internal.__cell__.pages=1},i=function(){var c=arguments[0];Object.defineProperty(this,"x",{enumerable:!0,get:function(){return c},set:function(b){c=b}});var A=arguments[1];Object.defineProperty(this,"y",{enumerable:!0,get:function(){return A},set:function(b){A=b}});var d=arguments[2];Object.defineProperty(this,"width",{enumerable:!0,get:function(){return d},set:function(b){d=b}});var h=arguments[3];Object.defineProperty(this,"height",{enumerable:!0,get:function(){return h},set:function(b){h=b}});var f=arguments[4];Object.defineProperty(this,"text",{enumerable:!0,get:function(){return f},set:function(b){f=b}});var u=arguments[5];Object.defineProperty(this,"lineNumber",{enumerable:!0,get:function(){return u},set:function(b){u=b}});var x=arguments[6];return Object.defineProperty(this,"align",{enumerable:!0,get:function(){return x},set:function(b){x=b}}),this};i.prototype.clone=function(){return new i(this.x,this.y,this.width,this.height,this.text,this.lineNumber,this.align)},i.prototype.toArray=function(){return[this.x,this.y,this.width,this.height,this.text,this.lineNumber,this.align]},s.setHeaderFunction=function(c){return a.call(this),this.internal.__cell__.headerFunction=typeof c=="function"?c:void 0,this},s.getTextDimensions=function(c,A){a.call(this);var d=(A=A||{}).fontSize||this.getFontSize(),h=A.font||this.getFont(),f=A.scaleFactor||this.internal.scaleFactor,u=0,x=0,b=0,N=this;if(!Array.isArray(c)&&typeof c!="string"){if(typeof c!="number")throw new Error("getTextDimensions expects text-parameter to be of type String or type Number or an Array of Strings.");c=String(c)}var v=A.maxWidth;v>0?typeof c=="string"?c=this.splitTextToSize(c,v):Object.prototype.toString.call(c)==="[object Array]"&&(c=c.reduce(function(I,C){return I.concat(N.splitTextToSize(C,v))},[])):c=Array.isArray(c)?c:[c];for(var j=0;j<c.length;j++)u<(b=this.getStringUnitWidth(c[j],{font:h})*d)&&(u=b);return u!==0&&(x=c.length),{w:u/=f,h:Math.max((x*d*this.getLineHeightFactor()-d*(this.getLineHeightFactor()-1))/f,0)}},s.cellAddPage=function(){a.call(this),this.addPage();var c=this.internal.__cell__.margins||e;return this.internal.__cell__.lastCell=new i(c.left,c.top,void 0,void 0),this.internal.__cell__.pages+=1,this};var o=s.cell=function(){var c;c=arguments[0]instanceof i?arguments[0]:new i(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6]),a.call(this);var A=this.internal.__cell__.lastCell,d=this.internal.__cell__.padding,h=this.internal.__cell__.margins||e,f=this.internal.__cell__.tableHeaderRow,u=this.internal.__cell__.printHeaders;return A.lineNumber!==void 0&&(A.lineNumber===c.lineNumber?(c.x=(A.x||0)+(A.width||0),c.y=A.y||0):A.y+A.height+c.height+h.bottom>this.getPageHeight()?(this.cellAddPage(),c.y=h.top,u&&f&&(this.printHeaderRow(c.lineNumber,!0),c.y+=f[0].height)):c.y=A.y+A.height||c.y),c.text[0]!==void 0&&(this.rect(c.x,c.y,c.width,c.height,r===!0?"FD":void 0),c.align==="right"?this.text(c.text,c.x+c.width-d,c.y+d,{align:"right",baseline:"top"}):c.align==="center"?this.text(c.text,c.x+c.width/2,c.y+d,{align:"center",baseline:"top",maxWidth:c.width-d-d}):this.text(c.text,c.x+d,c.y+d,{align:"left",baseline:"top",maxWidth:c.width-d-d})),this.internal.__cell__.lastCell=c,this};s.table=function(c,A,d,h,f){if(a.call(this),!d)throw new Error("No data for PDF table.");var u,x,b,N,v=[],j=[],I=[],C={},E={},T=[],Q=[],D=(f=f||{}).autoSize||!1,k=f.printHeaders!==!1,R=f.css&&f.css["font-size"]!==void 0?16*f.css["font-size"]:f.fontSize||12,w=f.margins||Object.assign({width:this.getPageWidth()},e),L=typeof f.padding=="number"?f.padding:3,M=f.headerBackgroundColor||"#c8c8c8",P=f.headerTextColor||"#000";if(n.call(this),this.internal.__cell__.printHeaders=k,this.internal.__cell__.margins=w,this.internal.__cell__.table_font_size=R,this.internal.__cell__.padding=L,this.internal.__cell__.headerBackgroundColor=M,this.internal.__cell__.headerTextColor=P,this.setFontSize(R),h==null)j=v=Object.keys(d[0]),I=v.map(function(){return"left"});else if(Array.isArray(h)&&Rs(h[0])==="object")for(v=h.map(function(V){return V.name}),j=h.map(function(V){return V.prompt||V.name||""}),I=h.map(function(V){return V.align||"left"}),u=0;u<h.length;u+=1)E[h[u].name]=.7499990551181103*h[u].width;else Array.isArray(h)&&typeof h[0]=="string"&&(j=v=h,I=v.map(function(){return"left"}));if(D||Array.isArray(h)&&typeof h[0]=="string")for(u=0;u<v.length;u+=1){for(C[N=v[u]]=d.map(function(V){return V[N]}),this.setFont(void 0,"bold"),T.push(this.getTextDimensions(j[u],{fontSize:this.internal.__cell__.table_font_size,scaleFactor:this.internal.scaleFactor}).w),x=C[N],this.setFont(void 0,"normal"),b=0;b<x.length;b+=1)T.push(this.getTextDimensions(x[b],{fontSize:this.internal.__cell__.table_font_size,scaleFactor:this.internal.scaleFactor}).w);E[N]=Math.max.apply(null,T)+L+L,T=[]}if(k){var K={};for(u=0;u<v.length;u+=1)K[v[u]]={},K[v[u]].text=j[u],K[v[u]].align=I[u];var $=l.call(this,K,E);Q=v.map(function(V){return new i(c,A,E[V],$,K[V].text,void 0,K[V].align)}),this.setTableHeaderRow(Q),this.printHeaderRow(1,!1)}var O=h.reduce(function(V,q){return V[q.name]=q.align,V},{});for(u=0;u<d.length;u+=1){"rowStart"in f&&f.rowStart instanceof Function&&f.rowStart({row:u,data:d[u]},this);var W=l.call(this,d[u],E);for(b=0;b<v.length;b+=1){var ee=d[u][v[b]];"cellStart"in f&&f.cellStart instanceof Function&&f.cellStart({row:u,col:b,data:ee},this),o.call(this,new i(c,A,E[v[b]],W,ee,u+2,O[v[b]]))}}return this.internal.__cell__.table_x=c,this.internal.__cell__.table_y=A,this};var l=function(c,A){var d=this.internal.__cell__.padding,h=this.internal.__cell__.table_font_size,f=this.internal.scaleFactor;return Object.keys(c).map(function(u){var x=c[u];return this.splitTextToSize(x.hasOwnProperty("text")?x.text:x,A[u]-d-d)},this).map(function(u){return this.getLineHeightFactor()*u.length*h/f+d+d},this).reduce(function(u,x){return Math.max(u,x)},0)};s.setTableHeaderRow=function(c){a.call(this),this.internal.__cell__.tableHeaderRow=c},s.printHeaderRow=function(c,A){if(a.call(this),!this.internal.__cell__.tableHeaderRow)throw new Error("Property tableHeaderRow does not exist.");var d;if(r=!0,typeof this.internal.__cell__.headerFunction=="function"){var h=this.internal.__cell__.headerFunction(this,this.internal.__cell__.pages);this.internal.__cell__.lastCell=new i(h[0],h[1],h[2],h[3],void 0,-1)}this.setFont(void 0,"bold");for(var f=[],u=0;u<this.internal.__cell__.tableHeaderRow.length;u+=1){d=this.internal.__cell__.tableHeaderRow[u].clone(),A&&(d.y=this.internal.__cell__.margins.top||0,f.push(d)),d.lineNumber=c;var x=this.getTextColor();this.setTextColor(this.internal.__cell__.headerTextColor),this.setFillColor(this.internal.__cell__.headerBackgroundColor),o.call(this,d),this.setTextColor(x)}f.length>0&&this.setTableHeaderRow(f),this.setFont(void 0,"normal"),r=!1}}(Dt.API);var n1={italic:["italic","oblique","normal"],oblique:["oblique","italic","normal"],normal:["normal","oblique","italic"]},i1=["ultra-condensed","extra-condensed","condensed","semi-condensed","normal","semi-expanded","expanded","extra-expanded","ultra-expanded"],yp=a1(i1),o1=[100,200,300,400,500,600,700,800,900],RU=a1(o1);function Ch(s){var e=s.family.replace(/"|'/g,"").toLowerCase(),r=function(i){return n1[i=i||"normal"]?i:"normal"}(s.style),a=function(i){return i?typeof i=="number"?i>=100&&i<=900&&i%100==0?i:400:/^\d00$/.test(i)?parseInt(i):i==="bold"?700:400:400}(s.weight),n=function(i){return typeof yp[i=i||"normal"]=="number"?i:"normal"}(s.stretch);return{family:e,style:r,weight:a,stretch:n,src:s.src||[],ref:s.ref||{name:e,style:[n,r,a].join(" ")}}}function Zx(s,e,r,a){var n;for(n=r;n>=0&&n<e.length;n+=a)if(s[e[n]])return s[e[n]];for(n=r;n>=0&&n<e.length;n-=a)if(s[e[n]])return s[e[n]]}var MU={"sans-serif":"helvetica",fixed:"courier",monospace:"courier",terminal:"courier",cursive:"times",fantasy:"times",serif:"times"},ey={caption:"times",icon:"times",menu:"times","message-box":"times","small-caption":"times","status-bar":"times"};function ty(s){return[s.stretch,s.style,s.weight,s.family].join(" ")}function sy(s){return s.trimLeft()}function _U(s,e){for(var r=0;r<s.length;){if(s.charAt(r)===e)return[s.substring(0,r),s.substring(r+1)];r+=1}return null}function QU(s){var e=s.match(/^(-[a-z_]|[a-z_])[a-z0-9_-]*/i);return e===null?null:[e[0],s.substring(e[0].length)]}var $d,ry,ay,Pl,Kd,ny,iy,oy,Nh=["times"];function ly(s,e,r,a,n){var i=4,o=Ay;switch(n){case Dt.API.image_compression.FAST:i=1,o=cy;break;case Dt.API.image_compression.MEDIUM:i=6,o=dy;break;case Dt.API.image_compression.SLOW:i=9,o=uy}s=function(c,A,d,h){for(var f,u=c.length/A,x=new Uint8Array(c.length+u),b=[OU,cy,Ay,dy,uy],N=0;N<u;N+=1){var v=N*A,j=c.subarray(v,v+A);if(h)x.set(h(j,d,f),v+N);else{for(var I=b.length,C=[],E=0;E<I;E+=1)C[E]=b[E](j,d,f);var T=VU(C.concat());x.set(C[T],v+N)}f=j}return x}(s,e,Math.ceil(r*a/8),o);var l=up(s,{level:i});return Dt.API.__addimage__.arrayBufferToBinaryString(l)}function OU(s){var e=Array.apply([],s);return e.unshift(0),e}function cy(s,e){var r=s.length,a=[];a[0]=1;for(var n=0;n<r;n+=1){var i=s[n-e]||0;a[n+1]=s[n]-i+256&255}return a}function Ay(s,e,r){var a=s.length,n=[];n[0]=2;for(var i=0;i<a;i+=1){var o=r&&r[i]||0;n[i+1]=s[i]-o+256&255}return n}function dy(s,e,r){var a=s.length,n=[];n[0]=3;for(var i=0;i<a;i+=1){var o=s[i-e]||0,l=r&&r[i]||0;n[i+1]=s[i]+256-(o+l>>>1)&255}return n}function uy(s,e,r){var a=s.length,n=[];n[0]=4;for(var i=0;i<a;i+=1){var o=HU(s[i-e]||0,r&&r[i]||0,r&&r[i-e]||0);n[i+1]=s[i]-o+256&255}return n}function HU(s,e,r){if(s===e&&e===r)return s;var a=Math.abs(e-r),n=Math.abs(s-r),i=Math.abs(s+e-r-r);return a<=n&&a<=i?s:n<=i?e:r}function VU(s){var e=s.map(function(r){return r.reduce(function(a,n){return a+Math.abs(n)},0)});return e.indexOf(Math.min.apply(null,e))}function Bh(s,e,r){var a=e*r,n=Math.floor(a/8),i=16-(a-8*n+r),o=(1<<r)-1;return l1(s,n)>>i&o}function my(s,e,r,a){var n=r*a,i=Math.floor(n/8),o=16-(n-8*i+a),l=(1<<a)-1,c=(e&l)<<o;(function(A,d,h){if(d+1<A.byteLength)A.setUint16(d,h,!1);else{var f=h>>8&255;A.setUint8(d,f)}})(s,i,l1(s,i)&~(l<<o)&65535|c)}function l1(s,e){return e+1<s.byteLength?s.getUint16(e,!1):s.getUint8(e)<<8}function $U(s){var e=0;if(s[e++]!==71||s[e++]!==73||s[e++]!==70||s[e++]!==56||(s[e++]+1&253)!=56||s[e++]!==97)throw new Error("Invalid GIF 87a/89a header.");var r=s[e++]|s[e++]<<8,a=s[e++]|s[e++]<<8,n=s[e++],i=n>>7,o=1<<1+(7&n);s[e++],s[e++];var l=null,c=null;i&&(l=e,c=o,e+=3*o);var A=!0,d=[],h=0,f=null,u=0,x=null;for(this.width=r,this.height=a;A&&e<s.length;)switch(s[e++]){case 33:switch(s[e++]){case 255:if(s[e]!==11||s[e+1]==78&&s[e+2]==69&&s[e+3]==84&&s[e+4]==83&&s[e+5]==67&&s[e+6]==65&&s[e+7]==80&&s[e+8]==69&&s[e+9]==50&&s[e+10]==46&&s[e+11]==48&&s[e+12]==3&&s[e+13]==1&&s[e+16]==0)e+=14,x=s[e++]|s[e++]<<8,e++;else for(e+=12;;){if(!((w=s[e++])>=0))throw Error("Invalid block size");if(w===0)break;e+=w}break;case 249:if(s[e++]!==4||s[e+4]!==0)throw new Error("Invalid graphics extension block.");var b=s[e++];h=s[e++]|s[e++]<<8,f=s[e++],1&b||(f=null),u=b>>2&7,e++;break;case 254:for(;;){if(!((w=s[e++])>=0))throw Error("Invalid block size");if(w===0)break;e+=w}break;default:throw new Error("Unknown graphic control label: 0x"+s[e-1].toString(16))}break;case 44:var N=s[e++]|s[e++]<<8,v=s[e++]|s[e++]<<8,j=s[e++]|s[e++]<<8,I=s[e++]|s[e++]<<8,C=s[e++],E=C>>6&1,T=1<<1+(7&C),Q=l,D=c,k=!1;C>>7&&(k=!0,Q=e,D=T,e+=3*T);var R=e;for(e++;;){var w;if(!((w=s[e++])>=0))throw Error("Invalid block size");if(w===0)break;e+=w}d.push({x:N,y:v,width:j,height:I,has_local_palette:k,palette_offset:Q,palette_size:D,data_offset:R,data_length:e-R,transparent_index:f,interlaced:!!E,delay:h,disposal:u});break;case 59:A=!1;break;default:throw new Error("Unknown gif block: 0x"+s[e-1].toString(16))}this.numFrames=function(){return d.length},this.loopCount=function(){return x},this.frameInfo=function(L){if(L<0||L>=d.length)throw new Error("Frame index out of range.");return d[L]},this.decodeAndBlitFrameBGRA=function(L,M){var P=this.frameInfo(L),K=P.width*P.height,$=new Uint8Array(K);hy(s,P.data_offset,$,K);var O=P.palette_offset,W=P.transparent_index;W===null&&(W=256);var ee=P.width,V=r-ee,q=ee,S=4*(P.y*r+P.x),H=4*((P.y+P.height)*r+P.x),Y=S,te=4*V;P.interlaced===!0&&(te+=4*r*7);for(var G=8,X=0,le=$.length;X<le;++X){var he=$[X];if(q===0&&(q=ee,(Y+=te)>=H&&(te=4*V+4*r*(G-1),Y=S+(ee+V)*(G<<1),G>>=1)),he===W)Y+=4;else{var ve=s[O+3*he],ke=s[O+3*he+1],Le=s[O+3*he+2];M[Y++]=Le,M[Y++]=ke,M[Y++]=ve,M[Y++]=255}--q}},this.decodeAndBlitFrameRGBA=function(L,M){var P=this.frameInfo(L),K=P.width*P.height,$=new Uint8Array(K);hy(s,P.data_offset,$,K);var O=P.palette_offset,W=P.transparent_index;W===null&&(W=256);var ee=P.width,V=r-ee,q=ee,S=4*(P.y*r+P.x),H=4*((P.y+P.height)*r+P.x),Y=S,te=4*V;P.interlaced===!0&&(te+=4*r*7);for(var G=8,X=0,le=$.length;X<le;++X){var he=$[X];if(q===0&&(q=ee,(Y+=te)>=H&&(te=4*V+4*r*(G-1),Y=S+(ee+V)*(G<<1),G>>=1)),he===W)Y+=4;else{var ve=s[O+3*he],ke=s[O+3*he+1],Le=s[O+3*he+2];M[Y++]=ve,M[Y++]=ke,M[Y++]=Le,M[Y++]=255}--q}}}function hy(s,e,r,a){for(var n=s[e++],i=1<<n,o=i+1,l=o+1,c=n+1,A=(1<<c)-1,d=0,h=0,f=0,u=s[e++],x=new Int32Array(4096),b=null;;){for(;d<16&&u!==0;)h|=s[e++]<<d,d+=8,u===1?u=s[e++]:--u;if(d<c)break;var N=h&A;if(h>>=c,d-=c,N!==i){if(N===o)break;for(var v=N<l?N:b,j=0,I=v;I>i;)I=x[I]>>8,++j;var C=I;if(f+j+(v!==N?1:0)>a)return void Gs.log("Warning, gif stream longer than expected.");r[f++]=C;var E=f+=j;for(v!==N&&(r[f++]=C),I=v;j--;)I=x[I],r[--E]=255&I,I>>=8;b!==null&&l<4096&&(x[l++]=b<<8|C,l>=A+1&&c<12&&(++c,A=A<<1|1)),b=N}else l=o+1,A=(1<<(c=n+1))-1,b=null}return f!==a&&Gs.log("Warning, gif stream shorter than expected."),r}function Sh(s){var e,r,a,n,i,o=Math.floor,l=new Array(64),c=new Array(64),A=new Array(64),d=new Array(64),h=new Array(65535),f=new Array(65535),u=new Array(64),x=new Array(64),b=[],N=0,v=7,j=new Array(64),I=new Array(64),C=new Array(64),E=new Array(256),T=new Array(2048),Q=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],D=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],k=[0,1,2,3,4,5,6,7,8,9,10,11],R=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],w=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],L=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],M=[0,1,2,3,4,5,6,7,8,9,10,11],P=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],K=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];function $(S,H){for(var Y=0,te=0,G=new Array,X=1;X<=16;X++){for(var le=1;le<=S[X];le++)G[H[te]]=[],G[H[te]][0]=Y,G[H[te]][1]=X,te++,Y++;Y*=2}return G}function O(S){for(var H=S[0],Y=S[1]-1;Y>=0;)H&1<<Y&&(N|=1<<v),Y--,--v<0&&(N==255?(W(255),W(0)):W(N),v=7,N=0)}function W(S){b.push(S)}function ee(S){W(S>>8&255),W(255&S)}function V(S,H,Y,te,G){for(var X,le=G[0],he=G[240],ve=function(ce,Ie){var pe,fe,we,de,xe,Ne,it,st,$e,Xe,Ze=0;for($e=0;$e<8;++$e){pe=ce[Ze],fe=ce[Ze+1],we=ce[Ze+2],de=ce[Ze+3],xe=ce[Ze+4],Ne=ce[Ze+5],it=ce[Ze+6];var ct=pe+(st=ce[Ze+7]),pt=pe-st,dt=fe+it,xt=fe-it,Se=we+Ne,qe=we-Ne,ut=de+xe,Ge=de-xe,rt=ct+ut,Tt=ct-ut,At=dt+Se,mt=dt-Se;ce[Ze]=rt+At,ce[Ze+4]=rt-At;var Qt=.707106781*(mt+Tt);ce[Ze+2]=Tt+Qt,ce[Ze+6]=Tt-Qt;var ts=.382683433*((rt=Ge+qe)-(mt=xt+pt)),Yt=.5411961*rt+ts,Ht=1.306562965*mt+ts,Es=.707106781*(At=qe+xt),vt=pt+Es,Ft=pt-Es;ce[Ze+5]=Ft+Yt,ce[Ze+3]=Ft-Yt,ce[Ze+1]=vt+Ht,ce[Ze+7]=vt-Ht,Ze+=8}for(Ze=0,$e=0;$e<8;++$e){pe=ce[Ze],fe=ce[Ze+8],we=ce[Ze+16],de=ce[Ze+24],xe=ce[Ze+32],Ne=ce[Ze+40],it=ce[Ze+48];var Hs=pe+(st=ce[Ze+56]),ks=pe-st,Is=fe+it,Nt=fe-it,gs=we+Ne,Vt=we-Ne,Kr=de+xe,Kt=de-xe,Js=Hs+Kr,fs=Hs-Kr,Zs=Is+gs,Ot=Is-gs;ce[Ze]=Js+Zs,ce[Ze+32]=Js-Zs;var qt=.707106781*(Ot+fs);ce[Ze+16]=fs+qt,ce[Ze+48]=fs-qt;var ur=.382683433*((Js=Kt+Vt)-(Ot=Nt+ks)),kr=.5411961*Js+ur,Zr=1.306562965*Ot+ur,Qa=.707106781*(Zs=Vt+Nt),Oa=ks+Qa,tn=ks-Qa;ce[Ze+40]=tn+kr,ce[Ze+24]=tn-kr,ce[Ze+8]=Oa+Zr,ce[Ze+56]=Oa-Zr,Ze++}for($e=0;$e<64;++$e)Xe=ce[$e]*Ie[$e],u[$e]=Xe>0?Xe+.5|0:Xe-.5|0;return u}(S,H),ke=0;ke<64;++ke)x[Q[ke]]=ve[ke];var Le=x[0]-Y;Y=x[0],Le==0?O(te[0]):(O(te[f[X=32767+Le]]),O(h[X]));for(var Be=63;Be>0&&x[Be]==0;)Be--;if(Be==0)return O(le),Y;for(var Re,re=1;re<=Be;){for(var Me=re;x[re]==0&&re<=Be;)++re;var Pe=re-Me;if(Pe>=16){Re=Pe>>4;for(var be=1;be<=Re;++be)O(he);Pe&=15}X=32767+x[re],O(G[(Pe<<4)+f[X]]),O(h[X]),re++}return Be!=63&&O(le),Y}function q(S){S=Math.min(Math.max(S,1),100),i!=S&&(function(H){for(var Y=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],te=0;te<64;te++){var G=o((Y[te]*H+50)/100);G=Math.min(Math.max(G,1),255),l[Q[te]]=G}for(var X=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],le=0;le<64;le++){var he=o((X[le]*H+50)/100);he=Math.min(Math.max(he,1),255),c[Q[le]]=he}for(var ve=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],ke=0,Le=0;Le<8;Le++)for(var Be=0;Be<8;Be++)A[ke]=1/(l[Q[ke]]*ve[Le]*ve[Be]*8),d[ke]=1/(c[Q[ke]]*ve[Le]*ve[Be]*8),ke++}(S<50?Math.floor(5e3/S):Math.floor(200-2*S)),i=S)}this.encode=function(S,H){H&&q(H),b=new Array,N=0,v=7,ee(65496),ee(65504),ee(16),W(74),W(70),W(73),W(70),W(0),W(1),W(1),W(0),ee(1),ee(1),W(0),W(0),function(){ee(65499),ee(132),W(0);for(var fe=0;fe<64;fe++)W(l[fe]);W(1);for(var we=0;we<64;we++)W(c[we])}(),function(fe,we){ee(65472),ee(17),W(8),ee(we),ee(fe),W(3),W(1),W(17),W(0),W(2),W(17),W(1),W(3),W(17),W(1)}(S.width,S.height),function(){ee(65476),ee(418),W(0);for(var fe=0;fe<16;fe++)W(D[fe+1]);for(var we=0;we<=11;we++)W(k[we]);W(16);for(var de=0;de<16;de++)W(R[de+1]);for(var xe=0;xe<=161;xe++)W(w[xe]);W(1);for(var Ne=0;Ne<16;Ne++)W(L[Ne+1]);for(var it=0;it<=11;it++)W(M[it]);W(17);for(var st=0;st<16;st++)W(P[st+1]);for(var $e=0;$e<=161;$e++)W(K[$e])}(),ee(65498),ee(12),W(3),W(1),W(0),W(2),W(17),W(3),W(17),W(0),W(63),W(0);var Y=0,te=0,G=0;N=0,v=7,this.encode.displayName="_encode_";for(var X,le,he,ve,ke,Le,Be,Re,re,Me=S.data,Pe=S.width,be=S.height,ce=4*Pe,Ie=0;Ie<be;){for(X=0;X<ce;){for(ke=ce*Ie+X,Be=-1,Re=0,re=0;re<64;re++)Le=ke+(Re=re>>3)*ce+(Be=4*(7&re)),Ie+Re>=be&&(Le-=ce*(Ie+1+Re-be)),X+Be>=ce&&(Le-=X+Be-ce+4),le=Me[Le++],he=Me[Le++],ve=Me[Le++],j[re]=(T[le]+T[he+256|0]+T[ve+512|0]>>16)-128,I[re]=(T[le+768|0]+T[he+1024|0]+T[ve+1280|0]>>16)-128,C[re]=(T[le+1280|0]+T[he+1536|0]+T[ve+1792|0]>>16)-128;Y=V(j,A,Y,e,a),te=V(I,d,te,r,n),G=V(C,d,G,r,n),X+=32}Ie+=8}if(v>=0){var pe=[];pe[1]=v+1,pe[0]=(1<<v+1)-1,O(pe)}return ee(65497),new Uint8Array(b)},s=s||50,function(){for(var S=String.fromCharCode,H=0;H<256;H++)E[H]=S(H)}(),e=$(D,k),r=$(L,M),a=$(R,w),n=$(P,K),function(){for(var S=1,H=2,Y=1;Y<=15;Y++){for(var te=S;te<H;te++)f[32767+te]=Y,h[32767+te]=[],h[32767+te][1]=Y,h[32767+te][0]=te;for(var G=-(H-1);G<=-S;G++)f[32767+G]=Y,h[32767+G]=[],h[32767+G][1]=Y,h[32767+G][0]=H-1+G;S<<=1,H<<=1}}(),function(){for(var S=0;S<256;S++)T[S]=19595*S,T[S+256|0]=38470*S,T[S+512|0]=7471*S+32768,T[S+768|0]=-11059*S,T[S+1024|0]=-21709*S,T[S+1280|0]=32768*S+8421375,T[S+1536|0]=-27439*S,T[S+1792|0]=-5329*S}(),q(s)}function Gn(s,e){if(this.pos=0,this.buffer=s,this.datav=new DataView(s.buffer),this.is_with_alpha=!!e,this.bottom_up=!0,this.flag=String.fromCharCode(this.buffer[0])+String.fromCharCode(this.buffer[1]),this.pos+=2,["BM","BA","CI","CP","IC","PT"].indexOf(this.flag)===-1)throw new Error("Invalid BMP File");this.parseHeader(),this.parseBGR()}function py(s){function e(k){if(!k)throw Error("assert :P")}function r(k,R,w){for(var L=0;4>L;L++)if(k[R+L]!=w.charCodeAt(L))return!0;return!1}function a(k,R,w,L,M){for(var P=0;P<M;P++)k[R+P]=w[L+P]}function n(k,R,w,L){for(var M=0;M<L;M++)k[R+M]=w}function i(k){return new Int32Array(k)}function o(k,R){for(var w=[],L=0;L<k;L++)w.push(new R);return w}function l(k,R){var w=[];return function L(M,P,K){for(var $=K[P],O=0;O<$&&(M.push(K.length>P+1?[]:new R),!(K.length<P+1));O++)L(M[O],P+1,K)}(w,0,k),w}var c=function(){var k=this;function R(p,y){for(var F=1<<y-1>>>0;p&F;)F>>>=1;return F?(p&F-1)+F:p}function w(p,y,F,_,Z){e(!(_%F));do p[y+(_-=F)]=Z;while(0<_)}function L(p,y,F,_,Z){if(e(2328>=Z),512>=Z)var se=i(512);else if((se=i(Z))==null)return 0;return function(ae,oe,Ae,ue,Ce,De){var me,Ee,Fe=oe,He=1<<Ae,Ue=i(16),Ve=i(16);for(e(Ce!=0),e(ue!=null),e(ae!=null),e(0<Ae),Ee=0;Ee<Ce;++Ee){if(15<ue[Ee])return 0;++Ue[ue[Ee]]}if(Ue[0]==Ce)return 0;for(Ve[1]=0,me=1;15>me;++me){if(Ue[me]>1<<me)return 0;Ve[me+1]=Ve[me]+Ue[me]}for(Ee=0;Ee<Ce;++Ee)me=ue[Ee],0<ue[Ee]&&(De[Ve[me]++]=Ee);if(Ve[15]==1)return(ue=new M).g=0,ue.value=De[0],w(ae,Fe,1,He,ue),He;var Ke,tt=-1,Je=He-1,Lt=0,jt=1,ss=1,Pt=1<<Ae;for(Ee=0,me=1,Ce=2;me<=Ae;++me,Ce<<=1){if(jt+=ss<<=1,0>(ss-=Ue[me]))return 0;for(;0<Ue[me];--Ue[me])(ue=new M).g=me,ue.value=De[Ee++],w(ae,Fe+Lt,Ce,Pt,ue),Lt=R(Lt,me)}for(me=Ae+1,Ce=2;15>=me;++me,Ce<<=1){if(jt+=ss<<=1,0>(ss-=Ue[me]))return 0;for(;0<Ue[me];--Ue[me]){if(ue=new M,(Lt&Je)!=tt){for(Fe+=Pt,Ke=1<<(tt=me)-Ae;15>tt&&!(0>=(Ke-=Ue[tt]));)++tt,Ke<<=1;He+=Pt=1<<(Ke=tt-Ae),ae[oe+(tt=Lt&Je)].g=Ke+Ae,ae[oe+tt].value=Fe-oe-tt}ue.g=me-Ae,ue.value=De[Ee++],w(ae,Fe+(Lt>>Ae),Ce,Pt,ue),Lt=R(Lt,me)}}return jt!=2*Ve[15]-1?0:He}(p,y,F,_,Z,se)}function M(){this.value=this.g=0}function P(){this.value=this.g=0}function K(){this.G=o(5,M),this.H=i(5),this.jc=this.Qb=this.qb=this.nd=0,this.pd=o(ga,P)}function $(p,y,F,_){e(p!=null),e(y!=null),e(2147483648>_),p.Ca=254,p.I=0,p.b=-8,p.Ka=0,p.oa=y,p.pa=F,p.Jd=y,p.Yc=F+_,p.Zc=4<=_?F+_-4+1:F,le(p)}function O(p,y){for(var F=0;0<y--;)F|=ve(p,128)<<y;return F}function W(p,y){var F=O(p,y);return he(p)?-F:F}function ee(p,y,F,_){var Z,se=0;for(e(p!=null),e(y!=null),e(4294967288>_),p.Sb=_,p.Ra=0,p.u=0,p.h=0,4<_&&(_=4),Z=0;Z<_;++Z)se+=y[F+Z]<<8*Z;p.Ra=se,p.bb=_,p.oa=y,p.pa=F}function V(p){for(;8<=p.u&&p.bb<p.Sb;)p.Ra>>>=8,p.Ra+=p.oa[p.pa+p.bb]<<Hn-8>>>0,++p.bb,p.u-=8;te(p)&&(p.h=1,p.u=0)}function q(p,y){if(e(0<=y),!p.h&&y<=Ns){var F=Y(p)&rr[y];return p.u+=y,V(p),F}return p.h=1,p.u=0}function S(){this.b=this.Ca=this.I=0,this.oa=[],this.pa=0,this.Jd=[],this.Yc=0,this.Zc=[],this.Ka=0}function H(){this.Ra=0,this.oa=[],this.h=this.u=this.bb=this.Sb=this.pa=0}function Y(p){return p.Ra>>>(p.u&Hn-1)>>>0}function te(p){return e(p.bb<=p.Sb),p.h||p.bb==p.Sb&&p.u>Hn}function G(p,y){p.u=y,p.h=te(p)}function X(p){p.u>=Nn&&(e(p.u>=Nn),V(p))}function le(p){e(p!=null&&p.oa!=null),p.pa<p.Zc?(p.I=(p.oa[p.pa++]|p.I<<8)>>>0,p.b+=8):(e(p!=null&&p.oa!=null),p.pa<p.Yc?(p.b+=8,p.I=p.oa[p.pa++]|p.I<<8):p.Ka?p.b=0:(p.I<<=8,p.b+=8,p.Ka=1))}function he(p){return O(p,1)}function ve(p,y){var F=p.Ca;0>p.b&&le(p);var _=p.b,Z=F*y>>>8,se=(p.I>>>_>Z)+0;for(se?(F-=Z,p.I-=Z+1<<_>>>0):F=Z+1,_=F,Z=0;256<=_;)Z+=8,_>>=8;return _=7^Z+Ai[_],p.b-=_,p.Ca=(F<<_)-1,se}function ke(p,y,F){p[y+0]=F>>24&255,p[y+1]=F>>16&255,p[y+2]=F>>8&255,p[y+3]=255&F}function Le(p,y){return p[y+0]|p[y+1]<<8}function Be(p,y){return Le(p,y)|p[y+2]<<16}function Re(p,y){return Le(p,y)|Le(p,y+2)<<16}function re(p,y){var F=1<<y;return e(p!=null),e(0<y),p.X=i(F),p.X==null?0:(p.Mb=32-y,p.Xa=y,1)}function Me(p,y){e(p!=null),e(y!=null),e(p.Xa==y.Xa),a(y.X,0,p.X,0,1<<y.Xa)}function Pe(){this.X=[],this.Xa=this.Mb=0}function be(p,y,F,_){e(F!=null),e(_!=null);var Z=F[0],se=_[0];return Z==0&&(Z=(p*se+y/2)/y),se==0&&(se=(y*Z+p/2)/p),0>=Z||0>=se?0:(F[0]=Z,_[0]=se,1)}function ce(p,y){return p+(1<<y)-1>>>y}function Ie(p,y){return((4278255360&p)+(4278255360&y)>>>0&4278255360)+((16711935&p)+(16711935&y)>>>0&16711935)>>>0}function pe(p,y){k[y]=function(F,_,Z,se,ae,oe,Ae){var ue;for(ue=0;ue<ae;++ue){var Ce=k[p](oe[Ae+ue-1],Z,se+ue);oe[Ae+ue]=Ie(F[_+ue],Ce)}}}function fe(){this.ud=this.hd=this.jd=0}function we(p,y){return((4278124286&(p^y))>>>1)+(p&y)>>>0}function de(p){return 0<=p&&256>p?p:0>p?0:255<p?255:void 0}function xe(p,y){return de(p+(p-y+.5>>1))}function Ne(p,y,F){return Math.abs(y-F)-Math.abs(p-F)}function it(p,y,F,_,Z,se,ae){for(_=se[ae-1],F=0;F<Z;++F)se[ae+F]=_=Ie(p[y+F],_)}function st(p,y,F,_,Z){var se;for(se=0;se<F;++se){var ae=p[y+se],oe=ae>>8&255,Ae=16711935&(Ae=(Ae=16711935&ae)+((oe<<16)+oe));_[Z+se]=(4278255360&ae)+Ae>>>0}}function $e(p,y){y.jd=255&p,y.hd=p>>8&255,y.ud=p>>16&255}function Xe(p,y,F,_,Z,se){var ae;for(ae=0;ae<_;++ae){var oe=y[F+ae],Ae=oe>>>8,ue=oe,Ce=255&(Ce=(Ce=oe>>>16)+((p.jd<<24>>24)*(Ae<<24>>24)>>>5));ue=255&(ue=(ue+=(p.hd<<24>>24)*(Ae<<24>>24)>>>5)+((p.ud<<24>>24)*(Ce<<24>>24)>>>5)),Z[se+ae]=(4278255360&oe)+(Ce<<16)+ue}}function Ze(p,y,F,_,Z){k[y]=function(se,ae,oe,Ae,ue,Ce,De,me,Ee){for(Ae=De;Ae<me;++Ae)for(De=0;De<Ee;++De)ue[Ce++]=Z(oe[_(se[ae++])])},k[p]=function(se,ae,oe,Ae,ue,Ce,De){var me=8>>se.b,Ee=se.Ea,Fe=se.K[0],He=se.w;if(8>me)for(se=(1<<se.b)-1,He=(1<<me)-1;ae<oe;++ae){var Ue,Ve=0;for(Ue=0;Ue<Ee;++Ue)Ue&se||(Ve=_(Ae[ue++])),Ce[De++]=Z(Fe[Ve&He]),Ve>>=me}else k["VP8LMapColor"+F](Ae,ue,Fe,He,Ce,De,ae,oe,Ee)}}function ct(p,y,F,_,Z){for(F=y+F;y<F;){var se=p[y++];_[Z++]=se>>16&255,_[Z++]=se>>8&255,_[Z++]=255&se}}function pt(p,y,F,_,Z){for(F=y+F;y<F;){var se=p[y++];_[Z++]=se>>16&255,_[Z++]=se>>8&255,_[Z++]=255&se,_[Z++]=se>>24&255}}function dt(p,y,F,_,Z){for(F=y+F;y<F;){var se=(ae=p[y++])>>16&240|ae>>12&15,ae=240&ae|ae>>28&15;_[Z++]=se,_[Z++]=ae}}function xt(p,y,F,_,Z){for(F=y+F;y<F;){var se=(ae=p[y++])>>16&248|ae>>13&7,ae=ae>>5&224|ae>>3&31;_[Z++]=se,_[Z++]=ae}}function Se(p,y,F,_,Z){for(F=y+F;y<F;){var se=p[y++];_[Z++]=255&se,_[Z++]=se>>8&255,_[Z++]=se>>16&255}}function qe(p,y,F,_,Z,se){if(se==0)for(F=y+F;y<F;)ke(_,((se=p[y++])[0]>>24|se[1]>>8&65280|se[2]<<8&16711680|se[3]<<24)>>>0),Z+=32;else a(_,Z,p,y,F)}function ut(p,y){k[y][0]=k[p+"0"],k[y][1]=k[p+"1"],k[y][2]=k[p+"2"],k[y][3]=k[p+"3"],k[y][4]=k[p+"4"],k[y][5]=k[p+"5"],k[y][6]=k[p+"6"],k[y][7]=k[p+"7"],k[y][8]=k[p+"8"],k[y][9]=k[p+"9"],k[y][10]=k[p+"10"],k[y][11]=k[p+"11"],k[y][12]=k[p+"12"],k[y][13]=k[p+"13"],k[y][14]=k[p+"0"],k[y][15]=k[p+"0"]}function Ge(p){return p==um||p==mm||p==MA||p==hm}function rt(){this.eb=[],this.size=this.A=this.fb=0}function Tt(){this.y=[],this.f=[],this.ea=[],this.F=[],this.Tc=this.Ed=this.Cd=this.Fd=this.lb=this.Db=this.Ab=this.fa=this.J=this.W=this.N=this.O=0}function At(){this.Rd=this.height=this.width=this.S=0,this.f={},this.f.RGBA=new rt,this.f.kb=new Tt,this.sd=null}function mt(){this.width=[0],this.height=[0],this.Pd=[0],this.Qd=[0],this.format=[0]}function Qt(){this.Id=this.fd=this.Md=this.hb=this.ib=this.da=this.bd=this.cd=this.j=this.v=this.Da=this.Sd=this.ob=0}function ts(p){return alert("todo:WebPSamplerProcessPlane"),p.T}function Yt(p,y){var F=p.T,_=y.ba.f.RGBA,Z=_.eb,se=_.fb+p.ka*_.A,ae=jn[y.ba.S],oe=p.y,Ae=p.O,ue=p.f,Ce=p.N,De=p.ea,me=p.W,Ee=y.cc,Fe=y.dc,He=y.Mc,Ue=y.Nc,Ve=p.ka,Ke=p.ka+p.T,tt=p.U,Je=tt+1>>1;for(Ve==0?ae(oe,Ae,null,null,ue,Ce,De,me,ue,Ce,De,me,Z,se,null,null,tt):(ae(y.ec,y.fc,oe,Ae,Ee,Fe,He,Ue,ue,Ce,De,me,Z,se-_.A,Z,se,tt),++F);Ve+2<Ke;Ve+=2)Ee=ue,Fe=Ce,He=De,Ue=me,Ce+=p.Rc,me+=p.Rc,se+=2*_.A,ae(oe,(Ae+=2*p.fa)-p.fa,oe,Ae,Ee,Fe,He,Ue,ue,Ce,De,me,Z,se-_.A,Z,se,tt);return Ae+=p.fa,p.j+Ke<p.o?(a(y.ec,y.fc,oe,Ae,tt),a(y.cc,y.dc,ue,Ce,Je),a(y.Mc,y.Nc,De,me,Je),F--):1&Ke||ae(oe,Ae,null,null,ue,Ce,De,me,ue,Ce,De,me,Z,se+_.A,null,null,tt),F}function Ht(p,y,F){var _=p.F,Z=[p.J];if(_!=null){var se=p.U,ae=y.ba.S,oe=ae==RA||ae==MA;y=y.ba.f.RGBA;var Ae=[0],ue=p.ka;Ae[0]=p.T,p.Kb&&(ue==0?--Ae[0]:(--ue,Z[0]-=p.width),p.j+p.ka+p.T==p.o&&(Ae[0]=p.o-p.j-ue));var Ce=y.eb;ue=y.fb+ue*y.A,p=ig(_,Z[0],p.width,se,Ae,Ce,ue+(oe?0:3),y.A),e(F==Ae),p&&Ge(ae)&&Nc(Ce,ue,oe,se,Ae,y.A)}return 0}function Es(p){var y=p.ma,F=y.ba.S,_=11>F,Z=F==LA||F==DA||F==RA||F==dm||F==12||Ge(F);if(y.memory=null,y.Ib=null,y.Jb=null,y.Nd=null,!qr(y.Oa,p,Z?11:12))return 0;if(Z&&Ge(F)&&Cs(),p.da)alert("todo:use_scaling");else{if(_){if(y.Ib=ts,p.Kb){if(F=p.U+1>>1,y.memory=i(p.U+2*F),y.memory==null)return 0;y.ec=y.memory,y.fc=0,y.cc=y.ec,y.dc=y.fc+p.U,y.Mc=y.cc,y.Nc=y.dc+F,y.Ib=Yt,Cs()}}else alert("todo:EmitYUV");Z&&(y.Jb=Ht,_&&xs())}if(_&&!wg){for(p=0;256>p;++p)T1[p]=89858*(p-128)+QA>>_A,U1[p]=-22014*(p-128)+QA,P1[p]=-45773*(p-128),F1[p]=113618*(p-128)+QA>>_A;for(p=Sc;p<fm;++p)y=76283*(p-16)+QA>>_A,L1[p-Sc]=Gr(y,255),D1[p-Sc]=Gr(y+8>>4,15);wg=1}return 1}function vt(p){var y=p.ma,F=p.U,_=p.T;return e(!(1&p.ka)),0>=F||0>=_?0:(F=y.Ib(p,y),y.Jb!=null&&y.Jb(p,y,F),y.Dc+=F,1)}function Ft(p){p.ma.memory=null}function Hs(p,y,F,_){return q(p,8)!=47?0:(y[0]=q(p,14)+1,F[0]=q(p,14)+1,_[0]=q(p,1),q(p,3)!=0?0:!p.h)}function ks(p,y){if(4>p)return p+1;var F=p-2>>1;return(2+(1&p)<<F)+q(y,F)+1}function Is(p,y){return 120<y?y-120:1<=(F=((F=f1[y-1])>>4)*p+(8-(15&F)))?F:1;var F}function Nt(p,y,F){var _=Y(F),Z=p[y+=255&_].g-8;return 0<Z&&(G(F,F.u+8),_=Y(F),y+=p[y].value,y+=_&(1<<Z)-1),G(F,F.u+p[y].g),p[y].value}function gs(p,y,F){return F.g+=p.g,F.value+=p.value<<y>>>0,e(8>=F.g),p.g}function Vt(p,y,F){var _=p.xc;return e((y=_==0?0:p.vc[p.md*(F>>_)+(y>>_)])<p.Wb),p.Ya[y]}function Kr(p,y,F,_){var Z=p.ab,se=p.c*y,ae=p.C;y=ae+y;var oe=F,Ae=_;for(_=p.Ta,F=p.Ua;0<Z--;){var ue=p.gc[Z],Ce=ae,De=y,me=oe,Ee=Ae,Fe=(Ae=_,oe=F,ue.Ea);switch(e(Ce<De),e(De<=ue.nc),ue.hc){case 2:br(me,Ee,(De-Ce)*Fe,Ae,oe);break;case 0:var He=Ce,Ue=De,Ve=Ae,Ke=oe,tt=(Pt=ue).Ea;He==0&&(xc(me,Ee,null,null,1,Ve,Ke),it(me,Ee+1,0,0,tt-1,Ve,Ke+1),Ee+=tt,Ke+=tt,++He);for(var Je=1<<Pt.b,Lt=Je-1,jt=ce(tt,Pt.b),ss=Pt.K,Pt=Pt.w+(He>>Pt.b)*jt;He<Ue;){var hs=ss,_r=Pt,rs=1;for(fl(me,Ee,Ve,Ke-tt,1,Ve,Ke);rs<tt;){var Ut=(rs&~Lt)+Je;Ut>tt&&(Ut=tt),(0,bc[hs[_r++]>>8&15])(me,Ee+ +rs,Ve,Ke+rs-tt,Ut-rs,Ve,Ke+rs),rs=Ut}Ee+=tt,Ke+=tt,++He&Lt||(Pt+=jt)}De!=ue.nc&&a(Ae,oe-Fe,Ae,oe+(De-Ce-1)*Fe,Fe);break;case 1:for(Fe=me,Ue=Ee,tt=(me=ue.Ea)-(Ke=me&~(Ve=(Ee=1<<ue.b)-1)),He=ce(me,ue.b),Je=ue.K,ue=ue.w+(Ce>>ue.b)*He;Ce<De;){for(Lt=Je,jt=ue,ss=new fe,Pt=Ue+Ke,hs=Ue+me;Ue<Pt;)$e(Lt[jt++],ss),vc(ss,Fe,Ue,Ee,Ae,oe),Ue+=Ee,oe+=Ee;Ue<hs&&($e(Lt[jt++],ss),vc(ss,Fe,Ue,tt,Ae,oe),Ue+=tt,oe+=tt),++Ce&Ve||(ue+=He)}break;case 3:if(me==Ae&&Ee==oe&&0<ue.b){for(Ue=Ae,me=Fe=oe+(De-Ce)*Fe-(Ke=(De-Ce)*ce(ue.Ea,ue.b)),Ee=Ae,Ve=oe,He=[],Ke=(tt=Ke)-1;0<=Ke;--Ke)He[Ke]=Ee[Ve+Ke];for(Ke=tt-1;0<=Ke;--Ke)Ue[me+Ke]=He[Ke];TA(ue,Ce,De,Ae,Fe,Ae,oe)}else TA(ue,Ce,De,me,Ee,Ae,oe)}oe=_,Ae=F}Ae!=F&&a(_,F,oe,Ae,se)}function Kt(p,y){var F=p.V,_=p.Ba+p.c*p.C,Z=y-p.C;if(e(y<=p.l.o),e(16>=Z),0<Z){var se=p.l,ae=p.Ta,oe=p.Ua,Ae=se.width;if(Kr(p,Z,F,_),Z=oe=[oe],e((F=p.C)<(_=y)),e(se.v<se.va),_>se.o&&(_=se.o),F<se.j){var ue=se.j-F;F=se.j,Z[0]+=ue*Ae}if(F>=_?F=0:(Z[0]+=4*se.v,se.ka=F-se.j,se.U=se.va-se.v,se.T=_-F,F=1),F){if(oe=oe[0],11>(F=p.ca).S){var Ce=F.f.RGBA,De=(_=F.S,Z=se.U,se=se.T,ue=Ce.eb,Ce.A),me=se;for(Ce=Ce.fb+p.Ma*Ce.A;0<me--;){var Ee=ae,Fe=oe,He=Z,Ue=ue,Ve=Ce;switch(_){case UA:wc(Ee,Fe,He,Ue,Ve);break;case LA:to(Ee,Fe,He,Ue,Ve);break;case um:to(Ee,Fe,He,Ue,Ve),Nc(Ue,Ve,0,He,1,0);break;case mg:Ro(Ee,Fe,He,Ue,Ve);break;case DA:qe(Ee,Fe,He,Ue,Ve,1);break;case mm:qe(Ee,Fe,He,Ue,Ve,1),Nc(Ue,Ve,0,He,1,0);break;case RA:qe(Ee,Fe,He,Ue,Ve,0);break;case MA:qe(Ee,Fe,He,Ue,Ve,0),Nc(Ue,Ve,1,He,1,0);break;case dm:so(Ee,Fe,He,Ue,Ve);break;case hm:so(Ee,Fe,He,Ue,Ve),ng(Ue,Ve,He,1,0);break;case hg:ro(Ee,Fe,He,Ue,Ve);break;default:e(0)}oe+=Ae,Ce+=De}p.Ma+=se}else alert("todo:EmitRescaledRowsYUVA");e(p.Ma<=F.height)}}p.C=y,e(p.C<=p.i)}function Js(p){var y;if(0<p.ua)return 0;for(y=0;y<p.Wb;++y){var F=p.Ya[y].G,_=p.Ya[y].H;if(0<F[1][_[1]+0].g||0<F[2][_[2]+0].g||0<F[3][_[3]+0].g)return 0}return 1}function fs(p,y,F,_,Z,se){if(p.Z!=0){var ae=p.qd,oe=p.rd;for(e(io[p.Z]!=null);y<F;++y)io[p.Z](ae,oe,_,Z,_,Z,se),ae=_,oe=Z,Z+=se;p.qd=ae,p.rd=oe}}function Zs(p,y){var F=p.l.ma,_=F.Z==0||F.Z==1?p.l.j:p.C;if(_=p.C<_?_:p.C,e(y<=p.l.o),y>_){var Z=p.l.width,se=F.ca,ae=F.tb+Z*_,oe=p.V,Ae=p.Ba+p.c*_,ue=p.gc;e(p.ab==1),e(ue[0].hc==3),ui(ue[0],_,y,oe,Ae,se,ae),fs(F,_,y,se,ae,Z)}p.C=p.Ma=y}function Ot(p,y,F,_,Z,se,ae){var oe=p.$/_,Ae=p.$%_,ue=p.m,Ce=p.s,De=F+p.$,me=De;Z=F+_*Z;var Ee=F+_*se,Fe=280+Ce.ua,He=p.Pb?oe:16777216,Ue=0<Ce.ua?Ce.Wa:null,Ve=Ce.wc,Ke=De<Ee?Vt(Ce,Ae,oe):null;e(p.C<se),e(Ee<=Z);var tt=!1;e:for(;;){for(;tt||De<Ee;){var Je=0;if(oe>=He){var Lt=De-F;e((He=p).Pb),He.wd=He.m,He.xd=Lt,0<He.s.ua&&Me(He.s.Wa,He.s.vb),He=oe+y1}if(Ae&Ve||(Ke=Vt(Ce,Ae,oe)),e(Ke!=null),Ke.Qb&&(y[De]=Ke.qb,tt=!0),!tt)if(X(ue),Ke.jc){Je=ue,Lt=y;var jt=De,ss=Ke.pd[Y(Je)&ga-1];e(Ke.jc),256>ss.g?(G(Je,Je.u+ss.g),Lt[jt]=ss.value,Je=0):(G(Je,Je.u+ss.g-256),e(256<=ss.value),Je=ss.value),Je==0&&(tt=!0)}else Je=Nt(Ke.G[0],Ke.H[0],ue);if(ue.h)break;if(tt||256>Je){if(!tt)if(Ke.nd)y[De]=(Ke.qb|Je<<8)>>>0;else{if(X(ue),tt=Nt(Ke.G[1],Ke.H[1],ue),X(ue),Lt=Nt(Ke.G[2],Ke.H[2],ue),jt=Nt(Ke.G[3],Ke.H[3],ue),ue.h)break;y[De]=(jt<<24|tt<<16|Je<<8|Lt)>>>0}if(tt=!1,++De,++Ae>=_&&(Ae=0,++oe,ae!=null&&oe<=se&&!(oe%16)&&ae(p,oe),Ue!=null))for(;me<De;)Je=y[me++],Ue.X[(506832829*Je&4294967295)>>>Ue.Mb]=Je}else if(280>Je){if(Je=ks(Je-256,ue),Lt=Nt(Ke.G[4],Ke.H[4],ue),X(ue),Lt=Is(_,Lt=ks(Lt,ue)),ue.h)break;if(De-F<Lt||Z-De<Je)break e;for(jt=0;jt<Je;++jt)y[De+jt]=y[De+jt-Lt];for(De+=Je,Ae+=Je;Ae>=_;)Ae-=_,++oe,ae!=null&&oe<=se&&!(oe%16)&&ae(p,oe);if(e(De<=Z),Ae&Ve&&(Ke=Vt(Ce,Ae,oe)),Ue!=null)for(;me<De;)Je=y[me++],Ue.X[(506832829*Je&4294967295)>>>Ue.Mb]=Je}else{if(!(Je<Fe))break e;for(tt=Je-280,e(Ue!=null);me<De;)Je=y[me++],Ue.X[(506832829*Je&4294967295)>>>Ue.Mb]=Je;Je=De,e(!(tt>>>(Lt=Ue).Xa)),y[Je]=Lt.X[tt],tt=!0}tt||e(ue.h==te(ue))}if(p.Pb&&ue.h&&De<Z)e(p.m.h),p.a=5,p.m=p.wd,p.$=p.xd,0<p.s.ua&&Me(p.s.vb,p.s.Wa);else{if(ue.h)break e;ae?.(p,oe>se?se:oe),p.a=0,p.$=De-F}return 1}return p.a=3,0}function qt(p){e(p!=null),p.vc=null,p.yc=null,p.Ya=null;var y=p.Wa;y!=null&&(y.X=null),p.vb=null,e(p!=null)}function ur(){var p=new We;return p==null?null:(p.a=0,p.xb=fg,ut("Predictor","VP8LPredictors"),ut("Predictor","VP8LPredictors_C"),ut("PredictorAdd","VP8LPredictorsAdd"),ut("PredictorAdd","VP8LPredictorsAdd_C"),br=st,vc=Xe,wc=ct,to=pt,so=dt,ro=xt,Ro=Se,k.VP8LMapColor32b=di,k.VP8LMapColor8b=yc,p)}function kr(p,y,F,_,Z){var se=1,ae=[p],oe=[y],Ae=_.m,ue=_.s,Ce=null,De=0;e:for(;;){if(F)for(;se&&q(Ae,1);){var me=ae,Ee=oe,Fe=_,He=1,Ue=Fe.m,Ve=Fe.gc[Fe.ab],Ke=q(Ue,2);if(Fe.Oc&1<<Ke)se=0;else{switch(Fe.Oc|=1<<Ke,Ve.hc=Ke,Ve.Ea=me[0],Ve.nc=Ee[0],Ve.K=[null],++Fe.ab,e(4>=Fe.ab),Ke){case 0:case 1:Ve.b=q(Ue,3)+2,He=kr(ce(Ve.Ea,Ve.b),ce(Ve.nc,Ve.b),0,Fe,Ve.K),Ve.K=Ve.K[0];break;case 3:var tt,Je=q(Ue,8)+1,Lt=16<Je?0:4<Je?1:2<Je?2:3;if(me[0]=ce(Ve.Ea,Lt),Ve.b=Lt,tt=He=kr(Je,1,0,Fe,Ve.K)){var jt,ss=Je,Pt=Ve,hs=1<<(8>>Pt.b),_r=i(hs);if(_r==null)tt=0;else{var rs=Pt.K[0],Ut=Pt.w;for(_r[0]=Pt.K[0][0],jt=1;jt<1*ss;++jt)_r[jt]=Ie(rs[Ut+jt],_r[jt-1]);for(;jt<4*hs;++jt)_r[jt]=0;Pt.K[0]=null,Pt.K[0]=_r,tt=1}}He=tt;break;case 2:break;default:e(0)}se=He}}if(ae=ae[0],oe=oe[0],se&&q(Ae,1)&&!(se=1<=(De=q(Ae,4))&&11>=De)){_.a=3;break e}var ht;if(ht=se)t:{var wr,Xt,ys,Ys=_,na=ae,Ta=oe,pr=De,fa=F,Fa=Ys.m,Qr=Ys.s,ws=[null],Us=1,gr=0,Ls=x1[pr];s:for(;;){if(fa&&q(Fa,1)){var ia=q(Fa,3)+2,$n=ce(na,ia),Cr=ce(Ta,ia),Wa=$n*Cr;if(!kr($n,Cr,0,Ys,ws))break s;for(ws=ws[0],Qr.xc=ia,wr=0;wr<Wa;++wr){var Ks=ws[wr]>>8&65535;ws[wr]=Ks,Ks>=Us&&(Us=Ks+1)}}if(Fa.h)break s;for(Xt=0;5>Xt;++Xt){var Or=pg[Xt];!Xt&&0<pr&&(Or+=1<<pr),gr<Or&&(gr=Or)}var cn=o(Us*Ls,M),Pa=Us,An=o(Pa,K);if(An==null)var dn=null;else e(65536>=Pa),dn=An;var qa=i(gr);if(dn==null||qa==null||cn==null){Ys.a=1;break s}var un=cn;for(wr=ys=0;wr<Us;++wr){var Ws=dn[wr],mn=Ws.G,Kn=Ws.H,_o=0,Mi=1,oa=0;for(Xt=0;5>Xt;++Xt){Or=pg[Xt],mn[Xt]=un,Kn[Xt]=ys,!Xt&&0<pr&&(Or+=1<<pr);a:{var HA,xm=Or,VA=Ys,jc=qa,_1=un,Q1=ys,ym=0,oo=VA.m,O1=q(oo,1);if(n(jc,0,0,xm),O1){var H1=q(oo,1)+1,V1=q(oo,1),Bg=q(oo,V1==0?1:8);jc[Bg]=1,H1==2&&(jc[Bg=q(oo,8)]=1);var $A=1}else{var Sg=i(19),jg=q(oo,4)+4;if(19<jg){VA.a=3;var KA=0;break a}for(HA=0;HA<jg;++HA)Sg[g1[HA]]=q(oo,3);var bm=void 0,Ec=void 0,Eg=VA,$1=Sg,GA=xm,kg=jc,vm=0,lo=Eg.m,Ig=8,Tg=o(128,M);r:for(;L(Tg,0,7,$1,19);){if(q(lo,1)){var K1=2+2*q(lo,3);if((bm=2+q(lo,K1))>GA)break r}else bm=GA;for(Ec=0;Ec<GA&&bm--;){X(lo);var Fg=Tg[0+(127&Y(lo))];G(lo,lo.u+Fg.g);var yl=Fg.value;if(16>yl)kg[Ec++]=yl,yl!=0&&(Ig=yl);else{var G1=yl==16,Pg=yl-16,z1=h1[Pg],Ug=q(lo,m1[Pg])+z1;if(Ec+Ug>GA)break r;for(var W1=G1?Ig:0;0<Ug--;)kg[Ec++]=W1}}vm=1;break r}vm||(Eg.a=3),$A=vm}($A=$A&&!oo.h)&&(ym=L(_1,Q1,8,jc,xm)),$A&&ym!=0?KA=ym:(VA.a=3,KA=0)}if(KA==0)break s;if(Mi&&p1[Xt]==1&&(Mi=un[ys].g==0),_o+=un[ys].g,ys+=KA,3>=Xt){var kc,wm=qa[0];for(kc=1;kc<Or;++kc)qa[kc]>wm&&(wm=qa[kc]);oa+=wm}}if(Ws.nd=Mi,Ws.Qb=0,Mi&&(Ws.qb=(mn[3][Kn[3]+0].value<<24|mn[1][Kn[1]+0].value<<16|mn[2][Kn[2]+0].value)>>>0,_o==0&&256>mn[0][Kn[0]+0].value&&(Ws.Qb=1,Ws.qb+=mn[0][Kn[0]+0].value<<8)),Ws.jc=!Ws.Qb&&6>oa,Ws.jc){var zA,_i=Ws;for(zA=0;zA<ga;++zA){var co=zA,Ao=_i.pd[co],WA=_i.G[0][_i.H[0]+co];256<=WA.value?(Ao.g=WA.g+256,Ao.value=WA.value):(Ao.g=0,Ao.value=0,co>>=gs(WA,8,Ao),co>>=gs(_i.G[1][_i.H[1]+co],16,Ao),co>>=gs(_i.G[2][_i.H[2]+co],0,Ao),gs(_i.G[3][_i.H[3]+co],24,Ao))}}}Qr.vc=ws,Qr.Wb=Us,Qr.Ya=dn,Qr.yc=cn,ht=1;break t}ht=0}if(!(se=ht)){_.a=3;break e}if(0<De){if(ue.ua=1<<De,!re(ue.Wa,De)){_.a=1,se=0;break e}}else ue.ua=0;var Cm=_,Lg=ae,q1=oe,Nm=Cm.s,Bm=Nm.xc;if(Cm.c=Lg,Cm.i=q1,Nm.md=ce(Lg,Bm),Nm.wc=Bm==0?-1:(1<<Bm)-1,F){_.xb=S1;break e}if((Ce=i(ae*oe))==null){_.a=1,se=0;break e}se=(se=Ot(_,Ce,0,ae,oe,oe,null))&&!Ae.h;break e}return se?(Z!=null?Z[0]=Ce:(e(Ce==null),e(F)),_.$=0,F||qt(ue)):qt(ue),se}function Zr(p,y){var F=p.c*p.i,_=F+y+16*y;return e(p.c<=y),p.V=i(_),p.V==null?(p.Ta=null,p.Ua=0,p.a=1,0):(p.Ta=p.V,p.Ua=p.Ba+F+y,1)}function Qa(p,y){var F=p.C,_=y-F,Z=p.V,se=p.Ba+p.c*F;for(e(y<=p.l.o);0<_;){var ae=16<_?16:_,oe=p.l.ma,Ae=p.l.width,ue=Ae*ae,Ce=oe.ca,De=oe.tb+Ae*F,me=p.Ta,Ee=p.Ua;Kr(p,ae,Z,se),og(me,Ee,Ce,De,ue),fs(oe,F,F+ae,Ce,De,Ae),_-=ae,Z+=ae*p.c,F+=ae}e(F==y),p.C=p.Ma=y}function Oa(){this.ub=this.yd=this.td=this.Rb=0}function tn(){this.Kd=this.Ld=this.Ud=this.Td=this.i=this.c=0}function Ha(){this.Fb=this.Bb=this.Cb=0,this.Zb=i(4),this.Lb=i(4)}function sn(){this.Yb=function(){var p=[];return function y(F,_,Z){for(var se=Z[_],ae=0;ae<se&&(F.push(Z.length>_+1?[]:0),!(Z.length<_+1));ae++)y(F[ae],_+1,Z)}(p,0,[3,11]),p}()}function Mn(){this.jb=i(3),this.Wc=l([4,8],sn),this.Xc=l([4,17],sn)}function lr(){this.Pc=this.wb=this.Tb=this.zd=0,this.vd=new i(4),this.od=new i(4)}function os(){this.ld=this.La=this.dd=this.tc=0}function ua(){this.Na=this.la=0}function _n(){this.Sc=[0,0],this.Eb=[0,0],this.Qc=[0,0],this.ia=this.lc=0}function Va(){this.ad=i(384),this.Za=0,this.Ob=i(16),this.$b=this.Ad=this.ia=this.Gc=this.Hc=this.Dd=0}function Qn(){this.uc=this.M=this.Nb=0,this.wa=Array(new os),this.Y=0,this.ya=Array(new Va),this.aa=0,this.l=new ea}function rn(){this.y=i(16),this.f=i(8),this.ea=i(8)}function an(){this.cb=this.a=0,this.sc="",this.m=new S,this.Od=new Oa,this.Kc=new tn,this.ed=new lr,this.Qa=new Ha,this.Ic=this.$c=this.Aa=0,this.D=new Qn,this.Xb=this.Va=this.Hb=this.zb=this.yb=this.Ub=this.za=0,this.Jc=o(8,S),this.ia=0,this.pb=o(4,_n),this.Pa=new Mn,this.Bd=this.kc=0,this.Ac=[],this.Bc=0,this.zc=[0,0,0,0],this.Gd=Array(new rn),this.Hd=0,this.rb=Array(new ua),this.sb=0,this.wa=Array(new os),this.Y=0,this.oc=[],this.pc=0,this.sa=[],this.ta=0,this.qa=[],this.ra=0,this.Ha=[],this.B=this.R=this.Ia=0,this.Ec=[],this.M=this.ja=this.Vb=this.Fc=0,this.ya=Array(new Va),this.L=this.aa=0,this.gd=l([4,2],os),this.ga=null,this.Fa=[],this.Cc=this.qc=this.P=0,this.Gb=[],this.Uc=0,this.mb=[],this.nb=0,this.rc=[],this.Ga=this.Vc=0}function Gr(p,y){return 0>p?0:p>y?y:p}function ea(){this.T=this.U=this.ka=this.height=this.width=0,this.y=[],this.f=[],this.ea=[],this.Rc=this.fa=this.W=this.N=this.O=0,this.ma="void",this.put="VP8IoPutHook",this.ac="VP8IoSetupHook",this.bc="VP8IoTeardownHook",this.ha=this.Kb=0,this.data=[],this.hb=this.ib=this.da=this.o=this.j=this.va=this.v=this.Da=this.ob=this.w=0,this.F=[],this.J=0}function mr(){var p=new an;return p!=null&&(p.a=0,p.sc="OK",p.cb=0,p.Xb=0,Bc||(Bc=zr)),p}function Ts(p,y,F){return p.a==0&&(p.a=y,p.sc=F,p.cb=0),0}function On(p,y,F){return 3<=F&&p[y+0]==157&&p[y+1]==1&&p[y+2]==42}function Ur(p,y){if(p==null)return 0;if(p.a=0,p.sc="OK",y==null)return Ts(p,2,"null VP8Io passed to VP8GetHeaders()");var F=y.data,_=y.w,Z=y.ha;if(4>Z)return Ts(p,7,"Truncated header.");var se=F[_+0]|F[_+1]<<8|F[_+2]<<16,ae=p.Od;if(ae.Rb=!(1&se),ae.td=se>>1&7,ae.yd=se>>4&1,ae.ub=se>>5,3<ae.td)return Ts(p,3,"Incorrect keyframe parameters.");if(!ae.yd)return Ts(p,4,"Frame not displayable.");_+=3,Z-=3;var oe=p.Kc;if(ae.Rb){if(7>Z)return Ts(p,7,"cannot parse picture header");if(!On(F,_,Z))return Ts(p,3,"Bad code word");oe.c=16383&(F[_+4]<<8|F[_+3]),oe.Td=F[_+4]>>6,oe.i=16383&(F[_+6]<<8|F[_+5]),oe.Ud=F[_+6]>>6,_+=7,Z-=7,p.za=oe.c+15>>4,p.Ub=oe.i+15>>4,y.width=oe.c,y.height=oe.i,y.Da=0,y.j=0,y.v=0,y.va=y.width,y.o=y.height,y.da=0,y.ib=y.width,y.hb=y.height,y.U=y.width,y.T=y.height,n((se=p.Pa).jb,0,255,se.jb.length),e((se=p.Qa)!=null),se.Cb=0,se.Bb=0,se.Fb=1,n(se.Zb,0,0,se.Zb.length),n(se.Lb,0,0,se.Lb)}if(ae.ub>Z)return Ts(p,7,"bad partition length");$(se=p.m,F,_,ae.ub),_+=ae.ub,Z-=ae.ub,ae.Rb&&(oe.Ld=he(se),oe.Kd=he(se)),oe=p.Qa;var Ae,ue=p.Pa;if(e(se!=null),e(oe!=null),oe.Cb=he(se),oe.Cb){if(oe.Bb=he(se),he(se)){for(oe.Fb=he(se),Ae=0;4>Ae;++Ae)oe.Zb[Ae]=he(se)?W(se,7):0;for(Ae=0;4>Ae;++Ae)oe.Lb[Ae]=he(se)?W(se,6):0}if(oe.Bb)for(Ae=0;3>Ae;++Ae)ue.jb[Ae]=he(se)?O(se,8):255}else oe.Bb=0;if(se.Ka)return Ts(p,3,"cannot parse segment header");if((oe=p.ed).zd=he(se),oe.Tb=O(se,6),oe.wb=O(se,3),oe.Pc=he(se),oe.Pc&&he(se)){for(ue=0;4>ue;++ue)he(se)&&(oe.vd[ue]=W(se,6));for(ue=0;4>ue;++ue)he(se)&&(oe.od[ue]=W(se,6))}if(p.L=oe.Tb==0?0:oe.zd?1:2,se.Ka)return Ts(p,3,"cannot parse filter header");var Ce=Z;if(Z=Ae=_,_=Ae+Ce,oe=Ce,p.Xb=(1<<O(p.m,2))-1,Ce<3*(ue=p.Xb))F=7;else{for(Ae+=3*ue,oe-=3*ue,Ce=0;Ce<ue;++Ce){var De=F[Z+0]|F[Z+1]<<8|F[Z+2]<<16;De>oe&&(De=oe),$(p.Jc[+Ce],F,Ae,De),Ae+=De,oe-=De,Z+=3}$(p.Jc[+ue],F,Ae,oe),F=Ae<_?0:5}if(F!=0)return Ts(p,F,"cannot parse partitions");for(F=O(Ae=p.m,7),Z=he(Ae)?W(Ae,4):0,_=he(Ae)?W(Ae,4):0,oe=he(Ae)?W(Ae,4):0,ue=he(Ae)?W(Ae,4):0,Ae=he(Ae)?W(Ae,4):0,Ce=p.Qa,De=0;4>De;++De){if(Ce.Cb){var me=Ce.Zb[De];Ce.Fb||(me+=F)}else{if(0<De){p.pb[De]=p.pb[0];continue}me=F}var Ee=p.pb[De];Ee.Sc[0]=pm[Gr(me+Z,127)],Ee.Sc[1]=gm[Gr(me+0,127)],Ee.Eb[0]=2*pm[Gr(me+_,127)],Ee.Eb[1]=101581*gm[Gr(me+oe,127)]>>16,8>Ee.Eb[1]&&(Ee.Eb[1]=8),Ee.Qc[0]=pm[Gr(me+ue,117)],Ee.Qc[1]=gm[Gr(me+Ae,127)],Ee.lc=me+Ae}if(!ae.Rb)return Ts(p,4,"Not a key frame.");for(he(se),ae=p.Pa,F=0;4>F;++F){for(Z=0;8>Z;++Z)for(_=0;3>_;++_)for(oe=0;11>oe;++oe)ue=ve(se,N1[F][Z][_][oe])?O(se,8):w1[F][Z][_][oe],ae.Wc[F][Z].Yb[_][oe]=ue;for(Z=0;17>Z;++Z)ae.Xc[F][Z]=ae.Wc[F][B1[Z]]}return p.kc=he(se),p.kc&&(p.Bd=O(se,8)),p.cb=1}function zr(p,y,F,_,Z,se,ae){var oe=y[Z].Yb[F];for(F=0;16>Z;++Z){if(!ve(p,oe[F+0]))return Z;for(;!ve(p,oe[F+1]);)if(oe=y[++Z].Yb[0],F=0,Z==16)return 16;var Ae=y[Z+1].Yb;if(ve(p,oe[F+2])){var ue=p,Ce=0;if(ve(ue,(me=oe)[(De=F)+3]))if(ve(ue,me[De+6])){for(oe=0,De=2*(Ce=ve(ue,me[De+8]))+(me=ve(ue,me[De+9+Ce])),Ce=0,me=b1[De];me[oe];++oe)Ce+=Ce+ve(ue,me[oe]);Ce+=3+(8<<De)}else ve(ue,me[De+7])?(Ce=7+2*ve(ue,165),Ce+=ve(ue,145)):Ce=5+ve(ue,159);else Ce=ve(ue,me[De+4])?3+ve(ue,me[De+5]):2;oe=Ae[2]}else Ce=1,oe=Ae[1];Ae=ae+v1[Z],0>(ue=p).b&&le(ue);var De,me=ue.b,Ee=(De=ue.Ca>>1)-(ue.I>>me)>>31;--ue.b,ue.Ca+=Ee,ue.Ca|=1,ue.I-=(De+1&Ee)<<me,se[Ae]=((Ce^Ee)-Ee)*_[(0<Z)+0]}return 16}function er(p){var y=p.rb[p.sb-1];y.la=0,y.Na=0,n(p.zc,0,0,p.zc.length),p.ja=0}function tr(p,y,F,_,Z){Z=p[y+F+32*_]+(Z>>3),p[y+F+32*_]=-256&Z?0>Z?0:255:Z}function _s(p,y,F,_,Z,se){tr(p,y,0,F,_+Z),tr(p,y,1,F,_+se),tr(p,y,2,F,_-se),tr(p,y,3,F,_-Z)}function Lr(p){return(20091*p>>16)+p}function oi(p,y,F,_){var Z,se=0,ae=i(16);for(Z=0;4>Z;++Z){var oe=p[y+0]+p[y+8],Ae=p[y+0]-p[y+8],ue=(35468*p[y+4]>>16)-Lr(p[y+12]),Ce=Lr(p[y+4])+(35468*p[y+12]>>16);ae[se+0]=oe+Ce,ae[se+1]=Ae+ue,ae[se+2]=Ae-ue,ae[se+3]=oe-Ce,se+=4,y++}for(Z=se=0;4>Z;++Z)oe=(p=ae[se+0]+4)+ae[se+8],Ae=p-ae[se+8],ue=(35468*ae[se+4]>>16)-Lr(ae[se+12]),tr(F,_,0,0,oe+(Ce=Lr(ae[se+4])+(35468*ae[se+12]>>16))),tr(F,_,1,0,Ae+ue),tr(F,_,2,0,Ae-ue),tr(F,_,3,0,oe-Ce),se++,_+=32}function Fi(p,y,F,_){var Z=p[y+0]+4,se=35468*p[y+4]>>16,ae=Lr(p[y+4]),oe=35468*p[y+1]>>16;_s(F,_,0,Z+ae,p=Lr(p[y+1]),oe),_s(F,_,1,Z+se,p,oe),_s(F,_,2,Z-se,p,oe),_s(F,_,3,Z-ae,p,oe)}function Sa(p,y,F,_,Z){oi(p,y,F,_),Z&&oi(p,y+16,F,_+4)}function ta(p,y,F,_){Mo(p,y+0,F,_,1),Mo(p,y+32,F,_+128,1)}function ja(p,y,F,_){var Z;for(p=p[y+0]+4,Z=0;4>Z;++Z)for(y=0;4>y;++y)tr(F,_,y,Z,p)}function ma(p,y,F,_){p[y+0]&&Ss(p,y+0,F,_),p[y+16]&&Ss(p,y+16,F,_+4),p[y+32]&&Ss(p,y+32,F,_+128),p[y+48]&&Ss(p,y+48,F,_+128+4)}function sr(p,y,F,_){var Z,se=i(16);for(Z=0;4>Z;++Z){var ae=p[y+0+Z]+p[y+12+Z],oe=p[y+4+Z]+p[y+8+Z],Ae=p[y+4+Z]-p[y+8+Z],ue=p[y+0+Z]-p[y+12+Z];se[0+Z]=ae+oe,se[8+Z]=ae-oe,se[4+Z]=ue+Ae,se[12+Z]=ue-Ae}for(Z=0;4>Z;++Z)ae=(p=se[0+4*Z]+3)+se[3+4*Z],oe=se[1+4*Z]+se[2+4*Z],Ae=se[1+4*Z]-se[2+4*Z],ue=p-se[3+4*Z],F[_+0]=ae+oe>>3,F[_+16]=ue+Ae>>3,F[_+32]=ae-oe>>3,F[_+48]=ue-Ae>>3,_+=64}function $a(p,y,F){var _,Z=y-32,se=ln,ae=255-p[Z-1];for(_=0;_<F;++_){var oe,Ae=se,ue=ae+p[y-1];for(oe=0;oe<F;++oe)p[y+oe]=Ae[ue+p[Z+oe]];y+=32}}function nn(p,y){$a(p,y,4)}function on(p,y){$a(p,y,8)}function Ea(p,y){$a(p,y,16)}function ie(p,y){var F;for(F=0;16>F;++F)a(p,y+32*F,p,y-32,16)}function Qe(p,y){var F;for(F=16;0<F;--F)n(p,y,p[y-1],16),y+=32}function _e(p,y,F){var _;for(_=0;16>_;++_)n(y,F+32*_,p,16)}function St(p,y){var F,_=16;for(F=0;16>F;++F)_+=p[y-1+32*F]+p[y+F-32];_e(_>>5,p,y)}function zt(p,y){var F,_=8;for(F=0;16>F;++F)_+=p[y-1+32*F];_e(_>>4,p,y)}function ot(p,y){var F,_=8;for(F=0;16>F;++F)_+=p[y+F-32];_e(_>>4,p,y)}function yr(p,y){_e(128,p,y)}function kt(p,y,F){return p+2*y+F+2>>2}function ze(p,y){var F,_=y-32;for(_=new Uint8Array([kt(p[_-1],p[_+0],p[_+1]),kt(p[_+0],p[_+1],p[_+2]),kt(p[_+1],p[_+2],p[_+3]),kt(p[_+2],p[_+3],p[_+4])]),F=0;4>F;++F)a(p,y+32*F,_,0,_.length)}function Gt(p,y){var F=p[y-1],_=p[y-1+32],Z=p[y-1+64],se=p[y-1+96];ke(p,y+0,16843009*kt(p[y-1-32],F,_)),ke(p,y+32,16843009*kt(F,_,Z)),ke(p,y+64,16843009*kt(_,Z,se)),ke(p,y+96,16843009*kt(Z,se,se))}function Bs(p,y){var F,_=4;for(F=0;4>F;++F)_+=p[y+F-32]+p[y-1+32*F];for(_>>=3,F=0;4>F;++F)n(p,y+32*F,_,4)}function ls(p,y){var F=p[y-1+0],_=p[y-1+32],Z=p[y-1+64],se=p[y-1-32],ae=p[y+0-32],oe=p[y+1-32],Ae=p[y+2-32],ue=p[y+3-32];p[y+0+96]=kt(_,Z,p[y-1+96]),p[y+1+96]=p[y+0+64]=kt(F,_,Z),p[y+2+96]=p[y+1+64]=p[y+0+32]=kt(se,F,_),p[y+3+96]=p[y+2+64]=p[y+1+32]=p[y+0+0]=kt(ae,se,F),p[y+3+64]=p[y+2+32]=p[y+1+0]=kt(oe,ae,se),p[y+3+32]=p[y+2+0]=kt(Ae,oe,ae),p[y+3+0]=kt(ue,Ae,oe)}function Qs(p,y){var F=p[y+1-32],_=p[y+2-32],Z=p[y+3-32],se=p[y+4-32],ae=p[y+5-32],oe=p[y+6-32],Ae=p[y+7-32];p[y+0+0]=kt(p[y+0-32],F,_),p[y+1+0]=p[y+0+32]=kt(F,_,Z),p[y+2+0]=p[y+1+32]=p[y+0+64]=kt(_,Z,se),p[y+3+0]=p[y+2+32]=p[y+1+64]=p[y+0+96]=kt(Z,se,ae),p[y+3+32]=p[y+2+64]=p[y+1+96]=kt(se,ae,oe),p[y+3+64]=p[y+2+96]=kt(ae,oe,Ae),p[y+3+96]=kt(oe,Ae,Ae)}function Vs(p,y){var F=p[y-1+0],_=p[y-1+32],Z=p[y-1+64],se=p[y-1-32],ae=p[y+0-32],oe=p[y+1-32],Ae=p[y+2-32],ue=p[y+3-32];p[y+0+0]=p[y+1+64]=se+ae+1>>1,p[y+1+0]=p[y+2+64]=ae+oe+1>>1,p[y+2+0]=p[y+3+64]=oe+Ae+1>>1,p[y+3+0]=Ae+ue+1>>1,p[y+0+96]=kt(Z,_,F),p[y+0+64]=kt(_,F,se),p[y+0+32]=p[y+1+96]=kt(F,se,ae),p[y+1+32]=p[y+2+96]=kt(se,ae,oe),p[y+2+32]=p[y+3+96]=kt(ae,oe,Ae),p[y+3+32]=kt(oe,Ae,ue)}function ha(p,y){var F=p[y+0-32],_=p[y+1-32],Z=p[y+2-32],se=p[y+3-32],ae=p[y+4-32],oe=p[y+5-32],Ae=p[y+6-32],ue=p[y+7-32];p[y+0+0]=F+_+1>>1,p[y+1+0]=p[y+0+64]=_+Z+1>>1,p[y+2+0]=p[y+1+64]=Z+se+1>>1,p[y+3+0]=p[y+2+64]=se+ae+1>>1,p[y+0+32]=kt(F,_,Z),p[y+1+32]=p[y+0+96]=kt(_,Z,se),p[y+2+32]=p[y+1+96]=kt(Z,se,ae),p[y+3+32]=p[y+2+96]=kt(se,ae,oe),p[y+3+64]=kt(ae,oe,Ae),p[y+3+96]=kt(oe,Ae,ue)}function sa(p,y){var F=p[y-1+0],_=p[y-1+32],Z=p[y-1+64],se=p[y-1+96];p[y+0+0]=F+_+1>>1,p[y+2+0]=p[y+0+32]=_+Z+1>>1,p[y+2+32]=p[y+0+64]=Z+se+1>>1,p[y+1+0]=kt(F,_,Z),p[y+3+0]=p[y+1+32]=kt(_,Z,se),p[y+3+32]=p[y+1+64]=kt(Z,se,se),p[y+3+64]=p[y+2+64]=p[y+0+96]=p[y+1+96]=p[y+2+96]=p[y+3+96]=se}function Dr(p,y){var F=p[y-1+0],_=p[y-1+32],Z=p[y-1+64],se=p[y-1+96],ae=p[y-1-32],oe=p[y+0-32],Ae=p[y+1-32],ue=p[y+2-32];p[y+0+0]=p[y+2+32]=F+ae+1>>1,p[y+0+32]=p[y+2+64]=_+F+1>>1,p[y+0+64]=p[y+2+96]=Z+_+1>>1,p[y+0+96]=se+Z+1>>1,p[y+3+0]=kt(oe,Ae,ue),p[y+2+0]=kt(ae,oe,Ae),p[y+1+0]=p[y+3+32]=kt(F,ae,oe),p[y+1+32]=p[y+3+64]=kt(_,F,ae),p[y+1+64]=p[y+3+96]=kt(Z,_,F),p[y+1+96]=kt(se,Z,_)}function ra(p,y){var F;for(F=0;8>F;++F)a(p,y+32*F,p,y-32,8)}function pa(p,y){var F;for(F=0;8>F;++F)n(p,y,p[y-1],8),y+=32}function ka(p,y,F){var _;for(_=0;8>_;++_)n(y,F+32*_,p,8)}function gl(p,y){var F,_=8;for(F=0;8>F;++F)_+=p[y+F-32]+p[y-1+32*F];ka(_>>4,p,y)}function Pi(p,y){var F,_=4;for(F=0;8>F;++F)_+=p[y+F-32];ka(_>>3,p,y)}function Yi(p,y){var F,_=4;for(F=0;8>F;++F)_+=p[y-1+32*F];ka(_>>3,p,y)}function Ka(p,y){ka(128,p,y)}function bn(p,y,F){var _=p[y-F],Z=p[y+0],se=3*(Z-_)+Am[1020+p[y-2*F]-p[y+F]],ae=PA[112+(se+4>>3)];p[y-F]=ln[255+_+PA[112+(se+3>>3)]],p[y+0]=ln[255+Z-ae]}function Xi(p,y,F,_){var Z=p[y+0],se=p[y+F];return Sn[255+p[y-2*F]-p[y-F]]>_||Sn[255+se-Z]>_}function Rr(p,y,F,_){return 4*Sn[255+p[y-F]-p[y+0]]+Sn[255+p[y-2*F]-p[y+F]]<=_}function li(p,y,F,_,Z){var se=p[y-3*F],ae=p[y-2*F],oe=p[y-F],Ae=p[y+0],ue=p[y+F],Ce=p[y+2*F],De=p[y+3*F];return 4*Sn[255+oe-Ae]+Sn[255+ae-ue]>_?0:Sn[255+p[y-4*F]-se]<=Z&&Sn[255+se-ae]<=Z&&Sn[255+ae-oe]<=Z&&Sn[255+De-Ce]<=Z&&Sn[255+Ce-ue]<=Z&&Sn[255+ue-Ae]<=Z}function lt(p,y,F,_){var Z=2*_+1;for(_=0;16>_;++_)Rr(p,y+_,F,Z)&&bn(p,y+_,F)}function us(p,y,F,_){var Z=2*_+1;for(_=0;16>_;++_)Rr(p,y+_*F,1,Z)&&bn(p,y+_*F,1)}function Wr(p,y,F,_){var Z;for(Z=3;0<Z;--Z)lt(p,y+=4*F,F,_)}function ci(p,y,F,_){var Z;for(Z=3;0<Z;--Z)us(p,y+=4,F,_)}function Ga(p,y,F,_,Z,se,ae,oe){for(se=2*se+1;0<Z--;){if(li(p,y,F,se,ae))if(Xi(p,y,F,oe))bn(p,y,F);else{var Ae=p,ue=y,Ce=F,De=Ae[ue-2*Ce],me=Ae[ue-Ce],Ee=Ae[ue+0],Fe=Ae[ue+Ce],He=Ae[ue+2*Ce],Ue=27*(Ke=Am[1020+3*(Ee-me)+Am[1020+De-Fe]])+63>>7,Ve=18*Ke+63>>7,Ke=9*Ke+63>>7;Ae[ue-3*Ce]=ln[255+Ae[ue-3*Ce]+Ke],Ae[ue-2*Ce]=ln[255+De+Ve],Ae[ue-Ce]=ln[255+me+Ue],Ae[ue+0]=ln[255+Ee-Ue],Ae[ue+Ce]=ln[255+Fe-Ve],Ae[ue+2*Ce]=ln[255+He-Ke]}y+=_}}function Ia(p,y,F,_,Z,se,ae,oe){for(se=2*se+1;0<Z--;){if(li(p,y,F,se,ae))if(Xi(p,y,F,oe))bn(p,y,F);else{var Ae=p,ue=y,Ce=F,De=Ae[ue-Ce],me=Ae[ue+0],Ee=Ae[ue+Ce],Fe=PA[112+(4+(He=3*(me-De))>>3)],He=PA[112+(He+3>>3)],Ue=Fe+1>>1;Ae[ue-2*Ce]=ln[255+Ae[ue-2*Ce]+Ue],Ae[ue-Ce]=ln[255+De+He],Ae[ue+0]=ln[255+me-Fe],Ae[ue+Ce]=ln[255+Ee-Ue]}y+=_}}function Zi(p,y,F,_,Z,se){Ga(p,y,F,1,16,_,Z,se)}function Ui(p,y,F,_,Z,se){Ga(p,y,1,F,16,_,Z,se)}function U(p,y,F,_,Z,se){var ae;for(ae=3;0<ae;--ae)Ia(p,y+=4*F,F,1,16,_,Z,se)}function g(p,y,F,_,Z,se){var ae;for(ae=3;0<ae;--ae)Ia(p,y+=4,1,F,16,_,Z,se)}function B(p,y,F,_,Z,se,ae,oe){Ga(p,y,Z,1,8,se,ae,oe),Ga(F,_,Z,1,8,se,ae,oe)}function z(p,y,F,_,Z,se,ae,oe){Ga(p,y,1,Z,8,se,ae,oe),Ga(F,_,1,Z,8,se,ae,oe)}function J(p,y,F,_,Z,se,ae,oe){Ia(p,y+4*Z,Z,1,8,se,ae,oe),Ia(F,_+4*Z,Z,1,8,se,ae,oe)}function ne(p,y,F,_,Z,se,ae,oe){Ia(p,y+4,1,Z,8,se,ae,oe),Ia(F,_+4,1,Z,8,se,ae,oe)}function ge(){this.ba=new At,this.ec=[],this.cc=[],this.Mc=[],this.Dc=this.Nc=this.dc=this.fc=0,this.Oa=new Qt,this.memory=0,this.Ib="OutputFunc",this.Jb="OutputAlphaFunc",this.Nd="OutputRowFunc"}function je(){this.data=[],this.offset=this.kd=this.ha=this.w=0,this.na=[],this.xa=this.gb=this.Ja=this.Sa=this.P=0}function Te(){this.nc=this.Ea=this.b=this.hc=0,this.K=[],this.w=0}function Oe(){this.ua=0,this.Wa=new Pe,this.vb=new Pe,this.md=this.xc=this.wc=0,this.vc=[],this.Wb=0,this.Ya=new K,this.yc=new M}function We(){this.xb=this.a=0,this.l=new ea,this.ca=new At,this.V=[],this.Ba=0,this.Ta=[],this.Ua=0,this.m=new H,this.Pb=0,this.wd=new H,this.Ma=this.$=this.C=this.i=this.c=this.xd=0,this.s=new Oe,this.ab=0,this.gc=o(4,Te),this.Oc=0}function at(){this.Lc=this.Z=this.$a=this.i=this.c=0,this.l=new ea,this.ic=0,this.ca=[],this.tb=0,this.qd=null,this.rd=0}function et(p,y,F,_,Z,se,ae){for(p=p==null?0:p[y+0],y=0;y<ae;++y)Z[se+y]=p+F[_+y]&255,p=Z[se+y]}function Bt(p,y,F,_,Z,se,ae){var oe;if(p==null)et(null,null,F,_,Z,se,ae);else for(oe=0;oe<ae;++oe)Z[se+oe]=p[y+oe]+F[_+oe]&255}function It(p,y,F,_,Z,se,ae){if(p==null)et(null,null,F,_,Z,se,ae);else{var oe,Ae=p[y+0],ue=Ae,Ce=Ae;for(oe=0;oe<ae;++oe)ue=Ce+(Ae=p[y+oe])-ue,Ce=F[_+oe]+(-256&ue?0>ue?0:255:ue)&255,ue=Ae,Z[se+oe]=Ce}}function ft(p,y,F,_){var Z=y.width,se=y.o;if(e(p!=null&&y!=null),0>F||0>=_||F+_>se)return null;if(!p.Cc){if(p.ga==null){var ae;if(p.ga=new at,(ae=p.ga==null)||(ae=y.width*y.o,e(p.Gb.length==0),p.Gb=i(ae),p.Uc=0,p.Gb==null?ae=0:(p.mb=p.Gb,p.nb=p.Uc,p.rc=null,ae=1),ae=!ae),!ae){ae=p.ga;var oe=p.Fa,Ae=p.P,ue=p.qc,Ce=p.mb,De=p.nb,me=Ae+1,Ee=ue-1,Fe=ae.l;if(e(oe!=null&&Ce!=null&&y!=null),io[0]=null,io[1]=et,io[2]=Bt,io[3]=It,ae.ca=Ce,ae.tb=De,ae.c=y.width,ae.i=y.height,e(0<ae.c&&0<ae.i),1>=ue)y=0;else if(ae.$a=3&oe[Ae+0],ae.Z=oe[Ae+0]>>2&3,ae.Lc=oe[Ae+0]>>4&3,Ae=oe[Ae+0]>>6&3,0>ae.$a||1<ae.$a||4<=ae.Z||1<ae.Lc||Ae)y=0;else if(Fe.put=vt,Fe.ac=Es,Fe.bc=Ft,Fe.ma=ae,Fe.width=y.width,Fe.height=y.height,Fe.Da=y.Da,Fe.v=y.v,Fe.va=y.va,Fe.j=y.j,Fe.o=y.o,ae.$a)e:{e(ae.$a==1),y=ur();t:for(;;){if(y==null){y=0;break e}if(e(ae!=null),ae.mc=y,y.c=ae.c,y.i=ae.i,y.l=ae.l,y.l.ma=ae,y.l.width=ae.c,y.l.height=ae.i,y.a=0,ee(y.m,oe,me,Ee),!kr(ae.c,ae.i,1,y,null)||(y.ab==1&&y.gc[0].hc==3&&Js(y.s)?(ae.ic=1,oe=y.c*y.i,y.Ta=null,y.Ua=0,y.V=i(oe),y.Ba=0,y.V==null?(y.a=1,y=0):y=1):(ae.ic=0,y=Zr(y,ae.c)),!y))break t;y=1;break e}ae.mc=null,y=0}else y=Ee>=ae.c*ae.i;ae=!y}if(ae)return null;p.ga.Lc!=1?p.Ga=0:_=se-F}e(p.ga!=null),e(F+_<=se);e:{if(y=(oe=p.ga).c,se=oe.l.o,oe.$a==0){if(me=p.rc,Ee=p.Vc,Fe=p.Fa,Ae=p.P+1+F*y,ue=p.mb,Ce=p.nb+F*y,e(Ae<=p.P+p.qc),oe.Z!=0)for(e(io[oe.Z]!=null),ae=0;ae<_;++ae)io[oe.Z](me,Ee,Fe,Ae,ue,Ce,y),me=ue,Ee=Ce,Ce+=y,Ae+=y;else for(ae=0;ae<_;++ae)a(ue,Ce,Fe,Ae,y),me=ue,Ee=Ce,Ce+=y,Ae+=y;p.rc=me,p.Vc=Ee}else{if(e(oe.mc!=null),y=F+_,e((ae=oe.mc)!=null),e(y<=ae.i),ae.C>=y)y=1;else if(oe.ic||xs(),oe.ic){oe=ae.V,me=ae.Ba,Ee=ae.c;var He=ae.i,Ue=(Fe=1,Ae=ae.$/Ee,ue=ae.$%Ee,Ce=ae.m,De=ae.s,ae.$),Ve=Ee*He,Ke=Ee*y,tt=De.wc,Je=Ue<Ke?Vt(De,ue,Ae):null;e(Ue<=Ve),e(y<=He),e(Js(De));t:for(;;){for(;!Ce.h&&Ue<Ke;){if(ue&tt||(Je=Vt(De,ue,Ae)),e(Je!=null),X(Ce),256>(He=Nt(Je.G[0],Je.H[0],Ce)))oe[me+Ue]=He,++Ue,++ue>=Ee&&(ue=0,++Ae<=y&&!(Ae%16)&&Zs(ae,Ae));else{if(!(280>He)){Fe=0;break t}He=ks(He-256,Ce);var Lt,jt=Nt(Je.G[4],Je.H[4],Ce);if(X(Ce),!(Ue>=(jt=Is(Ee,jt=ks(jt,Ce)))&&Ve-Ue>=He)){Fe=0;break t}for(Lt=0;Lt<He;++Lt)oe[me+Ue+Lt]=oe[me+Ue+Lt-jt];for(Ue+=He,ue+=He;ue>=Ee;)ue-=Ee,++Ae<=y&&!(Ae%16)&&Zs(ae,Ae);Ue<Ke&&ue&tt&&(Je=Vt(De,ue,Ae))}e(Ce.h==te(Ce))}Zs(ae,Ae>y?y:Ae);break t}!Fe||Ce.h&&Ue<Ve?(Fe=0,ae.a=Ce.h?5:3):ae.$=Ue,y=Fe}else y=Ot(ae,ae.V,ae.Ba,ae.c,ae.i,y,Qa);if(!y){_=0;break e}}F+_>=se&&(p.Cc=1),_=1}if(!_)return null;if(p.Cc&&((_=p.ga)!=null&&(_.mc=null),p.ga=null,0<p.Ga))return alert("todo:WebPDequantizeLevels"),null}return p.nb+F*Z}function cs(p,y,F,_,Z,se){for(;0<Z--;){var ae,oe=p,Ae=y+(F?1:0),ue=p,Ce=y+(F?0:3);for(ae=0;ae<_;++ae){var De=ue[Ce+4*ae];De!=255&&(De*=32897,oe[Ae+4*ae+0]=oe[Ae+4*ae+0]*De>>23,oe[Ae+4*ae+1]=oe[Ae+4*ae+1]*De>>23,oe[Ae+4*ae+2]=oe[Ae+4*ae+2]*De>>23)}y+=se}}function As(p,y,F,_,Z){for(;0<_--;){var se;for(se=0;se<F;++se){var ae=p[y+2*se+0],oe=15&(ue=p[y+2*se+1]),Ae=4369*oe,ue=(240&ue|ue>>4)*Ae>>16;p[y+2*se+0]=(240&ae|ae>>4)*Ae>>16&240|(15&ae|ae<<4)*Ae>>16>>4&15,p[y+2*se+1]=240&ue|oe}y+=Z}}function Fs(p,y,F,_,Z,se,ae,oe){var Ae,ue,Ce=255;for(ue=0;ue<Z;++ue){for(Ae=0;Ae<_;++Ae){var De=p[y+Ae];se[ae+4*Ae]=De,Ce&=De}y+=F,ae+=oe}return Ce!=255}function za(p,y,F,_,Z){var se;for(se=0;se<Z;++se)F[_+se]=p[y+se]>>8}function xs(){Nc=cs,ng=As,ig=Fs,og=za}function cr(p,y,F){k[p]=function(_,Z,se,ae,oe,Ae,ue,Ce,De,me,Ee,Fe,He,Ue,Ve,Ke,tt){var Je,Lt=tt-1>>1,jt=oe[Ae+0]|ue[Ce+0]<<16,ss=De[me+0]|Ee[Fe+0]<<16;e(_!=null);var Pt=3*jt+ss+131074>>2;for(y(_[Z+0],255&Pt,Pt>>16,He,Ue),se!=null&&(Pt=3*ss+jt+131074>>2,y(se[ae+0],255&Pt,Pt>>16,Ve,Ke)),Je=1;Je<=Lt;++Je){var hs=oe[Ae+Je]|ue[Ce+Je]<<16,_r=De[me+Je]|Ee[Fe+Je]<<16,rs=jt+hs+ss+_r+524296,Ut=rs+2*(hs+ss)>>3;Pt=Ut+jt>>1,jt=(rs=rs+2*(jt+_r)>>3)+hs>>1,y(_[Z+2*Je-1],255&Pt,Pt>>16,He,Ue+(2*Je-1)*F),y(_[Z+2*Je-0],255&jt,jt>>16,He,Ue+(2*Je-0)*F),se!=null&&(Pt=rs+ss>>1,jt=Ut+_r>>1,y(se[ae+2*Je-1],255&Pt,Pt>>16,Ve,Ke+(2*Je-1)*F),y(se[ae+2*Je+0],255&jt,jt>>16,Ve,Ke+(2*Je+0)*F)),jt=hs,ss=_r}1&tt||(Pt=3*jt+ss+131074>>2,y(_[Z+tt-1],255&Pt,Pt>>16,He,Ue+(tt-1)*F),se!=null&&(Pt=3*ss+jt+131074>>2,y(se[ae+tt-1],255&Pt,Pt>>16,Ve,Ke+(tt-1)*F)))}}function Cs(){jn[UA]=j1,jn[LA]=xg,jn[mg]=E1,jn[DA]=yg,jn[RA]=bg,jn[dm]=vg,jn[hg]=k1,jn[um]=xg,jn[mm]=yg,jn[MA]=bg,jn[hm]=vg}function zs(p){return p&-16384?0>p?0:255:p>>I1}function Ps(p,y){return zs((19077*p>>8)+(26149*y>>8)-14234)}function _t(p,y,F){return zs((19077*p>>8)-(6419*y>>8)-(13320*F>>8)+8708)}function aa(p,y){return zs((19077*p>>8)+(33050*y>>8)-17685)}function wt(p,y,F,_,Z){_[Z+0]=Ps(p,F),_[Z+1]=_t(p,y,F),_[Z+2]=aa(p,y)}function vs(p,y,F,_,Z){_[Z+0]=aa(p,y),_[Z+1]=_t(p,y,F),_[Z+2]=Ps(p,F)}function vn(p,y,F,_,Z){var se=_t(p,y,F);y=se<<3&224|aa(p,y)>>3,_[Z+0]=248&Ps(p,F)|se>>5,_[Z+1]=y}function wn(p,y,F,_,Z){var se=240&aa(p,y)|15;_[Z+0]=240&Ps(p,F)|_t(p,y,F)>>4,_[Z+1]=se}function Ar(p,y,F,_,Z){_[Z+0]=255,wt(p,y,F,_,Z+1)}function eo(p,y,F,_,Z){vs(p,y,F,_,Z),_[Z+3]=255}function hr(p,y,F,_,Z){wt(p,y,F,_,Z),_[Z+3]=255}function Cn(p,y,F){k[p]=function(_,Z,se,ae,oe,Ae,ue,Ce,De){for(var me=Ce+(-2&De)*F;Ce!=me;)y(_[Z+0],se[ae+0],oe[Ae+0],ue,Ce),y(_[Z+1],se[ae+0],oe[Ae+0],ue,Ce+F),Z+=2,++ae,++Ae,Ce+=2*F;1&De&&y(_[Z+0],se[ae+0],oe[Ae+0],ue,Ce)}}function Li(p,y,F){return F==0?p==0?y==0?6:5:y==0?4:0:F}function nt(p,y,F,_,Z){switch(p>>>30){case 3:Mo(y,F,_,Z,0);break;case 2:Bn(y,F,_,Z);break;case 1:Ss(y,F,_,Z)}}function Mt(p,y){var F,_,Z=y.M,se=y.Nb,ae=p.oc,oe=p.pc+40,Ae=p.oc,ue=p.pc+584,Ce=p.oc,De=p.pc+600;for(F=0;16>F;++F)ae[oe+32*F-1]=129;for(F=0;8>F;++F)Ae[ue+32*F-1]=129,Ce[De+32*F-1]=129;for(0<Z?ae[oe-1-32]=Ae[ue-1-32]=Ce[De-1-32]=129:(n(ae,oe-32-1,127,21),n(Ae,ue-32-1,127,9),n(Ce,De-32-1,127,9)),_=0;_<p.za;++_){var me=y.ya[y.aa+_];if(0<_){for(F=-1;16>F;++F)a(ae,oe+32*F-4,ae,oe+32*F+12,4);for(F=-1;8>F;++F)a(Ae,ue+32*F-4,Ae,ue+32*F+4,4),a(Ce,De+32*F-4,Ce,De+32*F+4,4)}var Ee=p.Gd,Fe=p.Hd+_,He=me.ad,Ue=me.Hc;if(0<Z&&(a(ae,oe-32,Ee[Fe].y,0,16),a(Ae,ue-32,Ee[Fe].f,0,8),a(Ce,De-32,Ee[Fe].ea,0,8)),me.Za){var Ve=ae,Ke=oe-32+16;for(0<Z&&(_>=p.za-1?n(Ve,Ke,Ee[Fe].y[15],4):a(Ve,Ke,Ee[Fe+1].y,0,4)),F=0;4>F;F++)Ve[Ke+128+F]=Ve[Ke+256+F]=Ve[Ke+384+F]=Ve[Ke+0+F];for(F=0;16>F;++F,Ue<<=2)Ve=ae,Ke=oe+Cg[F],Vn[me.Ob[F]](Ve,Ke),nt(Ue,He,16*+F,Ve,Ke)}else if(Ve=Li(_,Z,me.Ob[0]),no[Ve](ae,oe),Ue!=0)for(F=0;16>F;++F,Ue<<=2)nt(Ue,He,16*+F,ae,oe+Cg[F]);for(F=me.Gc,Ve=Li(_,Z,me.Dd),Ri[Ve](Ae,ue),Ri[Ve](Ce,De),Ue=He,Ve=Ae,Ke=ue,255&(me=0|F)&&(170&me?mi(Ue,256,Ve,Ke):$s(Ue,256,Ve,Ke)),me=Ce,Ue=De,255&(F>>=8)&&(170&F?mi(He,320,me,Ue):$s(He,320,me,Ue)),Z<p.Ub-1&&(a(Ee[Fe].y,0,ae,oe+480,16),a(Ee[Fe].f,0,Ae,ue+224,8),a(Ee[Fe].ea,0,Ce,De+224,8)),F=8*se*p.B,Ee=p.sa,Fe=p.ta+16*_+16*se*p.R,He=p.qa,me=p.ra+8*_+F,Ue=p.Ha,Ve=p.Ia+8*_+F,F=0;16>F;++F)a(Ee,Fe+F*p.R,ae,oe+32*F,16);for(F=0;8>F;++F)a(He,me+F*p.B,Ae,ue+32*F,8),a(Ue,Ve+F*p.B,Ce,De+32*F,8)}}function is(p,y,F,_,Z,se,ae,oe,Ae){var ue=[0],Ce=[0],De=0,me=Ae!=null?Ae.kd:0,Ee=Ae??new je;if(p==null||12>F)return 7;Ee.data=p,Ee.w=y,Ee.ha=F,y=[y],F=[F],Ee.gb=[Ee.gb];e:{var Fe=y,He=F,Ue=Ee.gb;if(e(p!=null),e(He!=null),e(Ue!=null),Ue[0]=0,12<=He[0]&&!r(p,Fe[0],"RIFF")){if(r(p,Fe[0]+8,"WEBP")){Ue=3;break e}var Ve=Re(p,Fe[0]+4);if(12>Ve||4294967286<Ve){Ue=3;break e}if(me&&Ve>He[0]-8){Ue=7;break e}Ue[0]=Ve,Fe[0]+=12,He[0]-=12}Ue=0}if(Ue!=0)return Ue;for(Ve=0<Ee.gb[0],F=F[0];;){e:{var Ke=p;He=y,Ue=F;var tt=ue,Je=Ce,Lt=Fe=[0];if((Pt=De=[De])[0]=0,8>Ue[0])Ue=7;else{if(!r(Ke,He[0],"VP8X")){if(Re(Ke,He[0]+4)!=10){Ue=3;break e}if(18>Ue[0]){Ue=7;break e}var jt=Re(Ke,He[0]+8),ss=1+Be(Ke,He[0]+12);if(2147483648<=ss*(Ke=1+Be(Ke,He[0]+15))){Ue=3;break e}Lt!=null&&(Lt[0]=jt),tt!=null&&(tt[0]=ss),Je!=null&&(Je[0]=Ke),He[0]+=18,Ue[0]-=18,Pt[0]=1}Ue=0}}if(De=De[0],Fe=Fe[0],Ue!=0)return Ue;if(He=!!(2&Fe),!Ve&&De)return 3;if(se!=null&&(se[0]=!!(16&Fe)),ae!=null&&(ae[0]=He),oe!=null&&(oe[0]=0),ae=ue[0],Fe=Ce[0],De&&He&&Ae==null){Ue=0;break}if(4>F){Ue=7;break}if(Ve&&De||!Ve&&!De&&!r(p,y[0],"ALPH")){F=[F],Ee.na=[Ee.na],Ee.P=[Ee.P],Ee.Sa=[Ee.Sa];e:{jt=p,Ue=y,Ve=F;var Pt=Ee.gb;tt=Ee.na,Je=Ee.P,Lt=Ee.Sa,ss=22,e(jt!=null),e(Ve!=null),Ke=Ue[0];var hs=Ve[0];for(e(tt!=null),e(Lt!=null),tt[0]=null,Je[0]=null,Lt[0]=0;;){if(Ue[0]=Ke,Ve[0]=hs,8>hs){Ue=7;break e}var _r=Re(jt,Ke+4);if(4294967286<_r){Ue=3;break e}var rs=8+_r+1&-2;if(ss+=rs,0<Pt&&ss>Pt){Ue=3;break e}if(!r(jt,Ke,"VP8 ")||!r(jt,Ke,"VP8L")){Ue=0;break e}if(hs[0]<rs){Ue=7;break e}r(jt,Ke,"ALPH")||(tt[0]=jt,Je[0]=Ke+8,Lt[0]=_r),Ke+=rs,hs-=rs}}if(F=F[0],Ee.na=Ee.na[0],Ee.P=Ee.P[0],Ee.Sa=Ee.Sa[0],Ue!=0)break}F=[F],Ee.Ja=[Ee.Ja],Ee.xa=[Ee.xa];e:if(Pt=p,Ue=y,Ve=F,tt=Ee.gb[0],Je=Ee.Ja,Lt=Ee.xa,jt=Ue[0],Ke=!r(Pt,jt,"VP8 "),ss=!r(Pt,jt,"VP8L"),e(Pt!=null),e(Ve!=null),e(Je!=null),e(Lt!=null),8>Ve[0])Ue=7;else{if(Ke||ss){if(Pt=Re(Pt,jt+4),12<=tt&&Pt>tt-12){Ue=3;break e}if(me&&Pt>Ve[0]-8){Ue=7;break e}Je[0]=Pt,Ue[0]+=8,Ve[0]-=8,Lt[0]=ss}else Lt[0]=5<=Ve[0]&&Pt[jt+0]==47&&!(Pt[jt+4]>>5),Je[0]=Ve[0];Ue=0}if(F=F[0],Ee.Ja=Ee.Ja[0],Ee.xa=Ee.xa[0],y=y[0],Ue!=0)break;if(4294967286<Ee.Ja)return 3;if(oe==null||He||(oe[0]=Ee.xa?2:1),ae=[ae],Fe=[Fe],Ee.xa){if(5>F){Ue=7;break}oe=ae,me=Fe,He=se,p==null||5>F?p=0:5<=F&&p[y+0]==47&&!(p[y+4]>>5)?(Ve=[0],Pt=[0],tt=[0],ee(Je=new H,p,y,F),Hs(Je,Ve,Pt,tt)?(oe!=null&&(oe[0]=Ve[0]),me!=null&&(me[0]=Pt[0]),He!=null&&(He[0]=tt[0]),p=1):p=0):p=0}else{if(10>F){Ue=7;break}oe=Fe,p==null||10>F||!On(p,y+3,F-3)?p=0:(me=p[y+0]|p[y+1]<<8|p[y+2]<<16,He=16383&(p[y+7]<<8|p[y+6]),p=16383&(p[y+9]<<8|p[y+8]),1&me||3<(me>>1&7)||!(me>>4&1)||me>>5>=Ee.Ja||!He||!p?p=0:(ae&&(ae[0]=He),oe&&(oe[0]=p),p=1))}if(!p||(ae=ae[0],Fe=Fe[0],De&&(ue[0]!=ae||Ce[0]!=Fe)))return 3;Ae!=null&&(Ae[0]=Ee,Ae.offset=y-Ae.w,e(4294967286>y-Ae.w),e(Ae.offset==Ae.ha-F));break}return Ue==0||Ue==7&&De&&Ae==null?(se!=null&&(se[0]|=Ee.na!=null&&0<Ee.na.length),_!=null&&(_[0]=ae),Z!=null&&(Z[0]=Fe),0):Ue}function qr(p,y,F){var _=y.width,Z=y.height,se=0,ae=0,oe=_,Ae=Z;if(y.Da=p!=null&&0<p.Da,y.Da&&(oe=p.cd,Ae=p.bd,se=p.v,ae=p.j,11>F||(se&=-2,ae&=-2),0>se||0>ae||0>=oe||0>=Ae||se+oe>_||ae+Ae>Z))return 0;if(y.v=se,y.j=ae,y.va=se+oe,y.o=ae+Ae,y.U=oe,y.T=Ae,y.da=p!=null&&0<p.da,y.da){if(!be(oe,Ae,F=[p.ib],se=[p.hb]))return 0;y.ib=F[0],y.hb=se[0]}return y.ob=p!=null&&p.ob,y.Kb=p==null||!p.Sd,y.da&&(y.ob=y.ib<3*_/4&&y.hb<3*Z/4,y.Kb=0),1}function Ir(p){if(p==null)return 2;if(11>p.S){var y=p.f.RGBA;y.fb+=(p.height-1)*y.A,y.A=-y.A}else y=p.f.kb,p=p.height,y.O+=(p-1)*y.fa,y.fa=-y.fa,y.N+=(p-1>>1)*y.Ab,y.Ab=-y.Ab,y.W+=(p-1>>1)*y.Db,y.Db=-y.Db,y.F!=null&&(y.J+=(p-1)*y.lb,y.lb=-y.lb);return 0}function ms(p,y,F,_){if(_==null||0>=p||0>=y)return 2;if(F!=null){if(F.Da){var Z=F.cd,se=F.bd,ae=-2&F.v,oe=-2&F.j;if(0>ae||0>oe||0>=Z||0>=se||ae+Z>p||oe+se>y)return 2;p=Z,y=se}if(F.da){if(!be(p,y,Z=[F.ib],se=[F.hb]))return 2;p=Z[0],y=se[0]}}_.width=p,_.height=y;e:{var Ae=_.width,ue=_.height;if(p=_.S,0>=Ae||0>=ue||!(p>=UA&&13>p))p=2;else{if(0>=_.Rd&&_.sd==null){ae=se=Z=y=0;var Ce=(oe=Ae*Ng[p])*ue;if(11>p||(se=(ue+1)/2*(y=(Ae+1)/2),p==12&&(ae=(Z=Ae)*ue)),(ue=i(Ce+2*se+ae))==null){p=1;break e}_.sd=ue,11>p?((Ae=_.f.RGBA).eb=ue,Ae.fb=0,Ae.A=oe,Ae.size=Ce):((Ae=_.f.kb).y=ue,Ae.O=0,Ae.fa=oe,Ae.Fd=Ce,Ae.f=ue,Ae.N=0+Ce,Ae.Ab=y,Ae.Cd=se,Ae.ea=ue,Ae.W=0+Ce+se,Ae.Db=y,Ae.Ed=se,p==12&&(Ae.F=ue,Ae.J=0+Ce+2*se),Ae.Tc=ae,Ae.lb=Z)}if(y=1,Z=_.S,se=_.width,ae=_.height,Z>=UA&&13>Z)if(11>Z)p=_.f.RGBA,y&=(oe=Math.abs(p.A))*(ae-1)+se<=p.size,y&=oe>=se*Ng[Z],y&=p.eb!=null;else{p=_.f.kb,oe=(se+1)/2,Ce=(ae+1)/2,Ae=Math.abs(p.fa),ue=Math.abs(p.Ab);var De=Math.abs(p.Db),me=Math.abs(p.lb),Ee=me*(ae-1)+se;y&=Ae*(ae-1)+se<=p.Fd,y&=ue*(Ce-1)+oe<=p.Cd,y=(y&=De*(Ce-1)+oe<=p.Ed)&Ae>=se&ue>=oe&De>=oe,y&=p.y!=null,y&=p.f!=null,y&=p.ea!=null,Z==12&&(y&=me>=se,y&=Ee<=p.Tc,y&=p.F!=null)}else y=0;p=y?0:2}}return p!=0||F!=null&&F.fd&&(p=Ir(_)),p}var ga=64,rr=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535,131071,262143,524287,1048575,2097151,4194303,8388607,16777215],Ns=24,Hn=32,Nn=8,Ai=[0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7];pe("Predictor0","PredictorAdd0"),k.Predictor0=function(){return 4278190080},k.Predictor1=function(p){return p},k.Predictor2=function(p,y,F){return y[F+0]},k.Predictor3=function(p,y,F){return y[F+1]},k.Predictor4=function(p,y,F){return y[F-1]},k.Predictor5=function(p,y,F){return we(we(p,y[F+1]),y[F+0])},k.Predictor6=function(p,y,F){return we(p,y[F-1])},k.Predictor7=function(p,y,F){return we(p,y[F+0])},k.Predictor8=function(p,y,F){return we(y[F-1],y[F+0])},k.Predictor9=function(p,y,F){return we(y[F+0],y[F+1])},k.Predictor10=function(p,y,F){return we(we(p,y[F-1]),we(y[F+0],y[F+1]))},k.Predictor11=function(p,y,F){var _=y[F+0];return 0>=Ne(_>>24&255,p>>24&255,(y=y[F-1])>>24&255)+Ne(_>>16&255,p>>16&255,y>>16&255)+Ne(_>>8&255,p>>8&255,y>>8&255)+Ne(255&_,255&p,255&y)?_:p},k.Predictor12=function(p,y,F){var _=y[F+0];return(de((p>>24&255)+(_>>24&255)-((y=y[F-1])>>24&255))<<24|de((p>>16&255)+(_>>16&255)-(y>>16&255))<<16|de((p>>8&255)+(_>>8&255)-(y>>8&255))<<8|de((255&p)+(255&_)-(255&y)))>>>0},k.Predictor13=function(p,y,F){var _=y[F-1];return(xe((p=we(p,y[F+0]))>>24&255,_>>24&255)<<24|xe(p>>16&255,_>>16&255)<<16|xe(p>>8&255,_>>8&255)<<8|xe(255&p,255&_))>>>0};var xc=k.PredictorAdd0;k.PredictorAdd1=it,pe("Predictor2","PredictorAdd2"),pe("Predictor3","PredictorAdd3"),pe("Predictor4","PredictorAdd4"),pe("Predictor5","PredictorAdd5"),pe("Predictor6","PredictorAdd6"),pe("Predictor7","PredictorAdd7"),pe("Predictor8","PredictorAdd8"),pe("Predictor9","PredictorAdd9"),pe("Predictor10","PredictorAdd10"),pe("Predictor11","PredictorAdd11"),pe("Predictor12","PredictorAdd12"),pe("Predictor13","PredictorAdd13");var fl=k.PredictorAdd2;Ze("ColorIndexInverseTransform","MapARGB","32b",function(p){return p>>8&255},function(p){return p}),Ze("VP8LColorIndexInverseTransformAlpha","MapAlpha","8b",function(p){return p},function(p){return p>>8&255});var br,TA=k.ColorIndexInverseTransform,di=k.MapARGB,ui=k.VP8LColorIndexInverseTransformAlpha,yc=k.MapAlpha,bc=k.VP8LPredictorsAdd=[];bc.length=16,(k.VP8LPredictors=[]).length=16,(k.VP8LPredictorsAdd_C=[]).length=16,(k.VP8LPredictors_C=[]).length=16;var vc,wc,to,so,ro,Ro,ao,Mo,Bn,mi,Ss,$s,vr,Mr,Di,Cc,xl,FA,Zp,eg,tg,sg,rg,ag,Nc,ng,ig,og,lg=i(511),cg=i(2041),Ag=i(225),dg=i(767),ug=0,Am=cg,PA=Ag,ln=dg,Sn=lg,UA=0,LA=1,mg=2,DA=3,RA=4,dm=5,hg=6,um=7,mm=8,MA=9,hm=10,m1=[2,3,7],h1=[3,3,11],pg=[280,256,256,256,40],p1=[0,1,1,1,0],g1=[17,18,0,1,2,3,4,5,16,6,7,8,9,10,11,12,13,14,15],f1=[24,7,23,25,40,6,39,41,22,26,38,42,56,5,55,57,21,27,54,58,37,43,72,4,71,73,20,28,53,59,70,74,36,44,88,69,75,52,60,3,87,89,19,29,86,90,35,45,68,76,85,91,51,61,104,2,103,105,18,30,102,106,34,46,84,92,67,77,101,107,50,62,120,1,119,121,83,93,17,31,100,108,66,78,118,122,33,47,117,123,49,63,99,109,82,94,0,116,124,65,79,16,32,98,110,48,115,125,81,95,64,114,126,97,111,80,113,127,96,112],x1=[2954,2956,2958,2962,2970,2986,3018,3082,3212,3468,3980,5004],y1=8,pm=[4,5,6,7,8,9,10,10,11,12,13,14,15,16,17,17,18,19,20,20,21,21,22,22,23,23,24,25,25,26,27,28,29,30,31,32,33,34,35,36,37,37,38,39,40,41,42,43,44,45,46,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,76,77,78,79,80,81,82,83,84,85,86,87,88,89,91,93,95,96,98,100,101,102,104,106,108,110,112,114,116,118,122,124,126,128,130,132,134,136,138,140,143,145,148,151,154,157],gm=[4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,60,62,64,66,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,108,110,112,114,116,119,122,125,128,131,134,137,140,143,146,149,152,155,158,161,164,167,170,173,177,181,185,189,193,197,201,205,209,213,217,221,225,229,234,239,245,249,254,259,264,269,274,279,284],Bc=null,b1=[[173,148,140,0],[176,155,140,135,0],[180,157,141,134,130,0],[254,254,243,230,196,177,153,140,133,130,129,0]],v1=[0,1,4,8,5,2,3,6,9,12,13,10,7,11,14,15],gg=[-0,1,-1,2,-2,3,4,6,-3,5,-4,-5,-6,7,-7,8,-8,-9],w1=[[[[128,128,128,128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128,128,128,128]],[[253,136,254,255,228,219,128,128,128,128,128],[189,129,242,255,227,213,255,219,128,128,128],[106,126,227,252,214,209,255,255,128,128,128]],[[1,98,248,255,236,226,255,255,128,128,128],[181,133,238,254,221,234,255,154,128,128,128],[78,134,202,247,198,180,255,219,128,128,128]],[[1,185,249,255,243,255,128,128,128,128,128],[184,150,247,255,236,224,128,128,128,128,128],[77,110,216,255,236,230,128,128,128,128,128]],[[1,101,251,255,241,255,128,128,128,128,128],[170,139,241,252,236,209,255,255,128,128,128],[37,116,196,243,228,255,255,255,128,128,128]],[[1,204,254,255,245,255,128,128,128,128,128],[207,160,250,255,238,128,128,128,128,128,128],[102,103,231,255,211,171,128,128,128,128,128]],[[1,152,252,255,240,255,128,128,128,128,128],[177,135,243,255,234,225,128,128,128,128,128],[80,129,211,255,194,224,128,128,128,128,128]],[[1,1,255,128,128,128,128,128,128,128,128],[246,1,255,128,128,128,128,128,128,128,128],[255,128,128,128,128,128,128,128,128,128,128]]],[[[198,35,237,223,193,187,162,160,145,155,62],[131,45,198,221,172,176,220,157,252,221,1],[68,47,146,208,149,167,221,162,255,223,128]],[[1,149,241,255,221,224,255,255,128,128,128],[184,141,234,253,222,220,255,199,128,128,128],[81,99,181,242,176,190,249,202,255,255,128]],[[1,129,232,253,214,197,242,196,255,255,128],[99,121,210,250,201,198,255,202,128,128,128],[23,91,163,242,170,187,247,210,255,255,128]],[[1,200,246,255,234,255,128,128,128,128,128],[109,178,241,255,231,245,255,255,128,128,128],[44,130,201,253,205,192,255,255,128,128,128]],[[1,132,239,251,219,209,255,165,128,128,128],[94,136,225,251,218,190,255,255,128,128,128],[22,100,174,245,186,161,255,199,128,128,128]],[[1,182,249,255,232,235,128,128,128,128,128],[124,143,241,255,227,234,128,128,128,128,128],[35,77,181,251,193,211,255,205,128,128,128]],[[1,157,247,255,236,231,255,255,128,128,128],[121,141,235,255,225,227,255,255,128,128,128],[45,99,188,251,195,217,255,224,128,128,128]],[[1,1,251,255,213,255,128,128,128,128,128],[203,1,248,255,255,128,128,128,128,128,128],[137,1,177,255,224,255,128,128,128,128,128]]],[[[253,9,248,251,207,208,255,192,128,128,128],[175,13,224,243,193,185,249,198,255,255,128],[73,17,171,221,161,179,236,167,255,234,128]],[[1,95,247,253,212,183,255,255,128,128,128],[239,90,244,250,211,209,255,255,128,128,128],[155,77,195,248,188,195,255,255,128,128,128]],[[1,24,239,251,218,219,255,205,128,128,128],[201,51,219,255,196,186,128,128,128,128,128],[69,46,190,239,201,218,255,228,128,128,128]],[[1,191,251,255,255,128,128,128,128,128,128],[223,165,249,255,213,255,128,128,128,128,128],[141,124,248,255,255,128,128,128,128,128,128]],[[1,16,248,255,255,128,128,128,128,128,128],[190,36,230,255,236,255,128,128,128,128,128],[149,1,255,128,128,128,128,128,128,128,128]],[[1,226,255,128,128,128,128,128,128,128,128],[247,192,255,128,128,128,128,128,128,128,128],[240,128,255,128,128,128,128,128,128,128,128]],[[1,134,252,255,255,128,128,128,128,128,128],[213,62,250,255,255,128,128,128,128,128,128],[55,93,255,128,128,128,128,128,128,128,128]],[[128,128,128,128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128,128,128,128]]],[[[202,24,213,235,186,191,220,160,240,175,255],[126,38,182,232,169,184,228,174,255,187,128],[61,46,138,219,151,178,240,170,255,216,128]],[[1,112,230,250,199,191,247,159,255,255,128],[166,109,228,252,211,215,255,174,128,128,128],[39,77,162,232,172,180,245,178,255,255,128]],[[1,52,220,246,198,199,249,220,255,255,128],[124,74,191,243,183,193,250,221,255,255,128],[24,71,130,219,154,170,243,182,255,255,128]],[[1,182,225,249,219,240,255,224,128,128,128],[149,150,226,252,216,205,255,171,128,128,128],[28,108,170,242,183,194,254,223,255,255,128]],[[1,81,230,252,204,203,255,192,128,128,128],[123,102,209,247,188,196,255,233,128,128,128],[20,95,153,243,164,173,255,203,128,128,128]],[[1,222,248,255,216,213,128,128,128,128,128],[168,175,246,252,235,205,255,255,128,128,128],[47,116,215,255,211,212,255,255,128,128,128]],[[1,121,236,253,212,214,255,255,128,128,128],[141,84,213,252,201,202,255,219,128,128,128],[42,80,160,240,162,185,255,205,128,128,128]],[[1,1,255,128,128,128,128,128,128,128,128],[244,1,255,128,128,128,128,128,128,128,128],[238,1,255,128,128,128,128,128,128,128,128]]]],C1=[[[231,120,48,89,115,113,120,152,112],[152,179,64,126,170,118,46,70,95],[175,69,143,80,85,82,72,155,103],[56,58,10,171,218,189,17,13,152],[114,26,17,163,44,195,21,10,173],[121,24,80,195,26,62,44,64,85],[144,71,10,38,171,213,144,34,26],[170,46,55,19,136,160,33,206,71],[63,20,8,114,114,208,12,9,226],[81,40,11,96,182,84,29,16,36]],[[134,183,89,137,98,101,106,165,148],[72,187,100,130,157,111,32,75,80],[66,102,167,99,74,62,40,234,128],[41,53,9,178,241,141,26,8,107],[74,43,26,146,73,166,49,23,157],[65,38,105,160,51,52,31,115,128],[104,79,12,27,217,255,87,17,7],[87,68,71,44,114,51,15,186,23],[47,41,14,110,182,183,21,17,194],[66,45,25,102,197,189,23,18,22]],[[88,88,147,150,42,46,45,196,205],[43,97,183,117,85,38,35,179,61],[39,53,200,87,26,21,43,232,171],[56,34,51,104,114,102,29,93,77],[39,28,85,171,58,165,90,98,64],[34,22,116,206,23,34,43,166,73],[107,54,32,26,51,1,81,43,31],[68,25,106,22,64,171,36,225,114],[34,19,21,102,132,188,16,76,124],[62,18,78,95,85,57,50,48,51]],[[193,101,35,159,215,111,89,46,111],[60,148,31,172,219,228,21,18,111],[112,113,77,85,179,255,38,120,114],[40,42,1,196,245,209,10,25,109],[88,43,29,140,166,213,37,43,154],[61,63,30,155,67,45,68,1,209],[100,80,8,43,154,1,51,26,71],[142,78,78,16,255,128,34,197,171],[41,40,5,102,211,183,4,1,221],[51,50,17,168,209,192,23,25,82]],[[138,31,36,171,27,166,38,44,229],[67,87,58,169,82,115,26,59,179],[63,59,90,180,59,166,93,73,154],[40,40,21,116,143,209,34,39,175],[47,15,16,183,34,223,49,45,183],[46,17,33,183,6,98,15,32,183],[57,46,22,24,128,1,54,17,37],[65,32,73,115,28,128,23,128,205],[40,3,9,115,51,192,18,6,223],[87,37,9,115,59,77,64,21,47]],[[104,55,44,218,9,54,53,130,226],[64,90,70,205,40,41,23,26,57],[54,57,112,184,5,41,38,166,213],[30,34,26,133,152,116,10,32,134],[39,19,53,221,26,114,32,73,255],[31,9,65,234,2,15,1,118,73],[75,32,12,51,192,255,160,43,51],[88,31,35,67,102,85,55,186,85],[56,21,23,111,59,205,45,37,192],[55,38,70,124,73,102,1,34,98]],[[125,98,42,88,104,85,117,175,82],[95,84,53,89,128,100,113,101,45],[75,79,123,47,51,128,81,171,1],[57,17,5,71,102,57,53,41,49],[38,33,13,121,57,73,26,1,85],[41,10,67,138,77,110,90,47,114],[115,21,2,10,102,255,166,23,6],[101,29,16,10,85,128,101,196,26],[57,18,10,102,102,213,34,20,43],[117,20,15,36,163,128,68,1,26]],[[102,61,71,37,34,53,31,243,192],[69,60,71,38,73,119,28,222,37],[68,45,128,34,1,47,11,245,171],[62,17,19,70,146,85,55,62,70],[37,43,37,154,100,163,85,160,1],[63,9,92,136,28,64,32,201,85],[75,15,9,9,64,255,184,119,16],[86,6,28,5,64,255,25,248,1],[56,8,17,132,137,255,55,116,128],[58,15,20,82,135,57,26,121,40]],[[164,50,31,137,154,133,25,35,218],[51,103,44,131,131,123,31,6,158],[86,40,64,135,148,224,45,183,128],[22,26,17,131,240,154,14,1,209],[45,16,21,91,64,222,7,1,197],[56,21,39,155,60,138,23,102,213],[83,12,13,54,192,255,68,47,28],[85,26,85,85,128,128,32,146,171],[18,11,7,63,144,171,4,4,246],[35,27,10,146,174,171,12,26,128]],[[190,80,35,99,180,80,126,54,45],[85,126,47,87,176,51,41,20,32],[101,75,128,139,118,146,116,128,85],[56,41,15,176,236,85,37,9,62],[71,30,17,119,118,255,17,18,138],[101,38,60,138,55,70,43,26,142],[146,36,19,30,171,255,97,27,20],[138,45,61,62,219,1,81,188,64],[32,41,20,117,151,142,20,21,163],[112,19,12,61,195,128,48,4,24]]],N1=[[[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[176,246,255,255,255,255,255,255,255,255,255],[223,241,252,255,255,255,255,255,255,255,255],[249,253,253,255,255,255,255,255,255,255,255]],[[255,244,252,255,255,255,255,255,255,255,255],[234,254,254,255,255,255,255,255,255,255,255],[253,255,255,255,255,255,255,255,255,255,255]],[[255,246,254,255,255,255,255,255,255,255,255],[239,253,254,255,255,255,255,255,255,255,255],[254,255,254,255,255,255,255,255,255,255,255]],[[255,248,254,255,255,255,255,255,255,255,255],[251,255,254,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,253,254,255,255,255,255,255,255,255,255],[251,254,254,255,255,255,255,255,255,255,255],[254,255,254,255,255,255,255,255,255,255,255]],[[255,254,253,255,254,255,255,255,255,255,255],[250,255,254,255,254,255,255,255,255,255,255],[254,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]]],[[[217,255,255,255,255,255,255,255,255,255,255],[225,252,241,253,255,255,254,255,255,255,255],[234,250,241,250,253,255,253,254,255,255,255]],[[255,254,255,255,255,255,255,255,255,255,255],[223,254,254,255,255,255,255,255,255,255,255],[238,253,254,254,255,255,255,255,255,255,255]],[[255,248,254,255,255,255,255,255,255,255,255],[249,254,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,253,255,255,255,255,255,255,255,255,255],[247,254,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,253,254,255,255,255,255,255,255,255,255],[252,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,254,254,255,255,255,255,255,255,255,255],[253,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,254,253,255,255,255,255,255,255,255,255],[250,255,255,255,255,255,255,255,255,255,255],[254,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]]],[[[186,251,250,255,255,255,255,255,255,255,255],[234,251,244,254,255,255,255,255,255,255,255],[251,251,243,253,254,255,254,255,255,255,255]],[[255,253,254,255,255,255,255,255,255,255,255],[236,253,254,255,255,255,255,255,255,255,255],[251,253,253,254,254,255,255,255,255,255,255]],[[255,254,254,255,255,255,255,255,255,255,255],[254,254,254,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,254,255,255,255,255,255,255,255,255,255],[254,254,255,255,255,255,255,255,255,255,255],[254,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[254,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]]],[[[248,255,255,255,255,255,255,255,255,255,255],[250,254,252,254,255,255,255,255,255,255,255],[248,254,249,253,255,255,255,255,255,255,255]],[[255,253,253,255,255,255,255,255,255,255,255],[246,253,253,255,255,255,255,255,255,255,255],[252,254,251,254,254,255,255,255,255,255,255]],[[255,254,252,255,255,255,255,255,255,255,255],[248,254,253,255,255,255,255,255,255,255,255],[253,255,254,254,255,255,255,255,255,255,255]],[[255,251,254,255,255,255,255,255,255,255,255],[245,251,254,255,255,255,255,255,255,255,255],[253,253,254,255,255,255,255,255,255,255,255]],[[255,251,253,255,255,255,255,255,255,255,255],[252,253,254,255,255,255,255,255,255,255,255],[255,254,255,255,255,255,255,255,255,255,255]],[[255,252,255,255,255,255,255,255,255,255,255],[249,255,254,255,255,255,255,255,255,255,255],[255,255,254,255,255,255,255,255,255,255,255]],[[255,255,253,255,255,255,255,255,255,255,255],[250,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[254,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]]]],B1=[0,1,2,3,6,4,5,6,6,6,6,6,6,6,6,7,0],no=[],Vn=[],Ri=[],S1=1,fg=2,io=[],jn=[];cr("UpsampleRgbLinePair",wt,3),cr("UpsampleBgrLinePair",vs,3),cr("UpsampleRgbaLinePair",hr,4),cr("UpsampleBgraLinePair",eo,4),cr("UpsampleArgbLinePair",Ar,4),cr("UpsampleRgba4444LinePair",wn,2),cr("UpsampleRgb565LinePair",vn,2);var j1=k.UpsampleRgbLinePair,E1=k.UpsampleBgrLinePair,xg=k.UpsampleRgbaLinePair,yg=k.UpsampleBgraLinePair,bg=k.UpsampleArgbLinePair,vg=k.UpsampleRgba4444LinePair,k1=k.UpsampleRgb565LinePair,_A=16,QA=1<<_A-1,Sc=-227,fm=482,I1=6,wg=0,T1=i(256),F1=i(256),P1=i(256),U1=i(256),L1=i(fm-Sc),D1=i(fm-Sc);Cn("YuvToRgbRow",wt,3),Cn("YuvToBgrRow",vs,3),Cn("YuvToRgbaRow",hr,4),Cn("YuvToBgraRow",eo,4),Cn("YuvToArgbRow",Ar,4),Cn("YuvToRgba4444Row",wn,2),Cn("YuvToRgb565Row",vn,2);var Cg=[0,4,8,12,128,132,136,140,256,260,264,268,384,388,392,396],OA=[0,2,8],R1=[8,7,6,4,4,2,2,2,1,1,1,1],M1=1;this.WebPDecodeRGBA=function(p,y,F,_,Z){var se=LA,ae=new ge,oe=new At;ae.ba=oe,oe.S=se,oe.width=[oe.width],oe.height=[oe.height];var Ae=oe.width,ue=oe.height,Ce=new mt;if(Ce==null||p==null)var De=2;else e(Ce!=null),De=is(p,y,F,Ce.width,Ce.height,Ce.Pd,Ce.Qd,Ce.format,null);if(De!=0?Ae=0:(Ae!=null&&(Ae[0]=Ce.width[0]),ue!=null&&(ue[0]=Ce.height[0]),Ae=1),Ae){oe.width=oe.width[0],oe.height=oe.height[0],_!=null&&(_[0]=oe.width),Z!=null&&(Z[0]=oe.height);e:{if(_=new ea,(Z=new je).data=p,Z.w=y,Z.ha=F,Z.kd=1,y=[0],e(Z!=null),((p=is(Z.data,Z.w,Z.ha,null,null,null,y,null,Z))==0||p==7)&&y[0]&&(p=4),(y=p)==0){if(e(ae!=null),_.data=Z.data,_.w=Z.w+Z.offset,_.ha=Z.ha-Z.offset,_.put=vt,_.ac=Es,_.bc=Ft,_.ma=ae,Z.xa){if((p=ur())==null){ae=1;break e}if(function(me,Ee){var Fe=[0],He=[0],Ue=[0];t:for(;;){if(me==null)return 0;if(Ee==null)return me.a=2,0;if(me.l=Ee,me.a=0,ee(me.m,Ee.data,Ee.w,Ee.ha),!Hs(me.m,Fe,He,Ue)){me.a=3;break t}if(me.xb=fg,Ee.width=Fe[0],Ee.height=He[0],!kr(Fe[0],He[0],1,me,null))break t;return 1}return e(me.a!=0),0}(p,_)){if(_=(y=ms(_.width,_.height,ae.Oa,ae.ba))==0){t:{_=p;s:for(;;){if(_==null){_=0;break t}if(e(_.s.yc!=null),e(_.s.Ya!=null),e(0<_.s.Wb),e((F=_.l)!=null),e((Z=F.ma)!=null),_.xb!=0){if(_.ca=Z.ba,_.tb=Z.tb,e(_.ca!=null),!qr(Z.Oa,F,DA)){_.a=2;break s}if(!Zr(_,F.width)||F.da)break s;if((F.da||Ge(_.ca.S))&&xs(),11>_.ca.S||(alert("todo:WebPInitConvertARGBToYUV"),_.ca.f.kb.F!=null&&xs()),_.Pb&&0<_.s.ua&&_.s.vb.X==null&&!re(_.s.vb,_.s.Wa.Xa)){_.a=1;break s}_.xb=0}if(!Ot(_,_.V,_.Ba,_.c,_.i,F.o,Kt))break s;Z.Dc=_.Ma,_=1;break t}e(_.a!=0),_=0}_=!_}_&&(y=p.a)}else y=p.a}else{if((p=new mr)==null){ae=1;break e}if(p.Fa=Z.na,p.P=Z.P,p.qc=Z.Sa,Ur(p,_)){if((y=ms(_.width,_.height,ae.Oa,ae.ba))==0){if(p.Aa=0,F=ae.Oa,e((Z=p)!=null),F!=null){if(0<(Ae=0>(Ae=F.Md)?0:100<Ae?255:255*Ae/100)){for(ue=Ce=0;4>ue;++ue)12>(De=Z.pb[ue]).lc&&(De.ia=Ae*R1[0>De.lc?0:De.lc]>>3),Ce|=De.ia;Ce&&(alert("todo:VP8InitRandom"),Z.ia=1)}Z.Ga=F.Id,100<Z.Ga?Z.Ga=100:0>Z.Ga&&(Z.Ga=0)}(function(me,Ee){if(me==null)return 0;if(Ee==null)return Ts(me,2,"NULL VP8Io parameter in VP8Decode().");if(!me.cb&&!Ur(me,Ee))return 0;if(e(me.cb),Ee.ac==null||Ee.ac(Ee)){Ee.ob&&(me.L=0);var Fe=OA[me.L];if(me.L==2?(me.yb=0,me.zb=0):(me.yb=Ee.v-Fe>>4,me.zb=Ee.j-Fe>>4,0>me.yb&&(me.yb=0),0>me.zb&&(me.zb=0)),me.Va=Ee.o+15+Fe>>4,me.Hb=Ee.va+15+Fe>>4,me.Hb>me.za&&(me.Hb=me.za),me.Va>me.Ub&&(me.Va=me.Ub),0<me.L){var He=me.ed;for(Fe=0;4>Fe;++Fe){var Ue;if(me.Qa.Cb){var Ve=me.Qa.Lb[Fe];me.Qa.Fb||(Ve+=He.Tb)}else Ve=He.Tb;for(Ue=0;1>=Ue;++Ue){var Ke=me.gd[Fe][Ue],tt=Ve;if(He.Pc&&(tt+=He.vd[0],Ue&&(tt+=He.od[0])),0<(tt=0>tt?0:63<tt?63:tt)){var Je=tt;0<He.wb&&(Je=4<He.wb?Je>>2:Je>>1)>9-He.wb&&(Je=9-He.wb),1>Je&&(Je=1),Ke.dd=Je,Ke.tc=2*tt+Je,Ke.ld=40<=tt?2:15<=tt?1:0}else Ke.tc=0;Ke.La=Ue}}}Fe=0}else Ts(me,6,"Frame setup failed"),Fe=me.a;if(Fe=Fe==0){if(Fe){me.$c=0,0<me.Aa||(me.Ic=M1);t:{Fe=me.Ic,He=4*(Je=me.za);var Lt=32*Je,jt=Je+1,ss=0<me.L?Je*(0<me.Aa?2:1):0,Pt=(me.Aa==2?2:1)*Je;if((Ke=He+832+(Ue=3*(16*Fe+OA[me.L])/2*Lt)+(Ve=me.Fa!=null&&0<me.Fa.length?me.Kc.c*me.Kc.i:0))!=Ke)Fe=0;else{if(Ke>me.Vb){if(me.Vb=0,me.Ec=i(Ke),me.Fc=0,me.Ec==null){Fe=Ts(me,1,"no memory during frame initialization.");break t}me.Vb=Ke}Ke=me.Ec,tt=me.Fc,me.Ac=Ke,me.Bc=tt,tt+=He,me.Gd=o(Lt,rn),me.Hd=0,me.rb=o(jt+1,ua),me.sb=1,me.wa=ss?o(ss,os):null,me.Y=0,me.D.Nb=0,me.D.wa=me.wa,me.D.Y=me.Y,0<me.Aa&&(me.D.Y+=Je),e(!0),me.oc=Ke,me.pc=tt,tt+=832,me.ya=o(Pt,Va),me.aa=0,me.D.ya=me.ya,me.D.aa=me.aa,me.Aa==2&&(me.D.aa+=Je),me.R=16*Je,me.B=8*Je,Je=(Lt=OA[me.L])*me.R,Lt=Lt/2*me.B,me.sa=Ke,me.ta=tt+Je,me.qa=me.sa,me.ra=me.ta+16*Fe*me.R+Lt,me.Ha=me.qa,me.Ia=me.ra+8*Fe*me.B+Lt,me.$c=0,tt+=Ue,me.mb=Ve?Ke:null,me.nb=Ve?tt:null,e(tt+Ve<=me.Fc+me.Vb),er(me),n(me.Ac,me.Bc,0,He),Fe=1}}if(Fe){if(Ee.ka=0,Ee.y=me.sa,Ee.O=me.ta,Ee.f=me.qa,Ee.N=me.ra,Ee.ea=me.Ha,Ee.Vd=me.Ia,Ee.fa=me.R,Ee.Rc=me.B,Ee.F=null,Ee.J=0,!ug){for(Fe=-255;255>=Fe;++Fe)lg[255+Fe]=0>Fe?-Fe:Fe;for(Fe=-1020;1020>=Fe;++Fe)cg[1020+Fe]=-128>Fe?-128:127<Fe?127:Fe;for(Fe=-112;112>=Fe;++Fe)Ag[112+Fe]=-16>Fe?-16:15<Fe?15:Fe;for(Fe=-255;510>=Fe;++Fe)dg[255+Fe]=0>Fe?0:255<Fe?255:Fe;ug=1}ao=sr,Mo=Sa,mi=ta,Ss=ja,$s=ma,Bn=Fi,vr=Zi,Mr=Ui,Di=B,Cc=z,xl=U,FA=g,Zp=J,eg=ne,tg=lt,sg=us,rg=Wr,ag=ci,Vn[0]=Bs,Vn[1]=nn,Vn[2]=ze,Vn[3]=Gt,Vn[4]=ls,Vn[5]=Vs,Vn[6]=Qs,Vn[7]=ha,Vn[8]=Dr,Vn[9]=sa,no[0]=St,no[1]=Ea,no[2]=ie,no[3]=Qe,no[4]=zt,no[5]=ot,no[6]=yr,Ri[0]=gl,Ri[1]=on,Ri[2]=ra,Ri[3]=pa,Ri[4]=Yi,Ri[5]=Pi,Ri[6]=Ka,Fe=1}else Fe=0}Fe&&(Fe=function(hs,_r){for(hs.M=0;hs.M<hs.Va;++hs.M){var rs,Ut=hs.Jc[hs.M&hs.Xb],ht=hs.m,wr=hs;for(rs=0;rs<wr.za;++rs){var Xt=ht,ys=wr,Ys=ys.Ac,na=ys.Bc+4*rs,Ta=ys.zc,pr=ys.ya[ys.aa+rs];if(ys.Qa.Bb?pr.$b=ve(Xt,ys.Pa.jb[0])?2+ve(Xt,ys.Pa.jb[2]):ve(Xt,ys.Pa.jb[1]):pr.$b=0,ys.kc&&(pr.Ad=ve(Xt,ys.Bd)),pr.Za=!ve(Xt,145)+0,pr.Za){var fa=pr.Ob,Fa=0;for(ys=0;4>ys;++ys){var Qr,ws=Ta[0+ys];for(Qr=0;4>Qr;++Qr){ws=C1[Ys[na+Qr]][ws];for(var Us=gg[ve(Xt,ws[0])];0<Us;)Us=gg[2*Us+ve(Xt,ws[Us])];ws=-Us,Ys[na+Qr]=ws}a(fa,Fa,Ys,na,4),Fa+=4,Ta[0+ys]=ws}}else ws=ve(Xt,156)?ve(Xt,128)?1:3:ve(Xt,163)?2:0,pr.Ob[0]=ws,n(Ys,na,ws,4),n(Ta,0,ws,4);pr.Dd=ve(Xt,142)?ve(Xt,114)?ve(Xt,183)?1:3:2:0}if(wr.m.Ka)return Ts(hs,7,"Premature end-of-partition0 encountered.");for(;hs.ja<hs.za;++hs.ja){if(wr=Ut,Xt=(ht=hs).rb[ht.sb-1],Ys=ht.rb[ht.sb+ht.ja],rs=ht.ya[ht.aa+ht.ja],na=ht.kc?rs.Ad:0)Xt.la=Ys.la=0,rs.Za||(Xt.Na=Ys.Na=0),rs.Hc=0,rs.Gc=0,rs.ia=0;else{var gr,Ls;if(Xt=Ys,Ys=wr,na=ht.Pa.Xc,Ta=ht.ya[ht.aa+ht.ja],pr=ht.pb[Ta.$b],ys=Ta.ad,fa=0,Fa=ht.rb[ht.sb-1],ws=Qr=0,n(ys,fa,0,384),Ta.Za)var ia=0,$n=na[3];else{Us=i(16);var Cr=Xt.Na+Fa.Na;if(Cr=Bc(Ys,na[1],Cr,pr.Eb,0,Us,0),Xt.Na=Fa.Na=(0<Cr)+0,1<Cr)ao(Us,0,ys,fa);else{var Wa=Us[0]+3>>3;for(Us=0;256>Us;Us+=16)ys[fa+Us]=Wa}ia=1,$n=na[0]}var Ks=15&Xt.la,Or=15&Fa.la;for(Us=0;4>Us;++Us){var cn=1&Or;for(Wa=Ls=0;4>Wa;++Wa)Ks=Ks>>1|(cn=(Cr=Bc(Ys,$n,Cr=cn+(1&Ks),pr.Sc,ia,ys,fa))>ia)<<7,Ls=Ls<<2|(3<Cr?3:1<Cr?2:ys[fa+0]!=0),fa+=16;Ks>>=4,Or=Or>>1|cn<<7,Qr=(Qr<<8|Ls)>>>0}for($n=Ks,ia=Or>>4,gr=0;4>gr;gr+=2){for(Ls=0,Ks=Xt.la>>4+gr,Or=Fa.la>>4+gr,Us=0;2>Us;++Us){for(cn=1&Or,Wa=0;2>Wa;++Wa)Cr=cn+(1&Ks),Ks=Ks>>1|(cn=0<(Cr=Bc(Ys,na[2],Cr,pr.Qc,0,ys,fa)))<<3,Ls=Ls<<2|(3<Cr?3:1<Cr?2:ys[fa+0]!=0),fa+=16;Ks>>=2,Or=Or>>1|cn<<5}ws|=Ls<<4*gr,$n|=Ks<<4<<gr,ia|=(240&Or)<<gr}Xt.la=$n,Fa.la=ia,Ta.Hc=Qr,Ta.Gc=ws,Ta.ia=43690&ws?0:pr.ia,na=!(Qr|ws)}if(0<ht.L&&(ht.wa[ht.Y+ht.ja]=ht.gd[rs.$b][rs.Za],ht.wa[ht.Y+ht.ja].La|=!na),wr.Ka)return Ts(hs,7,"Premature end-of-file encountered.")}if(er(hs),ht=_r,wr=1,rs=(Ut=hs).D,Xt=0<Ut.L&&Ut.M>=Ut.zb&&Ut.M<=Ut.Va,Ut.Aa==0)t:{if(rs.M=Ut.M,rs.uc=Xt,Mt(Ut,rs),wr=1,rs=(Ls=Ut.D).Nb,Xt=(ws=OA[Ut.L])*Ut.R,Ys=ws/2*Ut.B,Us=16*rs*Ut.R,Wa=8*rs*Ut.B,na=Ut.sa,Ta=Ut.ta-Xt+Us,pr=Ut.qa,ys=Ut.ra-Ys+Wa,fa=Ut.Ha,Fa=Ut.Ia-Ys+Wa,Or=(Ks=Ls.M)==0,Qr=Ks>=Ut.Va-1,Ut.Aa==2&&Mt(Ut,Ls),Ls.uc)for(cn=(Cr=Ut).D.M,e(Cr.D.uc),Ls=Cr.yb;Ls<Cr.Hb;++Ls){ia=Ls,$n=cn;var Pa=(An=(oa=Cr).D).Nb;gr=oa.R;var An=An.wa[An.Y+ia],dn=oa.sa,qa=oa.ta+16*Pa*gr+16*ia,un=An.dd,Ws=An.tc;if(Ws!=0)if(e(3<=Ws),oa.L==1)0<ia&&sg(dn,qa,gr,Ws+4),An.La&&ag(dn,qa,gr,Ws),0<$n&&tg(dn,qa,gr,Ws+4),An.La&&rg(dn,qa,gr,Ws);else{var mn=oa.B,Kn=oa.qa,_o=oa.ra+8*Pa*mn+8*ia,Mi=oa.Ha,oa=oa.Ia+8*Pa*mn+8*ia;Pa=An.ld,0<ia&&(Mr(dn,qa,gr,Ws+4,un,Pa),Cc(Kn,_o,Mi,oa,mn,Ws+4,un,Pa)),An.La&&(FA(dn,qa,gr,Ws,un,Pa),eg(Kn,_o,Mi,oa,mn,Ws,un,Pa)),0<$n&&(vr(dn,qa,gr,Ws+4,un,Pa),Di(Kn,_o,Mi,oa,mn,Ws+4,un,Pa)),An.La&&(xl(dn,qa,gr,Ws,un,Pa),Zp(Kn,_o,Mi,oa,mn,Ws,un,Pa))}}if(Ut.ia&&alert("todo:DitherRow"),ht.put!=null){if(Ls=16*Ks,Ks=16*(Ks+1),Or?(ht.y=Ut.sa,ht.O=Ut.ta+Us,ht.f=Ut.qa,ht.N=Ut.ra+Wa,ht.ea=Ut.Ha,ht.W=Ut.Ia+Wa):(Ls-=ws,ht.y=na,ht.O=Ta,ht.f=pr,ht.N=ys,ht.ea=fa,ht.W=Fa),Qr||(Ks-=ws),Ks>ht.o&&(Ks=ht.o),ht.F=null,ht.J=null,Ut.Fa!=null&&0<Ut.Fa.length&&Ls<Ks&&(ht.J=ft(Ut,ht,Ls,Ks-Ls),ht.F=Ut.mb,ht.F==null&&ht.F.length==0)){wr=Ts(Ut,3,"Could not decode alpha data.");break t}Ls<ht.j&&(ws=ht.j-Ls,Ls=ht.j,e(!(1&ws)),ht.O+=Ut.R*ws,ht.N+=Ut.B*(ws>>1),ht.W+=Ut.B*(ws>>1),ht.F!=null&&(ht.J+=ht.width*ws)),Ls<Ks&&(ht.O+=ht.v,ht.N+=ht.v>>1,ht.W+=ht.v>>1,ht.F!=null&&(ht.J+=ht.v),ht.ka=Ls-ht.j,ht.U=ht.va-ht.v,ht.T=Ks-Ls,wr=ht.put(ht))}rs+1!=Ut.Ic||Qr||(a(Ut.sa,Ut.ta-Xt,na,Ta+16*Ut.R,Xt),a(Ut.qa,Ut.ra-Ys,pr,ys+8*Ut.B,Ys),a(Ut.Ha,Ut.Ia-Ys,fa,Fa+8*Ut.B,Ys))}if(!wr)return Ts(hs,6,"Output aborted.")}return 1}(me,Ee)),Ee.bc!=null&&Ee.bc(Ee),Fe&=1}return Fe?(me.cb=0,Fe):0})(p,_)||(y=p.a)}}else y=p.a}y==0&&ae.Oa!=null&&ae.Oa.fd&&(y=Ir(ae.ba))}ae=y}se=ae!=0?null:11>se?oe.f.RGBA.eb:oe.f.kb.y}else se=null;return se};var Ng=[3,4,3,4,4,2,2,4,4,4,2,1,1]};function A(k,R){for(var w="",L=0;L<4;L++)w+=String.fromCharCode(k[R++]);return w}function d(k,R){return k[R+0]|k[R+1]<<8}function h(k,R){return(k[R+0]|k[R+1]<<8|k[R+2]<<16)>>>0}function f(k,R){return(k[R+0]|k[R+1]<<8|k[R+2]<<16|k[R+3]<<24)>>>0}new c;var u=[0],x=[0],b=[],N=new c,v=s,j=function(k,R){var w={},L=0,M=!1,P=0,K=0;if(w.frames=[],!function(S,H){for(var Y=0;Y<4;Y++)if(S[H+Y]!="RIFF".charCodeAt(Y))return!0;return!1}(k,R)){for(f(k,R+=4),R+=8;R<k.length;){var $=A(k,R),O=f(k,R+=4);R+=4;var W=O+(1&O);switch($){case"VP8 ":case"VP8L":w.frames[L]===void 0&&(w.frames[L]={}),(q=w.frames[L]).src_off=M?K:R-8,q.src_size=P+O+8,L++,M&&(M=!1,P=0,K=0);break;case"VP8X":(q=w.header={}).feature_flags=k[R];var ee=R+4;q.canvas_width=1+h(k,ee),ee+=3,q.canvas_height=1+h(k,ee),ee+=3;break;case"ALPH":M=!0,P=W+8,K=R-8;break;case"ANIM":(q=w.header).bgcolor=f(k,R),ee=R+4,q.loop_count=d(k,ee),ee+=2;break;case"ANMF":var V,q;(q=w.frames[L]={}).offset_x=2*h(k,R),R+=3,q.offset_y=2*h(k,R),R+=3,q.width=1+h(k,R),R+=3,q.height=1+h(k,R),R+=3,q.duration=h(k,R),R+=3,V=k[R++],q.dispose=1&V,q.blend=V>>1&1}$!="ANMF"&&(R+=W)}return w}}(v,0);j.response=v,j.rgbaoutput=!0,j.dataurl=!1;var I=j.header?j.header:null,C=j.frames?j.frames:null;if(I){I.loop_counter=I.loop_count,u=[I.canvas_height],x=[I.canvas_width];for(var E=0;E<C.length&&C[E].blend!=0;E++);}var T=C[0],Q=N.WebPDecodeRGBA(v,T.src_off,T.src_size,x,u);T.rgba=Q,T.imgwidth=x[0],T.imgheight=u[0];for(var D=0;D<x[0]*u[0]*4;D++)b[D]=Q[D];return this.width=x,this.height=u,this.data=b,this}(function(s){var e,r,a,n,i,o,l,c,A,d=function(S){return S=S||{},this.isStrokeTransparent=S.isStrokeTransparent||!1,this.strokeOpacity=S.strokeOpacity||1,this.strokeStyle=S.strokeStyle||"#000000",this.fillStyle=S.fillStyle||"#000000",this.isFillTransparent=S.isFillTransparent||!1,this.fillOpacity=S.fillOpacity||1,this.font=S.font||"10px sans-serif",this.textBaseline=S.textBaseline||"alphabetic",this.textAlign=S.textAlign||"left",this.lineWidth=S.lineWidth||1,this.lineJoin=S.lineJoin||"miter",this.lineCap=S.lineCap||"butt",this.path=S.path||[],this.transform=S.transform!==void 0?S.transform.clone():new c,this.globalCompositeOperation=S.globalCompositeOperation||"normal",this.globalAlpha=S.globalAlpha||1,this.clip_path=S.clip_path||[],this.currentPoint=S.currentPoint||new o,this.miterLimit=S.miterLimit||10,this.lastPoint=S.lastPoint||new o,this.lineDashOffset=S.lineDashOffset||0,this.lineDash=S.lineDash||[],this.margin=S.margin||[0,0,0,0],this.prevPageLastElemOffset=S.prevPageLastElemOffset||0,this.ignoreClearRect=typeof S.ignoreClearRect!="boolean"||S.ignoreClearRect,this};s.events.push(["initialized",function(){this.context2d=new h(this),e=this.internal.f2,r=this.internal.getCoordinateString,a=this.internal.getVerticalCoordinateString,n=this.internal.getHorizontalCoordinate,i=this.internal.getVerticalCoordinate,o=this.internal.Point,l=this.internal.Rectangle,c=this.internal.Matrix,A=new d}]);var h=function(S){Object.defineProperty(this,"canvas",{get:function(){return{parentNode:!1,style:!1}}});var H=S;Object.defineProperty(this,"pdf",{get:function(){return H}});var Y=!1;Object.defineProperty(this,"pageWrapXEnabled",{get:function(){return Y},set:function(re){Y=!!re}});var te=!1;Object.defineProperty(this,"pageWrapYEnabled",{get:function(){return te},set:function(re){te=!!re}});var G=0;Object.defineProperty(this,"posX",{get:function(){return G},set:function(re){isNaN(re)||(G=re)}});var X=0;Object.defineProperty(this,"posY",{get:function(){return X},set:function(re){isNaN(re)||(X=re)}}),Object.defineProperty(this,"margin",{get:function(){return A.margin},set:function(re){var Me;typeof re=="number"?Me=[re,re,re,re]:((Me=new Array(4))[0]=re[0],Me[1]=re.length>=2?re[1]:Me[0],Me[2]=re.length>=3?re[2]:Me[0],Me[3]=re.length>=4?re[3]:Me[1]),A.margin=Me}});var le=!1;Object.defineProperty(this,"autoPaging",{get:function(){return le},set:function(re){le=re}});var he=0;Object.defineProperty(this,"lastBreak",{get:function(){return he},set:function(re){he=re}});var ve=[];Object.defineProperty(this,"pageBreaks",{get:function(){return ve},set:function(re){ve=re}}),Object.defineProperty(this,"ctx",{get:function(){return A},set:function(re){re instanceof d&&(A=re)}}),Object.defineProperty(this,"path",{get:function(){return A.path},set:function(re){A.path=re}});var ke=[];Object.defineProperty(this,"ctxStack",{get:function(){return ke},set:function(re){ke=re}}),Object.defineProperty(this,"fillStyle",{get:function(){return this.ctx.fillStyle},set:function(re){var Me;Me=f(re),this.ctx.fillStyle=Me.style,this.ctx.isFillTransparent=Me.a===0,this.ctx.fillOpacity=Me.a,this.pdf.setFillColor(Me.r,Me.g,Me.b,{a:Me.a}),this.pdf.setTextColor(Me.r,Me.g,Me.b,{a:Me.a})}}),Object.defineProperty(this,"strokeStyle",{get:function(){return this.ctx.strokeStyle},set:function(re){var Me=f(re);this.ctx.strokeStyle=Me.style,this.ctx.isStrokeTransparent=Me.a===0,this.ctx.strokeOpacity=Me.a,Me.a===0?this.pdf.setDrawColor(255,255,255):(Me.a,this.pdf.setDrawColor(Me.r,Me.g,Me.b))}}),Object.defineProperty(this,"lineCap",{get:function(){return this.ctx.lineCap},set:function(re){["butt","round","square"].indexOf(re)!==-1&&(this.ctx.lineCap=re,this.pdf.setLineCap(re))}}),Object.defineProperty(this,"lineWidth",{get:function(){return this.ctx.lineWidth},set:function(re){isNaN(re)||(this.ctx.lineWidth=re,this.pdf.setLineWidth(re))}}),Object.defineProperty(this,"lineJoin",{get:function(){return this.ctx.lineJoin},set:function(re){["bevel","round","miter"].indexOf(re)!==-1&&(this.ctx.lineJoin=re,this.pdf.setLineJoin(re))}}),Object.defineProperty(this,"miterLimit",{get:function(){return this.ctx.miterLimit},set:function(re){isNaN(re)||(this.ctx.miterLimit=re,this.pdf.setMiterLimit(re))}}),Object.defineProperty(this,"textBaseline",{get:function(){return this.ctx.textBaseline},set:function(re){this.ctx.textBaseline=re}}),Object.defineProperty(this,"textAlign",{get:function(){return this.ctx.textAlign},set:function(re){["right","end","center","left","start"].indexOf(re)!==-1&&(this.ctx.textAlign=re)}});var Le=null,Be=null,Re=null;Object.defineProperty(this,"fontFaces",{get:function(){return Re},set:function(re){Le=null,Be=null,Re=re}}),Object.defineProperty(this,"font",{get:function(){return this.ctx.font},set:function(re){var Me;if(this.ctx.font=re,(Me=/^\s*(?=(?:(?:[-a-z]+\s*){0,2}(italic|oblique))?)(?=(?:(?:[-a-z]+\s*){0,2}(small-caps))?)(?=(?:(?:[-a-z]+\s*){0,2}(bold(?:er)?|lighter|[1-9]00))?)(?:(?:normal|\1|\2|\3)\s*){0,3}((?:xx?-)?(?:small|large)|medium|smaller|larger|[.\d]+(?:\%|in|[cem]m|ex|p[ctx]))(?:\s*\/\s*(normal|[.\d]+(?:\%|in|[cem]m|ex|p[ctx])))?\s*([-_,\"\'\sa-z0-9]+?)\s*$/i.exec(re))!==null){var Pe=Me[1];Me[2];var be=Me[3],ce=Me[4];Me[5];var Ie=Me[6],pe=/^([.\d]+)((?:%|in|[cem]m|ex|p[ctx]))$/i.exec(ce)[2];ce=Math.floor(pe==="px"?parseFloat(ce)*this.pdf.internal.scaleFactor:pe==="em"?parseFloat(ce)*this.pdf.getFontSize():parseFloat(ce)*this.pdf.internal.scaleFactor),this.pdf.setFontSize(ce);var fe=function(Ze){var ct,pt,dt=[],xt=Ze.trim();if(xt==="")return Nh;if(xt in ey)return[ey[xt]];for(;xt!=="";){switch(pt=null,ct=(xt=sy(xt)).charAt(0)){case'"':case"'":pt=_U(xt.substring(1),ct);break;default:pt=QU(xt)}if(pt===null||(dt.push(pt[0]),(xt=sy(pt[1]))!==""&&xt.charAt(0)!==","))return Nh;xt=xt.replace(/^,/,"")}return dt}(Ie);if(this.fontFaces){var we=function(Ze,ct){var pt=Ze.getFontList(),dt=JSON.stringify(pt);if(Le===null||Be!==dt){var xt=function(Se){var qe=[];return Object.keys(Se).forEach(function(ut){Se[ut].forEach(function(Ge){var rt=null;switch(Ge){case"bold":rt={family:ut,weight:"bold"};break;case"italic":rt={family:ut,style:"italic"};break;case"bolditalic":rt={family:ut,weight:"bold",style:"italic"};break;case"":case"normal":rt={family:ut}}rt!==null&&(rt.ref={name:ut,style:Ge},qe.push(rt))})}),qe}(pt);Le=function(Se){for(var qe={},ut=0;ut<Se.length;++ut){var Ge=Ch(Se[ut]),rt=Ge.family,Tt=Ge.stretch,At=Ge.style,mt=Ge.weight;qe[rt]=qe[rt]||{},qe[rt][Tt]=qe[rt][Tt]||{},qe[rt][Tt][At]=qe[rt][Tt][At]||{},qe[rt][Tt][At][mt]=Ge}return qe}(xt.concat(ct)),Be=dt}return Le}(this.pdf,this.fontFaces),de=fe.map(function(Ze){return{family:Ze,stretch:"normal",weight:be,style:Pe}}),xe=function(Ze,ct,pt){for(var dt=(pt=pt||{}).defaultFontFamily||"times",xt=Object.assign({},MU,pt.genericFontFamilies||{}),Se=null,qe=null,ut=0;ut<ct.length;++ut)if(xt[(Se=Ch(ct[ut])).family]&&(Se.family=xt[Se.family]),Ze.hasOwnProperty(Se.family)){qe=Ze[Se.family];break}if(!(qe=qe||Ze[dt]))throw new Error("Could not find a font-family for the rule '"+ty(Se)+"' and default family '"+dt+"'.");if(qe=function(Ge,rt){if(rt[Ge])return rt[Ge];var Tt=yp[Ge],At=Tt<=yp.normal?-1:1,mt=Zx(rt,i1,Tt,At);if(!mt)throw new Error("Could not find a matching font-stretch value for "+Ge);return mt}(Se.stretch,qe),qe=function(Ge,rt){if(rt[Ge])return rt[Ge];for(var Tt=n1[Ge],At=0;At<Tt.length;++At)if(rt[Tt[At]])return rt[Tt[At]];throw new Error("Could not find a matching font-style for "+Ge)}(Se.style,qe),!(qe=function(Ge,rt){if(rt[Ge])return rt[Ge];if(Ge===400&&rt[500])return rt[500];if(Ge===500&&rt[400])return rt[400];var Tt=RU[Ge],At=Zx(rt,o1,Tt,Ge<400?-1:1);if(!At)throw new Error("Could not find a matching font-weight for value "+Ge);return At}(Se.weight,qe)))throw new Error("Failed to resolve a font for the rule '"+ty(Se)+"'.");return qe}(we,de);this.pdf.setFont(xe.ref.name,xe.ref.style)}else{var Ne="";(be==="bold"||parseInt(be,10)>=700||Pe==="bold")&&(Ne="bold"),Pe==="italic"&&(Ne+="italic"),Ne.length===0&&(Ne="normal");for(var it="",st={arial:"Helvetica",Arial:"Helvetica",verdana:"Helvetica",Verdana:"Helvetica",helvetica:"Helvetica",Helvetica:"Helvetica","sans-serif":"Helvetica",fixed:"Courier",monospace:"Courier",terminal:"Courier",cursive:"Times",fantasy:"Times",serif:"Times"},$e=0;$e<fe.length;$e++){if(this.pdf.internal.getFont(fe[$e],Ne,{noFallback:!0,disableWarning:!0})!==void 0){it=fe[$e];break}if(Ne==="bolditalic"&&this.pdf.internal.getFont(fe[$e],"bold",{noFallback:!0,disableWarning:!0})!==void 0)it=fe[$e],Ne="bold";else if(this.pdf.internal.getFont(fe[$e],"normal",{noFallback:!0,disableWarning:!0})!==void 0){it=fe[$e],Ne="normal";break}}if(it===""){for(var Xe=0;Xe<fe.length;Xe++)if(st[fe[Xe]]){it=st[fe[Xe]];break}}it=it===""?"Times":it,this.pdf.setFont(it,Ne)}}}}),Object.defineProperty(this,"globalCompositeOperation",{get:function(){return this.ctx.globalCompositeOperation},set:function(re){this.ctx.globalCompositeOperation=re}}),Object.defineProperty(this,"globalAlpha",{get:function(){return this.ctx.globalAlpha},set:function(re){this.ctx.globalAlpha=re}}),Object.defineProperty(this,"lineDashOffset",{get:function(){return this.ctx.lineDashOffset},set:function(re){this.ctx.lineDashOffset=re,q.call(this)}}),Object.defineProperty(this,"lineDash",{get:function(){return this.ctx.lineDash},set:function(re){this.ctx.lineDash=re,q.call(this)}}),Object.defineProperty(this,"ignoreClearRect",{get:function(){return this.ctx.ignoreClearRect},set:function(re){this.ctx.ignoreClearRect=!!re}})};h.prototype.setLineDash=function(S){this.lineDash=S},h.prototype.getLineDash=function(){return this.lineDash.length%2?this.lineDash.concat(this.lineDash):this.lineDash.slice()},h.prototype.fill=function(){C.call(this,"fill",!1)},h.prototype.stroke=function(){C.call(this,"stroke",!1)},h.prototype.beginPath=function(){this.path=[{type:"begin"}]},h.prototype.moveTo=function(S,H){if(isNaN(S)||isNaN(H))throw Gs.error("jsPDF.context2d.moveTo: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.moveTo");var Y=this.ctx.transform.applyToPoint(new o(S,H));this.path.push({type:"mt",x:Y.x,y:Y.y}),this.ctx.lastPoint=new o(S,H)},h.prototype.closePath=function(){var S=new o(0,0),H=0;for(H=this.path.length-1;H!==-1;H--)if(this.path[H].type==="begin"&&Rs(this.path[H+1])==="object"&&typeof this.path[H+1].x=="number"){S=new o(this.path[H+1].x,this.path[H+1].y);break}this.path.push({type:"close"}),this.ctx.lastPoint=new o(S.x,S.y)},h.prototype.lineTo=function(S,H){if(isNaN(S)||isNaN(H))throw Gs.error("jsPDF.context2d.lineTo: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.lineTo");var Y=this.ctx.transform.applyToPoint(new o(S,H));this.path.push({type:"lt",x:Y.x,y:Y.y}),this.ctx.lastPoint=new o(Y.x,Y.y)},h.prototype.clip=function(){this.ctx.clip_path=JSON.parse(JSON.stringify(this.path)),C.call(this,null,!0)},h.prototype.quadraticCurveTo=function(S,H,Y,te){if(isNaN(Y)||isNaN(te)||isNaN(S)||isNaN(H))throw Gs.error("jsPDF.context2d.quadraticCurveTo: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.quadraticCurveTo");var G=this.ctx.transform.applyToPoint(new o(Y,te)),X=this.ctx.transform.applyToPoint(new o(S,H));this.path.push({type:"qct",x1:X.x,y1:X.y,x:G.x,y:G.y}),this.ctx.lastPoint=new o(G.x,G.y)},h.prototype.bezierCurveTo=function(S,H,Y,te,G,X){if(isNaN(G)||isNaN(X)||isNaN(S)||isNaN(H)||isNaN(Y)||isNaN(te))throw Gs.error("jsPDF.context2d.bezierCurveTo: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.bezierCurveTo");var le=this.ctx.transform.applyToPoint(new o(G,X)),he=this.ctx.transform.applyToPoint(new o(S,H)),ve=this.ctx.transform.applyToPoint(new o(Y,te));this.path.push({type:"bct",x1:he.x,y1:he.y,x2:ve.x,y2:ve.y,x:le.x,y:le.y}),this.ctx.lastPoint=new o(le.x,le.y)},h.prototype.arc=function(S,H,Y,te,G,X){if(isNaN(S)||isNaN(H)||isNaN(Y)||isNaN(te)||isNaN(G))throw Gs.error("jsPDF.context2d.arc: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.arc");if(X=!!X,!this.ctx.transform.isIdentity){var le=this.ctx.transform.applyToPoint(new o(S,H));S=le.x,H=le.y;var he=this.ctx.transform.applyToPoint(new o(0,Y)),ve=this.ctx.transform.applyToPoint(new o(0,0));Y=Math.sqrt(Math.pow(he.x-ve.x,2)+Math.pow(he.y-ve.y,2))}Math.abs(G-te)>=2*Math.PI&&(te=0,G=2*Math.PI),this.path.push({type:"arc",x:S,y:H,radius:Y,startAngle:te,endAngle:G,counterclockwise:X})},h.prototype.arcTo=function(S,H,Y,te,G){throw new Error("arcTo not implemented.")},h.prototype.rect=function(S,H,Y,te){if(isNaN(S)||isNaN(H)||isNaN(Y)||isNaN(te))throw Gs.error("jsPDF.context2d.rect: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.rect");this.moveTo(S,H),this.lineTo(S+Y,H),this.lineTo(S+Y,H+te),this.lineTo(S,H+te),this.lineTo(S,H),this.lineTo(S+Y,H),this.lineTo(S,H)},h.prototype.fillRect=function(S,H,Y,te){if(isNaN(S)||isNaN(H)||isNaN(Y)||isNaN(te))throw Gs.error("jsPDF.context2d.fillRect: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.fillRect");if(!u.call(this)){var G={};this.lineCap!=="butt"&&(G.lineCap=this.lineCap,this.lineCap="butt"),this.lineJoin!=="miter"&&(G.lineJoin=this.lineJoin,this.lineJoin="miter"),this.beginPath(),this.rect(S,H,Y,te),this.fill(),G.hasOwnProperty("lineCap")&&(this.lineCap=G.lineCap),G.hasOwnProperty("lineJoin")&&(this.lineJoin=G.lineJoin)}},h.prototype.strokeRect=function(S,H,Y,te){if(isNaN(S)||isNaN(H)||isNaN(Y)||isNaN(te))throw Gs.error("jsPDF.context2d.strokeRect: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.strokeRect");x.call(this)||(this.beginPath(),this.rect(S,H,Y,te),this.stroke())},h.prototype.clearRect=function(S,H,Y,te){if(isNaN(S)||isNaN(H)||isNaN(Y)||isNaN(te))throw Gs.error("jsPDF.context2d.clearRect: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.clearRect");this.ignoreClearRect||(this.fillStyle="#ffffff",this.fillRect(S,H,Y,te))},h.prototype.save=function(S){S=typeof S!="boolean"||S;for(var H=this.pdf.internal.getCurrentPageInfo().pageNumber,Y=0;Y<this.pdf.internal.getNumberOfPages();Y++)this.pdf.setPage(Y+1),this.pdf.internal.out("q");if(this.pdf.setPage(H),S){this.ctx.fontSize=this.pdf.internal.getFontSize();var te=new d(this.ctx);this.ctxStack.push(this.ctx),this.ctx=te}},h.prototype.restore=function(S){S=typeof S!="boolean"||S;for(var H=this.pdf.internal.getCurrentPageInfo().pageNumber,Y=0;Y<this.pdf.internal.getNumberOfPages();Y++)this.pdf.setPage(Y+1),this.pdf.internal.out("Q");this.pdf.setPage(H),S&&this.ctxStack.length!==0&&(this.ctx=this.ctxStack.pop(),this.fillStyle=this.ctx.fillStyle,this.strokeStyle=this.ctx.strokeStyle,this.font=this.ctx.font,this.lineCap=this.ctx.lineCap,this.lineWidth=this.ctx.lineWidth,this.lineJoin=this.ctx.lineJoin,this.lineDash=this.ctx.lineDash,this.lineDashOffset=this.ctx.lineDashOffset)},h.prototype.toDataURL=function(){throw new Error("toDataUrl not implemented.")};var f=function(S){var H,Y,te,G;if(S.isCanvasGradient===!0&&(S=S.getColor()),!S)return{r:0,g:0,b:0,a:0,style:S};if(/transparent|rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*0+\s*\)/.test(S))H=0,Y=0,te=0,G=0;else{var X=/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/.exec(S);if(X!==null)H=parseInt(X[1]),Y=parseInt(X[2]),te=parseInt(X[3]),G=1;else if((X=/rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*([\d.]+)\s*\)/.exec(S))!==null)H=parseInt(X[1]),Y=parseInt(X[2]),te=parseInt(X[3]),G=parseFloat(X[4]);else{if(G=1,typeof S=="string"&&S.charAt(0)!=="#"){var le=new Xw(S);S=le.ok?le.toHex():"#000000"}S.length===4?(H=S.substring(1,2),H+=H,Y=S.substring(2,3),Y+=Y,te=S.substring(3,4),te+=te):(H=S.substring(1,3),Y=S.substring(3,5),te=S.substring(5,7)),H=parseInt(H,16),Y=parseInt(Y,16),te=parseInt(te,16)}}return{r:H,g:Y,b:te,a:G,style:S}},u=function(){return this.ctx.isFillTransparent||this.globalAlpha==0},x=function(){return!!(this.ctx.isStrokeTransparent||this.globalAlpha==0)};h.prototype.fillText=function(S,H,Y,te){if(isNaN(H)||isNaN(Y)||typeof S!="string")throw Gs.error("jsPDF.context2d.fillText: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.fillText");if(te=isNaN(te)?void 0:te,!u.call(this)){var G=W(this.ctx.transform.rotation),X=this.ctx.transform.scaleX;L.call(this,{text:S,x:H,y:Y,scale:X,angle:G,align:this.textAlign,maxWidth:te})}},h.prototype.strokeText=function(S,H,Y,te){if(isNaN(H)||isNaN(Y)||typeof S!="string")throw Gs.error("jsPDF.context2d.strokeText: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.strokeText");if(!x.call(this)){te=isNaN(te)?void 0:te;var G=W(this.ctx.transform.rotation),X=this.ctx.transform.scaleX;L.call(this,{text:S,x:H,y:Y,scale:X,renderingMode:"stroke",angle:G,align:this.textAlign,maxWidth:te})}},h.prototype.measureText=function(S){if(typeof S!="string")throw Gs.error("jsPDF.context2d.measureText: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.measureText");var H=this.pdf,Y=this.pdf.internal.scaleFactor,te=H.internal.getFontSize(),G=H.getStringUnitWidth(S)*te/H.internal.scaleFactor;return new function(X){var le=(X=X||{}).width||0;return Object.defineProperty(this,"width",{get:function(){return le}}),this}({width:G*=Math.round(96*Y/72*1e4)/1e4})},h.prototype.scale=function(S,H){if(isNaN(S)||isNaN(H))throw Gs.error("jsPDF.context2d.scale: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.scale");var Y=new c(S,0,0,H,0,0);this.ctx.transform=this.ctx.transform.multiply(Y)},h.prototype.rotate=function(S){if(isNaN(S))throw Gs.error("jsPDF.context2d.rotate: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.rotate");var H=new c(Math.cos(S),Math.sin(S),-Math.sin(S),Math.cos(S),0,0);this.ctx.transform=this.ctx.transform.multiply(H)},h.prototype.translate=function(S,H){if(isNaN(S)||isNaN(H))throw Gs.error("jsPDF.context2d.translate: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.translate");var Y=new c(1,0,0,1,S,H);this.ctx.transform=this.ctx.transform.multiply(Y)},h.prototype.transform=function(S,H,Y,te,G,X){if(isNaN(S)||isNaN(H)||isNaN(Y)||isNaN(te)||isNaN(G)||isNaN(X))throw Gs.error("jsPDF.context2d.transform: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.transform");var le=new c(S,H,Y,te,G,X);this.ctx.transform=this.ctx.transform.multiply(le)},h.prototype.setTransform=function(S,H,Y,te,G,X){S=isNaN(S)?1:S,H=isNaN(H)?0:H,Y=isNaN(Y)?0:Y,te=isNaN(te)?1:te,G=isNaN(G)?0:G,X=isNaN(X)?0:X,this.ctx.transform=new c(S,H,Y,te,G,X)};var b=function(){return this.margin[0]>0||this.margin[1]>0||this.margin[2]>0||this.margin[3]>0};h.prototype.drawImage=function(S,H,Y,te,G,X,le,he,ve){var ke=this.pdf.getImageProperties(S),Le=1,Be=1,Re=1,re=1;te!==void 0&&he!==void 0&&(Re=he/te,re=ve/G,Le=ke.width/te*he/te,Be=ke.height/G*ve/G),X===void 0&&(X=H,le=Y,H=0,Y=0),te!==void 0&&he===void 0&&(he=te,ve=G),te===void 0&&he===void 0&&(he=ke.width,ve=ke.height);var Me=this.ctx.transform.decompose(),Pe=W(Me.rotate.shx),be=new c,ce=(be=(be=(be=be.multiply(Me.translate)).multiply(Me.skew)).multiply(Me.scale)).applyToRectangle(new l(X-H*Re,le-Y*re,te*Le,G*Be));if(this.autoPaging){for(var Ie,pe=N.call(this,ce),fe=[],we=0;we<pe.length;we+=1)fe.indexOf(pe[we])===-1&&fe.push(pe[we]);I(fe);for(var de=fe[0],xe=fe[fe.length-1],Ne=de;Ne<xe+1;Ne++){this.pdf.setPage(Ne);var it=this.pdf.internal.pageSize.width-this.margin[3]-this.margin[1],st=Ne===1?this.posY+this.margin[0]:this.margin[0],$e=this.pdf.internal.pageSize.height-this.posY-this.margin[0]-this.margin[2],Xe=this.pdf.internal.pageSize.height-this.margin[0]-this.margin[2],Ze=Ne===1?0:$e+(Ne-2)*Xe;if(this.ctx.clip_path.length!==0){var ct=this.path;Ie=JSON.parse(JSON.stringify(this.ctx.clip_path)),this.path=j(Ie,this.posX+this.margin[3],-Ze+st+this.ctx.prevPageLastElemOffset),E.call(this,"fill",!0),this.path=ct}var pt=JSON.parse(JSON.stringify(ce));pt=j([pt],this.posX+this.margin[3],-Ze+st+this.ctx.prevPageLastElemOffset)[0];var dt=(Ne>de||Ne<xe)&&b.call(this);dt&&(this.pdf.saveGraphicsState(),this.pdf.rect(this.margin[3],this.margin[0],it,Xe,null).clip().discardPath()),this.pdf.addImage(S,"JPEG",pt.x,pt.y,pt.w,pt.h,null,null,Pe),dt&&this.pdf.restoreGraphicsState()}}else this.pdf.addImage(S,"JPEG",ce.x,ce.y,ce.w,ce.h,null,null,Pe)};var N=function(S,H,Y){var te=[];H=H||this.pdf.internal.pageSize.width,Y=Y||this.pdf.internal.pageSize.height-this.margin[0]-this.margin[2];var G=this.posY+this.ctx.prevPageLastElemOffset;switch(S.type){default:case"mt":case"lt":te.push(Math.floor((S.y+G)/Y)+1);break;case"arc":te.push(Math.floor((S.y+G-S.radius)/Y)+1),te.push(Math.floor((S.y+G+S.radius)/Y)+1);break;case"qct":var X=ee(this.ctx.lastPoint.x,this.ctx.lastPoint.y,S.x1,S.y1,S.x,S.y);te.push(Math.floor((X.y+G)/Y)+1),te.push(Math.floor((X.y+X.h+G)/Y)+1);break;case"bct":var le=V(this.ctx.lastPoint.x,this.ctx.lastPoint.y,S.x1,S.y1,S.x2,S.y2,S.x,S.y);te.push(Math.floor((le.y+G)/Y)+1),te.push(Math.floor((le.y+le.h+G)/Y)+1);break;case"rect":te.push(Math.floor((S.y+G)/Y)+1),te.push(Math.floor((S.y+S.h+G)/Y)+1)}for(var he=0;he<te.length;he+=1)for(;this.pdf.internal.getNumberOfPages()<te[he];)v.call(this);return te},v=function(){var S=this.fillStyle,H=this.strokeStyle,Y=this.font,te=this.lineCap,G=this.lineWidth,X=this.lineJoin;this.pdf.addPage(),this.fillStyle=S,this.strokeStyle=H,this.font=Y,this.lineCap=te,this.lineWidth=G,this.lineJoin=X},j=function(S,H,Y){for(var te=0;te<S.length;te++)switch(S[te].type){case"bct":S[te].x2+=H,S[te].y2+=Y;case"qct":S[te].x1+=H,S[te].y1+=Y;default:S[te].x+=H,S[te].y+=Y}return S},I=function(S){return S.sort(function(H,Y){return H-Y})},C=function(S,H){var Y=this.fillStyle,te=this.strokeStyle,G=this.lineCap,X=this.lineWidth,le=Math.abs(X*this.ctx.transform.scaleX),he=this.lineJoin;if(this.autoPaging){for(var ve,ke,Le=JSON.parse(JSON.stringify(this.path)),Be=JSON.parse(JSON.stringify(this.path)),Re=[],re=0;re<Be.length;re++)if(Be[re].x!==void 0)for(var Me=N.call(this,Be[re]),Pe=0;Pe<Me.length;Pe+=1)Re.indexOf(Me[Pe])===-1&&Re.push(Me[Pe]);for(var be=0;be<Re.length;be++)for(;this.pdf.internal.getNumberOfPages()<Re[be];)v.call(this);I(Re);for(var ce=Re[0],Ie=Re[Re.length-1],pe=ce;pe<Ie+1;pe++){this.pdf.setPage(pe),this.fillStyle=Y,this.strokeStyle=te,this.lineCap=G,this.lineWidth=le,this.lineJoin=he;var fe=this.pdf.internal.pageSize.width-this.margin[3]-this.margin[1],we=pe===1?this.posY+this.margin[0]:this.margin[0],de=this.pdf.internal.pageSize.height-this.posY-this.margin[0]-this.margin[2],xe=this.pdf.internal.pageSize.height-this.margin[0]-this.margin[2],Ne=pe===1?0:de+(pe-2)*xe;if(this.ctx.clip_path.length!==0){var it=this.path;ve=JSON.parse(JSON.stringify(this.ctx.clip_path)),this.path=j(ve,this.posX+this.margin[3],-Ne+we+this.ctx.prevPageLastElemOffset),E.call(this,S,!0),this.path=it}if(ke=JSON.parse(JSON.stringify(Le)),this.path=j(ke,this.posX+this.margin[3],-Ne+we+this.ctx.prevPageLastElemOffset),H===!1||pe===0){var st=(pe>ce||pe<Ie)&&b.call(this);st&&(this.pdf.saveGraphicsState(),this.pdf.rect(this.margin[3],this.margin[0],fe,xe,null).clip().discardPath()),E.call(this,S,H),st&&this.pdf.restoreGraphicsState()}this.lineWidth=X}this.path=Le}else this.lineWidth=le,E.call(this,S,H),this.lineWidth=X},E=function(S,H){if((S!=="stroke"||H||!x.call(this))&&(S==="stroke"||H||!u.call(this))){for(var Y,te,G=[],X=this.path,le=0;le<X.length;le++){var he=X[le];switch(he.type){case"begin":G.push({begin:!0});break;case"close":G.push({close:!0});break;case"mt":G.push({start:he,deltas:[],abs:[]});break;case"lt":var ve=G.length;if(X[le-1]&&!isNaN(X[le-1].x)&&(Y=[he.x-X[le-1].x,he.y-X[le-1].y],ve>0)){for(;ve>=0;ve--)if(G[ve-1].close!==!0&&G[ve-1].begin!==!0){G[ve-1].deltas.push(Y),G[ve-1].abs.push(he);break}}break;case"bct":Y=[he.x1-X[le-1].x,he.y1-X[le-1].y,he.x2-X[le-1].x,he.y2-X[le-1].y,he.x-X[le-1].x,he.y-X[le-1].y],G[G.length-1].deltas.push(Y);break;case"qct":var ke=X[le-1].x+2/3*(he.x1-X[le-1].x),Le=X[le-1].y+2/3*(he.y1-X[le-1].y),Be=he.x+2/3*(he.x1-he.x),Re=he.y+2/3*(he.y1-he.y),re=he.x,Me=he.y;Y=[ke-X[le-1].x,Le-X[le-1].y,Be-X[le-1].x,Re-X[le-1].y,re-X[le-1].x,Me-X[le-1].y],G[G.length-1].deltas.push(Y);break;case"arc":G.push({deltas:[],abs:[],arc:!0}),Array.isArray(G[G.length-1].abs)&&G[G.length-1].abs.push(he)}}te=H?null:S==="stroke"?"stroke":"fill";for(var Pe=!1,be=0;be<G.length;be++)if(G[be].arc)for(var ce=G[be].abs,Ie=0;Ie<ce.length;Ie++){var pe=ce[Ie];pe.type==="arc"?D.call(this,pe.x,pe.y,pe.radius,pe.startAngle,pe.endAngle,pe.counterclockwise,void 0,H,!Pe):M.call(this,pe.x,pe.y),Pe=!0}else if(G[be].close===!0)this.pdf.internal.out("h"),Pe=!1;else if(G[be].begin!==!0){var fe=G[be].start.x,we=G[be].start.y;P.call(this,G[be].deltas,fe,we),Pe=!0}te&&k.call(this,te),H&&R.call(this)}},T=function(S){var H=this.pdf.internal.getFontSize()/this.pdf.internal.scaleFactor,Y=H*(this.pdf.internal.getLineHeightFactor()-1);switch(this.ctx.textBaseline){case"bottom":return S-Y;case"top":return S+H-Y;case"hanging":return S+H-2*Y;case"middle":return S+H/2-Y;default:return S}},Q=function(S){return S+this.pdf.internal.getFontSize()/this.pdf.internal.scaleFactor*(this.pdf.internal.getLineHeightFactor()-1)};h.prototype.createLinearGradient=function(){var S=function(){};return S.colorStops=[],S.addColorStop=function(H,Y){this.colorStops.push([H,Y])},S.getColor=function(){return this.colorStops.length===0?"#000000":this.colorStops[0][1]},S.isCanvasGradient=!0,S},h.prototype.createPattern=function(){return this.createLinearGradient()},h.prototype.createRadialGradient=function(){return this.createLinearGradient()};var D=function(S,H,Y,te,G,X,le,he,ve){for(var ke=$.call(this,Y,te,G,X),Le=0;Le<ke.length;Le++){var Be=ke[Le];Le===0&&(ve?w.call(this,Be.x1+S,Be.y1+H):M.call(this,Be.x1+S,Be.y1+H)),K.call(this,S,H,Be.x2,Be.y2,Be.x3,Be.y3,Be.x4,Be.y4)}he?R.call(this):k.call(this,le)},k=function(S){switch(S){case"stroke":this.pdf.internal.out("S");break;case"fill":this.pdf.internal.out("f")}},R=function(){this.pdf.clip(),this.pdf.discardPath()},w=function(S,H){this.pdf.internal.out(r(S)+" "+a(H)+" m")},L=function(S){var H;switch(S.align){case"right":case"end":H="right";break;case"center":H="center";break;default:H="left"}var Y,te,G,X=this.pdf.getTextDimensions(S.text),le=T.call(this,S.y),he=Q.call(this,le)-X.h,ve=this.ctx.transform.applyToPoint(new o(S.x,le));if(this.autoPaging){var ke=this.ctx.transform.decompose(),Le=new c;Le=(Le=(Le=Le.multiply(ke.translate)).multiply(ke.skew)).multiply(ke.scale);for(var Be=this.ctx.transform.applyToRectangle(new l(S.x,le,X.w,X.h)),Re=Le.applyToRectangle(new l(S.x,he,X.w,X.h)),re=N.call(this,Re),Me=[],Pe=0;Pe<re.length;Pe+=1)Me.indexOf(re[Pe])===-1&&Me.push(re[Pe]);I(Me);for(var be=Me[0],ce=Me[Me.length-1],Ie=be;Ie<ce+1;Ie++){this.pdf.setPage(Ie);var pe=Ie===1?this.posY+this.margin[0]:this.margin[0],fe=this.pdf.internal.pageSize.height-this.posY-this.margin[0]-this.margin[2],we=this.pdf.internal.pageSize.height-this.margin[2],de=we-this.margin[0],xe=this.pdf.internal.pageSize.width-this.margin[1],Ne=xe-this.margin[3],it=Ie===1?0:fe+(Ie-2)*de;if(this.ctx.clip_path.length!==0){var st=this.path;Y=JSON.parse(JSON.stringify(this.ctx.clip_path)),this.path=j(Y,this.posX+this.margin[3],-1*it+pe),E.call(this,"fill",!0),this.path=st}var $e=j([JSON.parse(JSON.stringify(Re))],this.posX+this.margin[3],-it+pe+this.ctx.prevPageLastElemOffset)[0];S.scale>=.01&&(te=this.pdf.internal.getFontSize(),this.pdf.setFontSize(te*S.scale),G=this.lineWidth,this.lineWidth=G*S.scale);var Xe=this.autoPaging!=="text";if(Xe||$e.y+$e.h<=we){if(Xe||$e.y>=pe&&$e.x<=xe){var Ze=Xe?S.text:this.pdf.splitTextToSize(S.text,S.maxWidth||xe-$e.x)[0],ct=j([JSON.parse(JSON.stringify(Be))],this.posX+this.margin[3],-it+pe+this.ctx.prevPageLastElemOffset)[0],pt=Xe&&(Ie>be||Ie<ce)&&b.call(this);pt&&(this.pdf.saveGraphicsState(),this.pdf.rect(this.margin[3],this.margin[0],Ne,de,null).clip().discardPath()),this.pdf.text(Ze,ct.x,ct.y,{angle:S.angle,align:H,renderingMode:S.renderingMode}),pt&&this.pdf.restoreGraphicsState()}}else $e.y<we&&(this.ctx.prevPageLastElemOffset+=we-$e.y);S.scale>=.01&&(this.pdf.setFontSize(te),this.lineWidth=G)}}else S.scale>=.01&&(te=this.pdf.internal.getFontSize(),this.pdf.setFontSize(te*S.scale),G=this.lineWidth,this.lineWidth=G*S.scale),this.pdf.text(S.text,ve.x+this.posX,ve.y+this.posY,{angle:S.angle,align:H,renderingMode:S.renderingMode,maxWidth:S.maxWidth}),S.scale>=.01&&(this.pdf.setFontSize(te),this.lineWidth=G)},M=function(S,H,Y,te){Y=Y||0,te=te||0,this.pdf.internal.out(r(S+Y)+" "+a(H+te)+" l")},P=function(S,H,Y){return this.pdf.lines(S,H,Y,null,null)},K=function(S,H,Y,te,G,X,le,he){this.pdf.internal.out([e(n(Y+S)),e(i(te+H)),e(n(G+S)),e(i(X+H)),e(n(le+S)),e(i(he+H)),"c"].join(" "))},$=function(S,H,Y,te){for(var G=2*Math.PI,X=Math.PI/2;H>Y;)H-=G;var le=Math.abs(Y-H);le<G&&te&&(le=G-le);for(var he=[],ve=te?-1:1,ke=H;le>1e-5;){var Le=ke+ve*Math.min(le,X);he.push(O.call(this,S,ke,Le)),le-=Math.abs(Le-ke),ke=Le}return he},O=function(S,H,Y){var te=(Y-H)/2,G=S*Math.cos(te),X=S*Math.sin(te),le=G,he=-X,ve=le*le+he*he,ke=ve+le*G+he*X,Le=4/3*(Math.sqrt(2*ve*ke)-ke)/(le*X-he*G),Be=le-Le*he,Re=he+Le*le,re=Be,Me=-Re,Pe=te+H,be=Math.cos(Pe),ce=Math.sin(Pe);return{x1:S*Math.cos(H),y1:S*Math.sin(H),x2:Be*be-Re*ce,y2:Be*ce+Re*be,x3:re*be-Me*ce,y3:re*ce+Me*be,x4:S*Math.cos(Y),y4:S*Math.sin(Y)}},W=function(S){return 180*S/Math.PI},ee=function(S,H,Y,te,G,X){var le=S+.5*(Y-S),he=H+.5*(te-H),ve=G+.5*(Y-G),ke=X+.5*(te-X),Le=Math.min(S,G,le,ve),Be=Math.max(S,G,le,ve),Re=Math.min(H,X,he,ke),re=Math.max(H,X,he,ke);return new l(Le,Re,Be-Le,re-Re)},V=function(S,H,Y,te,G,X,le,he){var ve,ke,Le,Be,Re,re,Me,Pe,be,ce,Ie,pe,fe,we,de=Y-S,xe=te-H,Ne=G-Y,it=X-te,st=le-G,$e=he-X;for(ke=0;ke<41;ke++)be=(Me=(Le=S+(ve=ke/40)*de)+ve*((Re=Y+ve*Ne)-Le))+ve*(Re+ve*(G+ve*st-Re)-Me),ce=(Pe=(Be=H+ve*xe)+ve*((re=te+ve*it)-Be))+ve*(re+ve*(X+ve*$e-re)-Pe),ke==0?(Ie=be,pe=ce,fe=be,we=ce):(Ie=Math.min(Ie,be),pe=Math.min(pe,ce),fe=Math.max(fe,be),we=Math.max(we,ce));return new l(Math.round(Ie),Math.round(pe),Math.round(fe-Ie),Math.round(we-pe))},q=function(){if(this.prevLineDash||this.ctx.lineDash.length||this.ctx.lineDashOffset){var S,H,Y=(S=this.ctx.lineDash,H=this.ctx.lineDashOffset,JSON.stringify({lineDash:S,lineDashOffset:H}));this.prevLineDash!==Y&&(this.pdf.setLineDash(this.ctx.lineDash,this.ctx.lineDashOffset),this.prevLineDash=Y)}}})(Dt.API),function(s){var e=function(o){var l,c,A,d,h,f,u,x,b,N;for(c=[],A=0,d=(o+=l="\0\0\0\0".slice(o.length%4||4)).length;d>A;A+=4)(h=(o.charCodeAt(A)<<24)+(o.charCodeAt(A+1)<<16)+(o.charCodeAt(A+2)<<8)+o.charCodeAt(A+3))!==0?(f=(h=((h=((h=((h=(h-(N=h%85))/85)-(b=h%85))/85)-(x=h%85))/85)-(u=h%85))/85)%85,c.push(f+33,u+33,x+33,b+33,N+33)):c.push(122);return function(v,j){for(var I=j;I>0;I--)v.pop()}(c,l.length),String.fromCharCode.apply(String,c)+"~>"},r=function(o){var l,c,A,d,h,f=String,u="length",x=255,b="charCodeAt",N="slice",v="replace";for(o[N](-2),o=o[N](0,-2)[v](/\s/g,"")[v]("z","!!!!!"),A=[],d=0,h=(o+=l="uuuuu"[N](o[u]%5||5))[u];h>d;d+=5)c=52200625*(o[b](d)-33)+614125*(o[b](d+1)-33)+7225*(o[b](d+2)-33)+85*(o[b](d+3)-33)+(o[b](d+4)-33),A.push(x&c>>24,x&c>>16,x&c>>8,x&c);return function(j,I){for(var C=I;C>0;C--)j.pop()}(A,l[u]),f.fromCharCode.apply(f,A)},a=function(o){return o.split("").map(function(l){return("0"+l.charCodeAt().toString(16)).slice(-2)}).join("")+">"},n=function(o){var l=new RegExp(/^([0-9A-Fa-f]{2})+$/);if((o=o.replace(/\s/g,"")).indexOf(">")!==-1&&(o=o.substr(0,o.indexOf(">"))),o.length%2&&(o+="0"),l.test(o)===!1)return"";for(var c="",A=0;A<o.length;A+=2)c+=String.fromCharCode("0x"+(o[A]+o[A+1]));return c},i=function(o){for(var l=new Uint8Array(o.length),c=o.length;c--;)l[c]=o.charCodeAt(c);return(l=up(l)).reduce(function(A,d){return A+String.fromCharCode(d)},"")};s.processDataByFilters=function(o,l){var c=0,A=o||"",d=[];for(typeof(l=l||[])=="string"&&(l=[l]),c=0;c<l.length;c+=1)switch(l[c]){case"ASCII85Decode":case"/ASCII85Decode":A=r(A),d.push("/ASCII85Encode");break;case"ASCII85Encode":case"/ASCII85Encode":A=e(A),d.push("/ASCII85Decode");break;case"ASCIIHexDecode":case"/ASCIIHexDecode":A=n(A),d.push("/ASCIIHexEncode");break;case"ASCIIHexEncode":case"/ASCIIHexEncode":A=a(A),d.push("/ASCIIHexDecode");break;case"FlateEncode":case"/FlateEncode":A=i(A),d.push("/FlateDecode");break;default:throw new Error('The filter: "'+l[c]+'" is not implemented')}return{data:A,reverseChain:d.reverse().join(" ")}}}(Dt.API),function(s){s.loadFile=function(e,r,a){return function(n,i,o){i=i!==!1,o=typeof o=="function"?o:function(){};var l=void 0;try{l=function(c,A,d){var h=new XMLHttpRequest,f=0,u=function(x){var b=x.length,N=[],v=String.fromCharCode;for(f=0;f<b;f+=1)N.push(v(255&x.charCodeAt(f)));return N.join("")};if(h.open("GET",c,!A),h.overrideMimeType("text/plain; charset=x-user-defined"),A===!1&&(h.onload=function(){h.status===200?d(u(this.responseText)):d(void 0)}),h.send(null),A&&h.status===200)return u(h.responseText)}(n,i,o)}catch{}return l}(e,r,a)},s.loadImageFile=s.loadFile}(Dt.API),function(s){function e(){return(Wt.html2canvas?Promise.resolve(Wt.html2canvas):ns(()=>Promise.resolve().then(()=>LE),void 0)).catch(function(l){return Promise.reject(new Error("Could not load html2canvas: "+l))}).then(function(l){return l.default?l.default:l})}function r(){return(Wt.DOMPurify?Promise.resolve(Wt.DOMPurify):ns(()=>import("./chunks/purify.es.Bzr520pe.js"),[])).catch(function(l){return Promise.reject(new Error("Could not load dompurify: "+l))}).then(function(l){return l.default?l.default:l})}var a=function(l){var c=Rs(l);return c==="undefined"?"undefined":c==="string"||l instanceof String?"string":c==="number"||l instanceof Number?"number":c==="function"||l instanceof Function?"function":l&&l.constructor===Array?"array":l&&l.nodeType===1?"element":c==="object"?"object":"unknown"},n=function(l,c){var A=document.createElement(l);for(var d in c.className&&(A.className=c.className),c.innerHTML&&c.dompurify&&(A.innerHTML=c.dompurify.sanitize(c.innerHTML)),c.style)A.style[d]=c.style[d];return A},i=function l(c,A){for(var d=c.nodeType===3?document.createTextNode(c.nodeValue):c.cloneNode(!1),h=c.firstChild;h;h=h.nextSibling)A!==!0&&h.nodeType===1&&h.nodeName==="SCRIPT"||d.appendChild(l(h,A));return c.nodeType===1&&(c.nodeName==="CANVAS"?(d.width=c.width,d.height=c.height,d.getContext("2d").drawImage(c,0,0)):c.nodeName!=="TEXTAREA"&&c.nodeName!=="SELECT"||(d.value=c.value),d.addEventListener("load",function(){d.scrollTop=c.scrollTop,d.scrollLeft=c.scrollLeft},!0)),d},o=function l(c){var A=Object.assign(l.convert(Promise.resolve()),JSON.parse(JSON.stringify(l.template))),d=l.convert(Promise.resolve(),A);return(d=d.setProgress(1,l,1,[l])).set(c)};(o.prototype=Object.create(Promise.prototype)).constructor=o,o.convert=function(l,c){return l.__proto__=c||o.prototype,l},o.template={prop:{src:null,container:null,overlay:null,canvas:null,img:null,pdf:null,pageSize:null,callback:function(){}},progress:{val:0,state:null,n:0,stack:[]},opt:{filename:"file.pdf",margin:[0,0,0,0],enableLinks:!0,x:0,y:0,html2canvas:{},jsPDF:{},backgroundColor:"transparent"}},o.prototype.from=function(l,c){return this.then(function(){switch(c=c||function(A){switch(a(A)){case"string":return"string";case"element":return A.nodeName.toLowerCase()==="canvas"?"canvas":"element";default:return"unknown"}}(l),c){case"string":return this.then(r).then(function(A){return this.set({src:n("div",{innerHTML:l,dompurify:A})})});case"element":return this.set({src:l});case"canvas":return this.set({canvas:l});case"img":return this.set({img:l});default:return this.error("Unknown source type.")}})},o.prototype.to=function(l){switch(l){case"container":return this.toContainer();case"canvas":return this.toCanvas();case"img":return this.toImg();case"pdf":return this.toPdf();default:return this.error("Invalid target.")}},o.prototype.toContainer=function(){return this.thenList([function(){return this.prop.src||this.error("Cannot duplicate - no source HTML.")},function(){return this.prop.pageSize||this.setPageSize()}]).then(function(){var l={position:"relative",display:"inline-block",width:(typeof this.opt.width!="number"||isNaN(this.opt.width)||typeof this.opt.windowWidth!="number"||isNaN(this.opt.windowWidth)?Math.max(this.prop.src.clientWidth,this.prop.src.scrollWidth,this.prop.src.offsetWidth):this.opt.windowWidth)+"px",left:0,right:0,top:0,margin:"auto",backgroundColor:this.opt.backgroundColor},c=i(this.prop.src,this.opt.html2canvas.javascriptEnabled);c.tagName==="BODY"&&(l.height=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight)+"px"),this.prop.overlay=n("div",{className:"html2pdf__overlay",style:{position:"fixed",overflow:"hidden",zIndex:1e3,left:"-100000px",right:0,bottom:0,top:0}}),this.prop.container=n("div",{className:"html2pdf__container",style:l}),this.prop.container.appendChild(c),this.prop.container.firstChild.appendChild(n("div",{style:{clear:"both",border:"0 none transparent",margin:0,padding:0,height:0}})),this.prop.container.style.float="none",this.prop.overlay.appendChild(this.prop.container),document.body.appendChild(this.prop.overlay),this.prop.container.firstChild.style.position="relative",this.prop.container.height=Math.max(this.prop.container.firstChild.clientHeight,this.prop.container.firstChild.scrollHeight,this.prop.container.firstChild.offsetHeight)+"px"})},o.prototype.toCanvas=function(){var l=[function(){return document.body.contains(this.prop.container)||this.toContainer()}];return this.thenList(l).then(e).then(function(c){var A=Object.assign({},this.opt.html2canvas);return delete A.onrendered,c(this.prop.container,A)}).then(function(c){(this.opt.html2canvas.onrendered||function(){})(c),this.prop.canvas=c,document.body.removeChild(this.prop.overlay)})},o.prototype.toContext2d=function(){var l=[function(){return document.body.contains(this.prop.container)||this.toContainer()}];return this.thenList(l).then(e).then(function(c){var A=this.opt.jsPDF,d=this.opt.fontFaces,h=typeof this.opt.width!="number"||isNaN(this.opt.width)||typeof this.opt.windowWidth!="number"||isNaN(this.opt.windowWidth)?1:this.opt.width/this.opt.windowWidth,f=Object.assign({async:!0,allowTaint:!0,scale:h,scrollX:this.opt.scrollX||0,scrollY:this.opt.scrollY||0,backgroundColor:"#ffffff",imageTimeout:15e3,logging:!0,proxy:null,removeContainer:!0,foreignObjectRendering:!1,useCORS:!1},this.opt.html2canvas);if(delete f.onrendered,A.context2d.autoPaging=this.opt.autoPaging===void 0||this.opt.autoPaging,A.context2d.posX=this.opt.x,A.context2d.posY=this.opt.y,A.context2d.margin=this.opt.margin,A.context2d.fontFaces=d,d)for(var u=0;u<d.length;++u){var x=d[u],b=x.src.find(function(N){return N.format==="truetype"});b&&A.addFont(b.url,x.ref.name,x.ref.style)}return f.windowHeight=f.windowHeight||0,f.windowHeight=f.windowHeight==0?Math.max(this.prop.container.clientHeight,this.prop.container.scrollHeight,this.prop.container.offsetHeight):f.windowHeight,A.context2d.save(!0),c(this.prop.container,f)}).then(function(c){this.opt.jsPDF.context2d.restore(!0),(this.opt.html2canvas.onrendered||function(){})(c),this.prop.canvas=c,document.body.removeChild(this.prop.overlay)})},o.prototype.toImg=function(){return this.thenList([function(){return this.prop.canvas||this.toCanvas()}]).then(function(){var l=this.prop.canvas.toDataURL("image/"+this.opt.image.type,this.opt.image.quality);this.prop.img=document.createElement("img"),this.prop.img.src=l})},o.prototype.toPdf=function(){return this.thenList([function(){return this.toContext2d()}]).then(function(){this.prop.pdf=this.prop.pdf||this.opt.jsPDF})},o.prototype.output=function(l,c,A){return(A=A||"pdf").toLowerCase()==="img"||A.toLowerCase()==="image"?this.outputImg(l,c):this.outputPdf(l,c)},o.prototype.outputPdf=function(l,c){return this.thenList([function(){return this.prop.pdf||this.toPdf()}]).then(function(){return this.prop.pdf.output(l,c)})},o.prototype.outputImg=function(l){return this.thenList([function(){return this.prop.img||this.toImg()}]).then(function(){switch(l){case void 0:case"img":return this.prop.img;case"datauristring":case"dataurlstring":return this.prop.img.src;case"datauri":case"dataurl":return document.location.href=this.prop.img.src;default:throw'Image output type "'+l+'" is not supported.'}})},o.prototype.save=function(l){return this.thenList([function(){return this.prop.pdf||this.toPdf()}]).set(l?{filename:l}:null).then(function(){this.prop.pdf.save(this.opt.filename)})},o.prototype.doCallback=function(){return this.thenList([function(){return this.prop.pdf||this.toPdf()}]).then(function(){this.prop.callback(this.prop.pdf)})},o.prototype.set=function(l){if(a(l)!=="object")return this;var c=Object.keys(l||{}).map(function(A){if(A in o.template.prop)return function(){this.prop[A]=l[A]};switch(A){case"margin":return this.setMargin.bind(this,l.margin);case"jsPDF":return function(){return this.opt.jsPDF=l.jsPDF,this.setPageSize()};case"pageSize":return this.setPageSize.bind(this,l.pageSize);default:return function(){this.opt[A]=l[A]}}},this);return this.then(function(){return this.thenList(c)})},o.prototype.get=function(l,c){return this.then(function(){var A=l in o.template.prop?this.prop[l]:this.opt[l];return c?c(A):A})},o.prototype.setMargin=function(l){return this.then(function(){switch(a(l)){case"number":l=[l,l,l,l];case"array":if(l.length===2&&(l=[l[0],l[1],l[0],l[1]]),l.length===4)break;default:return this.error("Invalid margin array.")}this.opt.margin=l}).then(this.setPageSize)},o.prototype.setPageSize=function(l){function c(A,d){return Math.floor(A*d/72*96)}return this.then(function(){(l=l||Dt.getPageSize(this.opt.jsPDF)).hasOwnProperty("inner")||(l.inner={width:l.width-this.opt.margin[1]-this.opt.margin[3],height:l.height-this.opt.margin[0]-this.opt.margin[2]},l.inner.px={width:c(l.inner.width,l.k),height:c(l.inner.height,l.k)},l.inner.ratio=l.inner.height/l.inner.width),this.prop.pageSize=l})},o.prototype.setProgress=function(l,c,A,d){return l!=null&&(this.progress.val=l),c!=null&&(this.progress.state=c),A!=null&&(this.progress.n=A),d!=null&&(this.progress.stack=d),this.progress.ratio=this.progress.val/this.progress.state,this},o.prototype.updateProgress=function(l,c,A,d){return this.setProgress(l?this.progress.val+l:null,c||null,A?this.progress.n+A:null,d?this.progress.stack.concat(d):null)},o.prototype.then=function(l,c){var A=this;return this.thenCore(l,c,function(d,h){return A.updateProgress(null,null,1,[d]),Promise.prototype.then.call(this,function(f){return A.updateProgress(null,d),f}).then(d,h).then(function(f){return A.updateProgress(1),f})})},o.prototype.thenCore=function(l,c,A){A=A||Promise.prototype.then;var d=this;l&&(l=l.bind(d)),c&&(c=c.bind(d));var h=Promise.toString().indexOf("[native code]")!==-1&&Promise.name==="Promise"?d:o.convert(Object.assign({},d),Promise.prototype),f=A.call(h,l,c);return o.convert(f,d.__proto__)},o.prototype.thenExternal=function(l,c){return Promise.prototype.then.call(this,l,c)},o.prototype.thenList=function(l){var c=this;return l.forEach(function(A){c=c.thenCore(A)}),c},o.prototype.catch=function(l){l&&(l=l.bind(this));var c=Promise.prototype.catch.call(this,l);return o.convert(c,this)},o.prototype.catchExternal=function(l){return Promise.prototype.catch.call(this,l)},o.prototype.error=function(l){return this.then(function(){throw new Error(l)})},o.prototype.using=o.prototype.set,o.prototype.saveAs=o.prototype.save,o.prototype.export=o.prototype.output,o.prototype.run=o.prototype.then,Dt.getPageSize=function(l,c,A){if(Rs(l)==="object"){var d=l;l=d.orientation,c=d.unit||c,A=d.format||A}c=c||"mm",A=A||"a4",l=(""+(l||"P")).toLowerCase();var h,f=(""+A).toLowerCase(),u={a0:[2383.94,3370.39],a1:[1683.78,2383.94],a2:[1190.55,1683.78],a3:[841.89,1190.55],a4:[595.28,841.89],a5:[419.53,595.28],a6:[297.64,419.53],a7:[209.76,297.64],a8:[147.4,209.76],a9:[104.88,147.4],a10:[73.7,104.88],b0:[2834.65,4008.19],b1:[2004.09,2834.65],b2:[1417.32,2004.09],b3:[1000.63,1417.32],b4:[708.66,1000.63],b5:[498.9,708.66],b6:[354.33,498.9],b7:[249.45,354.33],b8:[175.75,249.45],b9:[124.72,175.75],b10:[87.87,124.72],c0:[2599.37,3676.54],c1:[1836.85,2599.37],c2:[1298.27,1836.85],c3:[918.43,1298.27],c4:[649.13,918.43],c5:[459.21,649.13],c6:[323.15,459.21],c7:[229.61,323.15],c8:[161.57,229.61],c9:[113.39,161.57],c10:[79.37,113.39],dl:[311.81,623.62],letter:[612,792],"government-letter":[576,756],legal:[612,1008],"junior-legal":[576,360],ledger:[1224,792],tabloid:[792,1224],"credit-card":[153,243]};switch(c){case"pt":h=1;break;case"mm":h=72/25.4;break;case"cm":h=72/2.54;break;case"in":h=72;break;case"px":h=.75;break;case"pc":case"em":h=12;break;case"ex":h=6;break;default:throw"Invalid unit: "+c}var x,b=0,N=0;if(u.hasOwnProperty(f))b=u[f][1]/h,N=u[f][0]/h;else try{b=A[1],N=A[0]}catch{throw new Error("Invalid format: "+A)}if(l==="p"||l==="portrait")l="p",N>b&&(x=N,N=b,b=x);else{if(l!=="l"&&l!=="landscape")throw"Invalid orientation: "+l;l="l",b>N&&(x=N,N=b,b=x)}return{width:N,height:b,unit:c,k:h,orientation:l}},s.html=function(l,c){(c=c||{}).callback=c.callback||function(){},c.html2canvas=c.html2canvas||{},c.html2canvas.canvas=c.html2canvas.canvas||this.canvas,c.jsPDF=c.jsPDF||this,c.fontFaces=c.fontFaces?c.fontFaces.map(Ch):null;var A=new o(c);return c.worker?A:A.from(l).doCallback()}}(Dt.API),Dt.API.addJS=function(s){return ay=s,this.internal.events.subscribe("postPutResources",function(){$d=this.internal.newObject(),this.internal.out("<<"),this.internal.out("/Names [(EmbeddedJS) "+($d+1)+" 0 R]"),this.internal.out(">>"),this.internal.out("endobj"),ry=this.internal.newObject(),this.internal.out("<<"),this.internal.out("/S /JavaScript"),this.internal.out("/JS ("+ay+")"),this.internal.out(">>"),this.internal.out("endobj")}),this.internal.events.subscribe("putCatalog",function(){$d!==void 0&&ry!==void 0&&this.internal.out("/Names <</JavaScript "+$d+" 0 R>>")}),this},function(s){var e;s.events.push(["postPutResources",function(){var r=this,a=/^(\d+) 0 obj$/;if(this.outline.root.children.length>0)for(var n=r.outline.render().split(/\r\n/),i=0;i<n.length;i++){var o=n[i],l=a.exec(o);if(l!=null){var c=l[1];r.internal.newObjectDeferredBegin(c,!1)}r.internal.write(o)}if(this.outline.createNamedDestinations){var A=this.internal.pages.length,d=[];for(i=0;i<A;i++){var h=r.internal.newObject();d.push(h);var f=r.internal.getPageInfo(i+1);r.internal.write("<< /D["+f.objId+" 0 R /XYZ null null null]>> endobj")}var u=r.internal.newObject();for(r.internal.write("<< /Names [ "),i=0;i<d.length;i++)r.internal.write("(page_"+(i+1)+")"+d[i]+" 0 R");r.internal.write(" ] >>","endobj"),e=r.internal.newObject(),r.internal.write("<< /Dests "+u+" 0 R"),r.internal.write(">>","endobj")}}]),s.events.push(["putCatalog",function(){var r=this;r.outline.root.children.length>0&&(r.internal.write("/Outlines",this.outline.makeRef(this.outline.root)),this.outline.createNamedDestinations&&r.internal.write("/Names "+e+" 0 R"))}]),s.events.push(["initialized",function(){var r=this;r.outline={createNamedDestinations:!1,root:{children:[]}},r.outline.add=function(a,n,i){var o={title:n,options:i,children:[]};return a==null&&(a=this.root),a.children.push(o),o},r.outline.render=function(){return this.ctx={},this.ctx.val="",this.ctx.pdf=r,this.genIds_r(this.root),this.renderRoot(this.root),this.renderItems(this.root),this.ctx.val},r.outline.genIds_r=function(a){a.id=r.internal.newObjectDeferred();for(var n=0;n<a.children.length;n++)this.genIds_r(a.children[n])},r.outline.renderRoot=function(a){this.objStart(a),this.line("/Type /Outlines"),a.children.length>0&&(this.line("/First "+this.makeRef(a.children[0])),this.line("/Last "+this.makeRef(a.children[a.children.length-1]))),this.line("/Count "+this.count_r({count:0},a)),this.objEnd()},r.outline.renderItems=function(a){for(var n=this.ctx.pdf.internal.getVerticalCoordinateString,i=0;i<a.children.length;i++){var o=a.children[i];this.objStart(o),this.line("/Title "+this.makeString(o.title)),this.line("/Parent "+this.makeRef(a)),i>0&&this.line("/Prev "+this.makeRef(a.children[i-1])),i<a.children.length-1&&this.line("/Next "+this.makeRef(a.children[i+1])),o.children.length>0&&(this.line("/First "+this.makeRef(o.children[0])),this.line("/Last "+this.makeRef(o.children[o.children.length-1])));var l=this.count=this.count_r({count:0},o);if(l>0&&this.line("/Count "+l),o.options&&o.options.pageNumber){var c=r.internal.getPageInfo(o.options.pageNumber);this.line("/Dest ["+c.objId+" 0 R /XYZ 0 "+n(0)+" 0]")}this.objEnd()}for(var A=0;A<a.children.length;A++)this.renderItems(a.children[A])},r.outline.line=function(a){this.ctx.val+=a+`\r
`},r.outline.makeRef=function(a){return a.id+" 0 R"},r.outline.makeString=function(a){return"("+r.internal.pdfEscape(a)+")"},r.outline.objStart=function(a){this.ctx.val+=`\r
`+a.id+` 0 obj\r
<<\r
`},r.outline.objEnd=function(){this.ctx.val+=`>> \r
endobj\r
`},r.outline.count_r=function(a,n){for(var i=0;i<n.children.length;i++)a.count++,this.count_r(a,n.children[i]);return a.count}}])}(Dt.API),function(s){var e=[192,193,194,195,196,197,198,199];s.processJPEG=function(r,a,n,i,o,l){var c,A=this.decode.DCT_DECODE,d=null;if(typeof r=="string"||this.__addimage__.isArrayBuffer(r)||this.__addimage__.isArrayBufferView(r)){switch(r=o||r,r=this.__addimage__.isArrayBuffer(r)?new Uint8Array(r):r,c=function(h){for(var f,u=256*h.charCodeAt(4)+h.charCodeAt(5),x=h.length,b={width:0,height:0,numcomponents:1},N=4;N<x;N+=2){if(N+=u,e.indexOf(h.charCodeAt(N+1))!==-1){f=256*h.charCodeAt(N+5)+h.charCodeAt(N+6),b={width:256*h.charCodeAt(N+7)+h.charCodeAt(N+8),height:f,numcomponents:h.charCodeAt(N+9)};break}u=256*h.charCodeAt(N+2)+h.charCodeAt(N+3)}return b}(r=this.__addimage__.isArrayBufferView(r)?this.__addimage__.arrayBufferToBinaryString(r):r),c.numcomponents){case 1:l=this.color_spaces.DEVICE_GRAY;break;case 4:l=this.color_spaces.DEVICE_CMYK;break;case 3:l=this.color_spaces.DEVICE_RGB}d={data:r,width:c.width,height:c.height,colorSpace:l,bitsPerComponent:8,filter:A,index:a,alias:n}}return d}}(Dt.API),Dt.API.processPNG=function(s,e,r,a){if(this.__addimage__.isArrayBuffer(s)&&(s=new Uint8Array(s)),this.__addimage__.isArrayBufferView(s)){var n,i=CU(s,{checkCrc:!0}),o=i.width,l=i.height,c=i.channels,A=i.palette,d=i.depth;n=A&&c===1?function(D){for(var k=D.width,R=D.height,w=D.data,L=D.palette,M=D.depth,P=!1,K=[],$=[],O=void 0,W=!1,ee=0,V=0;V<L.length;V++){var q=lx(L[V],4),S=q[0],H=q[1],Y=q[2],te=q[3];K.push(S,H,Y),te!=null&&(te===0?(ee++,$.length<1&&$.push(V)):te<255&&(W=!0))}if(W||ee>1){P=!0,$=void 0;var G=k*R;O=new Uint8Array(G);for(var X=new DataView(w.buffer),le=0;le<G;le++){var he=Bh(X,le,M),ve=lx(L[he],4)[3];O[le]=ve}}else ee===0&&($=void 0);return{colorSpace:"Indexed",colorsPerPixel:1,sMaskBitsPerComponent:P?8:void 0,colorBytes:w,alphaBytes:O,needSMask:P,palette:K,mask:$}}(i):c===2||c===4?function(D){for(var k=D.data,R=D.width,w=D.height,L=D.channels,M=D.depth,P=L===2?"DeviceGray":"DeviceRGB",K=L-1,$=R*w,O=K,W=$*O,ee=1*$,V=Math.ceil(W*M/8),q=Math.ceil(ee*M/8),S=new Uint8Array(V),H=new Uint8Array(q),Y=new DataView(k.buffer),te=new DataView(S.buffer),G=new DataView(H.buffer),X=!1,le=0;le<$;le++){for(var he=le*L,ve=0;ve<O;ve++)my(te,Bh(Y,he+ve,M),le*O+ve,M);var ke=Bh(Y,he+O,M);ke<(1<<M)-1&&(X=!0),my(G,ke,1*le,M)}return{colorSpace:P,colorsPerPixel:K,sMaskBitsPerComponent:X?M:void 0,colorBytes:S,alphaBytes:H,needSMask:X}}(i):function(D){var k=D.data,R=D.channels===1?"DeviceGray":"DeviceRGB";return{colorSpace:R,colorsPerPixel:R==="DeviceGray"?1:3,colorBytes:k instanceof Uint16Array?function(w){for(var L=w.length,M=new Uint8Array(2*L),P=new DataView(M.buffer,M.byteOffset,M.byteLength),K=0;K<L;K++)P.setUint16(2*K,w[K],!1);return M}(k):k,needSMask:!1}}(i);var h,f,u,x=n,b=x.colorSpace,N=x.colorsPerPixel,v=x.sMaskBitsPerComponent,j=x.colorBytes,I=x.alphaBytes,C=x.needSMask,E=x.palette,T=x.mask,Q=null;return a!==Dt.API.image_compression.NONE&&typeof up=="function"?(Q=function(D){var k;switch(D){case Dt.API.image_compression.FAST:k=11;break;case Dt.API.image_compression.MEDIUM:k=13;break;case Dt.API.image_compression.SLOW:k=14;break;default:k=12}return k}(a),h=this.decode.FLATE_DECODE,f="/Predictor ".concat(Q," /Colors ").concat(N," /BitsPerComponent ").concat(d," /Columns ").concat(o),s=ly(j,Math.ceil(o*N*d/8),N,d,a),C&&(u=ly(I,Math.ceil(o*v/8),1,v,a))):(h=void 0,f=void 0,s=j,C&&(u=I)),(this.__addimage__.isArrayBuffer(s)||this.__addimage__.isArrayBufferView(s))&&(s=this.__addimage__.arrayBufferToBinaryString(s)),(u&&this.__addimage__.isArrayBuffer(u)||this.__addimage__.isArrayBufferView(u))&&(u=this.__addimage__.arrayBufferToBinaryString(u)),{alias:r,data:s,index:e,filter:h,decodeParameters:f,transparency:T,palette:E,sMask:u,predictor:Q,width:o,height:l,bitsPerComponent:d,sMaskBitsPerComponent:v,colorSpace:b}}},function(s){s.processGIF89A=function(e,r,a,n){var i=new $U(e),o=i.width,l=i.height,c=[];i.decodeAndBlitFrameRGBA(0,c);var A={data:c,width:o,height:l},d=new Sh(100).encode(A,100);return s.processJPEG.call(this,d,r,a,n)},s.processGIF87A=s.processGIF89A}(Dt.API),Gn.prototype.parseHeader=function(){if(this.fileSize=this.datav.getUint32(this.pos,!0),this.pos+=4,this.reserved=this.datav.getUint32(this.pos,!0),this.pos+=4,this.offset=this.datav.getUint32(this.pos,!0),this.pos+=4,this.headerSize=this.datav.getUint32(this.pos,!0),this.pos+=4,this.width=this.datav.getUint32(this.pos,!0),this.pos+=4,this.height=this.datav.getInt32(this.pos,!0),this.pos+=4,this.planes=this.datav.getUint16(this.pos,!0),this.pos+=2,this.bitPP=this.datav.getUint16(this.pos,!0),this.pos+=2,this.compress=this.datav.getUint32(this.pos,!0),this.pos+=4,this.rawSize=this.datav.getUint32(this.pos,!0),this.pos+=4,this.hr=this.datav.getUint32(this.pos,!0),this.pos+=4,this.vr=this.datav.getUint32(this.pos,!0),this.pos+=4,this.colors=this.datav.getUint32(this.pos,!0),this.pos+=4,this.importantColors=this.datav.getUint32(this.pos,!0),this.pos+=4,this.bitPP===16&&this.is_with_alpha&&(this.bitPP=15),this.bitPP<15){var s=this.colors===0?1<<this.bitPP:this.colors;this.palette=new Array(s);for(var e=0;e<s;e++){var r=this.datav.getUint8(this.pos++,!0),a=this.datav.getUint8(this.pos++,!0),n=this.datav.getUint8(this.pos++,!0),i=this.datav.getUint8(this.pos++,!0);this.palette[e]={red:n,green:a,blue:r,quad:i}}}this.height<0&&(this.height*=-1,this.bottom_up=!1)},Gn.prototype.parseBGR=function(){this.pos=this.offset;try{var s="bit"+this.bitPP,e=this.width*this.height*4;this.data=new Uint8Array(e),this[s]()}catch(r){Gs.log("bit decode error:"+r)}},Gn.prototype.bit1=function(){var s,e=Math.ceil(this.width/8),r=e%4;for(s=this.height-1;s>=0;s--){for(var a=this.bottom_up?s:this.height-1-s,n=0;n<e;n++)for(var i=this.datav.getUint8(this.pos++,!0),o=a*this.width*4+8*n*4,l=0;l<8&&8*n+l<this.width;l++){var c=this.palette[i>>7-l&1];this.data[o+4*l]=c.blue,this.data[o+4*l+1]=c.green,this.data[o+4*l+2]=c.red,this.data[o+4*l+3]=255}r!==0&&(this.pos+=4-r)}},Gn.prototype.bit4=function(){for(var s=Math.ceil(this.width/2),e=s%4,r=this.height-1;r>=0;r--){for(var a=this.bottom_up?r:this.height-1-r,n=0;n<s;n++){var i=this.datav.getUint8(this.pos++,!0),o=a*this.width*4+2*n*4,l=i>>4,c=15&i,A=this.palette[l];if(this.data[o]=A.blue,this.data[o+1]=A.green,this.data[o+2]=A.red,this.data[o+3]=255,2*n+1>=this.width)break;A=this.palette[c],this.data[o+4]=A.blue,this.data[o+4+1]=A.green,this.data[o+4+2]=A.red,this.data[o+4+3]=255}e!==0&&(this.pos+=4-e)}},Gn.prototype.bit8=function(){for(var s=this.width%4,e=this.height-1;e>=0;e--){for(var r=this.bottom_up?e:this.height-1-e,a=0;a<this.width;a++){var n=this.datav.getUint8(this.pos++,!0),i=r*this.width*4+4*a;if(n<this.palette.length){var o=this.palette[n];this.data[i]=o.red,this.data[i+1]=o.green,this.data[i+2]=o.blue,this.data[i+3]=255}else this.data[i]=255,this.data[i+1]=255,this.data[i+2]=255,this.data[i+3]=255}s!==0&&(this.pos+=4-s)}},Gn.prototype.bit15=function(){for(var s=this.width%3,e=parseInt("11111",2),r=this.height-1;r>=0;r--){for(var a=this.bottom_up?r:this.height-1-r,n=0;n<this.width;n++){var i=this.datav.getUint16(this.pos,!0);this.pos+=2;var o=(i&e)/e*255|0,l=(i>>5&e)/e*255|0,c=(i>>10&e)/e*255|0,A=i>>15?255:0,d=a*this.width*4+4*n;this.data[d]=c,this.data[d+1]=l,this.data[d+2]=o,this.data[d+3]=A}this.pos+=s}},Gn.prototype.bit16=function(){for(var s=this.width%3,e=parseInt("11111",2),r=parseInt("111111",2),a=this.height-1;a>=0;a--){for(var n=this.bottom_up?a:this.height-1-a,i=0;i<this.width;i++){var o=this.datav.getUint16(this.pos,!0);this.pos+=2;var l=(o&e)/e*255|0,c=(o>>5&r)/r*255|0,A=(o>>11)/e*255|0,d=n*this.width*4+4*i;this.data[d]=A,this.data[d+1]=c,this.data[d+2]=l,this.data[d+3]=255}this.pos+=s}},Gn.prototype.bit24=function(){for(var s=this.height-1;s>=0;s--){for(var e=this.bottom_up?s:this.height-1-s,r=0;r<this.width;r++){var a=this.datav.getUint8(this.pos++,!0),n=this.datav.getUint8(this.pos++,!0),i=this.datav.getUint8(this.pos++,!0),o=e*this.width*4+4*r;this.data[o]=i,this.data[o+1]=n,this.data[o+2]=a,this.data[o+3]=255}this.pos+=this.width%4}},Gn.prototype.bit32=function(){for(var s=this.height-1;s>=0;s--)for(var e=this.bottom_up?s:this.height-1-s,r=0;r<this.width;r++){var a=this.datav.getUint8(this.pos++,!0),n=this.datav.getUint8(this.pos++,!0),i=this.datav.getUint8(this.pos++,!0),o=this.datav.getUint8(this.pos++,!0),l=e*this.width*4+4*r;this.data[l]=i,this.data[l+1]=n,this.data[l+2]=a,this.data[l+3]=o}},Gn.prototype.getData=function(){return this.data},function(s){s.processBMP=function(e,r,a,n){var i=new Gn(e,!1),o=i.width,l=i.height,c={data:i.getData(),width:o,height:l},A=new Sh(100).encode(c,100);return s.processJPEG.call(this,A,r,a,n)}}(Dt.API),py.prototype.getData=function(){return this.data},function(s){s.processWEBP=function(e,r,a,n){var i=new py(e),o=i.width,l=i.height,c={data:i.getData(),width:o,height:l},A=new Sh(100).encode(c,100);return s.processJPEG.call(this,A,r,a,n)}}(Dt.API),Dt.API.processRGBA=function(s,e,r){for(var a=s.data,n=a.length,i=new Uint8Array(n/4*3),o=new Uint8Array(n/4),l=0,c=0,A=0;A<n;A+=4){var d=a[A],h=a[A+1],f=a[A+2],u=a[A+3];i[l++]=d,i[l++]=h,i[l++]=f,o[c++]=u}var x=this.__addimage__.arrayBufferToBinaryString(i);return{alpha:this.__addimage__.arrayBufferToBinaryString(o),data:x,index:e,alias:r,colorSpace:"DeviceRGB",bitsPerComponent:8,width:s.width,height:s.height}},Dt.API.setLanguage=function(s){return this.internal.languageSettings===void 0&&(this.internal.languageSettings={},this.internal.languageSettings.isSubscribed=!1),{af:"Afrikaans",sq:"Albanian",ar:"Arabic (Standard)","ar-DZ":"Arabic (Algeria)","ar-BH":"Arabic (Bahrain)","ar-EG":"Arabic (Egypt)","ar-IQ":"Arabic (Iraq)","ar-JO":"Arabic (Jordan)","ar-KW":"Arabic (Kuwait)","ar-LB":"Arabic (Lebanon)","ar-LY":"Arabic (Libya)","ar-MA":"Arabic (Morocco)","ar-OM":"Arabic (Oman)","ar-QA":"Arabic (Qatar)","ar-SA":"Arabic (Saudi Arabia)","ar-SY":"Arabic (Syria)","ar-TN":"Arabic (Tunisia)","ar-AE":"Arabic (U.A.E.)","ar-YE":"Arabic (Yemen)",an:"Aragonese",hy:"Armenian",as:"Assamese",ast:"Asturian",az:"Azerbaijani",eu:"Basque",be:"Belarusian",bn:"Bengali",bs:"Bosnian",br:"Breton",bg:"Bulgarian",my:"Burmese",ca:"Catalan",ch:"Chamorro",ce:"Chechen",zh:"Chinese","zh-HK":"Chinese (Hong Kong)","zh-CN":"Chinese (PRC)","zh-SG":"Chinese (Singapore)","zh-TW":"Chinese (Taiwan)",cv:"Chuvash",co:"Corsican",cr:"Cree",hr:"Croatian",cs:"Czech",da:"Danish",nl:"Dutch (Standard)","nl-BE":"Dutch (Belgian)",en:"English","en-AU":"English (Australia)","en-BZ":"English (Belize)","en-CA":"English (Canada)","en-IE":"English (Ireland)","en-JM":"English (Jamaica)","en-NZ":"English (New Zealand)","en-PH":"English (Philippines)","en-ZA":"English (South Africa)","en-TT":"English (Trinidad & Tobago)","en-GB":"English (United Kingdom)","en-US":"English (United States)","en-ZW":"English (Zimbabwe)",eo:"Esperanto",et:"Estonian",fo:"Faeroese",fj:"Fijian",fi:"Finnish",fr:"French (Standard)","fr-BE":"French (Belgium)","fr-CA":"French (Canada)","fr-FR":"French (France)","fr-LU":"French (Luxembourg)","fr-MC":"French (Monaco)","fr-CH":"French (Switzerland)",fy:"Frisian",fur:"Friulian",gd:"Gaelic (Scots)","gd-IE":"Gaelic (Irish)",gl:"Galacian",ka:"Georgian",de:"German (Standard)","de-AT":"German (Austria)","de-DE":"German (Germany)","de-LI":"German (Liechtenstein)","de-LU":"German (Luxembourg)","de-CH":"German (Switzerland)",el:"Greek",gu:"Gujurati",ht:"Haitian",he:"Hebrew",hi:"Hindi",hu:"Hungarian",is:"Icelandic",id:"Indonesian",iu:"Inuktitut",ga:"Irish",it:"Italian (Standard)","it-CH":"Italian (Switzerland)",ja:"Japanese",kn:"Kannada",ks:"Kashmiri",kk:"Kazakh",km:"Khmer",ky:"Kirghiz",tlh:"Klingon",ko:"Korean","ko-KP":"Korean (North Korea)","ko-KR":"Korean (South Korea)",la:"Latin",lv:"Latvian",lt:"Lithuanian",lb:"Luxembourgish",mk:"North Macedonia",ms:"Malay",ml:"Malayalam",mt:"Maltese",mi:"Maori",mr:"Marathi",mo:"Moldavian",nv:"Navajo",ng:"Ndonga",ne:"Nepali",no:"Norwegian",nb:"Norwegian (Bokmal)",nn:"Norwegian (Nynorsk)",oc:"Occitan",or:"Oriya",om:"Oromo",fa:"Persian","fa-IR":"Persian/Iran",pl:"Polish",pt:"Portuguese","pt-BR":"Portuguese (Brazil)",pa:"Punjabi","pa-IN":"Punjabi (India)","pa-PK":"Punjabi (Pakistan)",qu:"Quechua",rm:"Rhaeto-Romanic",ro:"Romanian","ro-MO":"Romanian (Moldavia)",ru:"Russian","ru-MO":"Russian (Moldavia)",sz:"Sami (Lappish)",sg:"Sango",sa:"Sanskrit",sc:"Sardinian",sd:"Sindhi",si:"Singhalese",sr:"Serbian",sk:"Slovak",sl:"Slovenian",so:"Somani",sb:"Sorbian",es:"Spanish","es-AR":"Spanish (Argentina)","es-BO":"Spanish (Bolivia)","es-CL":"Spanish (Chile)","es-CO":"Spanish (Colombia)","es-CR":"Spanish (Costa Rica)","es-DO":"Spanish (Dominican Republic)","es-EC":"Spanish (Ecuador)","es-SV":"Spanish (El Salvador)","es-GT":"Spanish (Guatemala)","es-HN":"Spanish (Honduras)","es-MX":"Spanish (Mexico)","es-NI":"Spanish (Nicaragua)","es-PA":"Spanish (Panama)","es-PY":"Spanish (Paraguay)","es-PE":"Spanish (Peru)","es-PR":"Spanish (Puerto Rico)","es-ES":"Spanish (Spain)","es-UY":"Spanish (Uruguay)","es-VE":"Spanish (Venezuela)",sx:"Sutu",sw:"Swahili",sv:"Swedish","sv-FI":"Swedish (Finland)","sv-SV":"Swedish (Sweden)",ta:"Tamil",tt:"Tatar",te:"Teluga",th:"Thai",tig:"Tigre",ts:"Tsonga",tn:"Tswana",tr:"Turkish",tk:"Turkmen",uk:"Ukrainian",hsb:"Upper Sorbian",ur:"Urdu",ve:"Venda",vi:"Vietnamese",vo:"Volapuk",wa:"Walloon",cy:"Welsh",xh:"Xhosa",ji:"Yiddish",zu:"Zulu"}[s]!==void 0&&(this.internal.languageSettings.languageCode=s,this.internal.languageSettings.isSubscribed===!1&&(this.internal.events.subscribe("putCatalog",function(){this.internal.write("/Lang ("+this.internal.languageSettings.languageCode+")")}),this.internal.languageSettings.isSubscribed=!0)),this},Pl=Dt.API,Kd=Pl.getCharWidthsArray=function(s,e){var r,a,n=(e=e||{}).font||this.internal.getFont(),i=e.fontSize||this.internal.getFontSize(),o=e.charSpace||this.internal.getCharSpace(),l=e.widths?e.widths:n.metadata.Unicode.widths,c=l.fof?l.fof:1,A=e.kerning?e.kerning:n.metadata.Unicode.kerning,d=A.fof?A.fof:1,h=e.doKerning!==!1,f=0,u=s.length,x=0,b=l[0]||c,N=[];for(r=0;r<u;r++)a=s.charCodeAt(r),typeof n.metadata.widthOfString=="function"?N.push((n.metadata.widthOfGlyph(n.metadata.characterToGlyph(a))+o*(1e3/i)||0)/1e3):(f=h&&Rs(A[a])==="object"&&!isNaN(parseInt(A[a][x],10))?A[a][x]/d:0,N.push((l[a]||b)/c+f)),x=a;return N},ny=Pl.getStringUnitWidth=function(s,e){var r=(e=e||{}).fontSize||this.internal.getFontSize(),a=e.font||this.internal.getFont(),n=e.charSpace||this.internal.getCharSpace();return Pl.processArabic&&(s=Pl.processArabic(s)),typeof a.metadata.widthOfString=="function"?a.metadata.widthOfString(s,r,n)/r:Kd.apply(this,arguments).reduce(function(i,o){return i+o},0)},iy=function(s,e,r,a){for(var n=[],i=0,o=s.length,l=0;i!==o&&l+e[i]<r;)l+=e[i],i++;n.push(s.slice(0,i));var c=i;for(l=0;i!==o;)l+e[i]>a&&(n.push(s.slice(c,i)),l=0,c=i),l+=e[i],i++;return c!==i&&n.push(s.slice(c,i)),n},oy=function(s,e,r){r||(r={});var a,n,i,o,l,c,A,d=[],h=[d],f=r.textIndent||0,u=0,x=0,b=s.split(" "),N=Kd.apply(this,[" ",r])[0];if(c=r.lineIndent===-1?b[0].length+2:r.lineIndent||0){var v=Array(c).join(" "),j=[];b.map(function(C){(C=C.split(/\s*\n/)).length>1?j=j.concat(C.map(function(E,T){return(T&&E.length?`
`:"")+E})):j.push(C[0])}),b=j,c=ny.apply(this,[v,r])}for(i=0,o=b.length;i<o;i++){var I=0;if(a=b[i],c&&a[0]==`
`&&(a=a.substr(1),I=1),f+u+(x=(n=Kd.apply(this,[a,r])).reduce(function(C,E){return C+E},0))>e||I){if(x>e){for(l=iy.apply(this,[a,n,e-(f+u),e]),d.push(l.shift()),d=[l.pop()];l.length;)h.push([l.shift()]);x=n.slice(a.length-(d[0]?d[0].length:0)).reduce(function(C,E){return C+E},0)}else d=[a];h.push(d),f=x+c,u=N}else d.push(a),f+=u+x,u=N}return A=c?function(C,E){return(E?v:"")+C.join(" ")}:function(C){return C.join(" ")},h.map(A)},Pl.splitTextToSize=function(s,e,r){var a,n=(r=r||{}).fontSize||this.internal.getFontSize(),i=function(d){if(d.widths&&d.kerning)return{widths:d.widths,kerning:d.kerning};var h=this.internal.getFont(d.fontName,d.fontStyle),f="Unicode";return h.metadata[f]?{widths:h.metadata[f].widths||{0:1},kerning:h.metadata[f].kerning||{}}:{font:h.metadata,fontSize:this.internal.getFontSize(),charSpace:this.internal.getCharSpace()}}.call(this,r);a=Array.isArray(s)?s:String(s).split(/\r?\n/);var o=1*this.internal.scaleFactor*e/n;i.textIndent=r.textIndent?1*r.textIndent*this.internal.scaleFactor/n:0,i.lineIndent=r.lineIndent;var l,c,A=[];for(l=0,c=a.length;l<c;l++)A=A.concat(oy.apply(this,[a[l],o,i]));return A},function(s){s.__fontmetrics__=s.__fontmetrics__||{};for(var e="0123456789abcdef",r="klmnopqrstuvwxyz",a={},n={},i=0;i<16;i++)a[r[i]]=e[i],n[e[i]]=r[i];var o=function(f){return"0x"+parseInt(f,10).toString(16)},l=s.__fontmetrics__.compress=function(f){var u,x,b,N,v=["{"];for(var j in f){if(u=f[j],isNaN(parseInt(j,10))?x="'"+j+"'":(j=parseInt(j,10),x=(x=o(j).slice(2)).slice(0,-1)+n[x.slice(-1)]),typeof u=="number")u<0?(b=o(u).slice(3),N="-"):(b=o(u).slice(2),N=""),b=N+b.slice(0,-1)+n[b.slice(-1)];else{if(Rs(u)!=="object")throw new Error("Don't know what to do with value type "+Rs(u)+".");b=l(u)}v.push(x+b)}return v.push("}"),v.join("")},c=s.__fontmetrics__.uncompress=function(f){if(typeof f!="string")throw new Error("Invalid argument passed to uncompress.");for(var u,x,b,N,v={},j=1,I=v,C=[],E="",T="",Q=f.length-1,D=1;D<Q;D+=1)(N=f[D])=="'"?u?(b=u.join(""),u=void 0):u=[]:u?u.push(N):N=="{"?(C.push([I,b]),I={},b=void 0):N=="}"?((x=C.pop())[0][x[1]]=I,b=void 0,I=x[0]):N=="-"?j=-1:b===void 0?a.hasOwnProperty(N)?(E+=a[N],b=parseInt(E,16)*j,j=1,E=""):E+=N:a.hasOwnProperty(N)?(T+=a[N],I[b]=parseInt(T,16)*j,j=1,b=void 0,T=""):T+=N;return v},A={codePages:["WinAnsiEncoding"],WinAnsiEncoding:c("{19m8n201n9q201o9r201s9l201t9m201u8m201w9n201x9o201y8o202k8q202l8r202m9p202q8p20aw8k203k8t203t8v203u9v2cq8s212m9t15m8w15n9w2dw9s16k8u16l9u17s9z17x8y17y9y}")},d={Unicode:{Courier:A,"Courier-Bold":A,"Courier-BoldOblique":A,"Courier-Oblique":A,Helvetica:A,"Helvetica-Bold":A,"Helvetica-BoldOblique":A,"Helvetica-Oblique":A,"Times-Roman":A,"Times-Bold":A,"Times-BoldItalic":A,"Times-Italic":A}},h={Unicode:{"Courier-Oblique":c("{'widths'{k3w'fof'6o}'kerning'{'fof'-6o}}"),"Times-BoldItalic":c("{'widths'{k3o2q4ycx2r201n3m201o6o201s2l201t2l201u2l201w3m201x3m201y3m2k1t2l2r202m2n2n3m2o3m2p5n202q6o2r1w2s2l2t2l2u3m2v3t2w1t2x2l2y1t2z1w3k3m3l3m3m3m3n3m3o3m3p3m3q3m3r3m3s3m203t2l203u2l3v2l3w3t3x3t3y3t3z3m4k5n4l4m4m4m4n4m4o4s4p4m4q4m4r4s4s4y4t2r4u3m4v4m4w3x4x5t4y4s4z4s5k3x5l4s5m4m5n3r5o3x5p4s5q4m5r5t5s4m5t3x5u3x5v2l5w1w5x2l5y3t5z3m6k2l6l3m6m3m6n2w6o3m6p2w6q2l6r3m6s3r6t1w6u1w6v3m6w1w6x4y6y3r6z3m7k3m7l3m7m2r7n2r7o1w7p3r7q2w7r4m7s3m7t2w7u2r7v2n7w1q7x2n7y3t202l3mcl4mal2ram3man3mao3map3mar3mas2lat4uau1uav3maw3way4uaz2lbk2sbl3t'fof'6obo2lbp3tbq3mbr1tbs2lbu1ybv3mbz3mck4m202k3mcm4mcn4mco4mcp4mcq5ycr4mcs4mct4mcu4mcv4mcw2r2m3rcy2rcz2rdl4sdm4sdn4sdo4sdp4sdq4sds4sdt4sdu4sdv4sdw4sdz3mek3mel3mem3men3meo3mep3meq4ser2wes2wet2weu2wev2wew1wex1wey1wez1wfl3rfm3mfn3mfo3mfp3mfq3mfr3tfs3mft3rfu3rfv3rfw3rfz2w203k6o212m6o2dw2l2cq2l3t3m3u2l17s3x19m3m}'kerning'{cl{4qu5kt5qt5rs17ss5ts}201s{201ss}201t{cks4lscmscnscoscpscls2wu2yu201ts}201x{2wu2yu}2k{201ts}2w{4qx5kx5ou5qx5rs17su5tu}2x{17su5tu5ou}2y{4qx5kx5ou5qx5rs17ss5ts}'fof'-6ofn{17sw5tw5ou5qw5rs}7t{cksclscmscnscoscps4ls}3u{17su5tu5os5qs}3v{17su5tu5os5qs}7p{17su5tu}ck{4qu5kt5qt5rs17ss5ts}4l{4qu5kt5qt5rs17ss5ts}cm{4qu5kt5qt5rs17ss5ts}cn{4qu5kt5qt5rs17ss5ts}co{4qu5kt5qt5rs17ss5ts}cp{4qu5kt5qt5rs17ss5ts}6l{4qu5ou5qw5rt17su5tu}5q{ckuclucmucnucoucpu4lu}5r{ckuclucmucnucoucpu4lu}7q{cksclscmscnscoscps4ls}6p{4qu5ou5qw5rt17sw5tw}ek{4qu5ou5qw5rt17su5tu}el{4qu5ou5qw5rt17su5tu}em{4qu5ou5qw5rt17su5tu}en{4qu5ou5qw5rt17su5tu}eo{4qu5ou5qw5rt17su5tu}ep{4qu5ou5qw5rt17su5tu}es{17ss5ts5qs4qu}et{4qu5ou5qw5rt17sw5tw}eu{4qu5ou5qw5rt17ss5ts}ev{17ss5ts5qs4qu}6z{17sw5tw5ou5qw5rs}fm{17sw5tw5ou5qw5rs}7n{201ts}fo{17sw5tw5ou5qw5rs}fp{17sw5tw5ou5qw5rs}fq{17sw5tw5ou5qw5rs}7r{cksclscmscnscoscps4ls}fs{17sw5tw5ou5qw5rs}ft{17su5tu}fu{17su5tu}fv{17su5tu}fw{17su5tu}fz{cksclscmscnscoscps4ls}}}"),"Helvetica-Bold":c("{'widths'{k3s2q4scx1w201n3r201o6o201s1w201t1w201u1w201w3m201x3m201y3m2k1w2l2l202m2n2n3r2o3r2p5t202q6o2r1s2s2l2t2l2u2r2v3u2w1w2x2l2y1w2z1w3k3r3l3r3m3r3n3r3o3r3p3r3q3r3r3r3s3r203t2l203u2l3v2l3w3u3x3u3y3u3z3x4k6l4l4s4m4s4n4s4o4s4p4m4q3x4r4y4s4s4t1w4u3r4v4s4w3x4x5n4y4s4z4y5k4m5l4y5m4s5n4m5o3x5p4s5q4m5r5y5s4m5t4m5u3x5v2l5w1w5x2l5y3u5z3r6k2l6l3r6m3x6n3r6o3x6p3r6q2l6r3x6s3x6t1w6u1w6v3r6w1w6x5t6y3x6z3x7k3x7l3x7m2r7n3r7o2l7p3x7q3r7r4y7s3r7t3r7u3m7v2r7w1w7x2r7y3u202l3rcl4sal2lam3ran3rao3rap3rar3ras2lat4tau2pav3raw3uay4taz2lbk2sbl3u'fof'6obo2lbp3xbq3rbr1wbs2lbu2obv3rbz3xck4s202k3rcm4scn4sco4scp4scq6ocr4scs4mct4mcu4mcv4mcw1w2m2zcy1wcz1wdl4sdm4ydn4ydo4ydp4ydq4yds4ydt4sdu4sdv4sdw4sdz3xek3rel3rem3ren3reo3rep3req5ter3res3ret3reu3rev3rew1wex1wey1wez1wfl3xfm3xfn3xfo3xfp3xfq3xfr3ufs3xft3xfu3xfv3xfw3xfz3r203k6o212m6o2dw2l2cq2l3t3r3u2l17s4m19m3r}'kerning'{cl{4qs5ku5ot5qs17sv5tv}201t{2ww4wy2yw}201w{2ks}201x{2ww4wy2yw}2k{201ts201xs}2w{7qs4qu5kw5os5qw5rs17su5tu7tsfzs}2x{5ow5qs}2y{7qs4qu5kw5os5qw5rs17su5tu7tsfzs}'fof'-6o7p{17su5tu5ot}ck{4qs5ku5ot5qs17sv5tv}4l{4qs5ku5ot5qs17sv5tv}cm{4qs5ku5ot5qs17sv5tv}cn{4qs5ku5ot5qs17sv5tv}co{4qs5ku5ot5qs17sv5tv}cp{4qs5ku5ot5qs17sv5tv}6l{17st5tt5os}17s{2kwclvcmvcnvcovcpv4lv4wwckv}5o{2kucltcmtcntcotcpt4lt4wtckt}5q{2ksclscmscnscoscps4ls4wvcks}5r{2ks4ws}5t{2kwclvcmvcnvcovcpv4lv4wwckv}eo{17st5tt5os}fu{17su5tu5ot}6p{17ss5ts}ek{17st5tt5os}el{17st5tt5os}em{17st5tt5os}en{17st5tt5os}6o{201ts}ep{17st5tt5os}es{17ss5ts}et{17ss5ts}eu{17ss5ts}ev{17ss5ts}6z{17su5tu5os5qt}fm{17su5tu5os5qt}fn{17su5tu5os5qt}fo{17su5tu5os5qt}fp{17su5tu5os5qt}fq{17su5tu5os5qt}fs{17su5tu5os5qt}ft{17su5tu5ot}7m{5os}fv{17su5tu5ot}fw{17su5tu5ot}}}"),Courier:c("{'widths'{k3w'fof'6o}'kerning'{'fof'-6o}}"),"Courier-BoldOblique":c("{'widths'{k3w'fof'6o}'kerning'{'fof'-6o}}"),"Times-Bold":c("{'widths'{k3q2q5ncx2r201n3m201o6o201s2l201t2l201u2l201w3m201x3m201y3m2k1t2l2l202m2n2n3m2o3m2p6o202q6o2r1w2s2l2t2l2u3m2v3t2w1t2x2l2y1t2z1w3k3m3l3m3m3m3n3m3o3m3p3m3q3m3r3m3s3m203t2l203u2l3v2l3w3t3x3t3y3t3z3m4k5x4l4s4m4m4n4s4o4s4p4m4q3x4r4y4s4y4t2r4u3m4v4y4w4m4x5y4y4s4z4y5k3x5l4y5m4s5n3r5o4m5p4s5q4s5r6o5s4s5t4s5u4m5v2l5w1w5x2l5y3u5z3m6k2l6l3m6m3r6n2w6o3r6p2w6q2l6r3m6s3r6t1w6u2l6v3r6w1w6x5n6y3r6z3m7k3r7l3r7m2w7n2r7o2l7p3r7q3m7r4s7s3m7t3m7u2w7v2r7w1q7x2r7y3o202l3mcl4sal2lam3man3mao3map3mar3mas2lat4uau1yav3maw3tay4uaz2lbk2sbl3t'fof'6obo2lbp3rbr1tbs2lbu2lbv3mbz3mck4s202k3mcm4scn4sco4scp4scq6ocr4scs4mct4mcu4mcv4mcw2r2m3rcy2rcz2rdl4sdm4ydn4ydo4ydp4ydq4yds4ydt4sdu4sdv4sdw4sdz3rek3mel3mem3men3meo3mep3meq4ser2wes2wet2weu2wev2wew1wex1wey1wez1wfl3rfm3mfn3mfo3mfp3mfq3mfr3tfs3mft3rfu3rfv3rfw3rfz3m203k6o212m6o2dw2l2cq2l3t3m3u2l17s4s19m3m}'kerning'{cl{4qt5ks5ot5qy5rw17sv5tv}201t{cks4lscmscnscoscpscls4wv}2k{201ts}2w{4qu5ku7mu5os5qx5ru17su5tu}2x{17su5tu5ou5qs}2y{4qv5kv7mu5ot5qz5ru17su5tu}'fof'-6o7t{cksclscmscnscoscps4ls}3u{17su5tu5os5qu}3v{17su5tu5os5qu}fu{17su5tu5ou5qu}7p{17su5tu5ou5qu}ck{4qt5ks5ot5qy5rw17sv5tv}4l{4qt5ks5ot5qy5rw17sv5tv}cm{4qt5ks5ot5qy5rw17sv5tv}cn{4qt5ks5ot5qy5rw17sv5tv}co{4qt5ks5ot5qy5rw17sv5tv}cp{4qt5ks5ot5qy5rw17sv5tv}6l{17st5tt5ou5qu}17s{ckuclucmucnucoucpu4lu4wu}5o{ckuclucmucnucoucpu4lu4wu}5q{ckzclzcmzcnzcozcpz4lz4wu}5r{ckxclxcmxcnxcoxcpx4lx4wu}5t{ckuclucmucnucoucpu4lu4wu}7q{ckuclucmucnucoucpu4lu}6p{17sw5tw5ou5qu}ek{17st5tt5qu}el{17st5tt5ou5qu}em{17st5tt5qu}en{17st5tt5qu}eo{17st5tt5qu}ep{17st5tt5ou5qu}es{17ss5ts5qu}et{17sw5tw5ou5qu}eu{17sw5tw5ou5qu}ev{17ss5ts5qu}6z{17sw5tw5ou5qu5rs}fm{17sw5tw5ou5qu5rs}fn{17sw5tw5ou5qu5rs}fo{17sw5tw5ou5qu5rs}fp{17sw5tw5ou5qu5rs}fq{17sw5tw5ou5qu5rs}7r{cktcltcmtcntcotcpt4lt5os}fs{17sw5tw5ou5qu5rs}ft{17su5tu5ou5qu}7m{5os}fv{17su5tu5ou5qu}fw{17su5tu5ou5qu}fz{cksclscmscnscoscps4ls}}}"),Symbol:c("{'widths'{k3uaw4r19m3m2k1t2l2l202m2y2n3m2p5n202q6o3k3m2s2l2t2l2v3r2w1t3m3m2y1t2z1wbk2sbl3r'fof'6o3n3m3o3m3p3m3q3m3r3m3s3m3t3m3u1w3v1w3w3r3x3r3y3r3z2wbp3t3l3m5v2l5x2l5z3m2q4yfr3r7v3k7w1o7x3k}'kerning'{'fof'-6o}}"),Helvetica:c("{'widths'{k3p2q4mcx1w201n3r201o6o201s1q201t1q201u1q201w2l201x2l201y2l2k1w2l1w202m2n2n3r2o3r2p5t202q6o2r1n2s2l2t2l2u2r2v3u2w1w2x2l2y1w2z1w3k3r3l3r3m3r3n3r3o3r3p3r3q3r3r3r3s3r203t2l203u2l3v1w3w3u3x3u3y3u3z3r4k6p4l4m4m4m4n4s4o4s4p4m4q3x4r4y4s4s4t1w4u3m4v4m4w3r4x5n4y4s4z4y5k4m5l4y5m4s5n4m5o3x5p4s5q4m5r5y5s4m5t4m5u3x5v1w5w1w5x1w5y2z5z3r6k2l6l3r6m3r6n3m6o3r6p3r6q1w6r3r6s3r6t1q6u1q6v3m6w1q6x5n6y3r6z3r7k3r7l3r7m2l7n3m7o1w7p3r7q3m7r4s7s3m7t3m7u3m7v2l7w1u7x2l7y3u202l3rcl4mal2lam3ran3rao3rap3rar3ras2lat4tau2pav3raw3uay4taz2lbk2sbl3u'fof'6obo2lbp3rbr1wbs2lbu2obv3rbz3xck4m202k3rcm4mcn4mco4mcp4mcq6ocr4scs4mct4mcu4mcv4mcw1w2m2ncy1wcz1wdl4sdm4ydn4ydo4ydp4ydq4yds4ydt4sdu4sdv4sdw4sdz3xek3rel3rem3ren3reo3rep3req5ter3mes3ret3reu3rev3rew1wex1wey1wez1wfl3rfm3rfn3rfo3rfp3rfq3rfr3ufs3xft3rfu3rfv3rfw3rfz3m203k6o212m6o2dw2l2cq2l3t3r3u1w17s4m19m3r}'kerning'{5q{4wv}cl{4qs5kw5ow5qs17sv5tv}201t{2wu4w1k2yu}201x{2wu4wy2yu}17s{2ktclucmucnu4otcpu4lu4wycoucku}2w{7qs4qz5k1m17sy5ow5qx5rsfsu5ty7tufzu}2x{17sy5ty5oy5qs}2y{7qs4qz5k1m17sy5ow5qx5rsfsu5ty7tufzu}'fof'-6o7p{17sv5tv5ow}ck{4qs5kw5ow5qs17sv5tv}4l{4qs5kw5ow5qs17sv5tv}cm{4qs5kw5ow5qs17sv5tv}cn{4qs5kw5ow5qs17sv5tv}co{4qs5kw5ow5qs17sv5tv}cp{4qs5kw5ow5qs17sv5tv}6l{17sy5ty5ow}do{17st5tt}4z{17st5tt}7s{fst}dm{17st5tt}dn{17st5tt}5o{ckwclwcmwcnwcowcpw4lw4wv}dp{17st5tt}dq{17st5tt}7t{5ow}ds{17st5tt}5t{2ktclucmucnu4otcpu4lu4wycoucku}fu{17sv5tv5ow}6p{17sy5ty5ow5qs}ek{17sy5ty5ow}el{17sy5ty5ow}em{17sy5ty5ow}en{5ty}eo{17sy5ty5ow}ep{17sy5ty5ow}es{17sy5ty5qs}et{17sy5ty5ow5qs}eu{17sy5ty5ow5qs}ev{17sy5ty5ow5qs}6z{17sy5ty5ow5qs}fm{17sy5ty5ow5qs}fn{17sy5ty5ow5qs}fo{17sy5ty5ow5qs}fp{17sy5ty5qs}fq{17sy5ty5ow5qs}7r{5ow}fs{17sy5ty5ow5qs}ft{17sv5tv5ow}7m{5ow}fv{17sv5tv5ow}fw{17sv5tv5ow}}}"),"Helvetica-BoldOblique":c("{'widths'{k3s2q4scx1w201n3r201o6o201s1w201t1w201u1w201w3m201x3m201y3m2k1w2l2l202m2n2n3r2o3r2p5t202q6o2r1s2s2l2t2l2u2r2v3u2w1w2x2l2y1w2z1w3k3r3l3r3m3r3n3r3o3r3p3r3q3r3r3r3s3r203t2l203u2l3v2l3w3u3x3u3y3u3z3x4k6l4l4s4m4s4n4s4o4s4p4m4q3x4r4y4s4s4t1w4u3r4v4s4w3x4x5n4y4s4z4y5k4m5l4y5m4s5n4m5o3x5p4s5q4m5r5y5s4m5t4m5u3x5v2l5w1w5x2l5y3u5z3r6k2l6l3r6m3x6n3r6o3x6p3r6q2l6r3x6s3x6t1w6u1w6v3r6w1w6x5t6y3x6z3x7k3x7l3x7m2r7n3r7o2l7p3x7q3r7r4y7s3r7t3r7u3m7v2r7w1w7x2r7y3u202l3rcl4sal2lam3ran3rao3rap3rar3ras2lat4tau2pav3raw3uay4taz2lbk2sbl3u'fof'6obo2lbp3xbq3rbr1wbs2lbu2obv3rbz3xck4s202k3rcm4scn4sco4scp4scq6ocr4scs4mct4mcu4mcv4mcw1w2m2zcy1wcz1wdl4sdm4ydn4ydo4ydp4ydq4yds4ydt4sdu4sdv4sdw4sdz3xek3rel3rem3ren3reo3rep3req5ter3res3ret3reu3rev3rew1wex1wey1wez1wfl3xfm3xfn3xfo3xfp3xfq3xfr3ufs3xft3xfu3xfv3xfw3xfz3r203k6o212m6o2dw2l2cq2l3t3r3u2l17s4m19m3r}'kerning'{cl{4qs5ku5ot5qs17sv5tv}201t{2ww4wy2yw}201w{2ks}201x{2ww4wy2yw}2k{201ts201xs}2w{7qs4qu5kw5os5qw5rs17su5tu7tsfzs}2x{5ow5qs}2y{7qs4qu5kw5os5qw5rs17su5tu7tsfzs}'fof'-6o7p{17su5tu5ot}ck{4qs5ku5ot5qs17sv5tv}4l{4qs5ku5ot5qs17sv5tv}cm{4qs5ku5ot5qs17sv5tv}cn{4qs5ku5ot5qs17sv5tv}co{4qs5ku5ot5qs17sv5tv}cp{4qs5ku5ot5qs17sv5tv}6l{17st5tt5os}17s{2kwclvcmvcnvcovcpv4lv4wwckv}5o{2kucltcmtcntcotcpt4lt4wtckt}5q{2ksclscmscnscoscps4ls4wvcks}5r{2ks4ws}5t{2kwclvcmvcnvcovcpv4lv4wwckv}eo{17st5tt5os}fu{17su5tu5ot}6p{17ss5ts}ek{17st5tt5os}el{17st5tt5os}em{17st5tt5os}en{17st5tt5os}6o{201ts}ep{17st5tt5os}es{17ss5ts}et{17ss5ts}eu{17ss5ts}ev{17ss5ts}6z{17su5tu5os5qt}fm{17su5tu5os5qt}fn{17su5tu5os5qt}fo{17su5tu5os5qt}fp{17su5tu5os5qt}fq{17su5tu5os5qt}fs{17su5tu5os5qt}ft{17su5tu5ot}7m{5os}fv{17su5tu5ot}fw{17su5tu5ot}}}"),ZapfDingbats:c("{'widths'{k4u2k1w'fof'6o}'kerning'{'fof'-6o}}"),"Courier-Bold":c("{'widths'{k3w'fof'6o}'kerning'{'fof'-6o}}"),"Times-Italic":c("{'widths'{k3n2q4ycx2l201n3m201o5t201s2l201t2l201u2l201w3r201x3r201y3r2k1t2l2l202m2n2n3m2o3m2p5n202q5t2r1p2s2l2t2l2u3m2v4n2w1t2x2l2y1t2z1w3k3m3l3m3m3m3n3m3o3m3p3m3q3m3r3m3s3m203t2l203u2l3v2l3w4n3x4n3y4n3z3m4k5w4l3x4m3x4n4m4o4s4p3x4q3x4r4s4s4s4t2l4u2w4v4m4w3r4x5n4y4m4z4s5k3x5l4s5m3x5n3m5o3r5p4s5q3x5r5n5s3x5t3r5u3r5v2r5w1w5x2r5y2u5z3m6k2l6l3m6m3m6n2w6o3m6p2w6q1w6r3m6s3m6t1w6u1w6v2w6w1w6x4s6y3m6z3m7k3m7l3m7m2r7n2r7o1w7p3m7q2w7r4m7s2w7t2w7u2r7v2s7w1v7x2s7y3q202l3mcl3xal2ram3man3mao3map3mar3mas2lat4wau1vav3maw4nay4waz2lbk2sbl4n'fof'6obo2lbp3mbq3obr1tbs2lbu1zbv3mbz3mck3x202k3mcm3xcn3xco3xcp3xcq5tcr4mcs3xct3xcu3xcv3xcw2l2m2ucy2lcz2ldl4mdm4sdn4sdo4sdp4sdq4sds4sdt4sdu4sdv4sdw4sdz3mek3mel3mem3men3meo3mep3meq4mer2wes2wet2weu2wev2wew1wex1wey1wez1wfl3mfm3mfn3mfo3mfp3mfq3mfr4nfs3mft3mfu3mfv3mfw3mfz2w203k6o212m6m2dw2l2cq2l3t3m3u2l17s3r19m3m}'kerning'{cl{5kt4qw}201s{201sw}201t{201tw2wy2yy6q-t}201x{2wy2yy}2k{201tw}2w{7qs4qy7rs5ky7mw5os5qx5ru17su5tu}2x{17ss5ts5os}2y{7qs4qy7rs5ky7mw5os5qx5ru17su5tu}'fof'-6o6t{17ss5ts5qs}7t{5os}3v{5qs}7p{17su5tu5qs}ck{5kt4qw}4l{5kt4qw}cm{5kt4qw}cn{5kt4qw}co{5kt4qw}cp{5kt4qw}6l{4qs5ks5ou5qw5ru17su5tu}17s{2ks}5q{ckvclvcmvcnvcovcpv4lv}5r{ckuclucmucnucoucpu4lu}5t{2ks}6p{4qs5ks5ou5qw5ru17su5tu}ek{4qs5ks5ou5qw5ru17su5tu}el{4qs5ks5ou5qw5ru17su5tu}em{4qs5ks5ou5qw5ru17su5tu}en{4qs5ks5ou5qw5ru17su5tu}eo{4qs5ks5ou5qw5ru17su5tu}ep{4qs5ks5ou5qw5ru17su5tu}es{5ks5qs4qs}et{4qs5ks5ou5qw5ru17su5tu}eu{4qs5ks5qw5ru17su5tu}ev{5ks5qs4qs}ex{17ss5ts5qs}6z{4qv5ks5ou5qw5ru17su5tu}fm{4qv5ks5ou5qw5ru17su5tu}fn{4qv5ks5ou5qw5ru17su5tu}fo{4qv5ks5ou5qw5ru17su5tu}fp{4qv5ks5ou5qw5ru17su5tu}fq{4qv5ks5ou5qw5ru17su5tu}7r{5os}fs{4qv5ks5ou5qw5ru17su5tu}ft{17su5tu5qs}fu{17su5tu5qs}fv{17su5tu5qs}fw{17su5tu5qs}}}"),"Times-Roman":c("{'widths'{k3n2q4ycx2l201n3m201o6o201s2l201t2l201u2l201w2w201x2w201y2w2k1t2l2l202m2n2n3m2o3m2p5n202q6o2r1m2s2l2t2l2u3m2v3s2w1t2x2l2y1t2z1w3k3m3l3m3m3m3n3m3o3m3p3m3q3m3r3m3s3m203t2l203u2l3v1w3w3s3x3s3y3s3z2w4k5w4l4s4m4m4n4m4o4s4p3x4q3r4r4s4s4s4t2l4u2r4v4s4w3x4x5t4y4s4z4s5k3r5l4s5m4m5n3r5o3x5p4s5q4s5r5y5s4s5t4s5u3x5v2l5w1w5x2l5y2z5z3m6k2l6l2w6m3m6n2w6o3m6p2w6q2l6r3m6s3m6t1w6u1w6v3m6w1w6x4y6y3m6z3m7k3m7l3m7m2l7n2r7o1w7p3m7q3m7r4s7s3m7t3m7u2w7v3k7w1o7x3k7y3q202l3mcl4sal2lam3man3mao3map3mar3mas2lat4wau1vav3maw3say4waz2lbk2sbl3s'fof'6obo2lbp3mbq2xbr1tbs2lbu1zbv3mbz2wck4s202k3mcm4scn4sco4scp4scq5tcr4mcs3xct3xcu3xcv3xcw2l2m2tcy2lcz2ldl4sdm4sdn4sdo4sdp4sdq4sds4sdt4sdu4sdv4sdw4sdz3mek2wel2wem2wen2weo2wep2weq4mer2wes2wet2weu2wev2wew1wex1wey1wez1wfl3mfm3mfn3mfo3mfp3mfq3mfr3sfs3mft3mfu3mfv3mfw3mfz3m203k6o212m6m2dw2l2cq2l3t3m3u1w17s4s19m3m}'kerning'{cl{4qs5ku17sw5ou5qy5rw201ss5tw201ws}201s{201ss}201t{ckw4lwcmwcnwcowcpwclw4wu201ts}2k{201ts}2w{4qs5kw5os5qx5ru17sx5tx}2x{17sw5tw5ou5qu}2y{4qs5kw5os5qx5ru17sx5tx}'fof'-6o7t{ckuclucmucnucoucpu4lu5os5rs}3u{17su5tu5qs}3v{17su5tu5qs}7p{17sw5tw5qs}ck{4qs5ku17sw5ou5qy5rw201ss5tw201ws}4l{4qs5ku17sw5ou5qy5rw201ss5tw201ws}cm{4qs5ku17sw5ou5qy5rw201ss5tw201ws}cn{4qs5ku17sw5ou5qy5rw201ss5tw201ws}co{4qs5ku17sw5ou5qy5rw201ss5tw201ws}cp{4qs5ku17sw5ou5qy5rw201ss5tw201ws}6l{17su5tu5os5qw5rs}17s{2ktclvcmvcnvcovcpv4lv4wuckv}5o{ckwclwcmwcnwcowcpw4lw4wu}5q{ckyclycmycnycoycpy4ly4wu5ms}5r{cktcltcmtcntcotcpt4lt4ws}5t{2ktclvcmvcnvcovcpv4lv4wuckv}7q{cksclscmscnscoscps4ls}6p{17su5tu5qw5rs}ek{5qs5rs}el{17su5tu5os5qw5rs}em{17su5tu5os5qs5rs}en{17su5qs5rs}eo{5qs5rs}ep{17su5tu5os5qw5rs}es{5qs}et{17su5tu5qw5rs}eu{17su5tu5qs5rs}ev{5qs}6z{17sv5tv5os5qx5rs}fm{5os5qt5rs}fn{17sv5tv5os5qx5rs}fo{17sv5tv5os5qx5rs}fp{5os5qt5rs}fq{5os5qt5rs}7r{ckuclucmucnucoucpu4lu5os}fs{17sv5tv5os5qx5rs}ft{17ss5ts5qs}fu{17sw5tw5qs}fv{17sw5tw5qs}fw{17ss5ts5qs}fz{ckuclucmucnucoucpu4lu5os5rs}}}"),"Helvetica-Oblique":c("{'widths'{k3p2q4mcx1w201n3r201o6o201s1q201t1q201u1q201w2l201x2l201y2l2k1w2l1w202m2n2n3r2o3r2p5t202q6o2r1n2s2l2t2l2u2r2v3u2w1w2x2l2y1w2z1w3k3r3l3r3m3r3n3r3o3r3p3r3q3r3r3r3s3r203t2l203u2l3v1w3w3u3x3u3y3u3z3r4k6p4l4m4m4m4n4s4o4s4p4m4q3x4r4y4s4s4t1w4u3m4v4m4w3r4x5n4y4s4z4y5k4m5l4y5m4s5n4m5o3x5p4s5q4m5r5y5s4m5t4m5u3x5v1w5w1w5x1w5y2z5z3r6k2l6l3r6m3r6n3m6o3r6p3r6q1w6r3r6s3r6t1q6u1q6v3m6w1q6x5n6y3r6z3r7k3r7l3r7m2l7n3m7o1w7p3r7q3m7r4s7s3m7t3m7u3m7v2l7w1u7x2l7y3u202l3rcl4mal2lam3ran3rao3rap3rar3ras2lat4tau2pav3raw3uay4taz2lbk2sbl3u'fof'6obo2lbp3rbr1wbs2lbu2obv3rbz3xck4m202k3rcm4mcn4mco4mcp4mcq6ocr4scs4mct4mcu4mcv4mcw1w2m2ncy1wcz1wdl4sdm4ydn4ydo4ydp4ydq4yds4ydt4sdu4sdv4sdw4sdz3xek3rel3rem3ren3reo3rep3req5ter3mes3ret3reu3rev3rew1wex1wey1wez1wfl3rfm3rfn3rfo3rfp3rfq3rfr3ufs3xft3rfu3rfv3rfw3rfz3m203k6o212m6o2dw2l2cq2l3t3r3u1w17s4m19m3r}'kerning'{5q{4wv}cl{4qs5kw5ow5qs17sv5tv}201t{2wu4w1k2yu}201x{2wu4wy2yu}17s{2ktclucmucnu4otcpu4lu4wycoucku}2w{7qs4qz5k1m17sy5ow5qx5rsfsu5ty7tufzu}2x{17sy5ty5oy5qs}2y{7qs4qz5k1m17sy5ow5qx5rsfsu5ty7tufzu}'fof'-6o7p{17sv5tv5ow}ck{4qs5kw5ow5qs17sv5tv}4l{4qs5kw5ow5qs17sv5tv}cm{4qs5kw5ow5qs17sv5tv}cn{4qs5kw5ow5qs17sv5tv}co{4qs5kw5ow5qs17sv5tv}cp{4qs5kw5ow5qs17sv5tv}6l{17sy5ty5ow}do{17st5tt}4z{17st5tt}7s{fst}dm{17st5tt}dn{17st5tt}5o{ckwclwcmwcnwcowcpw4lw4wv}dp{17st5tt}dq{17st5tt}7t{5ow}ds{17st5tt}5t{2ktclucmucnu4otcpu4lu4wycoucku}fu{17sv5tv5ow}6p{17sy5ty5ow5qs}ek{17sy5ty5ow}el{17sy5ty5ow}em{17sy5ty5ow}en{5ty}eo{17sy5ty5ow}ep{17sy5ty5ow}es{17sy5ty5qs}et{17sy5ty5ow5qs}eu{17sy5ty5ow5qs}ev{17sy5ty5ow5qs}6z{17sy5ty5ow5qs}fm{17sy5ty5ow5qs}fn{17sy5ty5ow5qs}fo{17sy5ty5ow5qs}fp{17sy5ty5qs}fq{17sy5ty5ow5qs}7r{5ow}fs{17sy5ty5ow5qs}ft{17sv5tv5ow}7m{5ow}fv{17sv5tv5ow}fw{17sv5tv5ow}}}")}};s.events.push(["addFont",function(f){var u=f.font,x=h.Unicode[u.postScriptName];x&&(u.metadata.Unicode={},u.metadata.Unicode.widths=x.widths,u.metadata.Unicode.kerning=x.kerning);var b=d.Unicode[u.postScriptName];b&&(u.metadata.Unicode.encoding=b,u.encoding=b.codePages[0])}])}(Dt.API),function(s){var e=function(r){for(var a=r.length,n=new Uint8Array(a),i=0;i<a;i++)n[i]=r.charCodeAt(i);return n};s.API.events.push(["addFont",function(r){var a=void 0,n=r.font,i=r.instance;if(!n.isStandardFont){if(i===void 0)throw new Error("Font does not exist in vFS, import fonts or remove declaration doc.addFont('"+n.postScriptName+"').");if(typeof(a=i.existsFileInVFS(n.postScriptName)===!1?i.loadFile(n.postScriptName):i.getFileFromVFS(n.postScriptName))!="string")throw new Error("Font is not stored as string-data in vFS, import fonts or remove declaration doc.addFont('"+n.postScriptName+"').");(function(o,l){l=/^\x00\x01\x00\x00/.test(l)?e(l):e(su(l)),o.metadata=s.API.TTFFont.open(l),o.metadata.Unicode=o.metadata.Unicode||{encoding:{},kerning:{},widths:[]},o.metadata.glyIdsUsed=[0]})(n,a)}}])}(Dt),Dt.API.addSvgAsImage=function(s,e,r,a,n,i,o,l){if(isNaN(e)||isNaN(r))throw Gs.error("jsPDF.addSvgAsImage: Invalid coordinates",arguments),new Error("Invalid coordinates passed to jsPDF.addSvgAsImage");if(isNaN(a)||isNaN(n))throw Gs.error("jsPDF.addSvgAsImage: Invalid measurements",arguments),new Error("Invalid measurements (width and/or height) passed to jsPDF.addSvgAsImage");var c=document.createElement("canvas");c.width=a,c.height=n;var A=c.getContext("2d");A.fillStyle="#fff",A.fillRect(0,0,c.width,c.height);var d={ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0},h=this;return(Wt.canvg?Promise.resolve(Wt.canvg):ns(()=>import("./chunks/index.es.NdbSEVaA.js"),__vite__mapDeps([22,2,7,1,4,8,3,5,6,9,10,11,12,13,14,15,16]))).catch(function(f){return Promise.reject(new Error("Could not load canvg: "+f))}).then(function(f){return f.default?f.default:f}).then(function(f){return f.fromString(A,s,d)},function(){return Promise.reject(new Error("Could not load canvg."))}).then(function(f){return f.render(d)}).then(function(){h.addImage(c.toDataURL("image/jpeg",1),e,r,a,n,o,l)})},Dt.API.putTotalPages=function(s){var e,r=0;parseInt(this.internal.getFont().id.substr(1),10)<15?(e=new RegExp(s,"g"),r=this.internal.getNumberOfPages()):(e=new RegExp(this.pdfEscape16(s,this.internal.getFont()),"g"),r=this.pdfEscape16(this.internal.getNumberOfPages()+"",this.internal.getFont()));for(var a=1;a<=this.internal.getNumberOfPages();a++)for(var n=0;n<this.internal.pages[a].length;n++)this.internal.pages[a][n]=this.internal.pages[a][n].replace(e,r);return this},Dt.API.viewerPreferences=function(s,e){var r;s=s||{},e=e||!1;var a,n,i,o={HideToolbar:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.3},HideMenubar:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.3},HideWindowUI:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.3},FitWindow:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.3},CenterWindow:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.3},DisplayDocTitle:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.4},NonFullScreenPageMode:{defaultValue:"UseNone",value:"UseNone",type:"name",explicitSet:!1,valueSet:["UseNone","UseOutlines","UseThumbs","UseOC"],pdfVersion:1.3},Direction:{defaultValue:"L2R",value:"L2R",type:"name",explicitSet:!1,valueSet:["L2R","R2L"],pdfVersion:1.3},ViewArea:{defaultValue:"CropBox",value:"CropBox",type:"name",explicitSet:!1,valueSet:["MediaBox","CropBox","TrimBox","BleedBox","ArtBox"],pdfVersion:1.4},ViewClip:{defaultValue:"CropBox",value:"CropBox",type:"name",explicitSet:!1,valueSet:["MediaBox","CropBox","TrimBox","BleedBox","ArtBox"],pdfVersion:1.4},PrintArea:{defaultValue:"CropBox",value:"CropBox",type:"name",explicitSet:!1,valueSet:["MediaBox","CropBox","TrimBox","BleedBox","ArtBox"],pdfVersion:1.4},PrintClip:{defaultValue:"CropBox",value:"CropBox",type:"name",explicitSet:!1,valueSet:["MediaBox","CropBox","TrimBox","BleedBox","ArtBox"],pdfVersion:1.4},PrintScaling:{defaultValue:"AppDefault",value:"AppDefault",type:"name",explicitSet:!1,valueSet:["AppDefault","None"],pdfVersion:1.6},Duplex:{defaultValue:"",value:"none",type:"name",explicitSet:!1,valueSet:["Simplex","DuplexFlipShortEdge","DuplexFlipLongEdge","none"],pdfVersion:1.7},PickTrayByPDFSize:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.7},PrintPageRange:{defaultValue:"",value:"",type:"array",explicitSet:!1,valueSet:null,pdfVersion:1.7},NumCopies:{defaultValue:1,value:1,type:"integer",explicitSet:!1,valueSet:null,pdfVersion:1.7}},l=Object.keys(o),c=[],A=0,d=0,h=0;function f(x,b){var N,v=!1;for(N=0;N<x.length;N+=1)x[N]===b&&(v=!0);return v}if(this.internal.viewerpreferences===void 0&&(this.internal.viewerpreferences={},this.internal.viewerpreferences.configuration=JSON.parse(JSON.stringify(o)),this.internal.viewerpreferences.isSubscribed=!1),r=this.internal.viewerpreferences.configuration,s==="reset"||e===!0){var u=l.length;for(h=0;h<u;h+=1)r[l[h]].value=r[l[h]].defaultValue,r[l[h]].explicitSet=!1}if(Rs(s)==="object"){for(n in s)if(i=s[n],f(l,n)&&i!==void 0){if(r[n].type==="boolean"&&typeof i=="boolean")r[n].value=i;else if(r[n].type==="name"&&f(r[n].valueSet,i))r[n].value=i;else if(r[n].type==="integer"&&Number.isInteger(i))r[n].value=i;else if(r[n].type==="array"){for(A=0;A<i.length;A+=1)if(a=!0,i[A].length===1&&typeof i[A][0]=="number")c.push(String(i[A]-1));else if(i[A].length>1){for(d=0;d<i[A].length;d+=1)typeof i[A][d]!="number"&&(a=!1);a===!0&&c.push([i[A][0]-1,i[A][1]-1].join(" "))}r[n].value="["+c.join(" ")+"]"}else r[n].value=r[n].defaultValue;r[n].explicitSet=!0}}return this.internal.viewerpreferences.isSubscribed===!1&&(this.internal.events.subscribe("putCatalog",function(){var x,b=[];for(x in r)r[x].explicitSet===!0&&(r[x].type==="name"?b.push("/"+x+" /"+r[x].value):b.push("/"+x+" "+r[x].value));b.length!==0&&this.internal.write(`/ViewerPreferences
<<
`+b.join(`
`)+`
>>`)}),this.internal.viewerpreferences.isSubscribed=!0),this.internal.viewerpreferences.configuration=r,this},function(s){var e=function(){var a='<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"><rdf:Description rdf:about="" xmlns:jspdf="'+this.internal.__metadata__.namespaceuri+'"><jspdf:metadata>',n=unescape(encodeURIComponent('<x:xmpmeta xmlns:x="adobe:ns:meta/">')),i=unescape(encodeURIComponent(a)),o=unescape(encodeURIComponent(this.internal.__metadata__.metadata)),l=unescape(encodeURIComponent("</jspdf:metadata></rdf:Description></rdf:RDF>")),c=unescape(encodeURIComponent("</x:xmpmeta>")),A=i.length+o.length+l.length+n.length+c.length;this.internal.__metadata__.metadata_object_number=this.internal.newObject(),this.internal.write("<< /Type /Metadata /Subtype /XML /Length "+A+" >>"),this.internal.write("stream"),this.internal.write(n+i+o+l+c),this.internal.write("endstream"),this.internal.write("endobj")},r=function(){this.internal.__metadata__.metadata_object_number&&this.internal.write("/Metadata "+this.internal.__metadata__.metadata_object_number+" 0 R")};s.addMetadata=function(a,n){return this.internal.__metadata__===void 0&&(this.internal.__metadata__={metadata:a,namespaceuri:n||"http://jspdf.default.namespaceuri/"},this.internal.events.subscribe("putCatalog",r),this.internal.events.subscribe("postPutResources",e)),this}}(Dt.API),function(s){var e=s.API,r=e.pdfEscape16=function(i,o){for(var l,c=o.metadata.Unicode.widths,A=["","0","00","000","0000"],d=[""],h=0,f=i.length;h<f;++h){if(l=o.metadata.characterToGlyph(i.charCodeAt(h)),o.metadata.glyIdsUsed.push(l),o.metadata.toUnicode[l]=i.charCodeAt(h),c.indexOf(l)==-1&&(c.push(l),c.push([parseInt(o.metadata.widthOfGlyph(l),10)])),l=="0")return d.join("");l=l.toString(16),d.push(A[4-l.length],l)}return d.join("")},a=function(i){var o,l,c,A,d,h,f;for(d=`/CIDInit /ProcSet findresource begin
12 dict begin
begincmap
/CIDSystemInfo <<
  /Registry (Adobe)
  /Ordering (UCS)
  /Supplement 0
>> def
/CMapName /Adobe-Identity-UCS def
/CMapType 2 def
1 begincodespacerange
<0000><ffff>
endcodespacerange`,c=[],h=0,f=(l=Object.keys(i).sort(function(u,x){return u-x})).length;h<f;h++)o=l[h],c.length>=100&&(d+=`
`+c.length+` beginbfchar
`+c.join(`
`)+`
endbfchar`,c=[]),i[o]!==void 0&&i[o]!==null&&typeof i[o].toString=="function"&&(A=("0000"+i[o].toString(16)).slice(-4),o=("0000"+(+o).toString(16)).slice(-4),c.push("<"+o+"><"+A+">"));return c.length&&(d+=`
`+c.length+` beginbfchar
`+c.join(`
`)+`
endbfchar
`),d+`endcmap
CMapName currentdict /CMap defineresource pop
end
end`};e.events.push(["putFont",function(i){(function(o){var l=o.font,c=o.out,A=o.newObject,d=o.putStream;if(l.metadata instanceof s.API.TTFFont&&l.encoding==="Identity-H"){for(var h=l.metadata.Unicode.widths,f=l.metadata.subset.encode(l.metadata.glyIdsUsed,1),u="",x=0;x<f.length;x++)u+=String.fromCharCode(f[x]);var b=A();d({data:u,addLength1:!0,objectId:b}),c("endobj");var N=A();d({data:a(l.metadata.toUnicode),addLength1:!0,objectId:N}),c("endobj");var v=A();c("<<"),c("/Type /FontDescriptor"),c("/FontName /"+Rl(l.fontName)),c("/FontFile2 "+b+" 0 R"),c("/FontBBox "+s.API.PDFObject.convert(l.metadata.bbox)),c("/Flags "+l.metadata.flags),c("/StemV "+l.metadata.stemV),c("/ItalicAngle "+l.metadata.italicAngle),c("/Ascent "+l.metadata.ascender),c("/Descent "+l.metadata.decender),c("/CapHeight "+l.metadata.capHeight),c(">>"),c("endobj");var j=A();c("<<"),c("/Type /Font"),c("/BaseFont /"+Rl(l.fontName)),c("/FontDescriptor "+v+" 0 R"),c("/W "+s.API.PDFObject.convert(h)),c("/CIDToGIDMap /Identity"),c("/DW 1000"),c("/Subtype /CIDFontType2"),c("/CIDSystemInfo"),c("<<"),c("/Supplement 0"),c("/Registry (Adobe)"),c("/Ordering ("+l.encoding+")"),c(">>"),c(">>"),c("endobj"),l.objectNumber=A(),c("<<"),c("/Type /Font"),c("/Subtype /Type0"),c("/ToUnicode "+N+" 0 R"),c("/BaseFont /"+Rl(l.fontName)),c("/Encoding /"+l.encoding),c("/DescendantFonts ["+j+" 0 R]"),c(">>"),c("endobj"),l.isAlreadyPutted=!0}})(i)}]),e.events.push(["putFont",function(i){(function(o){var l=o.font,c=o.out,A=o.newObject,d=o.putStream;if(l.metadata instanceof s.API.TTFFont&&l.encoding==="WinAnsiEncoding"){for(var h=l.metadata.rawData,f="",u=0;u<h.length;u++)f+=String.fromCharCode(h[u]);var x=A();d({data:f,addLength1:!0,objectId:x}),c("endobj");var b=A();d({data:a(l.metadata.toUnicode),addLength1:!0,objectId:b}),c("endobj");var N=A();c("<<"),c("/Descent "+l.metadata.decender),c("/CapHeight "+l.metadata.capHeight),c("/StemV "+l.metadata.stemV),c("/Type /FontDescriptor"),c("/FontFile2 "+x+" 0 R"),c("/Flags 96"),c("/FontBBox "+s.API.PDFObject.convert(l.metadata.bbox)),c("/FontName /"+Rl(l.fontName)),c("/ItalicAngle "+l.metadata.italicAngle),c("/Ascent "+l.metadata.ascender),c(">>"),c("endobj"),l.objectNumber=A();for(var v=0;v<l.metadata.hmtx.widths.length;v++)l.metadata.hmtx.widths[v]=parseInt(l.metadata.hmtx.widths[v]*(1e3/l.metadata.head.unitsPerEm));c("<</Subtype/TrueType/Type/Font/ToUnicode "+b+" 0 R/BaseFont/"+Rl(l.fontName)+"/FontDescriptor "+N+" 0 R/Encoding/"+l.encoding+" /FirstChar 29 /LastChar 255 /Widths "+s.API.PDFObject.convert(l.metadata.hmtx.widths)+">>"),c("endobj"),l.isAlreadyPutted=!0}})(i)}]);var n=function(i){var o,l=i.text||"",c=i.x,A=i.y,d=i.options||{},h=i.mutex||{},f=h.pdfEscape,u=h.activeFontKey,x=h.fonts,b=u,N="",v=0,j="",I=x[b].encoding;if(x[b].encoding!=="Identity-H")return{text:l,x:c,y:A,options:d,mutex:h};for(j=l,b=u,Array.isArray(l)&&(j=l[0]),v=0;v<j.length;v+=1)x[b].metadata.hasOwnProperty("cmap")&&(o=x[b].metadata.cmap.unicode.codeMap[j[v].charCodeAt(0)]),o||j[v].charCodeAt(0)<256&&x[b].metadata.hasOwnProperty("Unicode")?N+=j[v]:N+="";var C="";return parseInt(b.slice(1))<14||I==="WinAnsiEncoding"?C=f(N,b).split("").map(function(E){return E.charCodeAt(0).toString(16)}).join(""):I==="Identity-H"&&(C=r(N,x[b])),h.isHex=!0,{text:C,x:c,y:A,options:d,mutex:h}};e.events.push(["postProcessText",function(i){var o=i.text||"",l=[],c={text:o,x:i.x,y:i.y,options:i.options,mutex:i.mutex};if(Array.isArray(o)){var A=0;for(A=0;A<o.length;A+=1)Array.isArray(o[A])&&o[A].length===3?l.push([n(Object.assign({},c,{text:o[A][0]})).text,o[A][1],o[A][2]]):l.push(n(Object.assign({},c,{text:o[A]})).text);i.text=l}else i.text=n(Object.assign({},c,{text:o})).text}])}(Dt),function(s){var e=function(){return this.internal.vFS===void 0&&(this.internal.vFS={}),!0};s.existsFileInVFS=function(r){return e.call(this),this.internal.vFS[r]!==void 0},s.addFileToVFS=function(r,a){return e.call(this),this.internal.vFS[r]=a,this},s.getFileFromVFS=function(r){return e.call(this),this.internal.vFS[r]!==void 0?this.internal.vFS[r]:null}}(Dt.API),function(s){s.__bidiEngine__=s.prototype.__bidiEngine__=function(a){var n,i,o,l,c,A,d,h=e,f=[[0,3,0,1,0,0,0],[0,3,0,1,2,2,0],[0,3,0,17,2,0,1],[0,3,5,5,4,1,0],[0,3,21,21,4,0,1],[0,3,5,5,4,2,0]],u=[[2,0,1,1,0,1,0],[2,0,1,1,0,2,0],[2,0,2,1,3,2,0],[2,0,2,33,3,1,1]],x={L:0,R:1,EN:2,AN:3,N:4,B:5,S:6},b={0:0,5:1,6:2,7:3,32:4,251:5,254:6,255:7},N=["(",")","(","<",">","<","[","]","[","{","}","{","¬´","¬ª","¬´","‚Äπ","‚Ä∫","‚Äπ","‚ÅÖ","‚ÅÜ","‚ÅÖ","‚ÅΩ","‚Åæ","‚ÅΩ","‚Çç","‚Çé","‚Çç","‚â§","‚â•","‚â§","‚å©","‚å™","‚å©","Ôπô","Ôπö","Ôπô","Ôπõ","Ôπú","Ôπõ","Ôπù","Ôπû","Ôπù","Ôπ§","Ôπ•","Ôπ§"],v=new RegExp(/^([1-4|9]|1[0-9]|2[0-9]|3[0168]|4[04589]|5[012]|7[78]|159|16[0-9]|17[0-2]|21[569]|22[03489]|250)$/),j=!1,I=0;this.__bidiEngine__={};var C=function(w){var L=w.charCodeAt(),M=L>>8,P=b[M];return P!==void 0?h[256*P+(255&L)]:M===252||M===253?"AL":v.test(M)?"L":M===8?"R":"N"},E=function(w){for(var L,M=0;M<w.length;M++){if((L=C(w.charAt(M)))==="L")return!1;if(L==="R")return!0}return!1},T=function(w,L,M,P){var K,$,O,W,ee=L[P];switch(ee){case"L":case"R":case"LRE":case"RLE":case"LRO":case"RLO":case"PDF":j=!1;break;case"N":case"AN":break;case"EN":j&&(ee="AN");break;case"AL":j=!0,ee="R";break;case"WS":case"BN":ee="N";break;case"CS":P<1||P+1>=L.length||(K=M[P-1])!=="EN"&&K!=="AN"||($=L[P+1])!=="EN"&&$!=="AN"?ee="N":j&&($="AN"),ee=$===K?$:"N";break;case"ES":ee=(K=P>0?M[P-1]:"B")==="EN"&&P+1<L.length&&L[P+1]==="EN"?"EN":"N";break;case"ET":if(P>0&&M[P-1]==="EN"){ee="EN";break}if(j){ee="N";break}for(O=P+1,W=L.length;O<W&&L[O]==="ET";)O++;ee=O<W&&L[O]==="EN"?"EN":"N";break;case"NSM":if(o&&!l){for(W=L.length,O=P+1;O<W&&L[O]==="NSM";)O++;if(O<W){var V=w[P],q=V>=1425&&V<=2303||V===64286;if(K=L[O],q&&(K==="R"||K==="AL")){ee="R";break}}}ee=P<1||(K=L[P-1])==="B"?"N":M[P-1];break;case"B":j=!1,n=!0,ee=I;break;case"S":i=!0,ee="N"}return ee},Q=function(w,L,M){var P=w.split("");return M&&D(P,M,{hiLevel:I}),P.reverse(),L&&L.reverse(),P.join("")},D=function(w,L,M){var P,K,$,O,W,ee=-1,V=w.length,q=0,S=[],H=I?u:f,Y=[];for(j=!1,n=!1,i=!1,K=0;K<V;K++)Y[K]=C(w[K]);for($=0;$<V;$++){if(W=q,S[$]=T(w,Y,S,$),P=240&(q=H[W][x[S[$]]]),q&=15,L[$]=O=H[q][5],P>0)if(P===16){for(K=ee;K<$;K++)L[K]=1;ee=-1}else ee=-1;if(H[q][6])ee===-1&&(ee=$);else if(ee>-1){for(K=ee;K<$;K++)L[K]=O;ee=-1}Y[$]==="B"&&(L[$]=0),M.hiLevel|=O}i&&function(te,G,X){for(var le=0;le<X;le++)if(te[le]==="S"){G[le]=I;for(var he=le-1;he>=0&&te[he]==="WS";he--)G[he]=I}}(Y,L,V)},k=function(w,L,M,P,K){if(!(K.hiLevel<w)){if(w===1&&I===1&&!n)return L.reverse(),void(M&&M.reverse());for(var $,O,W,ee,V=L.length,q=0;q<V;){if(P[q]>=w){for(W=q+1;W<V&&P[W]>=w;)W++;for(ee=q,O=W-1;ee<O;ee++,O--)$=L[ee],L[ee]=L[O],L[O]=$,M&&($=M[ee],M[ee]=M[O],M[O]=$);q=W}q++}}},R=function(w,L,M){var P=w.split(""),K={hiLevel:I};return M||(M=[]),D(P,M,K),function($,O,W){if(W.hiLevel!==0&&d)for(var ee,V=0;V<$.length;V++)O[V]===1&&(ee=N.indexOf($[V]))>=0&&($[V]=N[ee+1])}(P,M,K),k(2,P,L,M,K),k(1,P,L,M,K),P.join("")};return this.__bidiEngine__.doBidiReorder=function(w,L,M){if(function(K,$){if($)for(var O=0;O<K.length;O++)$[O]=O;l===void 0&&(l=E(K)),A===void 0&&(A=E(K))}(w,L),o||!c||A)if(o&&c&&l^A)I=l?1:0,w=Q(w,L,M);else if(!o&&c&&A)I=l?1:0,w=R(w,L,M),w=Q(w,L);else if(!o||l||c||A){if(o&&!c&&l^A)w=Q(w,L),l?(I=0,w=R(w,L,M)):(I=1,w=R(w,L,M),w=Q(w,L));else if(o&&l&&!c&&A)I=1,w=R(w,L,M),w=Q(w,L);else if(!o&&!c&&l^A){var P=d;l?(I=1,w=R(w,L,M),I=0,d=!1,w=R(w,L,M),d=P):(I=0,w=R(w,L,M),w=Q(w,L),I=1,d=!1,w=R(w,L,M),d=P,w=Q(w,L))}}else I=0,w=R(w,L,M);else I=l?1:0,w=R(w,L,M);return w},this.__bidiEngine__.setOptions=function(w){w&&(o=w.isInputVisual,c=w.isOutputVisual,l=w.isInputRtl,A=w.isOutputRtl,d=w.isSymmetricSwapping)},this.__bidiEngine__.setOptions(a),this.__bidiEngine__};var e=["BN","BN","BN","BN","BN","BN","BN","BN","BN","S","B","S","WS","B","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","B","B","B","S","WS","N","N","ET","ET","ET","N","N","N","N","N","ES","CS","ES","CS","CS","EN","EN","EN","EN","EN","EN","EN","EN","EN","EN","CS","N","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","N","BN","BN","BN","BN","BN","BN","B","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","CS","N","ET","ET","ET","ET","N","N","N","N","L","N","N","BN","N","N","ET","ET","EN","EN","N","L","N","N","N","EN","L","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","L","L","L","L","L","L","L","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","L","N","N","N","N","N","ET","N","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","R","NSM","R","NSM","NSM","R","NSM","NSM","R","NSM","N","N","N","N","N","N","N","N","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","N","N","N","N","N","R","R","R","R","R","N","N","N","N","N","N","N","N","N","N","N","AN","AN","AN","AN","AN","AN","N","N","AL","ET","ET","AL","CS","AL","N","N","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AL","AL","N","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AN","AN","AN","AN","AN","AN","AN","AN","AN","AN","ET","AN","AN","AL","AL","AL","NSM","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AN","N","NSM","NSM","NSM","NSM","NSM","NSM","AL","AL","NSM","NSM","N","NSM","NSM","NSM","NSM","AL","AL","EN","EN","EN","EN","EN","EN","EN","EN","EN","EN","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","N","AL","AL","NSM","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","N","N","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AL","N","N","N","N","N","N","N","N","N","N","N","N","N","N","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","R","R","N","N","N","N","R","N","N","N","N","N","WS","WS","WS","WS","WS","WS","WS","WS","WS","WS","WS","BN","BN","BN","L","R","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","WS","B","LRE","RLE","PDF","LRO","RLO","CS","ET","ET","ET","ET","ET","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","CS","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","WS","BN","BN","BN","BN","BN","N","LRI","RLI","FSI","PDI","BN","BN","BN","BN","BN","BN","EN","L","N","N","EN","EN","EN","EN","EN","EN","ES","ES","N","N","N","L","EN","EN","EN","EN","EN","EN","EN","EN","EN","EN","ES","ES","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","L","L","L","L","L","L","L","N","N","N","N","N","N","N","N","N","N","N","N","L","L","L","L","L","N","N","N","N","N","R","NSM","R","R","R","R","R","R","R","R","R","R","ES","R","R","R","R","R","R","R","R","R","R","R","R","R","N","R","R","R","R","R","N","R","N","R","R","N","R","R","N","R","R","R","R","R","R","R","R","R","R","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","CS","N","CS","N","N","CS","N","N","N","N","N","N","N","N","N","ET","N","N","ES","ES","N","N","N","N","N","ET","ET","N","N","N","N","N","AL","AL","AL","AL","AL","N","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","N","N","BN","N","N","N","ET","ET","ET","N","N","N","N","N","ES","CS","ES","CS","CS","EN","EN","EN","EN","EN","EN","EN","EN","EN","EN","CS","N","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","N","N","N","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","L","L","L","L","L","L","N","N","L","L","L","L","L","L","N","N","L","L","L","L","L","L","N","N","L","L","L","N","N","N","ET","ET","N","N","N","ET","ET","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N"],r=new s.__bidiEngine__({isInputVisual:!0});s.API.events.push(["postProcessText",function(a){var n=a.text;a.x,a.y;var i=a.options||{};a.mutex,i.lang;var o=[];if(i.isInputVisual=typeof i.isInputVisual!="boolean"||i.isInputVisual,r.setOptions(i),Object.prototype.toString.call(n)==="[object Array]"){var l=0;for(o=[],l=0;l<n.length;l+=1)Object.prototype.toString.call(n[l])==="[object Array]"?o.push([r.doBidiReorder(n[l][0]),n[l][1],n[l][2]]):o.push([r.doBidiReorder(n[l])]);a.text=o}else a.text=r.doBidiReorder(n);r.setOptions({isInputVisual:!0})}])}(Dt),Dt.API.TTFFont=function(){function s(e){var r;if(this.rawData=e,r=this.contents=new Lo(e),this.contents.pos=4,r.readString(4)==="ttcf")throw new Error("TTCF not supported.");r.pos=0,this.parse(),this.subset=new nL(this),this.registerTTF()}return s.open=function(e){return new s(e)},s.prototype.parse=function(){return this.directory=new KU(this.contents),this.head=new zU(this),this.name=new XU(this),this.cmap=new c1(this),this.toUnicode={},this.hhea=new WU(this),this.maxp=new ZU(this),this.hmtx=new eL(this),this.post=new JU(this),this.os2=new qU(this),this.loca=new aL(this),this.glyf=new tL(this),this.ascender=this.os2.exists&&this.os2.ascender||this.hhea.ascender,this.decender=this.os2.exists&&this.os2.decender||this.hhea.decender,this.lineGap=this.os2.exists&&this.os2.lineGap||this.hhea.lineGap,this.bbox=[this.head.xMin,this.head.yMin,this.head.xMax,this.head.yMax]},s.prototype.registerTTF=function(){var e,r,a,n,i;if(this.scaleFactor=1e3/this.head.unitsPerEm,this.bbox=function(){var o,l,c,A;for(A=[],o=0,l=(c=this.bbox).length;o<l;o++)e=c[o],A.push(Math.round(e*this.scaleFactor));return A}.call(this),this.stemV=0,this.post.exists?(a=255&(n=this.post.italic_angle),32768&(r=n>>16)&&(r=-(1+(65535^r))),this.italicAngle=+(r+"."+a)):this.italicAngle=0,this.ascender=Math.round(this.ascender*this.scaleFactor),this.decender=Math.round(this.decender*this.scaleFactor),this.lineGap=Math.round(this.lineGap*this.scaleFactor),this.capHeight=this.os2.exists&&this.os2.capHeight||this.ascender,this.xHeight=this.os2.exists&&this.os2.xHeight||0,this.familyClass=(this.os2.exists&&this.os2.familyClass||0)>>8,this.isSerif=(i=this.familyClass)===1||i===2||i===3||i===4||i===5||i===7,this.isScript=this.familyClass===10,this.flags=0,this.post.isFixedPitch&&(this.flags|=1),this.isSerif&&(this.flags|=2),this.isScript&&(this.flags|=8),this.italicAngle!==0&&(this.flags|=64),this.flags|=32,!this.cmap.unicode)throw new Error("No unicode cmap for font")},s.prototype.characterToGlyph=function(e){var r;return((r=this.cmap.unicode)!=null?r.codeMap[e]:void 0)||0},s.prototype.widthOfGlyph=function(e){var r;return r=1e3/this.head.unitsPerEm,this.hmtx.forGlyph(e).advance*r},s.prototype.widthOfString=function(e,r,a){var n,i,o,l;for(o=0,i=0,l=(e=""+e).length;0<=l?i<l:i>l;i=0<=l?++i:--i)n=e.charCodeAt(i),o+=this.widthOfGlyph(this.characterToGlyph(n))+a*(1e3/r)||0;return o*(r/1e3)},s.prototype.lineHeight=function(e,r){var a;return r==null&&(r=!1),a=r?this.lineGap:0,(this.ascender+a-this.decender)/1e3*e},s}();var ii,Lo=function(){function s(e){this.data=e??[],this.pos=0,this.length=this.data.length}return s.prototype.readByte=function(){return this.data[this.pos++]},s.prototype.writeByte=function(e){return this.data[this.pos++]=e},s.prototype.readUInt32=function(){return 16777216*this.readByte()+(this.readByte()<<16)+(this.readByte()<<8)+this.readByte()},s.prototype.writeUInt32=function(e){return this.writeByte(e>>>24&255),this.writeByte(e>>16&255),this.writeByte(e>>8&255),this.writeByte(255&e)},s.prototype.readInt32=function(){var e;return(e=this.readUInt32())>=2147483648?e-4294967296:e},s.prototype.writeInt32=function(e){return e<0&&(e+=4294967296),this.writeUInt32(e)},s.prototype.readUInt16=function(){return this.readByte()<<8|this.readByte()},s.prototype.writeUInt16=function(e){return this.writeByte(e>>8&255),this.writeByte(255&e)},s.prototype.readInt16=function(){var e;return(e=this.readUInt16())>=32768?e-65536:e},s.prototype.writeInt16=function(e){return e<0&&(e+=65536),this.writeUInt16(e)},s.prototype.readString=function(e){var r,a;for(a=[],r=0;0<=e?r<e:r>e;r=0<=e?++r:--r)a[r]=String.fromCharCode(this.readByte());return a.join("")},s.prototype.writeString=function(e){var r,a,n;for(n=[],r=0,a=e.length;0<=a?r<a:r>a;r=0<=a?++r:--r)n.push(this.writeByte(e.charCodeAt(r)));return n},s.prototype.readShort=function(){return this.readInt16()},s.prototype.writeShort=function(e){return this.writeInt16(e)},s.prototype.readLongLong=function(){var e,r,a,n,i,o,l,c;return e=this.readByte(),r=this.readByte(),a=this.readByte(),n=this.readByte(),i=this.readByte(),o=this.readByte(),l=this.readByte(),c=this.readByte(),128&e?-1*(72057594037927940*(255^e)+281474976710656*(255^r)+1099511627776*(255^a)+4294967296*(255^n)+16777216*(255^i)+65536*(255^o)+256*(255^l)+(255^c)+1):72057594037927940*e+281474976710656*r+1099511627776*a+4294967296*n+16777216*i+65536*o+256*l+c},s.prototype.writeLongLong=function(e){var r,a;return r=Math.floor(e/4294967296),a=4294967295&e,this.writeByte(r>>24&255),this.writeByte(r>>16&255),this.writeByte(r>>8&255),this.writeByte(255&r),this.writeByte(a>>24&255),this.writeByte(a>>16&255),this.writeByte(a>>8&255),this.writeByte(255&a)},s.prototype.readInt=function(){return this.readInt32()},s.prototype.writeInt=function(e){return this.writeInt32(e)},s.prototype.read=function(e){var r,a;for(r=[],a=0;0<=e?a<e:a>e;a=0<=e?++a:--a)r.push(this.readByte());return r},s.prototype.write=function(e){var r,a,n,i;for(i=[],a=0,n=e.length;a<n;a++)r=e[a],i.push(this.writeByte(r));return i},s}(),KU=function(){var s;function e(r){var a,n,i;for(this.scalarType=r.readInt(),this.tableCount=r.readShort(),this.searchRange=r.readShort(),this.entrySelector=r.readShort(),this.rangeShift=r.readShort(),this.tables={},n=0,i=this.tableCount;0<=i?n<i:n>i;n=0<=i?++n:--n)a={tag:r.readString(4),checksum:r.readInt(),offset:r.readInt(),length:r.readInt()},this.tables[a.tag]=a}return e.prototype.encode=function(r){var a,n,i,o,l,c,A,d,h,f,u,x,b;for(b in u=Object.keys(r).length,c=Math.log(2),h=16*Math.floor(Math.log(u)/c),o=Math.floor(h/c),d=16*u-h,(n=new Lo).writeInt(this.scalarType),n.writeShort(u),n.writeShort(h),n.writeShort(o),n.writeShort(d),i=16*u,A=n.pos+i,l=null,x=[],r)for(f=r[b],n.writeString(b),n.writeInt(s(f)),n.writeInt(A),n.writeInt(f.length),x=x.concat(f),b==="head"&&(l=A),A+=f.length;A%4;)x.push(0),A++;return n.write(x),a=2981146554-s(n.data),n.pos=l+8,n.writeUInt32(a),n.data},s=function(r){var a,n,i,o;for(r=A1.call(r);r.length%4;)r.push(0);for(i=new Lo(r),n=0,a=0,o=r.length;a<o;a=a+=4)n+=i.readUInt32();return 4294967295&n},e}(),GU={}.hasOwnProperty,Ti=function(s,e){for(var r in e)GU.call(e,r)&&(s[r]=e[r]);function a(){this.constructor=s}return a.prototype=e.prototype,s.prototype=new a,s.__super__=e.prototype,s};ii=function(){function s(e){var r;this.file=e,r=this.file.directory.tables[this.tag],this.exists=!!r,r&&(this.offset=r.offset,this.length=r.length,this.parse(this.file.contents))}return s.prototype.parse=function(){},s.prototype.encode=function(){},s.prototype.raw=function(){return this.exists?(this.file.contents.pos=this.offset,this.file.contents.read(this.length)):null},s}();var zU=function(){function s(){return s.__super__.constructor.apply(this,arguments)}return Ti(s,ii),s.prototype.tag="head",s.prototype.parse=function(e){return e.pos=this.offset,this.version=e.readInt(),this.revision=e.readInt(),this.checkSumAdjustment=e.readInt(),this.magicNumber=e.readInt(),this.flags=e.readShort(),this.unitsPerEm=e.readShort(),this.created=e.readLongLong(),this.modified=e.readLongLong(),this.xMin=e.readShort(),this.yMin=e.readShort(),this.xMax=e.readShort(),this.yMax=e.readShort(),this.macStyle=e.readShort(),this.lowestRecPPEM=e.readShort(),this.fontDirectionHint=e.readShort(),this.indexToLocFormat=e.readShort(),this.glyphDataFormat=e.readShort()},s.prototype.encode=function(e){var r;return(r=new Lo).writeInt(this.version),r.writeInt(this.revision),r.writeInt(this.checkSumAdjustment),r.writeInt(this.magicNumber),r.writeShort(this.flags),r.writeShort(this.unitsPerEm),r.writeLongLong(this.created),r.writeLongLong(this.modified),r.writeShort(this.xMin),r.writeShort(this.yMin),r.writeShort(this.xMax),r.writeShort(this.yMax),r.writeShort(this.macStyle),r.writeShort(this.lowestRecPPEM),r.writeShort(this.fontDirectionHint),r.writeShort(e),r.writeShort(this.glyphDataFormat),r.data},s}(),gy=function(){function s(e,r){var a,n,i,o,l,c,A,d,h,f,u,x,b,N,v,j,I;switch(this.platformID=e.readUInt16(),this.encodingID=e.readShort(),this.offset=r+e.readInt(),h=e.pos,e.pos=this.offset,this.format=e.readUInt16(),this.length=e.readUInt16(),this.language=e.readUInt16(),this.isUnicode=this.platformID===3&&this.encodingID===1&&this.format===4||this.platformID===0&&this.format===4,this.codeMap={},this.format){case 0:for(c=0;c<256;++c)this.codeMap[c]=e.readByte();break;case 4:for(u=e.readUInt16(),f=u/2,e.pos+=6,i=function(){var C,E;for(E=[],c=C=0;0<=f?C<f:C>f;c=0<=f?++C:--C)E.push(e.readUInt16());return E}(),e.pos+=2,b=function(){var C,E;for(E=[],c=C=0;0<=f?C<f:C>f;c=0<=f?++C:--C)E.push(e.readUInt16());return E}(),A=function(){var C,E;for(E=[],c=C=0;0<=f?C<f:C>f;c=0<=f?++C:--C)E.push(e.readUInt16());return E}(),d=function(){var C,E;for(E=[],c=C=0;0<=f?C<f:C>f;c=0<=f?++C:--C)E.push(e.readUInt16());return E}(),n=(this.length-e.pos+this.offset)/2,l=function(){var C,E;for(E=[],c=C=0;0<=n?C<n:C>n;c=0<=n?++C:--C)E.push(e.readUInt16());return E}(),c=v=0,I=i.length;v<I;c=++v)for(N=i[c],a=j=x=b[c];x<=N?j<=N:j>=N;a=x<=N?++j:--j)d[c]===0?o=a+A[c]:(o=l[d[c]/2+(a-x)-(f-c)]||0)!==0&&(o+=A[c]),this.codeMap[a]=65535&o}e.pos=h}return s.encode=function(e,r){var a,n,i,o,l,c,A,d,h,f,u,x,b,N,v,j,I,C,E,T,Q,D,k,R,w,L,M,P,K,$,O,W,ee,V,q,S,H,Y,te,G,X,le,he,ve,ke,Le;switch(P=new Lo,o=Object.keys(e).sort(function(Be,Re){return Be-Re}),r){case"macroman":for(b=0,N=function(){var Be=[];for(x=0;x<256;++x)Be.push(0);return Be}(),j={0:0},i={},K=0,ee=o.length;K<ee;K++)j[he=e[n=o[K]]]==null&&(j[he]=++b),i[n]={old:e[n],new:j[e[n]]},N[n]=j[e[n]];return P.writeUInt16(1),P.writeUInt16(0),P.writeUInt32(12),P.writeUInt16(0),P.writeUInt16(262),P.writeUInt16(0),P.write(N),{charMap:i,subtable:P.data,maxGlyphID:b+1};case"unicode":for(L=[],h=[],I=0,j={},a={},v=A=null,$=0,V=o.length;$<V;$++)j[E=e[n=o[$]]]==null&&(j[E]=++I),a[n]={old:E,new:j[E]},l=j[E]-n,v!=null&&l===A||(v&&h.push(v),L.push(n),A=l),v=n;for(v&&h.push(v),h.push(65535),L.push(65535),R=2*(k=L.length),D=2*Math.pow(Math.log(k)/Math.LN2,2),f=Math.log(D/2)/Math.LN2,Q=2*k-D,c=[],T=[],u=[],x=O=0,q=L.length;O<q;x=++O){if(w=L[x],d=h[x],w===65535){c.push(0),T.push(0);break}if(w-(M=a[w].new)>=32768)for(c.push(0),T.push(2*(u.length+k-x)),n=W=w;w<=d?W<=d:W>=d;n=w<=d?++W:--W)u.push(a[n].new);else c.push(M-w),T.push(0)}for(P.writeUInt16(3),P.writeUInt16(1),P.writeUInt32(12),P.writeUInt16(4),P.writeUInt16(16+8*k+2*u.length),P.writeUInt16(0),P.writeUInt16(R),P.writeUInt16(D),P.writeUInt16(f),P.writeUInt16(Q),X=0,S=h.length;X<S;X++)n=h[X],P.writeUInt16(n);for(P.writeUInt16(0),le=0,H=L.length;le<H;le++)n=L[le],P.writeUInt16(n);for(ve=0,Y=c.length;ve<Y;ve++)l=c[ve],P.writeUInt16(l);for(ke=0,te=T.length;ke<te;ke++)C=T[ke],P.writeUInt16(C);for(Le=0,G=u.length;Le<G;Le++)b=u[Le],P.writeUInt16(b);return{charMap:a,subtable:P.data,maxGlyphID:I+1}}},s}(),c1=function(){function s(){return s.__super__.constructor.apply(this,arguments)}return Ti(s,ii),s.prototype.tag="cmap",s.prototype.parse=function(e){var r,a,n;for(e.pos=this.offset,this.version=e.readUInt16(),n=e.readUInt16(),this.tables=[],this.unicode=null,a=0;0<=n?a<n:a>n;a=0<=n?++a:--a)r=new gy(e,this.offset),this.tables.push(r),r.isUnicode&&this.unicode==null&&(this.unicode=r);return!0},s.encode=function(e,r){var a,n;return r==null&&(r="macroman"),a=gy.encode(e,r),(n=new Lo).writeUInt16(0),n.writeUInt16(1),a.table=n.data.concat(a.subtable),a},s}(),WU=function(){function s(){return s.__super__.constructor.apply(this,arguments)}return Ti(s,ii),s.prototype.tag="hhea",s.prototype.parse=function(e){return e.pos=this.offset,this.version=e.readInt(),this.ascender=e.readShort(),this.decender=e.readShort(),this.lineGap=e.readShort(),this.advanceWidthMax=e.readShort(),this.minLeftSideBearing=e.readShort(),this.minRightSideBearing=e.readShort(),this.xMaxExtent=e.readShort(),this.caretSlopeRise=e.readShort(),this.caretSlopeRun=e.readShort(),this.caretOffset=e.readShort(),e.pos+=8,this.metricDataFormat=e.readShort(),this.numberOfMetrics=e.readUInt16()},s}(),qU=function(){function s(){return s.__super__.constructor.apply(this,arguments)}return Ti(s,ii),s.prototype.tag="OS/2",s.prototype.parse=function(e){if(e.pos=this.offset,this.version=e.readUInt16(),this.averageCharWidth=e.readShort(),this.weightClass=e.readUInt16(),this.widthClass=e.readUInt16(),this.type=e.readShort(),this.ySubscriptXSize=e.readShort(),this.ySubscriptYSize=e.readShort(),this.ySubscriptXOffset=e.readShort(),this.ySubscriptYOffset=e.readShort(),this.ySuperscriptXSize=e.readShort(),this.ySuperscriptYSize=e.readShort(),this.ySuperscriptXOffset=e.readShort(),this.ySuperscriptYOffset=e.readShort(),this.yStrikeoutSize=e.readShort(),this.yStrikeoutPosition=e.readShort(),this.familyClass=e.readShort(),this.panose=function(){var r,a;for(a=[],r=0;r<10;++r)a.push(e.readByte());return a}(),this.charRange=function(){var r,a;for(a=[],r=0;r<4;++r)a.push(e.readInt());return a}(),this.vendorID=e.readString(4),this.selection=e.readShort(),this.firstCharIndex=e.readShort(),this.lastCharIndex=e.readShort(),this.version>0&&(this.ascent=e.readShort(),this.descent=e.readShort(),this.lineGap=e.readShort(),this.winAscent=e.readShort(),this.winDescent=e.readShort(),this.codePageRange=function(){var r,a;for(a=[],r=0;r<2;r=++r)a.push(e.readInt());return a}(),this.version>1))return this.xHeight=e.readShort(),this.capHeight=e.readShort(),this.defaultChar=e.readShort(),this.breakChar=e.readShort(),this.maxContext=e.readShort()},s}(),JU=function(){function s(){return s.__super__.constructor.apply(this,arguments)}return Ti(s,ii),s.prototype.tag="post",s.prototype.parse=function(e){var r,a,n;switch(e.pos=this.offset,this.format=e.readInt(),this.italicAngle=e.readInt(),this.underlinePosition=e.readShort(),this.underlineThickness=e.readShort(),this.isFixedPitch=e.readInt(),this.minMemType42=e.readInt(),this.maxMemType42=e.readInt(),this.minMemType1=e.readInt(),this.maxMemType1=e.readInt(),this.format){case 65536:case 196608:break;case 131072:var i;for(a=e.readUInt16(),this.glyphNameIndex=[],i=0;0<=a?i<a:i>a;i=0<=a?++i:--i)this.glyphNameIndex.push(e.readUInt16());for(this.names=[],n=[];e.pos<this.offset+this.length;)r=e.readByte(),n.push(this.names.push(e.readString(r)));return n;case 151552:return a=e.readUInt16(),this.offsets=e.read(a);case 262144:return this.map=function(){var o,l,c;for(c=[],i=o=0,l=this.file.maxp.numGlyphs;0<=l?o<l:o>l;i=0<=l?++o:--o)c.push(e.readUInt32());return c}.call(this)}},s}(),YU=function(s,e){this.raw=s,this.length=s.length,this.platformID=e.platformID,this.encodingID=e.encodingID,this.languageID=e.languageID},XU=function(){function s(){return s.__super__.constructor.apply(this,arguments)}return Ti(s,ii),s.prototype.tag="name",s.prototype.parse=function(e){var r,a,n,i,o,l,c,A,d,h,f;for(e.pos=this.offset,e.readShort(),r=e.readShort(),l=e.readShort(),a=[],i=0;0<=r?i<r:i>r;i=0<=r?++i:--i)a.push({platformID:e.readShort(),encodingID:e.readShort(),languageID:e.readShort(),nameID:e.readShort(),length:e.readShort(),offset:this.offset+l+e.readShort()});for(c={},i=d=0,h=a.length;d<h;i=++d)n=a[i],e.pos=n.offset,A=e.readString(n.length),o=new YU(A,n),c[f=n.nameID]==null&&(c[f]=[]),c[n.nameID].push(o);this.strings=c,this.copyright=c[0],this.fontFamily=c[1],this.fontSubfamily=c[2],this.uniqueSubfamily=c[3],this.fontName=c[4],this.version=c[5];try{this.postscriptName=c[6][0].raw.replace(/[\x00-\x19\x80-\xff]/g,"")}catch{this.postscriptName=c[4][0].raw.replace(/[\x00-\x19\x80-\xff]/g,"")}return this.trademark=c[7],this.manufacturer=c[8],this.designer=c[9],this.description=c[10],this.vendorUrl=c[11],this.designerUrl=c[12],this.license=c[13],this.licenseUrl=c[14],this.preferredFamily=c[15],this.preferredSubfamily=c[17],this.compatibleFull=c[18],this.sampleText=c[19]},s}(),ZU=function(){function s(){return s.__super__.constructor.apply(this,arguments)}return Ti(s,ii),s.prototype.tag="maxp",s.prototype.parse=function(e){return e.pos=this.offset,this.version=e.readInt(),this.numGlyphs=e.readUInt16(),this.maxPoints=e.readUInt16(),this.maxContours=e.readUInt16(),this.maxCompositePoints=e.readUInt16(),this.maxComponentContours=e.readUInt16(),this.maxZones=e.readUInt16(),this.maxTwilightPoints=e.readUInt16(),this.maxStorage=e.readUInt16(),this.maxFunctionDefs=e.readUInt16(),this.maxInstructionDefs=e.readUInt16(),this.maxStackElements=e.readUInt16(),this.maxSizeOfInstructions=e.readUInt16(),this.maxComponentElements=e.readUInt16(),this.maxComponentDepth=e.readUInt16()},s}(),eL=function(){function s(){return s.__super__.constructor.apply(this,arguments)}return Ti(s,ii),s.prototype.tag="hmtx",s.prototype.parse=function(e){var r,a,n,i,o,l,c;for(e.pos=this.offset,this.metrics=[],r=0,l=this.file.hhea.numberOfMetrics;0<=l?r<l:r>l;r=0<=l?++r:--r)this.metrics.push({advance:e.readUInt16(),lsb:e.readInt16()});for(n=this.file.maxp.numGlyphs-this.file.hhea.numberOfMetrics,this.leftSideBearings=function(){var A,d;for(d=[],r=A=0;0<=n?A<n:A>n;r=0<=n?++A:--A)d.push(e.readInt16());return d}(),this.widths=function(){var A,d,h,f;for(f=[],A=0,d=(h=this.metrics).length;A<d;A++)i=h[A],f.push(i.advance);return f}.call(this),a=this.widths[this.widths.length-1],c=[],r=o=0;0<=n?o<n:o>n;r=0<=n?++o:--o)c.push(this.widths.push(a));return c},s.prototype.forGlyph=function(e){return e in this.metrics?this.metrics[e]:{advance:this.metrics[this.metrics.length-1].advance,lsb:this.leftSideBearings[e-this.metrics.length]}},s}(),A1=[].slice,tL=function(){function s(){return s.__super__.constructor.apply(this,arguments)}return Ti(s,ii),s.prototype.tag="glyf",s.prototype.parse=function(){return this.cache={}},s.prototype.glyphFor=function(e){var r,a,n,i,o,l,c,A,d,h;return e in this.cache?this.cache[e]:(i=this.file.loca,r=this.file.contents,a=i.indexOf(e),(n=i.lengthOf(e))===0?this.cache[e]=null:(r.pos=this.offset+a,o=(l=new Lo(r.read(n))).readShort(),A=l.readShort(),h=l.readShort(),c=l.readShort(),d=l.readShort(),this.cache[e]=o===-1?new rL(l,A,h,c,d):new sL(l,o,A,h,c,d),this.cache[e]))},s.prototype.encode=function(e,r,a){var n,i,o,l,c;for(o=[],i=[],l=0,c=r.length;l<c;l++)n=e[r[l]],i.push(o.length),n&&(o=o.concat(n.encode(a)));return i.push(o.length),{table:o,offsets:i}},s}(),sL=function(){function s(e,r,a,n,i,o){this.raw=e,this.numberOfContours=r,this.xMin=a,this.yMin=n,this.xMax=i,this.yMax=o,this.compound=!1}return s.prototype.encode=function(){return this.raw.data},s}(),rL=function(){function s(e,r,a,n,i){var o,l;for(this.raw=e,this.xMin=r,this.yMin=a,this.xMax=n,this.yMax=i,this.compound=!0,this.glyphIDs=[],this.glyphOffsets=[],o=this.raw;l=o.readShort(),this.glyphOffsets.push(o.pos),this.glyphIDs.push(o.readUInt16()),32&l;)o.pos+=1&l?4:2,128&l?o.pos+=8:64&l?o.pos+=4:8&l&&(o.pos+=2)}return s.prototype.encode=function(){var e,r,a;for(r=new Lo(A1.call(this.raw.data)),e=0,a=this.glyphIDs.length;e<a;++e)r.pos=this.glyphOffsets[e];return r.data},s}(),aL=function(){function s(){return s.__super__.constructor.apply(this,arguments)}return Ti(s,ii),s.prototype.tag="loca",s.prototype.parse=function(e){var r,a;return e.pos=this.offset,r=this.file.head.indexToLocFormat,this.offsets=r===0?function(){var n,i;for(i=[],a=0,n=this.length;a<n;a+=2)i.push(2*e.readUInt16());return i}.call(this):function(){var n,i;for(i=[],a=0,n=this.length;a<n;a+=4)i.push(e.readUInt32());return i}.call(this)},s.prototype.indexOf=function(e){return this.offsets[e]},s.prototype.lengthOf=function(e){return this.offsets[e+1]-this.offsets[e]},s.prototype.encode=function(e,r){for(var a=new Uint32Array(this.offsets.length),n=0,i=0,o=0;o<a.length;++o)if(a[o]=n,i<r.length&&r[i]==o){++i,a[o]=n;var l=this.offsets[o],c=this.offsets[o+1]-l;c>0&&(n+=c)}for(var A=new Array(4*a.length),d=0;d<a.length;++d)A[4*d+3]=255&a[d],A[4*d+2]=(65280&a[d])>>8,A[4*d+1]=(16711680&a[d])>>16,A[4*d]=(4278190080&a[d])>>24;return A},s}(),nL=function(){function s(e){this.font=e,this.subset={},this.unicodes={},this.next=33}return s.prototype.generateCmap=function(){var e,r,a,n,i;for(r in n=this.font.cmap.tables[0].codeMap,e={},i=this.subset)a=i[r],e[r]=n[a];return e},s.prototype.glyphsFor=function(e){var r,a,n,i,o,l,c;for(n={},o=0,l=e.length;o<l;o++)n[i=e[o]]=this.font.glyf.glyphFor(i);for(i in r=[],n)(a=n[i])!=null&&a.compound&&r.push.apply(r,a.glyphIDs);if(r.length>0)for(i in c=this.glyphsFor(r))a=c[i],n[i]=a;return n},s.prototype.encode=function(e,r){var a,n,i,o,l,c,A,d,h,f,u,x,b,N,v;for(n in a=c1.encode(this.generateCmap(),"unicode"),o=this.glyphsFor(e),u={0:0},v=a.charMap)u[(c=v[n]).old]=c.new;for(x in f=a.maxGlyphID,o)x in u||(u[x]=f++);return d=function(j){var I,C;for(I in C={},j)C[j[I]]=I;return C}(u),h=Object.keys(d).sort(function(j,I){return j-I}),b=function(){var j,I,C;for(C=[],j=0,I=h.length;j<I;j++)l=h[j],C.push(d[l]);return C}(),i=this.font.glyf.encode(o,b,u),A=this.font.loca.encode(i.offsets,b),N={cmap:this.font.cmap.raw(),glyf:i.table,loca:A,hmtx:this.font.hmtx.raw(),hhea:this.font.hhea.raw(),maxp:this.font.maxp.raw(),post:this.font.post.raw(),name:this.font.name.raw(),head:this.font.head.encode(r)},this.font.os2.exists&&(N["OS/2"]=this.font.os2.raw()),this.font.directory.encode(N)},s}();Dt.API.PDFObject=function(){var s;function e(){}return s=function(r,a){return(Array(a+1).join("0")+r).slice(-a)},e.convert=function(r){var a,n,i,o;if(Array.isArray(r))return"["+function(){var l,c,A;for(A=[],l=0,c=r.length;l<c;l++)a=r[l],A.push(e.convert(a));return A}().join(" ")+"]";if(typeof r=="string")return"/"+r;if(r?.isString)return"("+r+")";if(r instanceof Date)return"(D:"+s(r.getUTCFullYear(),4)+s(r.getUTCMonth(),2)+s(r.getUTCDate(),2)+s(r.getUTCHours(),2)+s(r.getUTCMinutes(),2)+s(r.getUTCSeconds(),2)+"Z)";if({}.toString.call(r)==="[object Object]"){for(n in i=["<<"],r)o=r[n],i.push("/"+n+" "+e.convert(o));return i.push(">>"),i.join(`
`)}return""+r},e}();const In={pageWidth:210,pageHeight:297,margin:15,lineHeight:6,sectionGap:8,fontSize:{title:16,heading:12,subheading:10,body:9,small:8},colors:{primary:[79,70,229],secondary:[107,114,128],accent:[16,185,129],danger:[239,68,68],text:[31,41,55],lightGray:[243,244,246]}};class sc{static instance;valveSizingService=Al.getInstance();static getInstance(){return sc.instance||(sc.instance=new sc),sc.instance}async generatePDF(e){const r=new Dt({orientation:"portrait",unit:"mm",format:"a4"});let a=In.margin;return a=this.addHeader(r,e,a),a=this.addPatientInfo(r,e,a),e.ctMeasurements&&(a=this.addCTMeasurements(r,e.ctMeasurements,a)),e.ctMeasurements?.annulusArea&&e.ctMeasurements?.annulusPerimeter&&(a=this.addValveRecommendation(r,e,a)),a=this.addWorkupSections(r,e,a),e.snapshots&&e.snapshots.length>0&&(r.addPage(),this.addSnapshotsPage(r,e)),this.addFooters(r,e),r.output("blob")}async downloadPDF(e){const r=await this.generatePDF(e),a=URL.createObjectURL(r),n=document.createElement("a");n.href=a,n.download=this.generateFilename(e),document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)}generateFilename(e){const r=e.patient.replace(/[^a-zA-Z0-9]/g,"_"),a=new Date().toISOString().split("T")[0];return`TAVI_Workup_${r}_${a}.pdf`}addHeader(e,r,a){const{margin:n,pageWidth:i,colors:o,fontSize:l}=In,c=i-2*n;e.setFillColor(...o.primary),e.rect(n,a,c,12,"F"),e.setFont("helvetica","bold"),e.setFontSize(l.title),e.setTextColor(255,255,255),e.text("TAVI Workup Report",n+4,a+8);const A=r.status.toUpperCase(),d=r.status==="presented"?o.accent:r.status==="ready"?o.primary:o.secondary;return e.setFillColor(...d),e.roundedRect(i-n-25,a+2,22,8,2,2,"F"),e.setFontSize(l.small),e.text(A,i-n-14,a+7,{align:"center"}),a+18}addPatientInfo(e,r,a){const{margin:n,colors:i,fontSize:o,lineHeight:l}=In;return e.setFont("helvetica","bold"),e.setFontSize(o.heading),e.setTextColor(...i.text),e.text("Patient Information",n,a),a+=l+2,e.setFont("helvetica","bold"),e.setFontSize(o.subheading),e.text(r.patient,n,a),a+=l,e.setFont("helvetica","normal"),e.setFontSize(o.body),e.setTextColor(...i.secondary),[r.procedureDate?`Procedure: ${this.formatDate(r.procedureDate)}`:null,r.referralDate?`Referral: ${this.formatDate(r.referralDate)}`:null,r.referrer?`Referrer: ${r.referrer}`:null,r.location?`Location: ${r.location}`:null,r.category?`Category: ${r.category}`:null].filter(Boolean).forEach(A=>{e.text(A,n,a),a+=l-1}),a+In.sectionGap}addCTMeasurements(e,r,a){const{margin:n,pageWidth:i,colors:o,fontSize:l,lineHeight:c}=In,A=i-2*n;a>220&&(e.addPage(),a=In.margin),e.setFont("helvetica","bold"),e.setFontSize(l.heading),e.setTextColor(...o.text),e.text("CT Measurements",n,a),a+=c+2,e.setFillColor(...o.lightGray),e.rect(n,a-2,A,40,"F"),e.setFont("helvetica","normal"),e.setFontSize(l.body),e.setTextColor(...o.text);const d=n+3,h=n+A/2;let f=a+4;const u=r.annulusArea??r.annulusAreaMm2,x=r.annulusPerimeter??r.annulusPerimeterMm;(u||x)&&(e.setFont("helvetica","bold"),e.text("Annulus",d,f),e.setFont("helvetica","normal"),f+=c-1,u&&e.text(`Area: ${u.toFixed(0)} mm¬≤`,d,f),x&&e.text(`Perimeter: ${x.toFixed(1)} mm`,h,f),f+=c-1,r.annulusMaxDiameterMm&&r.annulusMinDiameterMm&&e.text(`Diameters: ${r.annulusMinDiameterMm.toFixed(1)} √ó ${r.annulusMaxDiameterMm.toFixed(1)} mm`,d,f),f+=c);const b=r.coronaryHeights?.leftMainMm,N=r.coronaryHeights?.rightCoronaryMm;(b||N)&&(e.setFont("helvetica","bold"),e.text("Coronary Heights",d,f),e.setFont("helvetica","normal"),f+=c-1,b&&e.text(`LM: ${b.toFixed(1)} mm`,d,f),N&&e.text(`RCA: ${N.toFixed(1)} mm`,h,f),f+=c);const v=r.accessVessels?.rightCFAmm,j=r.accessVessels?.leftCFAmm;if(v||j){e.setFont("helvetica","bold"),e.text("Access",d,f),e.setFont("helvetica","normal"),f+=c-1;const I=[];v&&I.push(`R CFA: ${v.toFixed(1)}mm`),j&&I.push(`L CFA: ${j.toFixed(1)}mm`),e.text(I.join("  |  "),d,f)}return a+46}addValveRecommendation(e,r,a){const{margin:n,pageWidth:i,colors:o,fontSize:l,lineHeight:c}=In,A=i-2*n;if(!r.ctMeasurements?.annulusArea||!r.ctMeasurements?.annulusPerimeter)return a;e.setFont("helvetica","bold"),e.setFontSize(l.heading),e.setTextColor(...o.text),e.text("Valve Recommendation",n,a),a+=c+2;const d=r.ctMeasurements.annulusArea,h=r.ctMeasurements.annulusPerimeter,f=this.valveSizingService.getBestValvePerBrand(d,h);e.setFillColor(236,253,245),e.rect(n,a-2,A,28,"F");let u=a+4;if(e.setFontSize(l.body),r.selectedValve){const x=this.valveSizingService.getManufacturer(r.selectedValve.brand);e.setFont("helvetica","bold"),e.setTextColor(...o.primary),e.text(`Selected: ${x.displayName} ${r.selectedValve.size}mm`,n+3,u),u+=c-1,e.setFont("helvetica","normal"),e.setTextColor(...o.secondary),e.text(`Selected by ${r.selectedValve.selectedBy==="ai"?"AI":"user"}`,n+3,u)}else{e.setFont("helvetica","bold"),e.setTextColor(...o.accent),e.text("Best Options:",n+3,u),u+=c-1,e.setFont("helvetica","normal"),e.setTextColor(...o.text);const x=this.valveSizingService.getBrandOrder(),b=[];for(const N of x){const v=f[N];if(v){const j=this.valveSizingService.getManufacturer(N),I=v.isOptimal?" ‚úì":"";b.push(`${j.displayName} ${v.size}mm (${v.oversizing.toFixed(0)}%)${I}`)}}e.text(b.slice(0,2).join("  |  "),n+3,u),u+=c-1,b.length>2&&e.text(b.slice(2).join("  |  "),n+3,u)}return a+34}addWorkupSections(e,r,a){const{margin:n,pageWidth:i,colors:o,fontSize:l,lineHeight:c,sectionGap:A}=In,d=i-2*n,h=r.structuredSections,f=[{key:"clinical",label:"Clinical Presentation"},{key:"echocardiography",label:"Echocardiography"},{key:"background",label:"Background"},{key:"medications",label:"Medications"},{key:"investigations",label:"Investigations"},{key:"procedure_planning",label:"Procedure Planning"},{key:"alerts",label:"Alerts & Precautions"}];for(const{key:u,label:x}of f){const b=h[u];if(!b||!("content"in b)||!b.content||b.content==="Not provided")continue;a>260&&(e.addPage(),a=In.margin),e.setFont("helvetica","bold"),e.setFontSize(l.subheading),e.setTextColor(...o.primary),e.text(x,n,a),a+=c,e.setFont("helvetica","normal"),e.setFontSize(l.body),e.setTextColor(...o.text);const N=e.splitTextToSize(b.content,d);for(const v of N)a>280&&(e.addPage(),a=In.margin),e.text(v,n,a),a+=c-2;a+=A}return a}addSnapshotsPage(e,r){const{margin:a,pageWidth:n,colors:i,fontSize:o,lineHeight:l}=In,c=r.snapshots||[];if(c.length===0)return;let A=a;e.setFont("helvetica","bold"),e.setFontSize(o.heading),e.setTextColor(...i.text),e.text("CT Image Snapshots",a,A),A+=l+4;const d=(n-2*a-10)/2,h=d*.75;c.forEach((f,u)=>{const x=u%2,b=Math.floor(u/2),N=a+x*(d+10),v=A+b*(h+20);if(v+h>280){e.addPage(),A=a;return}try{const j=f.thumbnailData||f.imageData;j&&e.addImage(j,"PNG",N,v,d,h),e.setDrawColor(...i.secondary),e.rect(N,v,d,h),f.label&&(e.setFont("helvetica","bold"),e.setFontSize(o.small),e.setTextColor(...i.text),e.text(f.label,N,v+h+4))}catch(j){console.warn(`[TAVIWorkupPDFService] Failed to add snapshot ${f.id}:`,j)}})}addFooters(e,r){const{margin:a,pageWidth:n,pageHeight:i,colors:o,fontSize:l}=In,c=e.getNumberOfPages(),A=new Date().toLocaleDateString("en-AU",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});for(let d=1;d<=c;d++)e.setPage(d),e.setDrawColor(...o.secondary),e.line(a,i-12,n-a,i-12),e.setFont("helvetica","normal"),e.setFontSize(l.small),e.setTextColor(...o.secondary),e.text(`Generated: ${A}`,a,i-8),e.text(r.patient,n/2,i-8,{align:"center"}),e.text(`Page ${d} of ${c}`,n-a,i-8,{align:"right"})}formatDate(e){try{return new Date(e).toLocaleDateString("en-AU",{year:"numeric",month:"short",day:"numeric"})}catch{return e}}}const iL=sc.getInstance(),oL=s=>{const e=s.trim().toLowerCase();return e==="new tavi workup"||e==="tavi workup"},lL=s=>{if(!s)return"";const e=[];s.name&&e.push(s.name.trim());const r=s.dateOfBirth||s.dob,a=s.age??s.ageYears;if(r||a){const n=[];r&&n.push(`DOB: ${r}`),a!=null&&String(a).trim().length>0&&n.push(`Age: ${a}`),n.length>0&&e.push(n.join(" | "))}if(s.id&&e.push(`ID: ${s.id}`),s.phone&&e.push(`Phone: ${s.phone}`),s.email&&e.push(`Email: ${s.email}`),s.medicare){const n=s.medicare.trim(),i=n.toLowerCase().includes("medicare");e.push(i?n:`Medicare: ${n}`)}return s.insurance&&e.push(`Insurance: ${s.insurance}`),s.address&&e.push(`Address: ${s.address}`),e.join(`
`).trim()},cL=s=>{if(!s||!s.trim())return{echocardiography:"",laboratory:"",otherInvestigations:""};const a=s.replace(/\r\n/g,`
`).replace(/[\u2022\u00b7]/g,`
`).replace(/\t/g," ").split(`
`).flatMap(f=>f.split(";")).map(f=>f.trim()).filter(Boolean),n=/^(echo(?:cardiogram|cardiography)?|tte|tee)\b[:\-]?\s*/i,i=/^(labs?|bloods?|biochem(?:istry)?|haematology|hematology|fbc|cbc|full blood count|uec|u&?e|lfts?|renal|electrolytes)\b[:\-]?\s*/i,o=[/\becho\b/i,/\bechocardiogram/i,/\bechocardiography/i,/\btte\b/i,/\btee\b/i,/\bef\b/i,/ejection fraction/i,/mean gradient/i,/peak gradient/i,/\bava\b/i,/aortic valve/i,/dimensionless index/i,/\bdi\b/i,/rvsp/i,/\blv\b/i,/\brv\b/i,/lvot/i,/\bmr\b/i,/\bar\b/i,/\btr\b/i],l=[/creatinine/i,/egfr/i,/urea/i,/\bhb\b/i,/ha?emoglobin/i,/platelet/i,/\bplt\b/i,/wcc/i,/inr/i,/albumin/i,/bilirubin/i,/\balt\b/i,/\bast\b/i,/\bna\b/i,/\bk\b/i,/sodium/i,/potassium/i,/troponin/i,/bnp/i,/nt-?pro?bnp/i,/lipids?/i,/cholesterol/i];let c=null;const A=[],d=[],h=[];for(const f of a){const u=f.replace(/\s+/g," ").trim();if(u){if(n.test(u)){c="echo";const x=u.replace(n,"").replace(/^[:\-]\s*/,"").trim();x&&A.push(x);continue}if(i.test(u)){c="lab";const x=u.replace(i,"").replace(/^[:\-]\s*/,"").trim();x&&d.push(x);continue}if(c==="echo"){A.push(u);continue}if(c==="lab"){d.push(u);continue}if(o.some(x=>x.test(u))){A.push(u);continue}if(l.some(x=>x.test(u))){d.push(u);continue}h.push(u)}}return{echocardiography:A.join(`
`).trim(),laboratory:d.join(`
`).trim(),otherInvestigations:h.join(`
`).trim()}},AL=s=>{if(!s)return;const r=Al.getInstance().getManufacturer(s.brand).displayName,a=s.volumeAdjustment,n=typeof a=="number"&&a!==0?` (${a>0?"+":""}${a.toFixed(1)}mL)`:"";return`${r} ${s.size}mm${n}`},dL=({workupId:s,onBack:e})=>{const{workups:r,updateWorkup:a,generatePresentation:n,retryNotionSync:i,resolveNotionConflict:o}=fw(),{clinicians:l}=yn(),c=r.find(S=>S.id===s),[A,d]=m.useState(!1),[h,f]=m.useState(null),[u,x]=m.useState(!1),[b,N]=m.useState(!1),[v,j]=m.useState(!1),[I,C]=m.useState(null),E=m.useRef(null),T=m.useCallback(async(S,H)=>{d(!0),f(null);try{const Y=await chrome.tabs.sendMessage(S,{type:"EXTRACT_EMR_DATA",fields:["background","investigations","medications"]});if(!Y?.success)throw new Error(Y?.error||"Failed to extract EMR data");const te=Y.data||{},G=(te.background||"").trim(),X=(te.investigations||"").trim(),le=(te.medications||"").trim(),he=cL(X),ve=lL(H);await a(s,ke=>{const Le={...ke.structuredSections,patient:{...ke.structuredSections.patient,content:ve||ke.structuredSections.patient.content},background:{...ke.structuredSections.background,content:G||ke.structuredSections.background.content},medications:{...ke.structuredSections.medications,content:le||ke.structuredSections.medications.content},laboratory:{...ke.structuredSections.laboratory,content:he.laboratory||ke.structuredSections.laboratory.content},echocardiography:{...ke.structuredSections.echocardiography,content:he.echocardiography||ke.structuredSections.echocardiography.content},investigations:{...ke.structuredSections.investigations,content:he.otherInvestigations||ke.structuredSections.investigations.content}};return{...ke,emrBackground:G,emrInvestigations:X,emrMedications:le,emrPatientDemographics:ve,emrLaboratory:he.laboratory,emrEchocardiography:he.echocardiography,emrLastExtracted:Date.now(),structuredSections:Le,completionPercentage:xA(Le)}}),console.log(`[TAVIWorkupDetailEditor] EMR extraction complete for workup ${s}`)}catch(Y){console.error("[TAVIWorkupDetailEditor] EMR extraction failed:",Y),f(Y instanceof Error?Y.message:"Failed to extract EMR data")}finally{d(!1)}},[s,a]),Q=m.useCallback(async()=>{f(null);try{const H=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0]?.id;if(!H)throw new Error("No active tab found");const Y=await chrome.tabs.sendMessage(H,{type:"EXTRACT_PATIENT_DATA"}),te=Y?.success?Y.data:null,G=te?.name?.trim()||"",X=c?.patient?.trim()||"";if(!!G&&!!X&&!oL(X)&&!Fu.shouldSkipValidation(X,G)){const he=Fu.validatePatientNames(X,G);if(!he.isMatch){E.current=()=>T(H,te),C(he);return}}await T(H,te)}catch(S){console.error("[TAVIWorkupDetailEditor] EMR extraction failed:",S),f(S instanceof Error?S.message:"Failed to extract EMR data")}},[T,c?.patient]),D=m.useCallback(async()=>{const S=E.current;E.current=null,C(null),S&&await S()},[]),k=m.useCallback(()=>{E.current=null,C(null)},[]);m.useEffect(()=>{c&&!c.emrLastExtracted&&Q()},[c?.id]);const R=m.useCallback(async()=>{x(!0);try{await n(s)}catch(S){console.error("[TAVIWorkupDetailEditor] Presentation failed:",S)}finally{x(!1)}},[s,n]),w=m.useCallback(async S=>{await a(s,H=>({...H,ctMeasurements:S}))},[s,a]),L=m.useCallback(async S=>{await a(s,H=>({...H,snapshots:[...H.snapshots||[],S]}))},[s,a]),M=m.useCallback(async S=>{await a(s,H=>({...H,snapshots:S}))},[s,a]),P=m.useCallback(async S=>{await a(s,H=>({...H,selectedValve:S}))},[s,a]),K=m.useCallback(async()=>{if(c){j(!0);try{await iL.downloadPDF(c),console.log(`[TAVIWorkupDetailEditor] PDF exported for workup ${s}`)}catch(S){console.error("[TAVIWorkupDetailEditor] PDF export failed:",S)}finally{j(!1)}}},[c,s]);if(!c)return t.jsx("div",{className:"flex items-center justify-center h-full",children:t.jsxs("div",{className:"text-center space-y-2",children:[t.jsx("p",{className:"text-sm text-ink-secondary",children:"Workup not found"}),t.jsx(ye,{variant:"outline",size:"sm",onClick:e,children:"Back to List"})]})});const $=AL(c.selectedValve),O=c.ctMeasurements?.annulusArea??c.ctMeasurements?.annulusAreaMm2,W=c.ctMeasurements?.annulusPerimeter??c.ctMeasurements?.annulusPerimeterMm,ee={patient:"Patient",status:"Status",category:"Category",referrer:"Referrer",location:"Location",procedureDate:"Procedure Date",referralDate:"Referral Date",notes:"Notes",datePresented:"Date Presented"},V=S=>S==null||S===""?"-":String(S),q=S=>S?new Date(S).toLocaleString():"Unknown";return t.jsxs("div",{className:"flex flex-col h-full bg-surface-secondary",children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-line-primary bg-white",children:[t.jsx("div",{className:"flex items-center gap-2",children:t.jsx(ye,{variant:"ghost",size:"sm",onClick:e,icon:t.jsx(Ly,{className:"w-4 h-4"}),children:"Back"})}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsx("div",{className:"flex items-center gap-2",children:t.jsxs("div",{className:"relative w-12 h-12",children:[t.jsxs("svg",{className:"w-12 h-12 transform -rotate-90",children:[t.jsx("circle",{cx:"24",cy:"24",r:"20",stroke:"currentColor",strokeWidth:"4",fill:"none",className:"text-gray-200"}),t.jsx("circle",{cx:"24",cy:"24",r:"20",stroke:"currentColor",strokeWidth:"4",fill:"none",strokeDasharray:`${2*Math.PI*20}`,strokeDashoffset:`${2*Math.PI*20*(1-c.completionPercentage/100)}`,className:"text-purple-600 transition-all duration-300"})]}),t.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:t.jsxs("span",{className:"text-xs font-semibold text-ink-primary",children:[c.completionPercentage,"%"]})})]})})})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[t.jsxs("div",{className:"bg-white rounded-lg border border-line-primary p-4",children:[t.jsx("h2",{className:"text-lg font-semibold text-ink-primary",children:c.patient}),t.jsx("div",{className:"mt-2 flex items-center gap-2",children:t.jsx("span",{className:"inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-700",children:c.status||"Undergoing Workup"})})]}),c.notionSyncConflict&&t.jsxs("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-4 space-y-3",children:[t.jsx("div",{className:"flex items-start justify-between gap-3",children:t.jsxs("div",{children:[t.jsx("div",{className:"text-sm font-semibold text-amber-900",children:"Notion sync conflict"}),t.jsxs("div",{className:"text-xs text-amber-800 mt-1",children:["Local edited ",q(c.notionSyncConflict.localEditedAt)," ¬∑ Notion edited ",q(c.notionSyncConflict.notionEditedAt)]}),t.jsxs("div",{className:"text-xs text-amber-700 mt-1",children:["Suggested: ",c.notionSyncConflict.preferredSource==="local"?"Keep local changes":"Use Notion changes"]})]})}),t.jsxs("div",{className:"grid grid-cols-[120px_1fr_1fr] gap-2 text-xs",children:[t.jsx("div",{className:"text-amber-700 font-medium",children:"Field"}),t.jsx("div",{className:"text-amber-700 font-medium",children:"Local"}),t.jsx("div",{className:"text-amber-700 font-medium",children:"Notion"}),Object.keys(c.notionSyncConflict.local).map(S=>{const H=S;return t.jsxs(bs.Fragment,{children:[t.jsx("div",{className:"text-amber-900",children:ee[H]||S}),t.jsx("div",{className:"text-amber-900",children:V(c.notionSyncConflict?.local[H])}),t.jsx("div",{className:"text-amber-900",children:V(c.notionSyncConflict?.notion[H])})]},S)})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(ye,{variant:"outline",size:"sm",onClick:()=>o(c.id,"local"),children:"Keep Local"}),t.jsx(ye,{variant:"primary",size:"sm",onClick:()=>o(c.id,"notion"),children:"Use Notion"})]})]}),c.notionSyncError&&!c.notionSyncConflict&&t.jsxs("div",{className:"bg-rose-50 border border-rose-200 rounded-lg p-4",children:[t.jsx("div",{className:"text-sm font-semibold text-rose-900",children:"Notion sync failed"}),t.jsx("div",{className:"text-xs text-rose-800 mt-1",children:c.notionSyncError}),t.jsx(ye,{variant:"outline",size:"sm",onClick:()=>i(c.id),className:"mt-3",children:"Retry Sync"})]}),t.jsxs("div",{className:"bg-white rounded-lg border border-line-primary p-4 space-y-3",children:[t.jsx("h3",{className:"text-sm font-semibold text-ink-primary",children:"Details"}),c.referralDate&&t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx(Da,{className:"w-4 h-4 text-ink-tertiary mt-0.5"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"text-xs text-ink-tertiary",children:"Referral Date"}),t.jsx("div",{className:"text-sm text-ink-primary",children:c.referralDate})]})]}),c.procedureDate&&t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx(Da,{className:"w-4 h-4 text-ink-tertiary mt-0.5"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"text-xs text-ink-tertiary",children:"Procedure Date"}),t.jsx("div",{className:"text-sm text-ink-primary",children:c.procedureDate})]})]}),c.referrer&&t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx(lu,{className:"w-4 h-4 text-ink-tertiary mt-0.5"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"text-xs text-ink-tertiary",children:"Referrer"}),t.jsx("div",{className:"text-sm text-ink-primary",children:c.referrer})]})]}),c.location&&t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx(vp,{className:"w-4 h-4 text-ink-tertiary mt-0.5"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"text-xs text-ink-tertiary",children:"Location"}),t.jsx("div",{className:"text-sm text-ink-primary",children:c.location})]})]}),c.category&&t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx(Do,{className:"w-4 h-4 text-ink-tertiary mt-0.5"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"text-xs text-ink-tertiary",children:"Category"}),t.jsx("div",{className:"text-sm text-ink-primary",children:c.category})]})]})]}),h&&t.jsxs("div",{className:"bg-rose-50 border border-rose-200 rounded-lg p-3",children:[t.jsx("p",{className:"text-sm text-rose-900",children:h}),t.jsx(ye,{variant:"ghost",size:"sm",onClick:Q,className:"mt-2",children:"Try Again"})]}),A&&!c.emrLastExtracted&&t.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Xa,{className:"w-4 h-4 text-blue-600 animate-spin"}),t.jsx("p",{className:"text-sm text-blue-900",children:"Extracting data from EMR..."})]})}),t.jsx(lF,{measurements:c.ctMeasurements,onUpdate:w}),t.jsx(cF,{measurements:c.ctMeasurements}),t.jsx(hF,{area:O,perimeter:W,selectedValve:c.selectedValve,onSelectValve:P}),t.jsx(pF,{snapshots:c.snapshots,onSnapshotCapture:L,onSnapshotsChange:M}),t.jsx(YT,{workup:c,onUpdate:S=>a(s,S),clinicians:l,selectedValveName:$})]}),t.jsx("div",{className:"border-t border-line-primary bg-white px-4 py-3",children:t.jsxs("div",{className:"flex items-center justify-end gap-2",children:[t.jsx(ye,{variant:"outline",size:"sm",onClick:K,disabled:v,icon:t.jsx(P2,{className:"w-3 h-3"}),children:v?"Exporting...":"PDF"}),t.jsx(ye,{variant:"outline",size:"sm",onClick:()=>N(!0),icon:t.jsx(Cp,{className:"w-3 h-3"}),children:"Preview"}),t.jsx(ye,{variant:"primary",size:"sm",onClick:R,disabled:u,children:u?"Generating...":"Present"})]})}),b&&t.jsx(fF,{workup:c,onClose:()=>N(!1)}),t.jsx($v,{isOpen:!!I,comparison:I,textToInsert:null,actionContext:"extract",onConfirm:D,onCancel:k,onRefreshEMR:Q})]})},uL=({patient:s,onImport:e,alreadyImported:r=!1})=>{const a=s.patient?.trim()||"Unnamed patient";return t.jsx("div",{className:"bg-white border border-line-primary rounded-lg p-3",children:t.jsxs("div",{className:"space-y-2",children:[t.jsx("div",{className:"flex items-start justify-between",children:t.jsxs("div",{children:[t.jsx("div",{className:"font-medium text-ink-primary text-sm",children:a}),s.status&&t.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium mt-1 ${s.status==="Pending"?"bg-gray-100 text-gray-700":s.status==="In Progress"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:s.status})]})}),t.jsxs("div",{className:"space-y-1 text-xs text-ink-secondary",children:[s.procedureDate&&t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx(Da,{className:"w-3 h-3 text-ink-tertiary"}),t.jsxs("span",{children:["Procedure: ",s.procedureDate]})]}),s.location&&t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx(vp,{className:"w-3 h-3 text-ink-tertiary"}),t.jsx("span",{children:s.location})]}),s.referrer&&t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx(Do,{className:"w-3 h-3 text-ink-tertiary"}),t.jsx("span",{children:s.referrer})]})]}),t.jsx(ye,{size:"sm",variant:r?"outline":"primary",onClick:()=>e(s),disabled:r,icon:t.jsx(Ya,{className:"w-3 h-3"}),className:"w-full",children:r?"Already Imported":"Import Workup"})]})})},Gd="all",zd="exclude-procedure-complete",mL=({onClose:s})=>{const{workups:e,loading:r,createWorkup:a,updateWorkup:n,selectedWorkupId:i,setSelectedWorkupId:o,notionAvailable:l,notionPatients:c,refreshNotionList:A}=fw(),[d,h]=m.useState(!0),[f,u]=m.useState(!0),[x,b]=m.useState(zd),N=async()=>{const k=prompt("Enter patient name:");if(!k?.trim())return;const R=await a();await n(R.id,w=>({...w,patient:k.trim(),referralDate:new Date().toISOString().split("T")[0]}))},v=k=>{o(k),h(!1)},j=()=>{o(null),h(!0)},I=async k=>{await a(k)},C=m.useMemo(()=>{const k=Array.from(new Set(c.map(R=>R.status).filter(Boolean)));return[zd,Gd,...k.sort((R,w)=>R.localeCompare(w))]},[c]),E=m.useMemo(()=>x===Gd?c:x===zd?c.filter(k=>k.status!=="Procedure Complete"):c.filter(k=>k.status===x),[c,x]),T=k=>e.some(R=>R.notionPageId===k),Q=m.useMemo(()=>E.filter(k=>!e.some(R=>R.notionPageId===k.notionPageId)),[E,e]),D=async()=>{for(const k of Q)await a(k)};return i?t.jsx("div",{className:"fixed inset-0 z-50 bg-white",children:t.jsx(dL,{workupId:i,onBack:j})}):t.jsxs("div",{className:"flex flex-col h-full bg-surface-secondary",children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-line-primary bg-white",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Zn,{className:"w-5 h-5 text-purple-600"}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("span",{className:"text-sm font-semibold text-ink-primary",children:"Structural Workups"}),t.jsx("span",{className:"text-xs text-ink-tertiary",children:"TAVI, PFO, mTEER workup management"})]})]}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsx(ye,{variant:"outline",size:"sm",onClick:s,icon:t.jsx(es,{className:"w-4 h-4"}),children:"Close"})})]}),t.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:r?t.jsx("div",{className:"flex items-center justify-center h-64",children:t.jsx("div",{className:"text-sm text-ink-tertiary",children:"Loading workups..."})}):e.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center h-full max-w-md mx-auto text-center space-y-6",children:[t.jsx("div",{className:"w-20 h-20 rounded-full bg-purple-50 flex items-center justify-center",children:t.jsx(Zn,{className:"w-10 h-10 text-purple-600"})}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("h3",{className:"text-lg font-semibold text-ink-primary",children:"No Workups Yet"}),t.jsx("p",{className:"text-sm text-ink-secondary",children:"Create your first TAVI workup to get started. Workups sync with your Notion Structural Workup database."})]}),t.jsx(ye,{onClick:N,icon:t.jsx(Fr,{className:"w-4 h-4"}),children:"Create Workup"})]}):t.jsxs("div",{className:"space-y-4",children:[l&&c.length>0&&t.jsxs("div",{className:"bg-white border border-line-primary rounded-lg",children:[t.jsxs("button",{type:"button",onClick:()=>u(!f),className:"w-full flex items-center justify-between p-3 hover:bg-gray-50 transition-colors",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Zn,{className:"w-4 h-4 text-purple-600"}),t.jsxs("span",{className:"text-sm font-semibold text-ink-primary",children:["Import from Notion (",x===Gd?c.length:`${E.length}/${c.length}`,")"]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{type:"button",onClick:k=>{k.stopPropagation(),A()},className:"p-1 hover:bg-gray-100 rounded","aria-label":"Refresh Notion patient list",children:t.jsx(Xa,{className:"w-3 h-3 text-ink-tertiary"})}),f?t.jsx(Vr,{className:"w-4 h-4 text-ink-tertiary"}):t.jsx(ps,{className:"w-4 h-4 text-ink-tertiary"})]})]}),f&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"px-3 pb-2 flex flex-wrap items-center gap-2",children:[t.jsxs("div",{className:"flex items-center gap-2 text-xs text-ink-tertiary",children:[t.jsx(Iy,{className:"w-3 h-3"}),t.jsx("span",{children:"Status"})]}),t.jsx("select",{value:x,onChange:k=>b(k.target.value),className:"px-2 py-1 text-xs border border-line-primary rounded-md bg-white text-ink-primary",children:C.map(k=>t.jsx("option",{value:k,children:k===Gd?"All statuses":k===zd?"Exclude Procedure Complete":k},k))}),t.jsxs(ye,{size:"sm",variant:"outline",onClick:D,disabled:Q.length===0,icon:t.jsx(Ya,{className:"w-3 h-3"}),children:[t.jsx("span",{children:"Import All"}),t.jsxs("span",{className:"text-ink-tertiary text-xs",children:["(",Q.length,")"]})]})]}),t.jsx("div",{className:"p-3 pt-0 space-y-2 max-h-80 overflow-y-auto",children:E.map(k=>t.jsx(uL,{patient:k,onImport:I,alreadyImported:T(k.notionPageId)},k.notionPageId))})]})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("h4",{className:"text-sm font-semibold text-ink-primary",children:["All Workups (",e.length,")"]}),t.jsx(ye,{size:"sm",onClick:N,icon:t.jsx(Fr,{className:"w-4 h-4"}),children:"New Workup"})]}),t.jsx("div",{className:"space-y-2",children:e.map(k=>t.jsx("button",{type:"button",onClick:()=>v(k.id),className:"w-full bg-white border border-line-primary rounded-lg p-4 hover:border-purple-300 hover:shadow-sm transition-all text-left",children:t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsxs("div",{children:[t.jsx("div",{className:"font-medium text-ink-primary",children:k.patient}),t.jsx("div",{className:"text-sm text-ink-secondary mt-1",children:k.procedureDate?`Procedure: ${k.procedureDate}`:"No procedure date"}),t.jsxs("div",{className:"text-xs text-ink-tertiary mt-1",children:[k.location&&`${k.location} ‚Ä¢ `,k.status]})]}),t.jsxs("div",{className:"text-xs text-ink-tertiary text-right space-y-1",children:[t.jsxs("div",{children:[k.completionPercentage,"%"]}),k.notionSyncConflict?t.jsx("div",{className:"text-amber-600",children:"Sync conflict"}):k.notionSyncError?t.jsx("div",{className:"text-rose-600",children:"Sync failed"}):k.notionPageId?t.jsx("div",{className:k.lastSyncedAt?"text-emerald-600":"text-ink-tertiary",children:k.lastSyncedAt?"Synced":"Syncing"}):null]})]})},k.id))})]})})]})},fy={clinic_letter:"quick-letter",procedure_report:"angiogram-pci",echo_report:"consultation",task:"background",note:"quick-letter",unknown:"quick-letter"},xy={quick_letter:"quick-letter",consultation_summary:"consultation",background:"background",investigations:"investigation-summary",medications:"medication",angiogram_report:"angiogram-pci",general:"quick-letter"},hL=s=>{const e=Date.now(),r=new Date(s).getTime(),a=Math.floor((e-r)/1e3);return a<60?"Just now":a<3600?`${Math.floor(a/60)} min ago`:a<86400?`${Math.floor(a/3600)} hours ago`:`${Math.floor(a/86400)} days ago`},pL=s=>({clinic_letter:"Clinic Letter",procedure_note:"Procedure Note",consultation:"Consultation",background:"Background",investigation:"Investigation",medication:"Medication",unknown:"General"})[s]||s.replace("_"," "),ou=[{category:"Letters & Correspondence",icon:"‚úâÔ∏è",color:"blue",agents:[{value:"quick-letter",label:"Quick Letter",description:"Clinic correspondence workflow"},{value:"consultation",label:"Consultation Summary",description:"Narrative consult note"}]},{category:"Clinical Data",icon:"üìã",color:"emerald",agents:[{value:"background",label:"Background",description:"Structured history / background note"},{value:"investigation-summary",label:"Investigations",description:"Investigation highlights (quick action)"},{value:"medication",label:"Medications",description:"Medication review quick action"}]},{category:"Procedures",icon:"üî¨",color:"purple",agents:[{value:"angiogram-pci",label:"Angiogram / PCI Report",description:"Cath lab procedure summary"}]}],gL=ou.flatMap(s=>s.agents),yy=gL.reduce((s,e)=>(s[e.value]=e.label,s),{}),Wd=s=>s.job_type==="phone_call_note"?"background":s.workflow_code&&xy[s.workflow_code]?xy[s.workflow_code]:s.dictation_type&&fy[s.dictation_type]?fy[s.dictation_type]:"quick-letter",d1=m.memo(()=>t.jsx(BC,{children:t.jsx(q2,{children:t.jsx(CC,{children:t.jsx(J3,{children:t.jsx(LT,{children:t.jsx(u1,{})})})})})})),u1=m.memo(()=>{const{state:s,actions:e,selectors:r}=y3(),a=Jy(),n=yn(),[i,o]=N3(),[l,c]=m.useState(!1),[A,d]=m.useState(!1),[h,f]=m.useState(!1),[u,x]=m.useState(!1),[b,N]=m.useState(!1),v={patientEducation:r.isOverlayActive("patient-education"),patientSelection:r.isOverlayActive("patient-selection"),screenshotAnnotation:r.isOverlayActive("screenshot-annotation"),bpDiaryImporter:r.isOverlayActive("bp-diary-importer"),lipidProfileImporter:r.isOverlayActive("lipid-profile-importer"),tteTrendImporter:r.isOverlayActive("tte-trend-importer"),imageInvestigation:r.isOverlayActive("image-investigation"),patientMismatch:r.isOverlayActive("patient-mismatch"),pasteNotes:r.isOverlayActive("paste-notes"),sparsityStepper:r.isOverlayActive("sparsity-stepper")},j=r.isSidePanelOpen("metrics-dashboard"),I=m.useRef(null),C=m.useRef(null),[E,T]=bs.useState(null),[Q,D]=m.useState(new Set),[k,R]=m.useState(new Set),[w,L]=m.useState(!1),[M,P]=m.useState(!1),[K,$]=m.useState({open:!1,tree:null,sourceKey:null}),O=m.useRef(null),W=m.useRef(0),ee=m.useRef(null),V=m.useRef(null),q=m.useRef(null),S=m.useRef(Ei.getInstance()).current,H=m.useRef($g.getInstance()).current,Y=m.useRef(Zo.getInstance()).current,te=m.useRef(nC.getInstance()).current,G=m.useRef(J2.getInstance()).current,X=m.useRef(null),le=m.useRef(null),[he,ve]=m.useState(null),[ke,Le]=m.useState([]),[Be,Re]=m.useState(!1),[re,Me]=m.useState(null),[Pe,be]=m.useState(null),[ce,Ie]=m.useState(new Set),[pe,fe]=m.useState(null),[we,de]=m.useState("quick-letter"),[xe,Ne]=m.useState(null),[it,st]=m.useState(null),[$e,Xe]=m.useState(null),Ze=m.useCallback(U=>{(async()=>{try{const[g]=await chrome.tabs.query({active:!0,currentWindow:!0}),B=g?.id,z=g?.url||"";if(!B||!z.includes("my.xestro.com"))return;await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"xestro-dark-mode",data:{force:U},tabId:B})}catch(g){console.debug("Xestro dark mode sync skipped:",g)}})()},[]),ct=m.useCallback(U=>{const g=document.documentElement,B=document.body;g.classList.toggle("dark",U),B?.classList.toggle("dark",U),g.classList.toggle("operator-extension-dark",U),B?.classList.toggle("operator-extension-dark",U),N(U),Ze(U);try{localStorage.setItem("operator-extension-dark-mode",U?"true":"false")}catch(z){console.debug("Dark mode preference persistence failed:",z)}},[Ze]),pt=m.useCallback(()=>{const g=!(b||document.documentElement.classList.contains("operator-extension-dark"));return ct(g),g},[ct,b]);m.useEffect(()=>{try{localStorage.getItem("operator-extension-dark-mode")==="true"&&ct(!0)}catch(U){console.debug("Dark mode preference load failed:",U)}},[ct]),m.useEffect(()=>{if(pe&&!we){const U=Wd(pe);de(U)}},[pe,we]),m.useEffect(()=>{if(!pe)return;const U=g=>{const B=ou.flatMap(J=>J.agents),z=parseInt(g.key);z>=1&&z<=B.length&&(de(B[z-1].value),g.preventDefault()),g.key==="Enter"&&we&&!Pe&&(ts(),g.preventDefault())};return document.addEventListener("keydown",U),()=>document.removeEventListener("keydown",U)},[pe,we,Pe]);const dt=U=>U.replace(/\s+/g," ").trim().toLowerCase(),xt=pe?pe.header_text||pe.triage_metadata?.raw_header||"Mobile dictation":"",Se=pe?.transcript_preview?.trim()||"",qe=!!Se&&dt(Se)!==dt(xt)&&!dt(Se).startsWith(dt(xt)),ut=pe?.triage_metadata?.confidence,Ge=m.useCallback(async({agentType:U,transcript:g,patientInfo:B,sessionId:z})=>{const J=Date.now(),ne=(We,at,et)=>{const Bt=Math.max(0,Math.min(100,Math.round(at))),It={stage:We,progress:Bt,stageProgress:Bt,details:et,modelName:U==="transcription"?"Transcription Capture":"LM Studio"};e.setPipelineProgress(It),e.updatePatientSession(z,{pipelineProgress:It})};let ge=0;const je=500,Te={sessionId:z,timestamp:Date.now(),patientId:B.id,patientInfo:B,demographics:{name:B.name,dateOfBirth:B.dob,age:B.age},onProgress:(We,at,et)=>{ne("ai-analysis",typeof at=="number"?at:50,et||We)},onStream:(We,at)=>{console.log(`üìä onStream called: delta length=${We.length}, fullText length=${at.length}`),e.setStreaming(!0),e.appendStreamChunk(We),ge=at.length;const et=90+Math.min(ge/je*10,9.5),Bt=Math.min(ge/je*100,95);console.log(`üìà Progress update: ${Math.round(et)}% (${ge}/${je} chars)`),ne("generation",et,`Generating letter (${ge} chars)`),e.updatePatientSession(z,{pipelineProgress:{stage:"generation",progress:Math.round(et),stageProgress:Math.round(Bt),details:`Streaming: ${ge} chars`,modelName:"LM Studio"}})}};let Oe=null;switch(U){case"quick-letter":{const{QuickLetterAgent:We}=await ns(async()=>{const{QuickLetterAgent:et}=await import("./chunks/agents.D6Qu3kid.js").then(Bt=>Bt.m);return{QuickLetterAgent:et}},__vite__mapDeps([5,6,4,2,1]));Oe=await new We().process(g,Te);break}case"angiogram-pci":{const{AngiogramPCIAgent:We}=await ns(async()=>{const{AngiogramPCIAgent:et}=await import("./chunks/agents.D6Qu3kid.js").then(Bt=>Bt.n);return{AngiogramPCIAgent:et}},__vite__mapDeps([5,6,4,2,1]));Oe=await new We().process(g,Te);break}case"consultation":{const{ConsultationAgent:We}=await ns(async()=>{const{ConsultationAgent:et}=await import("./chunks/agents.D6Qu3kid.js").then(Bt=>Bt.o);return{ConsultationAgent:et}},__vite__mapDeps([5,6,4,2,1]));Oe=await new We().process(g,Te);break}case"background":{const{BackgroundAgent:We}=await ns(async()=>{const{BackgroundAgent:et}=await import("./chunks/BackgroundAgent.Opfr34f8.js");return{BackgroundAgent:et}},__vite__mapDeps([23,5,6,4,2,1]));Oe=await new We().process(g,Te);break}case"transcription":default:{Oe={id:`transcription-${Date.now()}`,agentName:"Transcription Capture",content:g,sections:[{title:"Transcript",content:g,type:"narrative",priority:"high"}],metadata:{confidence:.95,processingTime:Date.now()-J,modelUsed:"operator-ingest"},timestamp:Date.now()};break}}if(!Oe)throw new Error(`No agent pipeline available for ${U}`);return ne("generation",100,U==="transcription"?"Transcription ready":"Agent output ready"),Oe},[e]),[rt,Tt]=m.useState(null),At=m.useCallback(async()=>{try{Re(!0);const U=await Pd.listJobs();Le(U),Me(null),Ie(new Set(U.filter(g=>!!g.attached_session_id).map(g=>g.id)))}catch(U){const g=U instanceof Error?U.message:"Unable to reach Operator Ingest daemon";Me(g)}finally{Re(!1)}},[]),mt=m.useCallback(async(U,g)=>{be(U);let B=null,z=!1;try{const J=await Pd.getJob(U);if(J.job_type==="phone_call_note")throw new Error("Phone call notes are already saved to rounds.");if(!J.transcript_text)throw new Error("Transcript not available yet. Try again in a moment.");console.log("üìã Extracting fresh patient data for mobile job attachment..."),Y.invalidateCache(),console.log("üóëÔ∏è Cache invalidated - extracting fresh patient data");const ne=await ma();if(!ne)throw new Error("No patient detected. Open a patient chart in Xestro before attaching the dictation.");const ge={name:ne.name||"Patient",id:ne.id||`Patient-${Date.now()}`,dob:ne.dob||"",age:ne.age||"",phone:ne.phone,email:ne.email,medicare:ne.medicare,insurance:ne.insurance,address:ne.address,extractedAt:ne.extractedAt||Date.now()};e.setCurrentPatientInfo(ge);const je=Date.parse(J.created_at)||Date.now();B=typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`mobile-${J.id}-${Date.now()}`;const Te=g??Wd(J),Oe=J.header_text||J.triage_metadata?.raw_header||"Mobile dictation",We={id:B,source:"mobile",mobileJobId:J.id,patient:ge,transcription:J.transcript_text,results:"",summary:Oe,agentType:Te,agentName:yy[Te]||"Mobile Dictation",timestamp:je,recordedDate:new Date(je).toLocaleDateString(),status:"processing",completed:!1,processingStartTime:Date.now(),pipelineProgress:{stage:"ai-analysis",progress:0,stageProgress:0,details:"Queued for agent processing",modelName:"LM Studio"}};e.addPatientSession(We),e.setCurrentSessionId(B),e.setSelectedSessionId(B),e.setActiveWorkflow(Te),e.setUIMode("processing",{sessionId:B,origin:"user"}),e.setProcessing(!0),e.setProcessingStatus("processing"),e.setTranscription(J.transcript_text),e.setCurrentAgent(Te),z=!0,e.setPipelineProgress({stage:"ai-analysis",progress:5,stageProgress:5,details:"Preparing mobile dictation",modelName:"LM Studio"});let at=Te,et;try{et=await Ge({agentType:Te,transcript:J.transcript_text,patientInfo:ge,sessionId:B})}catch(As){if(console.error("Mobile workflow failed, falling back to raw transcript",As),Te!=="transcription")gt.getInstance().warning("Workflow failed","Keeping raw transcription for review."),at="transcription",et=await Ge({agentType:"transcription",transcript:J.transcript_text,patientInfo:ge,sessionId:B});else throw As}const Bt=et.metadata?.processingTime??(We.processingStartTime?Date.now()-We.processingStartTime:0),It=et.status==="awaiting_validation"?"awaiting_validation":"completed",ft={...We,results:et.content,summary:et.summary||Oe,status:It,completed:It!=="awaiting_validation",processingTime:Bt,modelUsed:et.metadata?.modelUsed,warnings:et.warnings,errors:et.errors,pipelineProgress:{stage:"generation",progress:100,stageProgress:100,details:"Mobile dictation processed",modelName:et.metadata?.modelUsed||"LM Studio"}};if(at==="angiogram-pci"&&(ft.angiogramValidationResult=et.validationResult||null,ft.angiogramValidationStatus=et.status??"complete",ft.angiogramExtractedData=et.extractedData),e.updatePatientSession(B,{results:ft.results,summary:ft.summary,agentType:ft.agentType,agentName:ft.agentName,status:ft.status,completed:ft.completed,processingTime:ft.processingTime,modelUsed:ft.modelUsed,warnings:ft.warnings,errors:ft.errors,pipelineProgress:ft.pipelineProgress,angiogramValidationResult:ft.angiogramValidationResult,angiogramValidationStatus:ft.angiogramValidationStatus,angiogramExtractedData:ft.angiogramExtractedData}),console.log("üìù Setting mobile job results:",{hasContent:!!et.content,contentLength:et.content?.length||0,hasSummary:!!et.summary,summaryLength:et.summary?.length||0,agentType:at}),et.content?.trim()===J.transcript_text?.trim()&&Te!=="transcription")throw console.error("‚ùå Mobile job: Agent returned transcription unchanged"),console.error("   Agent type:",Te),console.error("   Transcript length:",J.transcript_text?.length||0),console.error("   Output length:",et.content?.length||0),new Error("Letter generation failed: Output matches input unchanged. Ensure LM Studio is running with a model loaded.");e.setResults(et.content),et.summary?(console.log("‚úÖ Setting AI generated summary for mobile job"),e.setAiGeneratedSummary(et.summary)):console.warn("‚ö†Ô∏è No summary found in mobile job report"),e.setMissingInfo(et.metadata?.missingInformation||null),e.clearStream(),e.setStreaming(!1),await G.saveSession(ft),await Pd.markAttached(J.id,B,ge.name,at),Ie(As=>new Set(As).add(J.id)),gt.getInstance().success(`${yy[Te]||"Mobile dictation"} ready`,`Linked to ${ge.name}`),At()}catch(J){console.error("Failed to attach mobile job",J);const ne=J instanceof Error?J.message:"Unexpected error attaching dictation";B&&e.updatePatientSession(B,{status:"error",completed:!0,errors:[ne],pipelineProgress:{stage:"generation",progress:100,stageProgress:100,details:"Mobile dictation processing failed"}}),gt.getInstance().error("Attach failed",ne)}finally{z&&(e.setProcessing(!1),e.setProcessingStatus("idle"),e.setUIMode("idle",{sessionId:B,origin:"auto"})),be(null)}},[e,Y,G,Ge,At]),Qt=m.useCallback(U=>{if(U.job_type==="phone_call_note"){gt.getInstance().info("Already saved","Phone call notes are added to rounds automatically.");return}fe(U),de(Wd(U))},[]);m.useEffect(()=>{At()},[At]);const ts=m.useCallback(async()=>{if(!pe)return;const U=pe.id,g=we;fe(null),await mt(U,g)},[mt,we,pe]),Yt=m.useCallback(()=>{Pe||fe(null)},[Pe]),Ht=m.useCallback(async U=>{if(xe&&xe!==U.id){gt.getInstance().info("Please wait for the current delete to finish.");return}Ne(U.id);try{await Pd.deleteJob(U.id),Le(g=>g.filter(B=>B.id!==U.id)),Ie(g=>{const B=new Set(g);return B.delete(U.id),B}),pe?.id===U.id&&fe(null),gt.getInstance().success("Mobile dictation deleted")}catch(g){console.error("Failed to delete mobile job",g);const B=g instanceof Error?g.message:"Unable to delete dictation";gt.getInstance().error("Delete failed",B)}finally{Ne(null),At()}},[xe,pe,At]),[Es,vt]=m.useState(null),[Ft,Hs]=m.useState(null),ks=m.useRef(null),Is=m.useRef(null),Nt=Hp({onRecordingComplete:U=>{if(ks.current)return ks.current(U)},onVoiceActivityUpdate:(U,g)=>{Is.current&&Is.current(U,g)},onRecordingTimeUpdate:m.useCallback(U=>{W.current=U},[]),onError:m.useCallback(U=>{console.error("üé§ Recording error:",U);const g=C.current||s.currentSessionId;g&&(console.log("üßπ Cleaning up failed recording session:",g),e.removePatientSession(g),e.setCurrentSessionId(null),C.current=null),e.setActiveWorkflow(null),I.current=null,e.setUIMode("idle",{sessionId:null,origin:"auto"});let B,z="Recording Failed";U.name==="NotAllowedError"?(z="Microphone Permission Denied",B="Please allow microphone access in your browser settings to record."):U.message.includes("Failed to access selected microphone")?(z="Microphone Device Error",B=U.message,gt.getInstance().error("Microphone Selection Issue","The selected microphone could not be accessed. Please check your audio device settings.",8e3)):U.name==="OverconstrainedError"||U.name==="NotFoundError"?(z="Microphone Not Available",B="The selected microphone is not available. Please check that your audio device is connected and selected in System Settings ‚Üí Sound."):B=`Recording failed: ${U.message}`,e.setErrors([B]),(U.name==="NotAllowedError"||U.message.includes("Failed to access selected microphone"))&&Oc(z,B),e.setProcessing(!1),e.setProcessingStatus("idle")},[e,s.currentSessionId]),getMicrophoneId:()=>a.selectedMicrophoneId}),gs=Nt.isRecording||["recording","transcribing","processing"].includes(s.processingStatus);C3({enabled:!gs,defaultMode:"dictate"});const Vt=m.useMemo(()=>(Nt.isRecording||C.current!==null,s.selectedSessionId),[s.selectedSessionId,Nt.isRecording]),Kr=m.useMemo(()=>Vt?s.patientSessions.find(g=>g.id===Vt)?.patient?.name:void 0,[Vt,s.patientSessions]),Kt=m.useMemo(()=>s.displaySession.isDisplayingSession&&s.displaySession.displaySessionId?s.displaySession.displaySessionId:Vt||(s.currentSessionId?s.currentSessionId:s.ui.modeContext.sessionId?s.ui.modeContext.sessionId:null),[s.displaySession.isDisplayingSession,s.displaySession.displaySessionId,Vt,s.currentSessionId,s.ui.modeContext.sessionId]),Js=m.useMemo(()=>Kt&&s.patientSessions.find(U=>U.id===Kt)||null,[s.patientSessions,Kt]),fs=m.useMemo(()=>s.displaySession.isDisplayingSession&&s.displaySession.displayAgent?s.displaySession.displayAgent:s.currentAgent?s.currentAgent:Js?.agentType??null,[s.displaySession.isDisplayingSession,s.displaySession.displayAgent,s.currentAgent,Js]),Zs=m.useMemo(()=>s.displaySession.isDisplayingSession&&s.displaySession.displayAgentName?s.displaySession.displayAgentName:s.currentAgentName?s.currentAgentName:Js?.agentName??null,[s.displaySession.isDisplayingSession,s.displaySession.displayAgentName,s.currentAgentName,Js]),Ot=m.useMemo(()=>`${Kt??"active"}::${fs??"unknown"}`,[Kt,fs]),qt=m.useMemo(()=>s.resultRevisions[Ot],[s.resultRevisions,Ot]),ur=m.useMemo(()=>{if(s.displaySession.isDisplayingSession&&s.displaySession.displaySessionId===(Kt??s.displaySession.displaySessionId))return s.displaySession.displayResults||"";if(Kt){const U=s.patientSessions.find(g=>g.id===Kt);if(U)return U.results||""}return s.results||""},[s.displaySession.isDisplayingSession,s.displaySession.displaySessionId,s.displaySession.displayResults,s.patientSessions,Kt,s.results]),kr=m.useMemo(()=>{if(qt)return{key:Ot,original:qt.original,edited:qt.edited,savedText:qt.savedText,notes:qt.notes,tags:qt.tags,runEvaluationOnSave:qt.runEvaluationOnSave,hasUnsavedChanges:qt.hasUnsavedChanges,lastSavedAt:qt.lastSavedAt,isEditing:qt.isEditing}},[qt,Ot]),Zr=m.useMemo(()=>({workflowId:Kt,agentLabel:Zs}),[Kt,Zs]);m.useEffect(()=>{s.patientVersionSessionId&&Kt&&s.patientVersionSessionId!==Kt&&(e.setPatientVersion(null),e.setPatientVersionSessionId(null))},[s.patientVersionSessionId,Kt,e]);const Qa=m.useCallback(()=>{ee.current&&(ee.current.abort(),ee.current=null),e.streamCancelled(),e.setStreaming(!1),e.setAiGeneratedSummary(void 0)},[e]),Oa=m.useCallback(U=>{if(!Ot)return;const g=s.resultRevisions[Ot];U?g?e.updateResultRevision(Ot,{isEditing:!0,workflowId:Kt??g.workflowId}):e.setResultRevision(Ot,{original:ur,edited:ur,savedText:ur,notes:"",tags:[],workflowId:Kt,runEvaluationOnSave:!0,hasUnsavedChanges:!1,isEditing:!0,lastSavedAt:void 0}):g&&e.updateResultRevision(Ot,{isEditing:!1})},[e,Ot,s.resultRevisions,Kt,ur]),tn=m.useCallback(U=>{if(!Ot)return;const g=s.resultRevisions[Ot];if(!g)return;const B={};U.edited!==void 0&&(B.edited=U.edited,B.hasUnsavedChanges=U.edited!==g.savedText),U.notes!==void 0&&(B.notes=U.notes),U.tags!==void 0&&(B.tags=U.tags),U.runEvaluationOnSave!==void 0&&(B.runEvaluationOnSave=U.runEvaluationOnSave),e.updateResultRevision(Ot,B)},[e,Ot,s.resultRevisions]),Ha=m.useCallback(()=>{if(!Ot)return;const U=s.resultRevisions[Ot];U&&e.updateResultRevision(Ot,{edited:U.savedText,hasUnsavedChanges:!1})},[e,Ot,s.resultRevisions]),sn=m.useCallback(async()=>{if(!qt||!Ot)return;const U=qt.edited;L(!0);try{if(e.setResults(U),Kt){e.updatePatientSession(Kt,{results:U});const g=s.patientSessions.find(B=>B.id===Kt);if(g){const B={...g,results:U};e.setDisplaySession(B)}}e.updateResultRevision(Ot,{savedText:U,hasUnsavedChanges:!1,lastSavedAt:Date.now()}),vi("Revision saved","Updated result is ready for EMR actions.")}catch(g){const B=g instanceof Error?g.message:"Unknown error";bt.error("Failed to save revision",{error:B}),Oc("Failed to save revision",B)}finally{L(!1)}},[qt,Ot,Kt,e,s.patientSessions]),Mn=m.useCallback(async()=>{if(!(!qt||!Ot)){if(!fs){Oc("Unable to save golden pair","Agent context is missing.");return}if(!qt.notes.trim()){Oc("Scenario summary required","Add a scenario summary before saving.");return}P(!0);try{const U=Array.from(new Set([...qt.tags||[],...fs?[fs]:[],...Kt?[Kt]:[]])),g=await te.saveGoldenPair({agentId:fs,workflowId:Kt,original:qt.original,edited:qt.edited,notes:qt.notes.trim(),tags:U,runEvaluationOnNewExample:qt.runEvaluationOnSave});vi("Golden pair saved",`Captured as ${g.exampleId}`),e.updateResultRevision(Ot,{savedText:qt.edited,hasUnsavedChanges:!1,lastSavedAt:Date.now()})}catch(U){const g=U instanceof Error?U.message:"Unknown error";bt.error("Golden pair capture failed",{error:g}),Oc("Failed to save golden pair",g)}finally{P(!1)}}},[qt,Ot,Kt,fs,te,e]);m.useEffect(()=>{s.ui.mode==="idle"&&!s.displaySession.isDisplayingSession&&!s.currentSessionId&&!Vt&&Object.keys(s.resultRevisions).length>0&&e.resetResultRevisions()},[s.ui.mode,s.displaySession.isDisplayingSession,s.currentSessionId,Vt,s.resultRevisions,e]),m.useEffect(()=>{},[e,s]),m.useEffect(()=>((async()=>{try{console.log("üì¶ Initializing session persistence..."),await G.initialize();const g=await G.loadSessions();console.log(`‚úÖ Loaded ${g.length} persisted sessions`);for(const z of g)e.addPatientSession(z),e.addPersistedSessionId(z.id);const B=await G.getCheckedSessionIds();R(B),await lr(),console.log("‚úÖ Session persistence initialized")}catch(g){console.error("‚ùå Failed to initialize session persistence:",g)}})(),()=>{G.shutdown()}),[]);const lr=m.useCallback(async()=>{try{const U=await G.getStorageStats();ve(U),e.setStorageMetadata({totalSessions:U.sessionCount,storageUsedBytes:U.usedBytes,usedPercentage:U.usedPercentage})}catch(U){console.error("‚ùå Failed to update storage stats:",U)}},[G,e]),os=m.useCallback(async U=>{try{await G.saveSession(U),e.addPersistedSessionId(U.id),await lr(),console.log("üíæ Session saved to local storage:",U.id)}catch(g){console.error("‚ùå Failed to save session to persistence:",g),ca().errorFromBackground("Failed to save session locally",{suggestion:"Storage may be full - clear old sessions",category:"storage"})}},[G,e,lr]),ua=m.useCallback(async U=>{if(!k.has(U)){R(g=>{if(g.has(U))return g;const B=new Set(g);return B.add(U),B});try{await G.markSessionComplete(U),await lr(),console.log("‚úÖ Session marked complete (persistent):",U)}catch(g){console.error("‚ùå Failed to mark session as complete:",g),ca().errorFromBackground("Failed to mark session as complete",{suggestion:"Try again",category:"storage",autoClearMs:5e3}),R(B=>{if(!B.has(U))return B;const z=new Set(B);return z.delete(U),z})}}},[k,G,lr]),_n=m.useCallback(async U=>{if(k.has(U)){R(g=>{if(!g.has(U))return g;const B=new Set(g);return B.delete(U),B});try{await G.unmarkSessionComplete(U),await lr(),console.log("‚Ü©Ô∏è Session unchecked (persistent):",U)}catch(g){console.error("‚ùå Failed to unmark session as complete:",g),ca().errorFromBackground("Failed to unmark session",{suggestion:"Try again",category:"storage",autoClearMs:5e3}),R(B=>{if(B.has(U))return B;const z=new Set(B);return z.add(U),z})}}},[k,G,lr]),Va=m.useCallback(async U=>{k.has(U)?await _n(U):await ua(U)},[k,ua,_n]);m.useCallback(async()=>{try{const U=await G.deleteAllCheckedSessions();console.log(`üóëÔ∏è Deleted ${U.deletedCount} checked sessions`),s.patientSessions.forEach(g=>{g.completed&&(e.removePatientSession(g.id),e.removePersistedSessionId(g.id))}),R(new Set),await lr(),gt.getInstance().success(`Deleted ${U.deletedCount} checked sessions`)}catch(U){console.error("‚ùå Failed to delete checked sessions:",U),ca().errorFromBackground("Failed to delete checked sessions",{suggestion:"Try again",category:"storage",autoClearMs:5e3})}},[G,s.patientSessions,e,lr]),m.useCallback(async U=>{try{const g=await G.deleteOldSessions(U);console.log(`üóëÔ∏è Deleted ${g.deletedCount} sessions older than ${U} days`);const B=await G.loadSessions(),z=new Set(B.map(J=>J.id));s.patientSessions.forEach(J=>{z.has(J.id)||(e.removePatientSession(J.id),e.removePersistedSessionId(J.id))}),await lr(),gt.getInstance().success(`Deleted ${g.deletedCount} old sessions`)}catch(g){console.error("‚ùå Failed to delete old sessions:",g),ca().errorFromBackground("Failed to delete old sessions",{suggestion:"Try again",category:"storage",autoClearMs:5e3})}},[G,s.patientSessions,e,lr]);const Qn=m.useCallback(async U=>{try{await G.deleteSession(U),console.log(`üóëÔ∏è Deleted session ${U} from persistent storage`),e.removePatientSession(U),e.removePersistedSessionId(U),await lr(),gt.getInstance().success("Session deleted")}catch(g){console.error("‚ùå Failed to delete session:",g),ca().errorFromBackground("Failed to delete session",{suggestion:"Try again",category:"storage",autoClearMs:5e3})}},[G,e,lr]),rn=m.useCallback(async()=>{if(!Ft)return;console.log("üîÑ Retrying workflow with same model after user freed memory"),vt(null);const{sessionId:U,audioBlob:g,workflowId:B,transcription:z}=Ft;e.updatePatientSession(U,{status:"processing",errors:[],processingProgress:{phase:"Processing",progress:0}});try{await tr(U,g,B,z),Hs(null)}catch(J){console.error("‚ùå Retry failed:",J)}},[Ft,e]),an=m.useCallback(async U=>{if(!Ft)return;console.log(`üîÄ Switching to model: ${U}`),S.updateConfig({processorModel:U}),vt(null);const{sessionId:g,audioBlob:B,workflowId:z,transcription:J}=Ft;e.updatePatientSession(g,{status:"processing",errors:[],processingProgress:{phase:"Processing",progress:0}});try{await tr(g,B,z,J),Hs(null),gt.getInstance().success(`Switched to ${U}`,"Processing will continue with the new model")}catch(ne){console.error("‚ùå Switch and retry failed:",ne)}},[Ft,S,e]),Gr=m.useCallback(()=>{vt(null),Hs(null),Ft&&e.updatePatientSession(Ft.sessionId,{status:"cancelled",errors:["User cancelled model loading"]})},[Ft,e]);m.useEffect(()=>{(async()=>{try{const g=await chrome.storage.local.get("checkedSessionIds");g.checkedSessionIds&&Array.isArray(g.checkedSessionIds)&&(R(new Set(g.checkedSessionIds)),console.log("‚úÖ Loaded checked sessions from storage:",g.checkedSessionIds))}catch(g){console.warn("Failed to load checked sessions from storage:",g)}})()},[]),m.useEffect(()=>{(async()=>{try{const g=Array.from(k);await chrome.storage.local.set({checkedSessionIds:g}),console.log("üíæ Saved checked sessions to storage:",g)}catch(g){console.warn("Failed to save checked sessions to storage:",g)}})()},[k]),m.useEffect(()=>{if(typeof chrome>"u"||!chrome.storage?.local)return;let U=!0;const g=async()=>{try{const z=await chrome.storage.local.get(JA);if(!U)return;const J=Hg(z[JA]);Tt(J?.dataUrl??null)}catch(z){console.warn("Failed to load lanyard artwork preference:",z)}},B=(z,J)=>{if(J!=="local"||!(JA in z))return;const ne=Hg(z[JA].newValue);Tt(ne?.dataUrl??null)};return g(),chrome.storage.onChanged.addListener(B),()=>{U=!1,chrome.storage.onChanged.removeListener(B)}},[]);const ea=m.useCallback(async U=>{if(["right-heart-cath","tavi-workup"].includes(U))return console.log(`üîÑ Agent '${U}' requires agent-based processing, skipping streaming`),null;try{const{systemPromptLoader:B}=await ns(async()=>{const{systemPromptLoader:z}=await import("./chunks/agents.D6Qu3kid.js").then(J=>J.S);return{systemPromptLoader:z}},__vite__mapDeps([5,6,4,2,1]));return await B.loadSystemPrompt(U,"primary")}catch(B){return console.error("Failed to load system prompt for agent:",U,B),null}},[]);m.useCallback(async U=>{try{switch(U){case"quick-letter":return(await ns(()=>import("./chunks/QuickLetterSystemPrompts.MduAofRn.js"),[])).QUICK_LETTER_SYSTEM_PROMPTS.primary;case"investigation-summary":return(await ns(()=>import("./chunks/InvestigationSummarySystemPrompts.8cZAk0RD.js"),__vite__mapDeps([24,5,6,4,2,1]))).INVESTIGATION_SUMMARY_SYSTEM_PROMPTS.primary;case"background":return(await ns(()=>import("./chunks/BackgroundSystemPrompts.Dx0p2kfn.js"),[])).BACKGROUND_SYSTEM_PROMPTS.primary;case"medication":return(await ns(()=>import("./chunks/agents.D6Qu3kid.js").then(B=>B.j),__vite__mapDeps([5,6,4,2,1]))).MEDICATION_SYSTEM_PROMPTS.primary;case"bloods":return(await ns(()=>import("./chunks/agents.D6Qu3kid.js").then(B=>B.q),__vite__mapDeps([5,6,4,2,1]))).BLOODS_SYSTEM_PROMPTS.primary;case"imaging":return(await ns(()=>import("./chunks/agents.D6Qu3kid.js").then(B=>B.r),__vite__mapDeps([5,6,4,2,1]))).IMAGING_SYSTEM_PROMPTS.primary;default:return null}}catch(g){return console.warn("Failed to load system prompt for agent",U,g),null}},[]);const mr=U=>{switch(U){case"investigation-summary":return{model:Tr.QUICK_MODEL,maxTokens:2e3};case"background":return{model:Tr.QUICK_MODEL,maxTokens:2e3};case"medication":return{model:Tr.QUICK_MODEL,maxTokens:3e3};case"quick-letter":return{model:Tr.REASONING_MODEL,maxTokens:5e3};default:return{model:Tr.REASONING_MODEL,maxTokens:4e3}}},Ts=m.useCallback(async(U,g,B,z)=>{console.log("üé¨ Starting streaming generation:",{sessionId:U,agent:g,inputLength:B?.length||0,inputPreview:B?.substring(0,100)||"(empty)"});let J=await ea(g);if(!J)return{handled:!1,success:!1};if(g==="quick-letter"&&z?.patientInfo){const{name:xs,age:cr,dob:Cs,gender:zs}=z.patientInfo,Ps=[];xs&&Ps.push(`Patient Name: ${xs}`),cr&&Ps.push(`Age: ${cr}`),Cs&&Ps.push(`DOB: ${Cs}`),zs&&Ps.push(`Gender: ${zs}`),Ps.length>0&&(J+=`

PATIENT DEMOGRAPHICS:
${Ps.join(`
`)}
Use these demographics when appropriate in the letter (e.g., salutations, patient identification).`,console.log("üìã Added patient demographics to Quick Letter streaming context:",{name:xs,age:cr,dob:Cs,gender:zs}))}e.clearStream(),e.setStreaming(!0),e.setProcessingStatus("processing"),e.setCurrentAgent(g);const ne=new AbortController;ee.current=ne;const{model:ge,maxTokens:je}=mr(g),Te=Date.now();e.setProcessingStartTime(Te),e.setPipelineProgress({stage:"ai-analysis",progress:50,stageProgress:10,details:`Generating ${g==="quick-letter"?"letter":"report"}`,modelName:ge});let Oe=0,We=!1,at=null;const et=performance.now();let Bt=0;const It=je*3.5;let ft=Date.now();const cs=Date.now(),As=2e4;let Fs=null;Fs=setInterval(()=>{const xs=Date.now()-cs,cr=Math.min(xs/As*18,18),Cs=Math.min(50+cr,68);e.updatePipelineProgress({stage:"ai-analysis",progress:Cs,stageProgress:Math.min(xs/As*100,90),details:"Processing prompt..."})},1e3);const za=Ni.getInstance();return await pC({model:ge,messages:[{role:"system",content:J},{role:"user",content:B}],temperature:.3,maxTokens:je,signal:ne.signal,onMessage:xs=>{at==null&&xs?.choices?.[0]?.delta?.content&&(at=Math.round(performance.now()-et),e.setTTFT(at),Fs&&(clearInterval(Fs),Fs=null),e.updatePipelineProgress({stage:"generation",progress:70,stageProgress:20,details:"Streaming response"}))},onToken:xs=>{e.appendStreamChunk(xs),Bt+=xs.length;const cr=Date.now();if(cr-ft>500){ft=cr;const Cs=Math.min(Bt/It*30,28),zs=Math.min(70+Cs,98),Ps=Math.min(Bt/It*100,95);e.updatePipelineProgress({stage:"generation",progress:zs,stageProgress:Ps,details:`Streaming response (${Math.round(Ps)}%)`})}},onEnd:async(xs,cr)=>{Fs&&(clearInterval(Fs),Fs=null),We=!0,Oe=Date.now()-Te,e.updatePipelineProgress({stage:"generation",progress:100,stageProgress:100,details:"Complete"});let Cs,zs=xs;if(g==="quick-letter")try{const _t=ew(xs);Cs=_t.summary,zs=_t.letterContent,console.log("üìã Parsed QuickLetter streaming output:"),console.log("   Summary:",Cs.substring(0,100)+"..."),console.log("   Letter content length:",zs.length)}catch(_t){console.warn("‚ö†Ô∏è Failed to parse QuickLetter output:",_t),Cs=I3(xs),zs=xs}e.streamDone(zs,cr,at),Cs&&e.setAiGeneratedSummary(Cs),g==="quick-letter"?(console.log("üîç Streaming completion: detecting missing information for QuickLetter"),(async()=>{try{const _t=B.toLowerCase(),wt=!!(s.patientSessions.find(Ar=>Ar.id===U)?.patient?.name||s.currentPatientInfo?.name);console.log("üîç EMR patient info available:",wt);const vs={letter_type:"general",missing_purpose:[],missing_clinical:[],missing_recommendations:[],completeness_score:"90%"};!(_t.includes("refer")||_t.includes("follow up")||_t.includes("follow-up")||_t.includes("consultation")||_t.includes("thank you")||_t.includes("review")||_t.includes("assessment")||_t.includes("request")||_t.includes("results")||_t.includes("recommend")||_t.includes("appreciate")||_t.includes("discharge")||_t.includes("admission")||_t.includes("update"))&&_t.length<50&&vs.missing_purpose.push("Letter purpose or reason for correspondence"),!_t.includes("examination")&&!_t.includes("found")&&!_t.includes("shows")&&!_t.includes("revealed")&&!_t.includes("noted")&&_t.length>200&&(_t.includes("assess")||_t.includes("exam")||_t.includes("review")||_t.includes("consult"))&&vs.missing_clinical.push("Clinical examination findings");const wn=vs.missing_purpose.length+vs.missing_clinical.length+vs.missing_recommendations.length;wn>0?(console.log("üìä Setting missing information from streaming completion:",wn,"items"),e.setMissingInfo(vs)):(console.log("‚úÖ No missing information detected during streaming completion"),e.setMissingInfo(null))}catch(_t){console.warn("‚ö†Ô∏è Failed to detect missing information during streaming:",_t)}})()):(console.log(`üßπ Streaming completion: clearing missing info for ${g} agent (not quick-letter)`),e.setMissingInfo(null)),console.log("üèÅ Workflow Completion: Using atomic completion for streaming results"),console.log("üèÅ State Check: Before atomic completion - Processing:",s.isProcessing,"Status:",s.processingStatus,"Streaming:",s.streaming);try{console.log("üîß PRESERVING AGENT TYPE (streaming path):",g,"for session:",U),e.setCurrentAgent(g),e.completeProcessingAtomic(U,zs,Cs),console.log("üèÅ Workflow Completion: Atomic completion done for streaming workflow"),e.setSelectedSessionId(U),console.log("üîñ Set selectedSessionId for completed session:",U),setTimeout(()=>{(s.streaming||s.currentSessionId!==null)&&(console.warn("üö® UI still showing active state after completion - forcing ready state"),e.forceUIReadyState())},1e3)}catch(_t){console.error("‚ùå Atomic completion failed for streaming workflow:",_t),e.forceUIReadyState()}ee.current=null,console.log("üíæ Saving session with transcription:",{sessionId:U,transcriptionLength:B?.length||0,transcriptionPreview:B?.substring(0,100)||"(empty)",resultsLength:zs?.length||0}),e.updatePatientSession(U,{results:zs,summary:Cs,transcription:B||"",status:"completed",completed:!0,completedTime:Date.now(),processingProgress:{phase:"Complete",progress:100,details:"Streaming finished"}});const Ps=s.patientSessions.find(_t=>_t.id===U);if(Ps&&await os({...Ps,results:zs,summary:Cs,transcription:B||"",status:"completed",completed:!0,completedTime:Date.now()}),g==="quick-letter"&&zs){console.log("üéØ NEXT-STEP ENGINE: Triggering inference after Quick Letter completion");const _t=Ps?.patient||s.currentPatientInfo,aa={demographics:{name:_t?.name||"Patient",age:_t?.age}};o.runInference(zs,aa,U,"quick-letter").then(async wt=>{if(e.updatePatientSession(U,{nextStepResult:wt,nextStepContext:aa}),Ps)try{await os({...Ps,results:zs,summary:Cs,transcription:B||"",status:"completed",completed:!0,completedTime:Ps.completedTime??Date.now(),nextStepResult:wt,nextStepContext:aa})}catch(vs){console.warn("‚ö†Ô∏è Failed to persist next-step results:",vs)}}).catch(wt=>{console.error("‚ùå Next-Step Engine inference failed:",wt)})}V.current&&clearTimeout(V.current),V.current=setTimeout(()=>{e.updatePatientSession(U,{processingProgress:void 0}),V.current=null},300)},onError:xs=>{xs.name==="AbortError"?e.streamCancelled():e.streamError(String(xs)),e.setStreaming(!1),e.setAiGeneratedSummary(void 0),ee.current=null}}),We?(za.recordMetrics("agent-processing",Oe,{agentType:g}),{handled:!0,success:!0,processingDuration:Oe,modelUsed:ge}):{handled:!1,success:!1}},[e,ea]),[On,Ur]=m.useState(!1);m.useCallback(()=>(X.current||(X.current=new Xv),X.current),[]);const zr=m.useCallback((U,g,B,z,J,ne,ge)=>{const je=()=>{const Oe={id:ne||`failed-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,audioBlob:U,timestamp:Date.now(),agentType:g,errorMessage:B,transcriptionAttempt:z,metadata:{duration:J||W.current||0,fileSize:U.size,recordingTime:J||W.current||0}};if(e.setFailedRecordings([Oe,...s.failedAudioRecordings.slice(0,4)]),ne){const We=s.patientSessions.find(et=>et.id===ne),at=Date.now();e.updatePatientSession(ne,{pendingAudio:{saved:!1,savedAt:at,failureReason:B}}),te.savePendingAudio(ne,U,{agentType:g,patientName:ge,timestamp:new Date().toISOString(),failureReason:B}).then(et=>{const Bt={saved:et.success,audioPath:et.audioPath,savedAt:at,failureReason:B};e.updatePatientSession(ne,{pendingAudio:{...Bt}}),We&&os({...We,pendingAudio:Bt}).catch(It=>{console.warn("‚ö†Ô∏è Failed to persist pending-audio metadata:",It)}),et.success?console.log("üíæ Persisted audio to disk for retry:",et.audioPath):console.warn("‚ö†Ô∏è Pending audio save did not succeed (will remain in memory only)")}).catch(et=>{console.warn("‚ö†Ô∏è Failed to persist audio to disk (will remain in memory only):",et)})}};"requestIdleCallback"in window?requestIdleCallback(je,{timeout:1e3}):setTimeout(je,0)},[e,s.failedAudioRecordings,s.patientSessions,te,os]);m.useCallback(()=>{e.setFailedRecordings([]),console.log("üóëÔ∏è Cleared all failed audio recordings")},[e]);const er=m.useCallback(async(U,g,B)=>{console.log("üîÑ Starting background processing for session:",U),console.log("üéØ Current selectedSessionId at start:",s.selectedSessionId);let z="";const J=s.modelStatus.whisperServer?.model||"ASR engine",ne=new AbortController;try{e.updatePatientSession(U,{transcriptionStartTime:Date.now()}),e.setPipelineProgress({stage:"transcribing",progress:15,stageProgress:10,details:"Queued for transcription",modelName:J}),e.updatePatientSession(U,{pipelineProgress:{stage:"transcribing",progress:15,stageProgress:10,details:"Queued for transcription",modelName:J}}),console.log("üîÑ Queuing transcription for session:",U);const ge=Date.now(),je=Ni.getInstance(),{AudioProcessingQueueService:Te}=await ns(async()=>{const{AudioProcessingQueueService:nt}=await import("./chunks/AudioProcessingQueueService.BVdSSjm2.js");return{AudioProcessingQueueService:nt}},__vite__mapDeps([17,4,2,1,5,6])),Oe=Te.getInstance();z=await new Promise((nt,Mt)=>{Oe.addJob(U,g,B,{onProgress:(is,qr)=>{console.log(`üìä Session ${U} transcription status:`,is,qr||""),is==="processing"?(e.setPipelineProgress({stage:"transcribing",progress:30,stageProgress:60,details:"Transcribing audio",modelName:J}),e.updatePatientSession(U,{status:"transcribing",pipelineProgress:{stage:"transcribing",progress:30,stageProgress:60,details:"Transcribing audio",modelName:J}})):(is==="failed"||is==="cancelled")&&(e.clearPipelineProgress(),e.updatePatientSession(U,{status:"error",errors:[qr||"Transcription failed"],completedTime:Date.now(),processingProgress:void 0,pipelineProgress:void 0}))},onComplete:is=>{console.log("‚úÖ Queued transcription completed for session:",U),nt(is)},onError:is=>{console.error("‚ùå Queued transcription failed for session:",U,is),Mt(new Error(is))}})});const We=Date.now()-ge;je.recordMetrics("transcription",We,{agentType:B,audioSize:g.size}),console.log("‚úÖ Transcription complete for session:",U),console.log("üìù Transcription result:",z.substring(0,200)+(z.length>200?"...":""));let at=z,et=0;try{const Mt=await kh.getInstance().applyPhrasebookCorrections(z,B);at=Mt.correctedText,et=Mt.appliedCorrections,et>0&&(console.log(`üìñ Applied ${et} phrasebook corrections`),gt.getInstance().info(`Applied ${et} terminology correction${et===1?"":"s"}`))}catch(nt){console.warn("‚ö†Ô∏è Failed to apply phrasebook corrections:",nt)}const Bt=at.trim(),It=Bt.length<10,ft=Bt.length===0,cs=Bt.startsWith("[")&&Bt.endsWith("]"),As=Bt.toLowerCase().includes("transcription failed")||Bt.toLowerCase().includes("server not running")||Bt.toLowerCase().includes("timed out");if(ft||It||cs||As){console.warn("‚ùå Transcription validation failed:",{length:Bt.length,isEmpty:ft,tooShort:It,isPlaceholder:cs,isError:As,preview:Bt.substring(0,100)}),setTimeout(()=>{const is=s.patientSessions.find(rr=>rr.id===U)?.patient?.name;zr(g,B,`Transcription validation failed: ${ft?"Empty transcription":It?`Too short (${Bt.length} chars)`:cs?"Placeholder response - server not running":As?"Transcription error - server not running":"Transcription error"}`,Bt,void 0,U,is);const qr=ft?"no-audio":It?"too-short":cs?"service-unavailable":"error",Ir=ft?"No audio detected":It?"Recording too short":cs?"Transcription service unavailable":"Transcription service error",ms=ft?"Try speaking closer to the microphone":It?"Record for at least 2 seconds":cs?"Check Transcription server status":"Check Transcription server connection";ca().errorFromBackground(`Transcription failed: ${Ir}`,{suggestion:ms,category:"transcription"}),e.updatePatientSession(U,{transcription:Bt,status:"error",errors:[`Audio transcription failed: ${Ir}`],completedTime:Date.now()});const ga=s.patientSessions.find(rr=>rr.id===U);ga&&os({...ga,transcription:Bt,status:"error",errors:[`Audio transcription failed: ${Ir}`],completedTime:Date.now()}).then(()=>{console.log("üíæ Persisted failed transcription session:",U)}).catch(rr=>{console.error("Failed to persist error session:",rr)}),e.setTranscription(Bt),e.setErrors([`Audio transcription failed: ${Ir}`]),e.setProcessingStatus("error")},0),console.log("üö´ Skipping agent processing due to transcription validation failure");return}console.log("‚úÖ Transcription validation passed, proceeding with agent processing"),e.setPipelineProgress({stage:"ai-analysis",progress:45,stageProgress:10,details:"Loading AI agent",modelName:"MedGemma-27B"});const Fs=Date.now();e.updatePatientSession(U,{transcription:at,status:"processing",processingStartTime:Fs,pipelineProgress:{stage:"ai-analysis",progress:45,stageProgress:10,details:"Loading AI agent",modelName:"MedGemma-27B"}});const za=s.patientSessions.find(nt=>nt.id===U);za&&(await os({...za,transcription:at,status:"processing",processingStartTime:Fs}),console.log("üíæ Persisted session with transcription:",U)),e.setTranscription(at),e.setProcessingStatus("processing"),e.setTimingData({processingStartTime:Fs}),e.setTranscriptionApproval({status:"pending",originalText:z,currentText:z,hasBeenEdited:!1});const xs=B==="quick-letter"&&s.currentPatientInfo?{sessionId:U,timestamp:Date.now(),patientInfo:s.currentPatientInfo}:void 0;xs&&console.log("üìã Passing patient demographics to streaming generation:",{name:s.currentPatientInfo?.name,age:s.currentPatientInfo?.age,dob:s.currentPatientInfo?.dob});const cr=B==="angiogram-pci"||B==="tavi-workup";cr&&console.log(`‚è≠Ô∏è Skipping streaming for ${B==="angiogram-pci"?"Angio/PCI":"TAVI Workup"} so proof mode can run first`);const Cs=cr?{handled:!1,success:!1}:await Ts(U,B,z,xs);if(Cs.handled){if(Cs.success){const nt=Date.now()-ge;je.recordMetrics("complete",nt,{agentType:B});try{await rA.getInstance().storeMetric({agentType:B,transcriptionTime:We,processingTime:Cs.processingDuration??0,totalDuration:nt,modelUsed:Cs.modelUsed||"Unknown",success:!0})}catch(Mt){console.error("Failed to store performance metrics (streaming):",Mt)}try{const Mt=zi.getInstance(),is=s.patientSessions.find(qr=>qr.id===U);is&&Cs.processingDuration&&(Mt.recordActualProcessingTime(B,z.length,Cs.processingDuration,is.audioDuration),console.log(`üìä Recorded processing time for ${B} (streaming): ${Cs.processingDuration}ms (transcription: ${z.length} chars, audio: ${is.audioDuration?.toFixed(1)}s)`))}catch(Mt){console.warn("Failed to record processing time for prediction (streaming):",Mt)}}return}console.log("üîÑ Processing with agent for session (non-streaming):",U,B);const zs=Date.now(),{AgentFactory:Ps}=await ns(async()=>{const{AgentFactory:nt}=await import("./chunks/AgentFactory.CRiEgI8V.js");return{AgentFactory:nt}},__vite__mapDeps([25,4,2,1,5,6,10,8]));e.updatePatientSession(U,{status:"processing",processingStartTime:Date.now(),processingProgress:{phase:"Starting",progress:0,details:"Initializing agent"}}),e.setProcessingProgress(0);const _t={skipNotification:!0,sessionId:U};_t.onProgress=(nt,Mt,is)=>{console.log(`${B==="tavi-workup"?"ü´Ä TAVI":"ü§ñ"} Progress: ${nt} (${Mt}%) - ${is||""}`);const Ir=Math.max(0,Math.min(100,Mt)),ms=40+Ir*.5;e.setPipelineProgress({stage:"ai-analysis",progress:ms,stageProgress:Ir,details:is||nt||"Processing with AI",modelName:"MedGemma-27B"}),e.updatePatientSession(U,{status:"processing",processingProgress:{phase:nt||"Processing",progress:Ir,details:is},pipelineProgress:{stage:"ai-analysis",progress:ms,stageProgress:Ir,details:is||nt||"Processing with AI",modelName:"MedGemma-27B"}}),e.setProcessingProgress(Ir)};let aa;B==="quick-letter"&&s.currentPatientInfo&&(aa={sessionId:U,timestamp:Date.now(),patientInfo:s.currentPatientInfo},console.log("üìã Added patient demographics to Quick Letter context:",{name:s.currentPatientInfo.name,age:s.currentPatientInfo.age,dob:s.currentPatientInfo.dob})),(B==="tavi-workup"||B==="angiogram-pci")&&(aa={...aa,requestProofMode:!0},console.log(`üîç ${B==="tavi-workup"?"TAVI":"Angio/PCI"} Proof Mode: Requesting fact extraction before generation`));const wt=await Ps.processWithAgent(B,at,aa,ne.signal,_t),vs=Date.now()-zs;je.recordMetrics("agent-processing",vs,{agentType:B}),console.log("‚úÖ Agent processing complete for session:",U);const vn=wt.status;if(vn==="awaiting_proof"&&B==="tavi-workup"){console.log("üîç TAVI Proof Mode: Facts extracted, showing proof mode dialog");const nt=wt,Mt=nt.keyFacts||[];e.updatePatientSession(U,{taviProofModeExtractedData:{taviData:nt.taviData,hemodynamics:nt.hemodynamics,valveAssessment:nt.valveAssessment,complications:nt.complications},status:"awaiting_proof",processingProgress:void 0,pipelineProgress:void 0}),st({facts:Mt,onComplete:async is=>{console.log("‚úÖ TAVI Proof Mode: Facts confirmed, resuming with locked facts",is);const qr={};is.facts.forEach(ms=>{(ms.status==="confirmed"||ms.status==="edited")&&(qr[ms.sourceField]=ms.value)});const Ir={sessionId:U,timestamp:Date.now(),lockedFacts:qr,proofResult:is};try{e.updatePatientSession(U,{status:"processing",processingProgress:{phase:"Generating report",progress:0}});const ms=await Ps.processWithAgent("tavi-workup",at,Ir,ne.signal,_t),ga={results:ms.content,summary:ms.summary||"",agentName:ms.agentName,modelUsed:ms.modelUsed,status:"completed",completed:!0,completedTime:Date.now(),processingTime:ms.processingTime,warnings:ms.warnings,errors:ms.errors,taviStructuredSections:ms.taviStructuredSections,processingProgress:void 0,pipelineProgress:void 0,transcription:at};e.updatePatientSession(U,ga);const rr=s.patientSessions.find(Ns=>Ns.id===U);rr&&await os({...rr,...ga}),console.log("‚úÖ TAVI Proof Mode: Report generation complete")}catch(ms){console.error("‚ùå TAVI Proof Mode: Resume failed:",ms),e.updatePatientSession(U,{status:"error",errors:[ms.message||"Failed to resume after proof mode"]})}finally{st(null)}},onCancel:()=>{console.log("üö´ TAVI Proof Mode: Cancelled by user"),e.updatePatientSession(U,{status:"error",errors:["Proof mode cancelled by user"],processingProgress:void 0,pipelineProgress:void 0}),st(null)}}),e.clearPipelineProgress();return}if(vn==="awaiting_proof"&&B==="angiogram-pci"){console.log("üîç Angio/PCI Proof Mode: Facts extracted, showing proof mode dialog");const nt=wt,Mt=nt.keyFacts||[],is=nt.extractedData||{},qr=is.lesions,Ir=is.lesionExtractionMethod||"regex";console.log("üå≥ Lesion tree extracted for proof mode:",qr),e.updatePatientSession(U,{angiogramProofModeExtractedData:{extractedData:nt.extractedData,procedureType:nt.procedureType},status:"awaiting_proof",processingProgress:void 0,pipelineProgress:void 0}),Xe({facts:Mt,lesionTree:qr,lesionExtractionMethod:Ir,onComplete:async ms=>{console.log("‚úÖ Angio/PCI Proof Mode: Facts confirmed, resuming with locked facts",ms);const ga={};ms.facts.forEach(Ns=>{(Ns.status==="confirmed"||Ns.status==="edited")&&(ga[Ns.sourceField]=Ns.value)});const rr={sessionId:U,timestamp:Date.now(),lockedFacts:ga,lockedLesions:ms.refinedLesions,proofResult:ms};try{e.updatePatientSession(U,{status:"processing",processingProgress:{phase:"Generating report",progress:0}});const Ns=await Ps.processWithAgent("angiogram-pci",at,rr,ne.signal,_t),Hn={results:Ns.content,summary:Ns.summary||"",agentName:Ns.agentName,modelUsed:Ns.modelUsed,status:"completed",completed:!0,completedTime:Date.now(),processingTime:Ns.processingTime,warnings:Ns.warnings,errors:Ns.errors,processingProgress:void 0,pipelineProgress:void 0,transcription:at};e.updatePatientSession(U,Hn);const Nn=s.patientSessions.find(Ai=>Ai.id===U);Nn&&await os({...Nn,...Hn}),console.log("‚úÖ Angio/PCI Proof Mode: Report generation complete")}catch(Ns){console.error("‚ùå Angio/PCI Proof Mode: Resume failed:",Ns),e.updatePatientSession(U,{status:"error",errors:[Ns.message||"Failed to resume after proof mode"]})}finally{Xe(null)}},onCancel:()=>{console.log("üö´ Angio/PCI Proof Mode: Cancelled by user"),e.updatePatientSession(U,{status:"error",errors:["Proof mode cancelled by user"],processingProgress:void 0,pipelineProgress:void 0}),Xe(null)}}),e.clearPipelineProgress();return}if(vn==="awaiting_validation")switch(B){case"right-heart-cath":{console.log("‚ö†Ô∏è RHC validation required - pausing workflow");const nt=wt;e.updatePatientSession(U,{results:nt.content,rhcReport:nt,status:"awaiting_validation",processingProgress:void 0,pipelineProgress:void 0}),e.setProcessingProgress(0),e.clearPipelineProgress();return}case"tavi-workup":{console.log("‚ö†Ô∏è TAVI validation required - pausing workflow");const nt=wt;e.updatePatientSession(U,{results:nt.content,taviStructuredSections:nt.structuredSections,taviValidationResult:nt.validationResult??null,taviValidationStatus:"awaiting_validation",taviExtractedData:nt.extractedData,status:"awaiting_validation",processingProgress:void 0,pipelineProgress:void 0}),e.setTaviStructuredSections(nt.structuredSections??void 0),e.setTaviValidationState({result:nt.validationResult??null,status:"awaiting_validation",extractedData:nt.extractedData??null}),e.setProcessingProgress(0),e.clearPipelineProgress();return}case"angiogram-pci":{console.log("‚ö†Ô∏è Angiogram/PCI validation required - pausing workflow");const nt=wt;e.updatePatientSession(U,{results:nt.content,angiogramValidationResult:nt.validationResult??null,angiogramValidationStatus:"awaiting_validation",angiogramExtractedData:nt.extractedData,status:"awaiting_validation",processingProgress:void 0,pipelineProgress:void 0}),e.setAngioValidationState({result:nt.validationResult??null,status:"awaiting_validation",extractedData:nt.extractedData??null}),e.setProcessingProgress(0),e.clearPipelineProgress();return}case"mteer":{console.log("‚ö†Ô∏è mTEER validation required - pausing workflow");const nt=wt;e.updatePatientSession(U,{results:nt.content,mteerValidationResult:nt.validationResult??null,mteerValidationStatus:"awaiting_validation",mteerExtractedData:nt.extractedData,status:"awaiting_validation",processingProgress:void 0,pipelineProgress:void 0}),e.setMteerValidationState({result:nt.validationResult??null,status:"awaiting_validation",extractedData:nt.extractedData??null}),e.setProcessingProgress(0),e.clearPipelineProgress();return}case"pre-op-plan":{console.log("‚ö†Ô∏è Pre-Op Plan validation required - pausing workflow");const nt=wt;e.updatePatientSession(U,{results:nt.content,preOpPlanData:nt.preOpPlanData,preOpValidationResult:nt.validationResult??null,preOpValidationStatus:"awaiting_validation",preOpExtractedData:nt.extractedData,status:"awaiting_validation",processingProgress:void 0,pipelineProgress:void 0}),e.setPreOpPlanData(nt.preOpPlanData),e.setProcessingProgress(0),e.clearPipelineProgress();return}}e.setPipelineProgress({stage:"generation",progress:95,stageProgress:50,details:"Formatting output",modelName:"MedGemma-27B"});const wn=s.transcription&&s.transcription.trim().length>0?s.transcription:at&&at.trim().length>0?at:s.displaySession?.displayTranscription||"",Ar={results:wt.content,summary:wt.summary||"",agentName:wt.agentName,modelUsed:wt.modelUsed,status:"completed",completed:!0,completedTime:Date.now(),processingTime:wt.processingTime,warnings:wt.warnings,errors:wt.errors,processingProgress:{phase:"Complete",progress:100,details:"Processing finished"},pipelineProgress:{stage:"generation",progress:100,stageProgress:100,details:"Complete"},transcription:wn};Ar.preOpPlanData=wt.preOpPlanData,wt.taviStructuredSections&&(Ar.taviStructuredSections=wt.taviStructuredSections),B==="tavi-workup"&&(Ar.taviValidationResult=wt.validationResult??null,Ar.taviValidationStatus="complete",Ar.taviExtractedData=wt.extractedData??void 0,e.setTaviValidationState({result:null,status:void 0,extractedData:void 0})),B==="angiogram-pci"&&(Ar.angiogramValidationResult=wt.validationResult??null,Ar.angiogramValidationStatus="complete",Ar.angiogramExtractedData=wt.extractedData??void 0,e.setAngioValidationState({result:null,status:void 0,extractedData:void 0})),B==="mteer"&&(Ar.mteerValidationResult=wt.validationResult??null,Ar.mteerValidationStatus="complete",Ar.mteerExtractedData=wt.extractedData??void 0,e.setMteerValidationState({result:null,status:void 0,extractedData:void 0})),console.log("üö® STATE: Checking for rhcData in result..."),console.log("üö® STATE: Result keys:",Object.keys(wt)),console.log("üö® STATE: Has rhcData?","rhcData"in wt),"rhcData"in wt&&(console.log("üö® STATE: Storing RHC report to session"),console.log("üö® STATE: RHC report structure:",{hasRhcData:!!wt.rhcData,hasHaemodynamics:!!wt.haemodynamicPressures,hasCalculations:!!wt.calculations}),Ar.rhcReport=wt),e.updatePatientSession(U,Ar);const eo=s.patientSessions.find(nt=>nt.id===U);eo&&await os({...eo,...Ar}),e.setProcessingProgress(100),V.current&&clearTimeout(V.current),V.current=setTimeout(()=>{e.updatePatientSession(U,{processingProgress:void 0,pipelineProgress:void 0}),e.setProcessingProgress(0),e.clearPipelineProgress(),V.current=null},300),je.recordMetrics("complete",Date.now()-ge,{agentType:B});try{await rA.getInstance().storeMetric({agentType:B,transcriptionTime:We,processingTime:vs,totalDuration:Date.now()-ge,modelUsed:wt.agentName||"Unknown",success:!0})}catch(nt){console.error("Failed to store performance metrics:",nt)}try{const nt=zi.getInstance(),Mt=s.patientSessions.find(is=>is.id===U);Mt&&(nt.recordActualProcessingTime(B,z.length,vs,Mt.audioDuration),console.log(`üìä Recorded processing time for ${B}: ${vs}ms (transcription: ${z.length} chars, audio: ${Mt.audioDuration?.toFixed(1)}s)`))}catch(nt){console.warn("Failed to record processing time for prediction:",nt)}const hr=U===s.selectedSessionId;if(hr?(e.setTranscription(z),e.setResults(wt.content),e.setPreOpPlanData(wt.preOpPlanData),e.setMissingInfo(wt.missingInfo||null),wt.taviStructuredSections&&e.setTaviStructuredSections(wt.taviStructuredSections),"rhcData"in wt&&e.setRhcReport(wt),console.log("üéØ Updated main results panel for currently selected session:",U)):console.log("üîï Background session completed, results stored in session only:",U),B==="bloods")try{console.log("ü©∏ Bloods workflow completed - inserting results into Tests Requested field");const nt={content:wt.content};(await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"bloods-insert",data:nt}))?.success?console.log("‚úÖ Blood test results inserted into Tests Requested field successfully"):console.warn("‚ö†Ô∏è Failed to insert blood test results into Tests Requested field")}catch(nt){console.error("‚ùå Failed to insert blood test results into Tests Requested field:",nt)}console.log("üîß PRESERVING AGENT TYPE:",B,"for session:",U),e.setCurrentAgent(B),console.log("‚úÖ Agent type preserved:",B),hr&&(wt.summary&&wt.summary.trim()?(bt.debug("Setting AI-generated summary",{component:"summary",length:wt.summary.length}),e.setAiGeneratedSummary(wt.summary)):e.setAiGeneratedSummary(void 0),console.log("üéØ Updated agent and summary for currently selected session:",U));const Cn=s.patientSessions.find(nt=>nt.id===U),Li=Cn?.recordingStartTime?ge-Cn.recordingStartTime:0;if(console.log("üîç Session completion check:",{sessionId:U,currentSelectedSessionId:s.selectedSessionId,isCurrentlySelectedAtCompletion:hr,willUpdateGlobalUI:hr}),hr){e.setTimingData({recordingTime:Li,transcriptionTime:We,agentProcessingTime:vs,totalProcessingTime:Li+We+vs,processingStartTime:ge}),console.log("üèÅ Background Workflow Completion: Using atomic completion for background session"),console.log("üèÅ State Check: Before atomic completion - Processing:",s.isProcessing,"Status:",s.processingStatus,"Streaming:",s.streaming);const nt=wt.summary||wt.content||"Workflow completed";try{e.completeProcessingAtomic(U,wt.content,nt),console.log("üèÅ Background completion successful"),e.setSelectedSessionId(U),console.log("üîñ Set selectedSessionId for completed background session:",U),setTimeout(()=>{(s.streaming||s.currentSessionId!==null)&&(console.warn("üö® UI still showing active state after background completion - forcing ready state"),e.forceUIReadyState())},1e3)}catch(Mt){console.error("‚ùå Atomic completion failed for background session:",Mt),e.forceUIReadyState()}wt.missingInfo&&e.setMissingInfo(wt.missingInfo),wt.taviStructuredSections&&e.setTaviStructuredSections(wt.taviStructuredSections),"rhcData"in wt&&e.setRhcReport(wt),console.log("üèÅ Background Workflow Completion: Atomic completion done for background workflow"),console.log("üéØ Updated global UI state for currently selected session:",U)}else console.log("üîï Background session completed, skipping global UI state updates for:",U);console.log("‚úÖ Session completed in background:",U);try{const nt=s.patientSessions.find(Mt=>Mt.id===U)?.patient.name||"Unknown Patient";await _y.showCompletionNotification(B,wt.processingTime||0,void 0,nt),console.log("üéâ Background session completed for:",nt),Vg.sessionReady(nt,B)}catch(nt){console.warn("Failed to send completion notification:",nt)}if(hr)try{const nt=typeof window<"u"&&window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches;setTimeout(()=>{const Mt=le.current||document.getElementById("results-section");Mt&&typeof Mt.scrollIntoView=="function"&&(Mt.scrollIntoView({behavior:nt?"auto":"smooth",block:"start"}),console.log("üéØ Auto-scrolled to results for currently selected session:",U))},50)}catch(nt){console.debug("Auto-scroll to results failed (non-critical):",nt instanceof Error?nt.message:nt);try{const Mt=le.current||document.getElementById("results-section");Mt&&typeof Mt.focus=="function"&&Mt.focus({preventScroll:!1})}catch(Mt){console.debug("Fallback focus also failed:",Mt instanceof Error?Mt.message:Mt)}}else console.log("üîï Background session completed, skipping auto-scroll for:",U)}catch(ge){if(console.error("‚ùå Background processing failed for session:",U,ge),gC(ge)){console.error("üíæ Model loading failed - showing error dialog"),vt(ge),Hs({sessionId:U,audioBlob:g,workflowId:B,transcription:z}),e.updatePatientSession(U,{status:"error",errors:["Model loading failed - awaiting user action"],processingProgress:void 0});const Te=s.patientSessions.find(Oe=>Oe.id===U);Te&&os({...Te,status:"error",errors:["Model loading failed - awaiting user action"],processingProgress:void 0}).then(()=>{console.log("üíæ Persisted model loading error session:",U)}).catch(Oe=>{console.error("Failed to persist model error session:",Oe)});return}setTimeout(()=>{e.setProcessing(!1),e.setProcessingStatus("idle");const Te=s.patientSessions.find(We=>We.id===U),Oe=Te?.patient.name||"Unknown Patient";ge.name==="AbortError"?e.updatePatientSession(U,{status:"cancelled",errors:["Processing was cancelled"],processingProgress:void 0}):(e.updatePatientSession(U,{status:"error",errors:[ge.message||"Processing failed"],processingProgress:void 0}),Te&&os({...Te,status:"error",errors:[ge.message||"Processing failed"],processingProgress:void 0}).then(()=>{console.log("üíæ Persisted processing error session:",U)}).catch(We=>{console.error("Failed to persist processing error session:",We)}),ca().errorFromBackground(`Processing failed for ${Oe}`,{suggestion:"Check LM Studio connection",category:"generation"})),zr(g,B,ge.message||"Background processing failed","",0,U,Oe)},0)}},[e,S,zr,s.patientSessions]),tr=m.useCallback(async(U,g,B,z)=>{console.log("‚ôªÔ∏è Retrying background processing for session:",U),await er(U,g,B)},[er]),_s=m.useCallback(async U=>{if(O.current=U,s.ui.isCancelling){console.log("üõë Recording completed but cancellation in progress - ignoring"),e.setCancelling(!1);return}const g=I.current||s.ui.activeWorkflow,B=C.current||s.currentSessionId;if(!g){console.error("‚ùå No active workflow selected"),e.setErrors(["No workflow selected. Please select a workflow type before recording."]);return}if(!B){console.error("‚ùå No current session found"),e.setErrors(["No active session. Please start a new recording."]);return}let z;try{const ge=new AudioContext,je=await U.arrayBuffer();z=(await ge.decodeAudioData(je)).duration,await ge.close(),console.log(`üéµ Audio duration calculated: ${z.toFixed(1)}s`)}catch(ge){console.warn("‚ö†Ô∏è Failed to calculate audio duration:",ge)}console.log("üé§ Recording completed, starting background processing for session:",B),e.setPipelineProgress({stage:"audio-processing",progress:5,stageProgress:50,details:"Validating recording format"}),e.updatePatientSession(B,{status:"transcribing",audioBlob:U,audioDuration:z,pipelineProgress:{stage:"audio-processing",progress:5,stageProgress:50,details:"Validating recording format"}}),e.setCurrentSessionId(null),C.current=null,e.setActiveWorkflow(null),I.current=null,e.setSelectedSessionId(null),e.clearRecording(),o.reset();const ne=s.patientSessions.find(ge=>ge.id===B)?.patient.name||"Patient";Vg.recordingSent(ne,g),er(B,U,g),console.log("üöÄ Background processing started for session:",B,"- ready for new recordings!")},[e,er,s.ui.isCancelling,s.currentSessionId]),Lr=m.useCallback((U,g)=>{m.startTransition(()=>{e.setVoiceActivity(U,g)})},[e]);m.useEffect(()=>{ks.current=_s,Is.current=Lr},[_s,Lr]);const oi=m.useCallback(U=>{console.log("üìã üîç USER EXPLICIT SESSION SELECTION - Selected:",{patientName:U.patient.name,sessionId:U.id,status:U.status,hasTranscription:!!U.transcription,hasResults:!!U.results,hasSummary:!!U.summary,agentType:U.agentType,currentBackgroundWork:{isRecording:Nt.isRecording,isProcessing:s.isProcessing,streaming:s.streaming,currentSessionId:s.currentSessionId}}),m.startTransition(()=>{if(console.log("üìã üéØ Loading session into isolated display state - DETAILED DIAGNOSTIC:",{sessionId:U.id,patientName:U.patient?.name,patientId:U.patient?.id,hasPatient:!!U.patient,agentType:U.agentType,hasTranscription:!!U.transcription,transcriptionLength:U.transcription?.length||0,transcriptionPreview:U.transcription?.substring(0,50)||"(empty)",hasResults:!!U.results,resultsLength:U.results?.length||0,hasSummary:!!U.summary,summaryLength:U.summary?.length||0,hasAudioBlob:!!U.audioBlob,audioDuration:U.audioDuration,timestamp:U.timestamp,status:U.status,completed:U.completed}),e.setDisplaySession(U),e.setTranscription(U.transcription||""),e.setUIMode("reviewing",{sessionId:U.id,origin:"user"}),(U.status==="processing"||U.status==="transcribing")&&(e.openOverlay("field-ingestion"),console.log("üìä Opened field-ingestion overlay for processing session:",U.id)),console.log("‚úÖ üìã SESSION SELECT COMPLETE - Session loaded in isolated display (will show even during active work):",{patientName:U.patient.name,sessionId:U.id,status:U.status,priorityLevel:"PRIORITY 1 - User Explicit Selection"}),U.agentType==="quick-letter"&&U.results&&U.status==="completed"){const g={demographics:{name:U.patient?.name||"Patient",age:U.patient?.age}},B=U.nextStepContext?{...g,...U.nextStepContext,demographics:{...g.demographics,...U.nextStepContext.demographics}}:g;U.nextStepResult?(console.log("üéØ NEXT-STEP ENGINE: Using stored suggestions for viewed Quick Letter session"),o.hydrateFromSession(U.results,B,U.id,U.nextStepResult)):(console.log("üéØ NEXT-STEP ENGINE: Generating suggestions for viewed Quick Letter session"),o.reset(),o.runInference(U.results,B,U.id,"quick-letter").then(async z=>{e.updatePatientSession(U.id,{nextStepResult:z,nextStepContext:B});try{await os({...U,nextStepResult:z,nextStepContext:B})}catch(J){console.warn("‚ö†Ô∏è Failed to persist next-step results for viewed session:",J)}}).catch(z=>{console.error("‚ùå Next-Step Engine inference failed for viewed session:",z)}))}else o.reset();setTimeout(()=>{console.log("üîç DISPLAY STATE CHECK - Post session selection:",{isDisplayingSession:s.displaySession?.isDisplayingSession,displaySessionId:s.displaySession?.displaySessionId,displayResultsLength:s.displaySession?.displayResults?.length||0,displayTranscriptionLength:s.displaySession?.displayTranscription?.length||0,activeRecordingResults:s.results?.length||0,activeRecordingTranscription:s.transcription?.length||0,isRecording:Nt.isRecording,currentSessionId:s.currentSessionId})},100)})},[e,s.displaySession,s.results,s.transcription,s.currentSessionId,Nt.isRecording]),Fi=m.useCallback(U=>{e.setSelectedSessionId(U.id),e.setUIMode("recording",{sessionId:U.id,origin:"user"})},[e]),Sa=m.useCallback(U=>{const g=Date.now();e.updatePatientSession(U.id,{reviewedAt:g,finalizedAt:g,completed:!0,status:"completed"})},[e]),ta=m.useCallback(U=>{const g=U.split(/[.!?]+/).filter(J=>J.trim().length>0);if(g.length===0)return U.substring(0,150)+"...";const B=["stenosis","regurgitation","valve","artery","diagnosis","treatment"],z=g.filter(J=>B.some(ne=>J.toLowerCase().includes(ne)));return z.length>0?z.slice(0,2).join(". ").trim()+".":g[0]?.trim()+"."},[]);m.useCallback((U,g)=>g&&g.trim()?g.trim():ta(U),[ta]);const ja=m.useCallback(()=>{if(s.displaySession.isDisplayingSession&&s.displaySession.displaySessionId){const g=s.patientSessions.find(z=>z.id===s.displaySession.displaySessionId),B={transcription:s.displaySession.displayTranscription,results:s.displaySession.displayResults,summary:s.displaySession.displaySummary,taviStructuredSections:s.displaySession.displayTaviStructuredSections,educationData:s.displaySession.displayEducationData,preOpPlanData:s.displaySession.displayPreOpPlanData,reviewData:s.displaySession.displayReviewData,rhcReport:s.displaySession.displayRhcReport,taviValidationResult:s.displaySession.displayTaviValidationResult??null,taviValidationStatus:s.displaySession.displayTaviValidationStatus,angiogramValidationResult:s.displaySession.displayAngioValidationResult??null,angiogramValidationStatus:s.displaySession.displayAngioValidationStatus,mteerValidationResult:s.displaySession.displayMteerValidationResult??null,mteerValidationStatus:s.displaySession.displayMteerValidationStatus,agent:s.displaySession.displayAgent??null,agentName:s.displaySession.displayAgentName??null,patientInfo:s.displaySession.displayPatientInfo??null,processingTime:s.displaySession.displayProcessingTime??null,processingStartTime:s.displaySession.displayProcessingStartTime??null,modelUsed:s.displaySession.displayModelUsed??null,audioDuration:s.displaySession.displayAudioDuration??null,pipelineProgress:s.displaySession.displayPipelineProgress??null,processingStatus:"complete",isDisplayingSession:!0,ocrExplanation:g?.ocrExplanation??null};return console.log("üîç getCurrentDisplayData - Displaying session:",{sessionId:s.displaySession.displaySessionId,agent:B.agent,hasResults:!!B.results,resultsLength:B.results?.length||0,hasSummary:!!B.summary,summaryLength:B.summary?.length||0,hasTranscription:!!B.transcription,transcriptionLength:B.transcription?.length||0,patientName:B.patientInfo?.name||"Unknown",hasPipelineProgress:!!B.pipelineProgress,pipelineStage:B.pipelineProgress?.stage,pipelineProgressPercent:B.pipelineProgress?.progress,hasOcrExplanation:!!B.ocrExplanation,ocrExplanationLength:B.ocrExplanation?.length||0}),B}return Nt.isRecording||s.isProcessing||s.streaming||s.currentSessionId!==null?(s.streaming&&s.results&&s.processingStatus==="complete"&&console.warn("üö® POTENTIAL STUCK STREAMING STATE DETECTED:",{streaming:s.streaming,hasResults:!!s.results,resultsLength:s.results.length,processingStatus:s.processingStatus,streamBuffer:s.streamBuffer?.length||0}),{transcription:s.transcription,results:s.results,summary:s.aiGeneratedSummary,taviStructuredSections:s.taviStructuredSections,educationData:s.educationData,preOpPlanData:s.preOpPlanData,reviewData:s.reviewData,rhcReport:s.rhcReport,taviValidationResult:s.taviValidationResult??null,taviValidationStatus:s.taviValidationStatus,angiogramValidationResult:s.angiogramValidationResult??null,angiogramValidationStatus:s.angiogramValidationStatus,mteerValidationResult:s.mteerValidationResult??null,mteerValidationStatus:s.mteerValidationStatus,agent:s.currentAgent||s.ui.activeWorkflow||s.currentSessionId&&s.patientSessions.find(g=>g.id===s.currentSessionId)?.agentType||null,agentName:s.currentAgentName,patientInfo:s.currentPatientInfo,processingTime:s.totalProcessingTime,modelUsed:null,audioDuration:(()=>{if(s.currentSessionId){const z=s.patientSessions.find(J=>J.id===s.currentSessionId)?.audioDuration??null;return console.log("üìä Audio duration from currentSessionId:",{currentSessionId:s.currentSessionId,duration:z}),z}const g=[...s.patientSessions].sort((z,J)=>(J.timestamp||0)-(z.timestamp||0)).find(z=>["processing","transcribing"].includes(z.status)),B=g?.audioDuration??null;return console.log("üìä Audio duration from fallback (most recent processing session):",{sessionId:g?.id,status:g?.status,duration:B}),B})(),pipelineProgress:s.pipelineProgress,processingStatus:s.processingStatus,isDisplayingSession:!1,ocrExplanation:s.currentSessionId?s.patientSessions.find(g=>g.id===s.currentSessionId)?.ocrExplanation??null:null}):{transcription:s.transcription,results:s.results,summary:s.aiGeneratedSummary,taviStructuredSections:s.taviStructuredSections,educationData:s.educationData,preOpPlanData:s.preOpPlanData,reviewData:s.reviewData,rhcReport:s.rhcReport,agent:s.currentAgent||s.ui.activeWorkflow||s.currentSessionId&&s.patientSessions.find(g=>g.id===s.currentSessionId)?.agentType||null,agentName:s.currentAgentName,patientInfo:s.currentPatientInfo,processingTime:s.totalProcessingTime,modelUsed:null,audioDuration:null,pipelineProgress:s.pipelineProgress,processingStatus:s.processingStatus,isDisplayingSession:!1,ocrExplanation:null}},[Nt.isRecording,s.isProcessing,s.streaming,s.currentSessionId,s.transcription,s.results,s.aiGeneratedSummary,s.currentAgent,s.currentAgentName,s.currentPatientInfo,s.processingStatus,s.displaySession]),ma=m.useCallback(async()=>{try{console.log("üë§ Extracting patient data from EMR...");const U=await chrome.tabs.query({active:!0,currentWindow:!0});console.log("üîç Current active tab:",U[0]?.url);const g=3;let B=null;for(let z=1;z<=g;z++){console.log(`üîç Attempt ${z}/${g}: Sending extraction request to content script...`);try{const J=await Promise.race([chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"extract-patient-data",data:{}}),new Promise((ne,ge)=>setTimeout(()=>ge(new Error("Patient extraction timeout")),1e4))]);if(console.log("üì¨ Received response from content script:",J),J?.success&&J?.data){const ne=J.data;console.log(`‚úÖ Patient data extraction succeeded on attempt ${z}:`,ne);const ge=ne.name&&ne.name.trim()!=="",je=ne.id&&ne.id.trim()!=="";if(ge||je)return console.log("‚úÖ Patient data validation passed - returning data"),ne;console.warn(`‚ö†Ô∏è Attempt ${z}: Extracted data lacks name and ID - will retry`),B=new Error("Extracted data lacks required patient name or ID")}else console.warn(`‚ö†Ô∏è Attempt ${z}: No valid patient data in response`),B=new Error(J?.error||"No patient data found in response")}catch(J){if(console.warn(`‚ö†Ô∏è Attempt ${z} failed:`,J.message),B=J,z<g){const ne=Math.min(1e3*Math.pow(2,z-1),5e3);console.log(`‚è≥ Waiting ${ne}ms before retry...`),await new Promise(ge=>setTimeout(ge,ne))}}}return console.error("‚ùå All patient extraction attempts failed. Last error:",B),null}catch(U){return console.error("‚ùå Critical error in patient data extraction:",U),console.error("üîç Error details:",{name:U instanceof Error?U.name:"Unknown",message:U instanceof Error?U.message:U,stack:U instanceof Error?U.stack:void 0}),null}},[]),sr=m.useCallback(async(U,g)=>{console.log("üéØ Workflow selected:",U,g?`(Quick Action field: ${g})`:""),console.log("üîç handleWorkflowSelect state:",{isRecording:Nt.isRecording,activeWorkflow:s.ui.activeWorkflow,workflowId:U,willStop:Nt.isRecording&&s.ui.activeWorkflow===U});const B=(Oe,We)=>(e.setErrors([Oe]),ca().errorFromBackground(Oe,{suggestion:We,category:"service",autoClearMs:8e3}),e.setProcessingStatus("idle"),{success:!1,error:Oe,suggestion:We});s.processingStatus==="error"&&(console.log("üîÑ Auto-recovering from error state - resetting to idle for new recording"),e.setProcessingStatus("idle"),e.setErrors([]),e.setWarnings([]),e.clearRecording()),(s.results?.trim().length>0||s.transcription?.trim().length>0)&&(console.log("üîÑ Clearing previous session before starting new workflow:",U),e.clearRecording()),s.displaySession.isDisplayingSession&&(console.log("üîÑ Clearing display session view for new recording"),e.clearDisplaySession(),e.setUIMode("idle",{sessionId:null,origin:"user"}));const z=s.patientSessions.filter(Oe=>["recording","transcribing","processing"].includes(Oe.status));if(Nt.isRecording&&s.ui.activeWorkflow===U)return console.log("üõë Stopping current recording for:",U),Nt.stopRecording(),{success:!0};if(Nt.isRecording)return B("A recording is already in progress. Stop it before starting a new one.","Stop the current recording and try again");if(z.length>=3)return B(`Too many active sessions (${z.length}). Please wait for some to complete before starting new recordings.`,"Wait for processing to finish, then retry");console.log(`üìä Current active sessions: ${z.length}/3 - proceeding with new recording`),console.log("üîç Checking Transcription server status before recording...");const J=await H.checkServerStatus(!0,{timeout:5e3,retries:1});if(e.setModelStatus({...s.modelStatus,whisperServer:J}),!J.running){console.error("‚ùå Transcription server not running");const Oe=J.error?` (${J.error})`:"";return B(`Transcription server is not running${Oe}.`,"Start it with ./dev")}console.log("üìã Extracting patient data for new recording..."),e.setProcessingStatus("extracting-patient");const ne=performance.now();let ge=null;try{Y.invalidateCache(),console.log("üóëÔ∏è Cache invalidated - extracting fresh patient data"),ge=await ma();const Oe=Math.round(performance.now()-ne);if(console.log(`‚úÖ Patient data extracted in ${Oe}ms:`,ge?.name||"No name found"),ge)e.setCurrentPatientInfo(ge);else throw new Error("No patient data found")}catch(Oe){console.error("‚ùå Patient data extraction failed:",Oe);const We=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});ge={name:`Patient ${(s.patientSessions?.length||0)+1} (${We})`,id:`Session-${Date.now()}`,dob:"",age:"",extractedAt:Date.now()},e.setCurrentPatientInfo(ge),console.log("üìù Using fallback patient info due to extraction error:",ge.name)}finally{e.setProcessingStatus("idle")}const je=`session-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,Te={id:je,patient:ge,transcription:"",results:"",agentType:U,agentName:"",timestamp:Date.now(),status:"recording",completed:!1,recordingStartTime:Date.now(),...g&&{quickActionField:g}};return e.addPatientSession(Te),e.setCurrentSessionId(je),C.current=je,console.log("üìù Created new session:",je,"for patient:",Te.patient.name),console.log("‚úÖ Transcription server is running, starting recording..."),e.setActiveWorkflow(U),I.current=U,e.setUIMode("recording",{sessionId:je,origin:"user"}),Nt.startRecording(),e.setProcessingStartTime(Date.now()),{success:!0}},[Nt,s.ui.activeWorkflow,e,ma,s.patientSessions,s.modelStatus,H]);m.useCallback(()=>{if(Nt.isRecording){console.log("üè† Home navigation blocked while recording in progress");return}console.log("üè† Returning to idle home state"),e.clearDisplaySession(),e.setSelectedSessionId(null),e.setCurrentSessionId(null),e.setActiveWorkflow(null),e.setProcessingStatus("idle"),e.setUIMode("idle",{sessionId:null,origin:"user"})},[e,Nt.isRecording]);const[$a,nn]=bs.useState(null),on=m.useCallback(async(U,g)=>{console.log("‚å®Ô∏è Type mode selected for workflow:",U,g?`(field: ${g})`:"");const B={background:{action:"background",label:"Background"},"social-history":{action:"social-history",label:"Social History"},"investigation-summary":{action:"investigation-summary",label:"Investigation Summary"},medications:{action:"medications",label:"Medications"},bloods:{action:"bloods",label:"Bloods"},imaging:{action:"imaging",label:"Imaging"}},J=g||{background:"background",medication:"medications",bloods:"bloods",imaging:"imaging","investigation-summary":"investigation-summary"}[U];if(J&&B[J]){const ge=B[J];try{return await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:ge.action,data:{}}),e.setUIMode("configuring",{sessionId:s.selectedSessionId,origin:"user"}),nn(null),{success:!0}}catch(je){return console.error(`‚ùå Failed to open ${ge.label} for manual entry:`,je),ca().errorFromBackground(`Unable to open ${ge.label} field`,{suggestion:"Try again from the EMR"}),{success:!1,error:`Failed to open ${ge.label}`,suggestion:"Try again from the EMR"}}}return["quick-letter","right-heart-cath"].includes(U)?(nn(U),e.openOverlay("paste-notes"),e.setUIMode("configuring",{sessionId:s.selectedSessionId,origin:"user"}),{success:!0}):(console.warn(`‚ö†Ô∏è Type mode not implemented for: ${U}`),{success:!1,error:`Type mode not implemented for ${U}`,suggestion:"Try using dictate mode"})},[e,s.selectedSessionId]),Ea=m.useCallback(()=>{e.clearDisplaySession(),e.openOverlay("patient-education"),e.setUIMode("configuring",{sessionId:null,origin:"user"})},[e]),ie=m.useCallback(U=>{console.log("üé§ Header dictate action:",U.id),U.agentType&&sr(U.agentType,U.quickActionField)},[sr]),Qe=m.useCallback(U=>{console.log("‚å®Ô∏è Header type action:",U.id),U.agentType&&on(U.agentType,U.quickActionField)},[on]),_e=m.useCallback(U=>{console.log("üì∑ Header vision action:",U.id),U.id==="investigation-summary"||U.agentType==="investigation-summary"?(e.openOverlay("image-investigation"),e.setUIMode("configuring",{sessionId:s.selectedSessionId,origin:"user"})):console.warn(`‚ö†Ô∏è Vision mode not implemented for: ${U.id}`)},[e,s.selectedSessionId]),St=m.useCallback(async U=>{switch(console.log("üëÜ Header click action:",U.id),U.id){case"annotate-screenshots":try{const g=chrome.runtime.getURL("src/canvas/index.html");await chrome.tabs.create({url:g,active:!0})}catch(g){console.error("‚ùå Failed to open Canvas page:",g),e.setErrors(["Unable to open Canvas. Please try again."])}break;case"patient-education":Ea();break;case"ward-list":c(!0);break;case"structural-workups":f(!0);break;case"appointment-wrap-up":d(!0);break;case"ai-medical-review":{const g=document.getElementById("ai-review-section");g&&(g.scrollIntoView({behavior:"smooth",block:"start"}),g.classList.add("ring-2","ring-violet-400","ring-offset-2"),setTimeout(()=>{g.classList.remove("ring-2","ring-violet-400","ring-offset-2")},2e3)),gt.getInstance().info("AI Medical Review","Click the button below to analyze EMR data",3e3)}break;case"profile-photo":try{await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"profile-photo",data:{}}),console.log("üì∏ Profile photo capture initiated")}catch(g){console.error("‚ùå Failed to capture profile photo:",g),e.setErrors(["Unable to capture photo. Please try again."])}break;case"bp-diary-importer":e.openOverlay("bp-diary-importer");break;case"lipid-profile-importer":e.openOverlay("lipid-profile-importer");break;case"tte-trend-importer":e.openOverlay("tte-trend-importer");break;case"batch-ai-review":console.log("üìã Opening Batch AI Review"),e.setReviewData({classification:"BATCH",findings:[],recommendations:[],summary:"Batch review initiated"});break;case"create-task":try{const g=gt.getInstance();g.info("Opening Create Task in EMR‚Ä¶","Preparing task dialog",2e3);const B=await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"create-task",data:{}});if(B?.success===!1||B?.error)throw new Error(B?.error||"Create Task failed");g.success("Create Task opened","Task dialog should be visible in EMR")}catch(g){console.error("‚ùå Failed to open Create Task in EMR:",g);const B=g instanceof Error?g.message:"Unable to open task dialog";e.setErrors([B]),ca().errorFromBackground("Unable to open task dialog in EMR",{suggestion:"Make sure a patient chart is open, then try again"})}break;case"xestro-dark-mode":try{const g=await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"xestro-dark-mode",data:{}});g?.success===!1?gt.getInstance().warning("Dark Mode",g?.error||"Only available on my.xestro.com",3e3):gt.getInstance().success("Dark Mode",g?.enabled?"Enabled":"Disabled",2e3)}catch(g){console.error("‚ùå Failed to toggle dark mode:",g)}break;case"ohif-viewer":gt.getInstance().info("Coming Soon","OHIF Viewer integration is under development",3e3);break;default:console.log("‚ö†Ô∏è Unhandled click action:",U.id)}},[e,sr,Ea]),zt=m.useCallback(()=>{console.log("üìù Wrap Up action triggered"),d(!0)},[]),ot=m.useCallback(U=>{console.log("üìÜ Appointment preset generated:",U),d(!1),(async()=>{const g=gt.getInstance();g.info("Applying appointment in EMR‚Ä¶",`${U.displayName} (${U.itemCode})`,2500);try{const B=await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"appointment-wrap-up",data:{preset:{id:"matrix-generated",displayName:U.displayName,itemCode:U.itemCode,notes:U.notes,taskMessage:U.taskMessage}}});if(B?.success===!1||B?.error)throw new Error(B?.error||"Appointment wrap-up failed");g.success("Appointment applied in EMR",`${U.displayName} (${U.itemCode})`)}catch(B){console.error("‚ùå Failed to apply appointment wrap-up in EMR:",B);const z=B instanceof Error?B.message:"Unable to apply appointment";g.error("Appointment apply failed",z),ca().errorFromBackground("Unable to apply appointment in EMR",{suggestion:"Make sure a patient is open in the EMR, then try again"})}})()},[]),yr=m.useCallback(()=>{console.log("‚öôÔ∏è Opening full settings page"),chrome.runtime.openOptionsPage()},[]),kt=m.useCallback(U=>`<div>${(ge=>ge.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"))(U).replace(/\*\*(.+?)\*\*/gs,"<strong>$1</strong>").replace(/\*(?!\*)([^*\n]+)\*(?!\*)/g,"<em>$1</em>").replace(/\n/g,"<br>")}</div>`,[]),ze=m.useCallback(async U=>{try{if(typeof ClipboardItem<"u"&&!!navigator.clipboard?.write){const B=kt(U);try{await navigator.clipboard.write([new ClipboardItem({"text/html":new Blob([B],{type:"text/html"}),"text/plain":new Blob([U],{type:"text/plain"})})])}catch(z){console.warn("HTML clipboard write failed, falling back to plain text:",z),await navigator.clipboard.writeText(U)}}else await navigator.clipboard.writeText(U);if(console.log("üìã Text copied to clipboard"),s.currentSessionId){const B=s.patientSessions.find(z=>z.id===s.currentSessionId);B&&B.status==="completed"&&!B.reviewedAt&&(Sa(B),console.log("‚úÖ Auto-marked session as complete after copy"))}}catch(g){throw console.error("Failed to copy text:",g),g}},[kt,s.currentSessionId,s.patientSessions,Sa]),[Gt,Bs]=m.useState({status:"idle",message:""}),[ls,Qs]=m.useState(!1),Vs=m.useCallback(async U=>{try{console.log("‚úèÔ∏è Transcription edited, length:",U.length),e.setTranscription(U);const g=s.transcription;if(g&&U!==g){const B={...s.transcriptionApproval,status:"edited",originalText:s.transcriptionApproval.originalText||g,currentText:U,hasBeenEdited:!0,editTimestamp:Date.now()};e.setTranscriptionApproval(B),Bs({status:"idle",message:'Edit ready - click "Perfect" to submit for training'}),console.log("‚úèÔ∏è Transcription marked as edited, ready for approval")}else if(U===g){const B={...s.transcriptionApproval,status:"pending",currentText:U,hasBeenEdited:!1};e.setTranscriptionApproval(B),Bs({status:"idle",message:""})}}catch(g){console.error("‚ùå Failed to handle transcription edit:",g),Bs({status:"error",message:"‚ö† Failed to process edit",timestamp:new Date}),setTimeout(()=>{Bs({status:"idle",message:""})},5e3)}},[s.transcription,s.transcriptionApproval,s.currentAgent,s.selectedSessionId,e]),ha=m.useCallback(async U=>{try{console.log("‚úÖ Transcription approval status changed:",U);const g=s.transcription,B=s.transcriptionApproval,z={...B,status:U,currentText:g,approvalTimestamp:U==="approved"?Date.now():B.approvalTimestamp,editTimestamp:U==="edited"?Date.now():B.editTimestamp};if(e.setTranscriptionApproval(z),U==="approved"&&g.trim()!==""){console.log("üíæ Logging transcription for ASR training");const J=B.hasBeenEdited,ne=B.originalText||g;let ge;const je=s.selectedSessionId||s.currentSessionId;je&&(ge=s.patientSessions.find(We=>We.id===je)?.audioBlob||void 0),!ge&&O.current&&(ge=O.current),await kh.getInstance().addCorrection({rawText:ne,correctedText:g,agentType:s.currentAgent||"transcription",sessionId:s.selectedSessionId||"streaming",approvalStatus:"approved",userExplicitlyApproved:!0,approvalTimestamp:Date.now(),editTimestamp:J?B.editTimestamp||Date.now():void 0},{audioBlob:ge,backupToServer:!0}),Bs({status:"saved",message:J?"‚úì Corrected transcription saved for training":"‚úì Perfect transcription saved for training",timestamp:new Date}),setTimeout(()=>{Bs({status:"idle",message:""})},3e3)}}catch(g){console.error("‚ùå Failed to handle transcription approval:",g),Bs({status:"error",message:"‚ö† Failed to save approval",timestamp:new Date}),setTimeout(()=>{Bs({status:"idle",message:""})},5e3)}},[s.transcription,s.transcriptionApproval,s.currentAgent,s.selectedSessionId,e]),sa=m.useCallback(async U=>{const g=s.displaySession.isDisplayingSession,B=g?s.displaySession.displaySessionId:s.selectedSessionId||s.currentSessionId,z=g?s.displaySession.displayTranscription:s.transcription;try{if(console.log("üîÑ Reprocessing transcription with agent:",{newAgentType:U,isViewingSession:g,targetSessionId:B,hasTranscription:!!z,transcriptionLength:z?.length||0}),!z||z.trim().length===0){console.error("‚ùå No transcription available for reprocessing"),e.setErrors(["No transcription available for reprocessing"]);return}if(s.isProcessing){console.warn("‚ö†Ô∏è Already processing, ignoring reprocess request");return}g&&(console.log("üì§ Exiting session view to show reprocessing results"),e.clearDisplaySession(),e.setTranscription(z)),e.setResults(""),e.setWarnings([]),e.setErrors([]),e.setResultsSummary(""),e.setProcessing(!0),e.setProcessingStatus("processing"),e.setCurrentAgent(U),e.setProcessingStartTime(Date.now()),B&&e.updatePatientSession(B,{status:"processing",errors:[],processingProgress:{phase:"Reprocessing",progress:0}}),e.setPipelineProgress({stage:"ai-analysis",progress:40,stageProgress:0,details:`Reprocessing with ${U}`}),console.log("üîÑ Starting agent processing with:",U),e.setMissingInfo(null);const{AgentFactory:J}=await ns(async()=>{const{AgentFactory:ge}=await import("./chunks/AgentFactory.CRiEgI8V.js");return{AgentFactory:ge}},__vite__mapDeps([25,4,2,1,5,6,10,8])),ne=await J.processWithAgent(U,z,{isReprocessing:!0},ee.current?.signal);if(console.log("‚úÖ Agent reprocessing completed"),e.setResults(ne.content),e.setMissingInfo(ne.missingInfo||null),ne.taviStructuredSections&&e.setTaviStructuredSections(ne.taviStructuredSections),"rhcData"in ne&&e.setRhcReport(ne),ne.summary&&ne.summary.trim()?(bt.debug("Setting AI-generated summary from reprocessing",{component:"summary",agent:U}),e.setAiGeneratedSummary(ne.summary)):e.setAiGeneratedSummary(void 0),e.setTimingData({agentProcessingTime:ne.processingTime,totalProcessingTime:ne.processingTime}),e.setCurrentAgentName(ne.agentName),B&&e.updatePatientSession(B,{status:"completed",results:ne.content,errors:[],warnings:ne.warnings||[],processingProgress:void 0,pipelineProgress:void 0,completedTime:Date.now()}),e.completeProcessingAtomic(s.currentSessionId||"reprocess-session",ne.content),U==="quick-letter"&&ne.content){console.log("üéØ NEXT-STEP ENGINE: Triggering inference after Quick Letter reprocessing");const ge=s.patientSessions.find(Oe=>Oe.id===B),je=ge?.patient||s.currentPatientInfo,Te={demographics:{name:je?.name||"Patient",age:je?.age}};o.reset(),o.runInference(ne.content,Te,B||"reprocess-session","quick-letter").then(async Oe=>{if(B&&e.updatePatientSession(B,{nextStepResult:Oe,nextStepContext:Te}),ge)try{await os({...ge,results:ne.content,completedTime:ge.completedTime??Date.now(),nextStepResult:Oe,nextStepContext:Te})}catch(We){console.warn("‚ö†Ô∏è Failed to persist next-step results after reprocessing:",We)}}).catch(Oe=>{console.error("‚ùå Next-Step Engine inference failed after reprocessing:",Oe)})}ne.warnings?.length&&e.setWarnings(ne.warnings),ne.errors?.length&&e.setErrors(ne.errors),e.clearPipelineProgress()}catch(J){console.error("‚ùå Agent reprocessing failed:",J),B&&e.updatePatientSession(B,{status:"error",errors:[J.message||"Reprocessing failed"],processingProgress:void 0,pipelineProgress:void 0}),e.setProcessing(!1),e.setProcessingStatus("idle"),e.clearPipelineProgress(),J.name==="AbortError"?console.log("üõë Agent reprocessing was cancelled"):e.setErrors([J.message||"Reprocessing failed"])}},[s.transcription,s.isProcessing,s.selectedSessionId,s.currentSessionId,s.displaySession.isDisplayingSession,s.displaySession.displaySessionId,s.displaySession.displayTranscription,e]),Dr=m.useCallback(async()=>{const U=s.displaySession.isDisplayingSession,g=U?s.displaySession.displaySessionId:s.selectedSessionId||s.currentSessionId,B=s.patientSessions.find(ge=>ge.id===g);let z=B?.audioBlob||O.current,J=!1;if(!z&&g){console.log("üîç No in-memory audio, checking for persisted audio on disk...");const ge=await te.getPendingAudio(g);ge&&(z=ge,J=!0,console.log("üíæ Retrieved audio from disk, size:",ge.size))}if(!z){console.error("‚ùå No audio blob available for retry transcription"),gt.getInstance().error("No Audio Available","The recording may have been lost. Try recording again.");return}if(!B){console.error("‚ùå No session found for retry transcription");return}const ne=B.agentType;console.log("üîÑ Retrying transcription for session:",{sessionId:g,agentType:ne,audioBlobSize:z.size,audioSource:J?"disk":"memory"});try{Qs(!0),g&&e.updatePatientSession(g,{status:"transcribing",errors:[],pipelineProgress:{stage:"transcribing",progress:20,stageProgress:50,details:"Retrying transcription...",modelName:s.modelStatus.whisperServer?.model||"ASR engine"}});const ge=await $g.getInstance().checkServerStatus(!0);if(!ge.running)throw new Error(`Transcription server still not running. ${ge.error||"Please run ./dev"}`);const je=await S.transcribeAudio(z,void 0,ne);if(je.startsWith("[")&&je.endsWith("]"))throw new Error(je);console.log("‚úÖ Retry transcription succeeded:",je.substring(0,100));const Oe={...B,transcription:je,audioBlob:z,pendingAudio:void 0,status:"completed",errors:[],pipelineProgress:void 0};g&&(e.updatePatientSession(g,{transcription:je,audioBlob:z,pendingAudio:void 0,status:"completed",errors:[],pipelineProgress:void 0}),U&&e.setDisplaySession(Oe),J&&te.deletePendingAudio(g).then(We=>{We&&console.log("üóëÔ∏è Cleaned up pending audio file after successful retry")}));try{await os(Oe)}catch(We){console.warn("‚ö†Ô∏è Failed to persist recovered transcription:",We)}U||e.setTranscription(je),gt.getInstance().success("Transcription Recovered","You can now reprocess with any agent."),console.log("üöÄ Starting agent processing with recovered transcription"),await sa(ne)}catch(ge){console.error("‚ùå Retry transcription failed:",ge),g&&e.updatePatientSession(g,{status:"error",errors:[ge.message||"Retry transcription failed"],pipelineProgress:void 0}),gt.getInstance().error("Retry Failed",ge.message||"Unknown error")}finally{Qs(!1)}},[s.patientSessions,s.selectedSessionId,s.currentSessionId,s.displaySession,e,S,sa,te,os]),ra=m.useCallback(async U=>{try{if(!s.transcription||!s.currentAgent)return;e.setProcessing(!0),e.setProcessingStatus("processing");const g=Object.entries(U).filter(([ne,ge])=>ge&&ge.trim().length>0).map(([ne,ge])=>`- ${ne}: ${ge.trim()}`).join(`
`),B=`${s.transcription}

Additional details provided by clinician to fill missing information:
${g}`,{AgentFactory:z}=await ns(async()=>{const{AgentFactory:ne}=await import("./chunks/AgentFactory.CRiEgI8V.js");return{AgentFactory:ne}},__vite__mapDeps([25,4,2,1,5,6,10,8])),J=await z.processWithAgent(s.currentAgent,B,{isReprocessing:!0,withMissingInfo:!0},ee.current?.signal);e.setMissingInfo(J.missingInfo||null),J.taviStructuredSections&&e.setTaviStructuredSections(J.taviStructuredSections),"rhcData"in J&&e.setRhcReport(J),e.completeProcessingAtomic(s.currentSessionId||"missing-info-session",J.content)}catch(g){console.error("Reprocess with missing info failed:",g),e.setProcessing(!1),e.setProcessingStatus("idle")}},[s.transcription,s.currentAgent,e]),pa=m.useCallback(async U=>{try{if(!s.transcription||s.currentAgent!=="tavi-workup"){console.error("‚ùå Cannot reprocess TAVI: missing transcription or incorrect agent");return}const g=s.currentSessionId;if(!g){console.error("‚ùå Cannot reprocess TAVI: no session ID");return}console.log("üîÑ Reprocessing TAVI with user-provided fields:",U),e.setProcessing(!0),e.setProcessingStatus("processing"),e.updatePatientSession(g,{status:"processing"});const B={sessionId:g,timestamp:Date.now(),userProvidedFields:U},{AgentFactory:z}=await ns(async()=>{const{AgentFactory:Te}=await import("./chunks/AgentFactory.CRiEgI8V.js");return{AgentFactory:Te}},__vite__mapDeps([25,4,2,1,5,6,10,8])),J=await z.processWithAgent("tavi-workup",s.transcription,B,ee.current?.signal);if(J.status==="awaiting_validation"){console.warn("‚ö†Ô∏è TAVI still requires validation after user input");const Te=J;e.updatePatientSession(g,{results:Te.content,taviStructuredSections:Te.structuredSections,taviValidationResult:Te.validationResult??null,taviValidationStatus:"awaiting_validation",taviExtractedData:Te.extractedData,status:"awaiting_validation"}),e.setTaviStructuredSections(Te.structuredSections??void 0),e.setTaviValidationState({result:Te.validationResult??null,status:"awaiting_validation",extractedData:Te.extractedData??null}),e.setProcessingProgress(0),e.clearPipelineProgress();return}const ne=s.transcription&&s.transcription.trim().length>0?s.transcription:s.displaySession?.displayTranscription||"",ge={results:J.content,summary:J.summary||"",taviStructuredSections:J.structuredSections,taviValidationResult:J.validationResult??null,taviValidationStatus:"complete",taviExtractedData:J.extractedData??void 0,status:"completed",completed:!0,completedTime:Date.now(),processingTime:J.processingTime,warnings:J.warnings,errors:J.errors,transcription:ne};e.updatePatientSession(g,ge),J.structuredSections&&e.setTaviStructuredSections(J.structuredSections),e.setTaviValidationState({result:null,status:void 0,extractedData:void 0});const je=s.patientSessions.find(Te=>Te.id===g);je&&await os({...je,...ge}),e.completeProcessingAtomic(g,J.content,J.summary),console.log("‚úÖ TAVI session completed after validation")}catch(g){console.error("‚ùå TAVI reprocess with validation failed:",g),e.setProcessing(!1),e.setProcessingStatus("idle"),s.currentSessionId&&e.updatePatientSession(s.currentSessionId,{status:"failed",errors:[g instanceof Error?g.message:"Unknown error"]})}},[s.transcription,s.currentAgent,s.currentSessionId,s.patientSessions,e]),ka=m.useCallback(async U=>{try{if(!s.transcription||s.currentAgent!=="angiogram-pci"){console.error("‚ùå Cannot reprocess Angio/PCI: missing transcription or incorrect agent");return}const g=s.currentSessionId;if(!g){console.error("‚ùå Cannot reprocess Angio/PCI: no session ID");return}console.log("üîÑ Reprocessing Angio/PCI with user-provided fields:",U),e.setProcessing(!0),e.setProcessingStatus("processing"),e.updatePatientSession(g,{status:"processing"});const B={sessionId:g,timestamp:Date.now(),userProvidedFields:U},{AgentFactory:z}=await ns(async()=>{const{AgentFactory:Te}=await import("./chunks/AgentFactory.CRiEgI8V.js");return{AgentFactory:Te}},__vite__mapDeps([25,4,2,1,5,6,10,8])),J=await z.processWithAgent("angiogram-pci",s.transcription,B,ee.current?.signal);if(J.status==="awaiting_validation"){console.warn("‚ö†Ô∏è Angio/PCI still requires validation after user input");const Te=J;e.updatePatientSession(g,{results:Te.content,angiogramValidationResult:Te.validationResult??null,angiogramValidationStatus:"awaiting_validation",angiogramExtractedData:Te.extractedData,status:"awaiting_validation"}),e.setAngioValidationState({result:Te.validationResult??null,status:"awaiting_validation",extractedData:Te.extractedData??null}),e.setProcessingProgress(0),e.clearPipelineProgress();return}const ne=s.transcription&&s.transcription.trim().length>0?s.transcription:s.displaySession?.displayTranscription||"",ge={results:J.content,summary:J.summary||"",angiogramValidationResult:J.validationResult??null,angiogramValidationStatus:"complete",angiogramExtractedData:J.extractedData??void 0,status:"completed",completed:!0,completedTime:Date.now(),processingTime:J.processingTime,warnings:J.warnings,errors:J.errors,transcription:ne};e.updatePatientSession(g,ge),e.setAngioValidationState({result:null,status:void 0,extractedData:void 0});const je=s.patientSessions.find(Te=>Te.id===g);je&&await os({...je,...ge}),e.completeProcessingAtomic(g,J.content,J.summary),console.log("‚úÖ Angio/PCI session completed after validation")}catch(g){console.error("‚ùå Angio/PCI reprocess with validation failed:",g),e.setProcessing(!1),e.setProcessingStatus("idle"),s.currentSessionId&&e.updatePatientSession(s.currentSessionId,{status:"failed",errors:[g instanceof Error?g.message:"Unknown error"]})}},[s.transcription,s.currentAgent,s.currentSessionId,s.patientSessions,e]),gl=m.useCallback(async U=>{try{if(!s.transcription||s.currentAgent!=="mteer"){console.error("‚ùå Cannot reprocess mTEER: missing transcription or incorrect agent");return}const g=s.currentSessionId;if(!g){console.error("‚ùå Cannot reprocess mTEER: no session ID");return}console.log("üîÑ Reprocessing mTEER with user-provided fields:",U),e.setProcessing(!0),e.setProcessingStatus("processing"),e.updatePatientSession(g,{status:"processing"});const B={sessionId:g,timestamp:Date.now(),userProvidedFields:U},{AgentFactory:z}=await ns(async()=>{const{AgentFactory:Te}=await import("./chunks/AgentFactory.CRiEgI8V.js");return{AgentFactory:Te}},__vite__mapDeps([25,4,2,1,5,6,10,8])),J=await z.processWithAgent("mteer",s.transcription,B,ee.current?.signal);if(J.status==="awaiting_validation"){console.warn("‚ö†Ô∏è mTEER still requires validation after user input");const Te=J;e.updatePatientSession(g,{results:Te.content,mteerValidationResult:Te.validationResult??null,mteerValidationStatus:"awaiting_validation",mteerExtractedData:Te.extractedData,status:"awaiting_validation"}),e.setMteerValidationState({result:Te.validationResult??null,status:"awaiting_validation",extractedData:Te.extractedData??null}),e.setProcessingProgress(0),e.clearPipelineProgress();return}const ne=s.transcription&&s.transcription.trim().length>0?s.transcription:s.displaySession?.displayTranscription||"",ge={results:J.content,summary:J.summary||"",mteerValidationResult:J.validationResult??null,mteerValidationStatus:"complete",mteerExtractedData:J.extractedData??void 0,status:"completed",completed:!0,completedTime:Date.now(),processingTime:J.processingTime,warnings:J.warnings,errors:J.errors,transcription:ne};e.updatePatientSession(g,ge),e.setMteerValidationState({result:null,status:void 0,extractedData:void 0});const je=s.patientSessions.find(Te=>Te.id===g);je&&await os({...je,...ge}),e.completeProcessingAtomic(g,J.content,J.summary),console.log("‚úÖ mTEER session completed after validation")}catch(g){console.error("‚ùå mTEER reprocess with validation failed:",g),e.setProcessing(!1),e.setProcessingStatus("idle"),s.currentSessionId&&e.updatePatientSession(s.currentSessionId,{status:"failed",errors:[g instanceof Error?g.message:"Unknown error"]})}},[s.transcription,s.currentAgent,s.currentSessionId,s.patientSessions,e]),Pi=m.useCallback(async U=>{try{if(!s.transcription||!s.currentAgent||s.currentAgent!=="right-heart-cath"){console.error("‚ùå Cannot reprocess: missing transcription or not RHC agent");return}const g=s.currentSessionId;if(!g){console.error("‚ùå Cannot reprocess: no session ID");return}console.log("üîÑ Reprocessing RHC with user-provided fields:",U),e.setProcessing(!0),e.setProcessingStatus("processing"),e.updatePatientSession(g,{status:"processing"});const B={sessionId:g,timestamp:Date.now(),userProvidedFields:U},{AgentFactory:z}=await ns(async()=>{const{AgentFactory:Te}=await import("./chunks/AgentFactory.CRiEgI8V.js");return{AgentFactory:Te}},__vite__mapDeps([25,4,2,1,5,6,10,8])),J=await z.processWithAgent("right-heart-cath",s.transcription,B,ee.current?.signal);if(console.log("‚úÖ RHC reprocessing complete"),J.status==="awaiting_validation"){console.warn("‚ö†Ô∏è RHC still requires validation after user input - this should not happen"),e.updatePatientSession(g,{rhcReport:J,status:"awaiting_validation"});return}const ne=s.transcription&&s.transcription.trim().length>0?s.transcription:s.displaySession?.displayTranscription||"",ge={results:J.content,rhcReport:J,status:"completed",completed:!0,completedTime:Date.now(),processingTime:J.processingTime,warnings:J.warnings,errors:J.errors,transcription:ne};e.updatePatientSession(g,ge);const je=s.patientSessions.find(Te=>Te.id===g);je&&await os({...je,...ge}),e.completeProcessingAtomic(g,J.content),console.log("‚úÖ RHC session completed and saved")}catch(g){console.error("‚ùå RHC reprocess with validation failed:",g),e.setProcessing(!1),e.setProcessingStatus("idle"),s.currentSessionId&&e.updatePatientSession(s.currentSessionId,{status:"failed",errors:[g instanceof Error?g.message:"Unknown error"]})}},[s.transcription,s.currentAgent,s.currentSessionId,s.patientSessions,e]),Yi=m.useCallback(async()=>{const U=ja(),g=U?.results||s.results,B=U?.agent??s.currentAgent,z=s.displaySession.isDisplayingSession?s.displaySession.displaySessionId:s.currentSessionId||s.selectedSessionId||Kt||null;if(!(!g||s.isGeneratingPatientVersion||!(B==="quick-letter"||B==="angiogram-pci")))try{console.log(`üéØ Generating patient-friendly version for ${s.currentAgent}`),e.setGeneratingPatientVersion(!0),e.setPatientVersionSessionId(z??null);let ne;if(B==="quick-letter"){const{QuickLetterAgent:ge}=await ns(async()=>{const{QuickLetterAgent:Te}=await import("./chunks/agents.D6Qu3kid.js").then(Oe=>Oe.m);return{QuickLetterAgent:Te}},__vite__mapDeps([5,6,4,2,1]));ne=await new ge().generatePatientVersion(g)}else if(B==="angiogram-pci"){const{AngiogramPCIAgent:ge}=await ns(async()=>{const{AngiogramPCIAgent:Te}=await import("./chunks/agents.D6Qu3kid.js").then(Oe=>Oe.n);return{AngiogramPCIAgent:Te}},__vite__mapDeps([5,6,4,2,1]));ne=await new ge().generatePatientVersion(g)}else throw new Error(`Patient version not supported for ${B}`);if(e.setPatientVersion(ne),console.log("‚úÖ Patient version generated successfully"),B==="quick-letter")try{await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"message-patient",data:{subject:"Patient letter",message:ne}}),console.log("üí¨ Opened patient messaging dialog with patient version prefilled")}catch(ge){console.warn("‚ö†Ô∏è Unable to open patient messaging dialog automatically:",ge)}}catch(ne){console.error("‚ùå Failed to generate patient version:",ne),e.setPatientVersion("Error generating patient version. Please try again.")}finally{e.setGeneratingPatientVersion(!1)}},[s.results,s.currentAgent,s.isGeneratingPatientVersion,s.displaySession.isDisplayingSession,s.displaySession.displaySessionId,s.currentSessionId,s.selectedSessionId,Kt,ja,e]),Ka=m.useCallback(U=>`${Kt||s.currentSessionId||"active"}::${U.trim().length}`,[Kt,s.currentSessionId]),bn=m.useCallback(()=>{if(s.displaySession.isDisplayingSession||s.currentAgent!=="angiogram-pci"||!s.results||!s.results.trim())return;const U=Ka(s.results),g=Cd(s.results);$({open:!0,tree:g,sourceKey:U})},[s.displaySession.isDisplayingSession,s.currentAgent,s.results,Ka,Cd]),Xi=m.useCallback(U=>{if(!s.results){$(J=>({...J,open:!1}));return}const g=e0(U),B=t0(s.results,g),z=Ka(B);$({open:!1,tree:U,sourceKey:z}),e.setResults(B),s.currentSessionId&&e.updatePatientSession(s.currentSessionId,{results:B})},[s.results,e,s.currentSessionId,Ka,e0,t0]),Rr=m.useCallback(()=>{if(s.results){const U=Ka(s.results);$(g=>({...g,open:!1,sourceKey:U}))}else $(U=>({...U,open:!1}))},[s.results,Ka]);m.useEffect(()=>{if(s.displaySession.isDisplayingSession||s.currentAgent!=="angiogram-pci"||s.isProcessing||s.streaming||!s.results||!s.results.trim())return;const U=Ka(s.results);if(K.sourceKey===U)return;const g=Cd(s.results);$({open:!0,tree:g,sourceKey:U})},[s.displaySession.isDisplayingSession,s.currentAgent,s.isProcessing,s.streaming,s.results,Ka,K.sourceKey,Cd]);const li=m.useCallback(async U=>{try{console.log("üîç Starting patient name validation before EMR insertion");let g="";if(s.selectedSessionId){const J=s.patientSessions.find(ne=>ne.id===s.selectedSessionId);J&&(g=J.patient.name,console.log("üìã Using selected session patient name:",g))}else if(s.currentSessionId){const J=s.patientSessions.find(ne=>ne.id===s.currentSessionId);J&&(g=J.patient.name,console.log("üìã Using current session patient name:",g))}else s.currentPatientInfo?.name&&(g=s.currentPatientInfo.name,console.log("üìã Using current patient info name:",g));let B="";try{const J=await ma();J?.name?(B=J.name,console.log("üè• Extracted fresh EMR patient name:",B)):s.currentPatientInfo?.name&&(B=s.currentPatientInfo.name,console.log("üè• Using cached EMR patient name:",B))}catch(J){console.warn("‚ö†Ô∏è Failed to extract fresh patient data, using cached:",J),s.currentPatientInfo?.name&&(B=s.currentPatientInfo.name)}if(Fu.shouldSkipValidation(g,B))return console.log("‚è© Skipping patient name validation - insufficient data"),!0;const z=Fu.validatePatientNames(g,B);return console.log("üìä Patient name validation result:",z),z.isMatch?(console.log("‚úÖ Patient names match - proceeding with insertion"),!0):(console.log("‚ö†Ô∏è Patient name mismatch detected - showing confirmation modal"),new Promise(J=>{e.setPatientMismatchData({comparison:z,textToInsert:U,onConfirm:()=>{console.log("‚úÖ User confirmed insertion despite mismatch"),e.closeOverlay("patient-mismatch"),e.setPatientMismatchData({comparison:null,textToInsert:null,onConfirm:null,onCancel:null}),J(!0)},onCancel:()=>{console.log("‚ùå User cancelled insertion due to mismatch"),e.closeOverlay("patient-mismatch"),e.setPatientMismatchData({comparison:null,textToInsert:null,onConfirm:null,onCancel:null}),J(!1)}}),e.openOverlay("patient-mismatch"),e.setUIMode("reviewing",{sessionId:s.selectedSessionId||null,origin:"auto"})}))}catch(g){return console.error("‚ùå Patient name validation failed:",g),console.log("‚ö†Ô∏è Allowing insertion due to validation error"),!0}},[s.selectedSessionId,s.currentSessionId,s.patientSessions,s.currentPatientInfo,ma,e]),lt=m.useCallback(async(U,g,B)=>{if(q.current)return console.log("‚è≥ EMR insertion already in progress - reusing existing operation"),q.current;const z=(async()=>{try{if(!await li(U)){console.log("üõë Insertion cancelled due to patient mismatch");return}console.log("‚úÖ Patient validation passed - proceeding with insertion");const ne=ja(),je=(s.patientSessions.find(It=>It.id===s.currentSessionId)||s.patientSessions.find(It=>It.id===s.displaySession.displaySessionId))?.quickActionField,Te=g?null:B||ne.agent||s.currentAgent||s.ui.activeWorkflow,Oe=g||je||Zv(Te);console.log("üîç EMR insertion debug:"),console.log("  - agentContext:",B),console.log("  - currentAgent:",s.currentAgent),console.log("  - activeWorkflow:",s.ui.activeWorkflow),console.log("  - displayData.agent:",ne.agent),console.log("  - currentAgentType:",Te),console.log("  - targetField:",g),console.log("  - quickActionField (from session):",je),console.log("  - field (final):",Oe),console.log("  - supportsFieldSpecific:",M0(Te)),console.log("  - isDisplayingSession:",ne.isDisplayingSession);const at=Te!==null&&["angiogram-pci","quick-letter"].includes(Te);if(at&&console.log("üìù Agent requires direct cursor insertion - bypassing field mapping."),Te==="bloods")try{console.log('ü©∏ BloodsAgent: Setting up Lab Form with "Generic Pathology Request"...'),await Promise.race([chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"bloods"}),new Promise((It,ft)=>setTimeout(()=>ft(new Error("Lab form setup timeout")),15e3))]),await new Promise(It=>setTimeout(It,500)),console.log('‚úÖ Lab form set to "Generic Pathology Request"'),await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"bloods-insert",data:{content:U}}),console.log("‚úÖ Blood test results inserted into Lab field")}catch(It){console.warn("‚ö†Ô∏è  Lab form setup failed (continuing anyway):",It);try{await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"bloods-insert",data:{content:U}})}catch(ft){console.error("‚ùå Blood test insertion failed:",ft)}}else if(!at&&Oe&&(je||M0(Te))){console.log(`üìù Opening ${eh(Oe)} field and appending content`);const It=15e3;try{await Promise.race([chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:Oe,data:{insertMode:"append",content:U}}),new Promise((ft,cs)=>setTimeout(()=>cs(new Error("Insertion timeout")),It))]),console.log(`‚úÖ Content appended to ${eh(Oe)} field`)}catch(ft){console.log(`‚ö†Ô∏è Insertion response delayed/missing for ${eh(Oe)}, continuing with auto-check...`,ft)}}else if(!at&&U&&U.trim().length>0){console.log("üîç No agent type but have text to insert - trying Quick Action field detection");const It=[{action:"medications",displayName:"Medications (Problem List for Phil)"},{action:"investigation-summary",displayName:"Investigation Summary"},{action:"background",displayName:"Background"}];let ft=!1;for(const cs of It)try{console.log(`üîç Attempting ${cs.displayName}...`);const As=await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:cs.action,data:{insertMode:"append",content:U}});if(As&&As.success!==!1){console.log(`‚úÖ Successfully inserted to ${cs.displayName}`),ft=!0;break}}catch{console.log(`‚ö†Ô∏è ${cs.displayName} attempt failed, trying next...`);continue}ft||(console.log("üìù All Quick Action fields failed - using generic insertion"),await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"insertText",data:{text:U}}))}else console.log("üìù Using generic EMR text insertion (no specific field mapping)"),await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"insertText",data:{text:U}}),console.log("üìù Text inserted to EMR (generic)");const et=s.currentSessionId||s.displaySession.displaySessionId;if(et){const It=s.patientSessions.find(ft=>ft.id===et);It&&It.status==="completed"&&!It.reviewedAt&&(Sa(It),console.log("‚úÖ Auto-marked session as complete after EMR insertion:",et))}const Bt=s.currentSessionId||s.displaySession.displaySessionId||s.selectedSessionId;Bt?(await ua(Bt),D(It=>{const ft=new Set(It);return ft.add(Bt),ft}),console.log("‚úÖ Auto-checked session in dropdown after EMR insertion:",Bt)):console.warn("‚ö†Ô∏è Could not auto-check session - no session ID found",{currentSessionId:s.currentSessionId,displaySessionId:s.displaySession.displaySessionId,selectedSessionId:s.selectedSessionId})}catch(J){throw console.error("Failed to insert text to EMR:",J),J}})();q.current=z;try{await z}finally{q.current=null}},[s.currentAgent,s.ui.activeWorkflow,s.currentSessionId,s.patientSessions,Sa,ua,li]),us=m.useCallback(async()=>{const U=ja();if(U.agent!=="quick-letter")return;const g=U.results;if(!g||!g.trim())return;try{await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"quick-letter",data:{}})}catch(J){console.error("‚ùå Failed to open Quick Letter in EMR:",J);return}await new Promise(J=>setTimeout(J,500));try{await lt(g,void 0,"quick-letter")}catch(J){console.error("‚ùå Failed to insert Quick Letter to EMR:",J);return}const B=s.displaySession.displaySessionId||s.selectedSessionId;if(!B)return;const z=s.patientSessions.find(J=>J.id===B);z&&z.status==="completed"&&!z.reviewedAt&&Sa(z),await ua(B),D(J=>{const ne=new Set(J);return ne.add(B),ne})},[ja,lt,Sa,ua,D,s.displaySession.displaySessionId,s.patientSessions,s.selectedSessionId]),Wr=e.setModelStatus,ci=m.useCallback(async()=>{console.log("üîç checkModelStatus called - CALL STACK:",new Error().stack),console.time("‚è±Ô∏è Total checkModelStatus Duration");try{const U=await S.checkConnection(),g=await H.checkServerStatus(!1,{timeout:5e3,retries:2}),B={...U,whisperServer:g};m.startTransition(()=>{Wr(B)}),console.timeEnd("‚è±Ô∏è Total checkModelStatus Duration")}catch(U){console.timeEnd("‚è±Ô∏è Total checkModelStatus Duration"),m.startTransition(()=>{Wr({isConnected:!1,classifierModel:"",processorModel:"",lastPing:Date.now(),latency:0,whisperServer:{running:!1,model:"whisper-large-v3-turbo",port:8001,lastChecked:Date.now(),error:U instanceof Error?U.message:"Status check failed"}})})}},[S,H,Wr]);m.useEffect(()=>{console.log("üöÄ Component mounted - performing initial model status check..."),ci()},[ci]),m.useEffect(()=>{console.log("üèóÔ∏è Starting background patient data cache..."),Y.extractAndCache();const U=()=>{document.visibilityState==="visible"&&(console.log("üëÅÔ∏è Page became visible - refreshing patient cache"),Y.refreshCache())};document.addEventListener("visibilitychange",U);const g=setInterval(()=>{document.visibilityState==="visible"&&!Y.isCacheValid()&&(console.log("üîÑ Periodic patient cache refresh"),Y.extractAndCache())},3e4);return()=>{document.removeEventListener("visibilitychange",U),clearInterval(g)}},[Y]),m.useEffect(()=>{const U=s.results&&s.processingStatus==="complete",g=s.streaming||s.currentSessionId!==null,B=!Nt.isRecording&&!s.isProcessing;U&&g&&B&&(console.warn('üö® FIXING STUCK "ACTIVELY WORKING" STATE - clearing to restore record button access',{streaming:s.streaming,currentSessionId:s.currentSessionId,processingStatus:s.processingStatus,hasResults:!!s.results}),s.streaming&&(e.setStreaming(!1),e.clearStream()),s.currentSessionId!==null&&e.setCurrentSessionId(null))},[s.streaming,s.currentSessionId,s.results,s.processingStatus,Nt.isRecording,s.isProcessing,e]),m.useEffect(()=>{const U=setInterval(()=>{e.validateState();const g=s.processingStatus==="processing"&&s.isProcessing===!1,B=s.processingStatus==="complete"&&(s.streaming||s.currentSessionId),z=s.results&&s.processingStatus==="complete"&&(s.streaming||s.currentSessionId)&&!Nt.isRecording,J=Object.values(s.patientSessions).some(ne=>ne.status==="processing"||ne.status==="transcribing");(g||B||z)&&!J&&(console.warn("üöë STUCK STATE DETECTED - Auto-recovering:",{isStuckProcessing:g,isStuckComplete:B,hasCompletedResultsButActiveState:z,processingStatus:s.processingStatus,isProcessing:s.isProcessing,streaming:s.streaming,currentSessionId:s.currentSessionId,hasResults:!!s.results}),s.results&&s.processingStatus==="complete"?(console.log("üîß Using forceUIReadyState for completed workflow with stuck indicators"),e.forceUIReadyState()):(console.log("üîß Using recoverStuckState for processing state inconsistencies"),e.recoverStuckState()))},5e3);return()=>clearInterval(U)},[s.processingStatus,s.isProcessing,s.streaming,s.currentSessionId,s.results,Nt.isRecording,e]),m.useEffect(()=>()=>{V.current&&(clearTimeout(V.current),V.current=null)},[]),m.useEffect(()=>{let U,g;const B=async()=>{try{console.log("üöÄ Initializing critical agents for improved performance...");const{AgentFactory:J}=await ns(async()=>{const{AgentFactory:ne}=await import("./chunks/AgentFactory.CRiEgI8V.js");return{AgentFactory:ne}},__vite__mapDeps([25,4,2,1,5,6,10,8]));await J.preloadCriticalAgents(),U=setTimeout(async()=>{try{console.log("üîÑ Background preloading of common agents..."),await J.preloadCommonAgents(),console.log("‚úÖ Background agent preloading completed")}catch(ne){console.warn("‚ö†Ô∏è Background preloading failed:",ne)}},5e3)}catch(J){console.warn("‚ö†Ô∏è Critical agent preloading failed:",J)}},z=()=>{g=setInterval(async()=>{try{const{AgentFactory:J}=await ns(async()=>{const{AgentFactory:ge}=await import("./chunks/AgentFactory.CRiEgI8V.js");return{AgentFactory:ge}},__vite__mapDeps([25,4,2,1,5,6,10,8])),ne=J.getMemoryEstimate();console.log(`üìä Agent memory usage: ${ne.totalAgents} agents (~${ne.estimatedMemoryMB}MB)`),ne.totalAgents>8&&(console.log("üßπ Optimizing agent cache due to high memory usage..."),J.optimizeCache())}catch(J){console.warn("‚ö†Ô∏è Memory optimization failed:",J)}},6e5)};return B(),z(),()=>{U&&clearTimeout(U),g&&clearInterval(g)}},[]),m.useEffect(()=>{const U=ca();U.registerHandler("__default_workflow__",async(B,z,J)=>B.agentType?z==="dictate"||z===void 0?sr(B.agentType,J.quickActionField):z==="type"?on(B.agentType,J.quickActionField):{success:!1,error:`Unsupported mode: ${z}`}:{success:!1,error:"Action has no associated agent type"}),["quick-letter","consultation","tavi-workup","angiogram-pci","tavi","mteer","pfo-closure","right-heart-cath","background","medications","social-history","bloods","imaging","investigation-summary"].forEach(B=>{U.registerHandler(B,async(z,J,ne)=>(console.log(`üéØ [ActionExecutor] Handler invoked for: ${z.id}`,{mode:J,agentType:z.agentType,quickActionField:ne.quickActionField||z.quickActionField}),J==="vision"&&z.id==="investigation-summary"?(e.openOverlay("image-investigation"),e.setUIMode("configuring",{sessionId:s.selectedSessionId,origin:"user"}),{success:!0}):J==="type"&&z.agentType?(console.log(`‚å®Ô∏è [ActionExecutor] Routing to handleTypeClick: ${z.agentType}`),on(z.agentType,ne.quickActionField||z.quickActionField)):z.agentType?(console.log(`üé§ [ActionExecutor] Routing to handleWorkflowSelect: ${z.agentType}`),sr(z.agentType,ne.quickActionField)):(console.error(`‚ùå [ActionExecutor] No agent type for action: ${z.id}`),{success:!1,error:"No agent type for action"})))}),U.registerHandler("annotate-screenshots",async()=>{try{const B=chrome.runtime.getURL("src/canvas/index.html");return await chrome.tabs.create({url:B,active:!0}),{success:!0}}catch{return{success:!1,error:"Unable to open Canvas",suggestion:"Please try again"}}}),U.registerHandler("patient-education",async()=>(Ea(),{success:!0})),U.registerHandler("ward-list",async()=>(c(!0),{success:!0})),U.registerHandler("structural-workups",async()=>(f(!0),{success:!0})),U.registerHandler("appointment-wrap-up",async()=>(d(!0),{success:!0})),U.registerHandler("ai-medical-review",async()=>(console.log("ü§ñ Opening AI Medical Review"),{success:!0})),U.registerHandler("profile-photo",async()=>{try{return await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"profile-photo",data:{}}),{success:!0}}catch{return{success:!1,error:"Unable to capture photo",suggestion:"Please try again"}}}),U.registerHandler("bp-diary-importer",async()=>(e.openOverlay("bp-diary-importer"),{success:!0})),U.registerHandler("lipid-profile-importer",async()=>(e.openOverlay("lipid-profile-importer"),{success:!0})),U.registerHandler("tte-trend-importer",async()=>(e.openOverlay("tte-trend-importer"),{success:!0})),U.registerHandler("batch-ai-review",async()=>(e.setReviewData({classification:"BATCH",findings:[],recommendations:[],summary:"Batch review initiated"}),{success:!0})),U.registerHandler("create-task",async()=>{try{const B=await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"create-task",data:{}});return B?.success===!1||B?.error?{success:!1,error:B?.error||"Create Task failed"}:{success:!0}}catch{return{success:!1,error:"Unable to open task dialog",suggestion:"Make sure a patient chart is open in the EMR, then try again"}}}),U.registerHandler("pre-op-plan",async(B,z,J)=>!!!s.currentPatientInfo?.name&&z!=="type"?(U.requestClarification({actionId:"pre-op-plan",message:"Please specify the procedure details",fields:[{id:"procedureType",label:"Procedure Type",type:"select",required:!0,options:[{value:"cabg",label:"CABG"},{value:"valve",label:"Valve Surgery"},{value:"tavi",label:"TAVI"},{value:"pci",label:"PCI"},{value:"other",label:"Other"}],helperText:"Select the planned procedure"},{id:"urgency",label:"Urgency",type:"select",options:[{value:"elective",label:"Elective"},{value:"urgent",label:"Urgent"},{value:"emergent",label:"Emergent"}],defaultValue:"elective"}],onSubmit:async ge=>(console.log("[Pre-Op Plan] Clarification submitted:",ge),B.agentType&&sr(B.agentType,J.quickActionField),{success:!0,data:ge}),onCancel:()=>{console.log("[Pre-Op Plan] Clarification cancelled")}}),{success:!0,data:{pending:"clarification"}}):(B.agentType&&sr(B.agentType,J.quickActionField),{success:!0})),console.log("[ActionExecutor] Registered all action handlers")},[sr,on,Ea,e,s.selectedSessionId,c,d]);const Ga=m.useMemo(()=>{const U=new Set(k);return Q.forEach(g=>U.add(g)),U},[k,Q]),Ia=s.displaySession.isDisplayingSession?s.displaySession.displayPatientInfo??null:s.currentPatientInfo??null,Zi=s.displaySession.isDisplayingSession?s.displaySession.displayAgent??null:s.ui.activeWorkflow??null,Ui=!!Ia&&!!Zi&&(s.currentPatientInfo&&s.ui.activeWorkflow&&(Nt.isRecording||s.processingStatus==="transcribing"||s.processingStatus==="processing")||s.displaySession.isDisplayingSession&&s.displaySession.displayPatientInfo&&s.displaySession.displayAgent||s.currentPatientInfo&&s.ui.activeWorkflow&&s.processingStatus==="complete"&&s.results);return t.jsxs("div",{className:"relative h-full max-h-full flex flex-col bg-surface-secondary overflow-hidden",children:[!l&&!A&&!h&&!K.open&&t.jsx(Qv,{onDictate:ie,onType:Qe,onVision:_e,onClick:St,onWrapUp:zt,onOpenFullSettings:yr,status:Nt.isRecording?"recording":s.processingStatus,isRecording:Nt.isRecording,modelStatus:s.modelStatus,patientInfo:s.currentPatientInfo,patientSessions:s.patientSessions,selectedSessionId:Vt,currentSessionId:s.currentSessionId,checkedSessionIds:Ga,persistedSessionIds:s.persistedSessionIds,onSessionSelect:oi,onRemoveSession:Qn,onClearAllSessions:e.clearPatientSessions,onToggleSessionCheck:Va,onResumeRecording:Fi,onAgentReprocess:sa,mobileJobs:ke,mobileJobsLoading:Be,mobileJobsError:re,onRefreshMobileJobs:At,onAttachMobileJob:Qt,onDeleteMobileJob:Ht,attachingMobileJobId:Pe,deletingMobileJobId:xe,attachedMobileJobIds:ce,onOpenQuickAdd:()=>x(!0),loadingActions:new Set,isDarkMode:b,onToggleDarkMode:pt}),t.jsxs("div",{className:"flex-1 min-h-0 flex flex-col overflow-hidden",children:[A&&t.jsxs("div",{className:"fixed inset-0 z-50 bg-white shadow-lg overflow-hidden flex flex-col",children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-200",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(Da,{className:"w-5 h-5 text-blue-600"}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("span",{className:"text-sm font-semibold text-gray-900",children:"Appointment Wrap Up"}),t.jsx("span",{className:"text-xs text-gray-500",children:"Build the appointment matrix, then generate"})]})]}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsx(ye,{variant:"outline",size:"sm",onClick:()=>d(!1),children:"Close"})})]}),t.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:t.jsx(FT,{onGenerate:ot})})]}),l&&t.jsx("div",{className:"fixed inset-0 z-50 bg-white shadow-lg overflow-hidden flex flex-col",children:t.jsx(ST,{onClose:()=>c(!1)})}),h&&t.jsx("div",{className:"fixed inset-0 z-50 bg-white shadow-lg overflow-hidden flex flex-col",children:t.jsx(mL,{onClose:()=>f(!1)})}),t.jsxs("div",{className:"flex-1 min-h-0 flex flex-col overflow-y-auto px-4",ref:le,id:"results-section",children:[Ui&&Ia&&Zi&&t.jsx(Ov,{patientInfo:Ia,agentType:Zi,processingStatus:s.displaySession.isDisplayingSession?"complete":s.processingStatus,isRecording:Nt.isRecording,isViewingCompletedSession:s.displaySession.isDisplayingSession,onOpenQuickLetterAndInsert:us}),Nt.isRecording&&t.jsxs("div",{className:"flex flex-col space-y-4 p-4",children:[t.jsx("div",{className:"flex-shrink-0",children:t.jsx(Vv,{isRecording:Nt.isRecording,voiceActivityLevel:Nt.voiceActivityLevel,frequencyData:Nt.frequencyData,audioLevelHistory:Nt.audioLevelHistory,recordingTime:Nt.recordingTime,activeDeviceInfo:Nt.activeDeviceInfo,onStop:Nt.stopRecording,className:"min-h-0"})}),s.ui.activeWorkflow&&Tk(s.ui.activeWorkflow)&&t.jsx("div",{className:"flex-shrink-0",children:t.jsx(Fk,{agentType:s.ui.activeWorkflow,isVisible:!0,compactMode:!0})})]}),s.processingStatus==="extracting-patient"&&t.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:t.jsx("div",{className:"max-w-md w-full bg-white rounded-lg border border-blue-200 shadow-sm p-8",children:t.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[t.jsxs("div",{className:"relative",children:[t.jsx("div",{className:"w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center",children:t.jsx("svg",{className:"w-8 h-8 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),t.jsx("div",{className:"absolute inset-0 rounded-full border-4 border-blue-400 animate-ping opacity-30"})]}),t.jsxs("div",{className:"text-center space-y-2",children:[t.jsx("h3",{className:"text-lg font-semibold text-blue-900",children:"Extracting Patient Data"}),t.jsx("p",{className:"text-sm text-blue-600",children:"Reading patient information from EMR..."}),t.jsx("p",{className:"text-xs text-gray-500",children:"This usually takes 2-5 seconds"})]}),t.jsx("div",{className:"w-full bg-blue-100 rounded-full h-1.5 overflow-hidden",children:t.jsx("div",{className:"h-full bg-gradient-to-r from-blue-400 to-blue-600 rounded-full animate-pulse",style:{width:"60%"}})})]})})}),!Nt.isRecording&&(s.processingStatus==="transcribing"||s.processingStatus==="processing")&&s.transcription&&!s.streaming&&!s.displaySession.isDisplayingSession&&s.currentSessionId&&t.jsx("div",{className:"flex-1 flex flex-col overflow-y-auto p-6 space-y-4",children:t.jsxs("div",{className:"bg-white  rounded-lg border border-blue-200 p-4",children:[t.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[t.jsx("div",{className:"w-2 h-2 bg-accent-violet rounded-full animate-pulse"}),t.jsx("h3",{className:"text-lg font-semibold text-blue-800",children:s.processingStatus==="transcribing"?"Transcribing Audio...":"Processing Report..."})]}),t.jsx(Gi,{originalTranscription:s.transcription,onTranscriptionCopy:U=>{navigator.clipboard.writeText(U),gt.getInstance().success("Transcription copied to clipboard")},onTranscriptionInsert:async U=>{try{await chrome.runtime.sendMessage({type:"EXECUTE_ACTION",action:"insert-text",data:{content:U}}),gt.getInstance().success("Transcription inserted to EMR")}catch(g){console.error("Failed to insert transcription:",g),ca().errorFromBackground("Failed to insert transcription",{suggestion:"Check EMR connection",category:"generation",autoClearMs:5e3})}},onTranscriptionEdit:U=>{e.setTranscription(U)},currentAgent:s.currentAgent,isProcessing:s.processingStatus==="processing",defaultExpanded:!0,className:"border-0 bg-transparent"}),s.processingStatus==="processing"&&t.jsxs("div",{className:"mt-3 flex items-center space-x-2 text-sm text-blue-600",children:[t.jsx("div",{className:"w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"}),t.jsxs("span",{children:["Generating ",s.currentAgent," report..."]})]})]})}),s.reviewData&&t.jsx("div",{className:"flex-shrink-0 bg-white  border-b border-gray-200",children:t.jsx(P4,{onQuickAction:async(U,g)=>{console.log("üîß Quick action:",U,g)},processingAction:""})}),v.patientEducation&&t.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto p-4",children:t.jsx(Sk,{isVisible:v.patientEducation,onClose:()=>{e.closeOverlay("patient-education"),e.setUIMode("idle",{sessionId:null,origin:"user"})},isGenerating:s.isProcessing&&s.currentAgent==="patient-education",pipelineProgress:s.pipelineProgress,processingStartTime:s.processingStartTime,onGenerate:async U=>{try{const g=`session-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,B=U.patientData||s.currentPatientInfo||{name:"Patient Education Session",id:`PE-${Date.now()}`,dob:"",age:"",extractedAt:Date.now()},z={id:g,patient:B,transcription:"",results:"",agentType:"patient-education",agentName:"Patient Education & Lifestyle Medicine",timestamp:Date.now(),status:"processing",completed:!1,processingStartTime:Date.now()};e.addPatientSession(z),e.setCurrentSessionId(g),e.setProcessing(!0),e.setCurrentAgent("patient-education"),e.setResults(""),e.setErrors([]),e.setProcessingStartTime(Date.now()),e.closeOverlay("patient-education"),e.setPipelineProgress({stage:"ai-analysis",progress:45,stageProgress:10,details:"Loading Patient Education agent",modelName:"MedGemma-27B"}),e.updatePatientSession(g,{pipelineProgress:{stage:"ai-analysis",progress:45,stageProgress:10,details:"Loading Patient Education agent",modelName:"MedGemma-27B"}});const{AgentFactory:J}=await ns(async()=>{const{AgentFactory:je}=await import("./chunks/AgentFactory.CRiEgI8V.js");return{AgentFactory:je}},__vite__mapDeps([25,4,2,1,5,6,10,8]));console.log("üéì Processing Patient Education with input:",U);const ne=await J.processWithAgent("patient-education",JSON.stringify(U),void 0,void 0,{sessionId:g,onProgress:(je,Te,Oe)=>{console.log(`üéì Patient Education Progress: ${je} (${Te}%) - ${Oe||""}`);const We=Math.max(0,Math.min(100,Te)),at=40+We*.5;e.updatePipelineProgress({stage:"ai-analysis",progress:at,stageProgress:We,details:Oe||je||"Generating lifestyle advice",modelName:"MedGemma-27B"}),e.updatePatientSession(g,{pipelineProgress:{stage:"ai-analysis",progress:at,stageProgress:We,details:Oe||je||"Generating lifestyle advice",modelName:"MedGemma-27B"}})}});e.updatePipelineProgress({stage:"generation",progress:95,stageProgress:50,details:"Formatting education plan"});const ge=Date.now()-(z.processingStartTime||Date.now());e.updatePatientSession(g,{results:ne.content,educationData:ne.educationData,status:"completed",completed:!0,processingTime:ge,completedTime:Date.now(),pipelineProgress:{stage:"generation",progress:100,stageProgress:100,details:"Complete"}}),e.setEducationData(ne.educationData),e.completeProcessingAtomic(g,ne.content),console.log("‚úÖ Patient Education generation completed")}catch(g){console.error("‚ùå Patient Education generation failed:",g);const B=g instanceof Error?g.message:String(g);s.currentSessionId&&e.updatePatientSession(s.currentSessionId,{status:"error",completed:!0,errors:[B]}),e.setErrors([`Patient Education generation failed: ${B}`]),e.setProcessingStatus("idle"),e.setProcessing(!1)}}})}),Vt&&!v.patientEducation&&!s.results&&!s.streaming&&!s.isProcessing&&s.processingStatus!=="complete"&&!s.displaySession.isDisplayingSession&&t.jsx("div",{className:"flex-1 min-h-0 flex items-center justify-center p-8",children:t.jsxs("div",{className:"max-w-md text-center space-y-4",children:[t.jsx("div",{className:"w-16 h-16 mx-auto bg-purple-50 rounded-full flex items-center justify-center",children:t.jsx("svg",{className:"w-8 h-8 text-purple-600 animate-pulse",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Loading Session"}),t.jsx("p",{className:"text-gray-600",children:(()=>{const U=s.patientSessions.find(g=>g.id===Vt);return U?`Loading ${U.patient.name}'s ${U.agentType} session...`:"Loading session data..."})()})]})]})}),!v.patientEducation&&(Vt||s.streaming||s.isProcessing||s.results&&s.processingStatus==="complete")&&t.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto py-4",children:(()=>{const U=ja(),g=s.patientSessions.find(ne=>ne.id===(U.isDisplayingSession?s.displaySession.displaySessionId:s.currentSessionId)),B=g?.source||"recording",z=U.isDisplayingSession?g?.warnings||[]:s.ui.warnings,J=U.isDisplayingSession?g?.errors||[]:s.ui.errors;return t.jsx(fv,{results:U.results,resultsSummary:U.summary||"",warnings:z,errors:J,agentType:U.agent||null,onCopy:ze,onInsertToEMR:(ne,ge)=>{lt(ne,ge,U.agent||null)},originalTranscription:U.transcription,audioDuration:U.audioDuration??void 0,onTranscriptionCopy:ze,onTranscriptionInsert:ne=>{lt(ne,void 0,U.agent||null)},onTranscriptionEdit:Vs,transcriptionSaveStatus:Gt,onAgentReprocess:sa,onRetryTranscription:Dr,isRetryingTranscription:ls,approvalState:U.isDisplayingSession?{status:"pending",originalText:U.transcription||"",currentText:U.transcription||"",hasBeenEdited:!1}:s.transcriptionApproval,onTranscriptionApprove:U.isDisplayingSession?ne=>{console.log("üß† TAVI workup transcription approval for completed session:",{status:ne,sessionId:(U.isDisplayingSession?U.patientInfo?.name:null)||"unknown",transcriptionLength:U.transcription?.length||0}),ha(ne)}:ha,missingInfo:U.isDisplayingSession?null:s.missingInfo,onReprocessWithAnswers:U.isDisplayingSession?void 0:ra,onDismissMissingInfo:U.isDisplayingSession?void 0:()=>e.clearMissingInfo(),currentAgent:U.agent,isProcessing:U.isDisplayingSession?!1:s.isProcessing,audioBlob:U.isDisplayingSession?null:O.current,pendingAudio:g?.pendingAudio,transcriptionTime:U.isDisplayingSession?null:s.transcriptionTime,agentProcessingTime:U.isDisplayingSession?null:s.agentProcessingTime,totalProcessingTime:U.isDisplayingSession?U.processingTime||null:s.totalProcessingTime,processingStatus:U.processingStatus,currentAgentName:U.agentName,isViewingSession:U.isDisplayingSession,modelUsed:U.modelUsed||null,selectedSessionId:U.isDisplayingSession&&s.displaySession.displaySessionId||Vt,selectedPatientName:U.patientInfo?.name||Kr,patientVersion:s.patientVersionSessionId===Kt?s.patientVersion:null,isGeneratingPatientVersion:s.isGeneratingPatientVersion,onGeneratePatientVersion:Yi,onOpenLesionReview:U.isDisplayingSession?void 0:bn,streaming:U.isDisplayingSession?!1:!!s.streaming,streamBuffer:U.isDisplayingSession?"":s.streamBuffer||"",ttftMs:U.isDisplayingSession?null:s.ttftMs??null,onStopStreaming:U.isDisplayingSession?void 0:Qa,taviStructuredSections:U.isDisplayingSession?U.taviStructuredSections:s.taviStructuredSections,taviValidationResult:U.isDisplayingSession?U.taviValidationResult:s.taviValidationResult,taviValidationStatus:U.isDisplayingSession?U.taviValidationStatus:s.taviValidationStatus,onTAVIReprocessWithValidation:U.isDisplayingSession?void 0:pa,taviProofModeData:it,angioProofModeData:$e,educationData:U.isDisplayingSession?U.educationData:s.educationData,preOpPlanData:U.isDisplayingSession?U.preOpPlanData:s.preOpPlanData,reviewData:U.isDisplayingSession?U.reviewData:s.reviewData,rhcReport:U.isDisplayingSession?U.rhcReport:s.rhcReport,onUpdateRhcReport:U.isDisplayingSession&&Vt?ne=>e.updateSessionRhcReport(Vt,ne):void 0,onRHCReprocessWithValidation:U.isDisplayingSession?void 0:Pi,angiogramValidationResult:U.isDisplayingSession?U.angiogramValidationResult:s.angiogramValidationResult,angiogramValidationStatus:U.isDisplayingSession?U.angiogramValidationStatus:s.angiogramValidationStatus,onAngioReprocessWithValidation:U.isDisplayingSession?void 0:ka,mteerValidationResult:U.isDisplayingSession?U.mteerValidationResult:s.mteerValidationResult,mteerValidationStatus:U.isDisplayingSession?U.mteerValidationStatus:s.mteerValidationStatus,onMTEERReprocessWithValidation:U.isDisplayingSession?void 0:gl,pipelineProgress:U.pipelineProgress||s.pipelineProgress,processingStartTime:U.processingStartTime??s.processingStartTime,sessionSource:B,revisionPanel:kr,revisionContext:Zr,onRevisionToggle:Oa,onRevisionChange:tn,onRevisionSave:sn,onRevisionDiscard:Ha,onRevisionMarkGoldenPair:Mn,isSavingRevision:w,isSavingGoldenPair:M,ocrExplanation:U.ocrExplanation??null,nextStepStatus:i.status,nextStepResult:i.result,onNextStepIntegrate:async ne=>{const ge=await o.integrateSelected(ne);ge&&(console.log("‚úÖ NEXT-STEP INTEGRATION: Letter updated, length:",ge.length),e.setResults(ge),Vt&&e.updatePatientSession(Vt,{results:ge}))},onNextStepUndo:()=>{const ne=o.undo();ne&&(console.log("‚Ü©Ô∏è NEXT-STEP UNDO: Reverted letter, length:",ne.length),e.setResults(ne),Vt&&e.updatePatientSession(Vt,{results:ne}))},canNextStepUndo:i.canUndo,isNextStepIntegrating:i.isIntegrating,nextStepIntegrationError:i.integrationError})})()}),!s.displaySession.isDisplayingSession&&!Nt.isRecording&&!s.streaming&&!Vt&&!v.patientEducation&&!s.isProcessing&&!(s.results&&s.processingStatus==="complete")&&t.jsx("div",{className:"flex-1 min-h-0 flex flex-col items-center justify-center dot-grid-background-light",children:t.jsx("div",{className:"w-full flex-1 flex items-center justify-center",children:t.jsx(g3,{position:[0,13,20],gravity:[0,-40,0],fov:20,transparent:!0,cardText:"",cardTextureUrl:rt||void 0})})})]})]}),K.open&&t.jsx(bv,{open:K.open,lesionTree:K.tree,onClose:Rr,onConfirm:Xi}),v.patientSelection&&t.jsx(Bk,{isOpen:v.patientSelection,onClose:()=>{e.closeOverlay("patient-selection"),e.setUIMode("idle",{sessionId:null,origin:"user"})},onStartReview:async U=>{console.log("üîÑ Starting batch AI review for",U.length,"patients");try{e.closeOverlay("patient-selection");const{BatchAIReviewOrchestrator:g}=await ns(async()=>{const{BatchAIReviewOrchestrator:Te}=await Promise.resolve().then(()=>b3);return{BatchAIReviewOrchestrator:Te}},void 0),B={selectedPatients:U,appointmentDate:s.ui.calendarData?.appointmentDate||new Date().toLocaleDateString(),calendarUrl:s.ui.calendarData?.calendarUrl||window.location.href},z=new g({enableCaching:!0,enableMetrics:!0,enableAdvancedDiagnostics:!0,parallelProcessing:!1,maxConcurrentOperations:1,enableCheckpoints:!0,checkpointInterval:1,retryAttempts:2});console.log("üöÄ Starting batch processing...");const J=await z.processBatch(B,Te=>{console.log("üìä Batch progress:",Te)});console.log("‚úÖ Batch processing complete:",J);const ne=`batchResults_${Date.now()}`,ge={report:J,patientResults:J.batchData.patientResults,summary:{total:J.batchData.totalPatients,successful:J.batchData.successfulReviews,failed:J.batchData.failedReviews,processingTime:J.batchData.processingEndTime-J.batchData.processingStartTime},timestamp:Date.now()};await chrome.storage.local.set({[ne]:ge});const je=chrome.runtime.getURL(`src/components/BatchReviewResults.html?key=${ne}`);await chrome.tabs.create({url:je}),console.log("üìä Batch results page opened in new tab with key:",ne)}catch(g){console.error("‚ùå Batch AI review failed:",g),e.setErrors([`Batch AI review failed: ${g instanceof Error?g.message:"Unknown error"}`])}},calendarData:s.ui.calendarData,isExtracting:s.ui.isExtractingPatients,extractError:s.ui.extractError}),v.screenshotAnnotation&&t.jsx(rC,{isOpen:v.screenshotAnnotation,onClose:()=>{e.closeOverlay("screenshot-annotation"),e.setUIMode("idle",{sessionId:null,origin:"user"})}}),v.bpDiaryImporter&&t.jsx(_k,{isOpen:v.bpDiaryImporter,onClose:()=>{e.closeOverlay("bp-diary-importer"),e.setUIMode("idle",{sessionId:null,origin:"user"})}}),v.lipidProfileImporter&&t.jsx(SI,{isOpen:v.lipidProfileImporter,onClose:()=>{e.closeOverlay("lipid-profile-importer"),e.setUIMode("idle",{sessionId:null,origin:"user"})}}),v.tteTrendImporter&&t.jsx(m3,{isOpen:v.tteTrendImporter,onClose:()=>{e.closeOverlay("tte-trend-importer"),e.setUIMode("idle",{sessionId:null,origin:"user"})}}),v.imageInvestigation&&t.jsx(Ok,{isOpen:v.imageInvestigation,isProcessing:s.isProcessing,onClose:()=>{e.closeOverlay("image-investigation"),e.setUIMode("idle",{sessionId:null,origin:"user"})},onProcess:async(U,g,B)=>{console.log("üì∑ Processing investigation image:",{investigationType:g,investigationDate:B});const z=Date.now(),J=`investigation-image-${z}`;try{e.closeOverlay("image-investigation");const ne=Zo.getInstance().getCachedData(),ge={id:J,timestamp:Date.now(),transcription:"",results:"",agentType:"investigation-summary",agentName:"Investigation Summary",patient:ne||{name:"Unknown",id:"",dob:"",age:"",extractedAt:Date.now()},status:"processing",completed:!1,processingStartTime:z};e.addPatientSession(ge),e.setSelectedSessionId(J),e.setProcessing(!0),e.setProcessingStatus("transcribing"),e.setUIMode("processing",{sessionId:J,origin:"user"}),e.setPipelineProgress({stage:"transcribing",progress:15,stageProgress:10,details:"Extracting text from image with vision OCR",modelName:Yo.getInstance().getDefaultOCRModel()});const je=Yo.getInstance(),Te=await je.extractFromImage(U,g,B);if(!Te.success)throw new Error(Te.error||"Failed to extract text from image");console.log("‚úÖ Image OCR extraction complete:",{textLength:Te.extractedText.length,processingTime:Te.processingTime});const Oe=je.formatDateForAgent(B),We=`${g} ${Oe}: ${Te.extractedText}

[Note: The above is raw text extracted from an image. Please compress into the standard abbreviated format with medical abbreviations like LV, RV, EF, MR, AR, dil, mod, etc.]`;e.updatePatientSession(J,{transcription:Te.extractedText,status:"processing"}),e.setTranscription(Te.extractedText),e.setPipelineProgress({stage:"ai-analysis",progress:50,stageProgress:30,details:"Formatting investigation summary",modelName:Tr.QUICK_MODEL}),e.setProcessingStatus("formatting");const{AgentFactory:at}=await ns(async()=>{const{AgentFactory:It}=await import("./chunks/AgentFactory.CRiEgI8V.js");return{AgentFactory:It}},__vite__mapDeps([25,4,2,1,5,6,10,8])),et=await at.processWithAgent("investigation-summary",We,{fromVision:!0,onProgress:(It,ft)=>{e.setPipelineProgress({stage:"generation",progress:Math.min(50+ft*.5,98),stageProgress:ft,details:It,modelName:Tr.QUICK_MODEL})}}),Bt=Date.now()-z;e.updatePatientSession(J,{results:et.content,status:"completed",completed:!0,processingTime:Bt,ocrExplanation:Te.extractedText,pipelineProgress:{stage:"generation",progress:100,stageProgress:100,details:`Completed in ${Math.round(Bt/1e3)}s`,modelName:Tr.QUICK_MODEL}}),e.setResults(et.content),e.completeProcessingAtomic(J,et.content),e.setSelectedSessionId(J),console.log("‚úÖ Investigation image processing complete",{sessionId:J,resultsLength:et.content.length,processingTime:Bt})}catch(ne){console.error("‚ùå Investigation image processing failed:",ne);const ge=ne instanceof Error?ne.message:"Unknown error";e.updatePatientSession(J,{status:"error",completed:!0,errors:[ge]}),e.setErrors([`Image processing failed: ${ge}`]),e.setProcessingStatus("idle"),e.setProcessing(!1),e.setUIMode("idle",{sessionId:null,origin:"user"})}}}),pe&&t.jsxs(pc,{isOpen:!0,onClose:Yt,title:"Attach Mobile Dictation",size:"md",showCloseButton:!Pe,"aria-describedby":"mobile-job-description",children:[t.jsx("div",{id:"mobile-job-description",className:"sr-only",children:"Select an agent workflow to process the mobile dictation"}),t.jsxs("div",{className:"space-y-4",children:[qe&&t.jsxs("details",{className:"border border-gray-200 rounded-lg",children:[t.jsxs("summary",{className:"px-3 py-2 cursor-pointer flex items-center gap-2 text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-t-lg",children:[t.jsx(ps,{className:"w-4 h-4"}),t.jsx("span",{children:"Preview Transcript"}),t.jsxs("span",{className:"ml-auto text-xs text-gray-500",children:[Se.split(" ").length," words"]})]}),t.jsx("div",{className:"p-3 border-t border-gray-200 bg-gray-50",children:t.jsx("p",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:Se})})]}),t.jsxs("div",{className:"flex items-center gap-3 text-xs",children:[t.jsxs("span",{className:"flex items-center gap-1 text-gray-600",children:[t.jsx(Da,{className:"w-3 h-3"}),hL(pe.created_at)]}),typeof ut=="number"&&t.jsxs("span",{className:"flex items-center gap-1 text-gray-600",children:[t.jsx(ol,{className:"w-3 h-3"}),Math.round(ut*100),"% confidence"]}),t.jsx("span",{className:"ml-auto text-emerald-600 font-medium",children:pL(pe.dictation_type)})]}),t.jsxs("fieldset",{children:[t.jsx("legend",{className:"text-xs font-semibold text-gray-700 mb-2",children:"Choose agent workflow"}),t.jsx("div",{role:"radiogroup","aria-label":"Agent workflow selection",className:"space-y-3",children:ou.map((U,g)=>{let B=0;for(let z=0;z<g;z++)B+=ou[z].agents.length;return t.jsxs("div",{className:"space-y-1.5",children:[t.jsxs("div",{className:"flex items-center gap-2 px-2",children:[t.jsx("span",{className:"text-base",children:U.icon}),t.jsx("span",{className:"text-xs font-semibold text-gray-600 uppercase tracking-wide",children:U.category})]}),t.jsx("div",{className:"space-y-1.5",children:U.agents.map((z,J)=>{const ne=we===z.value,ge=z.value===Wd(pe),je=B+J+1;return t.jsxs("label",{className:`
                                flex items-start gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all
                                ${ne?"border-violet-500 bg-violet-50":ge?"border-blue-300 bg-blue-50/50":"border-gray-200 bg-white hover:border-gray-300 hover:bg-gray-50"}
                              `,children:[t.jsx("input",{type:"radio",name:"mobile-agent",value:z.value,checked:ne,onChange:()=>de(z.value),className:"mt-0.5 w-4 h-4 text-violet-600","aria-label":`${z.label} - ${z.description}`}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:`text-sm font-semibold ${ne?"text-violet-900":"text-gray-900"}`,children:z.label}),ge&&!ne&&t.jsxs("span",{className:"flex items-center gap-1 px-1.5 py-0.5 bg-blue-100 text-blue-700 text-xs font-semibold rounded-full",children:[t.jsx(Sp,{className:"w-3 h-3 fill-current"}),"Recommended"]})]}),t.jsx("p",{className:`text-xs mt-0.5 ${ne?"text-violet-700":"text-gray-600"}`,children:z.description})]}),t.jsx("span",{className:"text-xs font-mono text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded",children:je})]},z.value)})})]},U.category)})})]}),t.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500 px-2",children:[t.jsx(NA,{className:"w-3 h-3"}),t.jsx("span",{children:"Press 1-6 to select, ‚Üµ to confirm, Esc to cancel"})]}),t.jsxs("div",{className:"flex justify-end gap-3 pt-2 border-t border-gray-200",children:[t.jsx(ye,{variant:"outline",size:"sm",onClick:Yt,disabled:Pe===pe.id,children:"Cancel"}),t.jsx(ye,{variant:"primary",size:"sm",onClick:ts,isLoading:Pe===pe.id,children:"Attach to EMR"})]})]})]}),v.patientMismatch&&t.jsx($v,{isOpen:v.patientMismatch,comparison:s.patientMismatchData.comparison,textToInsert:s.patientMismatchData.textToInsert,onConfirm:s.patientMismatchData.onConfirm||(()=>{}),onCancel:s.patientMismatchData.onCancel||(()=>{}),onRefreshEMR:async()=>{try{console.log("üîÑ Refreshing EMR patient data...");const U=await ma();U?.name&&(e.setCurrentPatientInfo({...s.currentPatientInfo,...U}),console.log("‚úÖ EMR patient data refreshed:",U.name))}catch(U){console.error("‚ùå Failed to refresh EMR patient data:",U)}}}),v.pasteNotes&&t.jsx(Hk,{isVisible:v.pasteNotes,isGenerating:s.isProcessing&&(s.currentAgent==="quick-letter"||s.currentAgent==="right-heart-cath"),onClose:()=>{e.closeOverlay("paste-notes"),e.setUIMode("idle",{sessionId:null,origin:"user"}),nn(null)},onGenerate:async U=>{const g=$a||"quick-letter";console.log("üìã Processing pasted notes for workflow:",g);try{e.closeOverlay("paste-notes");const B=await ma();if(g==="quick-letter"){const z={demographics:{name:B.name,age:B.age,dob:B.dob,gender:B.gender,mrn:B.mrn},gp:B.gp,allergies:B.allergies||[],background:B.background||"",investigation_summary:B.investigationSummary||"",medications_emr:(B.medications||[]).map(We=>({name:We.name||We,dose:We.dose||"",frequency:We.frequency||"",indication:We.indication||""}))},J=`paste-${Date.now()}`,ne={id:J,patient:B,timestamp:Date.now(),agentType:"quick-letter",agentName:"Quick Letter",status:"processing",transcription:U,results:"",completed:!1,processingTime:0,modelUsed:"",pipelineProgress:{stage:"ai-analysis",progress:0,stageProgress:0}};e.addPatientSession(ne),e.setCurrentSessionId(J),e.setSelectedSessionId(J),e.setUIMode("processing",{sessionId:J,origin:"user"}),e.setProcessing(!0),e.setProcessingStatus("processing"),e.setProcessingStartTime(Date.now());const ge=(await ns(async()=>{const{QuickLetterAgent:We}=await import("./chunks/agents.D6Qu3kid.js").then(at=>at.m);return{QuickLetterAgent:We}},__vite__mapDeps([5,6,4,2,1]))).QuickLetterAgent,Te=await new ge().processPaste(U,z,{identity_mismatch:!1,patient_friendly_requested:!1},{onProgress:We=>{console.log(`üìù Paste processing: ${We}`)}}),Oe=Date.now()-(ne.timestamp||Date.now());e.updatePatientSession(J,{status:"completed",completed:!0,results:Te.content,processingTime:Oe,pipelineProgress:{stage:"generation",progress:100,stageProgress:100}}),e.setResults(Te.content),e.setProcessing(!1),e.setProcessingStatus("idle"),e.setUIMode("idle",{sessionId:J,origin:"user"}),console.log("‚úÖ Paste letter generated successfully"),gt.getInstance().success("Letter generated from pasted notes!")}else if(g==="right-heart-cath"){const z=`rhc-paste-${Date.now()}`,J={id:z,patient:B,timestamp:Date.now(),agentType:"right-heart-cath",agentName:"Right Heart Cath Agent",status:"processing",transcription:U,results:"",rhcReport:void 0,completed:!1,processingTime:0,modelUsed:"",pipelineProgress:{stage:"ai-analysis",progress:0,stageProgress:0}};e.addPatientSession(J),e.setCurrentSessionId(z),e.setSelectedSessionId(z),e.setUIMode("processing",{sessionId:z,origin:"user"}),e.setProcessing(!0),e.setProcessingStatus("processing"),e.setProcessingStartTime(Date.now()),e.setCurrentAgent("right-heart-cath");const{RightHeartCathAgent:ne}=await ns(async()=>{const{RightHeartCathAgent:Oe}=await import("./chunks/RightHeartCathAgent.DdqpSSZN.js");return{RightHeartCathAgent:Oe}},__vite__mapDeps([26,5,6,4,2,1,27,9])),je=await new ne().process(U,{onProgress:(Oe,We,at)=>{try{e.setProcessingPhase("ai-analysis",{"ai-analysis":We},We),e.updatePatientSession(z,{pipelineProgress:{stage:"ai-analysis",progress:We,stageProgress:We,details:at}})}catch(et){console.warn("Failed to update patient session progress",et)}}}),Te=Date.now()-(J.timestamp||Date.now());e.updatePatientSession(z,{status:je.status==="awaiting_validation"?"awaiting_validation":"completed",completed:je.status!=="awaiting_validation",results:je.content,rhcReport:je,processingTime:Te,pipelineProgress:{stage:"generation",progress:100,stageProgress:100}}),e.setResults(je.content),e.setProcessing(!1),e.setProcessingStatus("idle"),e.setUIMode("idle",{sessionId:z,origin:"user"}),console.log("‚úÖ RHC report generated from typed notes"),gt.getInstance().success("RHC report generated from typed notes!")}}catch(B){console.error("‚ùå Failed to process pasted notes:",B),e.setProcessing(!1),e.setProcessingStatus("error");const z=B instanceof Error?B.message:"Unknown error";e.setErrors([`Failed to generate report: ${z}`]),ca().errorFromBackground("Failed to generate report from typed notes",{suggestion:"Check LM Studio connection",category:"generation"})}}}),v.sparsityStepper&&E&&t.jsx(Vk,{isVisible:v.sparsityStepper,missingFields:E.missingFields,prefillData:E.prefillData,onComplete:E.onComplete,onCancel:()=>{e.closeOverlay("sparsity-stepper"),T(null),gt.getInstance().info("Letter generation cancelled")}}),t.jsx(Pk,{isOpen:j,onClose:()=>e.clearSidePanel()}),t.jsx(mC,{isOpen:On,onClose:()=>Ur(!1)}),Es&&t.jsx(p3,{error:Es,onRetry:rn,onSwitchModel:an,onClose:Gr}),t.jsx(mw,{open:u,onClose:()=>x(!1),onSave:async({name:U,scratchpad:g})=>{await n.quickAddPatient(U,g),c(!0),x(!1)}}),t.jsx(Nk,{})]})});u1.displayName="OptimizedAppContent";d1.displayName="OptimizedApp";const fL=()=>{const s=e=>{e.preventDefault()};window.addEventListener("dragover",s,{capture:!0}),window.addEventListener("drop",s,{capture:!0}),document.addEventListener("dragover",s,{capture:!0}),document.addEventListener("drop",s,{capture:!0}),document.documentElement?.addEventListener?.("dragover",s,{capture:!0}),document.documentElement?.addEventListener?.("drop",s,{capture:!0}),document.body?.addEventListener?.("dragover",s,{capture:!0}),document.body?.addEventListener?.("drop",s,{capture:!0})};fL();class xL extends bs.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,r){console.error("React Error Boundary caught an error:",e,r)}render(){return this.state.hasError?t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-red-500 to-red-700 p-4 flex items-center justify-center",children:t.jsxs("div",{className:"glass rounded-2xl p-6 max-w-md text-center",children:[t.jsx("h1",{className:"text-white text-xl font-bold mb-4",children:"Extension Error"}),t.jsx("p",{className:"text-white/80 mb-4",children:"The Operator Chrome Extension encountered an error."}),t.jsx("button",{onClick:()=>window.location.reload(),className:"bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-colors",children:"Reload Extension"}),this.state.error&&t.jsxs("details",{className:"mt-4 text-left",children:[t.jsx("summary",{className:"text-white/60 cursor-pointer text-sm",children:"Error Details"}),t.jsx("pre",{className:"text-xs text-white/50 mt-2 p-2 bg-black/20 rounded",children:this.state.error.message})]})]})}):this.props.children}}window.addEventListener("error",s=>{console.error("Global error in sidepanel:",s.error)});window.addEventListener("unhandledrejection",s=>{console.error("Unhandled promise rejection in sidepanel:",s.reason)});async function by(){fC(),await xC(),console.log("üè• Initializing Operator Chrome Extension...",new Date().toISOString()),console.log("üîß Extension context check:",typeof chrome<"u"&&chrome.runtime);const s=document.getElementById("root");if(!s){console.error("‚ùå Root element not found!"),document.body.innerHTML=`
      <div style="padding: 20px; text-align: center; background: #f5f5f5; min-height: 100vh; display: flex; align-items: center; justify-content: center;">
        <div style="background: white; padding: 2rem; border-radius: 8px; border: 1px solid #e0e0e0;">
          <h1 style="color: #1a1a1a; margin-bottom: 1rem;">Mount Error</h1>
          <p style="color: #525252;">Could not find root element</p>
          <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #1a1a1a; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Reload
          </button>
        </div>
      </div>
    `;return}typeof chrome>"u"||!chrome.runtime?console.warn("‚ö†Ô∏è Chrome extension APIs not available"):console.log("‚úÖ Chrome extension context detected");try{$u(s).render(t.jsx(bs.StrictMode,{children:t.jsx(xL,{children:t.jsx(d1,{})})})),console.log("‚úÖ React app rendered successfully")}catch(e){console.error("‚ùå Failed to render React app:",e),s.innerHTML=`
      <div style="padding: 20px; text-align: center; background: #f5f5f5; min-height: 100vh; display: flex; align-items: center; justify-content: center;">
        <div style="background: white; padding: 2rem; border-radius: 8px; border: 1px solid #e0e0e0;">
          <h1 style="color: #1a1a1a; margin-bottom: 1rem;">Render Error</h1>
          <p style="color: #525252;">${e instanceof Error?e.message:"Unknown error"}</p>
          <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #1a1a1a; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Reload
          </button>
        </div>
      </div>
    `}}document.readyState==="loading"?(console.log("‚è≥ Waiting for DOM to load..."),document.addEventListener("DOMContentLoaded",by)):(console.log("‚úÖ DOM already loaded, initializing immediately"),by());typeof window<"u"&&(window.operatorDebug={version:"1.0.0",timestamp:new Date().toISOString(),userAgent:navigator.userAgent,chromeAvailable:typeof chrome<"u",extensionId:chrome?.runtime?.id||"unknown"},console.log("üîß Debug info:",window.operatorDebug));export{pc as M,Rs as _};
