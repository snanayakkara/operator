const w="2.7.0-xestro-dark-mode";console.log("üè• Operator Chrome Extension Content Script Loading...",window.location.href);console.log("üìù Content Script Version:",w);console.log("‚è∞ Load Time:",new Date().toISOString());console.log("üîß EXTRACT_EMR_DATA handler: ENABLED");console.log("üîß AI Review support: ENABLED");if(window.operatorContentScriptLoaded)console.log("üè• Content script already loaded, skipping..."),console.log("üìù Previously loaded version:",window.operatorContentScriptVersion||"unknown");else{window.operatorContentScriptLoaded=!0,window.operatorContentScriptVersion=w;class x{isInitialized=!1;emrSystem=null;currentTabId=null;blockGlobalFileDrop=!1;pathologyOverlayObserver=null;saveAndSendRunning=!1;darkModeStyleElement=null;darkModeEnabled=!1;constructor(){this.initialize()}async initialize(){if(!this.isInitialized)try{this.emrSystem=this.detectEMRSystem(),this.emrSystem?(console.log(`üè• Operator Chrome Extension: Detected ${this.emrSystem.name}`),this.setupEventListeners(),this.setupPathologyOverlayWatcher(),this.applyPersistedDarkModePreference(),this.isInitialized=!0,console.log("üè• Content script initialized successfully")):console.log("üè• EMR system not detected on this page:",window.location.href)}catch(e){console.error("Content script initialization failed:",e)}}detectEMRSystem(){return window.location.hostname.includes("my.xestro.com")?{name:"Xestro",baseUrl:"https://my.xestro.com",fields:{investigationSummary:{selector:'textarea[data-field="investigation-summary"], #investigation-summary, .investigation-summary textarea, #AddNoteArea',type:"textarea",label:"Investigation Summary",waitFor:'.XestroBoxTitle:contains("Investigation Summary")'},background:{selector:'textarea[data-field="background"], #background, .background textarea',type:"textarea",label:"Background",waitFor:'.XestroBoxTitle:contains("Background")'},medications:{selector:'textarea[data-field="medications"], #medications, .medications textarea',type:"textarea",label:"Medications"},notes:{selector:'textarea[data-field="notes"], #notes, .notes textarea, #AddNoteArea',type:"textarea",label:"Notes"},testsRequested:{selector:'.TestsRequested input[type="text"], .tests-requested-tagit input[type="text"], ul.TestsRequested li.tagit-new input',type:"input",label:"Tests Requested"},labField:{selector:"ul li input.ui-widget-content.ui-autocomplete-input, li.tagit-new input.ui-widget-content.ui-autocomplete-input, .ui-widget-content.ui-autocomplete-input:not(.PatientName):not(#PatientName), #Lab.form-control.LabForm.ui-autocomplete-input",type:"input",label:"Lab Autocomplete Field"}},selectors:{patientRecord:".patient-record, .record-view, #patient-view",noteArea:'#AddNoteArea, .note-area, textarea[placeholder*="note"]',quickLetter:'.quick-letter, .QuickLetter, [data-action="quick-letter"]',taskButton:'.task-button, [data-action="create-task"]'}}:null}setupEventListeners(){chrome.runtime.onMessage.addListener((o,n,i)=>{if(o?.type==="OPEN_CAMERA_OVERLAY"||o?.type==="OPEN_CANVAS_OVERLAY"){const r=typeof o.targetSlot=="number"?o.targetSlot:0;return this.openCameraOverlay(r),i?.({ok:!0}),!0}return!1}),chrome.runtime.onMessage.addListener((o,n,i)=>(this.handleMessage(o,n,i),!0)),document.addEventListener("keydown",o=>{this.handleKeyboardShortcut(o)});const e=o=>{if(this.blockGlobalFileDrop)return o.preventDefault(),o.stopPropagation(),!1};window.addEventListener("dragover",e,!0),window.addEventListener("drop",e,!0),new MutationObserver(o=>{this.handleDOMChanges(o)}).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","id"]}),window.addEventListener("hashchange",()=>{this.autoSearchFromHash()}),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.autoSearchFromHash()}):this.autoSearchFromHash()}cameraOverlay=null;async openCameraOverlay(e){try{this.destroyCameraOverlay();const t=document.createElement("div");t.style.position="fixed",t.style.inset="0",t.style.background="rgba(0,0,0,0.6)",t.style.backdropFilter="blur(4px)",t.style.zIndex="2147483647",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';const o=document.createElement("div");o.style.width="min(960px, 92vw)",o.style.maxWidth="960px",o.style.background="#fff",o.style.borderRadius="24px",o.style.boxShadow="0 20px 60px rgba(0,0,0,0.2)",o.style.overflow="hidden",o.style.display="flex",o.style.flexDirection="column";const n=document.createElement("div");n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center",n.style.padding="16px 20px",n.style.borderBottom="1px solid #e5e7eb";const i=document.createElement("div"),r=document.createElement("div");r.textContent=`Use Camera (Slot ${e+1})`,r.style.fontSize="18px",r.style.fontWeight="700",r.style.color="#111827";const a=document.createElement("div");a.textContent="Continuity Camera works when this page is foregrounded",a.style.fontSize="13px",a.style.color="#6b7280",a.style.marginTop="4px",i.appendChild(r),i.appendChild(a);const s=document.createElement("button");s.textContent="‚úï",s.style.border="none",s.style.background="transparent",s.style.cursor="pointer",s.style.fontSize="18px",s.style.color="#6b7280",s.onclick=()=>this.destroyCameraOverlay(),n.appendChild(i),n.appendChild(s);const c=document.createElement("div");c.style.padding="16px 20px",c.style.display="grid",c.style.gap="12px";const l=document.createElement("div"),d=document.createElement("label");d.textContent="Camera source",d.style.fontSize="14px",d.style.fontWeight="600",d.style.color="#111827",d.style.display="block",d.style.marginBottom="4px",d.setAttribute("for","operator-camera-select");const u=document.createElement("div");u.style.display="flex",u.style.alignItems="center",u.style.gap="8px";const m=document.createElement("select");m.id="operator-camera-select",m.style.width="100%",m.style.padding="10px 12px",m.style.border="1px solid #d1d5db",m.style.borderRadius="10px",m.style.fontSize="14px",m.style.color="#111827",m.style.background="#fff",m.style.outline="none",m.onchange=()=>this.startCamera(m.value);const g=document.createElement("button");g.textContent="Refresh",g.style.padding="10px 12px",g.style.border="1px solid #d1d5db",g.style.borderRadius="10px",g.style.background="#fff",g.style.cursor="pointer",g.onclick=()=>this.enumerateAndStart(m),u.appendChild(m),u.appendChild(g),l.appendChild(d),l.appendChild(u);const p=document.createElement("div");p.textContent="Unlock your iPhone, keep Wi‚ÄëFi & Bluetooth on, then click Refresh if ‚ÄúiPhone Camera‚Äù is missing.",p.style.fontSize="12px",p.style.color="#6b7280";const f=document.createElement("video");f.autoplay=!0,f.playsInline=!0,f.muted=!0,f.style.width="100%",f.style.aspectRatio="16 / 9",f.style.background="#000",f.style.borderRadius="16px",f.style.objectFit="cover";const h=document.createElement("div");h.style.display="flex",h.style.justifyContent="flex-end",h.style.gap="10px",h.style.paddingTop="8px";const b=document.createElement("button");b.textContent="Cancel",b.style.padding="10px 16px",b.style.border="1px solid #d1d5db",b.style.borderRadius="10px",b.style.background="#fff",b.style.cursor="pointer",b.onclick=()=>this.destroyCameraOverlay();const y=document.createElement("button");y.textContent="Capture",y.style.padding="10px 16px",y.style.border="none",y.style.borderRadius="10px",y.style.background="linear-gradient(135deg, #6366f1, #8b5cf6)",y.style.color="#fff",y.style.cursor="pointer",y.onclick=()=>this.captureFrame(e),h.appendChild(b),h.appendChild(y),c.appendChild(l),c.appendChild(p),c.appendChild(f),c.appendChild(h),o.appendChild(n),o.appendChild(c),t.appendChild(o),document.body.appendChild(t),this.cameraOverlay={container:t,video:f,stream:null,deviceSelect:m,refreshButton:g,targetSlot:e},await this.enumerateAndStart(m)}catch(t){console.error("Failed to open camera overlay:",t)}}async enumerateAndStart(e){try{let t=null;try{t=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1})}catch(r){console.warn("Camera permission request failed before enumerate:",r)}finally{t&&t.getTracks().forEach(r=>r.stop())}const n=(await navigator.mediaDevices.enumerateDevices()).filter(r=>r.kind==="videoinput");e.innerHTML="",n.forEach((r,a)=>{const s=document.createElement("option");s.value=r.deviceId,s.textContent=r.label||`Camera ${a+1}`,e.appendChild(s)});const i=n.find(r=>r.label.toLowerCase().includes("iphone"))||n.find(r=>r.label.toLowerCase().includes("continuity"))||n[0];i&&(e.value=i.deviceId,await this.startCamera(i.deviceId))}catch(t){console.error("Failed to enumerate cameras:",t)}}async startCamera(e){if(this.cameraOverlay)try{this.cameraOverlay.stream&&this.cameraOverlay.stream.getTracks().forEach(o=>o.stop());const t=await navigator.mediaDevices.getUserMedia({video:e?{deviceId:{exact:e}}:!0,audio:!1});this.cameraOverlay.video.srcObject=t,this.cameraOverlay.stream=t}catch(t){console.error("Failed to start camera:",t)}}captureFrame(e){if(!this.cameraOverlay?.video)return;const t=this.cameraOverlay.video,{videoWidth:o,videoHeight:n}=t;if(!o||!n)return;const i=Math.min(o,n),r=(o-i)/2,a=(n-i)/2,s=document.createElement("canvas");s.width=1024,s.height=1024;const c=s.getContext("2d");if(!c)return;c.drawImage(t,r,a,i,i,0,0,1024,1024);const l=s.toDataURL("image/png");chrome.runtime.sendMessage({type:"CAMERA_OVERLAY_RESULT",payload:{slot:e,dataUrl:l,width:1024,height:1024}}),this.destroyCameraOverlay()}destroyCameraOverlay(){this.cameraOverlay?.stream&&this.cameraOverlay.stream.getTracks().forEach(e=>e.stop()),this.cameraOverlay?.container&&this.cameraOverlay.container.remove(),this.cameraOverlay=null}async handleMessage(e,t,o){console.log("üè• Content script received message:",e),console.log("üìù Content script version:",w,"at",new Date().toISOString()),console.log("üîß Available message types: EXTRACT_EMR_DATA, EXECUTE_ACTION, SHOW_SCREENSHOT_INSTRUCTIONS, START_CLIPBOARD_MONITORING");try{const{type:n,action:i,data:r}=e;if(console.log("üì® Processing message type:",n,"action:",i),n==="PING"){o({success:!0,ready:!0,version:w});return}if(n==="SET_FILE_DROP_GUARD"){this.blockGlobalFileDrop=!!e.enabled,console.log("üõ°Ô∏è File drop guard set to",this.blockGlobalFileDrop),o({success:!0,enabled:this.blockGlobalFileDrop});return}if(n==="PAGE_STATUS_CHECK"){try{const a=this.getPageStatus();o({success:!0,status:a})}catch(a){o({success:!1,error:a instanceof Error?a.message:"Page status check failed"})}return}if(n==="CHECK_XESTRO_BOXES"){try{const a=document.querySelectorAll(".XestroBox").length,s=a>0;console.log(`üìã XestroBox check: found ${a} boxes, hasPatientData: ${s}`),o({success:!0,found:s,count:a,url:window.location.href})}catch(a){o({success:!1,error:a instanceof Error?a.message:"XestroBox check failed"})}return}if(n==="SHOW_SCREENSHOT_INSTRUCTIONS"){await this.showScreenshotInstructions(r),o({success:!0});return}if(n==="CLOSE_SCREENSHOT_INSTRUCTIONS"){this.closeScreenshotModal(),o({success:!0});return}if(n==="START_CLIPBOARD_MONITORING"){console.log("üì∏ Content script received START_CLIPBOARD_MONITORING request"),this.startClipboardMonitoring(r.timeoutMs||3e4),o({success:!0});return}if(n==="EXTRACT_EMR_DATA"){console.log("üìã Received EXTRACT_EMR_DATA request - HANDLER FOUND!"),console.log("üìã Request data:",r),console.log("üìã Extracting fields:",r?.fields||["background","investigations","medications"]);try{const a=await this.extractEMRData(r?.fields||["background","investigations","medications"]);console.log("üìã EMR extraction completed successfully:",a),o({success:!0,data:a})}catch(a){console.error("üìã EMR extraction failed:",a),o({success:!1,error:a instanceof Error?a.message:"EMR extraction failed"})}return}if(n==="EXTRACT_EMR_DATA_AI_REVIEW"){console.log("ü§ñ Received EXTRACT_EMR_DATA_AI_REVIEW request - NON-INVASIVE EXTRACTION"),console.log("ü§ñ Request data:",r),console.log("ü§ñ Extracting fields (non-invasive):",r?.fields||["background","investigations","medications-problemlist"]);try{const a=await this.extractEMRDataForAIReview(r?.fields||["background","investigations","medications-problemlist"]);console.log("ü§ñ AI Review EMR extraction completed successfully:",a),o({success:!0,data:a})}catch(a){console.error("ü§ñ AI Review EMR extraction failed:",a),o({success:!1,error:a instanceof Error?a.message:"AI Review EMR extraction failed"})}return}if(n==="EXTRACT_PATIENT_DATA"){console.log("üë§ Received EXTRACT_PATIENT_DATA request");try{const a=this.extractPatientData();console.log("üë§ Patient data extraction completed:",a),o({success:!0,data:a})}catch(a){console.error("üë§ Patient data extraction failed:",a),o({success:!1,error:a instanceof Error?a.message:"Patient data extraction failed"})}return}if(n==="EXTRACT_CUSTOM_NOTE_CONTENT"){console.log("üìã Received EXTRACT_CUSTOM_NOTE_CONTENT request for field:",e.fieldName);try{const a=await this.extractCustomNoteContent(e.fieldName);console.log(`üìã Custom note extraction completed for "${e.fieldName}": ${a.length} chars`),o({success:!0,data:a})}catch(a){console.error(`üìã Custom note extraction failed for "${e.fieldName}":`,a),o({success:!1,error:a instanceof Error?a.message:"Custom note extraction failed"})}return}if(n==="extract-calendar-patients"){console.log("üìÖ Received extract-calendar-patients request");try{const a=await this.extractCalendarPatients();console.log("üìÖ Calendar patient extraction completed:",a),o({success:!0,data:a})}catch(a){console.error("üìÖ Calendar patient extraction failed:",a),o({success:!1,error:a instanceof Error?a.message:"Calendar extraction failed"})}return}if(n!=="EXECUTE_ACTION"){console.log("‚ùå Unknown message type:",n),o({error:"Unknown message type"});return}switch(console.log(`üè• Executing action: ${i}`),i){case"insertText":await this.insertText(r.text,r.fieldType),o({success:!0});break;case"openField":await this.openFieldByType(r.fieldType),o({success:!0});break;case"investigation-summary":if(r?.extractOnly){const a=await this.extractFieldContent("Investigation Summary");o({success:!0,data:a})}else if(r?.insertMode==="append"&&r?.content){console.log("üìù Investigation Summary: Opening field and appending content"),await this.openInvestigationSummary(),await this.wait(500);const a=await this.findNoteArea();if(a)await this.insertTextAtEndOfField(a,r.content),console.log("‚úÖ Content appended to Investigation Summary field");else throw console.error("‚ùå Could not find note area for appending"),new Error("Note area not found for content insertion");o({success:!0})}else await this.openInvestigationSummary(),r?.content&&(await this.wait(500),await this.insertFormattedSummary(r.content)),o({success:!0});break;case"background":if(r?.extractOnly){const a=await this.extractFieldContent("Background");o({success:!0,data:a})}else if(r?.insertMode==="append"&&r?.content){console.log("üìù Background: Opening field and appending content"),await this.openBackground(),await this.wait(500);const a=await this.findNoteArea();if(a)await this.insertTextAtEndOfField(a,r.content),console.log("‚úÖ Content appended to Background field");else throw console.error("‚ùå Could not find note area for appending"),new Error("Note area not found for content insertion");o({success:!0})}else await this.openBackground(),o({success:!0});break;case"medications":if(r?.extractOnly){const a=await this.extractFieldContent("Medications (Problem List for Phil)")||await this.extractFieldContent("Medications");o({success:!0,data:a})}else if(r?.insertMode==="append"&&r?.content){console.log("üìù Medications: Opening field and appending content"),await this.openMedications(),await this.wait(500);const a=await this.findNoteArea();if(a)await this.insertTextAtEndOfField(a,r.content),console.log("‚úÖ Content appended to Medications field");else throw console.error("‚ùå Could not find note area for appending"),new Error("Note area not found for content insertion");o({success:!0})}else await this.openMedications(),o({success:!0});break;case"social-history":if(r?.insertMode==="append"&&r?.content){console.log("üìù Social History: Opening field and appending content"),await this.openSocialHistory(),await this.wait(500);const a=await this.findNoteArea();if(a)await this.insertTextAtEndOfField(a,r.content),console.log("‚úÖ Content appended to Social History field");else throw console.error("‚ùå Could not find note area for appending"),new Error("Note area not found for content insertion");o({success:!0})}else await this.openSocialHistory(),o({success:!0});break;case"bloods":await this.clickPathologyButton(),await this.setupLabField(),o({success:!0});break;case"bloods-insert":await this.insertIntoLabField(r.content),o({success:!0});break;case"imaging":await this.clickRadiologyButton(),o({success:!0});break;case"message-patient":if(!r?.message||typeof r.message!="string")throw new Error("Message text is required for patient messaging");await this.openMessagingWithPrefill(typeof r.subject=="string"?r.subject:null,r.message),o({success:!0});break;case"extract-patient-data":{const a=this.extractPatientData();o(a?{success:!0,data:a}:{success:!1,error:"No patient data found"});break}case"quick-letter":await this.openQuickLetter(),o({success:!0});break;case"create-task":await this.createTask(),o({success:!0});break;case"appointment-wrap-up":await this.appointmentWrapUp(r),o({success:!0});break;case"profile-photo":await this.handleProfilePhoto(r),o({success:!0});break;case"xestro-dark-mode":{const a=this.toggleXestroDarkMode(typeof r?.force=="boolean"?r.force:void 0);o(a===null?{success:!1,error:"Dark mode is only available on my.xestro.com"}:{success:!0,enabled:a});break}case"save":await this.saveNote(),o({success:!0});break;case"ai-medical-review":console.warn("‚ö†Ô∏è AI medical review should be processed entirely in side panel"),o({success:!0,message:"AI medical review should use side panel processing only"});break;case"navigate-to-patient":console.log("üß≠ Received navigate-to-patient request");try{await this.navigateToPatient(r.fileNumber,r.patientName),o({success:!0})}catch(a){console.error("üß≠ Patient navigation failed:",a),o({success:!1,error:a instanceof Error?a.message:"Navigation failed"})}break;case"GO_TO_PATIENT_BY_FILING":console.log("üîç Received GO_TO_PATIENT_BY_FILING request");try{await this.searchPatientByFiling(r.fileNumber),o({success:!0})}catch(a){console.error("üîç Patient search by filing failed:",a),o({success:!1,error:a instanceof Error?a.message:"Search failed"})}break;case"activate-patient-by-element":console.log("üñ±Ô∏è Received activate-patient-by-element request");try{await this.activatePatientByElement(r.patientSelector||r.patientIndex),o({success:!0})}catch(a){console.error("üñ±Ô∏è Patient activation failed:",a),o({success:!1,error:a instanceof Error?a.message:"Patient activation failed"})}break;case"double-click-patient":console.log("üëÜ SWITCH CASE HIT: double-click-patient"),console.log("üëÜ Received double-click-patient request with data:",r),console.log("üëÜ About to call this.doubleClickPatient method...");try{await this.doubleClickPatient(r.patientName,r.patientId),console.log("üëÜ doubleClickPatient method completed successfully"),o({success:!0})}catch(a){console.error("üëÜ Double-click patient failed:",a),o({success:!1,error:a instanceof Error?a.message:"Double-click patient failed"})}break;case"navigate-to-patient-record":console.log("üè• SWITCH CASE HIT: navigate-to-patient-record"),console.log("üè• Received navigate-to-patient-record request"),console.log("üè• About to call this.navigateToPatientRecord method...");try{await this.navigateToPatientRecord(),console.log("üè• navigateToPatientRecord method completed successfully"),o({success:!0})}catch(a){console.error("üè• Navigate to patient record failed:",a),o({success:!1,error:a instanceof Error?a.message:"Navigate to patient record failed"})}break;case"navigate-to-appointment-book":console.log("üìÖ Received navigate-to-appointment-book request");try{await this.navigateToAppointmentBook(),o({success:!0})}catch(a){console.error("üìÖ Navigate to appointment book failed:",a),o({success:!1,error:a instanceof Error?a.message:"Navigate to appointment book failed"})}break;case"extract-calendar-patients":console.log("üìÖ Received extract-calendar-patients request (via EXECUTE_ACTION)");try{const a=await this.extractCalendarPatients();console.log("üìÖ Calendar patient extraction completed:",a),o({success:!0,data:a})}catch(a){console.error("üìÖ Calendar patient extraction failed:",a),o({success:!1,error:a instanceof Error?a.message:"Calendar extraction failed"})}break;case"extract-patient-fields":console.log("üìã SWITCH CASE HIT: extract-patient-fields"),console.log("üìã Received extract-patient-fields request"),console.log("üìã About to call extractPatientFields method...");try{const a=await this.extractPatientFields();console.log("üìã extractPatientFields completed, sending response:",a),o({success:!0,data:a})}catch(a){console.error("üìã Extract patient fields failed:",a),o({success:!1,error:a instanceof Error?a.message:"Extract patient fields failed"})}break;default:console.log(`‚ùå DEFAULT CASE HIT: Unknown action "${i}"`),console.log("‚ùå Available SPA actions: double-click-patient, navigate-to-patient-record, extract-patient-fields"),o({error:"Unknown action"})}}catch(n){console.error("Content script message handling error:",n),o({error:n instanceof Error?n.message:"Unknown error"})}}ensureDarkModeStyles(){if(this.darkModeStyleElement)return;const e=document.createElement("style");e.id="__operator_xestro_dark_mode__",e.textContent=`
      html.operator-xestro-dark-mode {
        filter: invert(0.92) hue-rotate(180deg) saturate(0.9);
        color-scheme: dark;
        transition: filter 0.2s ease;
      }

      html.operator-xestro-dark-mode img,
      html.operator-xestro-dark-mode video,
      html.operator-xestro-dark-mode picture,
      html.operator-xestro-dark-mode canvas,
      html.operator-xestro-dark-mode iframe {
        filter: invert(1) hue-rotate(180deg) saturate(1);
      }

      html.operator-xestro-dark-mode ::selection {
        background: rgba(125, 211, 252, 0.35);
      }
    `,document.head.appendChild(e),this.darkModeStyleElement=e}toggleXestroDarkMode(e){if(!this.emrSystem||this.emrSystem.name!=="Xestro")return console.warn("üåô Dark mode toggle ignored: Xestro EMR not detected"),null;this.ensureDarkModeStyles();const t=this.darkModeEnabled||document.documentElement.classList.contains("operator-xestro-dark-mode"),o=typeof e=="boolean"?e:!t;document.documentElement.classList.toggle("operator-xestro-dark-mode",o),this.darkModeEnabled=o;try{localStorage.setItem("operator-xestro-dark-mode",o?"true":"false")}catch(n){console.debug("Unable to persist dark mode preference:",n)}return console.log(`üåô Xestro dark mode ${o?"enabled":"disabled"}`),o}applyPersistedDarkModePreference(){if(!(!this.emrSystem||this.emrSystem.name!=="Xestro"))try{localStorage.getItem("operator-xestro-dark-mode")==="true"&&(console.log("üåô Restoring Xestro dark mode from previous session"),this.toggleXestroDarkMode(!0))}catch(e){console.debug("Skipping dark mode restore:",e)}}handleKeyboardShortcut(e){if(!(!(e.ctrlKey||e.metaKey)||!e.shiftKey))switch(e.key.toLowerCase()){case"i":e.preventDefault(),this.openInvestigationSummary();break;case"b":e.preventDefault(),this.openBackground();break;case"m":e.preventDefault(),this.openMedications();break;case"s":e.preventDefault(),this.openSocialHistory();break;case"l":e.preventDefault(),this.openQuickLetter();break;case"t":e.preventDefault(),this.createTask();break}}handleDOMChanges(e){for(const t of e)t.type==="childList"&&t.addedNodes.forEach(o=>{o.nodeType===Node.ELEMENT_NODE&&o.matches?.(".note-area, textarea, .field-container")&&this.updateFieldMappings()})}async insertText(e,t){let o=null;if(t&&this.emrSystem?.fields[t]?t==="investigationSummary"||t==="investigation-summary"?(console.log("üìù Special handling for Investigation Summary insertion - waiting for AddNoteArea"),o=await this.findElement("#AddNoteArea",3e3),o?console.log("‚úÖ Found AddNoteArea for Investigation Summary insertion"):(console.log("‚ö†Ô∏è AddNoteArea not found, falling back to Investigation Summary textarea"),o=await this.findElement(this.emrSystem.fields[t].selector))):o=await this.findElement(this.emrSystem.fields[t].selector):(o=document.activeElement,this.isTextInputElement(o)||(o=await this.findActiveNoteArea())),!o)throw new Error("No suitable text input found");await this.insertTextIntoElement(o,e)}async openFieldByType(e){switch(console.log(`üìù Opening EMR field by type: ${e}`),e){case"investigationSummary":case"investigation-summary":console.log("üìù Using openInvestigationSummary() for field opening"),await this.openInvestigationSummary();break;case"background":console.log("üìù Using openBackground() for field opening"),await this.openBackground();break;case"medications":console.log("üìù Using openMedications() for field opening"),await this.openMedications();break;default:if(console.log(`üìù Using fallback field opening for: ${e}`),!this.emrSystem?.fields[e])throw new Error(`Unknown field type: ${e}`);{const t=this.emrSystem.fields[e],o=await this.findElement(t.selector,5e3);if(o)this.focusElement(o);else throw new Error(`Field ${e} not found`)}break}console.log(`‚úÖ Field ${e} opened successfully`)}async insertTextIntoElement(e,t){if(e.tagName==="TEXTAREA"||e.tagName==="INPUT"){const o=e,n=o.selectionStart||0,i=o.selectionEnd||0,r=o.value,a=r.slice(0,n)+t+r.slice(i);o.value=a;const s=n+t.length;o.setSelectionRange(s,s),o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}))}else if(e.contentEditable==="true"){const o=window.getSelection();if(o&&o.rangeCount>0){const n=o.getRangeAt(0);n.deleteContents(),n.insertNode(document.createTextNode(t)),n.collapse(!1),o.removeAllRanges(),o.addRange(n)}else e.textContent+=t;e.dispatchEvent(new Event("input",{bubbles:!0}))}e.focus()}async insertFormattedSummary(e){console.log("üìù Inserting formatted investigation summary:",e);try{const t=await this.findInvestigationSummaryTextarea();if(!t){console.error("‚ùå No Investigation Summary textarea (AddNoteArea) found");return}await this.insertTextAtEndOfField(t,e),console.log("‚úÖ Successfully inserted formatted investigation summary")}catch(t){console.error("‚ùå Error inserting formatted summary:",t)}}async findInvestigationSummaryTextarea(){console.log("üîç Looking for Investigation Summary textarea...");const e=['.XestroBox:has(.XestroBoxTitle:contains("Investigation Summary")) textarea','.XestroBox:has(.XestroBoxTitle:contains("Investigation Summary")) .AddNoteArea','[data-field="investigation-summary"] textarea',"#investigation-summary textarea",".investigation-summary textarea"];for(const o of e){console.log(`üîç Trying Investigation Summary specific selector: ${o}`);const n=await this.findElement(o,2e3);if(n&&n.tagName==="TEXTAREA")return console.log(`‚úÖ Found Investigation Summary specific textarea with selector: ${o}`),n}const t=["textarea#AddNoteArea:focus","textarea.AddNoteArea:focus","textarea#AddNoteArea","textarea.AddNoteArea",'textarea[placeholder*="Add a note"]',"textarea.form-control.AddNoteArea"];for(const o of t){console.log(`üîç Trying generic selector: ${o}`);const n=await this.findElement(o,1e3);if(n&&n.tagName==="TEXTAREA"){const i=n.getBoundingClientRect(),r=i.top>=0&&i.left>=0&&i.bottom<=window.innerHeight&&i.right<=window.innerWidth,a=i.top<window.innerHeight*.8;if(r&&a)return console.log(`‚úÖ Found suitable Investigation Summary textarea with selector: ${o}`),n;console.log(`‚ö†Ô∏è Found textarea but it appears to be at bottom of page, skipping: ${o}`)}}return console.warn("‚ö†Ô∏è Could not find suitable Investigation Summary textarea with any selector"),null}async insertTextAtEndOfField(e,t){if(e.tagName==="TEXTAREA"||e.tagName==="INPUT"){const o=e;console.log("üìù Inserting into input/textarea:",{id:o.id,className:o.className,length:o.value?.length||0});const n=o.value;let i=t;n.trim().length>0&&(i=`
`+t);const r=n.length;o.setSelectionRange(r,r);const a=n+i;o.value=a;const s=a.length;o.setSelectionRange(s,s),o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0})),o.focus(),e.tagName==="TEXTAREA"&&(o.scrollTop=o.scrollHeight),console.log(`üìù Inserted text at end of field. Field now has ${a.length} characters.`)}else if(e.contentEditable==="true"){console.log("üìù Inserting into contenteditable element:",{id:e.id,className:e.className}),e.focus();const o=window.getSelection(),n=document.createRange();n.selectNodeContents(e),n.collapse(!1),o?.removeAllRanges(),o?.addRange(n);const i=e.textContent||"";let r=t;i.trim().length>0&&(r=`
`+t),n.insertNode(document.createTextNode(r)),n.collapse(!1),o?.removeAllRanges(),o?.addRange(n),e.dispatchEvent(new Event("input",{bubbles:!0})),e.focus()}console.log("‚úÖ Text inserted at end of field and field kept focused for review")}async openInvestigationSummary(){console.log("üìù Opening Investigation Summary section in Xestro"),await this.openCustomField("Investigation Summary")}async openCustomFieldWithTemplate(e,t){console.log(`üìù Opening ${e} with template in note area`);const o=await this.findNoteArea();if(!o)throw console.error("‚ùå No suitable note area found on page"),new Error("Note area not found");o.focus();const n=t(),i=o.contentEditable==="true",r=i?o.innerText||"":o.value||"",a=n.split(`
`)[0];if(!r.includes(a)){const s=`${n}
${r}`;if(i)o.innerText=s,o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}));else{const c=o;c.value=s,c.dispatchEvent(new Event("input",{bubbles:!0})),c.dispatchEvent(new Event("change",{bubbles:!0}))}}o.style.boxShadow="0 0 5px 2px rgba(33, 150, 243, 0.5)",setTimeout(()=>{o.style.boxShadow=""},1e3),o.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{const s=document.querySelector("#patientNotesSave");s&&confirm("Save the updated notes?")&&(s.click(),console.log("üíæ Auto-saved via Xestro save button"))},1e3),console.log("‚úÖ Note area ready for input with template (Xestro method)")}async findNoteArea(){console.log("üîç Looking for Xestro note input areas...");const e=document.getElementById("AddNoteArea");if(e&&e.offsetParent!==null)return console.log("‚úÖ Using AddNoteArea textarea as note area"),e;const t=["#patientNotesInput","#patientNoteInput",".patient-notes-input",'[contenteditable="true"]'];for(const i of t){const r=document.querySelector(i);if(r&&r.offsetParent!==null)return console.log(`‚úÖ Found Xestro note area with selector: ${i}`),r}const o=document.querySelectorAll('[contenteditable="true"], [contenteditable]');console.log(`üîç Found ${o.length} contenteditable elements:`),o.forEach((i,r)=>{console.log(`  ${r+1}. ID: "${i.id}" Class: "${i.className}" Size: ${i.offsetWidth}x${i.offsetHeight}`)});const n=document.querySelectorAll("textarea");console.log(`üîç Found ${n.length} textareas:`),n.forEach((i,r)=>{console.log(`  ${r+1}. ID: "${i.id}" Class: "${i.className}" Placeholder: "${i.placeholder}"`)});for(let i=0;i<o.length;i++){const r=o[i];if(r.offsetParent!==null&&r.offsetWidth>50&&r.offsetHeight>30)return console.log(`‚úÖ Found usable contenteditable at index ${i+1}`),r}for(let i=0;i<n.length;i++){const r=n[i];if(r.offsetParent!==null&&!r.readOnly&&!r.disabled&&r.offsetWidth>50&&r.offsetHeight>30)return console.log(`‚úÖ Found usable textarea at index ${i+1}${r.id?` (id: ${r.id})`:""}`),r}return console.log("‚è≥ No textarea found immediately, waiting for dynamic content..."),new Promise(i=>{const r=()=>{l&&clearTimeout(l),s&&s.disconnect()},a=()=>{const d=document.getElementById("AddNoteArea");if(d&&d.offsetParent!==null){console.log("‚úÖ Found AddNoteArea dynamically"),r(),i(d);return}for(const m of t){const g=document.querySelector(m);if(g&&g.offsetParent!==null){console.log(`‚úÖ Found note area dynamically with selector: ${m}`),r(),i(g);return}}const u=document.querySelectorAll("textarea");for(let m=0;m<u.length;m++){const g=u[m];if(g.offsetParent!==null&&!g.readOnly&&!g.disabled&&g.offsetWidth>50&&g.offsetHeight>30){console.log(`‚úÖ Found usable textarea dynamically at index ${m+1}`),r(),i(g);return}}},s=new MutationObserver(d=>{let u=!1;d.forEach(m=>{m.type==="childList"&&m.addedNodes.forEach(g=>{if(g.nodeType===Node.ELEMENT_NODE){const p=g;(p.tagName==="TEXTAREA"||p.querySelector("textarea"))&&(u=!0)}})}),u&&a()});s.observe(document.body,{childList:!0,subtree:!0});const c=setInterval(a,500),l=setTimeout(()=>{r(),clearInterval(c),console.log("‚ùå Timeout waiting for textarea"),i(null)},1e4);a()})}async openCustomField(e){if(console.log(`üìù Opening ${e} section in Xestro`),!await this.findAndClickXestroBox(e))throw console.error(`‚ùå Could not find XestroBox for ${e}`),new Error(`XestroBox for ${e} not found`);console.log("‚è≥ Waiting for AddNoteArea textarea to appear...");const o=await this.waitForAddNoteArea();if(!o)throw console.error("‚ùå AddNoteArea textarea did not appear after clicking XestroBox"),new Error("AddNoteArea textarea not found");o.focus(),console.log(`‚úÖ Found AddNoteArea textarea for ${e}`);const i=(o.value||"").length;o.setSelectionRange(i,i),o.dispatchEvent(new Event("focus",{bubbles:!0})),o.style.boxShadow="0 0 5px 2px rgba(33, 150, 243, 0.5)",setTimeout(()=>{o.style.boxShadow=""},1e3),o.scrollIntoView({behavior:"smooth",block:"center"}),console.log(`‚úÖ ${e} section opened and ready for input`)}async openBackground(){console.log("üìù Opening Background in note area"),await this.openCustomField("Background")}async openMedications(){console.log("üìù Opening Medications section in Xestro"),await this.openCustomField("Medications (Problem List for Phil)")}async openSocialHistory(){console.log("üìù Opening Social & Family History section in Xestro"),await this.openCustomField("Social & Family History")}async openPatientConversation(){const e=await this.findElement(".MessageButton",5e3);if(!e)throw new Error("Message button not found");console.log("üí¨ Opening messaging panel"),e.click(),await this.wait(800);const t=await this.findElement('.CreateConversationButton[data-conversationtype="Patient"]',5e3);if(!t)throw new Error("Patient conversation button not found");console.log("üë§ Selecting patient conversation"),t.click(),await this.wait(500)}setupPathologyOverlayWatcher(){this.emrSystem?.name==="Xestro"&&(this.pathologyOverlayObserver||(this.tryEnhancePathologyOverlay(document.body),this.pathologyOverlayObserver=new MutationObserver(e=>{for(const t of e)if(t.type==="childList"){for(const o of Array.from(t.addedNodes))if(o instanceof HTMLElement&&this.tryEnhancePathologyOverlay(o))return}}),this.pathologyOverlayObserver.observe(document.body,{childList:!0,subtree:!0})))}tryEnhancePathologyOverlay(e){if(!e)return!1;const t=e instanceof HTMLElement&&e.id==="Clinical_Investigations_Edit"?e:e.querySelector?.("#Clinical_Investigations_Edit");return t&&!t.hasAttribute("data-operator-save-send")?(console.log("ü©∏ Pathology overlay detected - injecting Save and Send button"),this.injectSaveAndSendButton(t),!0):!1}injectSaveAndSendButton(e){const t=e.querySelector(".footer .inner");if(!t){console.warn("‚ö†Ô∏è Pathology overlay footer not found - cannot inject Save and Send button");return}const o=document.createElement("button");o.type="button",o.className="btn btn-default full operator-save-and-send",o.textContent="Save and Send",o.style.display="inline-block";const n=t.querySelector(".Button1");n&&n.parentElement===t?t.insertBefore(o,n):t.appendChild(o),e.setAttribute("data-operator-save-send","true"),o.addEventListener("click",()=>{this.handleSaveAndSendFlow(e,o)})}async handleSaveAndSendFlow(e,t){if(this.saveAndSendRunning){console.log("‚ÑπÔ∏è Save and Send already running, ignoring duplicate click");return}this.saveAndSendRunning=!0;const o=t.textContent||"Save and Send";t.disabled=!0,t.textContent="Working...";try{const n=e.querySelector(".Button2");if(!n)throw new Error("Save button not found in pathology overlay");console.log("üíæ Clicking Save before messaging flow"),n.click(),await this.wait(800),await this.openMessagingAndAttachLatestRequest(),this.showSuccessMessage("Saved and prepared patient message with latest pathology slip.")}catch(n){console.error("‚ùå Save and Send workflow failed:",n),this.showErrorMessage("Save and Send failed. Please complete manually.")}finally{t.disabled=!1,t.textContent=o,this.saveAndSendRunning=!1}}async openMessagingAndAttachLatestRequest(){await this.openPatientConversation();const e=await this.findElement("#dropdownMenuExisting",5e3);if(!e)throw new Error("Attach dropdown not found");console.log("üìé Opening attach dropdown"),e.click(),await this.wait(300);const t=await this.findElement('.AttachFiles[data-type="REQUEST"]',5e3);if(!t)throw new Error("Investigation request attach option not found");console.log("üß™ Choosing Investigation Requests attach option"),t.click(),await this.wait(500);const o=await this.findElement('input[name="PrimaryKey[]"]',5e3);if(!o)throw new Error("No investigation request available to attach");o.checked||(console.log("‚úÖ Selecting newest investigation request"),o.click());const n=this.findNearestAttachButton(o);n?(console.log("üìé Confirming attach action"),n.click()):console.warn("‚ö†Ô∏è Attach button not found after selecting investigation"),await this.wait(400),await this.populateConversationFields()}findNearestAttachButton(e){const t=["button.AttachSelected","button.AttachFilesSubmit","button.attach-button","button.btn-primary","button.btn-success"];let o=e.closest(".modal, .dialog, form, .dropdown-menu");const n=new Set;for(;o&&!n.has(o);){n.add(o);for(const s of t){const c=o.querySelector(s);if(c&&c.textContent?.toLowerCase().includes("attach"))return c}const a=Array.from(o.querySelectorAll("button")).find(s=>s.textContent?.toLowerCase().includes("attach"));if(a)return a;o=o.parentElement}return Array.from(document.querySelectorAll("button")).find(r=>r.textContent?.toLowerCase().includes("attach")&&r.offsetParent!==null)||null}async populateConversationFields(e,t,o=!0){const n=e??(o?"Blood Test Form":null),i=t??(o?"Your blood test slip is attached here.":null),r=await this.findElement("#Subject",5e3);r&&n!==null?(r.focus(),r.value=n,this.triggerAllEvents(r,n)):r||console.warn("‚ö†Ô∏è Subject field not found in conversation");let a=await this.findElement("#Message",5e3);a||(a=await this.findElement("textarea.conversation-message",3e3)),a&&i!==null?(a.focus(),a.value=i,this.triggerAllEvents(a,i)):a||console.warn("‚ö†Ô∏è Message field not found in conversation")}async openMessagingWithPrefill(e,t){await this.openPatientConversation(),await this.populateConversationFields(e,t,!1)}async clickPathologyButton(){console.log("ü©∏ Clicking Order Pathology icon in Xestro");let e=document.getElementById("OrderPathologyInvestigations");if(!e&&(console.log("üîç Icon ID not found, trying button fallback..."),e=document.querySelector("button.btn-default.NewPathology"),!e)){console.log("üîç Button selector failed, trying text-based fallback...");const t=document.querySelectorAll("button.btn-default");for(const o of t){const n=o.textContent?.toLowerCase()||"";if(n.includes("pathology")||n.includes("order pathology")){e=o,console.log("‚úÖ Found pathology element via text search");break}}}if(e)console.log("ü©∏ Found pathology element, clicking..."),e.click(),await this.wait(500),console.log("‚úÖ Order Pathology clicked successfully");else throw console.error("‚ùå Order Pathology element not found"),new Error("Order Pathology element not found. Please ensure you are on the correct EMR page with pathology access.")}async setupLabField(){console.log('ü©∏ Setting up Lab field - typing "Generic Pathology Request" and selecting from dropdown');let e=null;e=document.querySelector("#Lab"),e||(console.log("üîç #Lab field not found, trying XPath-based selector..."),e=document.evaluate("/html/body/div[2]/div[7]/div/div[3]/div/div[1]/form/div/div[1]/div[2]/div/input[1]",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue),e||(console.log("üîç XPath failed, trying class-based fallback..."),e=document.querySelector("input.form-control.LabForm.ui-autocomplete-input")),e?(console.log('ü©∏ Found Lab setup field, typing "Generic Pathology Request"...',{id:e.id,classes:e.className,tagName:e.tagName}),e.focus(),e.value="",e.value="Generic Pathology Request",e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),e.dispatchEvent(new KeyboardEvent("keyup",{key:"t",bubbles:!0})),console.log("‚è≥ Waiting for autocomplete dropdown to appear..."),await this.waitForAndClickAutocompleteItem("Generic Pathology Request")?console.log('‚úÖ Lab field setup completed: selected "Generic Pathology Request" from dropdown'):(console.log("‚ö†Ô∏è Dropdown not found, trying Enter key fallback..."),e.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",keyCode:13,bubbles:!0})),e.dispatchEvent(new KeyboardEvent("keyup",{key:"Enter",keyCode:13,bubbles:!0})),await this.wait(100),e.blur(),console.log("‚úÖ Lab field setup completed with Enter key fallback"))):console.warn("‚ö†Ô∏è Lab field (#Lab) not found - user may need to navigate manually")}async waitForAndClickAutocompleteItem(e,t=3e3){const o=Date.now();for(;Date.now()-o<t;){const n=document.querySelectorAll("ul.ui-autocomplete.ui-menu");for(const i of n){const r=i;if(r.style.display==="none"||r.offsetWidth===0)continue;console.log("üîç Found visible autocomplete menu, searching for item...");const a=r.querySelectorAll("li.ui-menu-item");for(const s of a){const c=s,l=c.textContent||"";if(l.includes(e)&&!l.includes("start typing to search")){console.log("‚úÖ Found matching autocomplete item:",l.substring(0,50));const d=c.querySelector("a");return d?(console.log("üñ±Ô∏è Clicking autocomplete menu item..."),d.click(),await this.wait(200),!0):(console.log("üñ±Ô∏è Clicking menu item directly (no anchor)..."),c.click(),await this.wait(200),!0)}}}await this.wait(100)}return console.warn("‚ö†Ô∏è Autocomplete dropdown with matching item not found within timeout"),!1}async insertIntoLabField(e){console.log("ü©∏ Inserting blood test results into tagit field:",e.substring(0,100));let t=null;if(t=document.evaluate("/html/body/div[2]/div[7]/div/div[3]/div/div[1]/form/div/div[4]/div[2]/div/ul/li/input",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,!t){console.log("üîç XPath failed, trying tagit-specific selectors...");const n=["ul li input.ui-widget-content.ui-autocomplete-input","li.tagit-new input.ui-widget-content.ui-autocomplete-input","ul.tagit li input.ui-widget-content",".ui-widget-content.ui-autocomplete-input:not(#Lab):not(.form-control)"];for(const i of n){const r=document.querySelectorAll(i);for(const a of r){if(a.id==="Lab"||a.classList.contains("form-control")||a.classList.contains("LabForm")){console.log(`üö´ Results: Skipping #Lab setup field: ${a.id}`);continue}t=a,console.log(`ü©∏ Results: Found tagit field with selector: ${i}`,a);break}if(t)break}}if(t&&(t.id==="PatientName"||t.classList.contains("PatientName")||t.name==="PatientName"||t.id==="Lab"||t.classList.contains("form-control")||t.classList.contains("LabForm"))){console.error("üö® ERROR: Still targeting wrong field! Aborting insertion to prevent data corruption."),console.error("   Found element:",{id:t.id,classes:t.className,name:t.name,isPatientName:t.id==="PatientName",isLabSetupField:t.id==="Lab"});return}if(t)console.log("ü©∏ Found correct tagit field for results insertion...",{id:t.id,classes:t.className,name:t.name,tagName:t.tagName}),t.focus(),t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),t.classList.contains("ui-autocomplete-input")&&(t.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",bubbles:!0})),t.dispatchEvent(new KeyboardEvent("keyup",{key:"Enter",bubbles:!0})),t.closest("li.tagit-new")&&(console.log("ü©∏ Detected tagit field, triggering additional events"),t.dispatchEvent(new KeyboardEvent("keypress",{key:"Enter",bubbles:!0})),t.dispatchEvent(new Event("blur",{bubbles:!0})),setTimeout(()=>{t&&t.focus()},100))),console.log("‚úÖ Blood test results inserted into tagit field successfully");else return console.warn("‚ö†Ô∏è Tagit field not found, falling back to Tests Requested field"),this.insertIntoTestsRequestedField(e)}async insertIntoTestsRequestedField(e){console.log("ü©∏ Inserting blood test content into Tests Requested field:",e.substring(0,100));const t=this.emrSystem?.fields.testsRequested;if(!t)throw new Error("Tests Requested field not defined for this EMR system");let o=await this.findElement(t.selector,5e3);if(!o){console.log("üîç Tests Requested field not found, trying alternative selectors...");const n=[".TestsRequested input",".tests-requested-tagit input","ul.TestsRequested input",".tagit-new input",'[name="Tests"] + .tagit input'];for(const i of n)if(o=document.querySelector(i),o){console.log("‚úÖ Found Tests Requested field with selector:",i);break}}if(!o)throw console.error("‚ùå Tests Requested field not found"),new Error("Tests Requested field not found. Please ensure you are on the pathology ordering page.");if(o.tagName==="INPUT"){const n=o;n.focus(),n.value=e,["input","change","keyup"].forEach(a=>{const s=new Event(a,{bubbles:!0});n.dispatchEvent(s)});const r=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,bubbles:!0});n.dispatchEvent(r),console.log("‚úÖ Content inserted into Tests Requested field")}else console.warn("‚ö†Ô∏è Found element is not an input field, treating as generic element"),await this.insertTextIntoElement(o,e)}async clickRadiologyButton(){console.log("üì∑ Clicking Order Radiology icon in Xestro");let e=document.getElementById("orderRadiologInvestigations");if(!e&&(console.log("üîç Icon ID not found, trying button fallback..."),e=document.querySelector("button.btn-default.NewRadiology"),!e)){console.log("üîç Button selector failed, trying text-based fallback...");const t=document.querySelectorAll("button.btn-default");for(const o of t){const n=o.textContent?.toLowerCase()||"";if(n.includes("radiology")||n.includes("order radiology")){e=o,console.log("‚úÖ Found radiology element via text search");break}}}if(e)console.log("üì∑ Found radiology element, clicking..."),e.click(),await this.wait(500),console.log("‚úÖ Order Radiology clicked successfully");else throw console.error("‚ùå Order Radiology element not found"),new Error("Order Radiology element not found. Please ensure you are on the correct EMR page with radiology access.")}async openQuickLetter(){const e=await this.findElement('button:contains("Quick Letter"), [data-action="quick-letter"], .quick-letter-btn, .QuickLetter');if(e)e.click();else{const t=await this.findActiveNoteArea();t&&this.focusElement(t)}}async createTask(){console.log("üìù Starting Create Task workflow (3-step sequence)...");try{console.log("üîò Step 1: Clicking Actions button...");const t=this.findByXPath("/html/body/div[3]/div[2]/div/div[4]/div[1]/div[1]/button");if(!t)throw new Error("Actions button not found. Please ensure you are viewing a patient record.");console.log("‚úÖ Found Actions button, clicking..."),t.click(),await this.wait(500),console.log("‚úÖ Actions menu should be open"),console.log("üîò Step 2: Clicking dropdown toggle...");const n=this.findByXPath("/html/body/div[2]/div[7]/div/div[3]/div/div[2]/div[2]/div/div/div[1]/div[2]/div[1]/div/button");if(!n)throw new Error("Dropdown toggle not found. Actions menu may not have loaded properly.");console.log("‚úÖ Found dropdown toggle, clicking..."),n.click(),await this.wait(100),console.log("‚úÖ Dropdown submenu should be expanded"),console.log("üîò Step 3: Clicking Create Task button...");const r=this.findByXPath("/html/body/div[2]/div[7]/div/div[3]/div/div[2]/div[2]/div/div/div[1]/div[2]/div[1]/div/ul/li[2]/a");if(!r)throw new Error("Create Task button not found in dropdown menu.");console.log("‚úÖ Found Create Task button, clicking...",{tagName:r.tagName,className:r.className,textContent:r.textContent?.trim()}),r.click(),await this.wait(500),console.log("‚úÖ Create Task clicked successfully - dialog should be opening")}catch(e){console.error("‚ùå Task creation failed:",e);const t=e instanceof Error?e.message:"Unknown error occurred";throw alert(`‚ùå Failed to create task: ${t}

Please create the task manually.`),e}}async createTaskWithContent(e){console.log("üìù Creating task with content:",e);try{await this.createTask(),await this.wait(1e3),console.log("‚è≥ Waiting for task dialog to load...");const t=await this.findTaskSubjectField();t?(console.log("‚úÖ Found Subject field, populating..."),t.value="",t.focus(),t.value=e.subject,this.triggerAllEvents(t,e.subject),console.log(`‚úÖ Populated Subject: ${e.subject}`)):console.warn("‚ö†Ô∏è Subject field not found - task may need manual entry");const o=await this.findTaskMessageField();o?(console.log("‚úÖ Found Message field, populating..."),o.value="",o.focus(),o.value=e.message,this.triggerAllEvents(o,e.message),console.log(`‚úÖ Populated Message: ${e.message.substring(0,50)}...`)):console.warn("‚ö†Ô∏è Message field not found - task may need manual entry"),console.log("‚úÖ Task populated with content successfully")}catch(t){console.error("‚ùå Error creating task with content:",t);const o=t instanceof Error?t.message:"Unknown error";throw alert(`‚ùå Failed to create task with follow-up information:

${o}

Please create the task manually with this content:

Subject: ${e.subject}
Message: ${e.message.substring(0,200)}...`),t}}async findTaskSubjectField(){console.log("üîç Searching for task Subject field...");const e=['input[name*="subject"]','input[id*="subject"]','input[placeholder*="Subject"]','input[placeholder*="subject"]',"input.subject","input.Subject"];for(const i of e){const r=document.querySelector(i);if(r&&r.offsetParent!==null)return console.log(`‚úÖ Found Subject field via selector: ${i}`),r}const t=this.findFieldByLabelText("subject");if(t)return console.log("‚úÖ Found Subject field via label text"),t;const n=Array.from(document.querySelectorAll('input[type="text"], input:not([type])')).filter(i=>i.offsetParent!==null);return n.length>0?(console.log("‚ö†Ô∏è Using first visible input as Subject field (fallback)"),n[0]):(console.warn("‚ùå Subject field not found after trying all strategies"),null)}async findTaskMessageField(){console.log("üîç Searching for task Message field...");const e=["textarea#Message",'textarea[name="Message"]',"textarea.conversation-message","textarea.form-control.conversation-message"];for(const i of e){const r=document.querySelector(i);if(r&&r.offsetParent!==null)return console.log(`‚úÖ Found Message field via specific selector: ${i}`),r}try{const r=document.evaluate("/html/body/div[2]/div[7]/div[1]/div[3]/div/form/div[2]/div[2]/textarea",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(r&&r.offsetParent!==null)return console.log("‚úÖ Found Message field via XPath"),r}catch(i){console.log("‚ö†Ô∏è XPath search failed:",i)}const t=Array.from(document.querySelectorAll("label"));for(const i of t)if(i.textContent?.trim()==="Message"){console.log('‚úÖ Found exact label: "Message"');const a=i.getAttribute("for");if(a){const l=document.getElementById(a);if(l&&l.tagName==="TEXTAREA"&&l.offsetParent!==null)return console.log(`‚úÖ Found Message field via exact label 'for' attribute: #${a}`),l}let s=i.nextElementSibling;for(;s;){if(s.tagName==="TEXTAREA"&&s.offsetParent!==null)return console.log("‚úÖ Found Message field as label sibling"),s;s=s.nextElementSibling}let c=i.parentElement;for(;c;){const l=c.querySelector("textarea");if(l&&l.offsetParent!==null)return console.log("‚úÖ Found Message field in label parent"),l;if(c=c.parentElement,c?.tagName==="FORM")break}}const n=Array.from(document.querySelectorAll("textarea")).filter(i=>i.name==="Notes"||i.classList.contains("Notes")||(i.parentElement?.textContent?.toLowerCase()||"").includes("copy incoming")?!1:i.offsetParent!==null);return n.length>0?(console.log("‚ö†Ô∏è Using first visible textarea as Message field (fallback, filtered)"),n[0]):(console.warn("‚ùå Message field not found after trying all strategies"),null)}async appointmentWrapUp(e){this.emrSystem?.name==="Xestro"?await this.xestroAppointmentWrapUp(e):console.warn("Appointment wrap-up not implemented for this EMR system")}async xestroAppointmentWrapUp(e){if(e.preset?.taskMessage){console.log("üìù Creating task with follow-up information before opening wrap-up dialog...");try{await this.createTaskWithContent({subject:"Post Appointment Tasks",message:e.preset.taskMessage}),console.log("‚úÖ Task created successfully")}catch(o){console.error("‚ùå Task creation failed, but continuing with wrap-up dialog:",o)}}const t=await this.findElement('button.btn.btn-primary.appt-wrap-up-btn, [data-action="appt-wrap-up"]');t&&(console.log("üìã Opening appointment wrap-up dialog..."),t.click(),await this.wait(1500),e.preset&&await this.populateAppointmentPreset(e.preset))}findPatientDetailsXestroBoxContent(){console.log("üîç Strategy: Patient Details XestroBoxContent - looking for patient details section...");const e=document.querySelector(".XestroBox.PatientDetailsContent .XestroBoxContent");if(e)return console.log("‚úÖ Found PatientDetailsContent XestroBoxContent via class selector"),e;const t=document.querySelectorAll(".XestroBoxTitle");console.log(`üîç Found ${t.length} XestroBoxTitle elements`);for(let o=0;o<t.length;o++){const n=t[o],i=n.textContent?.trim()||"";if(console.log(`üîç XestroBoxTitle ${o+1}: "${i}"`),i==="Patient Details"){console.log('‚úÖ Found "Patient Details" title, looking for next sibling XestroBoxContent...');let r=n.nextElementSibling;for(;r;){if(r.classList.contains("XestroBoxContent"))return console.log("‚úÖ Found Patient Details XestroBoxContent via title search!"),r;r=r.nextElementSibling}const a=n.parentElement;if(a){const s=a.querySelector(".XestroBoxContent");if(s)return console.log("‚úÖ Found Patient Details XestroBoxContent in parent!"),s}}}return console.log("‚ùå No Patient Details XestroBoxContent found"),null}extractFromPatientSelectorInput(){console.log("üîç Strategy: Patient Selector Input - checking for patient data...");try{const e=document.querySelector("#PatientSelectorInput");if(e&&(e.value||e.placeholder)){const t=(e.value||e.placeholder).trim();if(t&&!t.toLowerCase().includes("select")&&!t.toLowerCase().includes("search"))return console.log("‚úÖ Found patient name in selector input:",t),{name:t,extractedAt:Date.now(),extractionMethod:"patientSelectorInput"}}return console.log("‚ùå No patient data found in selector input"),null}catch(e){return console.error("‚ùå Error extracting from patient selector input:",e),null}}extractFromHiddenInputs(){console.log("üîç Strategy: Hidden Input Fields - checking for patient data...");try{const e={extractedAt:Date.now(),extractionMethod:"hiddenInputs"},t=document.querySelector("#PatientName"),o=document.querySelector("#DialogTitleName"),n=document.querySelector("#PatientID_FYI");if(console.log("üîç Found input elements:",{patientName:t?.value||"not found",dialogTitle:o?.value||"not found",patientId:n?.value||"not found"}),o&&o.value){const i=o.value.trim();console.log("‚úÖ Found DialogTitleName:",i);const r=i.match(/^(.+?)\s*\((\d+)\)$/);r?(e.name=r[1].trim(),e.id=r[2],console.log("üìù Extracted from DialogTitleName - Name:",e.name,"ID:",e.id)):(e.name=i,console.log("üìù Extracted name only from DialogTitleName:",e.name))}return!e.name&&t&&t.value&&(e.name=t.value.trim(),console.log("üìù Extracted from PatientName input:",e.name)),!e.id&&n&&n.value&&(e.id=n.value.trim(),console.log("üìù Extracted from PatientID_FYI input:",e.id)),e.name?(console.log("‚úÖ Successfully extracted from hidden inputs:",e),e):(console.log("‚ùå No patient data found in hidden inputs"),null)}catch(e){return console.error("‚ùå Error extracting from hidden inputs:",e),null}}extractPatientData(){console.log("üë§ Extracting patient data from Xestro EMR page...");try{const e={extractedAt:Date.now()},t=this.extractFromHiddenInputs();if(t&&t.name)return console.log("‚úÖ Successfully extracted using Hidden Inputs strategy:",t),t;let o=this.findPatientDetailsXestroBoxContent();if(o){console.log("‚úÖ Strategy 2: Found Patient Details XestroBoxContent");const s=this.extractFromXestroBoxContent(o,e);if(s&&s.name)return console.log("‚úÖ Successfully extracted using PatientDetailsXestroBoxContent strategy:",s),s}else console.log("‚ùå Strategy 2: No Patient Details XestroBoxContent found");const n=this.extractFromPatientSelectorInput();if(n&&n.name)return console.log("‚úÖ Successfully extracted using PatientSelectorInput strategy:",n),n;const i=Array.from(document.querySelectorAll("div")).filter(s=>{const c=s.textContent||"",l=/^(Mr|Mrs|Ms|Dr|Miss)\s+[A-Za-z\s()]+/.test(c.trim()),d=s.querySelector(".pull-right"),u=c.includes("ID:");return l&&d&&u});if(i.length>0){o=i[0],console.log(`‚úÖ Strategy 2: Found patient data in patient details div (${i.length} candidates)`);const s=this.extractFromPatientDetailsDiv(o,e);if(s&&s.name)return console.log("‚úÖ Successfully extracted using PatientDetailsDiv strategy:",s),s}const r=document.querySelectorAll("div");for(let s=0;s<r.length;s++){const c=r[s],l=c.textContent||"";if(l.includes("ID:")&&/\d{4,6}/.test(l)&&c.querySelectorAll("div").length>=3){console.log("‚úÖ Strategy 3: Found potential patient data in generic div");const u=this.extractFromGenericPatientDiv(c,e);if(u&&u.name)return console.log("‚úÖ Successfully extracted using GenericPatientDiv strategy:",u),u}}console.log("‚ö†Ô∏è All primary strategies failed, attempting fallback extraction...");const a=this.extractPatientDataFallback(e);return a&&a.name?(console.log("‚úÖ Successfully extracted using fallback strategy:",a),a):(console.log("‚ùå All extraction strategies failed. Page structure might be different."),console.log("üîç Available elements for debugging:"),console.log("- .XestroBoxContent elements:",document.querySelectorAll(".XestroBoxContent").length),console.log("- .pull-right elements:",document.querySelectorAll(".pull-right").length),console.log('- Elements with "ID:" text:',Array.from(document.querySelectorAll("*")).filter(s=>s.textContent?.includes("ID:")).length),null)}catch(e){return console.error("‚ùå Error extracting patient data:",e),null}}extractFromXestroBoxContent(e,t){console.log("üìã Extracting from XestroBoxContent...");const o=e.querySelector("div");return o?this.extractFromPatientDetailsDiv(o,t):(console.log("‚ùå No content div found in XestroBoxContent"),null)}extractFromPatientDetailsDiv(e,t){console.log("üìã Extracting from patient details div...");try{let o="";const n=e.querySelector(":scope > div");if(n){console.log("üîç Found first child div, extracting direct text content...");const l=[];for(let d=0;d<n.childNodes.length;d++){const u=n.childNodes[d];if(u.nodeType===Node.TEXT_NODE){const m=u.textContent?.trim()||"";m&&l.push(m)}}l.length>0&&(o=l.join(" ").trim(),console.log("‚úÖ Extracted name from text nodes:",o))}if(!o){console.log("üîç Text node extraction failed, trying fallback strategies...");const l=e,d=Array.from(l.querySelectorAll(":scope > div div, :scope > div")).filter(u=>!u.closest(".pull-right"));for(const u of d){const m=(u.textContent||"").trim();if(m&&/^(Mr|Mrs|Ms|Dr|Miss)\b/.test(m)&&!/\bID:\b/.test(m)){o=m,console.log("‚úÖ Extracted name from fallback element:",o);break}}}if(!o){const l=e.firstChild;l&&l.nodeType===Node.TEXT_NODE&&(o=(l.textContent||"").trim())}if(!o){const l=e.firstElementChild;if(l){const d=(e.textContent||"").trim(),u=(l.textContent||"").trim(),m=d.replace(u,"").trim();m&&!/\bID:\b/.test(m)&&(o=m)}}if(!o){const d=(e.textContent||"").match(/\b(Mr|Mrs|Ms|Dr|Miss)\s+([A-Za-z\s()]+?)(?=\s*ID:|$)/);d&&(o=d[0].trim())}o&&(t.name=o,console.log("üìù Extracted name:",t.name));const i=Array.from(e.querySelectorAll("div")),r=i.find(l=>{const d=l.textContent?.trim()||"";return/^0\d{2,3}\s?\d{3}\s?\d{3}$/.test(d.replace(/\s/g,""))});r&&(t.phone=r.textContent?.trim(),console.log("üìû Extracted phone:",t.phone));const a=i.find(l=>(l.textContent?.trim()||"").toLowerCase().includes("medicare"));a&&(t.medicare=a.textContent?.trim(),console.log("üè• Extracted Medicare status:",t.medicare));const s=e.querySelector(".pull-right");if(s){const l=s.querySelector("b");if(l&&l.textContent){const m=l.textContent.match(/ID:\s*(\d+)/);m&&(t.id=m[1],console.log("üìù Extracted ID:",t.id))}const u=(s.textContent||"").match(/(\d{2}\/\d{2}\/\d{4})\s*\((\d+)\)/);u&&(t.dob=u[1],t.age=u[2],console.log("üìù Extracted DOB:",t.dob,"Age:",t.age))}return e.querySelectorAll('div[data-allow="1"]').forEach((l,d)=>{const u=l.textContent?.trim()||"";u&&(/^[\d\s\-()+]{8,}$/.test(u)?(t.phone=u,console.log("üìù Extracted phone:",t.phone)):u.includes("@")&&u.includes(".")?(t.email=u,console.log("üìù Extracted email:",t.email)):/\b(VIC|NSW|QLD|SA|WA|TAS|ACT|NT)\b/i.test(u)&&(t.address=u,console.log("üìù Extracted address:",t.address)))}),i.forEach(l=>{const d=l.textContent?.trim()||"";if(d)if(d.includes("Medicare:")){const u=d.match(/Medicare:\s*([^<]+)/);u&&(t.medicare=u[1].trim(),console.log("üìù Extracted Medicare:",t.medicare))}else(d.includes("Private")||d.includes("Limited:"))&&(t.insurance=d,console.log("üìù Extracted insurance:",t.insurance))}),t}catch(o){return console.error("‚ùå Error in extractFromPatientDetailsDiv:",o),null}}extractFromGenericPatientDiv(e,t){return console.log("üìã Extracting from generic patient div..."),this.extractFromPatientDetailsDiv(e,t)}extractPatientDataFallback(e){console.log("üìã Attempting fallback patient data extraction...");try{const t=Array.from(document.querySelectorAll("*")).filter(o=>o.textContent?.includes("ID:")&&/ID:\s*\d{4,6}/.test(o.textContent));for(const o of t){const n=o.textContent||"",i=n.match(/ID:\s*(\d+)/);i&&(e.id=i[1],console.log("üìù Fallback extracted ID:",e.id));const r=n.match(/(Mr|Mrs|Ms|Dr|Miss)\s+[A-Za-z\s()]+/);if(r){e.name=r[0].trim(),console.log("üìù Fallback extracted name:",e.name);break}const a=o.parentElement;if(a){const c=(a.textContent||"").match(/(Mr|Mrs|Ms|Dr|Miss)\s+[A-Za-z\s()]+/);if(c){e.name=c[0].trim(),console.log("üìù Fallback extracted name from parent:",e.name);break}}}return e.name||e.id?e:null}catch(t){return console.error("‚ùå Error in fallback extraction:",t),null}}findFieldByLabelText(e){console.log(`üîç Looking for field with label containing: "${e}"`);const t=Array.from(document.querySelectorAll("label"));for(const o of t)if(o.textContent?.toLowerCase().includes(e.toLowerCase())){console.log(`‚úÖ Found label: "${o.textContent?.trim()}"`);const n=o.getAttribute("for");if(n){const a=document.getElementById(n);if(a)return console.log(`‚úÖ Found field via label 'for' attribute: #${n}`),a}let i=o.nextElementSibling;for(;i;){if(i instanceof HTMLInputElement||i instanceof HTMLTextAreaElement)return console.log("‚úÖ Found field as next sibling of label"),i;const a=i.querySelector("input, textarea");if(a)return console.log("‚úÖ Found field as child of element after label"),a;i=i.nextElementSibling}const r=o.parentElement;if(r){const a=r.querySelector("input, textarea");if(a)return console.log("‚úÖ Found field in same parent as label"),a}}return console.log(`‚ùå No field found for label: "${e}"`),null}findByXPath(e){try{return document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(t){return console.error(`‚ùå Error evaluating XPath: ${e}`,t),null}}triggerAllEvents(e,t){const o=e,n=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value")?.set,i=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value")?.set;o instanceof HTMLInputElement&&n?n.call(o,t):o instanceof HTMLTextAreaElement&&i&&i.call(o,t),[new Event("input",{bubbles:!0,cancelable:!0}),new Event("change",{bubbles:!0,cancelable:!0}),new KeyboardEvent("keydown",{bubbles:!0,cancelable:!0}),new KeyboardEvent("keyup",{bubbles:!0,cancelable:!0}),new FocusEvent("focus",{bubbles:!0}),new FocusEvent("blur",{bubbles:!0})].forEach(a=>e.dispatchEvent(a))}async populateAppointmentPreset(e){try{if(console.log("üìã Starting appointment preset population..."),console.log("üìã Preset data:",{itemCode:e.itemCode,notes:e.notes,displayName:e.displayName}),await this.wait(500),e.itemCode){console.log("üîç Searching for Item Codes field...");let t=null;const n=this.findByXPath("/html/body/div[2]/div[7]/div/div[3]/div/div/div[1]/div/ul/li");if(n){const i=n.querySelector("input");i?(console.log("‚úÖ Found Item Codes field via XPath (inside li element)"),t=i):(console.log("üîç XPath element found but no input inside, checking element type..."),console.log("Element details:",{tagName:n.tagName,className:n.className,contentEditable:n.contentEditable}))}if(!t){const i=["input.item-codes-autocomplete","input.ui-autocomplete-input",'input[name*="item"]','input[name*="code"]','input[id*="item"]','input[id*="code"]','input[placeholder*="Item"]','input[placeholder*="Code"]'];for(const r of i){const a=document.querySelector(r);if(a&&a.offsetParent!==null){console.log(`‚úÖ Found Item Codes field via selector: ${r}`),t=a;break}}}if(t||(t=this.findFieldByLabelText("item code")),!t){console.log("üîç Trying to find visible inputs in modal...");const r=Array.from(document.querySelectorAll('input[type="text"], input:not([type])')).filter(a=>a.offsetParent!==null);console.log(`Found ${r.length} visible text inputs`),r.length>0&&(t=r[0],console.log("‚ö†Ô∏è Using first visible input as Item Codes field (fallback strategy)"))}if(t){console.log(`‚úÖ Found Item Codes field, setting value to: ${e.itemCode}`),t.value="",t.focus(),t.value=e.itemCode,this.triggerAllEvents(t,e.itemCode),t.dispatchEvent(new Event("input",{bubbles:!0})),setTimeout(()=>{const a=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0,cancelable:!0});t.dispatchEvent(a),console.log("üéØ Triggered Enter key to open autocomplete dropdown"),setTimeout(()=>{const s=`.item-code-${e.itemCode}`,c=document.querySelector(s);if(c){const l=c.closest("li.ui-menu-item");l?(l.click(),console.log(`üéØ Clicked menu item with item code ${e.itemCode}`)):console.warn("‚ö†Ô∏è Found item-code div but couldn't find parent li.ui-menu-item")}else console.warn(`‚ö†Ô∏è Could not find menu item with selector: ${s}`)},100)},50),await this.wait(200),console.log("üìù Clicking Appointment Notes area to accept billing code...");const i=['textarea[placeholder*="Appointment"]',"textarea.appointment-notes",'textarea[name*="Appointment"]',"#AppointmentNotes",".appointment-notes-field textarea"];let r=null;for(const a of i)if(r=document.querySelector(a),r&&r.offsetParent!==null){console.log(`‚úÖ Found Appointment Notes via selector: ${a}`);break}if(!r){const s=Array.from(document.querySelectorAll("textarea")).filter(c=>c.offsetParent!==null);console.log(`Found ${s.length} visible textareas`);for(const c of s){const l=c.getAttribute("name"),d=c.placeholder||"";if(console.log("Textarea details:",{name:l,placeholder:d,classes:c.className}),l!=="Notes"&&!c.classList.contains("Notes")){r=c,console.log("‚úÖ Found Appointment Notes field (by exclusion)");break}}}r?(r.focus(),r.click(),console.log("‚úÖ Clicked Appointment Notes area - billing code should be accepted"),await this.wait(300)):console.warn("‚ö†Ô∏è Appointment Notes field not found - billing code may not be accepted"),console.log(`‚úÖ Populated Item Code: ${e.itemCode}`)}else console.warn("‚ö†Ô∏è Item codes input field not found after trying all strategies"),console.log("üí° Available inputs:",Array.from(document.querySelectorAll("input")).map(i=>({type:i.type,name:i.getAttribute("name"),id:i.id,class:i.className,placeholder:i.placeholder})))}console.log("üìù Notes field left blank (task created separately)"),console.log(`‚úÖ Successfully applied preset: ${e.displayName}`)}catch(t){console.error("‚ùå Error populating appointment preset:",t)}}async ensurePatientRecordView(){if(!this.emrSystem)return;if(!await this.findElement(this.emrSystem.selectors.patientRecord,1e3)){const t=await this.findElement('button:contains("Record"), [data-view="record"], .record-view-btn');t&&(t.click(),await this.wait(2e3))}}async ensurePatientRecordOpened(){console.log("üîç Ensuring patient record is opened...");const e=document.querySelectorAll(".XestroBox");console.log(`üîç Initial XestroBox count: ${e.length}`);let t=await this.findElement("button.PatientDetailsButton");if(t||(t=await this.findButtonByText("Patient Record")),t||(t=await this.findButtonByText("Patient")),!t){const o=document.querySelectorAll("button.btn-default");for(const n of o)if(n.textContent?.includes("Patient")){t=n;break}}if(t){console.log("üîç Found Patient Record button, clicking..."),t.click(),await this.wait(3e3);const o=document.querySelectorAll(".XestroBox");console.log(`üîç Final XestroBox count: ${o.length}`),o.length===0?console.warn("‚ö†Ô∏è Patient record button clicked but no clinical content found"):o.length>e.length?console.log("‚úÖ Patient record opened successfully - clinical content detected"):console.log("‚ÑπÔ∏è Patient record may have already been open")}else console.warn("‚ö†Ô∏è Patient Record button not found - proceeding with extraction"),console.log("üí° Available buttons:",Array.from(document.querySelectorAll("button")).map(o=>o.textContent?.trim()).filter(Boolean))}async findActiveNoteArea(){return this.emrSystem?await this.findElement(this.emrSystem.selectors.noteArea):null}async findElement(e,t=5e3){const o=Date.now();for(;Date.now()-o<t;){if(e.includes(":contains(")){const n=e.match(/(.+):contains\("(.+)"\)/);if(n){const[,i,r]=n,a=document.querySelectorAll(i);for(const s of a)if(s.textContent?.includes(r))return s}}else{const n=document.querySelector(e);if(n)return n}await this.wait(100)}return null}focusElement(e){e.focus(),e.scrollIntoView({behavior:"smooth",block:"center"});const t=e.style.cssText;e.style.cssText+="border: 2px solid #3b82f6 !important; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5) !important;",setTimeout(()=>{e.style.cssText=t},2e3)}isTextInputElement(e){if(!e)return!1;const t=e.tagName.toLowerCase();return t==="textarea"||t==="input"&&["text","email","search","url"].includes(e.type)||e.contentEditable==="true"}updateFieldMappings(){}async findAndClickXestroBox(e){console.log(`üîç Looking for XestroBox with title "${e}"`);const t=document.querySelectorAll(".XestroBox");console.log(`Found ${t.length} XestroBox elements`);for(let o=0;o<t.length;o++){const n=t[o],i=n.querySelector(".XestroBoxTitle");if(i&&i.textContent?.includes(e))return console.log(`‚úÖ Found XestroBox for "${e}" at index ${o}`),console.log(`üñ±Ô∏è Clicking XestroBox title: "${i.textContent}"`),i.click(),await this.wait(500),n}return console.log(`‚ùå No XestroBox found with title containing "${e}"`),t.forEach((o,n)=>{const i=o.querySelector(".XestroBoxTitle");console.log(`  ${n+1}. XestroBoxTitle: "${i?.textContent||"No title"}"`)}),null}async waitForAddNoteArea(){for(let n=0;n<50;n++){const i=document.getElementById("AddNoteArea");if(i&&i.offsetParent!==null)return console.log(`‚úÖ AddNoteArea found after ${n*100}ms`),i;n%10===0&&console.log(`‚è≥ Still waiting for AddNoteArea... (${n*100}ms)`),await this.wait(100)}return console.log("‚ùå AddNoteArea not found after 5000ms"),null}async wait(e){return new Promise(t=>setTimeout(t,e))}getPageStatus(){const e=window.location.href,t=document.title,o=document.readyState,n=document.querySelectorAll(".XestroBox").length>0,i=document.querySelector("#patientNotesInput, #AddNoteArea")!==null,r=document.querySelectorAll(".appointmentBook, .one-appt-book").length>0,a=document.querySelector("input.date.form-control")!==null;let s="unknown";return r&&a?s="calendar":n&&i?s="patient":e.includes("Dashboard")&&(s="dashboard"),{url:e,title:t,readyState:o,pageType:s,isReady:o==="complete"&&(s==="calendar"||s==="patient"&&n),elements:{xestroBoxCount:document.querySelectorAll(".XestroBox").length,hasPatientNotes:i,hasCalendarElements:r,hasDateInput:a},timestamp:Date.now()}}async handleProfilePhoto(e){if(console.log("üì∏ Handling profile photo capture:",e),e?.imageData)try{console.log("üì∏ Opening photo upload interface..."),await this.openPhotoUploadInterface(),await this.insertImageIntoDropZone(e.imageData,e.method||"tab-capture"),console.log("‚úÖ Profile photo workflow completed successfully")}catch(t){throw console.error("‚ùå Profile photo workflow failed:",t),this.showErrorMessage(`Profile photo failed: ${t instanceof Error?t.message:"Unknown error"}`),t}else throw console.log("üì∏ No image data provided, showing capture instructions"),this.showErrorMessage("Profile photo capture requires image data"),new Error("Profile photo capture requires image data")}async insertImageIntoDropZone(e,t){console.log(`üì∏ Inserting image into DropZone using method: ${t}`);try{console.log("üîç Step 4: Looking for DropZone element...");const o=await this.findDropZone();if(!o)throw console.error("‚ùå Step 4 failed: DropZone not found on page"),console.log("üîç This usually means the Upload button click did not work properly"),console.log("üîç Current page state:"),console.log("  - URL:",window.location.href),console.log("  - Modal elements:",document.querySelectorAll('.modal, [class*="modal"]').length),console.log("  - Upload elements:",document.querySelectorAll('input[type="file"], [class*="upload"], [class*="drop"]').length),this.showErrorMessage("Upload area not found. Please try clicking the profile photo manually and then use the extension."),new Error("DropZone field not found - the upload interface may not have loaded properly");console.log("‚úÖ Step 4 completed: Found DropZone element"),console.log("üì∏ DropZone details:",{tagName:o.tagName,id:o.id,className:o.className,visible:o.offsetParent!==null}),console.log("üîÑ Step 5: Converting image data to file...");const n=await this.base64ToFile(e,"profile-photo.png");console.log("‚úÖ Step 5 completed: File created",{name:n.name,size:n.size,type:n.type}),console.log("üîÑ Step 6: Simulating file drop..."),await this.simulateFileDrop(o,n),console.log("‚úÖ Step 6 completed: File drop simulation finished"),await this.wait(1e3),document.querySelector('img[src*="blob:"], img[src*="data:"], .uploaded-image, .image-preview')?(console.log("‚úÖ Upload appears successful - found uploaded image preview"),this.showSuccessMessage("Profile photo uploaded successfully!")):(console.log("‚ö†Ô∏è Upload status unclear - no image preview detected"),this.showSuccessMessage("Profile photo uploaded (verification incomplete)")),console.log("‚úÖ Profile photo insertion workflow completed")}catch(o){throw console.error("‚ùå Error inserting image into DropZone:",o),this.showErrorMessage(`Failed to upload profile photo: ${o instanceof Error?o.message:"Unknown error"}`),o}}async openPhotoUploadInterface(){console.log("üîÑ Starting photo upload interface navigation...");try{console.log("üîÑ Step 1: Clicking sidebar patient photo...");const e=await this.findElementWithRetry(["#SidebarPatientPhoto",".sidebar-patient-photo",'[id*="patient"][id*="photo" i]','img[alt*="patient" i]'],5e3,3);if(!e)throw console.error("‚ùå Step 1 failed: Could not find sidebar patient photo"),console.log("üîç Available elements on page:",document.querySelectorAll('[id*="patient"], [class*="patient"], img').length),new Error("Could not find sidebar patient photo. The patient edit window may not have opened correctly.");console.log("‚úÖ Found sidebar patient photo element:",e.id||e.className),e.click(),await this.wait(1500),console.log("üîç Validating patient photo click result..."),await this.wait(500),console.log("üîÑ Step 2: Clicking Profile Picture tab/description...");const t=await this.findProfilePictureTab();if(!t)throw console.error("‚ùå Step 2 failed: Could not find Profile Picture tab"),console.log("üîç Available descriptions:",Array.from(document.querySelectorAll('.description, .tab, .tab-item, [role="tab"]')).map(n=>n.textContent?.trim()).filter(n=>n)),new Error("Could not find Profile Picture tab. The patient modal may not have opened correctly.");console.log("‚úÖ Found Profile Picture tab:",t.textContent?.trim()),t.click(),await this.wait(1500),console.log("üîÑ Step 3: Clicking Upload New button...");const o=await this.findElementWithRetry(["#UploadPhotoButton",'button:contains("Upload New")','button:contains("Upload")','button:contains("Browse")','[data-action="upload"]','input[type="file"]'],5e3,3);if(!o)throw console.error("‚ùå Step 3 failed: Could not find Upload button"),console.log("üîç Available buttons in profile section:",Array.from(document.querySelectorAll('button, input[type="file"]')).map(n=>n.textContent?.trim()||n.getAttribute("type")).filter(n=>n)),new Error("Could not find Upload New button. The Profile Picture tab may not have loaded correctly.");console.log("‚úÖ Found upload button:",o.textContent?.trim()||o.tagName),o.click(),await this.wait(2e3),console.log("‚úÖ Photo upload interface navigation completed successfully")}catch(e){throw console.error("‚ùå Failed to open photo upload interface:",e),console.log("üîç Current page URL:",window.location.href),console.log("üîç Current page title:",document.title),console.log("üîç Page contains patient edit elements:",document.querySelectorAll('[id*="edit"], [class*="edit"], .modal').length>0),new Error(`Navigation failed at step: ${e instanceof Error?e.message:"Unknown error"}`)}}async findDropZone(){console.log("üîç Looking for DropZone element...");let e=await this.waitForDropZone();if(e)return console.log("‚úÖ Found DropZone with primary selector"),e;const t=['[class*="dropzone" i]','[class*="drop-zone" i]','[class*="file-drop" i]','[class*="upload-zone" i]',".file-upload-area",'[data-drop="true"]','input[type="file"]'];return console.log("üîç Trying alternative DropZone selectors..."),e=await this.findElementWithRetry(t,5e3,2),e?(console.log("‚úÖ Found DropZone with alternative selector"),e):(console.warn("‚ö†Ô∏è Could not find DropZone even with alternative selectors"),console.log("üîç Available file-related elements:",document.querySelectorAll('input[type="file"], [class*="upload"], [class*="drop"]').length),null)}async waitForDropZone(e=5e3){console.log("‚è≥ Waiting for DropZone to appear...");const t=Date.now(),o=200;for(;Date.now()-t<e;){const n=document.querySelector("#DropZone");if(n&&n.offsetParent!==null)return console.log("‚úÖ DropZone appeared and is visible"),n;await this.wait(o)}return console.log("‚ùå Timeout waiting for DropZone to appear"),null}async base64ToFile(e,t){const o=e.replace(/^data:image\/\w+;base64,/,""),n=atob(o),i=new Array(n.length);for(let s=0;s<n.length;s++)i[s]=n.charCodeAt(s);const r=new Uint8Array(i),a=new Blob([r],{type:"image/png"});return new File([a],t,{type:"image/png"})}async simulateFileDrop(e,t){console.log("üìÅ Simulating file drop into DropZone");const o={0:t,length:1,item:s=>s===0?t:null},n=new DragEvent("dragenter",{bubbles:!0,cancelable:!0,dataTransfer:new DataTransfer}),i=new DragEvent("dragover",{bubbles:!0,cancelable:!0,dataTransfer:new DataTransfer}),r=new DragEvent("drop",{bubbles:!0,cancelable:!0,dataTransfer:new DataTransfer});r.dataTransfer?.items.add(t),e.dispatchEvent(n),await this.wait(50),e.dispatchEvent(i),await this.wait(50),e.dispatchEvent(r);const a=e.querySelector('input[type="file"]');a&&(console.log("üìÅ Found file input, setting files directly"),Object.defineProperty(a,"files",{value:o,writable:!1}),a.dispatchEvent(new Event("change",{bubbles:!0}))),console.log("üìÅ File drop simulation completed")}showSuccessMessage(e){const t=document.createElement("div");t.textContent=e,t.style.cssText=`
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-family: system-ui, sans-serif;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 10000;
      animation: slideInRight 0.3s ease-out;
    `,document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},3e3)}async showScreenshotInstructions(e){console.log("üì∏ Showing screenshot instructions:",e);try{console.log("üì∏ Opening photo upload interface for clipboard workflow..."),await this.openPhotoUploadInterface()}catch(m){console.error("‚ùå Failed to open photo upload interface for clipboard workflow:",m)}const t=document.createElement("div");t.id="screenshot-instructions-modal",t.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 20000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    `;const o=document.createElement("div");o.style.cssText=`
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      font-family: system-ui, sans-serif;
      animation: scaleIn 0.3s ease-out;
    `;const n=document.createElement("h2");n.textContent="üì∏ Take Screenshot",n.style.cssText=`
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      text-align: center;
    `;const i=document.createElement("p");i.textContent=e.tabCaptureError?`No doxy.me tabs found. ${e.tabCaptureError}`:"No doxy.me tabs found. Please take a manual screenshot.",i.style.cssText=`
      margin: 0 0 20px 0;
      font-size: 14px;
      color: #6b7280;
      text-align: center;
      line-height: 1.5;
    `;const r=document.createElement("div");r.style.cssText=`
      background: #f8fafc;
      border-radius: 12px;
      padding: 16px;
      margin: 20px 0;
    `,(e.instructions||["Press cmd+shift+4 to take a screenshot","Select the area you want to capture","The image will automatically be inserted when ready"]).forEach((m,g)=>{const p=document.createElement("div");p.style.cssText=`
        display: flex;
        align-items: flex-start;
        margin: ${g>0?"12px":"0"} 0 0 0;
        font-size: 14px;
        color: #374151;
        line-height: 1.5;
      `;const f=document.createElement("span");f.textContent=`${g+1}.`,f.style.cssText=`
        display: inline-block;
        width: 20px;
        font-weight: 600;
        color: #3b82f6;
        flex-shrink: 0;
      `;const h=document.createElement("span");h.textContent=m,p.appendChild(f),p.appendChild(h),r.appendChild(p)});const s=document.createElement("div");s.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: #fef3c7;
      border-radius: 8px;
      margin: 20px 0;
    `;const c=document.createElement("span");c.textContent="‚è≥ Waiting for screenshot...",c.style.cssText=`
      font-size: 14px;
      font-weight: 500;
      color: #92400e;
    `,s.appendChild(c);const l=document.createElement("button");l.textContent="üìã Manual Paste",l.style.cssText=`
      width: 100%;
      padding: 12px;
      background: #3b82f6;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-bottom: 12px;
    `,l.addEventListener("mouseenter",()=>{l.style.backgroundColor="#2563eb"}),l.addEventListener("mouseleave",()=>{l.style.backgroundColor="#3b82f6"}),l.addEventListener("click",async()=>{try{console.log("üìã Manual paste button clicked, attempting clipboard read...");const m=await navigator.clipboard.read();if(m.length===0){alert("No items found in clipboard. Please copy an image first.");return}let g=!1;for(let p=0;p<m.length;p++){const f=m[p],h=["image/png","image/jpeg","image/jpg","image/gif","image/webp","image/bmp"],b=f.types.find(y=>h.includes(y)||y.startsWith("image/"));if(b){console.log(`üìã Found image in clipboard: ${b}`);const y=await f.getType(b),v=await this.blobToBase64(y);this.closeScreenshotModal(),await this.insertImageIntoDropZone(v,"manual-paste");try{await chrome.runtime.sendMessage({type:"CLIPBOARD_MONITORING_RESULT",data:{success:!0,imageData:v,method:"manual-paste"}})}catch(E){console.error("Failed to notify service worker:",E)}g=!0;break}}g||alert("No image found in clipboard. Please copy an image and try again.")}catch(m){console.error("Manual paste failed:",m),alert("Failed to access clipboard. Please ensure you have copied an image and try again.")}});const d=document.createElement("button");d.textContent="Cancel",d.style.cssText=`
      width: 100%;
      padding: 12px;
      background: #f3f4f6;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      transition: background-color 0.2s;
    `,d.addEventListener("mouseenter",()=>{d.style.backgroundColor="#e5e7eb"}),d.addEventListener("mouseleave",()=>{d.style.backgroundColor="#f3f4f6"}),d.addEventListener("click",()=>{this.closeScreenshotModal()}),o.appendChild(n),o.appendChild(i),o.appendChild(r),o.appendChild(s),o.appendChild(l),o.appendChild(d),t.appendChild(o);const u=document.createElement("style");u.textContent=`
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes scaleIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }
      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }
      @keyframes scaleOut {
        from { transform: scale(1); opacity: 1; }
        to { transform: scale(0.9); opacity: 0; }
      }
    `,document.head.appendChild(u),document.body.appendChild(t),console.log("üì∏ Screenshot instructions modal shown")}closeScreenshotModal(){const e=document.getElementById("screenshot-instructions-modal");if(e){e.style.animation="fadeOut 0.3s ease-out";const t=e.querySelector("div");t&&(t.style.animation="scaleOut 0.3s ease-out"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300),console.log("üì∏ Screenshot instructions modal closed")}}async startClipboardMonitoring(e){console.log(`üì∏ Starting enhanced clipboard monitoring for ${e/1e3} seconds...`);const t=Date.now(),o=500;let n=null,i=0;const r=async()=>{const a=Date.now()-t;if(i++,a>=e){console.log(`‚ùå Clipboard monitoring timeout after ${i} checks over ${a/1e3} seconds`);try{await chrome.runtime.sendMessage({type:"CLIPBOARD_MONITORING_RESULT",data:{success:!1,error:`Timeout waiting for screenshot in clipboard (${i} checks)`}})}catch(s){console.error("‚ùå Failed to notify service worker of timeout:",s)}return}i%10===0&&console.log(`üì∏ Clipboard monitoring: check ${i}, ${Math.round((e-a)/1e3)}s remaining`);try{if(document.hasFocus&&!document.hasFocus()&&(console.log("üì∏ Page not focused, attempting to focus..."),window.focus(),await new Promise(u=>setTimeout(u,100))),(await navigator.permissions.query({name:"clipboard-read"})).state==="denied")throw console.error("‚ùå Clipboard read permission denied"),new Error("Clipboard read permission denied");const c=await navigator.clipboard.read(),l=c.map(u=>u.types.join(",")).join("|"),d=n!==l;d?(console.log(`üì∏ Clipboard content changed! Found ${c.length} items (check ${i})`),n=l):i%20===0&&console.log(`üì∏ No clipboard change detected (check ${i})`);for(let u=0;u<c.length;u++){const m=c[u];d&&console.log(`üì∏ Clipboard item ${u+1} types:`,m.types);const g=["image/png","image/jpeg","image/jpg","image/gif","image/webp","image/bmp","image/svg+xml","image/tiff","image/ico","image/avif"],p=m.types.find(f=>g.includes(f)||f.startsWith("image/"));if(p){console.log(`üì∏ ‚úÖ IMAGE DETECTED in clipboard! Type: ${p}, Size check starting...`);try{const f=await Promise.race([m.getType(p),new Promise((b,y)=>setTimeout(()=>y(new Error("Blob retrieval timeout")),5e3))]);if(console.log(`üì∏ ‚úÖ Successfully retrieved blob: ${f.size} bytes, type: ${f.type}`),f.size===0){console.warn("‚ö†Ô∏è Blob is empty, skipping...");continue}if(f.size>10*1024*1024){console.warn(`‚ö†Ô∏è Blob too large: ${f.size} bytes, skipping...`);continue}console.log(`üì∏ Converting ${f.size} byte blob to base64...`);const h=await this.blobToBase64(f);if(console.log(`üì∏ ‚úÖ Successfully converted to base64: ${h.length} characters`),!h.startsWith("data:image/")){console.warn("‚ö†Ô∏è Invalid base64 image data format, skipping...");continue}console.log("üéâ CLIPBOARD IMAGE PROCESSING SUCCESSFUL! Closing modal and inserting image..."),this.closeScreenshotModal(),await this.insertImageIntoDropZone(h,"clipboard");try{await chrome.runtime.sendMessage({type:"CLIPBOARD_MONITORING_RESULT",data:{success:!0,imageData:h,method:"clipboard",imageType:p,imageSize:f.size,checksCount:i}}),console.log("‚úÖ Successfully notified service worker of clipboard success")}catch(b){console.error("‚ùå Failed to notify service worker of success:",b)}return}catch(f){if(console.error(`‚ùå Failed to process clipboard image blob (${p}):`,f),u<c.length-1){console.log("üîÑ Trying next clipboard item...");continue}}}}setTimeout(r,o)}catch(s){const c=s instanceof Error?s.message:String(s);if(console.error(`‚ùå Clipboard access failed (check ${i}):`,c),c.includes("permission")||c.includes("denied")){console.error("üö´ Clipboard permission issue - stopping monitoring");try{await chrome.runtime.sendMessage({type:"CLIPBOARD_MONITORING_RESULT",data:{success:!1,error:`Clipboard permission denied: ${c}`}})}catch(l){console.error("‚ùå Failed to notify service worker of permission error:",l)}return}console.log("üîÑ Continuing monitoring with longer interval due to error..."),setTimeout(r,o*2)}};try{const a=await navigator.clipboard.read();n=a.map(s=>s.types.join(",")).join("|"),console.log(`üì∏ Initial clipboard state: ${a.length} items`)}catch(a){console.log("üì∏ Could not read initial clipboard state:",a)}console.log("üì∏ üöÄ Starting clipboard monitoring loop..."),r()}async blobToBase64(e){return new Promise((t,o)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=o,n.readAsDataURL(e)})}async extractEMRData(e){console.log("üìã Extracting EMR data for fields:",e),console.log("üìã Current page URL:",window.location.href),console.log("üìã Current page type:",window.location.href.includes("Dashboard")?"DASHBOARD":"PATIENT_PAGE");const t=document.querySelectorAll(".XestroBox");let o=document.querySelector("button.PatientDetailsButton");if(o||(o=await this.findButtonByText("Patient Record")),console.log("üìã Found XestroBox elements:",t.length),console.log("üìã Patient Record button present:",!!o),t.length===0)if(console.warn("‚ö†Ô∏è No XestroBox elements found - patient record may not be opened"),o){console.warn("üí° Patient Record button is available - attempting to open record");try{await this.ensurePatientRecordOpened();const i=document.querySelectorAll(".XestroBox");i.length===0?(console.warn("‚ö†Ô∏è Still no XestroBox elements after clicking Patient Record button"),console.warn("üí° Proceeding with extraction but results may be limited")):console.log(`‚úÖ Found ${i.length} XestroBox elements after opening record`)}catch(i){console.warn("‚ö†Ô∏è Failed to open patient record:",i)}}else console.warn("üí° EMR data extraction requires patient page with clinical fields"),console.warn("üí° Make sure you are on the correct patient page");const n={};for(const i of e)try{let r="";switch(this.normalizeFieldName(i)){case"background":r=await this.extractFieldContent("Background");break;case"investigations":case"investigation-summary":r=await this.extractFieldContent("Investigation Summary");break;case"medications":r=await this.extractFieldContent("Medications (Problem List for Phil)")||await this.extractFieldContent("Medications");break;default:r=await this.extractFieldContent(i)}n[i]=r,console.log(`üìã Extracted ${i}: ${r?r.length+" chars":"empty"}`)}catch(r){console.warn(`‚ö†Ô∏è Failed to extract field "${i}":`,r),n[i]=""}return console.log("üìã EMR data extraction completed:",Object.keys(n)),n}async extractEMRDataForAIReview(e){if(console.log("ü§ñ AI REVIEW EXTRACTION: Starting non-invasive EMR extraction for fields:",e),console.log("ü§ñ AI REVIEW EXTRACTION: Current URL:",window.location.href),console.log("ü§ñ AI REVIEW EXTRACTION: Page title:",document.title),!window.location.href.includes("my.xestro.com"))throw new Error("Not on Xestro EMR page - please navigate to my.xestro.com");const t=document.querySelectorAll(".XestroBox");if(console.log(`ü§ñ AI REVIEW EXTRACTION: Found ${t.length} XestroBox elements on page`),t.length===0)throw new Error("No XestroBox elements found - please navigate to a patient record page");console.log("ü§ñ AI REVIEW EXTRACTION: Available XestroBox titles:"),t.forEach((a,s)=>{const l=a.querySelector(".XestroBoxTitle")?.textContent||"No title";console.log(`  [${s}] "${l}"`)});const o={},n={};for(const a of e){console.log(`
ü§ñ AI REVIEW EXTRACTION: Processing field: "${a}"`);let s="",c=null;const l={fieldName:a,attempts:[]};try{const d=a.toLowerCase();switch(c=this.highlightFieldDuringExtraction(d),await this.wait(300),d){case"background":l.searchTerms=["Background"],s=await this.extractCustomNoteContent("Background"),l.attempts.push({searchTerm:"Background",result:s.length>0?"success":"empty"});break;case"investigations":case"investigation-summary":l.searchTerms=["Investigation Summary"],s=await this.extractCustomNoteContent("Investigation Summary"),l.attempts.push({searchTerm:"Investigation Summary",result:s.length>0?"success":"empty"});break;case"medications-problemlist":l.searchTerms=["Medications (Problem List for Phil)"],s=await this.extractCustomNoteContent("Medications (Problem List for Phil)"),l.attempts.push({searchTerm:"Medications (Problem List for Phil)",result:s.length>0?"success":"empty"});break;case"medications":console.warn('ü§ñ AI REVIEW EXTRACTION: Generic "medications" field requested. Trying specific fields...'),l.searchTerms=["Medications (Problem List for Phil)","Medications"],s=await this.extractCustomNoteContent("Medications (Problem List for Phil)"),l.attempts.push({searchTerm:"Medications (Problem List for Phil)",result:s.length>0?"success":"empty"}),s||(s=await this.extractCustomNoteContent("Medications"),l.attempts.push({searchTerm:"Medications",result:s.length>0?"success":"empty"}));break;default:l.searchTerms=[a],s=await this.extractCustomNoteContent(a),l.attempts.push({searchTerm:a,result:s.length>0?"success":"empty"})}l.finalResult={success:s.length>0,contentLength:s.length,preview:s.length>0?s.substring(0,100)+(s.length>100?"...":""):"No content"},s?(console.log(`‚úÖ AI REVIEW EXTRACTION: Successfully extracted "${a}": ${s.length} chars`),console.log(`   Preview: "${s.substring(0,100)}${s.length>100?"...":""}"`)):console.log(`‚ö†Ô∏è AI REVIEW EXTRACTION: No content found for "${a}"`),o[a]=s,n[a]=l}catch(d){console.error(`‚ùå AI REVIEW EXTRACTION: Failed to extract "${a}":`,d),l.error=d instanceof Error?d.message:String(d),o[a]="",n[a]=l}finally{c&&this.removeFieldHighlight(c)}}const i=Object.entries(o).filter(([,a])=>a.length>0),r=Object.keys(o).length;if(console.log(`
ü§ñ AI REVIEW EXTRACTION: SUMMARY`),console.log(`   Successful extractions: ${i.length}/${r}`),console.log("   Extraction details:",n),console.log("   Final extracted data keys:",Object.keys(o)),i.length===0)throw console.error("ü§ñ AI REVIEW EXTRACTION: No data extracted from any field"),console.log("ü§ñ AI REVIEW EXTRACTION: Diagnostic info:"),console.log("   - Available XestroBox titles:",Array.from(t).map(a=>a.querySelector(".XestroBoxTitle")?.textContent||"No title")),new Error(`No EMR data could be extracted. Available fields: ${Array.from(t).map(a=>a.querySelector(".XestroBoxTitle")?.textContent||"No title").join(", ")}`);return console.log("‚úÖ AI REVIEW EXTRACTION: Non-invasive extraction completed successfully"),o}highlightFieldDuringExtraction(e){try{let t=null;switch(e){case"background":t=this.findFieldContainer("Background");break;case"investigations":t=this.findFieldContainer("Investigation Summary")||this.findFieldContainer("Investigations");break;case"medications-problemlist":t=this.findFieldContainer("Medications")||this.findFieldContainer("Problem List");break;default:t=this.findFieldContainer(e)}return t?(t.style.transition="all 0.3s ease",t.style.boxShadow="0 0 0 3px rgba(59, 130, 246, 0.3)",t.style.backgroundColor="rgba(59, 130, 246, 0.05)",t.style.borderRadius="8px",console.log(`‚ú® Highlighted field: ${e}`),t):null}catch(t){return console.warn(`‚ö†Ô∏è Failed to highlight field ${e}:`,t),null}}removeFieldHighlight(e){try{e.style.boxShadow="",e.style.backgroundColor="",e.style.borderRadius="",setTimeout(()=>{e.style.transition=""},300),console.log("üîÑ Removed field highlighting")}catch(t){console.warn("‚ö†Ô∏è Failed to remove field highlighting:",t)}}findFieldContainer(e){try{const t=document.querySelectorAll(".XestroBoxTitle");for(const i of t)if(i.textContent?.includes(e))return i.closest(".XestroBox")||i.parentElement;const o=[`[data-field="${e.toLowerCase()}"]`,`[data-field-name="${e.toLowerCase()}"]`,`.${e.toLowerCase().replace(/\s+/g,"-")}-field`,`.field-${e.toLowerCase().replace(/\s+/g,"-")}`];for(const i of o){const r=document.querySelector(i);if(r)return r}const n=document.querySelectorAll(".XestroBox, .field, .section, .form-group");for(const i of n)if(i.textContent?.includes(e))return i;return console.log(`‚ö†Ô∏è Could not find container for field: ${e}`),null}catch(t){return console.warn(`‚ö†Ô∏è Error finding field container for ${e}:`,t),null}}normalizeFieldName(e){return e.toLowerCase().replace(/[_\s-]+/g,"-")}async extractCustomNoteContent(e){console.log(`üìã Looking for customNote content in field: "${e}"`);try{const t=await this.findXestroBoxByTitle(e);if(!t)return console.log(`‚ö†Ô∏è No XestroBox found for "${e}"`),"";const o=t.querySelectorAll(".customNote");if(console.log(`üìã Found ${o.length} customNote elements in "${e}" XestroBox`),o.length===0)return console.log(`‚ö†Ô∏è No .customNote elements found in "${e}" XestroBox`),"";let n="";for(let i=0;i<o.length;i++){const r=o[i],a=(r.textContent||r.innerText||"").trim();if(a){n?n+=`

`+a:n=a;const s=r.offsetParent!==null;console.log(`üìã Extracted customNote ${i+1} content: ${a.length} chars (visible: ${s})`)}}return n?(console.log(`‚úÖ Total customNote content for "${e}": ${n.length} chars`),n):(console.log(`‚ö†Ô∏è No visible content found in customNote elements for "${e}"`),"")}catch(t){return console.error(`‚ùå Error extracting customNote content for "${e}":`,t),""}}async extractFieldContent(e){console.log(`üìã Extracting content for field: "${e}"`);try{const t=await this.extractCustomNoteContent(e);if(t)return console.log(`üìã Found customNote content for "${e}": ${t.length} chars`),t;const o=await this.findXestroBoxByTitle(e);if(o){console.log(`‚úÖ Found XestroBox for "${e}"`);let i=!1;const r=o.querySelector(".XestroBoxTitle");r&&(r.click(),i=!0,await this.wait(300));let a="";const s=o.querySelector("textarea");if(s&&s.offsetParent!==null)a=s.value.trim(),console.log(`üìã Found textarea content for "${e}": ${a.length} chars`);else{const c=o.querySelectorAll('[contenteditable="true"]');for(const l of c){const d=l;if(d.offsetParent!==null){const u=(d.textContent||d.innerText||"").trim();if(u){a=u,console.log(`üìã Found contenteditable content for "${e}": ${u.length} chars`);break}}}}if(i&&await this.closeAnyOpenDialog(),a)return a}const n=[`textarea[data-field="${e.toLowerCase()}"]`,`textarea[placeholder*="${e}"]`,`textarea[aria-label*="${e}"]`,`#${e.replace(/\s+/g,"").toLowerCase()}`,`.${e.replace(/\s+/g,"-").toLowerCase()}`];for(const i of n){const r=document.querySelector(i);if(r&&r.offsetParent!==null){const a=r.value.trim();return console.log(`üìã Found fallback content for "${e}" via ${i}: ${a.length} chars`),a}}return console.log(`‚ö†Ô∏è No content found for field "${e}"`),""}catch(t){return console.error(`‚ùå Error extracting field "${e}":`,t),""}}async closeAnyOpenDialog(){console.log("üö™ Attempting to close any open dialogs...");try{const e=new KeyboardEvent("keydown",{key:"Escape",code:"Escape",keyCode:27,which:27,bubbles:!0,cancelable:!0});document.dispatchEvent(e),await this.wait(200);const t=['button[aria-label="Close"]',"button.close",".modal-close",".dialog-close","button:has(.fa-times)","button:has(.fa-close)",'[data-dismiss="modal"]'];for(const o of t){const n=document.querySelector(o);if(n&&n.offsetParent!==null){console.log(`üö™ Found close button: ${o}`),n.click(),await this.wait(200);break}}console.log("‚úÖ Dialog close attempt completed")}catch(e){console.error("‚ùå Error closing dialog:",e)}}async findXestroBoxByTitle(e){console.log(`üîç Looking for XestroBox with title: "${e}"`);const t=document.querySelectorAll(".XestroBox");console.log(`üîç Found ${t.length} XestroBox elements`),t.forEach((n,i)=>{const a=n.querySelector(".XestroBoxTitle")?.textContent||"No title";console.log(`üîç XestroBox ${i}: "${a}"`)});for(const n of t){const i=n.querySelector(".XestroBoxTitle");if(i&&i.textContent?.includes(e))return console.log(`‚úÖ Found XestroBox with matching title: "${i.textContent}"`),n}const o=[e.split(" ")[0],e.replace(/\s+/g,""),e.toLowerCase()];for(const n of o)for(const i of t){const r=i.querySelector(".XestroBoxTitle");if((r?.textContent?.toLowerCase()||"").includes(n.toLowerCase()))return console.log(`‚úÖ Found XestroBox with partial match: "${r?.textContent}" for "${e}"`),i}return console.log(`‚ùå No XestroBox found for title: "${e}"`),null}async saveNote(){console.log("üíæ Attempting to save note...");const e=document.getElementById("patientNotesSave")||document.querySelector('button[title*="Save"]')||document.querySelector('button:contains("Save")');if(e){e.click(),console.log("üíæ Note saved via button");return}const t=document.getElementById("AddNoteArea");if(t){const o=new KeyboardEvent("keydown",{key:"Enter",shiftKey:!0,bubbles:!0});t.dispatchEvent(o),console.log("üíæ Note saved via Shift+Enter");return}console.log("‚ùå No save method available")}async extractCalendarPatients(){if(console.log("üìÖ Starting calendar patient extraction..."),console.log("üìÖ Current page URL:",window.location.href),!this.isCalendarPage())throw new Error("Not on a calendar/appointment book page");const e=this.extractAppointmentDate();console.log("üìÖ Appointment date:",e);const t=document.querySelector("table.appointmentBook");if(!t)throw new Error("Appointment book table not found");const o=this.extractPatientsFromTable(t);return console.log("üìÖ Extracted patients:",o),{appointmentDate:e,calendarUrl:window.location.href,patients:o,totalCount:o.length}}isCalendarPage(){const e=document.querySelector(".one-appt-book, table.appointmentBook"),t=document.querySelector("input.date.form-control");return!!(e&&t)}extractAppointmentDate(){const e=document.querySelector("input.date.form-control");if(e)return e.value||e.getAttribute("data-value")||"";const t=document.querySelectorAll("[data-date]");for(const o of t){const n=o.getAttribute("data-date");if(n)return n}return new Date().toDateString()}extractPatientsFromTable(e){console.log("üìÖ Extracting patients from appointment table...");const t=[],o=e.querySelectorAll("tr.appt");return console.log(`üìÖ Found ${o.length} appointment rows`),o.forEach((n,i)=>{try{const r=n.querySelector("td.Name");if(!r||!r.textContent?.trim())return;const a=this.extractPatientFromRow(n);if(a){const s=this.validatePatientPattern(a);s.isValid?(t.push(a),console.log(`üìÖ ‚úÖ Extracted patient ${i+1} (${s.patternType}):`,a)):(console.warn(`üìÖ ‚ö†Ô∏è Patient ${i+1} has invalid pattern:`,{patient:a,reason:s.reason}),t.push({...a,_patternType:"legacy"}))}}catch(r){console.warn(`üìÖ Failed to extract patient from row ${i}:`,r)}}),console.log(`üìÖ Successfully extracted ${t.length} patients from appointment table`),t}extractPatientFromRow(e){const o=e.querySelector("td.Time")?.textContent?.trim()||"",i=e.querySelector("td.Type")?.textContent?.trim()||"",r=e.querySelector("td.Name");if(!r)return null;const a=this.parsePatientNameCell(r);if(!a)return null;const s=e.querySelector("td.Confirm"),c=this.isAppointmentConfirmed(s),l=r.querySelector(".fa-star")!==null,u=e.querySelector("td.Notes")?.textContent?.trim()||"";return{name:a.name,dob:a.dob,fileNumber:a.fileNumber,appointmentTime:o,appointmentType:i,confirmed:c,isFirstAppointment:l,notes:u||void 0}}parsePatientNameCell(e){const t=e.querySelector("span[aria-label]");if(!t)return null;const o=t.getAttribute("aria-label")||"",n=t.textContent?.trim()||"";console.log("üìÖ Parsing patient name cell:",{ariaLabel:o,displayName:n});const i=n.match(/^(.+?)\s*\((\d+)\)$/);if(i){const a=i[1].trim(),s=i[2];console.log("üìÖ Found Name (ID) pattern:",{fullName:a,patientId:s});const c=o.match(/\((\d{2}\/\d{2}\/\d{4})\)/),l=c?c[1]:"";return{name:a,dob:l,fileNumber:s}}const r=o.match(/^(.+?)\s*\((\d{2}\/\d{2}\/\d{4})\)$/);if(r){console.log("üìÖ Using legacy DOB pattern as fallback");const a=r[1].trim(),s=r[2],d=(e.querySelector("small")?.textContent?.trim()||"").replace(/[^\d]/g,"");return{name:a,dob:s,fileNumber:d}}return console.warn("üìÖ Could not parse patient name from either pattern:",{ariaLabel:o,displayName:n}),null}validatePatientPattern(e){return!e||!e.name||!e.fileNumber?{isValid:!1,patternType:"invalid",reason:"Missing name or fileNumber"}:/^\d+$/.test(e.fileNumber)&&!/\d{2}\/\d{2}\/\d{4}/.test(e.name)?{isValid:!0,patternType:"name-id"}:e.dob&&/\d{2}\/\d{2}\/\d{4}/.test(e.dob)?{isValid:!0,patternType:"legacy-dob"}:{isValid:!1,patternType:"unknown",reason:`Unrecognized pattern: name="${e.name}", fileNumber="${e.fileNumber}", dob="${e.dob}"`}}isAppointmentConfirmed(e){return e?!!e.querySelector(".fa-calendar-check.text-success"):!1}async autoSearchFromHash(){const e=window.location.hash;if(!e.includes("filing="))return;const t=e.match(/filing=([^&]+)/);if(!t)return;const o=decodeURIComponent(t[1]);console.log(`üîç Hash-based navigation detected for filing: ${o}`);try{await this.searchPatientByFiling(o)}catch(n){console.warn("‚ö†Ô∏è Hash-based search failed:",n)}setTimeout(()=>{window.location.hash.includes(`filing=${encodeURIComponent(o)}`)&&window.history.replaceState(null,"",window.location.pathname)},2e3)}async searchPatientByFiling(e){console.log(`üîç Searching for patient by filing: ${e}`);const t=document.querySelector("#PatientSelectorInput");if(!t)throw new Error("PatientSelectorInput not found - Xestro may not be ready");t.value=e,t.focus(),t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),console.log("üîç Typed filing number, waiting for dropdown..."),await this.wait(200);let o=0,n=!1;for(;o<30;){const i=document.querySelector(".ui-autocomplete"),r=i?.querySelectorAll(".ui-menu-item"),a=r&&r.length>0,s=i&&i.style.display!=="none";if(console.log(`üîç Autocomplete menu status (attempt ${o+1}/30):`,{menuExists:!!i,itemCount:r?.length||0,isVisible:s,display:i?.style.display}),a&&s){console.log("‚úÖ Autocomplete menu ready with items"),n=!0;break}await this.wait(100),o++}n||console.warn("‚ö†Ô∏è Autocomplete menu did not appear within 3 seconds, proceeding anyway..."),t.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown",keyCode:40,code:"ArrowDown",bubbles:!0})),console.log("‚¨áÔ∏è Pressed Down Arrow to select first result"),await this.wait(200),["keydown","keyup","keypress"].forEach(i=>{t.dispatchEvent(new KeyboardEvent(i,{key:"Enter",keyCode:13,code:"Enter",bubbles:!0}))}),console.log("‚úÖ Pressed Enter (keydown/keyup/keypress) - patient navigation should complete")}async navigateToPatient(e,t){console.log(`üß≠ Navigating to patient: ${t} (Filing: ${e})`);const o=`#filing=${encodeURIComponent(e)}`;window.location.hash=o,console.log(`‚úÖ Set hash to ${o} - auto-search will trigger`)}async activatePatientByElement(e){console.log(`üñ±Ô∏è Activating patient by element: ${e}`),console.log(`üñ±Ô∏è Current page URL: ${window.location.href}`),console.log(`üñ±Ô∏è Page title: ${document.title}`);let t=null;if(typeof e=="number"){const i=document.querySelector("table.appointmentBook");if(!i){const s=document.querySelectorAll("table"),c=Array.from(s).map(l=>l.className||"no-class");throw console.error("üñ±Ô∏è table.appointmentBook not found. Available tables:",c),new Error(`Appointment table not found. Expected table.appointmentBook. Found ${s.length} tables: ${c.join(", ")}`)}const r=i.querySelectorAll("tr.appt");console.log(`üñ±Ô∏è Found ${r.length} appointment rows`);const a=Array.from(r).map(s=>s.querySelector("td.Name")).filter(s=>s&&s.textContent?.trim());if(console.log(`üñ±Ô∏è Found ${a.length} valid patient elements`),e>=a.length)throw new Error(`Patient index ${e} out of range. Found ${a.length} patients from ${r.length} rows.`);t=a[e],console.log(`üñ±Ô∏è Found patient element by index ${e}`)}else{if(t=document.querySelector(e),!t)throw new Error(`Patient element not found using selector: ${e}`);console.log(`üñ±Ô∏è Found patient element by selector: ${e}`)}const o=this.extractPatientInfoFromElement(t);console.log(`üñ±Ô∏è Activating patient: ${o.name} (${o.fileNumber})`),t.click(),console.log("üñ±Ô∏è Patient name clicked"),await this.wait(1e3),this.checkPatientActivation(t)?console.log("‚úÖ Patient activation confirmed visually"):console.warn("‚ö†Ô∏è Patient activation not visually confirmed, proceeding anyway"),await this.ensurePatientRecordOpened(),console.log(`‚úÖ Successfully activated patient: ${o.name}`)}extractPatientInfoFromElement(e){const t=e.querySelector("span[aria-label]"),o=e.querySelector("small");if(!t)return{name:"Unknown",dob:"",fileNumber:""};const i=(t.getAttribute("aria-label")||"").match(/^(.+?)\s*\((.+?)\)$/),r=i?i[1].trim():t.textContent?.trim()||"Unknown",a=i?i[2]:"",s=o?.textContent?.replace(/[^\d]/g,"")||"";return{name:r,dob:a,fileNumber:s}}checkPatientActivation(e){const t=e.closest("tr");return t?t.classList.contains("selected")||t.classList.contains("active")||t.style.backgroundColor!==""||t.querySelector(".fa-check")!==null||window.getComputedStyle(t).backgroundColor!=="rgba(0, 0, 0, 0)":!1}async doubleClickPatient(e,t){console.log(`üëÜ Double-clicking patient: ${e} (ID: ${t})`),console.log(`üëÜ Current URL: ${window.location.href}`),console.log(`üëÜ Page title: ${document.title}`);const o=document.querySelector("table.appointmentBook");if(!o)throw new Error("Appointment book table not found. Make sure you are on the appointment calendar page.");const n=o.querySelectorAll("tr.appt");console.log(`üëÜ Found ${n.length} appointment rows in table`);let i=null;for(const a of Array.from(n)){const s=a.querySelector("td.Name");if(!s)continue;const c=s.querySelector("span[aria-label]");if(!c)continue;const l=c.getAttribute("aria-label")||"",d=c.textContent?.trim()||"",u=l.includes(e)||d.includes(e);if(u){const m=a.textContent||"",g=m.includes(t);if(console.log("üëÜ Found potential match:",{ariaLabel:l,displayName:d,nameMatches:u,hasFileNumber:g,rowText:m.substring(0,100)}),g||n.length===1){i=c,console.log("üëÜ Selected patient element in row:",{ariaLabel:l,displayName:d,className:c.className,tagName:c.tagName});break}}}if(!i)throw console.error("üëÜ ERROR: Patient not found in appointment book"),console.error(`üëÜ Search criteria: Name="${e}", ID="${t}"`),console.error("üëÜ Available patients:",Array.from(n).map((a,s)=>{const l=a.querySelector("td.Name")?.querySelector("span[aria-label]");return{index:s,ariaLabel:l?.getAttribute("aria-label"),displayName:l?.textContent?.trim(),rowText:a.textContent?.substring(0,100)}})),new Error(`Patient not found in appointment book: ${e} (${t})`);console.log("üëÜ Performing double-click on patient element...");const r=new MouseEvent("dblclick",{bubbles:!0,cancelable:!0,view:window});i.dispatchEvent(r),console.log("üëÜ Double-click event dispatched"),console.log("üëÜ Waiting 1 second for navigation..."),await this.wait(1e3),console.log(`üëÜ Double-click completed for patient: ${e}`),console.log(`üëÜ Post-click URL: ${window.location.href}`),console.log(`üëÜ Post-click title: ${document.title}`)}async navigateToPatientRecord(){console.log("üè• Navigating to Patient Record view");const e=this.findButtonByText("Patient Record")||this.findButtonByText("Patient")||document.querySelector('button[title*="Patient Record"]')||document.querySelector('a[href*="patient"]');if(!e)throw new Error("Patient Record button not found in navigation");if(console.log("üè• Found Patient Record button, clicking..."),e instanceof HTMLElement)e.click();else throw new Error("Patient Record button is not a clickable element");await this.wait(2e3);const t=document.querySelectorAll(".XestroBox").length;t===0&&console.warn("üè• Patient Record view may not have loaded (no XestroBoxes found)"),console.log(`üè• Navigation to Patient Record completed (${t} XestroBoxes found)`)}async navigateToAppointmentBook(){console.log("üìÖ Navigating back to Appointment Book view"),console.log(`üìÖ Current URL: ${window.location.href}`),console.log(`üìÖ Page title: ${document.title}`),console.log("üìÖ Inspecting available navigation elements...");const e=document.querySelectorAll("button");console.log(`üìÖ All buttons found (${e.length}):`,Array.from(e).map((a,s)=>({index:s,textContent:a.textContent?.trim(),className:a.className,id:a.id,title:a.title,onclick:a.onclick?"has onclick":"no onclick",visible:a.offsetParent!==null})));const t=document.querySelectorAll("a");console.log(`üìÖ All links found (${t.length}):`,Array.from(t).map((a,s)=>({index:s,textContent:a.textContent?.trim(),href:a.href,className:a.className,id:a.id,title:a.title,visible:a.offsetParent!==null}))),console.log("üìÖ Searching for navigation buttons...");const o=["Appointment Book","Appointments","Calendar","Dashboard","Home","Back","Close","Return"];let n=null,i="";for(const a of o){console.log(`üìÖ Searching for pattern: "${a}"`);const s=this.findButtonByText(a);if(s){n=s,i=a,console.log(`üìÖ Found button with pattern "${a}":`,{textContent:s.textContent?.trim(),className:s.className,id:s.id,tagName:s.tagName});break}}if(!n){console.log("üìÖ Trying specific selectors...");const a=['button[title*="Appointment"]','a[href*="appointment"]','button[title*="Dashboard"]','a[href*="Dashboard"]','button.btn-default:contains("Back")','button.btn-default:contains("Close")',".navbar-nav a",".nav-tabs a",".breadcrumb a"];for(const s of a)try{const c=document.querySelector(s);c&&(console.log(`üìÖ Found element with selector "${s}":`,{textContent:c.textContent?.trim(),className:c.className,id:c.id,tagName:c.tagName,href:c.href}),n||(n=c,i=`selector: ${s}`))}catch{}}if(!n)throw console.error("üìÖ ERROR: No navigation button found"),console.error("üìÖ DOM inspection complete - no suitable navigation element located"),new Error("Appointment Book button not found in navigation");if(console.log(`üìÖ Found navigation button with pattern "${i}", clicking...`),n instanceof HTMLElement)n.click(),console.log("üìÖ Clicked navigation button successfully");else throw console.error("üìÖ ERROR: Found element is not clickable HTMLElement"),new Error("Appointment Book button is not a clickable element");console.log("üìÖ Waiting 2 seconds for page transition..."),await this.wait(2e3),console.log("üìÖ Verifying navigation result..."),console.log(`üìÖ New URL: ${window.location.href}`),console.log(`üìÖ New title: ${document.title}`);const r=document.querySelectorAll(".appointmentBook, .one-appt-book, input.date.form-control");console.log(`üìÖ Calendar elements found: ${r.length}`),r.length===0&&(console.warn("üìÖ WARNING: Appointment Book view may not have loaded (no calendar elements found)"),console.warn("üìÖ Current page elements:",{xestroBoxes:document.querySelectorAll(".XestroBox").length,buttons:document.querySelectorAll("button").length,links:document.querySelectorAll("a").length,forms:document.querySelectorAll("form").length})),console.log(`üìÖ Navigation to Appointment Book completed (${r.length} calendar elements found)`)}async extractPatientFields(){console.log("üìã Extracting patient fields from Patient Record view"),console.log(`üìã Current URL: ${window.location.href}`),console.log(`üìã Page title: ${document.title}`);const e=document.querySelectorAll(".XestroBox").length;if(console.log(`üìã XestroBox count: ${e}`),e===0)throw console.error("üìã ERROR: No XestroBoxes found - not in Patient Record view"),new Error("Not in Patient Record view - no XestroBoxes found");const t=document.querySelectorAll(".XestroBox");console.log("üìã XestroBox details:",Array.from(t).map((a,s)=>({index:s,id:a.id,className:a.className,textContent:a.textContent?.substring(0,100)+"..."}))),console.log("üìã Performing smart empty field detection...");const o=this.detectEmptyFieldsVisually();console.log("üìã Visual field detection results:",o),console.log("üìã Starting optimized field extraction...");const n=await this.extractEMRDataOptimized(["background","investigations","medications","problemList"],o);console.log("üìã Raw extracted data:",{background:{length:n.background?.length||0,preview:n.background?.substring(0,100)||"EMPTY",hasContent:!!n.background?.trim()},investigations:{length:n.investigations?.length||0,preview:n.investigations?.substring(0,100)||"EMPTY",hasContent:!!n.investigations?.trim()},medications:{length:n.medications?.length||0,preview:n.medications?.substring(0,100)||"EMPTY",hasContent:!!n.medications?.trim()},problemList:{length:n.problemList?.length||0,preview:n.problemList?.substring(0,100)||"EMPTY",hasContent:!!n.problemList?.trim()}});const i=[n.background,n.investigations,n.medications,n.problemList].some(a=>a&&a.trim().length>0);console.log(`üìã Data validation: hasAnyData = ${i}`),i||console.warn("üìã WARNING: No meaningful data extracted from any field");const r={background:n.background||"",investigations:n.investigations||"",medications:n.medications||"",problemList:n.problemList||"",extractionTimestamp:Date.now(),xestroBoxCount:e,hasAnyData:i};return console.log("üìã Final extraction result:",r),r}detectEmptyFieldsVisually(){console.log("üîç Scanning page for empty field visual indicators...");const e={background:!1,investigations:!1,medications:!1,problemList:!1},t=document.querySelectorAll('div[style*="color:#ccc"], div[style*="color: #ccc"], .empty-field, .no-content');return console.log(`üîç Found ${t.length} potential empty field indicators`),t.forEach((o,n)=>{const i=o.textContent?.toLowerCase()||"";console.log(`üîç Indicator ${n}: "${i.substring(0,50)}..."`),(i.includes("no background")||i.includes("no history")||i.includes("background summary"))&&(e.background=!0,console.log("üîç ‚úÖ Background field detected as empty")),(i.includes("no investigation")||i.includes("no results")||i.includes("investigation summary"))&&(e.investigations=!0,console.log("üîç ‚úÖ Investigations field detected as empty")),(i.includes("no medication")||i.includes("no drugs")||i.includes("medications"))&&(e.medications=!0,console.log("üîç ‚úÖ Medications field detected as empty")),(i.includes("no problems")||i.includes("no conditions")||i.includes("problem list"))&&(e.problemList=!0,console.log("üîç ‚úÖ Problem list field detected as empty"))}),e}async extractEMRDataOptimized(e,t){console.log("üìã Starting optimized extraction for fields:",e),console.log("üìã Empty field status:",t);const o={};for(const n of e){const i=n.toLowerCase();if(t[i]){console.log(`‚ö° OPTIMIZATION: Skipping empty field "${n}" - detected visually as empty`),o[n]="";continue}console.log(`üìã Extracting content for field: "${n}" (not empty)`);let r="";try{switch(i){case"background":r=await this.extractFieldContent("Background");break;case"investigations":case"investigation-summary":r=await this.extractFieldContent("Investigation Summary");break;case"medications":r=await this.extractFieldContent("Medications (Problem List for Phil)")||await this.extractFieldContent("Medications");break;case"problemlist":r=await this.extractFieldContent("Problem List");break;default:r=await this.extractFieldContent(n)}o[n]=r,console.log(`‚úÖ Extracted ${r.length} characters from ${n}`)}catch(a){console.warn(`‚ö†Ô∏è Failed to extract ${n}:`,a),o[n]=""}}return o}findButtonByText(e){const o=Array.from(document.querySelectorAll("button, a")).find(n=>n.textContent?.trim().toLowerCase().includes(e.toLowerCase())||n.title?.toLowerCase().includes(e.toLowerCase()));return o instanceof HTMLElement?o:null}async findElementWithRetry(e,t=5e3,o=3){for(let n=0;n<o;n++){console.log(`üîÑ Attempt ${n+1}/${o} to find element...`);for(const i of e){console.log(`üîç Trying selector: ${i}`);const r=await this.findElement(i,t/o);if(r)return console.log(`‚úÖ Found element with selector: ${i}`),r}n<o-1&&(console.log(`‚è≥ Retry ${n+1} failed, waiting before next attempt...`),await this.wait(1e3))}return console.log(`‚ùå All attempts failed to find element with selectors: ${e.join(", ")}`),null}async findProfilePictureTab(){console.log("üîç Searching for Profile Picture tab with multiple strategies...");const e=Array.from(document.querySelectorAll('.description, .tab, .tab-item, [role="tab"], .nav-item'));for(const n of e)if(n.textContent?.includes("Profile Picture"))return console.log("‚úÖ Found Profile Picture tab via exact text match"),n;const t=["profile","picture","photo","image","avatar"];for(const n of e){const i=n.textContent?.toLowerCase()||"";if(t.some(r=>i.includes(r)))return console.log(`‚úÖ Found potential Profile Picture tab via text variation: ${n.textContent?.trim()}`),n}const o=document.querySelectorAll('.modal .description, .patient-edit .description, [class*="patient"] .tab');for(const n of o)if(n.textContent?.toLowerCase().includes("profile")||n.textContent?.toLowerCase().includes("picture"))return console.log(`‚úÖ Found Profile Picture tab in modal/patient section: ${n.textContent?.trim()}`),n;return console.log("‚ùå Could not find Profile Picture tab with any strategy"),null}showErrorMessage(e){const t=document.createElement("div");t.textContent=`‚ö†Ô∏è ${e}`,t.style.cssText=`
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ef4444;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-family: system-ui, sans-serif;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 10000;
      max-width: 400px;
      animation: slideInRight 0.3s ease-out;
    `,document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},5e3)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{new x}):new x}
