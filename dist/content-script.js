const w="2.6.1-session-name-fix";console.log("üè• Operator Chrome Extension Content Script Loading...",window.location.href);console.log("üìù Content Script Version:",w);console.log("‚è∞ Load Time:",new Date().toISOString());console.log("üîß EXTRACT_EMR_DATA handler: ENABLED");console.log("üîß AI Review support: ENABLED");if(window.operatorContentScriptLoaded)console.log("üè• Content script already loaded, skipping..."),console.log("üìù Previously loaded version:",window.operatorContentScriptVersion||"unknown");else{window.operatorContentScriptLoaded=!0,window.operatorContentScriptVersion=w;class x{isInitialized=!1;emrSystem=null;currentTabId=null;blockGlobalFileDrop=!1;constructor(){this.initialize()}async initialize(){if(!this.isInitialized)try{this.emrSystem=this.detectEMRSystem(),this.emrSystem?(console.log(`üè• Operator Chrome Extension: Detected ${this.emrSystem.name}`),this.setupEventListeners(),this.isInitialized=!0,console.log("üè• Content script initialized successfully")):console.log("üè• EMR system not detected on this page:",window.location.href)}catch(e){console.error("Content script initialization failed:",e)}}detectEMRSystem(){return window.location.hostname.includes("my.xestro.com")?{name:"Xestro",baseUrl:"https://my.xestro.com",fields:{investigationSummary:{selector:'textarea[data-field="investigation-summary"], #investigation-summary, .investigation-summary textarea, #AddNoteArea',type:"textarea",label:"Investigation Summary",waitFor:'.XestroBoxTitle:contains("Investigation Summary")'},background:{selector:'textarea[data-field="background"], #background, .background textarea',type:"textarea",label:"Background",waitFor:'.XestroBoxTitle:contains("Background")'},medications:{selector:'textarea[data-field="medications"], #medications, .medications textarea',type:"textarea",label:"Medications"},notes:{selector:'textarea[data-field="notes"], #notes, .notes textarea, #AddNoteArea',type:"textarea",label:"Notes"},testsRequested:{selector:'.TestsRequested input[type="text"], .tests-requested-tagit input[type="text"], ul.TestsRequested li.tagit-new input',type:"input",label:"Tests Requested"},labField:{selector:"ul li input.ui-widget-content.ui-autocomplete-input, li.tagit-new input.ui-widget-content.ui-autocomplete-input, .ui-widget-content.ui-autocomplete-input:not(.PatientName):not(#PatientName), #Lab.form-control.LabForm.ui-autocomplete-input",type:"input",label:"Lab Autocomplete Field"}},selectors:{patientRecord:".patient-record, .record-view, #patient-view",noteArea:'#AddNoteArea, .note-area, textarea[placeholder*="note"]',quickLetter:'.quick-letter, .QuickLetter, [data-action="quick-letter"]',taskButton:'.task-button, [data-action="create-task"]'}}:null}setupEventListeners(){chrome.runtime.onMessage.addListener((t,n,i)=>(this.handleMessage(t,n,i),!0)),document.addEventListener("keydown",t=>{this.handleKeyboardShortcut(t)});const e=t=>{if(this.blockGlobalFileDrop)return t.preventDefault(),t.stopPropagation(),!1};window.addEventListener("dragover",e,!0),window.addEventListener("drop",e,!0),new MutationObserver(t=>{this.handleDOMChanges(t)}).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","id"]})}async handleMessage(e,o,t){console.log("üè• Content script received message:",e),console.log("üìù Content script version:",w,"at",new Date().toISOString()),console.log("üîß Available message types: EXTRACT_EMR_DATA, EXECUTE_ACTION, SHOW_SCREENSHOT_INSTRUCTIONS, START_CLIPBOARD_MONITORING");try{const{type:n,action:i,data:r}=e;if(console.log("üì® Processing message type:",n,"action:",i),n==="PING"){t({success:!0,ready:!0,version:w});return}if(n==="SET_FILE_DROP_GUARD"){this.blockGlobalFileDrop=!!e.enabled,console.log("üõ°Ô∏è File drop guard set to",this.blockGlobalFileDrop),t({success:!0,enabled:this.blockGlobalFileDrop});return}if(n==="PAGE_STATUS_CHECK"){try{const s=this.getPageStatus();t({success:!0,status:s})}catch(s){t({success:!1,error:s instanceof Error?s.message:"Page status check failed"})}return}if(n==="CHECK_XESTRO_BOXES"){try{const s=document.querySelectorAll(".XestroBox").length,a=s>0;console.log(`üìã XestroBox check: found ${s} boxes, hasPatientData: ${a}`),t({success:!0,found:a,count:s,url:window.location.href})}catch(s){t({success:!1,error:s instanceof Error?s.message:"XestroBox check failed"})}return}if(n==="SHOW_SCREENSHOT_INSTRUCTIONS"){await this.showScreenshotInstructions(r),t({success:!0});return}if(n==="CLOSE_SCREENSHOT_INSTRUCTIONS"){this.closeScreenshotModal(),t({success:!0});return}if(n==="START_CLIPBOARD_MONITORING"){console.log("üì∏ Content script received START_CLIPBOARD_MONITORING request"),this.startClipboardMonitoring(r.timeoutMs||3e4),t({success:!0});return}if(n==="EXTRACT_EMR_DATA"){console.log("üìã Received EXTRACT_EMR_DATA request - HANDLER FOUND!"),console.log("üìã Request data:",r),console.log("üìã Extracting fields:",r?.fields||["background","investigations","medications"]);try{const s=await this.extractEMRData(r?.fields||["background","investigations","medications"]);console.log("üìã EMR extraction completed successfully:",s),t({success:!0,data:s})}catch(s){console.error("üìã EMR extraction failed:",s),t({success:!1,error:s instanceof Error?s.message:"EMR extraction failed"})}return}if(n==="EXTRACT_EMR_DATA_AI_REVIEW"){console.log("ü§ñ Received EXTRACT_EMR_DATA_AI_REVIEW request - NON-INVASIVE EXTRACTION"),console.log("ü§ñ Request data:",r),console.log("ü§ñ Extracting fields (non-invasive):",r?.fields||["background","investigations","medications-problemlist"]);try{const s=await this.extractEMRDataForAIReview(r?.fields||["background","investigations","medications-problemlist"]);console.log("ü§ñ AI Review EMR extraction completed successfully:",s),t({success:!0,data:s})}catch(s){console.error("ü§ñ AI Review EMR extraction failed:",s),t({success:!1,error:s instanceof Error?s.message:"AI Review EMR extraction failed"})}return}if(n==="EXTRACT_PATIENT_DATA"){console.log("üë§ Received EXTRACT_PATIENT_DATA request");try{const s=this.extractPatientData();console.log("üë§ Patient data extraction completed:",s),t({success:!0,data:s})}catch(s){console.error("üë§ Patient data extraction failed:",s),t({success:!1,error:s instanceof Error?s.message:"Patient data extraction failed"})}return}if(n!=="EXECUTE_ACTION"){console.log("‚ùå Unknown message type:",n),t({error:"Unknown message type"});return}switch(console.log(`üè• Executing action: ${i}`),i){case"insertText":await this.insertText(r.text,r.fieldType),t({success:!0});break;case"openField":await this.openFieldByType(r.fieldType),t({success:!0});break;case"investigation-summary":if(r?.extractOnly){const a=await this.extractFieldContent("Investigation Summary");t({success:!0,data:a})}else if(r?.insertMode==="append"&&r?.content){console.log("üìù Investigation Summary: Opening field and appending content"),await this.openInvestigationSummary(),await this.wait(500);const a=await this.findNoteArea();if(a)await this.insertTextAtEndOfField(a,r.content),console.log("‚úÖ Content appended to Investigation Summary field");else throw console.error("‚ùå Could not find note area for appending"),new Error("Note area not found for content insertion");t({success:!0})}else await this.openInvestigationSummary(),r?.content&&(await this.wait(500),await this.insertFormattedSummary(r.content)),t({success:!0});break;case"background":if(r?.extractOnly){const a=await this.extractFieldContent("Background");t({success:!0,data:a})}else if(r?.insertMode==="append"&&r?.content){console.log("üìù Background: Opening field and appending content"),await this.openBackground(),await this.wait(500);const a=await this.findNoteArea();if(a)await this.insertTextAtEndOfField(a,r.content),console.log("‚úÖ Content appended to Background field");else throw console.error("‚ùå Could not find note area for appending"),new Error("Note area not found for content insertion");t({success:!0})}else await this.openBackground(),t({success:!0});break;case"medications":if(r?.extractOnly){const a=await this.extractFieldContent("Medications (Problem List for Phil)")||await this.extractFieldContent("Medications");t({success:!0,data:a})}else if(r?.insertMode==="append"&&r?.content){console.log("üìù Medications: Opening field and appending content"),await this.openMedications(),await this.wait(500);const a=await this.findNoteArea();if(a)await this.insertTextAtEndOfField(a,r.content),console.log("‚úÖ Content appended to Medications field");else throw console.error("‚ùå Could not find note area for appending"),new Error("Note area not found for content insertion");t({success:!0})}else await this.openMedications(),t({success:!0});break;case"social-history":if(r?.insertMode==="append"&&r?.content){console.log("üìù Social History: Opening field and appending content"),await this.openSocialHistory(),await this.wait(500);const a=await this.findNoteArea();if(a)await this.insertTextAtEndOfField(a,r.content),console.log("‚úÖ Content appended to Social History field");else throw console.error("‚ùå Could not find note area for appending"),new Error("Note area not found for content insertion");t({success:!0})}else await this.openSocialHistory(),t({success:!0});break;case"bloods":await this.clickPathologyButton(),await this.setupLabField(),t({success:!0});break;case"bloods-insert":await this.insertIntoLabField(r.content),t({success:!0});break;case"imaging":await this.clickRadiologyButton(),t({success:!0});break;case"extract-patient-data":const s=this.extractPatientData();t(s?{success:!0,data:s}:{success:!1,error:"No patient data found"});break;case"quick-letter":await this.openQuickLetter(),t({success:!0});break;case"create-task":await this.createTask(),t({success:!0});break;case"appointment-wrap-up":await this.appointmentWrapUp(r),t({success:!0});break;case"profile-photo":await this.handleProfilePhoto(r),t({success:!0});break;case"save":await this.saveNote(),t({success:!0});break;case"ai-medical-review":console.warn("‚ö†Ô∏è AI medical review should be processed entirely in side panel"),t({success:!0,message:"AI medical review should use side panel processing only"});break;case"extract-calendar-patients":console.log("üìÖ Received extract-calendar-patients request");try{const a=await this.extractCalendarPatients();console.log("üìÖ Calendar patient extraction completed:",a),t({success:!0,data:a})}catch(a){console.error("üìÖ Calendar patient extraction failed:",a),t({success:!1,error:a instanceof Error?a.message:"Calendar extraction failed"})}break;case"navigate-to-patient":console.log("üß≠ Received navigate-to-patient request");try{await this.navigateToPatient(r.fileNumber,r.patientName),t({success:!0})}catch(a){console.error("üß≠ Patient navigation failed:",a),t({success:!1,error:a instanceof Error?a.message:"Navigation failed"})}break;case"activate-patient-by-element":console.log("üñ±Ô∏è Received activate-patient-by-element request");try{await this.activatePatientByElement(r.patientSelector||r.patientIndex),t({success:!0})}catch(a){console.error("üñ±Ô∏è Patient activation failed:",a),t({success:!1,error:a instanceof Error?a.message:"Patient activation failed"})}break;case"double-click-patient":console.log("üëÜ SWITCH CASE HIT: double-click-patient"),console.log("üëÜ Received double-click-patient request with data:",r),console.log("üëÜ About to call this.doubleClickPatient method...");try{await this.doubleClickPatient(r.patientName,r.patientId),console.log("üëÜ doubleClickPatient method completed successfully"),t({success:!0})}catch(a){console.error("üëÜ Double-click patient failed:",a),t({success:!1,error:a instanceof Error?a.message:"Double-click patient failed"})}break;case"navigate-to-patient-record":console.log("üè• SWITCH CASE HIT: navigate-to-patient-record"),console.log("üè• Received navigate-to-patient-record request"),console.log("üè• About to call this.navigateToPatientRecord method...");try{await this.navigateToPatientRecord(),console.log("üè• navigateToPatientRecord method completed successfully"),t({success:!0})}catch(a){console.error("üè• Navigate to patient record failed:",a),t({success:!1,error:a instanceof Error?a.message:"Navigate to patient record failed"})}break;case"navigate-to-appointment-book":console.log("üìÖ Received navigate-to-appointment-book request");try{await this.navigateToAppointmentBook(),t({success:!0})}catch(a){console.error("üìÖ Navigate to appointment book failed:",a),t({success:!1,error:a instanceof Error?a.message:"Navigate to appointment book failed"})}break;case"extract-patient-fields":console.log("üìã SWITCH CASE HIT: extract-patient-fields"),console.log("üìã Received extract-patient-fields request"),console.log("üìã About to call extractPatientFields method...");try{const a=await this.extractPatientFields();console.log("üìã extractPatientFields completed, sending response:",a),t({success:!0,data:a})}catch(a){console.error("üìã Extract patient fields failed:",a),t({success:!1,error:a instanceof Error?a.message:"Extract patient fields failed"})}break;default:console.log(`‚ùå DEFAULT CASE HIT: Unknown action "${i}"`),console.log("‚ùå Available SPA actions: double-click-patient, navigate-to-patient-record, extract-patient-fields"),t({error:"Unknown action"})}}catch(n){console.error("Content script message handling error:",n),t({error:n instanceof Error?n.message:"Unknown error"})}}handleKeyboardShortcut(e){if(!(!(e.ctrlKey||e.metaKey)||!e.shiftKey))switch(e.key.toLowerCase()){case"i":e.preventDefault(),this.openInvestigationSummary();break;case"b":e.preventDefault(),this.openBackground();break;case"m":e.preventDefault(),this.openMedications();break;case"s":e.preventDefault(),this.openSocialHistory();break;case"l":e.preventDefault(),this.openQuickLetter();break;case"t":e.preventDefault(),this.createTask();break}}handleDOMChanges(e){for(const o of e)o.type==="childList"&&o.addedNodes.forEach(t=>{t.nodeType===Node.ELEMENT_NODE&&t.matches?.(".note-area, textarea, .field-container")&&this.updateFieldMappings()})}async insertText(e,o){let t=null;if(o&&this.emrSystem?.fields[o]?o==="investigationSummary"||o==="investigation-summary"?(console.log("üìù Special handling for Investigation Summary insertion - waiting for AddNoteArea"),t=await this.findElement("#AddNoteArea",3e3),t?console.log("‚úÖ Found AddNoteArea for Investigation Summary insertion"):(console.log("‚ö†Ô∏è AddNoteArea not found, falling back to Investigation Summary textarea"),t=await this.findElement(this.emrSystem.fields[o].selector))):t=await this.findElement(this.emrSystem.fields[o].selector):(t=document.activeElement,this.isTextInputElement(t)||(t=await this.findActiveNoteArea())),!t)throw new Error("No suitable text input found");await this.insertTextIntoElement(t,e)}async openFieldByType(e){switch(console.log(`üìù Opening EMR field by type: ${e}`),e){case"investigationSummary":case"investigation-summary":console.log("üìù Using openInvestigationSummary() for field opening"),await this.openInvestigationSummary();break;case"background":console.log("üìù Using openBackground() for field opening"),await this.openBackground();break;case"medications":console.log("üìù Using openMedications() for field opening"),await this.openMedications();break;default:if(console.log(`üìù Using fallback field opening for: ${e}`),!this.emrSystem?.fields[e])throw new Error(`Unknown field type: ${e}`);const o=this.emrSystem.fields[e],t=await this.findElement(o.selector,5e3);if(t)this.focusElement(t);else throw new Error(`Field ${e} not found`);break}console.log(`‚úÖ Field ${e} opened successfully`)}async insertTextIntoElement(e,o){if(e.tagName==="TEXTAREA"||e.tagName==="INPUT"){const t=e,n=t.selectionStart||0,i=t.selectionEnd||0,r=t.value,s=r.slice(0,n)+o+r.slice(i);t.value=s;const a=n+o.length;t.setSelectionRange(a,a),t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}))}else if(e.contentEditable==="true"){const t=window.getSelection();if(t&&t.rangeCount>0){const n=t.getRangeAt(0);n.deleteContents(),n.insertNode(document.createTextNode(o)),n.collapse(!1),t.removeAllRanges(),t.addRange(n)}else e.textContent+=o;e.dispatchEvent(new Event("input",{bubbles:!0}))}e.focus()}async insertFormattedSummary(e){console.log("üìù Inserting formatted investigation summary:",e);try{const o=await this.findInvestigationSummaryTextarea();if(!o){console.error("‚ùå No Investigation Summary textarea (AddNoteArea) found");return}await this.insertTextAtEndOfField(o,e),console.log("‚úÖ Successfully inserted formatted investigation summary")}catch(o){console.error("‚ùå Error inserting formatted summary:",o)}}async findInvestigationSummaryTextarea(){console.log("üîç Looking for Investigation Summary textarea...");const e=['.XestroBox:has(.XestroBoxTitle:contains("Investigation Summary")) textarea','.XestroBox:has(.XestroBoxTitle:contains("Investigation Summary")) .AddNoteArea','[data-field="investigation-summary"] textarea',"#investigation-summary textarea",".investigation-summary textarea"];for(const t of e){console.log(`üîç Trying Investigation Summary specific selector: ${t}`);const n=await this.findElement(t,2e3);if(n&&n.tagName==="TEXTAREA")return console.log(`‚úÖ Found Investigation Summary specific textarea with selector: ${t}`),n}const o=["textarea#AddNoteArea:focus","textarea.AddNoteArea:focus","textarea#AddNoteArea","textarea.AddNoteArea",'textarea[placeholder*="Add a note"]',"textarea.form-control.AddNoteArea"];for(const t of o){console.log(`üîç Trying generic selector: ${t}`);const n=await this.findElement(t,1e3);if(n&&n.tagName==="TEXTAREA"){const i=n.getBoundingClientRect(),r=i.top>=0&&i.left>=0&&i.bottom<=window.innerHeight&&i.right<=window.innerWidth,s=i.top<window.innerHeight*.8;if(r&&s)return console.log(`‚úÖ Found suitable Investigation Summary textarea with selector: ${t}`),n;console.log(`‚ö†Ô∏è Found textarea but it appears to be at bottom of page, skipping: ${t}`)}}return console.warn("‚ö†Ô∏è Could not find suitable Investigation Summary textarea with any selector"),null}async insertTextAtEndOfField(e,o){if(e.tagName==="TEXTAREA"||e.tagName==="INPUT"){const t=e;console.log("üìù Inserting into input/textarea:",{id:t.id,className:t.className,length:t.value?.length||0});const n=t.value;let i=o;n.trim().length>0&&(i=`
`+o);const r=n.length;t.setSelectionRange(r,r);const s=n+i;t.value=s;const a=s.length;t.setSelectionRange(a,a),t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),t.focus(),e.tagName==="TEXTAREA"&&(t.scrollTop=t.scrollHeight),console.log(`üìù Inserted text at end of field. Field now has ${s.length} characters.`)}else if(e.contentEditable==="true"){console.log("üìù Inserting into contenteditable element:",{id:e.id,className:e.className}),e.focus();const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t?.removeAllRanges(),t?.addRange(n);const i=e.textContent||"";let r=o;i.trim().length>0&&(r=`
`+o),n.insertNode(document.createTextNode(r)),n.collapse(!1),t?.removeAllRanges(),t?.addRange(n),e.dispatchEvent(new Event("input",{bubbles:!0})),e.focus()}console.log("‚úÖ Text inserted at end of field and field kept focused for review")}async openInvestigationSummary(){console.log("üìù Opening Investigation Summary section in Xestro"),await this.openCustomField("Investigation Summary")}async openCustomFieldWithTemplate(e,o){console.log(`üìù Opening ${e} with template in note area`);const t=await this.findNoteArea();if(!t)throw console.error("‚ùå No suitable note area found on page"),new Error("Note area not found");t.focus();const n=o(),i=t.contentEditable==="true",r=i?t.innerText||"":t.value||"",s=n.split(`
`)[0];if(!r.includes(s)){const a=`${n}
${r}`;if(i)t.innerText=a,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}));else{const c=t;c.value=a,c.dispatchEvent(new Event("input",{bubbles:!0})),c.dispatchEvent(new Event("change",{bubbles:!0}))}}t.style.boxShadow="0 0 5px 2px rgba(33, 150, 243, 0.5)",setTimeout(()=>{t.style.boxShadow=""},1e3),t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{const a=document.querySelector("#patientNotesSave");a&&confirm("Save the updated notes?")&&(a.click(),console.log("üíæ Auto-saved via Xestro save button"))},1e3),console.log("‚úÖ Note area ready for input with template (Xestro method)")}async findNoteArea(){console.log("üîç Looking for Xestro note input areas...");const e=document.getElementById("AddNoteArea");if(e&&e.offsetParent!==null)return console.log("‚úÖ Using AddNoteArea textarea as note area"),e;const o=["#patientNotesInput","#patientNoteInput",".patient-notes-input",'[contenteditable="true"]'];for(const i of o){const r=document.querySelector(i);if(r&&r.offsetParent!==null)return console.log(`‚úÖ Found Xestro note area with selector: ${i}`),r}const t=document.querySelectorAll('[contenteditable="true"], [contenteditable]');console.log(`üîç Found ${t.length} contenteditable elements:`),t.forEach((i,r)=>{console.log(`  ${r+1}. ID: "${i.id}" Class: "${i.className}" Size: ${i.offsetWidth}x${i.offsetHeight}`)});const n=document.querySelectorAll("textarea");console.log(`üîç Found ${n.length} textareas:`),n.forEach((i,r)=>{console.log(`  ${r+1}. ID: "${i.id}" Class: "${i.className}" Placeholder: "${i.placeholder}"`)});for(let i=0;i<t.length;i++){const r=t[i];if(r.offsetParent!==null&&r.offsetWidth>50&&r.offsetHeight>30)return console.log(`‚úÖ Found usable contenteditable at index ${i+1}`),r}for(let i=0;i<n.length;i++){const r=n[i];if(r.offsetParent!==null&&!r.readOnly&&!r.disabled&&r.offsetWidth>50&&r.offsetHeight>30)return console.log(`‚úÖ Found usable textarea at index ${i+1}${r.id?` (id: ${r.id})`:""}`),r}return console.log("‚è≥ No textarea found immediately, waiting for dynamic content..."),new Promise(i=>{let r,s;const a=()=>{r&&clearTimeout(r),s&&s.disconnect()},c=()=>{const d=document.getElementById("AddNoteArea");if(d&&d.offsetParent!==null){console.log("‚úÖ Found AddNoteArea dynamically"),a(),i(d);return}for(const g of o){const m=document.querySelector(g);if(m&&m.offsetParent!==null){console.log(`‚úÖ Found note area dynamically with selector: ${g}`),a(),i(m);return}}const u=document.querySelectorAll("textarea");for(let g=0;g<u.length;g++){const m=u[g];if(m.offsetParent!==null&&!m.readOnly&&!m.disabled&&m.offsetWidth>50&&m.offsetHeight>30){console.log(`‚úÖ Found usable textarea dynamically at index ${g+1}`),a(),i(m);return}}};s=new MutationObserver(d=>{let u=!1;d.forEach(g=>{g.type==="childList"&&g.addedNodes.forEach(m=>{if(m.nodeType===Node.ELEMENT_NODE){const p=m;(p.tagName==="TEXTAREA"||p.querySelector("textarea"))&&(u=!0)}})}),u&&c()}),s.observe(document.body,{childList:!0,subtree:!0});const l=setInterval(c,500);r=setTimeout(()=>{a(),clearInterval(l),console.log("‚ùå Timeout waiting for textarea"),i(null)},1e4),c()})}async openCustomField(e){if(console.log(`üìù Opening ${e} section in Xestro`),!await this.findAndClickXestroBox(e))throw console.error(`‚ùå Could not find XestroBox for ${e}`),new Error(`XestroBox for ${e} not found`);console.log("‚è≥ Waiting for AddNoteArea textarea to appear...");const t=await this.waitForAddNoteArea();if(!t)throw console.error("‚ùå AddNoteArea textarea did not appear after clicking XestroBox"),new Error("AddNoteArea textarea not found");t.focus(),console.log(`‚úÖ Found AddNoteArea textarea for ${e}`);const i=(t.value||"").length;t.setSelectionRange(i,i),t.dispatchEvent(new Event("focus",{bubbles:!0})),t.style.boxShadow="0 0 5px 2px rgba(33, 150, 243, 0.5)",setTimeout(()=>{t.style.boxShadow=""},1e3),t.scrollIntoView({behavior:"smooth",block:"center"}),console.log(`‚úÖ ${e} section opened and ready for input`)}async openBackground(){console.log("üìù Opening Background in note area"),await this.openCustomField("Background")}async openMedications(){console.log("üìù Opening Medications section in Xestro"),await this.openCustomField("Medications (Problem List for Phil)")}async openSocialHistory(){console.log("üìù Opening Social & Family History section in Xestro"),await this.openCustomField("Social & Family History")}async clickPathologyButton(){console.log("ü©∏ Clicking Order Pathology icon in Xestro");let e=document.getElementById("OrderPathologyInvestigations");if(!e&&(console.log("üîç Icon ID not found, trying button fallback..."),e=document.querySelector("button.btn-default.NewPathology"),!e)){console.log("üîç Button selector failed, trying text-based fallback...");const o=document.querySelectorAll("button.btn-default");for(const t of o){const n=t.textContent?.toLowerCase()||"";if(n.includes("pathology")||n.includes("order pathology")){e=t,console.log("‚úÖ Found pathology element via text search");break}}}if(e)console.log("ü©∏ Found pathology element, clicking..."),e.click(),await this.wait(500),console.log("‚úÖ Order Pathology clicked successfully");else throw console.error("‚ùå Order Pathology element not found"),new Error("Order Pathology element not found. Please ensure you are on the correct EMR page with pathology access.")}async setupLabField(){console.log('ü©∏ Setting up Lab field - typing "Generic Pathology Request" and pressing Enter');let e=null;e=document.querySelector("#Lab"),e||(console.log("üîç #Lab field not found, trying XPath-based selector..."),e=document.evaluate("/html/body/div[2]/div[7]/div/div[3]/div/div[1]/form/div/div[1]/div[2]/div/input[1]",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue),e||(console.log("üîç XPath failed, trying class-based fallback..."),e=document.querySelector("input.form-control.LabForm.ui-autocomplete-input")),e?(console.log('ü©∏ Found Lab setup field, typing "Generic Pathology Request"...',{id:e.id,classes:e.className,tagName:e.tagName}),e.focus(),e.value="",e.value="Generic Pathology Request",e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),e.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",bubbles:!0})),e.dispatchEvent(new KeyboardEvent("keyup",{key:"Enter",bubbles:!0})),e.dispatchEvent(new KeyboardEvent("keypress",{key:"Enter",bubbles:!0})),setTimeout(()=>{e.blur()},100),console.log('‚úÖ Lab field setup completed: typed "Generic Pathology Request" and pressed Enter')):console.warn("‚ö†Ô∏è Lab field (#Lab) not found - user may need to navigate manually")}async insertIntoLabField(e){console.log("ü©∏ Inserting blood test results into tagit field:",e.substring(0,100));let o=null;if(o=document.evaluate("/html/body/div[2]/div[7]/div/div[3]/div/div[1]/form/div/div[4]/div[2]/div/ul/li/input",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,!o){console.log("üîç XPath failed, trying tagit-specific selectors...");const n=["ul li input.ui-widget-content.ui-autocomplete-input","li.tagit-new input.ui-widget-content.ui-autocomplete-input","ul.tagit li input.ui-widget-content",".ui-widget-content.ui-autocomplete-input:not(#Lab):not(.form-control)"];for(const i of n){const r=document.querySelectorAll(i);for(const s of r){if(s.id==="Lab"||s.classList.contains("form-control")||s.classList.contains("LabForm")){console.log(`üö´ Results: Skipping #Lab setup field: ${s.id}`);continue}o=s,console.log(`ü©∏ Results: Found tagit field with selector: ${i}`,s);break}if(o)break}}if(o&&(o.id==="PatientName"||o.classList.contains("PatientName")||o.name==="PatientName"||o.id==="Lab"||o.classList.contains("form-control")||o.classList.contains("LabForm"))){console.error("üö® ERROR: Still targeting wrong field! Aborting insertion to prevent data corruption."),console.error("   Found element:",{id:o.id,classes:o.className,name:o.name,isPatientName:o.id==="PatientName",isLabSetupField:o.id==="Lab"});return}if(o)console.log("ü©∏ Found correct tagit field for results insertion...",{id:o.id,classes:o.className,name:o.name,tagName:o.tagName}),o.focus(),o.value=e,o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0})),o.classList.contains("ui-autocomplete-input")&&(o.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",bubbles:!0})),o.dispatchEvent(new KeyboardEvent("keyup",{key:"Enter",bubbles:!0})),o.closest("li.tagit-new")&&(console.log("ü©∏ Detected tagit field, triggering additional events"),o.dispatchEvent(new KeyboardEvent("keypress",{key:"Enter",bubbles:!0})),o.dispatchEvent(new Event("blur",{bubbles:!0})),setTimeout(()=>{o&&o.focus()},100))),console.log("‚úÖ Blood test results inserted into tagit field successfully");else return console.warn("‚ö†Ô∏è Tagit field not found, falling back to Tests Requested field"),this.insertIntoTestsRequestedField(e)}async insertIntoTestsRequestedField(e){console.log("ü©∏ Inserting blood test content into Tests Requested field:",e.substring(0,100));const o=this.emrSystem?.fields.testsRequested;if(!o)throw new Error("Tests Requested field not defined for this EMR system");let t=await this.findElement(o.selector,5e3);if(!t){console.log("üîç Tests Requested field not found, trying alternative selectors...");const n=[".TestsRequested input",".tests-requested-tagit input","ul.TestsRequested input",".tagit-new input",'[name="Tests"] + .tagit input'];for(const i of n)if(t=document.querySelector(i),t){console.log("‚úÖ Found Tests Requested field with selector:",i);break}}if(!t)throw console.error("‚ùå Tests Requested field not found"),new Error("Tests Requested field not found. Please ensure you are on the pathology ordering page.");if(t.tagName==="INPUT"){const n=t;n.focus(),n.value=e,["input","change","keyup"].forEach(s=>{const a=new Event(s,{bubbles:!0});n.dispatchEvent(a)});const r=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,bubbles:!0});n.dispatchEvent(r),console.log("‚úÖ Content inserted into Tests Requested field")}else console.warn("‚ö†Ô∏è Found element is not an input field, treating as generic element"),await this.insertTextIntoElement(t,e)}async clickRadiologyButton(){console.log("üì∑ Clicking Order Radiology icon in Xestro");let e=document.getElementById("orderRadiologInvestigations");if(!e&&(console.log("üîç Icon ID not found, trying button fallback..."),e=document.querySelector("button.btn-default.NewRadiology"),!e)){console.log("üîç Button selector failed, trying text-based fallback...");const o=document.querySelectorAll("button.btn-default");for(const t of o){const n=t.textContent?.toLowerCase()||"";if(n.includes("radiology")||n.includes("order radiology")){e=t,console.log("‚úÖ Found radiology element via text search");break}}}if(e)console.log("üì∑ Found radiology element, clicking..."),e.click(),await this.wait(500),console.log("‚úÖ Order Radiology clicked successfully");else throw console.error("‚ùå Order Radiology element not found"),new Error("Order Radiology element not found. Please ensure you are on the correct EMR page with radiology access.")}async openQuickLetter(){const e=await this.findElement('button:contains("Quick Letter"), [data-action="quick-letter"], .quick-letter-btn, .QuickLetter');if(e)e.click();else{const o=await this.findActiveNoteArea();o&&this.focusElement(o)}}async createTask(){const e=await this.findElement('button:contains("Task"), [data-action="create-task"], .task-btn, .create-task');e?e.click():console.warn("Task creation button not found")}async appointmentWrapUp(e){this.emrSystem?.name==="Xestro"?await this.xestroAppointmentWrapUp(e):console.warn("Appointment wrap-up not implemented for this EMR system")}async xestroAppointmentWrapUp(e){const o=await this.findElement('button.btn.btn-primary.appt-wrap-up-btn, [data-action="appt-wrap-up"]');o&&(o.click(),await this.wait(1500),e.preset&&await this.populateAppointmentPreset(e.preset))}findPatientDetailsXestroBoxContent(){console.log("üîç Strategy: Patient Details XestroBoxContent - looking for patient details section...");const e=document.querySelector(".XestroBox.PatientDetailsContent .XestroBoxContent");if(e)return console.log("‚úÖ Found PatientDetailsContent XestroBoxContent via class selector"),e;const o=document.querySelectorAll(".XestroBoxTitle");console.log(`üîç Found ${o.length} XestroBoxTitle elements`);for(let t=0;t<o.length;t++){const n=o[t],i=n.textContent?.trim()||"";if(console.log(`üîç XestroBoxTitle ${t+1}: "${i}"`),i==="Patient Details"){console.log('‚úÖ Found "Patient Details" title, looking for next sibling XestroBoxContent...');let r=n.nextElementSibling;for(;r;){if(r.classList.contains("XestroBoxContent"))return console.log("‚úÖ Found Patient Details XestroBoxContent via title search!"),r;r=r.nextElementSibling}const s=n.parentElement;if(s){const a=s.querySelector(".XestroBoxContent");if(a)return console.log("‚úÖ Found Patient Details XestroBoxContent in parent!"),a}}}return console.log("‚ùå No Patient Details XestroBoxContent found"),null}extractFromPatientSelectorInput(){console.log("üîç Strategy: Patient Selector Input - checking for patient data...");try{const e=document.querySelector("#PatientSelectorInput");if(e&&(e.value||e.placeholder)){const o=(e.value||e.placeholder).trim();if(o&&!o.toLowerCase().includes("select")&&!o.toLowerCase().includes("search"))return console.log("‚úÖ Found patient name in selector input:",o),{name:o,extractedAt:Date.now(),extractionMethod:"patientSelectorInput"}}return console.log("‚ùå No patient data found in selector input"),null}catch(e){return console.error("‚ùå Error extracting from patient selector input:",e),null}}extractFromHiddenInputs(){console.log("üîç Strategy: Hidden Input Fields - checking for patient data...");try{const e={extractedAt:Date.now(),extractionMethod:"hiddenInputs"},o=document.querySelector("#PatientName"),t=document.querySelector("#DialogTitleName"),n=document.querySelector("#PatientID_FYI");if(console.log("üîç Found input elements:",{patientName:o?.value||"not found",dialogTitle:t?.value||"not found",patientId:n?.value||"not found"}),t&&t.value){const i=t.value.trim();console.log("‚úÖ Found DialogTitleName:",i);const r=i.match(/^(.+?)\s*\((\d+)\)$/);r?(e.name=r[1].trim(),e.id=r[2],console.log("üìù Extracted from DialogTitleName - Name:",e.name,"ID:",e.id)):(e.name=i,console.log("üìù Extracted name only from DialogTitleName:",e.name))}return!e.name&&o&&o.value&&(e.name=o.value.trim(),console.log("üìù Extracted from PatientName input:",e.name)),!e.id&&n&&n.value&&(e.id=n.value.trim(),console.log("üìù Extracted from PatientID_FYI input:",e.id)),e.name?(console.log("‚úÖ Successfully extracted from hidden inputs:",e),e):(console.log("‚ùå No patient data found in hidden inputs"),null)}catch(e){return console.error("‚ùå Error extracting from hidden inputs:",e),null}}extractPatientData(){console.log("üë§ Extracting patient data from Xestro EMR page...");try{const e={extractedAt:Date.now()},o=this.extractFromHiddenInputs();if(o&&o.name)return console.log("‚úÖ Successfully extracted using Hidden Inputs strategy:",o),o;let t=this.findPatientDetailsXestroBoxContent();if(t){console.log("‚úÖ Strategy 2: Found Patient Details XestroBoxContent");const a=this.extractFromXestroBoxContent(t,e);if(a&&a.name)return console.log("‚úÖ Successfully extracted using PatientDetailsXestroBoxContent strategy:",a),a}else console.log("‚ùå Strategy 2: No Patient Details XestroBoxContent found");const n=this.extractFromPatientSelectorInput();if(n&&n.name)return console.log("‚úÖ Successfully extracted using PatientSelectorInput strategy:",n),n;const i=Array.from(document.querySelectorAll("div")).filter(a=>{const c=a.textContent||"",l=/^(Mr|Mrs|Ms|Dr|Miss)\s+[A-Za-z\s\(\)]+/.test(c.trim()),d=a.querySelector(".pull-right"),u=c.includes("ID:");return l&&d&&u});if(i.length>0){t=i[0],console.log(`‚úÖ Strategy 2: Found patient data in patient details div (${i.length} candidates)`);const a=this.extractFromPatientDetailsDiv(t,e);if(a&&a.name)return console.log("‚úÖ Successfully extracted using PatientDetailsDiv strategy:",a),a}const r=document.querySelectorAll("div");for(let a=0;a<r.length;a++){const c=r[a],l=c.textContent||"";if(l.includes("ID:")&&/\d{4,6}/.test(l)&&c.querySelectorAll("div").length>=3){console.log("‚úÖ Strategy 3: Found potential patient data in generic div");const u=this.extractFromGenericPatientDiv(c,e);if(u&&u.name)return console.log("‚úÖ Successfully extracted using GenericPatientDiv strategy:",u),u}}console.log("‚ö†Ô∏è All primary strategies failed, attempting fallback extraction...");const s=this.extractPatientDataFallback(e);return s&&s.name?(console.log("‚úÖ Successfully extracted using fallback strategy:",s),s):(console.log("‚ùå All extraction strategies failed. Page structure might be different."),console.log("üîç Available elements for debugging:"),console.log("- .XestroBoxContent elements:",document.querySelectorAll(".XestroBoxContent").length),console.log("- .pull-right elements:",document.querySelectorAll(".pull-right").length),console.log('- Elements with "ID:" text:',Array.from(document.querySelectorAll("*")).filter(a=>a.textContent?.includes("ID:")).length),null)}catch(e){return console.error("‚ùå Error extracting patient data:",e),null}}extractFromXestroBoxContent(e,o){console.log("üìã Extracting from XestroBoxContent...");const t=e.querySelector("div");return t?this.extractFromPatientDetailsDiv(t,o):(console.log("‚ùå No content div found in XestroBoxContent"),null)}extractFromPatientDetailsDiv(e,o){console.log("üìã Extracting from patient details div...");try{let t="";const n=e.querySelector(":scope > div");if(n){console.log("üîç Found first child div, extracting direct text content...");const l=[];for(let d=0;d<n.childNodes.length;d++){const u=n.childNodes[d];if(u.nodeType===Node.TEXT_NODE){const g=u.textContent?.trim()||"";g&&l.push(g)}}l.length>0&&(t=l.join(" ").trim(),console.log("‚úÖ Extracted name from text nodes:",t))}if(!t){console.log("üîç Text node extraction failed, trying fallback strategies...");const l=e,d=Array.from(l.querySelectorAll(":scope > div div, :scope > div")).filter(u=>!u.closest(".pull-right"));for(const u of d){const g=(u.textContent||"").trim();if(g&&/^(Mr|Mrs|Ms|Dr|Miss)\b/.test(g)&&!/\bID:\b/.test(g)){t=g,console.log("‚úÖ Extracted name from fallback element:",t);break}}}if(!t){const l=e.firstChild;l&&l.nodeType===Node.TEXT_NODE&&(t=(l.textContent||"").trim())}if(!t){const l=e.firstElementChild;if(l){const d=(e.textContent||"").trim(),u=(l.textContent||"").trim(),g=d.replace(u,"").trim();g&&!/\bID:\b/.test(g)&&(t=g)}}if(!t){const d=(e.textContent||"").match(/\b(Mr|Mrs|Ms|Dr|Miss)\s+([A-Za-z\s\(\)]+?)(?=\s*ID:|$)/);d&&(t=d[0].trim())}t&&(o.name=t,console.log("üìù Extracted name:",o.name));const i=Array.from(e.querySelectorAll("div")),r=i.find(l=>{const d=l.textContent?.trim()||"";return/^0\d{2,3}\s?\d{3}\s?\d{3}$/.test(d.replace(/\s/g,""))});r&&(o.phone=r.textContent?.trim(),console.log("üìû Extracted phone:",o.phone));const s=i.find(l=>(l.textContent?.trim()||"").toLowerCase().includes("medicare"));s&&(o.medicare=s.textContent?.trim(),console.log("üè• Extracted Medicare status:",o.medicare));const a=e.querySelector(".pull-right");if(a){const l=a.querySelector("b");if(l&&l.textContent){const g=l.textContent.match(/ID:\s*(\d+)/);g&&(o.id=g[1],console.log("üìù Extracted ID:",o.id))}const u=(a.textContent||"").match(/(\d{2}\/\d{2}\/\d{4})\s*\((\d+)\)/);u&&(o.dob=u[1],o.age=u[2],console.log("üìù Extracted DOB:",o.dob,"Age:",o.age))}return e.querySelectorAll('div[data-allow="1"]').forEach((l,d)=>{const u=l.textContent?.trim()||"";u&&(/^[\d\s\-\(\)\+]{8,}$/.test(u)?(o.phone=u,console.log("üìù Extracted phone:",o.phone)):u.includes("@")&&u.includes(".")?(o.email=u,console.log("üìù Extracted email:",o.email)):/\b(VIC|NSW|QLD|SA|WA|TAS|ACT|NT)\b/i.test(u)&&(o.address=u,console.log("üìù Extracted address:",o.address)))}),i.forEach(l=>{const d=l.textContent?.trim()||"";if(d)if(d.includes("Medicare:")){const u=d.match(/Medicare:\s*([^<]+)/);u&&(o.medicare=u[1].trim(),console.log("üìù Extracted Medicare:",o.medicare))}else(d.includes("Private")||d.includes("Limited:"))&&(o.insurance=d,console.log("üìù Extracted insurance:",o.insurance))}),o}catch(t){return console.error("‚ùå Error in extractFromPatientDetailsDiv:",t),null}}extractFromGenericPatientDiv(e,o){return console.log("üìã Extracting from generic patient div..."),this.extractFromPatientDetailsDiv(e,o)}extractPatientDataFallback(e){console.log("üìã Attempting fallback patient data extraction...");try{const o=Array.from(document.querySelectorAll("*")).filter(t=>t.textContent?.includes("ID:")&&/ID:\s*\d{4,6}/.test(t.textContent));for(const t of o){const n=t.textContent||"",i=n.match(/ID:\s*(\d+)/);i&&(e.id=i[1],console.log("üìù Fallback extracted ID:",e.id));const r=n.match(/(Mr|Mrs|Ms|Dr|Miss)\s+[A-Za-z\s\(\)]+/);if(r){e.name=r[0].trim(),console.log("üìù Fallback extracted name:",e.name);break}const s=t.parentElement;if(s){const c=(s.textContent||"").match(/(Mr|Mrs|Ms|Dr|Miss)\s+[A-Za-z\s\(\)]+/);if(c){e.name=c[0].trim(),console.log("üìù Fallback extracted name from parent:",e.name);break}}}return e.name||e.id?e:null}catch(o){return console.error("‚ùå Error in fallback extraction:",o),null}}async populateAppointmentPreset(e){try{if(await this.wait(500),e.itemCode){const o=await this.findElement("input.item-codes-autocomplete, input.ui-autocomplete-input");o?(o.value="",o.value=e.itemCode,o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0})),console.log(`‚úÖ Populated Item Code: ${e.itemCode}`)):console.warn("‚ö†Ô∏è Item codes input field not found")}if(e.notes){const o=await this.findElement("textarea.Notes, textarea.form-control");o?(o.value="",o.value=e.notes,o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0})),console.log(`‚úÖ Populated Appointment Notes: ${e.notes}`)):console.warn("‚ö†Ô∏è Appointment notes textarea not found")}console.log(`‚úÖ Successfully applied preset: ${e.displayName}`)}catch(o){console.error("‚ùå Error populating appointment preset:",o)}}async ensurePatientRecordView(){if(!this.emrSystem)return;if(!await this.findElement(this.emrSystem.selectors.patientRecord,1e3)){const o=await this.findElement('button:contains("Record"), [data-view="record"], .record-view-btn');o&&(o.click(),await this.wait(2e3))}}async ensurePatientRecordOpened(){console.log("üîç Ensuring patient record is opened...");const e=document.querySelectorAll(".XestroBox");console.log(`üîç Initial XestroBox count: ${e.length}`);let o=await this.findElement("button.PatientDetailsButton");if(o||(o=await this.findButtonByText("Patient Record")),o||(o=await this.findButtonByText("Patient")),!o){const t=document.querySelectorAll("button.btn-default");for(const n of t)if(n.textContent?.includes("Patient")){o=n;break}}if(o){console.log("üîç Found Patient Record button, clicking..."),o.click(),await this.wait(3e3);const t=document.querySelectorAll(".XestroBox");console.log(`üîç Final XestroBox count: ${t.length}`),t.length===0?console.warn("‚ö†Ô∏è Patient record button clicked but no clinical content found"):t.length>e.length?console.log("‚úÖ Patient record opened successfully - clinical content detected"):console.log("‚ÑπÔ∏è Patient record may have already been open")}else console.warn("‚ö†Ô∏è Patient Record button not found - proceeding with extraction"),console.log("üí° Available buttons:",Array.from(document.querySelectorAll("button")).map(t=>t.textContent?.trim()).filter(Boolean))}async findActiveNoteArea(){return this.emrSystem?await this.findElement(this.emrSystem.selectors.noteArea):null}async findElement(e,o=5e3){const t=Date.now();for(;Date.now()-t<o;){if(e.includes(":contains(")){const n=e.match(/(.+):contains\("(.+)"\)/);if(n){const[,i,r]=n,s=document.querySelectorAll(i);for(const a of s)if(a.textContent?.includes(r))return a}}else{const n=document.querySelector(e);if(n)return n}await this.wait(100)}return null}focusElement(e){e.focus(),e.scrollIntoView({behavior:"smooth",block:"center"});const o=e.style.cssText;e.style.cssText+="border: 2px solid #3b82f6 !important; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5) !important;",setTimeout(()=>{e.style.cssText=o},2e3)}isTextInputElement(e){if(!e)return!1;const o=e.tagName.toLowerCase();return o==="textarea"||o==="input"&&["text","email","search","url"].includes(e.type)||e.contentEditable==="true"}updateFieldMappings(){}async findAndClickXestroBox(e){console.log(`üîç Looking for XestroBox with title "${e}"`);const o=document.querySelectorAll(".XestroBox");console.log(`Found ${o.length} XestroBox elements`);for(let t=0;t<o.length;t++){const n=o[t],i=n.querySelector(".XestroBoxTitle");if(i&&i.textContent?.includes(e))return console.log(`‚úÖ Found XestroBox for "${e}" at index ${t}`),console.log(`üñ±Ô∏è Clicking XestroBox title: "${i.textContent}"`),i.click(),await this.wait(500),n}return console.log(`‚ùå No XestroBox found with title containing "${e}"`),o.forEach((t,n)=>{const i=t.querySelector(".XestroBoxTitle");console.log(`  ${n+1}. XestroBoxTitle: "${i?.textContent||"No title"}"`)}),null}async waitForAddNoteArea(){for(let n=0;n<50;n++){const i=document.getElementById("AddNoteArea");if(i&&i.offsetParent!==null)return console.log(`‚úÖ AddNoteArea found after ${n*100}ms`),i;n%10===0&&console.log(`‚è≥ Still waiting for AddNoteArea... (${n*100}ms)`),await this.wait(100)}return console.log("‚ùå AddNoteArea not found after 5000ms"),null}async wait(e){return new Promise(o=>setTimeout(o,e))}getPageStatus(){const e=window.location.href,o=document.title,t=document.readyState,n=document.querySelectorAll(".XestroBox").length>0,i=document.querySelector("#patientNotesInput, #AddNoteArea")!==null,r=document.querySelectorAll(".appointmentBook, .one-appt-book").length>0,s=document.querySelector("input.date.form-control")!==null;let a="unknown";return r&&s?a="calendar":n&&i?a="patient":e.includes("Dashboard")&&(a="dashboard"),{url:e,title:o,readyState:t,pageType:a,isReady:t==="complete"&&(a==="calendar"||a==="patient"&&n),elements:{xestroBoxCount:document.querySelectorAll(".XestroBox").length,hasPatientNotes:i,hasCalendarElements:r,hasDateInput:s},timestamp:Date.now()}}async handleProfilePhoto(e){if(console.log("üì∏ Handling profile photo capture:",e),e?.imageData)try{console.log("üì∏ Opening photo upload interface..."),await this.openPhotoUploadInterface(),await this.insertImageIntoDropZone(e.imageData,e.method||"tab-capture"),console.log("‚úÖ Profile photo workflow completed successfully")}catch(o){throw console.error("‚ùå Profile photo workflow failed:",o),this.showErrorMessage(`Profile photo failed: ${o instanceof Error?o.message:"Unknown error"}`),o}else throw console.log("üì∏ No image data provided, showing capture instructions"),this.showErrorMessage("Profile photo capture requires image data"),new Error("Profile photo capture requires image data")}async insertImageIntoDropZone(e,o){console.log(`üì∏ Inserting image into DropZone using method: ${o}`);try{console.log("üîç Step 4: Looking for DropZone element...");const t=await this.findDropZone();if(!t)throw console.error("‚ùå Step 4 failed: DropZone not found on page"),console.log("üîç This usually means the Upload button click did not work properly"),console.log("üîç Current page state:"),console.log("  - URL:",window.location.href),console.log("  - Modal elements:",document.querySelectorAll('.modal, [class*="modal"]').length),console.log("  - Upload elements:",document.querySelectorAll('input[type="file"], [class*="upload"], [class*="drop"]').length),this.showErrorMessage("Upload area not found. Please try clicking the profile photo manually and then use the extension."),new Error("DropZone field not found - the upload interface may not have loaded properly");console.log("‚úÖ Step 4 completed: Found DropZone element"),console.log("üì∏ DropZone details:",{tagName:t.tagName,id:t.id,className:t.className,visible:t.offsetParent!==null}),console.log("üîÑ Step 5: Converting image data to file...");const n=await this.base64ToFile(e,"profile-photo.png");console.log("‚úÖ Step 5 completed: File created",{name:n.name,size:n.size,type:n.type}),console.log("üîÑ Step 6: Simulating file drop..."),await this.simulateFileDrop(t,n),console.log("‚úÖ Step 6 completed: File drop simulation finished"),await this.wait(1e3),document.querySelector('img[src*="blob:"], img[src*="data:"], .uploaded-image, .image-preview')?(console.log("‚úÖ Upload appears successful - found uploaded image preview"),this.showSuccessMessage("Profile photo uploaded successfully!")):(console.log("‚ö†Ô∏è Upload status unclear - no image preview detected"),this.showSuccessMessage("Profile photo uploaded (verification incomplete)")),console.log("‚úÖ Profile photo insertion workflow completed")}catch(t){throw console.error("‚ùå Error inserting image into DropZone:",t),this.showErrorMessage(`Failed to upload profile photo: ${t instanceof Error?t.message:"Unknown error"}`),t}}async openPhotoUploadInterface(){console.log("üîÑ Starting photo upload interface navigation...");try{console.log("üîÑ Step 1: Clicking sidebar patient photo...");const e=await this.findElementWithRetry(["#SidebarPatientPhoto",".sidebar-patient-photo",'[id*="patient"][id*="photo" i]','img[alt*="patient" i]'],5e3,3);if(!e)throw console.error("‚ùå Step 1 failed: Could not find sidebar patient photo"),console.log("üîç Available elements on page:",document.querySelectorAll('[id*="patient"], [class*="patient"], img').length),new Error("Could not find sidebar patient photo. The patient edit window may not have opened correctly.");console.log("‚úÖ Found sidebar patient photo element:",e.id||e.className),e.click(),await this.wait(1500),console.log("üîç Validating patient photo click result..."),await this.wait(500),console.log("üîÑ Step 2: Clicking Profile Picture tab/description...");const o=await this.findProfilePictureTab();if(!o)throw console.error("‚ùå Step 2 failed: Could not find Profile Picture tab"),console.log("üîç Available descriptions:",Array.from(document.querySelectorAll('.description, .tab, .tab-item, [role="tab"]')).map(n=>n.textContent?.trim()).filter(n=>n)),new Error("Could not find Profile Picture tab. The patient modal may not have opened correctly.");console.log("‚úÖ Found Profile Picture tab:",o.textContent?.trim()),o.click(),await this.wait(1500),console.log("üîÑ Step 3: Clicking Upload New button...");const t=await this.findElementWithRetry(["#UploadPhotoButton",'button:contains("Upload New")','button:contains("Upload")','button:contains("Browse")','[data-action="upload"]','input[type="file"]'],5e3,3);if(!t)throw console.error("‚ùå Step 3 failed: Could not find Upload button"),console.log("üîç Available buttons in profile section:",Array.from(document.querySelectorAll('button, input[type="file"]')).map(n=>n.textContent?.trim()||n.getAttribute("type")).filter(n=>n)),new Error("Could not find Upload New button. The Profile Picture tab may not have loaded correctly.");console.log("‚úÖ Found upload button:",t.textContent?.trim()||t.tagName),t.click(),await this.wait(2e3),console.log("‚úÖ Photo upload interface navigation completed successfully")}catch(e){throw console.error("‚ùå Failed to open photo upload interface:",e),console.log("üîç Current page URL:",window.location.href),console.log("üîç Current page title:",document.title),console.log("üîç Page contains patient edit elements:",document.querySelectorAll('[id*="edit"], [class*="edit"], .modal').length>0),new Error(`Navigation failed at step: ${e instanceof Error?e.message:"Unknown error"}`)}}async findDropZone(){console.log("üîç Looking for DropZone element...");let e=await this.waitForDropZone();if(e)return console.log("‚úÖ Found DropZone with primary selector"),e;const o=['[class*="dropzone" i]','[class*="drop-zone" i]','[class*="file-drop" i]','[class*="upload-zone" i]',".file-upload-area",'[data-drop="true"]','input[type="file"]'];return console.log("üîç Trying alternative DropZone selectors..."),e=await this.findElementWithRetry(o,5e3,2),e?(console.log("‚úÖ Found DropZone with alternative selector"),e):(console.warn("‚ö†Ô∏è Could not find DropZone even with alternative selectors"),console.log("üîç Available file-related elements:",document.querySelectorAll('input[type="file"], [class*="upload"], [class*="drop"]').length),null)}async waitForDropZone(e=5e3){console.log("‚è≥ Waiting for DropZone to appear...");const o=Date.now(),t=200;for(;Date.now()-o<e;){const n=document.querySelector("#DropZone");if(n&&n.offsetParent!==null)return console.log("‚úÖ DropZone appeared and is visible"),n;await this.wait(t)}return console.log("‚ùå Timeout waiting for DropZone to appear"),null}async base64ToFile(e,o){const t=e.replace(/^data:image\/\w+;base64,/,""),n=atob(t),i=new Array(n.length);for(let a=0;a<n.length;a++)i[a]=n.charCodeAt(a);const r=new Uint8Array(i),s=new Blob([r],{type:"image/png"});return new File([s],o,{type:"image/png"})}async simulateFileDrop(e,o){console.log("üìÅ Simulating file drop into DropZone");const t={0:o,length:1,item:a=>a===0?o:null},n=new DragEvent("dragenter",{bubbles:!0,cancelable:!0,dataTransfer:new DataTransfer}),i=new DragEvent("dragover",{bubbles:!0,cancelable:!0,dataTransfer:new DataTransfer}),r=new DragEvent("drop",{bubbles:!0,cancelable:!0,dataTransfer:new DataTransfer});r.dataTransfer?.items.add(o),e.dispatchEvent(n),await this.wait(50),e.dispatchEvent(i),await this.wait(50),e.dispatchEvent(r);const s=e.querySelector('input[type="file"]');s&&(console.log("üìÅ Found file input, setting files directly"),Object.defineProperty(s,"files",{value:t,writable:!1}),s.dispatchEvent(new Event("change",{bubbles:!0}))),console.log("üìÅ File drop simulation completed")}showSuccessMessage(e){const o=document.createElement("div");o.textContent=e,o.style.cssText=`
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-family: system-ui, sans-serif;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 10000;
      animation: slideInRight 0.3s ease-out;
    `,document.body.appendChild(o),setTimeout(()=>{o.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},300)},3e3)}async showScreenshotInstructions(e){console.log("üì∏ Showing screenshot instructions:",e);try{console.log("üì∏ Opening photo upload interface for clipboard workflow..."),await this.openPhotoUploadInterface()}catch(g){console.error("‚ùå Failed to open photo upload interface for clipboard workflow:",g)}const o=document.createElement("div");o.id="screenshot-instructions-modal",o.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 20000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    `;const t=document.createElement("div");t.style.cssText=`
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      font-family: system-ui, sans-serif;
      animation: scaleIn 0.3s ease-out;
    `;const n=document.createElement("h2");n.textContent="üì∏ Take Screenshot",n.style.cssText=`
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      text-align: center;
    `;const i=document.createElement("p");i.textContent=e.tabCaptureError?`No doxy.me tabs found. ${e.tabCaptureError}`:"No doxy.me tabs found. Please take a manual screenshot.",i.style.cssText=`
      margin: 0 0 20px 0;
      font-size: 14px;
      color: #6b7280;
      text-align: center;
      line-height: 1.5;
    `;const r=document.createElement("div");r.style.cssText=`
      background: #f8fafc;
      border-radius: 12px;
      padding: 16px;
      margin: 20px 0;
    `,(e.instructions||["Press cmd+shift+4 to take a screenshot","Select the area you want to capture","The image will automatically be inserted when ready"]).forEach((g,m)=>{const p=document.createElement("div");p.style.cssText=`
        display: flex;
        align-items: flex-start;
        margin: ${m>0?"12px":"0"} 0 0 0;
        font-size: 14px;
        color: #374151;
        line-height: 1.5;
      `;const f=document.createElement("span");f.textContent=`${m+1}.`,f.style.cssText=`
        display: inline-block;
        width: 20px;
        font-weight: 600;
        color: #3b82f6;
        flex-shrink: 0;
      `;const h=document.createElement("span");h.textContent=g,p.appendChild(f),p.appendChild(h),r.appendChild(p)});const a=document.createElement("div");a.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: #fef3c7;
      border-radius: 8px;
      margin: 20px 0;
    `;const c=document.createElement("span");c.textContent="‚è≥ Waiting for screenshot...",c.style.cssText=`
      font-size: 14px;
      font-weight: 500;
      color: #92400e;
    `,a.appendChild(c);const l=document.createElement("button");l.textContent="üìã Manual Paste",l.style.cssText=`
      width: 100%;
      padding: 12px;
      background: #3b82f6;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-bottom: 12px;
    `,l.addEventListener("mouseenter",()=>{l.style.backgroundColor="#2563eb"}),l.addEventListener("mouseleave",()=>{l.style.backgroundColor="#3b82f6"}),l.addEventListener("click",async()=>{try{console.log("üìã Manual paste button clicked, attempting clipboard read...");const g=await navigator.clipboard.read();if(g.length===0){alert("No items found in clipboard. Please copy an image first.");return}let m=!1;for(let p=0;p<g.length;p++){const f=g[p],h=["image/png","image/jpeg","image/jpg","image/gif","image/webp","image/bmp"],b=f.types.find(y=>h.includes(y)||y.startsWith("image/"));if(b){console.log(`üìã Found image in clipboard: ${b}`);const y=await f.getType(b),E=await this.blobToBase64(y);this.closeScreenshotModal(),await this.insertImageIntoDropZone(E,"manual-paste");try{await chrome.runtime.sendMessage({type:"CLIPBOARD_MONITORING_RESULT",data:{success:!0,imageData:E,method:"manual-paste"}})}catch(v){console.error("Failed to notify service worker:",v)}m=!0;break}}m||alert("No image found in clipboard. Please copy an image and try again.")}catch(g){console.error("Manual paste failed:",g),alert("Failed to access clipboard. Please ensure you have copied an image and try again.")}});const d=document.createElement("button");d.textContent="Cancel",d.style.cssText=`
      width: 100%;
      padding: 12px;
      background: #f3f4f6;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      transition: background-color 0.2s;
    `,d.addEventListener("mouseenter",()=>{d.style.backgroundColor="#e5e7eb"}),d.addEventListener("mouseleave",()=>{d.style.backgroundColor="#f3f4f6"}),d.addEventListener("click",()=>{this.closeScreenshotModal()}),t.appendChild(n),t.appendChild(i),t.appendChild(r),t.appendChild(a),t.appendChild(l),t.appendChild(d),o.appendChild(t);const u=document.createElement("style");u.textContent=`
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes scaleIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }
      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }
      @keyframes scaleOut {
        from { transform: scale(1); opacity: 1; }
        to { transform: scale(0.9); opacity: 0; }
      }
    `,document.head.appendChild(u),document.body.appendChild(o),console.log("üì∏ Screenshot instructions modal shown")}closeScreenshotModal(){const e=document.getElementById("screenshot-instructions-modal");if(e){e.style.animation="fadeOut 0.3s ease-out";const o=e.querySelector("div");o&&(o.style.animation="scaleOut 0.3s ease-out"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300),console.log("üì∏ Screenshot instructions modal closed")}}async startClipboardMonitoring(e){console.log(`üì∏ Starting enhanced clipboard monitoring for ${e/1e3} seconds...`);const o=Date.now(),t=500;let n=null,i=0;const r=async()=>{const s=Date.now()-o;if(i++,s>=e){console.log(`‚ùå Clipboard monitoring timeout after ${i} checks over ${s/1e3} seconds`);try{await chrome.runtime.sendMessage({type:"CLIPBOARD_MONITORING_RESULT",data:{success:!1,error:`Timeout waiting for screenshot in clipboard (${i} checks)`}})}catch(a){console.error("‚ùå Failed to notify service worker of timeout:",a)}return}i%10===0&&console.log(`üì∏ Clipboard monitoring: check ${i}, ${Math.round((e-s)/1e3)}s remaining`);try{if(document.hasFocus&&!document.hasFocus()&&(console.log("üì∏ Page not focused, attempting to focus..."),window.focus(),await new Promise(u=>setTimeout(u,100))),(await navigator.permissions.query({name:"clipboard-read"})).state==="denied")throw console.error("‚ùå Clipboard read permission denied"),new Error("Clipboard read permission denied");const c=await navigator.clipboard.read(),l=c.map(u=>u.types.join(",")).join("|"),d=n!==l;d?(console.log(`üì∏ Clipboard content changed! Found ${c.length} items (check ${i})`),n=l):i%20===0&&console.log(`üì∏ No clipboard change detected (check ${i})`);for(let u=0;u<c.length;u++){const g=c[u];d&&console.log(`üì∏ Clipboard item ${u+1} types:`,g.types);const m=["image/png","image/jpeg","image/jpg","image/gif","image/webp","image/bmp","image/svg+xml","image/tiff","image/ico","image/avif"],p=g.types.find(f=>m.includes(f)||f.startsWith("image/"));if(p){console.log(`üì∏ ‚úÖ IMAGE DETECTED in clipboard! Type: ${p}, Size check starting...`);try{const f=await Promise.race([g.getType(p),new Promise((b,y)=>setTimeout(()=>y(new Error("Blob retrieval timeout")),5e3))]);if(console.log(`üì∏ ‚úÖ Successfully retrieved blob: ${f.size} bytes, type: ${f.type}`),f.size===0){console.warn("‚ö†Ô∏è Blob is empty, skipping...");continue}if(f.size>10*1024*1024){console.warn(`‚ö†Ô∏è Blob too large: ${f.size} bytes, skipping...`);continue}console.log(`üì∏ Converting ${f.size} byte blob to base64...`);const h=await this.blobToBase64(f);if(console.log(`üì∏ ‚úÖ Successfully converted to base64: ${h.length} characters`),!h.startsWith("data:image/")){console.warn("‚ö†Ô∏è Invalid base64 image data format, skipping...");continue}console.log("üéâ CLIPBOARD IMAGE PROCESSING SUCCESSFUL! Closing modal and inserting image..."),this.closeScreenshotModal(),await this.insertImageIntoDropZone(h,"clipboard");try{await chrome.runtime.sendMessage({type:"CLIPBOARD_MONITORING_RESULT",data:{success:!0,imageData:h,method:"clipboard",imageType:p,imageSize:f.size,checksCount:i}}),console.log("‚úÖ Successfully notified service worker of clipboard success")}catch(b){console.error("‚ùå Failed to notify service worker of success:",b)}return}catch(f){if(console.error(`‚ùå Failed to process clipboard image blob (${p}):`,f),u<c.length-1){console.log("üîÑ Trying next clipboard item...");continue}}}}setTimeout(r,t)}catch(a){const c=a instanceof Error?a.message:String(a);if(console.error(`‚ùå Clipboard access failed (check ${i}):`,c),c.includes("permission")||c.includes("denied")){console.error("üö´ Clipboard permission issue - stopping monitoring");try{await chrome.runtime.sendMessage({type:"CLIPBOARD_MONITORING_RESULT",data:{success:!1,error:`Clipboard permission denied: ${c}`}})}catch(l){console.error("‚ùå Failed to notify service worker of permission error:",l)}return}console.log("üîÑ Continuing monitoring with longer interval due to error..."),setTimeout(r,t*2)}};try{const s=await navigator.clipboard.read();n=s.map(a=>a.types.join(",")).join("|"),console.log(`üì∏ Initial clipboard state: ${s.length} items`)}catch(s){console.log("üì∏ Could not read initial clipboard state:",s)}console.log("üì∏ üöÄ Starting clipboard monitoring loop..."),r()}async blobToBase64(e){return new Promise((o,t)=>{const n=new FileReader;n.onload=()=>o(n.result),n.onerror=t,n.readAsDataURL(e)})}async extractEMRData(e){console.log("üìã Extracting EMR data for fields:",e),console.log("üìã Current page URL:",window.location.href),console.log("üìã Current page type:",window.location.href.includes("Dashboard")?"DASHBOARD":"PATIENT_PAGE");const o=document.querySelectorAll(".XestroBox");let t=document.querySelector("button.PatientDetailsButton");if(t||(t=await this.findButtonByText("Patient Record")),console.log("üìã Found XestroBox elements:",o.length),console.log("üìã Patient Record button present:",!!t),o.length===0)if(console.warn("‚ö†Ô∏è No XestroBox elements found - patient record may not be opened"),t){console.warn("üí° Patient Record button is available - attempting to open record");try{await this.ensurePatientRecordOpened();const i=document.querySelectorAll(".XestroBox");i.length===0?(console.warn("‚ö†Ô∏è Still no XestroBox elements after clicking Patient Record button"),console.warn("üí° Proceeding with extraction but results may be limited")):console.log(`‚úÖ Found ${i.length} XestroBox elements after opening record`)}catch(i){console.warn("‚ö†Ô∏è Failed to open patient record:",i)}}else console.warn("üí° EMR data extraction requires patient page with clinical fields"),console.warn("üí° Make sure you are on the correct patient page");const n={};for(const i of e)try{let r="";switch(this.normalizeFieldName(i)){case"background":r=await this.extractFieldContent("Background");break;case"investigations":case"investigation-summary":r=await this.extractFieldContent("Investigation Summary");break;case"medications":r=await this.extractFieldContent("Medications (Problem List for Phil)")||await this.extractFieldContent("Medications");break;default:r=await this.extractFieldContent(i)}n[i]=r,console.log(`üìã Extracted ${i}: ${r?r.length+" chars":"empty"}`)}catch(r){console.warn(`‚ö†Ô∏è Failed to extract field "${i}":`,r),n[i]=""}return console.log("üìã EMR data extraction completed:",Object.keys(n)),n}async extractEMRDataForAIReview(e){if(console.log("ü§ñ AI REVIEW EXTRACTION: Starting non-invasive EMR extraction for fields:",e),console.log("ü§ñ AI REVIEW EXTRACTION: Current URL:",window.location.href),console.log("ü§ñ AI REVIEW EXTRACTION: Page title:",document.title),!window.location.href.includes("my.xestro.com"))throw new Error("Not on Xestro EMR page - please navigate to my.xestro.com");const o=document.querySelectorAll(".XestroBox");if(console.log(`ü§ñ AI REVIEW EXTRACTION: Found ${o.length} XestroBox elements on page`),o.length===0)throw new Error("No XestroBox elements found - please navigate to a patient record page");console.log("ü§ñ AI REVIEW EXTRACTION: Available XestroBox titles:"),o.forEach((s,a)=>{const l=s.querySelector(".XestroBoxTitle")?.textContent||"No title";console.log(`  [${a}] "${l}"`)});const t={},n={};for(const s of e){console.log(`
ü§ñ AI REVIEW EXTRACTION: Processing field: "${s}"`);let a="",c=null;const l={fieldName:s,attempts:[]};try{const d=s.toLowerCase();switch(c=this.highlightFieldDuringExtraction(d),await this.wait(300),d){case"background":l.searchTerms=["Background"],a=await this.extractCustomNoteContent("Background"),l.attempts.push({searchTerm:"Background",result:a.length>0?"success":"empty"});break;case"investigations":case"investigation-summary":l.searchTerms=["Investigation Summary"],a=await this.extractCustomNoteContent("Investigation Summary"),l.attempts.push({searchTerm:"Investigation Summary",result:a.length>0?"success":"empty"});break;case"medications-problemlist":l.searchTerms=["Medications (Problem List for Phil)"],a=await this.extractCustomNoteContent("Medications (Problem List for Phil)"),l.attempts.push({searchTerm:"Medications (Problem List for Phil)",result:a.length>0?"success":"empty"});break;case"medications":console.warn('ü§ñ AI REVIEW EXTRACTION: Generic "medications" field requested. Trying specific fields...'),l.searchTerms=["Medications (Problem List for Phil)","Medications"],a=await this.extractCustomNoteContent("Medications (Problem List for Phil)"),l.attempts.push({searchTerm:"Medications (Problem List for Phil)",result:a.length>0?"success":"empty"}),a||(a=await this.extractCustomNoteContent("Medications"),l.attempts.push({searchTerm:"Medications",result:a.length>0?"success":"empty"}));break;default:l.searchTerms=[s],a=await this.extractCustomNoteContent(s),l.attempts.push({searchTerm:s,result:a.length>0?"success":"empty"})}l.finalResult={success:a.length>0,contentLength:a.length,preview:a.length>0?a.substring(0,100)+(a.length>100?"...":""):"No content"},a?(console.log(`‚úÖ AI REVIEW EXTRACTION: Successfully extracted "${s}": ${a.length} chars`),console.log(`   Preview: "${a.substring(0,100)}${a.length>100?"...":""}"`)):console.log(`‚ö†Ô∏è AI REVIEW EXTRACTION: No content found for "${s}"`),t[s]=a,n[s]=l}catch(d){console.error(`‚ùå AI REVIEW EXTRACTION: Failed to extract "${s}":`,d),l.error=d instanceof Error?d.message:String(d),t[s]="",n[s]=l}finally{c&&this.removeFieldHighlight(c)}}const i=Object.entries(t).filter(([,s])=>s.length>0),r=Object.keys(t).length;if(console.log(`
ü§ñ AI REVIEW EXTRACTION: SUMMARY`),console.log(`   Successful extractions: ${i.length}/${r}`),console.log("   Extraction details:",n),console.log("   Final extracted data keys:",Object.keys(t)),i.length===0)throw console.error("ü§ñ AI REVIEW EXTRACTION: No data extracted from any field"),console.log("ü§ñ AI REVIEW EXTRACTION: Diagnostic info:"),console.log("   - Available XestroBox titles:",Array.from(o).map(s=>s.querySelector(".XestroBoxTitle")?.textContent||"No title")),new Error(`No EMR data could be extracted. Available fields: ${Array.from(o).map(s=>s.querySelector(".XestroBoxTitle")?.textContent||"No title").join(", ")}`);return console.log("‚úÖ AI REVIEW EXTRACTION: Non-invasive extraction completed successfully"),t}highlightFieldDuringExtraction(e){try{let o=null;switch(e){case"background":o=this.findFieldContainer("Background");break;case"investigations":o=this.findFieldContainer("Investigation Summary")||this.findFieldContainer("Investigations");break;case"medications-problemlist":o=this.findFieldContainer("Medications")||this.findFieldContainer("Problem List");break;default:o=this.findFieldContainer(e)}return o?(o.style.transition="all 0.3s ease",o.style.boxShadow="0 0 0 3px rgba(59, 130, 246, 0.3)",o.style.backgroundColor="rgba(59, 130, 246, 0.05)",o.style.borderRadius="8px",console.log(`‚ú® Highlighted field: ${e}`),o):null}catch(o){return console.warn(`‚ö†Ô∏è Failed to highlight field ${e}:`,o),null}}removeFieldHighlight(e){try{e.style.boxShadow="",e.style.backgroundColor="",e.style.borderRadius="",setTimeout(()=>{e.style.transition=""},300),console.log("üîÑ Removed field highlighting")}catch(o){console.warn("‚ö†Ô∏è Failed to remove field highlighting:",o)}}findFieldContainer(e){try{const o=document.querySelectorAll(".XestroBoxTitle");for(const i of o)if(i.textContent?.includes(e))return i.closest(".XestroBox")||i.parentElement;const t=[`[data-field="${e.toLowerCase()}"]`,`[data-field-name="${e.toLowerCase()}"]`,`.${e.toLowerCase().replace(/\s+/g,"-")}-field`,`.field-${e.toLowerCase().replace(/\s+/g,"-")}`];for(const i of t){const r=document.querySelector(i);if(r)return r}const n=document.querySelectorAll(".XestroBox, .field, .section, .form-group");for(const i of n)if(i.textContent?.includes(e))return i;return console.log(`‚ö†Ô∏è Could not find container for field: ${e}`),null}catch(o){return console.warn(`‚ö†Ô∏è Error finding field container for ${e}:`,o),null}}normalizeFieldName(e){return e.toLowerCase().replace(/[_\s-]+/g,"-")}async extractCustomNoteContent(e){console.log(`üìã Looking for customNote content in field: "${e}"`);try{const o=await this.findXestroBoxByTitle(e);if(!o)return console.log(`‚ö†Ô∏è No XestroBox found for "${e}"`),"";const t=o.querySelectorAll(".customNote");if(console.log(`üìã Found ${t.length} customNote elements in "${e}" XestroBox`),t.length===0)return console.log(`‚ö†Ô∏è No .customNote elements found in "${e}" XestroBox`),"";let n="";for(let i=0;i<t.length;i++){const r=t[i];if(r.offsetParent!==null){const s=(r.textContent||r.innerText||"").trim();s&&(n?n+=`

`+s:n=s,console.log(`üìã Extracted customNote ${i+1} content: ${s.length} chars`))}}return n?(console.log(`‚úÖ Total customNote content for "${e}": ${n.length} chars`),n):(console.log(`‚ö†Ô∏è No visible content found in customNote elements for "${e}"`),"")}catch(o){return console.error(`‚ùå Error extracting customNote content for "${e}":`,o),""}}async extractFieldContent(e){console.log(`üìã Extracting content for field: "${e}"`);try{const o=await this.extractCustomNoteContent(e);if(o)return console.log(`üìã Found customNote content for "${e}": ${o.length} chars`),o;const t=await this.findXestroBoxByTitle(e);if(t){console.log(`‚úÖ Found XestroBox for "${e}"`);const i=t.querySelector(".XestroBoxTitle");i&&(i.click(),await this.wait(300));const r=t.querySelector("textarea");if(r&&r.offsetParent!==null){const a=r.value.trim();return console.log(`üìã Found textarea content for "${e}": ${a.length} chars`),a}const s=t.querySelectorAll('[contenteditable="true"]');for(const a of s){const c=a;if(c.offsetParent!==null){const l=(c.textContent||c.innerText||"").trim();if(l)return console.log(`üìã Found contenteditable content for "${e}": ${l.length} chars`),l}}}const n=[`textarea[data-field="${e.toLowerCase()}"]`,`textarea[placeholder*="${e}"]`,`textarea[aria-label*="${e}"]`,`#${e.replace(/\s+/g,"").toLowerCase()}`,`.${e.replace(/\s+/g,"-").toLowerCase()}`];for(const i of n){const r=document.querySelector(i);if(r&&r.offsetParent!==null){const s=r.value.trim();return console.log(`üìã Found fallback content for "${e}" via ${i}: ${s.length} chars`),s}}return console.log(`‚ö†Ô∏è No content found for field "${e}"`),""}catch(o){return console.error(`‚ùå Error extracting field "${e}":`,o),""}}async findXestroBoxByTitle(e){console.log(`üîç Looking for XestroBox with title: "${e}"`);const o=document.querySelectorAll(".XestroBox");console.log(`üîç Found ${o.length} XestroBox elements`),o.forEach((n,i)=>{const s=n.querySelector(".XestroBoxTitle")?.textContent||"No title";console.log(`üîç XestroBox ${i}: "${s}"`)});for(const n of o){const i=n.querySelector(".XestroBoxTitle");if(i&&i.textContent?.includes(e))return console.log(`‚úÖ Found XestroBox with matching title: "${i.textContent}"`),n}const t=[e.split(" ")[0],e.replace(/\s+/g,""),e.toLowerCase()];for(const n of t)for(const i of o){const r=i.querySelector(".XestroBoxTitle");if((r?.textContent?.toLowerCase()||"").includes(n.toLowerCase()))return console.log(`‚úÖ Found XestroBox with partial match: "${r?.textContent}" for "${e}"`),i}return console.log(`‚ùå No XestroBox found for title: "${e}"`),null}async saveNote(){console.log("üíæ Attempting to save note...");const e=document.getElementById("patientNotesSave")||document.querySelector('button[title*="Save"]')||document.querySelector('button:contains("Save")');if(e){e.click(),console.log("üíæ Note saved via button");return}const o=document.getElementById("AddNoteArea");if(o){const t=new KeyboardEvent("keydown",{key:"Enter",shiftKey:!0,bubbles:!0});o.dispatchEvent(t),console.log("üíæ Note saved via Shift+Enter");return}console.log("‚ùå No save method available")}async extractCalendarPatients(){if(console.log("üìÖ Starting calendar patient extraction..."),console.log("üìÖ Current page URL:",window.location.href),!this.isCalendarPage())throw new Error("Not on a calendar/appointment book page");const e=this.extractAppointmentDate();console.log("üìÖ Appointment date:",e);const o=document.querySelector("table.appointmentBook");if(!o)throw new Error("Appointment book table not found");const t=this.extractPatientsFromTable(o);return console.log("üìÖ Extracted patients:",t),{appointmentDate:e,calendarUrl:window.location.href,patients:t,totalCount:t.length}}isCalendarPage(){const e=document.querySelector(".one-appt-book, table.appointmentBook"),o=document.querySelector("input.date.form-control");return!!(e&&o)}extractAppointmentDate(){const e=document.querySelector("input.date.form-control");if(e)return e.value||e.getAttribute("data-value")||"";const o=document.querySelectorAll("[data-date]");for(const t of o){const n=t.getAttribute("data-date");if(n)return n}return new Date().toDateString()}extractPatientsFromTable(e){console.log("üìÖ Extracting patients from appointment table...");const o=[],t=e.querySelectorAll("tr.appt");return console.log(`üìÖ Found ${t.length} appointment rows`),t.forEach((n,i)=>{try{const r=n.querySelector("td.Name");if(!r||!r.textContent?.trim())return;const s=this.extractPatientFromRow(n);if(s){const a=this.validatePatientPattern(s);a.isValid?(o.push(s),console.log(`üìÖ ‚úÖ Extracted patient ${i+1} (${a.patternType}):`,s)):(console.warn(`üìÖ ‚ö†Ô∏è Patient ${i+1} has invalid pattern:`,{patient:s,reason:a.reason}),o.push({...s,_patternType:"legacy"}))}}catch(r){console.warn(`üìÖ Failed to extract patient from row ${i}:`,r)}}),console.log(`üìÖ Successfully extracted ${o.length} patients from appointment table`),o}extractPatientFromRow(e){const t=e.querySelector("td.Time")?.textContent?.trim()||"",i=e.querySelector("td.Type")?.textContent?.trim()||"",r=e.querySelector("td.Name");if(!r)return null;const s=this.parsePatientNameCell(r);if(!s)return null;const a=e.querySelector("td.Confirm"),c=this.isAppointmentConfirmed(a),l=r.querySelector(".fa-star")!==null,u=e.querySelector("td.Notes")?.textContent?.trim()||"";return{name:s.name,dob:s.dob,fileNumber:s.fileNumber,appointmentTime:t,appointmentType:i,confirmed:c,isFirstAppointment:l,notes:u||void 0}}parsePatientNameCell(e){const o=e.querySelector("span[aria-label]");if(!o)return null;const t=o.getAttribute("aria-label")||"",n=o.textContent?.trim()||"";console.log("üìÖ Parsing patient name cell:",{ariaLabel:t,displayName:n});const i=n.match(/^(.+?)\s*\((\d+)\)$/);if(i){const s=i[1].trim(),a=i[2];console.log("üìÖ Found Name (ID) pattern:",{fullName:s,patientId:a});const c=t.match(/\((\d{2}\/\d{2}\/\d{4})\)/),l=c?c[1]:"";return{name:s,dob:l,fileNumber:a}}const r=t.match(/^(.+?)\s*\((\d{2}\/\d{2}\/\d{4})\)$/);if(r){console.log("üìÖ Using legacy DOB pattern as fallback");const s=r[1].trim(),a=r[2],d=(e.querySelector("small")?.textContent?.trim()||"").replace(/[^\d]/g,"");return{name:s,dob:a,fileNumber:d}}return console.warn("üìÖ Could not parse patient name from either pattern:",{ariaLabel:t,displayName:n}),null}validatePatientPattern(e){return!e||!e.name||!e.fileNumber?{isValid:!1,patternType:"invalid",reason:"Missing name or fileNumber"}:/^\d+$/.test(e.fileNumber)&&!/\d{2}\/\d{2}\/\d{4}/.test(e.name)?{isValid:!0,patternType:"name-id"}:e.dob&&/\d{2}\/\d{2}\/\d{4}/.test(e.dob)?{isValid:!0,patternType:"legacy-dob"}:{isValid:!1,patternType:"unknown",reason:`Unrecognized pattern: name="${e.name}", fileNumber="${e.fileNumber}", dob="${e.dob}"`}}isAppointmentConfirmed(e){return e?!!e.querySelector(".fa-calendar-check.text-success"):!1}async navigateToPatient(e,o){console.log(`üß≠ Navigating to patient: ${o} (${e})`);const t=document.querySelector('input[placeholder*="search"], input[placeholder*="patient"]');if(t){t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),await this.wait(1e3);const s=document.querySelectorAll("[data-patient-id], .patient-result");for(const a of s)if(a.textContent?.includes(e)||a.textContent?.includes(o)){a.click(),console.log("üß≠ Clicked patient in search results"),await this.wait(2e3),await this.ensurePatientRecordOpened();return}}const i=window.location.href.split("?")[0].split("#")[0],r=[`${i}?patient=${e}`,`${i}#patient/${e}`,`${i}/patient/${e}`];for(const s of r)try{if(console.log(`üß≠ Trying navigation to: ${s}`),window.location.href=s,await this.wait(2e3),document.querySelector(".patient-record, #patient-view, .XestroBox")){console.log("‚úÖ Successfully navigated to patient page"),await this.ensurePatientRecordOpened();return}}catch(a){console.warn(`üß≠ Navigation attempt failed for ${s}:`,a)}throw new Error(`Unable to navigate to patient ${o} (${e})`)}async activatePatientByElement(e){console.log(`üñ±Ô∏è Activating patient by element: ${e}`),console.log(`üñ±Ô∏è Current page URL: ${window.location.href}`),console.log(`üñ±Ô∏è Page title: ${document.title}`);let o=null;if(typeof e=="number"){const i=document.querySelector("table.appointmentBook");if(!i){const a=document.querySelectorAll("table"),c=Array.from(a).map(l=>l.className||"no-class");throw console.error("üñ±Ô∏è table.appointmentBook not found. Available tables:",c),new Error(`Appointment table not found. Expected table.appointmentBook. Found ${a.length} tables: ${c.join(", ")}`)}const r=i.querySelectorAll("tr.appt");console.log(`üñ±Ô∏è Found ${r.length} appointment rows`);const s=Array.from(r).map(a=>a.querySelector("td.Name")).filter(a=>a&&a.textContent?.trim());if(console.log(`üñ±Ô∏è Found ${s.length} valid patient elements`),e>=s.length)throw new Error(`Patient index ${e} out of range. Found ${s.length} patients from ${r.length} rows.`);o=s[e],console.log(`üñ±Ô∏è Found patient element by index ${e}`)}else{if(o=document.querySelector(e),!o)throw new Error(`Patient element not found using selector: ${e}`);console.log(`üñ±Ô∏è Found patient element by selector: ${e}`)}const t=this.extractPatientInfoFromElement(o);console.log(`üñ±Ô∏è Activating patient: ${t.name} (${t.fileNumber})`),o.click(),console.log("üñ±Ô∏è Patient name clicked"),await this.wait(1e3),this.checkPatientActivation(o)?console.log("‚úÖ Patient activation confirmed visually"):console.warn("‚ö†Ô∏è Patient activation not visually confirmed, proceeding anyway"),await this.ensurePatientRecordOpened(),console.log(`‚úÖ Successfully activated patient: ${t.name}`)}extractPatientInfoFromElement(e){const o=e.querySelector("span[aria-label]"),t=e.querySelector("small");if(!o)return{name:"Unknown",dob:"",fileNumber:""};const i=(o.getAttribute("aria-label")||"").match(/^(.+?)\s*\((.+?)\)$/),r=i?i[1].trim():o.textContent?.trim()||"Unknown",s=i?i[2]:"",a=t?.textContent?.replace(/[^\d]/g,"")||"";return{name:r,dob:s,fileNumber:a}}checkPatientActivation(e){const o=e.closest("tr");return o?o.classList.contains("selected")||o.classList.contains("active")||o.style.backgroundColor!==""||o.querySelector(".fa-check")!==null||window.getComputedStyle(o).backgroundColor!=="rgba(0, 0, 0, 0)":!1}async doubleClickPatient(e,o){console.log(`üëÜ Double-clicking patient: ${e} (ID: ${o})`),console.log(`üëÜ Current URL: ${window.location.href}`),console.log(`üëÜ Page title: ${document.title}`);const t=document.querySelectorAll("span[aria-label]");console.log(`üëÜ All patient elements found (${t.length}):`,Array.from(t).map((a,c)=>({index:c,ariaLabel:a.getAttribute("aria-label"),textContent:a.textContent?.trim(),className:a.className,id:a.id,visible:a.offsetParent!==null})));const n=`${e} (${o})`;console.log(`üëÜ Searching for patient with pattern: "${n}"`);const i=Array.from(document.querySelectorAll("span[aria-label]")).filter(a=>{const c=a.textContent?.trim()||"",l=a.getAttribute("aria-label")||"",d=c===n,u=c.includes(e)||l.includes(e),g=c.includes(`(${o})`);return d||u&&g});if(console.log(`üëÜ Filtered patient elements (${i.length}):`,i.map((a,c)=>{const l=a.textContent?.trim()||"",d=a.getAttribute("aria-label")||"";return{index:c,ariaLabel:d,textContent:l,matches:{exactPattern:l===n,nameMatch:l.includes(e)||d.includes(e),idMatch:l.includes(`(${o})`),searchPattern:n}}})),i.length===0)throw console.error(`üëÜ ERROR: No patient elements found matching pattern "${n}"`),console.error(`üëÜ Search criteria: Name="${e}", ID="${o}"`),console.error("üëÜ Available patients:",Array.from(t).map(a=>({textContent:a.textContent?.trim(),ariaLabel:a.getAttribute("aria-label")}))),new Error(`Patient not found in appointment book: ${n}. Expected format: "Name (ID)"`);i.length>1&&console.warn(`üëÜ WARNING: Multiple patient elements found (${i.length}), using the first one`);const r=i[0];console.log("üëÜ Selected patient element:",{ariaLabel:r.getAttribute("aria-label"),textContent:r.textContent?.trim(),className:r.className,id:r.id,tagName:r.tagName,parentElement:r.parentElement?.tagName,boundingRect:r.getBoundingClientRect()}),console.log("üëÜ Performing double-click on patient element...");const s=new MouseEvent("dblclick",{bubbles:!0,cancelable:!0,view:window});r.dispatchEvent(s),console.log("üëÜ Double-click event dispatched"),console.log("üëÜ Waiting 1 second for navigation..."),await this.wait(1e3),console.log(`üëÜ Double-click completed for patient: ${e}`),console.log(`üëÜ Post-click URL: ${window.location.href}`),console.log(`üëÜ Post-click title: ${document.title}`)}async navigateToPatientRecord(){console.log("üè• Navigating to Patient Record view");const e=this.findButtonByText("Patient Record")||this.findButtonByText("Patient")||document.querySelector('button[title*="Patient Record"]')||document.querySelector('a[href*="patient"]');if(!e)throw new Error("Patient Record button not found in navigation");if(console.log("üè• Found Patient Record button, clicking..."),e instanceof HTMLElement)e.click();else throw new Error("Patient Record button is not a clickable element");await this.wait(2e3);const o=document.querySelectorAll(".XestroBox").length;o===0&&console.warn("üè• Patient Record view may not have loaded (no XestroBoxes found)"),console.log(`üè• Navigation to Patient Record completed (${o} XestroBoxes found)`)}async navigateToAppointmentBook(){console.log("üìÖ Navigating back to Appointment Book view"),console.log(`üìÖ Current URL: ${window.location.href}`),console.log(`üìÖ Page title: ${document.title}`),console.log("üìÖ Inspecting available navigation elements...");const e=document.querySelectorAll("button");console.log(`üìÖ All buttons found (${e.length}):`,Array.from(e).map((s,a)=>({index:a,textContent:s.textContent?.trim(),className:s.className,id:s.id,title:s.title,onclick:s.onclick?"has onclick":"no onclick",visible:s.offsetParent!==null})));const o=document.querySelectorAll("a");console.log(`üìÖ All links found (${o.length}):`,Array.from(o).map((s,a)=>({index:a,textContent:s.textContent?.trim(),href:s.href,className:s.className,id:s.id,title:s.title,visible:s.offsetParent!==null}))),console.log("üìÖ Searching for navigation buttons...");const t=["Appointment Book","Appointments","Calendar","Dashboard","Home","Back","Close","Return"];let n=null,i="";for(const s of t){console.log(`üìÖ Searching for pattern: "${s}"`);const a=this.findButtonByText(s);if(a){n=a,i=s,console.log(`üìÖ Found button with pattern "${s}":`,{textContent:a.textContent?.trim(),className:a.className,id:a.id,tagName:a.tagName});break}}if(!n){console.log("üìÖ Trying specific selectors...");const s=['button[title*="Appointment"]','a[href*="appointment"]','button[title*="Dashboard"]','a[href*="Dashboard"]','button.btn-default:contains("Back")','button.btn-default:contains("Close")',".navbar-nav a",".nav-tabs a",".breadcrumb a"];for(const a of s)try{const c=document.querySelector(a);c&&(console.log(`üìÖ Found element with selector "${a}":`,{textContent:c.textContent?.trim(),className:c.className,id:c.id,tagName:c.tagName,href:c.href}),n||(n=c,i=`selector: ${a}`))}catch{}}if(!n)throw console.error("üìÖ ERROR: No navigation button found"),console.error("üìÖ DOM inspection complete - no suitable navigation element located"),new Error("Appointment Book button not found in navigation");if(console.log(`üìÖ Found navigation button with pattern "${i}", clicking...`),n instanceof HTMLElement)n.click(),console.log("üìÖ Clicked navigation button successfully");else throw console.error("üìÖ ERROR: Found element is not clickable HTMLElement"),new Error("Appointment Book button is not a clickable element");console.log("üìÖ Waiting 2 seconds for page transition..."),await this.wait(2e3),console.log("üìÖ Verifying navigation result..."),console.log(`üìÖ New URL: ${window.location.href}`),console.log(`üìÖ New title: ${document.title}`);const r=document.querySelectorAll(".appointmentBook, .one-appt-book, input.date.form-control");console.log(`üìÖ Calendar elements found: ${r.length}`),r.length===0&&(console.warn("üìÖ WARNING: Appointment Book view may not have loaded (no calendar elements found)"),console.warn("üìÖ Current page elements:",{xestroBoxes:document.querySelectorAll(".XestroBox").length,buttons:document.querySelectorAll("button").length,links:document.querySelectorAll("a").length,forms:document.querySelectorAll("form").length})),console.log(`üìÖ Navigation to Appointment Book completed (${r.length} calendar elements found)`)}async extractPatientFields(){console.log("üìã Extracting patient fields from Patient Record view"),console.log(`üìã Current URL: ${window.location.href}`),console.log(`üìã Page title: ${document.title}`);const e=document.querySelectorAll(".XestroBox").length;if(console.log(`üìã XestroBox count: ${e}`),e===0)throw console.error("üìã ERROR: No XestroBoxes found - not in Patient Record view"),new Error("Not in Patient Record view - no XestroBoxes found");const o=document.querySelectorAll(".XestroBox");console.log("üìã XestroBox details:",Array.from(o).map((s,a)=>({index:a,id:s.id,className:s.className,textContent:s.textContent?.substring(0,100)+"..."}))),console.log("üìã Performing smart empty field detection...");const t=this.detectEmptyFieldsVisually();console.log("üìã Visual field detection results:",t),console.log("üìã Starting optimized field extraction...");const n=await this.extractEMRDataOptimized(["background","investigations","medications","problemList"],t);console.log("üìã Raw extracted data:",{background:{length:n.background?.length||0,preview:n.background?.substring(0,100)||"EMPTY",hasContent:!!n.background?.trim()},investigations:{length:n.investigations?.length||0,preview:n.investigations?.substring(0,100)||"EMPTY",hasContent:!!n.investigations?.trim()},medications:{length:n.medications?.length||0,preview:n.medications?.substring(0,100)||"EMPTY",hasContent:!!n.medications?.trim()},problemList:{length:n.problemList?.length||0,preview:n.problemList?.substring(0,100)||"EMPTY",hasContent:!!n.problemList?.trim()}});const i=[n.background,n.investigations,n.medications,n.problemList].some(s=>s&&s.trim().length>0);console.log(`üìã Data validation: hasAnyData = ${i}`),i||console.warn("üìã WARNING: No meaningful data extracted from any field");const r={background:n.background||"",investigations:n.investigations||"",medications:n.medications||"",problemList:n.problemList||"",extractionTimestamp:Date.now(),xestroBoxCount:e,hasAnyData:i};return console.log("üìã Final extraction result:",r),r}detectEmptyFieldsVisually(){console.log("üîç Scanning page for empty field visual indicators...");const e={background:!1,investigations:!1,medications:!1,problemList:!1},o=document.querySelectorAll('div[style*="color:#ccc"], div[style*="color: #ccc"], .empty-field, .no-content');return console.log(`üîç Found ${o.length} potential empty field indicators`),o.forEach((t,n)=>{const i=t.textContent?.toLowerCase()||"";console.log(`üîç Indicator ${n}: "${i.substring(0,50)}..."`),(i.includes("no background")||i.includes("no history")||i.includes("background summary"))&&(e.background=!0,console.log("üîç ‚úÖ Background field detected as empty")),(i.includes("no investigation")||i.includes("no results")||i.includes("investigation summary"))&&(e.investigations=!0,console.log("üîç ‚úÖ Investigations field detected as empty")),(i.includes("no medication")||i.includes("no drugs")||i.includes("medications"))&&(e.medications=!0,console.log("üîç ‚úÖ Medications field detected as empty")),(i.includes("no problems")||i.includes("no conditions")||i.includes("problem list"))&&(e.problemList=!0,console.log("üîç ‚úÖ Problem list field detected as empty"))}),e}async extractEMRDataOptimized(e,o){console.log("üìã Starting optimized extraction for fields:",e),console.log("üìã Empty field status:",o);const t={};for(const n of e){const i=n.toLowerCase();if(o[i]){console.log(`‚ö° OPTIMIZATION: Skipping empty field "${n}" - detected visually as empty`),t[n]="";continue}console.log(`üìã Extracting content for field: "${n}" (not empty)`);let r="";try{switch(i){case"background":r=await this.extractFieldContent("Background");break;case"investigations":case"investigation-summary":r=await this.extractFieldContent("Investigation Summary");break;case"medications":r=await this.extractFieldContent("Medications (Problem List for Phil)")||await this.extractFieldContent("Medications");break;case"problemlist":r=await this.extractFieldContent("Problem List");break;default:r=await this.extractFieldContent(n)}t[n]=r,console.log(`‚úÖ Extracted ${r.length} characters from ${n}`)}catch(s){console.warn(`‚ö†Ô∏è Failed to extract ${n}:`,s),t[n]=""}}return t}findButtonByText(e){const t=Array.from(document.querySelectorAll("button, a")).find(n=>n.textContent?.trim().toLowerCase().includes(e.toLowerCase())||n.title?.toLowerCase().includes(e.toLowerCase()));return t instanceof HTMLElement?t:null}async findElementWithRetry(e,o=5e3,t=3){for(let n=0;n<t;n++){console.log(`üîÑ Attempt ${n+1}/${t} to find element...`);for(const i of e){console.log(`üîç Trying selector: ${i}`);const r=await this.findElement(i,o/t);if(r)return console.log(`‚úÖ Found element with selector: ${i}`),r}n<t-1&&(console.log(`‚è≥ Retry ${n+1} failed, waiting before next attempt...`),await this.wait(1e3))}return console.log(`‚ùå All attempts failed to find element with selectors: ${e.join(", ")}`),null}async findProfilePictureTab(){console.log("üîç Searching for Profile Picture tab with multiple strategies...");const e=Array.from(document.querySelectorAll('.description, .tab, .tab-item, [role="tab"], .nav-item'));for(const n of e)if(n.textContent?.includes("Profile Picture"))return console.log("‚úÖ Found Profile Picture tab via exact text match"),n;const o=["profile","picture","photo","image","avatar"];for(const n of e){const i=n.textContent?.toLowerCase()||"";if(o.some(r=>i.includes(r)))return console.log(`‚úÖ Found potential Profile Picture tab via text variation: ${n.textContent?.trim()}`),n}const t=document.querySelectorAll('.modal .description, .patient-edit .description, [class*="patient"] .tab');for(const n of t)if(n.textContent?.toLowerCase().includes("profile")||n.textContent?.toLowerCase().includes("picture"))return console.log(`‚úÖ Found Profile Picture tab in modal/patient section: ${n.textContent?.trim()}`),n;return console.log("‚ùå Could not find Profile Picture tab with any strategy"),null}showErrorMessage(e){const o=document.createElement("div");o.textContent=`‚ö†Ô∏è ${e}`,o.style.cssText=`
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ef4444;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-family: system-ui, sans-serif;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 10000;
      max-width: 400px;
      animation: slideInRight 0.3s ease-out;
    `,document.body.appendChild(o),setTimeout(()=>{o.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},300)},5e3)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{new x}):new x}
