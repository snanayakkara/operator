import{W as A}from"./chunks/services.BZymtB7H.js";import{i as M,m as C}from"./chunks/clinicalStorage.Cnou96FG.js";import"./chunks/agents.D6Qu3kid.js";import"./chunks/vendor-3d.C_BwnfSu.js";import"./chunks/vendor.ChGo-vQ_.js";import"./chunks/vendor-ui.BBm4hhLH.js";class D{isInitialized=!1;activeTabs=new Set;whisperServerService;clipboardResultPromise=null;fileTabSuppression=!1;constructor(){this.whisperServerService=A.getInstance(),this.initialize()}async initialize(){if(this.isInitialized){console.log("âš ï¸ Background service already initialized");return}console.log("ðŸš€ Initializing background service..."),M(),await C(),this.setupEventListeners(),console.log("âœ… Event listeners set up"),await this.setupSidePanel(),console.log("âœ… Side panel initialized"),await this.initializeWhisperServer(),console.log("âœ… Transcription server initialized"),this.isInitialized=!0,console.log("ðŸŽ‰ Background service fully initialized")}setupEventListeners(){chrome.runtime.onInstalled.addListener(async e=>{e.reason==="install"&&await this.handleInstallation()}),chrome.runtime.onMessage.addListener((e,t,o)=>(this.handleMessage(e,t,o),!0)),chrome.tabs.onUpdated.addListener(async(e,t,o)=>{console.log(`ðŸ“‹ Tab ${e} updated:`,{status:t.status,url:o.url,title:o.title?.substring(0,50)});try{const r=t.url||o.url||t.pendingUrl;if(this.fileTabSuppression&&typeof r=="string"&&r.startsWith("file:")&&o.id){console.log("ðŸ›‘ Closing file:// tab due to active drop guard:",{id:o.id,url:r}),await chrome.tabs.remove(o.id);return}}catch(r){console.warn("âš ï¸ File tab suppression (onUpdated) failed:",r)}if(t.status==="complete"){const r=this.isEMRTab(o.url);if(console.log(`ðŸŽ¯ Tab ${e} processing: EMR=${r}`),r){this.activeTabs.add(e),console.log(`âœ… Adding tab ${e} to active EMR tabs`);try{await chrome.sidePanel.setOptions({tabId:e,path:"src/sidepanel/index.html",enabled:!0}),console.log(`âœ… Side panel ENABLED for tab ${e}`)}catch(a){console.error("âŒ Could not enable side panel for tab:",a)}}else{this.activeTabs.delete(e),console.log(`ðŸ—‘ï¸ Removing tab ${e} from active EMR tabs`);try{await chrome.sidePanel.setOptions({tabId:e,enabled:!1}),console.log(`ðŸš« Side panel DISABLED for tab ${e}`)}catch(a){console.error("âŒ Could not disable side panel for tab:",a)}}}}),chrome.tabs.onCreated.addListener(async e=>{try{const t=e.pendingUrl,o=e.url||t;this.fileTabSuppression&&o&&o.startsWith("file:")&&e.id&&(console.log("ðŸ›‘ Closing newly created file:// tab due to active drop guard:",{id:e.id,url:o}),await chrome.tabs.remove(e.id))}catch(t){console.warn("âš ï¸ File tab suppression (onCreated) failed:",t)}}),chrome.tabs.onRemoved.addListener(e=>{console.log(`ðŸ—‘ï¸ Tab ${e} removed`),this.activeTabs.delete(e)}),chrome.tabs.onActivated.addListener(async e=>{console.log(`ðŸŽ¯ Tab ${e.tabId} activated`);try{const t=await chrome.tabs.get(e.tabId);console.log("ðŸŽ¯ Active tab info:",{id:t.id,url:t.url,title:t.title?.substring(0,50)}),this.isEMRTab(t.url)&&(await chrome.sidePanel.setOptions({tabId:e.tabId,path:"src/sidepanel/index.html",enabled:!0}),console.log(`âœ… Side panel ENABLED for activated tab ${e.tabId}`))}catch(t){console.error("âŒ Error handling tab activation:",t)}}),chrome.commands.onCommand.addListener(async e=>{await this.handleCommand(e)}),this.checkExistingTabs(),chrome.action.onClicked.addListener(e=>{if(console.log("ðŸŽ¯ Extension icon clicked for tab:",e.id,e.url),!e.id){console.error("âŒ Cannot open side panel - no tab ID");return}if(!this.isEMRTab(e.url)){console.log("â„¹ï¸ Cannot open side panel - not on EMR domain");return}chrome.sidePanel.open({tabId:e.id}).then(()=>{console.log("âœ… Side panel opened successfully")}).catch(o=>{console.error("âŒ Failed to open side panel:",o),console.error("Error details:",{name:o.name,message:o.message,stack:o.stack}),o.message.includes("user gesture")?console.error("ðŸ’¡ User gesture timing issue - Chrome requires immediate synchronous call"):o.message.includes("No active side panel")&&console.error("ðŸ’¡ Side panel not properly registered - check tab management logic")})}),"onPanelOpened"in chrome.sidePanel&&chrome.sidePanel.onPanelOpened?.addListener(()=>{console.log("âœ… Side panel opened successfully")})}async setupSidePanel(){try{console.log("ðŸ”§ Setting up side panel..."),await chrome.sidePanel.setOptions({path:"src/sidepanel/index.html",enabled:!1}),console.log("âœ… Side panel path set to src/sidepanel/index.html");try{const t=await fetch(chrome.runtime.getURL("src/sidepanel/index.html"));t.ok?console.log("âœ… Side panel HTML is accessible"):console.error("âŒ Side panel HTML not accessible:",t.status,t.statusText)}catch(t){console.error("âŒ Failed to test side panel HTML accessibility:",t)}await chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}),console.log("âœ… Side panel behavior set to open on action click");const e=await chrome.tabs.query({active:!0,currentWindow:!0});console.log(`ðŸ” Found ${e.length} active tabs during setup`),e[0]?(console.log("ðŸ” Current active tab:",{id:e[0].id,url:e[0].url,status:e[0].status,title:e[0].title?.substring(0,50)}),this.isEMRTab(e[0].url)?(await chrome.sidePanel.setOptions({tabId:e[0].id,path:"src/sidepanel/index.html",enabled:!0}),console.log("âœ… Side panel enabled for current tab:",e[0].url)):console.log("â„¹ï¸ Current tab is not EMR, side panel remains disabled")):console.log("âš ï¸ No active tab found during setup"),console.log("âœ… Side panel setup complete")}catch(e){console.error("âŒ Failed to setup side panel:",e)}}async handleInstallation(){try{await chrome.storage.local.set({settings:{lmStudioUrl:"http://localhost:1234",classifierModel:"medgemma-4b-it",processorModel:"medgemma-27b-it",autoDetectAgent:!0,voiceActivation:!0},agentMemory:{},sessionHistory:[]});try{await chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("assets/icons/icon-48.png"),title:"Operator Chrome Extension",message:"Extension installed successfully! Open the side panel to get started."})}catch(e){console.log("Welcome notification skipped:",e)}}catch(e){console.error("Installation setup failed:",e)}}async handleMessage(e,t,o){try{const{type:r,action:a,data:i,tabId:p}=e;switch(r){case"EXECUTE_ACTION":await this.executeAction(a,i,p||t.tab?.id,o);break;case"EXECUTE_ACTION_ACTIVE_EMR":{const c=p||this.getActiveEmrTabIdFromSet();if(!c){o({success:!1,error:"No active EMR tab available"});break}await this.executeAction(a,i,c,o);break}case"PAGE_DROP_GUARD_INSTALLED":console.log("âœ… Page drop guard installed for tab",t.tab?.id),o({success:!0});break;case"SET_DROP_HINT":{const c=e.data?.slot??1;try{for(const d of this.activeTabs)try{await chrome.scripting.executeScript({target:{tabId:d},func:u=>{try{const s=document.getElementById("__operator_page_drop_overlay__");if(!s)return;const f=s.firstElementChild;f&&(f.textContent=`Drop image for Slot ${u} to import into Annotate & Combine`)}catch(s){console.debug("Drop overlay hint update failed:",s instanceof Error?s.message:s)}},args:[c]})}catch(u){console.warn("SET_DROP_HINT failed for tab",d,u)}}catch(d){console.warn("SET_DROP_HINT broadcast failed:",d)}o({success:!0});break}case"SIDE_PANEL_ACTION":await this.handleSidePanelAction(a,i,o);break;case"GET_TAB_INFO":o(await this.getTabInfo(t.tab?.id));break;case"UPDATE_AGENT_MEMORY":await this.updateAgentMemory(i.agentType,i.memory),o({success:!0});break;case"GET_SETTINGS":{const c=await chrome.storage.local.get("settings");o(c.settings||{});break}case"UPDATE_SETTINGS":await chrome.storage.local.set({settings:i}),o({success:!0});break;case"CLIPBOARD_MONITORING_RESULT":this.handleClipboardResult(i),o({success:!0});break;case"EXTRACT_EMR_DATA_AI_REVIEW":await this.handleEMRDataExtractionForAIReview(i,t.tab?.id,o);break;case"SET_FILE_DROP_GUARD":{const c=!!e.data?.enabled||!!e.enabled;this.fileTabSuppression=c,console.log("ðŸ›¡ï¸ Background file-tab suppression set to",this.fileTabSuppression);try{for(const d of this.activeTabs){try{await chrome.tabs.sendMessage(d,{type:"SET_FILE_DROP_GUARD",enabled:this.fileTabSuppression})}catch(u){console.warn("SET_FILE_DROP_GUARD forward to tab failed:",d,u)}try{await chrome.scripting.executeScript({target:{tabId:d},func:u=>{try{const s=window;s.__operatorInstallPageDropGuard||(s.__operatorInstallPageDropGuard=f=>{if(f){if(s.__operatorDropGuard)return;const m="__operator_page_drop_overlay__";let l=document.getElementById(m);if(!l){l=document.createElement("div"),l.id=m,l.style.position="fixed",l.style.top="0",l.style.left="0",l.style.width="100vw",l.style.height="100vh",l.style.zIndex="2147483647",l.style.background="rgba(59,130,246,0.12)",l.style.border="2px dashed rgba(37,99,235,0.7)",l.style.display="flex",l.style.boxSizing="border-box",l.style.alignItems="center",l.style.justifyContent="center",l.style.pointerEvents="none",l.style.backdropFilter="blur(2px)";const n=document.createElement("div");n.style.padding="16px 20px",n.style.background="rgba(255,255,255,0.9)",n.style.borderRadius="12px",n.style.color="#1f2937",n.style.boxShadow="0 10px 30px rgba(0,0,0,0.15)",n.style.fontFamily="system-ui, -apple-system, Segoe UI, Roboto, sans-serif",n.style.fontSize="14px",n.textContent="Drop image anywhere on this page to import into Annotate & Combine",l.appendChild(n),document.body.appendChild(l)}const S=()=>{l&&(l.style.display="flex")},k=()=>{},E=n=>{n.preventDefault(),S()},v=n=>{n.preventDefault(),n.dataTransfer&&(n.dataTransfer.dropEffect="copy")},T=n=>{n.preventDefault()},_=n=>{try{n.preventDefault();const g=n.dataTransfer;if(!g)return;let y=[];if(g.files&&g.files.length)y=Array.from(g.files);else if(g.items&&g.items.length){for(const h of Array.from(g.items))if(h.kind==="file"){const R=h.getAsFile?.();R&&y.push(R)}}const b=y.find(h=>h&&/^image\//.test(h.type));if(!b)return;const w=new FileReader;w.onload=()=>{try{chrome.runtime.sendMessage({type:"PAGE_FILE_DROPPED",payload:{dataUrl:w.result,name:b.name,type:b.type,size:b.size}})}catch(h){console.debug("Failed to send PAGE_FILE_DROPPED message:",h instanceof Error?h.message:h)}},w.readAsDataURL(b)}catch(g){console.debug("Failed to read dropped file:",g instanceof Error?g.message:g)}};window.addEventListener("dragenter",E,!0),window.addEventListener("dragover",v,!0),window.addEventListener("dragleave",T,!0),window.addEventListener("drop",_,!0),s.__operatorDropGuard={onDragEnter:E,onDragOver:v,onDragLeave:T,onDrop:_,overlay:l};try{chrome.runtime.sendMessage({type:"PAGE_DROP_GUARD_INSTALLED"})}catch(n){console.debug("Failed to send PAGE_DROP_GUARD_INSTALLED notification:",n instanceof Error?n.message:n)}}else if(s.__operatorDropGuard){window.removeEventListener("dragenter",s.__operatorDropGuard.onDragEnter,!0),window.removeEventListener("dragover",s.__operatorDropGuard.onDragOver,!0),window.removeEventListener("dragleave",s.__operatorDropGuard.onDragLeave,!0),window.removeEventListener("drop",s.__operatorDropGuard.onDrop,!0);try{s.__operatorDropGuard.overlay&&s.__operatorDropGuard.overlay.parentNode&&s.__operatorDropGuard.overlay.parentNode.removeChild(s.__operatorDropGuard.overlay)}catch(m){console.debug("Failed to remove drop guard overlay:",m instanceof Error?m.message:m)}s.__operatorDropGuard=null}}),s.__operatorInstallPageDropGuard(u)}catch(s){console.error("Page drop guard install failed",s)}},args:[this.fileTabSuppression]}),console.log("âœ… Injected drop guard overlay into tab",d)}catch(u){console.error("âŒ Failed to inject drop guard overlay into tab",d,u)}}}catch(d){console.warn("SET_FILE_DROP_GUARD broadcast failed:",d)}o({success:!0,enabled:this.fileTabSuppression});break}case"NAVIGATE_TO_PATIENT":{try{const c=await chrome.tabs.query({url:"https://my.xestro.com/*"});if(c.length===0){console.warn("âš ï¸ No Xestro tab found for patient navigation"),o({success:!1,error:"No Xestro tab found"});break}const d=c[0];console.log("ðŸ§­ Navigating Xestro tab to patient:",e.fileNumber),await chrome.tabs.sendMessage(d.id,{type:"EXECUTE_ACTION",action:"GO_TO_PATIENT_BY_FILING",data:{fileNumber:e.fileNumber,patientName:e.patientName}}),console.log("âœ… Patient navigation request sent successfully"),o({success:!0})}catch(c){console.error("âŒ Failed to navigate to patient:",c),o({success:!1,error:c instanceof Error?c.message:"Unknown error"})}break}default:o({error:"Unknown message type"})}}catch(r){console.error("Message handling error:",r),o({error:r instanceof Error?r.message:"Unknown error"})}}async executeAction(e,t,o,r){if(e==="profile-photo"){await this.handleProfilePhotoCapture(t,o,r);return}if(!o){console.log("ðŸ” No tabId provided, searching for active EMR tab...");const a=await this.getActiveEMRTab();if(!a?.id){console.log("âŒ No active EMR tab found"),r?.({error:"No active EMR tab found"});return}o=a.id,console.log("âœ… Found active EMR tab:",o,a.url)}try{console.log(`ðŸš€ Executing action "${e}" on tab ${o}`);try{(await chrome.scripting.executeScript({target:{tabId:o},func:()=>window.operatorContentScriptLoaded===!0}))[0]?.result?console.log("ðŸ“ Content script already loaded"):(await chrome.scripting.executeScript({target:{tabId:o},files:["content-script.js"]}),console.log("ðŸ“ Content script injected manually"),await this.wait(1e3))}catch(i){console.log("ðŸ“ Content script injection failed:",i)}const a=await chrome.tabs.sendMessage(o,{type:"EXECUTE_ACTION",action:e,data:t});console.log(`âœ… Action "${e}" completed:`,a),r?.(a)}catch(a){console.error(`âŒ Action ${e} failed:`,a),r?.({error:a instanceof Error?a.message:"Action failed"})}}async handleEMRDataExtractionForAIReview(e,t,o){console.log("ðŸ¤– Service Worker: Handling EXTRACT_EMR_DATA_AI_REVIEW request");try{if(!t){console.log("ðŸ” No tabId provided, searching for active EMR tab...");const a=await this.getActiveEMRTab();if(!a?.id){console.log("âŒ No active EMR tab found"),o?.({success:!1,error:"No active EMR tab found. Please ensure you're on my.xestro.com with a patient record open."});return}t=a.id,console.log("âœ… Found active EMR tab:",t,a.url)}console.log("ðŸ“‹ Service Worker: Sending EXTRACT_EMR_DATA_AI_REVIEW message to content script via robust method");const r=await this.sendMessageToTab(t,{type:"EXTRACT_EMR_DATA_AI_REVIEW",fields:e?.fields||["background","investigations","medications-problemlist"]},{retries:3,timeout:6e5,ensureContentScript:!0});console.log("âœ… Service Worker: EMR data extraction completed successfully:",r),o?.({success:!0,data:r.data||r})}catch(r){console.error("âŒ Service Worker: EMR data extraction failed:",r),o?.({success:!1,error:r instanceof Error?r.message:"EMR data extraction failed"})}}async handleSidePanelAction(e,t,o){try{const r=await this.getActiveEMRTab();if(!r){o({error:"No active EMR tab found"});return}await this.executeAction(e,t,r.id,o)}catch(r){console.error(`Side panel action ${e} failed:`,r),o({error:r instanceof Error?r.message:"Action failed"})}}async handleCommand(e){try{const t=await this.getActiveEMRTab();switch(e){case"toggle-recording":await chrome.runtime.sendMessage({type:"KEYBOARD_SHORTCUT",command:"toggle-recording"});break;case"open-side-panel":t?.id;break;case"quick-transcribe":await chrome.runtime.sendMessage({type:"KEYBOARD_SHORTCUT",command:"quick-transcribe"});break}}catch(t){console.error(`Command ${e} failed:`,t)}}async getActiveEMRTab(){try{const t=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0];if(t&&this.isEMRTab(t.url))return t;const o=await chrome.tabs.query({});for(const r of o)if(this.isEMRTab(r.url))return r;return null}catch(e){return console.error("Failed to get active EMR tab:",e),null}}isEMRTab(e){if(console.log("ðŸ” Checking if EMR tab:",e),!e)return console.log("âŒ No URL provided"),!1;try{const t=new URL(e),o=t.hostname==="my.xestro.com";return console.log(`ðŸ” URL hostname: "${t.hostname}", matches my.xestro.com: ${o}`),o}catch(t){return console.log("âŒ Invalid URL format:",t),!1}}getActiveEmrTabIdFromSet(){const t=this.activeTabs.values().next();return t.done?null:t.value}async getTabInfo(e){if(!e)return null;try{const t=await chrome.tabs.get(e);return{id:t.id,url:t.url,title:t.title,isEMR:this.isEMRTab(t.url)}}catch(t){return console.error("Failed to get tab info:",t),null}}async updateAgentMemory(e,t){try{const r=(await chrome.storage.local.get("agentMemory")).agentMemory||{};r[e]={...r[e],...t,lastUpdated:Date.now()},await chrome.storage.local.set({agentMemory:r})}catch(o){console.error("Failed to update agent memory:",o)}}async initializeWhisperServer(){try{console.log("ðŸŽ™ï¸ Initializing Transcription server...");const e=await this.whisperServerService.checkServerStatus();e.running?(console.log("âœ… Transcription server is already running"),console.log(`ðŸ“ Model: ${e.model}, Port: ${e.port}`)):(console.log("âš ï¸ Transcription server is not running"),console.log("ðŸ’¡ Starting server automatically..."),(await this.whisperServerService.startServer()).running?console.log("âœ… Transcription server started successfully"):(console.warn("âŒ Failed to start Transcription server automatically"),console.warn("ðŸ’¡ Manual start required: ./dev (select MLX Whisper or MedASR)")))}catch(e){console.error("âŒ Transcription server initialization failed:",e)}}async wait(e){return new Promise(t=>setTimeout(t,e))}async handleProfilePhotoCapture(e,t,o){console.log("ðŸ“¸ Starting profile photo capture workflow...");try{const r=t?await chrome.tabs.get(t):await this.getActiveEMRTab();if(!r?.id){console.error("âŒ No EMR tab found for image insertion"),o?.({error:"No EMR tab found for image insertion"});return}console.log(`ðŸ“¸ Target EMR tab: ${r.id} (${r.url})`),console.log("ðŸ“¸ Attempting tab capture method...");const a=await this.captureDoxyTab();if(a.success){console.log("âœ… Tab capture successful, inserting image..."),console.log("ðŸ“ Ensuring content script is available for image insertion..."),await this.ensureContentScriptLoaded(r.id);const i=await chrome.tabs.sendMessage(r.id,{type:"EXECUTE_ACTION",action:"profile-photo",data:{imageData:a.imageData,method:a.method,tabInfo:a.tabInfo}});console.log("âœ… Profile photo capture and insertion completed"),o?.({success:!0,method:a.method,response:i});return}console.log("âš ï¸ Tab capture failed, falling back to clipboard method..."),await this.handleClipboardFallback(r.id,a.error,o)}catch(r){console.error("âŒ Profile photo capture failed:",r),o?.({error:r instanceof Error?r.message:"Screenshot capture failed",method:"failed"})}}async captureDoxyTab(){console.log("ðŸ“¸ Looking for doxy.me tabs...");try{const e=await chrome.tabs.query({url:["*://*.doxy.me/*","*://doxy.me/*"]});if(console.log(`ðŸ“¸ Found ${e.length} doxy.me tabs`),e.length===0)return{success:!1,method:"failed",error:"No doxy.me tabs found"};let t=e[0];if(e.length>1){const a=e.find(i=>i.active);a?(t=a,console.log("ðŸ“¸ Using active doxy.me tab")):(t=e.reduce((i,p)=>(p.lastAccessed||0)>(i.lastAccessed||0)?p:i),console.log("ðŸ“¸ Using most recently accessed doxy.me tab"))}console.log(`ðŸ“¸ Capturing tab: ${t.id} - ${t.title}`),console.log(`ðŸ“¸ Tab URL: ${t.url}`),console.log(`ðŸ“¸ Window ID: ${t.windowId}`);const r=(await chrome.tabs.query({active:!0,windowId:t.windowId}))[0];try{t.active||(console.log("ðŸ“¸ Temporarily activating tab for capture..."),await chrome.tabs.update(t.id,{active:!0}),await this.wait(300)),console.log("ðŸ“¸ Attempting chrome.tabs.captureVisibleTab...");const a=await chrome.tabs.captureVisibleTab(t.windowId,{format:"png",quality:90});return console.log("ðŸ“¸ Tab capture completed successfully"),r&&r.id!==t.id&&(console.log("ðŸ“¸ Restoring original active tab..."),await chrome.tabs.update(r.id,{active:!0})),console.log("âœ… Tab capture successful"),{success:!0,imageData:a,method:"tab-capture",tabInfo:{title:t.title||"doxy.me",url:t.url||"",windowId:t.windowId}}}catch(a){if(r&&r.id!==t.id)try{await chrome.tabs.update(r.id,{active:!0})}catch(i){console.log("âš ï¸ Could not restore original active tab:",i)}throw a}}catch(e){return console.error("âŒ Tab capture failed:",e),{success:!1,method:"failed",error:e instanceof Error?e.message:"Tab capture failed"}}}async handleClipboardFallback(e,t,o){console.log("ðŸ“¸ Starting clipboard fallback method...");try{console.log("ðŸ“¸ Ensuring content script is available..."),await this.ensureContentScriptLoaded(e),console.log("ðŸ“¸ Showing clipboard capture instructions..."),await chrome.tabs.sendMessage(e,{type:"SHOW_SCREENSHOT_INSTRUCTIONS",data:{method:"clipboard",tabCaptureError:t,instructions:["Press cmd+shift+4 to take a screenshot","Select the area you want to capture","The image will automatically be inserted when ready"]}}),console.log("ðŸ“¸ Starting clipboard monitoring via content script..."),await chrome.tabs.sendMessage(e,{type:"START_CLIPBOARD_MONITORING",data:{timeoutMs:3e4}}),console.log("ðŸ“¸ Waiting for clipboard monitoring result...");const r=await this.waitForClipboardResult();r.success?(console.log("âœ… Clipboard method successful via content script"),o?.({success:!0,method:"clipboard",result:r})):(console.error("âŒ Clipboard method failed:",r.error),o?.({error:r.error||"Clipboard method failed",method:"failed"}))}catch(r){console.error("âŒ Clipboard fallback failed:",r),o?.({error:r instanceof Error?r.message:"Clipboard fallback failed",method:"failed"})}}async blobToBase64(e){return new Promise((t,o)=>{const r=new FileReader;r.onload=()=>t(r.result),r.onerror=o,r.readAsDataURL(e)})}async ensureContentScriptLoaded(e){try{if(await this.testContentScriptResponsiveness(e)){console.log("ðŸ“ Content script already loaded and responsive");return}if(console.log("ðŸ“ Injecting content script..."),await chrome.scripting.executeScript({target:{tabId:e},files:["content-script.js"]}),console.log("ðŸ“ Content script injected successfully"),await this.wait(1e3),!await this.testContentScriptResponsiveness(e))throw new Error("Content script injection successful but not responsive")}catch(t){throw console.error("âŒ Failed to inject content script:",t),new Error("Could not load content script for functionality")}}async testContentScriptResponsiveness(e){try{const t=await new Promise((o,r)=>{const a=setTimeout(()=>{r(new Error("Content script ping timeout"))},2e3);chrome.tabs.sendMessage(e,{type:"PING"},i=>{if(clearTimeout(a),chrome.runtime.lastError){r(new Error(chrome.runtime.lastError.message));return}o(i)})});return!!(t&&t.success)}catch(t){return console.log("ðŸ“ Content script not responsive:",t),!1}}async waitForClipboardResult(){return new Promise((e,t)=>{this.clipboardResultPromise={resolve:e,reject:t},setTimeout(()=>{this.clipboardResultPromise&&(this.clipboardResultPromise.reject(new Error("Timeout waiting for clipboard result")),this.clipboardResultPromise=null)},35e3)})}handleClipboardResult(e){console.log("ðŸ“¸ Received clipboard monitoring result:",e),this.clipboardResultPromise?(e.success?this.clipboardResultPromise.resolve(e):this.clipboardResultPromise.reject(new Error(e.error||"Clipboard monitoring failed")),this.clipboardResultPromise=null):console.warn("âš ï¸ Received clipboard result but no promise waiting for it")}async checkExistingTabs(){try{console.log("ðŸ” Checking all existing tabs for EMR domains...");const e=await chrome.tabs.query({});console.log(`ðŸ” Found ${e.length} total tabs to check`);for(const t of e)if(t.id&&t.url&&(console.log(`ðŸ” Checking tab ${t.id}: ${t.url}`),this.isEMRTab(t.url))){this.activeTabs.add(t.id);try{await chrome.sidePanel.setOptions({tabId:t.id,path:"src/sidepanel/index.html",enabled:!0}),console.log(`âœ… Side panel ENABLED for existing EMR tab ${t.id}`)}catch(r){console.error(`âŒ Failed to enable side panel for tab ${t.id}:`,r)}}console.log(`âœ… Finished checking existing tabs. Active EMR tabs: ${Array.from(this.activeTabs)}`)}catch(e){console.error("âŒ Error checking existing tabs:",e)}}async navigateTab(e,t){return console.log(`ðŸ§­ Navigating tab ${e} to: ${t}`),new Promise((o,r)=>{chrome.tabs.update(e,{url:t},async a=>{if(chrome.runtime.lastError){r(new Error(`Navigation failed: ${chrome.runtime.lastError.message}`));return}console.log(`ðŸ§­ Navigation initiated for tab ${e}`);try{await this.waitForTabLoad(e),console.log(`âœ… Navigation completed for tab ${e}`),o()}catch(i){r(i)}})})}async waitForTabLoad(e){const r=Date.now();for(;Date.now()-r<15e3;)try{if((await chrome.tabs.get(e)).status==="complete"){console.log(`âœ… Tab ${e} loaded successfully`),await this.wait(500);try{await this.ensureContentScriptLoaded(e)}catch(i){console.warn(`âš ï¸ Content script injection failed for tab ${e}, but continuing:`,i)}return}await this.wait(500)}catch(a){console.warn(`âš ï¸ Error checking tab ${e} status:`,a),await this.wait(500)}throw new Error(`Tab ${e} load timeout after 15000ms`)}async sendMessageToTab(e,t,o={}){const{timeout:r=5e3,retries:a=2,ensureContentScript:i=!0}=o;if(i)try{await this.ensureContentScriptLoaded(e)}catch(c){console.warn(`âš ï¸ Could not ensure content script for tab ${e}:`,c)}let p=null;for(let c=1;c<=a+1;c++)try{return await new Promise((u,s)=>{const f=setTimeout(()=>{s(new Error(`Message timeout after ${r}ms`))},r);chrome.tabs.sendMessage(e,t,m=>{if(clearTimeout(f),chrome.runtime.lastError){s(new Error(chrome.runtime.lastError.message));return}u(m)})})}catch(d){if(p=d instanceof Error?d:new Error(String(d)),console.warn(`ðŸ“¨ Message attempt ${c} failed for tab ${e}:`,p.message),c<=a){if(i&&p.message.includes("Could not establish connection"))try{console.log(`ðŸ“ Re-injecting content script for tab ${e} after connection failure...`),await chrome.scripting.executeScript({target:{tabId:e},files:["content-script.js"]}),await this.wait(1e3)}catch(u){console.warn(`ðŸ“ Content script re-injection failed for tab ${e}:`,u)}await this.wait(Math.min(1e3*c,3e3))}}throw p||new Error("Message sending failed after all retries")}async broadcastToTabs(e,t=!0){try{const o=await chrome.tabs.query({});for(const r of o)if(!t||this.isEMRTab(r.url))try{await this.sendMessageToTab(r.id,e,{timeout:2e3,retries:0,ensureContentScript:!1})}catch{}}catch(o){console.error("Failed to broadcast to tabs:",o)}}}const P=new D;typeof window<"u"&&(window.backgroundService=P);
